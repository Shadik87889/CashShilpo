<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõçÔ∏è CashShilpo - AI Powered POS & Invoicing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@700&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js for dashboard graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        :root {
            --bg-primary: #0A0A0A; /* Near black */
            --bg-secondary: #121212; /* Darker Gray */
            --bg-tertiary: #1a1a1a; /* Dark Gray */
            --glass-bg: rgba(26, 26, 26, 0.6);
            --border-color: #2a2a2a;
            --border-color-strong: #444;
            --text-primary: #F0F0F0;
            --text-secondary: #A0A0A0;
            --accent: #007BFF; /* A vibrant blue */
            --accent-hover: #0056b3;
            --accent-glow: rgba(0, 123, 255, 0.25);
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-secondary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6a6a6a; }

        /* Glassmorphism & Borders */
        .glass-pane {
            background-color: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
        }
        
        .loading-shimmer {
            background: linear-gradient(110deg, var(--bg-tertiary) 8%, var(--border-color) 18%, var(--bg-tertiary) 33%);
            background-size: 200% 100%;
            animation: 1.5s shine linear infinite;
        }
        @keyframes shine { to { background-position-x: -200%; } }

        /* General Transitions */
        * {
            transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        
        /* View Animations */
        .view-pane { animation: fadeIn 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modal Animations */
        .modal-overlay {
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5), 0 0 15px var(--accent-glow);
        }
        
        /* Toast Animations */
        @keyframes toast-in-right { from { transform: translateX(100%) scale(0.8); opacity: 0; } to { transform: translateX(0) scale(1); opacity: 1; } }
        @keyframes toast-out-right { from { transform: translateX(0) scale(1); opacity: 1; } to { transform: translateX(120%) scale(0.8); opacity: 0; } }
        .toast { animation: toast-in-right 0.5s cubic-bezier(0.21, 1.02, 0.73, 1), toast-out-right 0.5s cubic-bezier(0.21, 1.02, 0.73, 1) 4.5s forwards; }

        /* Form Inputs */
        .form-input, .form-select {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem; color: var(--text-primary); padding: 0.75rem 1rem;
        }
        .form-input:focus, .form-select:focus {
            outline: none; border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        
        /* World-Class Button */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.75rem 1.5rem; border-radius: 0.5rem;
            font-weight: 600; cursor: pointer; user-select: none; border: 1px solid transparent;
        }
        .btn[disabled] { cursor: not-allowed; opacity: 0.5; transform: none !important; box-shadow: none !important; }
        .btn-primary {
            background: linear-gradient(45deg, var(--accent), var(--accent-hover)); color: white;
            border-color: var(--accent);
            box-shadow: 0 4px 15px -5px var(--accent-glow), inset 0 1px 1px rgba(255,255,255,0.1);
        }
         .btn:hover:not([disabled]) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px -8px var(--accent-glow), inset 0 1px 1px rgba(255,255,255,0.1);
        }
        .btn:active:not([disabled]) { transform: translateY(-1px) scale(0.98); }
        .btn-danger { background-color: var(--danger); color: white; border-color: var(--danger); }
        .btn-danger:hover { background-color: #b02a37; }
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-color); }
        .btn-secondary:hover { background-color: var(--border-color); border-color: var(--border-color-strong); }
        
        /* Professional Table Styling */
        .table-pro { width: 100%; border-collapse: separate; border-spacing: 0 0.75rem; min-width: 600px; }
        .table-pro th {
            color: var(--text-secondary); font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.08em; font-size: 0.75rem; padding: 1rem 1.5rem; text-align: left;
        }
        .table-pro tr.table-row {
             background-color: var(--bg-secondary); border-radius: 0.75rem;
             box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
             transition: transform 0.2s ease, background-color 0.2s ease, border-color 0.2s ease;
             border: 1px solid var(--border-color);
        }
        .table-pro tr.table-row:hover {
            transform: translateY(-4px) scale(1.01); background-color: var(--bg-tertiary);
            border-color: var(--accent); color: var(--text-primary); cursor: pointer;
        }
        .table-pro td { padding: 1.25rem 1.5rem; color: var(--text-secondary); }
        .table-pro tr.table-row:hover td { color: inherit; }
        .table-pro td:first-child { border-top-left-radius: 0.75rem; border-bottom-left-radius: 0.75rem; }
        .table-pro td:last-child { border-top-right-radius: 0.75rem; border-bottom-right-radius: 0.75rem; }

        /* Sidebar Nav Link & Smooth Collapse */
        .nav-link { position: relative; }
        .nav-link.active-view { background-color: var(--accent-glow); color: var(--text-primary); }
        .nav-link.active-view::before {
            content: ''; position: absolute; left: 0; top: 50%;
            transform: translateY(-50%); width: 3px; height: 60%;
            background-color: var(--accent); border-radius: 3px;
            transition: all 0.3s ease;
        }
        
        #brand-name, .nav-link-text, .user-profile-details {
            transition: opacity 0.2s ease-out, max-width 0.3s ease-in-out, margin-left 0.3s ease-in-out;
            white-space: nowrap; overflow: hidden; max-width: 200px;
        }
        
        .sidebar-collapsed .nav-link.active-view::before {
            left: 50%; transform: translate(-50%, -50%);
            height: 3px; width: 60%; top: 100%;
        }
        
        .sidebar-collapsed #brand-name, .sidebar-collapsed .nav-link-text, .sidebar-collapsed .user-profile-details {
            opacity: 0; max-width: 0; margin-left: 0; pointer-events: none;
        }
        .sidebar-collapsed .nav-link { justify-content: center; }
        
        /* Main Workspace Tabs */
        .main-tab { border-bottom: 2px solid transparent; position: relative; }
        .main-tab.active { color: var(--text-primary); }
        .main-tab.active::after {
            content: ''; position: absolute; bottom: -1px; left: 0; right: 0;
            height: 2px; background-color: var(--accent);
            transform-origin: center; animation: scaleX 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }
        @keyframes scaleX { from { transform: scaleX(0); } to { transform: scaleX(1); } }
        
        /* POS Sub-Tabs */
        .pos-tab { border-bottom: 2px solid transparent; }
        .pos-tab.active { color: var(--text-primary); border-bottom-color: var(--accent); background-color: var(--bg-tertiary); }
        .pos-tab.held { border-bottom-color: var(--warning); color: var(--text-primary); }
        
        /* ADVANCED PAYMENT MODAL STYLES */
        .payment-method-btn.active {
            background: var(--accent) !important;
            color: white !important;
            border-color: var(--accent-hover) !important;
            box-shadow: 0 0 15px var(--accent-glow);
        }
        .keypad-btn {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            transition: all 0.1s ease-out;
        }
        .keypad-btn:hover { background-color: var(--border-color); }
        .keypad-btn:active { transform: scale(0.95); background-color: var(--border-color-strong); }
        .payment-split-item { animation: fadeIn 0.3s ease; }
        
        /* POS Tab Scrolling */
        #pos-tabs-container { overflow-x: auto; scrollbar-width: none; position: relative; }
        #pos-tabs-container::-webkit-scrollbar { display: none; }
        .pos-scroll-btn-left { background: radial-gradient(ellipse 120% 70% at 0% 50%, var(--bg-secondary) 25%, transparent 70%); }
        .pos-scroll-btn-right { background: radial-gradient(ellipse 120% 70% at 100% 50%, var(--bg-secondary) 25%, transparent 70%); }
        
        /* Search Result Styling */
        #pos-search-results {
            background-color: var(--bg-secondary);
        }
        .search-result-item:hover {
            background-color: var(--border-color);
        }
        .search-result-item.active {
            background-color: var(--accent-hover);
            color: white;
        }

        /* Settings Template Selector */
        .template-selector {
            border: 2px solid var(--border-color);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .template-selector:hover {
            border-color: var(--accent);
            transform: translateY(-4px);
        }
        .template-selector.active {
            border-color: var(--accent);
            box-shadow: 0 0 15px var(--accent-glow);
        }

        /* Responsive Design */
        #sidebar-backdrop {
            transition: opacity 0.3s ease-in-out;
        }

        @media (max-width: 1023px) { /* Below Tailwind's 'lg' breakpoint */
            #sidebar {
                position: fixed;
                top: 0;
                bottom: 0;
                left: 0;
                z-index: 50;
                transform: translateX(-100%);
            }
            #sidebar.mobile-open {
                transform: translateX(0);
            }
             /* Ensure desktop collapse styles don't affect mobile view */
            #sidebar.sidebar-collapsed {
                width: 16rem !important; /* w-64 */
            }
            .sidebar-collapsed #brand-name, 
            .sidebar-collapsed .nav-link-text, 
            .sidebar-collapsed .user-profile-details {
                opacity: 1;
                max-width: 200px;
                margin-left: 1rem;
                pointer-events: auto;
            }
             .sidebar-collapsed .nav-link {
                justify-content: flex-start;
            }
            .sidebar-collapsed .nav-link.active-view::before {
                left: 0; transform: translateY(-50%);
                height: 60%; width: 3px; top: 50%;
            }

            /* Adjust header for mobile */
            header { padding-left: 1rem; padding-right: 1rem; }

             /* Adjust main content for mobile */
            #workspace-content { padding: 1rem; }
            #main-tabs-container { padding-left: 0.5rem; padding-right: 0.5rem; }
        }
    </style>
</head>
<body class="bg-dots">

    <div class="flex h-screen bg-bg-primary text-text-secondary">
        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="w-64 bg-[var(--bg-secondary)] flex flex-col transition-all duration-300 border-r border-border-color shrink-0">
            <div class="h-24 flex items-center justify-between px-6 shrink-0">
                <div class="flex items-center overflow-hidden">
                    <i data-lucide="gem" class="w-10 h-10 text-accent shrink-0"></i>
                    <span id="brand-name" class="ml-4 text-2xl font-bold text-text-primary tracking-tighter">CashShilpo</span>
                </div>
            </div>
            <nav id="main-nav" class="flex-1 px-4 py-4 space-y-2">
                <a href="#" data-view="dashboard" class="nav-link flex items-center p-3 rounded-lg hover:bg-bg-tertiary hover:text-white group">
                    <i data-lucide="layout-dashboard" class="w-6 h-6 shrink-0 text-gray-400 group-hover:text-accent"></i><span class="nav-link-text ml-4 font-medium">Dashboard</span>
                </a>
                <a href="#" data-view="pos" class="nav-link flex items-center p-3 rounded-lg hover:bg-bg-tertiary hover:text-white group">
                    <i data-lucide="scan-line" class="w-6 h-6 shrink-0 text-gray-400 group-hover:text-accent"></i><span class="nav-link-text ml-4 font-medium">POS Terminal</span>
                </a>
                <a href="#" data-view="invoices" class="nav-link flex items-center p-3 rounded-lg hover:bg-bg-tertiary hover:text-white group">
                    <i data-lucide="file-text" class="w-6 h-6 shrink-0 text-gray-400 group-hover:text-accent"></i><span class="nav-link-text ml-4 font-medium">Invoices</span>
                </a>
                <a href="#" data-view="inventory" class="nav-link flex items-center p-3 rounded-lg hover:bg-bg-tertiary hover:text-white group">
                    <i data-lucide="boxes" class="w-6 h-6 shrink-0 text-gray-400 group-hover:text-accent"></i><span class="nav-link-text ml-4 font-medium">Inventory</span>
                </a>
                 <a href="#" data-view="reports" class="nav-link flex items-center p-3 rounded-lg hover:bg-bg-tertiary hover:text-white group">
                    <i data-lucide="bar-chart-3" class="w-6 h-6 shrink-0 text-gray-400 group-hover:text-accent"></i><span class="nav-link-text ml-4 font-medium">Reports</span>
                </a>
                <a href="#" data-view="customers" class="nav-link flex items-center p-3 rounded-lg hover:bg-bg-tertiary hover:text-white group">
                    <i data-lucide="users" class="w-6 h-6 shrink-0 text-gray-400 group-hover:text-accent"></i><span class="nav-link-text ml-4 font-medium">Customers</span>
                </a>
                 <a href="#" data-view="settings" class="nav-link flex items-center p-3 rounded-lg hover:bg-bg-tertiary hover:text-white group">
                    <i data-lucide="settings" class="w-6 h-6 shrink-0 text-gray-400 group-hover:text-accent"></i><span class="nav-link-text ml-4 font-medium">Settings</span>
                </a>
            </nav>
            <div class="p-4 border-t border-border-color shrink-0">
                 <a href="#" class="flex items-center p-3 rounded-lg hover:bg-bg-tertiary">
                    <img src="https://placehold.co/40x40/007BFF/ffffff?text=A" class="w-10 h-10 rounded-full ring-2 ring-border-color shrink-0" alt="User Avatar">
                    <div class="user-profile-details ml-4">
                        <p class="font-semibold text-text-primary">Admin User</p>
                        <p class="text-xs text-text-secondary">admin@cashshilpo.com</p>
                    </div>
                </a>
            </div>
        </aside>
        
        <!-- Sidebar Backdrop for Mobile -->
        <div id="sidebar-backdrop" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden"></div>

        <!-- Main Content Workspace -->
        <main class="flex-1 flex flex-col bg-bg-primary overflow-hidden">
            <header class="h-24 flex items-center justify-between px-8 border-b border-border-color shrink-0 bg-[var(--bg-secondary)]/50">
                <div class="flex items-center gap-4">
                    <button id="sidebar-toggle" class="text-text-secondary hover:text-text-primary p-2 -ml-2 rounded-md"><i data-lucide="panel-left-close" class="w-6 h-6"></i></button>
                    <button data-action="open-search" class="flex items-center gap-2 text-text-secondary hover:text-text-primary bg-bg-tertiary px-4 py-2 rounded-lg border border-border-color">
                         <i data-lucide="search" class="w-5 h-5"></i>
                         <span class="text-sm hidden md:inline">Search...</span>
                         <kbd class="ml-4 text-xs font-sans border border-border-color-strong rounded px-1.5 py-0.5 hidden md:inline">‚åòK</kbd>
                    </button>
                </div>
                <div class="flex items-center gap-2 md:gap-4">
                    <button data-action="open-notifications" class="text-text-secondary hover:text-text-primary relative p-2"><i data-lucide="bell" class="w-6 h-6"></i><span class="absolute top-1 right-1 w-2.5 h-2.5 bg-danger rounded-full border-2 border-bg-secondary"></span></button>
                    <button id="ai-assistant-btn" class="bg-accent text-white rounded-full p-2 hover:bg-accent-hover transition-all transform hover:scale-110 shadow-lg shadow-accent-glow"><i data-lucide="sparkles" class="w-6 h-6"></i></button>
                </div>
            </header>
            <div id="main-tabs-container" class="flex-shrink-0 flex items-center border-b border-border-color px-4 bg-[var(--bg-secondary)]/50"></div>
            <div id="workspace-content" class="flex-1 p-4 md:p-8 overflow-y-auto">
                <!-- Dynamic content will be loaded here -->
            </div>
        </main>
    </div>
    
    <!-- Modals Container -->
    <div id="modals-container"></div>
    
    <!-- Toasts Container -->
    <div id="toasts-container" class="fixed bottom-6 right-6 z-[100] space-y-3 w-full max-w-sm md:max-w-md"></div>

    <script type="module">
        // --- MOCK DATABASE & STORE INFO ---
        const storeInfo = {
            name: "CashShilpo Flagship",
            logoUrl: "https://placehold.co/100x100/007BFF/FFFFFF?text=CS",
            address: "123 Commerce St, Business City, 12345",
            contact: "555-0101",
            website: "cashshilpo.com",
            taxId: "BIN-123456789",
            socials: "@cashshilpo"
        };

        let mockDB = {
            products: [
                { id: 'SKU001', name: 'Espresso Coffee Beans', category: 'Coffee', price: 15.99, stock: 45, sales: 120, warrantyInfo: 'N/A' },
                { id: 'SKU002', name: 'Organic Green Tea', category: 'Tea', price: 8.50, stock: 85, sales: 95, warrantyInfo: 'N/A' },
                { id: 'SKU003', name: 'Artisan Sourdough Bread', category: 'Bakery', price: 5.25, stock: 15, sales: 210, warrantyInfo: 'N/A' },
                { id: 'SKU004', name: 'Mineral Water 1L', category: 'Beverages', price: 1.20, stock: 250, sales: 450, warrantyInfo: 'N/A' },
                { id: 'SKU005', name: 'Gourmet Chocolate Bar', category: 'Snacks', price: 3.99, stock: 150, sales: 320, warrantyInfo: 'N/A' },
                { id: 'SKU006', name: 'Premium Olive Oil', category: 'Pantry', price: 22.00, stock: 60, sales: 55, warrantyInfo: 'N/A' },
                { id: 'SKU007', name: 'Fresh Croissants (x2)', category: 'Bakery', price: 4.50, stock: 40, sales: 180, warrantyInfo: 'N/A' },
                { id: 'SKU101', name: 'Cybernetic Mousepad', category: 'Electronics', price: 49.99, stock: 30, sales: 50, warrantyInfo: '2-Year Limited Warranty' },

            ],
            customers: [
                { id: 'CUST001', name: 'John Doe', phone: '555-1234', email: 'john.doe@email.com', loyaltyPoints: 150, joinDate: '2025-01-15', address: '456 Oak Avenue', loyaltyId: 'CS-JD-456' },
                { id: 'CUST002', name: 'Jane Smith', phone: '555-5678', email: 'jane.smith@email.com', loyaltyPoints: 275, joinDate: '2024-11-22', address: '789 Pine Street', loyaltyId: 'CS-JS-789' },
                { id: 'CUST003', name: 'Michael Brown', phone: '555-8765', email: 'michael.b@email.com', loyaltyPoints: 80, joinDate: '2025-05-10', address: '101 Maple Lane', loyaltyId: 'CS-MB-101' },
            ],
            invoices: [
                { id: 'INV001', customerId: 'CUST001', customerName: 'John Doe', total: 37.23, status: 'Paid', date: '2025-09-08', items: [{id: 'SKU001', qty: 1, price: 15.99}, {id: 'SKU003', qty: 2, price: 5.25}], cashier: 'Alice', storeId: 'STR-01' },
                { id: 'INV002', customerId: 'CUST002', customerName: 'Jane Smith', total: 12.49, status: 'Pending', date: '2025-09-07', items: [{id: 'SKU002', qty: 1, price: 8.50}, {id: 'SKU005', qty: 1, price: 3.99}], cashier: 'Bob', storeId: 'STR-01' },
                { id: 'INV003', customerId: 'CUST003', customerName: 'Michael Brown', total: 102.50, status: 'Paid', date: '2025-09-05', items: [{id: 'SKU006', qty: 4, price: 22.00}], cashier: 'Alice', storeId: 'STR-01' },
                { id: 'INV004', customerId: 'CUST001', customerName: 'John Doe', total: 9.00, status: 'Paid', date: '2025-08-21', items: [{id: 'SKU007', qty: 2, price: 4.50}], cashier: 'Charlie', storeId: 'STR-01' },
            ],
            notifications: [
                { id: 1, type: 'stock', message: 'Artisan Sourdough Bread is low on stock (15 remaining).', read: false, date: '2025-09-10' },
                { id: 2, type: 'info', message: 'System update scheduled for tonight at 2 AM.', read: false, date: '2025-09-10' },
                { id: 3, type: 'sale', message: 'New sale record: INV003 for $102.50.', read: true, date: '2025-09-05' }
            ]
        };
        
        // --- APPLICATION STATE ---
        let appState = { 
            tabs: [], 
            activeTabId: null, 
            isSidebarCollapsed: false,
            settings: {
                selectedReceiptTemplate: 'modern',
            },
            session: {
                cashier: 'Admin User',
                storeId: 'STR-01'
            }
        };
        let posState = { sales: [], activeSaleId: null, saleCounter: 1, };

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            const workspaceContent = document.getElementById('workspace-content');
            const mainTabsContainer = document.getElementById('main-tabs-container');
            const modalsContainer = document.getElementById('modals-container');
            const toastsContainer = document.getElementById('toasts-container');
            const sidebar = document.getElementById('sidebar');
            const sidebarToggleBtn = document.getElementById('sidebar-toggle');
            const sidebarBackdrop = document.getElementById('sidebar-backdrop');
            
            // --- CORE UTILITY FUNCTIONS ---
            const showToast = (message, type = 'success') => {
                const toastStyles = {
                    success: { bg: 'bg-green-500/10 border-green-500/50', icon: 'check-circle', iconColor: 'text-green-400' },
                    error: { bg: 'bg-red-500/10 border-red-500/50', icon: 'alert-circle', iconColor: 'text-red-400' },
                    info: { bg: 'bg-blue-500/10 border-blue-500/50', icon: 'info', iconColor: 'text-blue-400' }
                };
                const style = toastStyles[type];
                const toast = document.createElement('div');
                toast.className = `toast glass-pane flex items-center gap-4 text-text-primary text-sm font-medium px-4 py-3 rounded-xl shadow-lg ${style.bg}`;
                toast.innerHTML = `<i data-lucide="${style.icon}" class="w-6 h-6 ${style.iconColor}"></i><p class="flex-1">${message}</p>`;
                toastsContainer.prepend(toast);
                lucide.createIcons();
                setTimeout(() => toast.remove(), 5000);
            };

            const showModal = (title, content, footer, options = {}) => {
                const { size = 'max-w-lg', customClasses = '' } = options;
                const modalId = `modal-${Date.now()}`;
                const modalHTML = `
                    <div id="${modalId}" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4 opacity-0">
                        <div class="modal-content glass-pane rounded-xl shadow-2xl w-full ${size} ${customClasses} scale-95 transform">
                            <div class="flex justify-between items-center p-5 border-b border-border-color">
                                <h3 class="text-xl font-semibold text-text-primary">${title}</h3>
                                <button data-action="close-modal" class="p-1 rounded-full text-text-secondary hover:bg-bg-tertiary hover:text-white">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="p-6 text-text-secondary max-h-[70vh] overflow-y-auto">${content}</div>
                            ${footer ? `<div class="flex justify-end items-center p-4 bg-[var(--bg-secondary)]/50 rounded-b-xl space-x-3">${footer}</div>` : ''}
                        </div>
                    </div>`;
                modalsContainer.insertAdjacentHTML('beforeend', modalHTML);
                lucide.createIcons();
                const modalEl = document.getElementById(modalId);
                setTimeout(() => {
                    modalEl.classList.remove('opacity-0');
                    modalEl.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
                return modalEl;
            };

            const closeModal = (modalEl) => {
                if (!modalEl) return;
                modalEl.classList.add('opacity-0');
                modalEl.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => modalEl.remove(), 300);
            };

            // --- VIEW CONTENT & INITIALIZERS ---
            const viewInitializers = { 'dashboard': initDashboard, 'pos': initPOS, 'inventory': initInventory, 'customers': initCustomers, 'invoices': initInvoices, 'reports': initReports, 'settings': initSettings };
            
            function getViewContent(viewType) {
                 switch (viewType) {
                    case 'dashboard': return `<div class="space-y-8"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="dashboard-stats"></div><div class="grid grid-cols-1 lg:grid-cols-5 gap-6"><div class="lg:col-span-3 glass-pane p-6 rounded-lg flex flex-col"><h2 class="text-xl font-semibold mb-4 text-text-primary">Sales Overview</h2><div class="relative flex-grow"><canvas id="sales-chart"></canvas></div></div><div class="lg:col-span-2 glass-pane p-6 rounded-lg"><h2 class="text-xl font-semibold mb-4 text-text-primary">AI Insights</h2><p>üìà Sales are trending <span class="text-green-400 font-medium">15% higher</span> than last week.</p><p class="mt-2">üí° Consider restocking <span class="font-medium text-blue-400">Artisan Sourdough Bread</span>. Predicted stockout in 3 days.</p><p class="mt-2">üë• <span class="font-medium text-yellow-400">John Doe</span> is your top customer this month.</p></div></div></div>`;
                    case 'pos': return `<div class="flex flex-col h-full -mx-4 md:-mx-8 -my-4 md:-my-8"><div class="relative flex-shrink-0 border-b border-border-color"><button id="pos-scroll-left" class="pos-scroll-btn-left hidden absolute left-0 top-0 bottom-0 z-10 flex items-center pl-4 pr-8 text-text-secondary hover:text-text-primary transition-opacity"><i data-lucide="chevron-left" class="w-6 h-6 pointer-events-none"></i></button><div id="pos-tabs-container" class="flex items-center"></div><button id="pos-scroll-right" class="pos-scroll-btn-right hidden absolute right-0 top-0 bottom-0 z-10 flex items-center pr-4 pl-8 text-text-secondary hover:text-text-primary transition-opacity"><i data-lucide="chevron-right" class="w-6 h-6 pointer-events-none"></i></button></div><div class="grid grid-cols-12 gap-6 flex-grow p-4 md:p-6 lg:p-8"><div class="col-span-12 md:col-span-7 glass-pane p-4 rounded-xl flex flex-col"><div class="flex items-center border-b border-border-color pb-4 mb-4"><div class="relative w-full"><i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i><input type="text" id="pos-search" placeholder="Scan or search products..." class="w-full form-input pl-12 p-3 focus:ring-0" autocomplete="off"><div id="pos-search-results" class="absolute top-full left-0 right-0 mt-1 border border-border-color rounded-lg shadow-lg z-20 hidden max-h-60 overflow-y-auto"></div></div><button data-action="add-customer-to-sale" class="ml-3 bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 shrink-0"><i data-lucide="user-plus" class="w-6 h-6"></i></button></div><div class="flex-grow overflow-y-auto pr-2"><table class="w-full text-sm text-left text-text-secondary"><thead class="text-xs text-text-secondary uppercase"><tr><th class="px-6 py-3">Product</th><th class="px-6 py-3 w-24">Qty</th><th class="px-6 py-3">Price</th><th class="px-6 py-3">Total</th><th class="px-6 py-3"></th></tr></thead><tbody id="pos-cart-body"></tbody></table></div></div><div class="col-span-12 md:col-span-5 glass-pane p-6 rounded-xl flex flex-col justify-between"><div><h2 class="text-2xl font-bold text-text-primary mb-6">Order Summary</h2><div id="pos-customer-display" class="hidden items-center justify-between mb-4 p-3 bg-blue-900/50 rounded-lg text-blue-200"></div><div class="space-y-3 text-lg"><div class="flex justify-between"><p>Subtotal:</p><p id="pos-subtotal" class="font-mono text-text-primary">$0.00</p></div><div class="flex justify-between"><p>Tax (10%):</p><p id="pos-tax" class="font-mono text-text-primary">$0.00</p></div><div class="flex justify-between border-t border-border-color pt-4 mt-2 font-bold text-2xl"><p class="text-text-primary">Total:</p><p id="pos-total" class="font-mono text-accent">$0.00</p></div></div></div><div class="grid grid-cols-2 gap-3 mt-6"><button data-action="hold-sale" class="btn btn-secondary text-lg">Hold</button><button data-action="cancel-sale" class="btn btn-danger text-lg">Cancel</button><button data-action="process-payment" class="col-span-2 btn btn-primary text-xl tracking-wider py-4">PAY</button></div></div></div></div>`;
                    case 'inventory': return `<div><div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-text-primary">Inventory Management</h1><button data-action="add-product" class="btn btn-primary"><i data-lucide="plus" class="w-5 h-5 mr-2"></i> Add Product</button></div><div class="bg-bg-secondary/50 rounded-xl overflow-hidden"><table class="table-pro"><thead><tr><th>SKU</th><th>Product</th><th>Category</th><th>Price</th><th>Stock</th><th>Actions</th></tr></thead><tbody id="inventory-table-body"></tbody></table></div></div>`;
                    case 'customers': return `<div><div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-text-primary">Customer Database</h1><button data-action="add-customer" class="btn btn-primary"><i data-lucide="user-plus" class="w-5 h-5 mr-2"></i> Add Customer</button></div><div class="bg-bg-secondary/50 rounded-xl overflow-hidden"><table class="table-pro"><thead><tr><th>Customer</th><th>Contact</th><th>Address</th><th>Loyalty ID</th><th>Actions</th></tr></thead><tbody id="customers-table-body"></tbody></table></div></div>`;
                    case 'invoices': return `<div><div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-text-primary">Invoice History</h1></div><div class="bg-bg-secondary/50 rounded-xl overflow-hidden"><table class="table-pro"><thead><tr><th>Invoice ID</th><th>Customer</th><th>Date</th><th>Total</th><th>Status</th><th>Actions</th></tr></thead><tbody id="invoices-table-body"></tbody></table></div></div>`;
                    case 'reports': return `<div><h1 class="text-3xl font-bold text-text-primary mb-6">Business Reports</h1><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="glass-pane p-6 rounded-lg"><h2 class="text-xl font-semibold mb-4 text-text-primary">Revenue Over Time</h2><div class="relative h-80"><canvas id="revenue-chart"></canvas></div></div><div class="glass-pane p-6 rounded-lg"><h2 class="text-xl font-semibold mb-4 text-text-primary">Top Selling Products</h2><div class="relative h-80"><canvas id="top-products-chart"></canvas></div></div><div class="lg:col-span-2 glass-pane p-6 rounded-lg"><h2 class="text-xl font-semibold mb-4 text-text-primary">Sales By Category</h2><div class="relative h-96"><canvas id="category-sales-chart"></canvas></div></div></div></div>`;
                    case 'settings': return `<div><h1 class="text-3xl font-bold text-text-primary mb-6">Settings</h1><div class="space-y-8 max-w-4xl"><div class="glass-pane p-6 rounded-lg"> <h2 class="text-xl font-semibold text-text-primary border-b border-border-color pb-4 mb-4">Store Information</h2><form class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Store Name</label><input type="text" value="${storeInfo.name}" class="form-input w-full"></div><div><label class="block text-sm font-medium mb-1">Contact Email</label><input type="email" value="contact@cashshilpo.com" class="form-input w-full"></div></div><div><label class="block text-sm font-medium mb-1">Store Address</label><input type="text" value="${storeInfo.address}" class="form-input w-full"></div></form></div><div class="glass-pane p-6 rounded-lg"> <h2 class="text-xl font-semibold text-text-primary border-b border-border-color pb-4 mb-4">Tax Settings</h2><form class="space-y-4"><div><label class="block text-sm font-medium mb-1">Default Tax Rate (%)</label><input type="number" value="10" class="form-input w-full max-w-xs"></div></form></div><div class="glass-pane p-6 rounded-lg"> <h2 class="text-xl font-semibold text-text-primary border-b border-border-color pb-4 mb-4">Receipt & Invoice Customization</h2><div id="receipt-template-selector"></div></div><div class="flex justify-end"><button class="btn btn-primary">Save Changes</button></div></div></div>`;
                    default: return `<h1 class="text-2xl text-text-primary">Content for ${viewType}</h1>`;
                }
            }

             // --- NAVIGATION & TABBING SYSTEM ---
             const renderApp = () => {
                const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);

                mainTabsContainer.innerHTML = appState.tabs.map(tab => `
                    <button data-action="switch-tab" data-id="${tab.id}" class="main-tab flex items-center gap-2 px-4 py-3 text-sm font-medium hover:bg-bg-tertiary ${tab.id === appState.activeTabId ? 'active' : ''}">
                        ${tab.name}
                        <i data-lucide="x" data-action="close-tab" data-id="${tab.id}" class="w-4 h-4 rounded-full hover:bg-bg-tertiary ml-2"></i>
                    </button>
                `).join('');

                if (activeTab) {
                    workspaceContent.innerHTML = `<div class="view-pane">${getViewContent(activeTab.viewType)}</div>`;
                    viewInitializers[activeTab.viewType]?.(workspaceContent.firstElementChild);
                } else {
                    workspaceContent.innerHTML = `<div class="text-center p-20 flex flex-col items-center"><i data-lucide="layout-template" class="w-20 h-20 text-border-color-strong mb-6"></i><h2 class="text-2xl font-semibold">Workspace is empty</h2><p class="text-text-secondary mt-2">Select an item from the sidebar to open a new tab.</p></div>`;
                }
                
                 document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.toggle('active-view', activeTab && link.dataset.view === activeTab.viewType);
                });

                lucide.createIcons();
            };

            const openOrSwitchTab = (viewType) => {
                const existingTab = appState.tabs.find(t => t.viewType === viewType);
                if (existingTab) {
                    appState.activeTabId = existingTab.id;
                } else {
                    const newTabId = `tab_${Date.now()}`;
                    const name = viewType.charAt(0).toUpperCase() + viewType.slice(1);
                    appState.tabs.push({ id: newTabId, name: name, viewType: viewType });
                    appState.activeTabId = newTabId;
                }
                renderApp();
            };
            
            function initDashboard(pane) {
                 const statsContainer = pane.querySelector('#dashboard-stats');
                 const stats = [
                    { icon: 'dollar-sign', label: "Today's Revenue", value: '$1,250.75', color: 'blue' },
                    { icon: 'shopping-bag', label: "Today's Sales", value: '82', color: 'green' },
                    { icon: 'users', label: 'New Customers', value: '12', color: 'yellow' },
                    { icon: 'alert-triangle', label: 'Stock Alerts', value: '1', color: 'red' }
                 ];
                 statsContainer.innerHTML = stats.map(s => `<div class="glass-pane p-6 rounded-xl hover:border-accent hover:-translate-y-1"><div class="flex items-center"><div class="p-3 bg-${s.color}-500/10 rounded-full"><i data-lucide="${s.icon}" class="w-7 h-7 text-${s.color}-400"></i></div><div class="ml-4"><p class="text-sm text-text-secondary">${s.label}</p><p class="text-3xl font-bold text-text-primary">${s.value}</p></div></div></div>`).join('');
                
                const ctx = pane.querySelector('#sales-chart').getContext('2d');
                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(0, 123, 255, 0.4)');
                gradient.addColorStop(1, 'rgba(0, 123, 255, 0)');
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            label: 'Sales', data: [650, 720, 810, 780, 950, 1100, 1250],
                            borderColor: 'rgb(0, 123, 255)', backgroundColor: gradient, tension: 0.4,
                            pointBackgroundColor: 'rgb(0, 123, 255)', pointBorderColor: '#fff',
                            pointHoverRadius: 7, pointHoverBackgroundColor: '#fff', pointHoverBorderColor: 'rgb(0, 123, 255)', fill: true,
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)'}, ticks: {color: 'var(--text-secondary)'} }, x: { grid: { display: false }, ticks: {color: 'var(--text-secondary)'} } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // --- POS TABBING SYSTEM ---
            const posFullRender = (pane) => {
                const tabsContainer = pane.querySelector('#pos-tabs-container');
                const cartBody = pane.querySelector('#pos-cart-body');
                const subtotalEl = pane.querySelector('#pos-subtotal');
                const taxEl = pane.querySelector('#pos-tax');
                const totalEl = pane.querySelector('#pos-total');
                const customerDisplay = pane.querySelector('#pos-customer-display');
                const activeSale = posState.sales.find(s => s.id === posState.activeSaleId);
                const scrollLeftBtn = pane.querySelector('#pos-scroll-left');
                const scrollRightBtn = pane.querySelector('#pos-scroll-right');

                tabsContainer.innerHTML = posState.sales.map(s => {
                    let statusClass = s.id === posState.activeSaleId ? 'active' : '';
                    if (s.status === 'held') statusClass += ' held';
                    return `
                    <button data-action="switch-sale" data-id="${s.id}" class="pos-tab flex items-center gap-2 px-4 py-3 text-sm font-medium shrink-0 ${statusClass}">
                        ${s.status === 'held' ? '<i data-lucide="pause-circle" class="w-4 h-4 text-yellow-400"></i>' : ''}
                        ${s.name}
                        <i data-lucide="x" data-action="close-sale" data-id="${s.id}" class="w-4 h-4 rounded-full hover:bg-bg-tertiary"></i>
                    </button>
                    `;
                }).join('') + `<button data-action="new-sale" class="px-4 py-3 text-accent hover:text-white shrink-0"><i data-lucide="plus" class="w-5 h-5"></i></button>`;
                
                const handleOverflow = () => {
                    if (!tabsContainer) return;
                    const isOverflowing = tabsContainer.scrollWidth > tabsContainer.clientWidth;
                    const isAtStart = tabsContainer.scrollLeft < 5;
                    const isAtEnd = tabsContainer.scrollLeft + tabsContainer.clientWidth >= tabsContainer.scrollWidth - 5;
                    scrollLeftBtn?.classList.toggle('hidden', !isOverflowing || isAtStart);
                    scrollRightBtn?.classList.toggle('hidden', !isOverflowing || isAtEnd);
                };
                
                handleOverflow();
                tabsContainer.removeEventListener('scroll', handleOverflow);
                tabsContainer.addEventListener('scroll', handleOverflow);
                if ('ResizeObserver' in window) {
                   new ResizeObserver(handleOverflow).observe(tabsContainer);
                }


                if (!activeSale) {
                    cartBody.innerHTML = '<tr><td colspan="5" class="text-center py-10"><i data-lucide="shopping-cart" class="w-12 h-12 text-border-color-strong mx-auto mb-4"></i><p>No active sale. Create one with the + button!</p></td></tr>';
                    subtotalEl.textContent = "$0.00"; taxEl.textContent = "$0.00"; totalEl.textContent = "$0.00";
                    customerDisplay.classList.add('hidden');
                    lucide.createIcons();
                    return;
                }

                if(activeSale.customer) {
                    customerDisplay.innerHTML = `<div class="flex items-center gap-2">
                        <i data-lucide="user-check" class="inline w-4 h-4"></i> 
                        <span class="font-medium">${activeSale.customer.name}</span>
                        <span class="text-xs font-mono bg-yellow-500/20 text-yellow-300 px-2 py-0.5 rounded-full flex items-center gap-1"><i data-lucide="star" class="w-3 h-3"></i>${activeSale.customer.loyaltyPoints}</span>
                        </div>
                        <button data-action="remove-customer-from-sale" class="ml-2 text-red-400 hover:text-red-300"><i data-lucide="x" class="w-4 h-4"></i></button>`;
                    customerDisplay.classList.remove('hidden');
                    customerDisplay.classList.add('flex');
                } else {
                    customerDisplay.classList.add('hidden');
                }
                
                cartBody.innerHTML = activeSale.cart.length ? activeSale.cart.map(item => `
                    <tr class="hover:bg-bg-tertiary/50">
                        <td class="px-6 py-4 font-medium text-text-primary">${item.name}<p class="text-xs text-text-secondary font-mono">Stock: ${item.stock}</p></td>
                        <td class="px-6 py-4"><input type="number" value="${item.qty}" min="1" max="${item.stock}" class="w-16 bg-bg-tertiary text-center form-input p-1" data-id="${item.id}" data-action="update-qty"></td>
                        <td class="px-6 py-4 font-mono">$${item.price.toFixed(2)}</td>
                        <td class="px-6 py-4 font-mono text-text-primary">$${(item.price * item.qty).toFixed(2)}</td>
                        <td class="px-6 py-4 text-right"><button data-action="remove-from-cart" data-id="${item.id}" class="text-danger/70 hover:text-danger"><i data-lucide="trash-2" class="w-5 h-5"></i></button></td>
                    </tr>
                `).join('') : '<tr><td colspan="5" class="text-center py-10"><i data-lucide="scan" class="w-12 h-12 text-border-color-strong mx-auto mb-4"></i><p>Scan a product to begin</p></td></tr>';

                const subtotal = activeSale.cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
                const tax = subtotal * 0.10;
                const total = subtotal + tax;
                subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
                taxEl.textContent = `$${tax.toFixed(2)}`;
                totalEl.textContent = `$${total.toFixed(2)}`;

                lucide.createIcons();
            };

            const addProductToActiveCart = (product) => {
                const activeSale = posState.sales.find(s => s.id === posState.activeSaleId);
                if (!activeSale) { showToast('No active sale selected.', 'error'); return; }
                if(product.stock <= 0) { showToast(`${product.name} is out of stock.`, 'error'); return; }

                const existingItem = activeSale.cart.find(item => item.id === product.id);
                if(existingItem) {
                    if(existingItem.qty < product.stock) {
                        existingItem.qty++;
                    } else {
                        showToast(`No more stock available for ${product.name}.`, 'warning');
                        return;
                    }
                } else {
                    activeSale.cart.push({ ...product, qty: 1 });
                }
                posFullRender(workspaceContent.querySelector('.view-pane'));
            };
            
            function initPOS(pane) {
                if (posState.sales.length === 0) {
                    const newSaleId = `sale_${Date.now()}`;
                    posState.sales.push({ id: newSaleId, name: `Sale ${posState.saleCounter++}`, cart: [], customer: null, status: 'active' });
                    posState.activeSaleId = newSaleId;
                }
                posFullRender(pane);

                const searchInput = pane.querySelector('#pos-search');
                const resultsContainer = pane.querySelector('#pos-search-results');
                let activeSearchIndex = -1;

                const handleSelection = (product) => {
                    if(!product) return;
                    addProductToActiveCart(product);
                    searchInput.value = '';
                    resultsContainer.innerHTML = '';
                    resultsContainer.classList.add('hidden');
                    searchInput.focus();
                };

                searchInput.addEventListener('input', e => {
                    const query = e.target.value.toLowerCase();
                    if (query.length < 1) {
                        resultsContainer.classList.add('hidden');
                        return;
                    }
                    const filtered = mockDB.products.filter(p => p.name.toLowerCase().includes(query) || p.id.toLowerCase().includes(query)).slice(0, 7);
                    
                    if (filtered.length > 0) {
                        resultsContainer.innerHTML = filtered.map(p => `
                            <div class="search-result-item p-3 cursor-pointer" data-id="${p.id}">
                                <p class="font-medium text-text-primary pointer-events-none">${p.name}</p>
                                <p class="text-xs text-text-secondary font-mono pointer-events-none">ID: ${p.id} / Stock: ${p.stock}</p>
                            </div>
                        `).join('');
                        resultsContainer.classList.remove('hidden');
                    } else {
                        resultsContainer.innerHTML = `<p class="p-3 text-center text-text-secondary">No products found</p>`;
                        resultsContainer.classList.remove('hidden');
                    }
                    activeSearchIndex = -1;
                });
                
                resultsContainer.addEventListener('mousedown', e => {
                    const target = e.target.closest('.search-result-item');
                    if (target) {
                        const product = mockDB.products.find(p => p.id === target.dataset.id);
                        handleSelection(product);
                    }
                });

                searchInput.addEventListener('keydown', e => {
                    const items = resultsContainer.querySelectorAll('.search-result-item');
                    if(resultsContainer.classList.contains('hidden') || items.length === 0) {
                        if (e.key === 'Enter' && searchInput.value) {
                             const product = mockDB.products.find(p => p.id.toLowerCase() === searchInput.value.toLowerCase());
                             if (product) handleSelection(product);
                             else showToast(`Product "${searchInput.value}" not found.`, 'error');
                        }
                        return;
                    };

                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        activeSearchIndex = (activeSearchIndex + 1) % items.length;
                        items.forEach((item, i) => item.classList.toggle('active', i === activeSearchIndex));
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        activeSearchIndex = (activeSearchIndex - 1 + items.length) % items.length;
                        items.forEach((item, i) => item.classList.toggle('active', i === activeSearchIndex));
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        const activeItem = resultsContainer.querySelector('.search-result-item.active');
                        if (activeItem) {
                            const product = mockDB.products.find(p => p.id === activeItem.dataset.id);
                            handleSelection(product);
                        } else if(searchInput.value) { // Fallback for direct SKU entry
                             const product = mockDB.products.find(p => p.id.toLowerCase() === searchInput.value.toLowerCase());
                             if (product) handleSelection(product);
                             else showToast(`Product "${searchInput.value}" not found.`, 'error');
                        }
                    } else if (e.key === 'Escape') {
                         resultsContainer.classList.add('hidden');
                    }
                });
                
                searchInput.addEventListener('blur', () => setTimeout(() => resultsContainer.classList.add('hidden'), 150));

                const scrollLeftBtn = pane.querySelector('#pos-scroll-left');
                const scrollRightBtn = pane.querySelector('#pos-scroll-right');
                const tabsContainer = pane.querySelector('#pos-tabs-container');

                if(scrollLeftBtn && scrollRightBtn && tabsContainer) {
                    scrollLeftBtn.addEventListener('click', () => tabsContainer.scrollBy({ left: -250, behavior: 'smooth' }));
                    scrollRightBtn.addEventListener('click', () => tabsContainer.scrollBy({ left: 250, behavior: 'smooth' }));
                }
            }
            
            function initInventory(pane) {
                const tableBody = pane.querySelector('#inventory-table-body');
                const renderTable = () => {
                    tableBody.innerHTML = mockDB.products.map(p => `
                        <tr class="table-row">
                            <td class="font-mono text-xs">${p.id}</td>
                            <td class="font-medium text-text-primary">${p.name}</td>
                            <td>${p.category}</td>
                            <td class="font-mono">$${p.price.toFixed(2)}</td>
                            <td><span class="font-medium ${p.stock <= 0 ? 'text-red-500 bg-red-500/10 px-2 py-1 rounded-md' : p.stock < 20 ? 'text-red-400' : p.stock < 50 ? 'text-yellow-400' : 'text-green-400'}">${p.stock > 0 ? p.stock : 'Out of Stock'}</span></td>
                            <td class="space-x-2"><button data-action="edit-product" data-id="${p.id}" class="font-medium text-accent hover:text-accent-hover p-2 rounded-md"><i data-lucide="edit" class="w-4 h-4"></i></button></td>
                        </tr>`).join('');
                        lucide.createIcons();
                };
                renderTable();
                pane.rerender = renderTable;
            }

            function initCustomers(pane) {
                const tableBody = pane.querySelector('#customers-table-body');
                const renderTable = () => {
                    tableBody.innerHTML = mockDB.customers.map(c => `
                        <tr class="table-row" data-action="edit-customer" data-id="${c.id}">
                            <td class="font-medium text-text-primary">${c.name}</td>
                            <td><div>${c.email}</div><div class="text-xs">${c.phone}</div></td>
                            <td>${c.address || 'N/A'}</td>
                            <td class="font-mono text-xs">${c.loyaltyId || 'N/A'}</td>
                            <td><button data-action="edit-customer" data-id="${c.id}" class="font-medium text-accent hover:text-accent-hover p-2 rounded-md"><i data-lucide="edit" class="w-4 h-4"></i></button></td>
                        </tr>`).join('');
                        lucide.createIcons();
                };
                renderTable();
                pane.rerender = renderTable;
            }

            function initInvoices(pane) {
                const tableBody = pane.querySelector('#invoices-table-body');
                const getStatusBadge = (status) => {
                    const base = "px-3 py-1 text-xs font-semibold rounded-full inline-block";
                    if(status === 'Paid') return `${base} bg-green-500/20 text-green-300`;
                    if(status === 'Pending') return `${base} bg-yellow-500/20 text-yellow-300`;
                    return `${base} bg-gray-500/20 text-gray-300`;
                };
                const renderTable = () => {
                    tableBody.innerHTML = [...mockDB.invoices].reverse().map(i => `
                         <tr class="table-row" data-action="view-invoice" data-id="${i.id}">
                            <td class="font-mono text-xs">${i.id}</td>
                            <td class="font-medium text-text-primary">${i.customerName}</td>
                            <td>${i.date}</td>
                            <td class="font-mono">$${i.total.toFixed(2)}</td>
                            <td><span class="${getStatusBadge(i.status)}">${i.status}</span></td>
                            <td><button data-action="view-invoice" data-id="${i.id}" class="font-medium text-accent hover:text-accent-hover p-2 rounded-md"><i data-lucide="eye" class="w-4 h-4"></i></button></td>
                        </tr>`).join('');
                    lucide.createIcons();
                };
                renderTable();
                pane.rerender = renderTable;
            }

            function initReports(pane) {
                // IMPORTANT: Destroy existing chart instances on the same canvas elements before creating new ones.
                // This prevents the "infinite growing" bug when switching tabs.
                ['revenue-chart', 'top-products-chart', 'category-sales-chart'].forEach(chartId => {
                    const chart = Chart.getChart(chartId);
                    if (chart) {
                        chart.destroy();
                    }
                });

                const commonOptions = {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)'}, ticks: {color: 'var(--text-secondary)'} }, x: { grid: { display: false }, ticks: {color: 'var(--text-secondary)'} } },
                    plugins: { legend: { labels: { color: 'var(--text-secondary)' } } }
                };

                // Revenue Chart
                new Chart(pane.querySelector('#revenue-chart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['June', 'July', 'August', 'September'],
                        datasets: [{ label: 'Monthly Revenue', data: [5200, 7800, 6900, 9250], backgroundColor: 'rgba(0, 123, 255, 0.6)', borderColor: 'rgb(0, 123, 255)', borderWidth: 1 }]
                    },
                    options: commonOptions
                });

                // Top Products Chart
                const topProducts = [...mockDB.products].sort((a,b) => b.sales - a.sales).slice(0, 5);
                new Chart(pane.querySelector('#top-products-chart').getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: topProducts.map(p => p.name),
                        datasets: [{ label: 'Units Sold', data: topProducts.map(p => p.sales), backgroundColor: ['#007BFF', '#28a745', '#ffc107', '#dc3545', '#17a2b8'] }]
                    },
                    options: { ...commonOptions, scales: {} }
                });

                // Category Sales
                const categorySales = mockDB.products.reduce((acc, p) => {
                    acc[p.category] = (acc[p.category] || 0) + p.sales;
                    return acc;
                }, {});
                new Chart(pane.querySelector('#category-sales-chart').getContext('2d'), {
                    type: 'polarArea',
                    data: {
                        labels: Object.keys(categorySales),
                        datasets: [{ label: 'Sales by Category', data: Object.values(categorySales), backgroundColor: ['rgba(0, 123, 255, 0.7)', 'rgba(40, 167, 69, 0.7)', 'rgba(255, 193, 7, 0.7)', 'rgba(220, 53, 69, 0.7)', 'rgba(23, 162, 184, 0.7)'] }]
                    },
                     options: { ...commonOptions, scales: { r: { grid: { color: 'rgba(255,255,255,0.05)'}, ticks: {color: 'var(--text-secondary)', backdropColor: 'transparent'} } } }
                });
            }
            
            function initSettings(pane) {
                const selectorContainer = pane.querySelector('#receipt-template-selector');
                const renderSelector = () => {
                    selectorContainer.innerHTML = `
                        <p class="text-sm text-text-secondary mb-4">Choose the default design for printed and digital receipts.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            ${Object.entries(receiptTemplates).map(([key, template]) => `
                                <div data-action="select-template" data-template-id="${key}" class="template-selector rounded-lg p-4 bg-bg-secondary ${appState.settings.selectedReceiptTemplate === key ? 'active' : ''}">
                                    <div class="flex justify-between items-start mb-2">
                                        <h4 class="font-semibold text-text-primary capitalize pr-2">${template.name}</h4>
                                        <button data-action="preview-template" data-template-id="${key}" class="btn btn-secondary p-1 h-auto text-xs shrink-0"><i data-lucide="eye" class="w-4 h-4"></i></button>
                                    </div>
                                    <div class="h-40 bg-bg-tertiary rounded overflow-hidden pointer-events-none scale-[30%] origin-top-left -mb-28">
                                        ${template.preview}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    lucide.createIcons();
                };
                renderSelector();
                selectorContainer.addEventListener('click', e => {
                    const previewTarget = e.target.closest('[data-action="preview-template"]');
                    const selectTarget = e.target.closest('[data-action="select-template"]');

                    if (previewTarget) {
                        e.stopPropagation();
                        const templateId = previewTarget.dataset.templateId;
                        showLargeReceiptPreview(templateId);
                    } else if (selectTarget) {
                        const templateId = selectTarget.dataset.templateId;
                        if (appState.settings.selectedReceiptTemplate !== templateId) {
                            appState.settings.selectedReceiptTemplate = templateId;
                            showToast(`Receipt template set to "${receiptTemplates[templateId].name}".`, 'info');
                            renderSelector();
                        }
                    }
                });
            }

            function openCustomerModal(customerId = null, callback = null) {
                const customer = customerId ? mockDB.customers.find(c => c.id === customerId) : {};
                const isEditing = !!customerId;
                const content = `<form id="customer-form" class="space-y-4"><div><label class="block text-sm font-medium text-text-secondary mb-1">Full Name</label><input type="text" name="name" value="${customer.name || ''}" class="w-full form-input" required></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-secondary mb-1">Email</label><input type="email" name="email" value="${customer.email || ''}" class="w-full form-input"></div><div><label class="block text-sm font-medium text-text-secondary mb-1">Phone</label><input type="tel" name="phone" value="${customer.phone || ''}" class="w-full form-input"></div></div><div><label class="block text-sm font-medium text-text-secondary mb-1">Address</label><input type="text" name="address" value="${customer.address || ''}" class="w-full form-input"></div><div><label class="block text-sm font-medium text-text-secondary mb-1">Loyalty ID</label><input type="text" name="loyaltyId" value="${customer.loyaltyId || `CS-${(customer.name || 'CUST').substring(0,2).toUpperCase()}-${Date.now().toString().slice(-3)}`}" class="w-full form-input"></div></form>`;
                const footer = `<button type="button" data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="customer-form" class="btn btn-primary">${isEditing ? 'Save Changes' : 'Create Customer'}</button>`;
                const modal = showModal(isEditing ? 'Edit Customer' : 'Add New Customer', content, footer, { size: 'max-w-2xl' });
                modal.querySelector('#customer-form').addEventListener('submit', (ev) => {
                    ev.preventDefault();
                    const formData = new FormData(ev.target);
                    const newCustomerData = { name: formData.get('name'), email: formData.get('email'), phone: formData.get('phone'), address: formData.get('address'), loyaltyId: formData.get('loyaltyId') };
                    const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
                    
                    if(isEditing) {
                        const index = mockDB.customers.findIndex(c => c.id === customerId);
                        mockDB.customers[index] = { ...mockDB.customers[index], ...newCustomerData };
                    } else {
                        const newCustomer = { id: `CUST${Date.now().toString().slice(-4)}`, loyaltyPoints: 0, joinDate: new Date().toISOString().slice(0,10), ...newCustomerData };
                        mockDB.customers.push(newCustomer);
                        if (callback) callback(newCustomer);
                    }
                     if (activeTab?.viewType === 'customers' || activeTab?.viewType === 'pos') renderApp();
                    showToast(`Customer ${isEditing ? 'updated' : 'added'} successfully!`);
                    closeModal(modal);
                });
            }
            
            // --- RESPONSIVE SIDEBAR LOGIC ---
            const toggleMobileSidebar = (forceClose = false) => {
                const isOpen = sidebar.classList.contains('mobile-open');
                if (forceClose || isOpen) {
                    sidebar.classList.remove('mobile-open');
                    sidebarBackdrop.classList.add('hidden');
                } else {
                    sidebar.classList.add('mobile-open');
                    sidebarBackdrop.classList.remove('hidden');
                }
            };

            const checkScreenSize = () => {
                const isMobile = window.innerWidth < 1024;
                if (isMobile) {
                    toggleMobileSidebar(true); // Ensure it's closed on resize
                    sidebar.classList.remove('sidebar-collapsed', 'w-20');
                    sidebar.classList.add('w-64');
                    sidebarToggleBtn.innerHTML = `<i data-lucide="menu" class="w-6 h-6"></i>`;
                } else {
                    sidebarToggleBtn.innerHTML = `<i data-lucide="${appState.isSidebarCollapsed ? 'panel-right-close' : 'panel-left-close'}" class="w-6 h-6"></i>`;
                }
                lucide.createIcons();
            };
            
            // --- GLOBAL EVENT LISTENERS ---
            sidebarToggleBtn.addEventListener('click', () => {
                if (window.innerWidth < 1024) {
                    toggleMobileSidebar();
                } else {
                    appState.isSidebarCollapsed = !appState.isSidebarCollapsed;
                    sidebar.classList.toggle('w-64', !appState.isSidebarCollapsed);
                    sidebar.classList.toggle('w-20', appState.isSidebarCollapsed);
                    sidebar.classList.toggle('sidebar-collapsed', appState.isSidebarCollapsed);
                    sidebarToggleBtn.innerHTML = `<i data-lucide="${appState.isSidebarCollapsed ? 'panel-right-close' : 'panel-left-close'}" class="w-6 h-6"></i>`;
                    lucide.createIcons();
                }
            });
            
            sidebarBackdrop.addEventListener('click', () => toggleMobileSidebar(true));

            document.getElementById('main-nav').addEventListener('click', e => {
                 const viewTarget = e.target.closest('[data-view]');
                if (viewTarget) { 
                    e.preventDefault(); 
                    openOrSwitchTab(viewTarget.dataset.view); 
                    if (window.innerWidth < 1024) {
                        toggleMobileSidebar(true);
                    }
                }
            });

            document.body.addEventListener('click', e => {
                const actionTarget = e.target.closest('[data-action]');
                if (!actionTarget) return;
                const action = actionTarget.dataset.action;
                const currentViewPane = workspaceContent.querySelector('.view-pane');
                
                // --- Main Tab Actions ---
                if (action === 'switch-tab') { appState.activeTabId = actionTarget.dataset.id; renderApp(); }
                if (action === 'close-tab') {
                    e.stopPropagation();
                    const tabIdToClose = actionTarget.dataset.id;
                    const tabIndex = appState.tabs.findIndex(t => t.id === tabIdToClose);
                    appState.tabs.splice(tabIndex, 1);
                    if (appState.activeTabId === tabIdToClose) {
                        const newActiveTab = appState.tabs[tabIndex] || appState.tabs[tabIndex - 1];
                        appState.activeTabId = newActiveTab ? newActiveTab.id : null;
                    }
                    renderApp();
                }

                // --- POS Actions ---
                const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
                if(activeTab?.viewType === 'pos') {
                    const activeSale = posState.sales.find(s => s.id === posState.activeSaleId);
                    switch(action) {
                        case 'new-sale': {
                            const newSaleId = `sale_${Date.now()}`;
                            posState.sales.push({ id: newSaleId, name: `Sale ${posState.saleCounter++}`, cart: [], customer: null, status: 'active' });
                            posState.activeSaleId = newSaleId;
                            posFullRender(currentViewPane);
                            currentViewPane.querySelector('#pos-tabs-container').scrollTo({ left: 9999, behavior: 'smooth' });
                            break;
                        }
                        case 'switch-sale': posState.activeSaleId = actionTarget.dataset.id; posFullRender(currentViewPane); break;
                        case 'close-sale': {
                             e.stopPropagation();
                             const saleIdToClose = actionTarget.dataset.id;
                             const sale = posState.sales.find(s => s.id === saleIdToClose);
                             if (sale?.cart.length > 0 && sale.status !== 'held') {
                                const confirmModal = showModal('Unsaved Sale', 'This sale has items in it. Are you sure you want to close and discard it?', `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-close-sale" class="btn btn-danger">Discard Sale</button>`);
                                confirmModal.querySelector('#confirm-close-sale').addEventListener('click', () => {
                                    posState.sales = posState.sales.filter(s => s.id !== saleIdToClose);
                                    if (posState.activeSaleId === saleIdToClose) posState.activeSaleId = posState.sales.length > 0 ? posState.sales[0].id : null;
                                    posFullRender(currentViewPane);
                                    closeModal(confirmModal);
                                });
                             } else {
                                posState.sales = posState.sales.filter(s => s.id !== saleIdToClose);
                                if (posState.activeSaleId === saleIdToClose) posState.activeSaleId = posState.sales.length > 0 ? posState.sales[0].id : null;
                                posFullRender(currentViewPane);
                             }
                             break;
                        }
                        case 'hold-sale': {
                            if (activeSale) {
                                activeSale.status = 'held';
                                const nextActiveSale = posState.sales.find(s => s.status === 'active' && s.id !== activeSale.id) || null;
                                if (!nextActiveSale) {
                                    const newSaleId = `sale_${Date.now()}`;
                                    posState.sales.push({ id: newSaleId, name: `Sale ${posState.saleCounter++}`, cart: [], customer: null, status: 'active' });
                                    posState.activeSaleId = newSaleId;
                                } else {
                                    posState.activeSaleId = nextActiveSale.id;
                                }
                                posFullRender(currentViewPane);
                                showToast(`${activeSale.name} put on hold.`, 'info');
                            }
                            break;
                        }
                        case 'cancel-sale': {
                            if (!activeSale || activeSale.cart.length === 0) return;
                            const confirmModal = showModal('Cancel Sale', 'Are you sure you want to clear all items from the current cart?', `<button data-action="close-modal" class="btn btn-secondary">No</button><button id="confirm-cancel-sale" class="btn btn-danger">Yes, Clear Cart</button>`);
                            confirmModal.querySelector('#confirm-cancel-sale').addEventListener('click', () => {
                                activeSale.cart = [];
                                activeSale.customer = null;
                                posFullRender(currentViewPane);
                                closeModal(confirmModal);
                                showToast('Cart cleared.', 'info');
                            });
                            break;
                        }
                        case 'remove-from-cart': {
                             if(activeSale) {
                                activeSale.cart = activeSale.cart.filter(item => item.id !== actionTarget.dataset.id);
                                posFullRender(currentViewPane);
                             }
                             break;
                        }
                        case 'process-payment': {
                            if (!activeSale || activeSale.cart.length === 0) { showToast('Cart is empty!', 'error'); return; }
                            const total = activeSale.cart.reduce((acc, i) => acc + (i.price * i.qty), 0) * 1.10;
                            
                            // --- Advanced Payment Modal Logic ---
                            const paymentState = {
                                total,
                                payments: [],
                                activePaymentMethod: 'Cash',
                                userInputStarted: false, // Track if user has started typing
                                get totalPaid() { return this.payments.reduce((sum, p) => sum + p.amount, 0); },
                                get remaining() { return this.total - this.totalPaid; }
                            };

                            const getPaymentIcons = (method) => ({'Cash': 'dollar-sign', 'Card': 'credit-card', 'QR Code': 'qr-code'})[method];
                            
                            const content = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 -m-6 p-0">
                                <!-- Left Side: Keypad & Info -->
                                <div class="bg-[var(--bg-secondary)]/50 p-6 rounded-l-xl flex flex-col">
                                    <div class="flex-1 space-y-4">
                                        <p class="text-text-secondary">Total Due</p>
                                        <p class="text-6xl font-bold text-text-primary font-mono tracking-tighter">$${total.toFixed(2)}</p>
                                        <div id="payment-status-display" class="h-16"></div>
                                        <div class="space-y-2 pt-2" id="payment-splits-container"></div>
                                    </div>
                                    <div class="grid grid-cols-4 gap-2">
                                        ${[...[100, 50, 20].filter(v => v > total), Math.ceil(total), 'Exact'].map(val => `<button data-payment-action="quick-cash" data-amount="${val === 'Exact' ? total.toFixed(2) : val}" class="keypad-btn rounded-md h-14 text-lg font-semibold">${val === 'Exact' ? 'Exact' : `$${val}`}</button>`).join('')}
                                    </div>
                                </div>
                                <!-- Right Side: Actions -->
                                <div class="p-6 flex flex-col">
                                    <div class="grid grid-cols-3 gap-3 mb-4">
                                        <button data-payment-action="set-method" data-method="Cash" class="payment-method-btn btn btn-secondary h-16 flex-col gap-1 active"><i data-lucide="dollar-sign" class="w-6 h-6"></i>Cash</button>
                                        <button data-payment-action="set-method" data-method="Card" class="payment-method-btn btn btn-secondary h-16 flex-col gap-1"><i data-lucide="credit-card" class="w-6 h-6"></i>Card</button>
                                        <button data-payment-action="set-method" data-method="QR Code" class="payment-method-btn btn btn-secondary h-16 flex-col gap-1"><i data-lucide="qr-code" class="w-6 h-6"></i>QR</button>
                                    </div>
                                    <div class="relative mb-4">
                                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-2xl font-mono text-text-secondary">$</span>
                                        <input type="text" id="payment-input" class="form-input w-full text-right text-4xl font-mono p-4 pr-6 bg-transparent" value="${paymentState.remaining.toFixed(2)}" readonly>
                                    </div>
                                    <div class="grid grid-cols-3 gap-2 flex-1">
                                        ${['1', '2', '3', '4', '5', '6', '7', '8', '9', '00', '0', '.'].map(key => `<button data-payment-action="keypad" data-key="${key}" class="keypad-btn rounded-md text-2xl font-mono h-full">${key}</button>`).join('')}
                                        <button data-payment-action="keypad" data-key="del" class="keypad-btn rounded-md text-2xl font-mono h-full flex items-center justify-center"><i data-lucide="delete" class="w-6 h-6 pointer-events-none"></i></button>
                                    </div>
                                    <button id="add-payment-btn" data-payment-action="add-payment" class="btn btn-primary w-full mt-4 text-lg py-4">Add Payment</button>
                                </div>
                            </div>`;
                            
                            const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel Transaction</button><button id="finalize-payment" class="btn btn-success text-white" disabled><i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>Finalize Payment</button>`;
                            const modal = showModal('Process Payment', content, footer, {size: 'max-w-4xl', customClasses: 'p-0'});
                            lucide.createIcons();
                            
                            const inputEl = modal.querySelector('#payment-input');
                            const statusDisplay = modal.querySelector('#payment-status-display');
                            const splitsContainer = modal.querySelector('#payment-splits-container');
                            const addPaymentBtn = modal.querySelector('#add-payment-btn');
                            const finalizeBtn = modal.querySelector('#finalize-payment');

                            const renderPaymentState = () => {
                                // Update input, rounding to avoid floating point issues
                                const remainingValue = parseFloat(paymentState.remaining.toPrecision(15));
                                inputEl.value = remainingValue > 0 ? remainingValue.toFixed(2) : '0.00';
                                
                                // Update status display
                                if (remainingValue > 0.001) {
                                    statusDisplay.innerHTML = `<p class="text-text-secondary">Amount Remaining</p><p class="text-4xl font-bold text-danger font-mono tracking-tight">-$${remainingValue.toFixed(2)}</p>`;
                                    const inputValue = parseFloat(inputEl.value) || 0;
                                    addPaymentBtn.textContent = `Add $${inputValue.toFixed(2)} Payment`;
                                    addPaymentBtn.disabled = inputValue <= 0;
                                    finalizeBtn.disabled = true;
                                } else {
                                    const change = Math.abs(remainingValue);
                                    statusDisplay.innerHTML = `<p class="text-text-secondary">Change Due</p><p class="text-4xl font-bold text-success font-mono tracking-tight">$${change.toFixed(2)}</p>`;
                                    addPaymentBtn.textContent = 'Add Payment';
                                    addPaymentBtn.disabled = true;
                                    finalizeBtn.disabled = false;
                                }

                                // Update splits
                                splitsContainer.innerHTML = paymentState.payments.map((p, i) => `
                                    <div class="payment-split-item flex items-center justify-between p-2 bg-bg-tertiary rounded-md text-sm">
                                        <div class="flex items-center gap-2"><i data-lucide="${getPaymentIcons(p.method)}" class="w-4 h-4 text-accent"></i><span>${p.method} Payment</span></div>
                                        <div class="flex items-center gap-2"><span class="font-mono text-text-primary font-medium">$${p.amount.toFixed(2)}</span><button data-payment-action="remove-split" data-index="${i}" class="text-danger/70 hover:text-danger"><i data-lucide="x" class="w-4 h-4"></i></button></div>
                                    </div>
                                `).join('');
                                lucide.createIcons();
                                // After rendering, reset the input flag so the next keypad press clears the default value.
                                paymentState.userInputStarted = false;
                            };

                            modal.addEventListener('click', e => {
                                const target = e.target.closest('[data-payment-action]');
                                if (!target) return;
                                const { paymentAction, method, amount, key, index } = target.dataset;

                                switch (paymentAction) {
                                    case 'set-method':
                                        paymentState.activePaymentMethod = method;
                                        modal.querySelectorAll('.payment-method-btn').forEach(btn => btn.classList.remove('active'));
                                        target.classList.add('active');
                                        break;
                                    case 'quick-cash':
                                        inputEl.value = parseFloat(amount).toFixed(2);
                                        paymentState.userInputStarted = true; // Set flag as this is an input
                                        paymentState.activePaymentMethod = 'Cash';
                                        modal.querySelectorAll('.payment-method-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.method === 'Cash'));
                                        document.getElementById('add-payment-btn').click();
                                        break;
                                    case 'keypad': {
                                        let currentVal = inputEl.value;
                                        // On first key press, clear the existing amount and start fresh
                                        if (!paymentState.userInputStarted) {
                                            currentVal = '0';
                                            paymentState.userInputStarted = true;
                                        }

                                        if (key === 'del') {
                                            currentVal = currentVal.slice(0, -1) || '0';
                                        } else if (key === '.' && !currentVal.includes('.')) {
                                            currentVal += '.';
                                        } else if (key === '00' && currentVal !== '0') {
                                            currentVal += '00';
                                        } else if (!isNaN(parseInt(key))) { // handles '1' through '9' and '0'
                                            if (currentVal === '0' && key !== '.') {
                                                currentVal = key;
                                            } else {
                                                // Prevent excessive length
                                                if (currentVal.length < 12) currentVal += key;
                                            }
                                        }
                                        inputEl.value = currentVal;
                                        break;
                                    }
                                    case 'add-payment': {
                                        const paymentAmount = parseFloat(inputEl.value);
                                        if (paymentAmount > 0) {
                                            paymentState.payments.push({ method: paymentState.activePaymentMethod, amount: paymentAmount, ref: (paymentState.activePaymentMethod !== 'Cash' ? `TRX_${Date.now()}`: null) });
                                            renderPaymentState();
                                        }
                                        break;
                                    }
                                     case 'remove-split':
                                        paymentState.payments.splice(parseInt(index), 1);
                                        renderPaymentState();
                                        break;
                                }
                                // Update button state after keypad press or method change
                                if (paymentAction === 'keypad' || paymentAction === 'set-method') {
                                     const inputValue = parseFloat(inputEl.value) || 0;
                                     if(paymentState.remaining > 0.001) {
                                        addPaymentBtn.textContent = `Add $${inputValue.toFixed(2)} Payment`;
                                        addPaymentBtn.disabled = inputValue <= 0;
                                     }
                                }
                            });
                            
                            inputEl.addEventListener('input', () => {
                                // This is a fallback for manual input if readonly is removed, but mainly to keep state consistent.
                                const inputValue = parseFloat(inputEl.value) || 0;
                                if(paymentState.remaining > 0.001) {
                                    addPaymentBtn.textContent = `Add $${inputValue.toFixed(2)} Payment`;
                                    addPaymentBtn.disabled = inputValue <= 0;
                                }
                            });

                            finalizeBtn.addEventListener('click', () => {
                                // 1. Update stock and sales figures
                                activeSale.cart.forEach(cartItem => {
                                    const product = mockDB.products.find(p => p.id === cartItem.id);
                                    if(product) {
                                        product.stock -= cartItem.qty;
                                        product.sales += cartItem.qty;
                                    }
                                });

                                // 2. Award loyalty points
                                const customer = activeSale.customer ? mockDB.customers.find(c => c.id === activeSale.customer.id) : null;
                                const pointsEarned = Math.floor(total);
                                if (customer) customer.loyaltyPoints += pointsEarned;
                                
                                // 3. Create invoice
                                const newInvoice = { 
                                    id: `INV${Date.now().toString().slice(-4)}`, 
                                    customerId: customer?.id, 
                                    customerName: customer?.name || 'Walk-in Customer',
                                    customer,
                                    total: total, 
                                    status: 'Paid', 
                                    date: new Date().toISOString(), 
                                    items: activeSale.cart, 
                                    paymentDetails: paymentState.payments,
                                    cashier: appState.session.cashier,
                                    storeId: appState.session.storeId,
                                    pointsEarned,
                                };
                                mockDB.invoices.push(newInvoice);
                                
                                closeModal(modal);
                                showReceipt(newInvoice, paymentState);

                                posState.sales = posState.sales.filter(s => s.id !== activeSale.id);
                                if (posState.activeSaleId === activeSale.id) {
                                    const nextSale = posState.sales.find(s => s.status !== 'held') || posState.sales[0] || null;
                                    posState.activeSaleId = nextSale ? nextSale.id : null;
                                    if (!posState.activeSaleId && posState.sales.length === 0) {
                                         const newSaleId = `sale_${Date.now()}`;
                                         posState.sales.push({ id: newSaleId, name: `Sale ${posState.saleCounter++}`, cart: [], customer: null, status: 'active' });
                                         posState.activeSaleId = newSaleId;
                                    }
                                }
                                posFullRender(currentViewPane);
                            });

                            renderPaymentState();
                            break;
                        }
                        case 'add-customer-to-sale': {
                            if(!activeSale) { showToast('No active sale', 'error'); return; }
                            let content = `
                                <input type="text" id="customer-search" placeholder="Search by name, phone, or email..." class="form-input w-full mb-4">
                                <div id="customer-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                                <div class="text-center pt-4 border-t border-border-color mt-4">
                                    <button id="create-new-customer-btn" class="btn btn-secondary w-full">
                                        <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>Create New Customer
                                    </button>
                                </div>
                            `;
                            const modal = showModal('Select Customer', content, '');
                            lucide.createIcons();
                            const customerListEl = modal.querySelector('#customer-list');

                            const renderCustomerList = (filter = '') => {
                                const query = filter.toLowerCase();
                                const filteredCustomers = mockDB.customers.filter(c => 
                                    c.name.toLowerCase().includes(query) ||
                                    c.phone.includes(query) ||
                                    c.email.toLowerCase().includes(query)
                                );
                                customerListEl.innerHTML = filteredCustomers.length > 0
                                    ? filteredCustomers.map(c => `<div data-action="select-customer" data-id="${c.id}" class="p-3 rounded-lg hover:bg-bg-tertiary cursor-pointer"><p class="font-medium text-text-primary">${c.name}</p><p class="text-sm">${c.phone}</p></div>`).join('')
                                    : '<p class="text-center text-sm p-4">No customers found.</p>';
                            };

                            modal.querySelector('#customer-search').addEventListener('input', e => renderCustomerList(e.target.value));
                            
                            customerListEl.addEventListener('click', e => {
                                 const customerTarget = e.target.closest('[data-action="select-customer"]');
                                 if(customerTarget) {
                                     const customer = mockDB.customers.find(c => c.id === customerTarget.dataset.id);
                                     activeSale.customer = customer;
                                     activeSale.status = 'active'; // Reactivate if held
                                     posFullRender(currentViewPane);
                                     closeModal(modal);
                                 }
                            });

                            modal.querySelector('#create-new-customer-btn').addEventListener('click', () => {
                                closeModal(modal);
                                openCustomerModal(null, (newCustomer) => {
                                    if (activeSale && newCustomer) {
                                        activeSale.customer = newCustomer;
                                        posFullRender(currentViewPane);
                                    }
                                });
                            });

                             renderCustomerList();
                             break;
                        }
                        case 'remove-customer-from-sale': {
                            if(activeSale) activeSale.customer = null;
                            posFullRender(currentViewPane);
                            break;
                        }
                    }
                }
                
                // --- Universal Actions ---
                if (action === 'close-modal') { closeModal(actionTarget.closest('.modal-overlay')); }

                if (action === 'add-product' || action === 'edit-product') {
                    const productId = actionTarget.dataset.id;
                    const product = productId ? mockDB.products.find(p => p.id === productId) : {};
                    const isEditing = !!productId;
                    const content = `<form id="product-form" class="space-y-4"><input type="hidden" name="id" value="${product.id || ''}"><div><label class="block text-sm font-medium text-text-secondary mb-1">Product Name</label><input type="text" name="name" value="${product.name || ''}" class="w-full form-input" required></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-secondary mb-1">Category</label><input type="text" name="category" value="${product.category || ''}" class="w-full form-input"></div><div><label class="block text-sm font-medium text-text-secondary mb-1">SKU</label><input type="text" name="sku" value="${product.id || `SKU${Date.now().toString().slice(-4)}`}" class="w-full form-input bg-bg-tertiary" ${isEditing ? 'readonly' : ''}></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-secondary mb-1">Price</label><input type="number" name="price" step="0.01" value="${product.price || ''}" class="w-full form-input" required></div><div><label class="block text-sm font-medium text-text-secondary mb-1">Stock</label><input type="number" name="stock" value="${product.stock || ''}" class="w-full form-input" required></div></div><div><label class="block text-sm font-medium text-text-secondary mb-1">Warranty Info</label><input type="text" name="warrantyInfo" value="${product.warrantyInfo || 'N/A'}" class="w-full form-input"></div></form>`;
                    const footer = `<button type="button" data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="product-form" class="btn btn-primary">${isEditing ? 'Save Changes' : 'Create Product'}</button>`;
                    const modal = showModal(isEditing ? 'Edit Product' : 'Add New Product', content, footer);
                    
                    modal.querySelector('#product-form').addEventListener('submit', (ev) => {
                        ev.preventDefault();
                        const formData = new FormData(ev.target);
                        const newProductData = { id: formData.get('sku'), name: formData.get('name'), category: formData.get('category'), price: parseFloat(formData.get('price')), stock: parseInt(formData.get('stock')), warrantyInfo: formData.get('warrantyInfo') };
                        if (isEditing) {
                            const index = mockDB.products.findIndex(p => p.id === productId);
                            mockDB.products[index] = { ...mockDB.products[index], ...newProductData };
                        } else { mockDB.products.push({...newProductData, sales: 0}); }
                        
                        if (activeTab?.viewType === 'inventory') renderApp();
                        showToast(`Product ${isEditing ? 'updated' : 'added'} successfully!`);
                        closeModal(modal);
                    });
                }
                
                 if (action === 'add-customer' || action === 'edit-customer') {
                    const customerId = actionTarget.dataset.id;
                    openCustomerModal(customerId);
                 }

                 if(action === 'view-invoice') {
                     const invoiceId = actionTarget.dataset.id;
                     const invoice = mockDB.invoices.find(i => i.id === invoiceId);
                     if(!invoice) return;
                     // Enrich invoice with full customer details if they exist
                     if (invoice.customerId) {
                        invoice.customer = mockDB.customers.find(c => c.id === invoice.customerId);
                     }
                     showReceipt(invoice);
                 }
                 
                if (action === 'open-search') {
                    const content = `<div class="relative"><i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i><input type="text" id="global-search-input" placeholder="Search products, customers, invoices..." class="w-full form-input pl-12 p-3 text-lg" autocomplete="off"></div><div id="global-search-results" class="mt-2 -mx-6 -mb-6 px-4 pb-4 text-sm max-h-[60vh] overflow-y-auto bg-[var(--bg-secondary)] rounded-b-xl"></div>`;
                    const modal = showModal('Search', content, '', { size: 'max-w-2xl', customClasses: 'p-0' });
                    const input = modal.querySelector('#global-search-input');
                    const resultsEl = modal.querySelector('#global-search-results');
                    let activeIndex = -1;

                    const executeNavigation = (item) => {
                        if (!item) return;
                        const { type, id } = item.dataset;
                        openOrSwitchTab(type);
                        
                        setTimeout(() => { 
                            if (type === 'inventory') document.querySelector(`button[data-action="edit-product"][data-id="${id}"]`).click();
                            else if (type === 'customers') document.querySelector(`button[data-action="edit-customer"][data-id="${id}"]`).click();
                            else if (type === 'invoices') document.querySelector(`button[data-action="view-invoice"][data-id="${id}"]`).click();
                        }, 100);

                        closeModal(modal);
                    };

                    const updateActive = (newIndex) => {
                        const items = resultsEl.querySelectorAll('.search-result-item');
                        if (activeIndex > -1 && items[activeIndex]) items[activeIndex].classList.remove('active');
                        if (newIndex > -1 && items[newIndex]) {
                            items[newIndex].classList.add('active');
                            items[newIndex].scrollIntoView({ block: 'nearest' });
                        }
                        activeIndex = newIndex;
                    };

                    input.focus();
                    input.addEventListener('input', e => {
                        const query = e.target.value.toLowerCase();
                        activeIndex = -1;
                        if (query.length < 1) { resultsEl.innerHTML = '<p class="text-center text-text-secondary py-8">Start typing to see results.</p>'; return; }

                        const productResults = mockDB.products.filter(p => p.name.toLowerCase().includes(query) || p.id.toLowerCase().includes(query));
                        const customerResults = mockDB.customers.filter(c => 
                            c.name.toLowerCase().includes(query) ||
                            c.phone.includes(query) ||
                            c.email.toLowerCase().includes(query)
                        );
                        const invoiceResults = mockDB.invoices.filter(i => i.id.toLowerCase().includes(query) || i.customerName.toLowerCase().includes(query));
                        
                        let html = '';
                        if (productResults.length > 0) html += `<h4 class="font-semibold text-text-primary mb-1 mt-2 px-4">Products</h4>` + productResults.map(p => `<a href="#" class="search-result-item flex items-center gap-4 p-3 mx-2 rounded-lg" data-type="inventory" data-id="${p.id}"><i data-lucide="box" class="w-5 h-5 text-text-secondary"></i><div><strong>${p.name}</strong> <span class="text-xs font-mono text-text-secondary">${p.id}</span></div></a>`).join('');
                        if (customerResults.length > 0) html += `<h4 class="font-semibold text-text-primary mb-1 mt-2 px-4">Customers</h4>` + customerResults.map(c => `<a href="#" class="search-result-item flex items-center gap-4 p-3 mx-2 rounded-lg" data-type="customers" data-id="${c.id}"><i data-lucide="user" class="w-5 h-5 text-text-secondary"></i><div><strong>${c.name}</strong> <span class="text-xs text-text-secondary">${c.phone}</span></div></a>`).join('');
                        if (invoiceResults.length > 0) html += `<h4 class="font-semibold text-text-primary mb-1 mt-2 px-4">Invoices</h4>` + invoiceResults.map(i => `<a href="#" class="search-result-item flex items-center gap-4 p-3 mx-2 rounded-lg" data-type="invoices" data-id="${i.id}"><i data-lucide="file-text" class="w-5 h-5 text-text-secondary"></i><div><strong>${i.id}</strong> <span class="text-xs text-text-secondary">for ${i.customerName}</span></div></a>`).join('');
                        resultsEl.innerHTML = html || '<p class="text-center text-text-secondary py-8">No results found.</p>';
                        lucide.createIcons();
                    });

                    resultsEl.addEventListener('click', e => { e.preventDefault(); const target = e.target.closest('.search-result-item'); if (target) executeNavigation(target); });
                    
                    input.addEventListener('keydown', e => {
                        const items = resultsEl.querySelectorAll('.search-result-item');
                        if (items.length === 0) return;
                        if (e.key === 'ArrowDown') { e.preventDefault(); updateActive(activeIndex < items.length - 1 ? activeIndex + 1 : 0); } 
                        else if (e.key === 'ArrowUp') { e.preventDefault(); updateActive(activeIndex > 0 ? activeIndex - 1 : items.length - 1); } 
                        else if (e.key === 'Enter') { e.preventDefault(); const activeItem = resultsEl.querySelector('.search-result-item.active'); if (activeItem) executeNavigation(activeItem); }
                    });
                }


                 if (action === 'open-notifications') {
                    const icons = { stock: 'box', info: 'info', sale: 'dollar-sign' };
                    const content = mockDB.notifications.map(n => `
                        <div class="flex gap-4 items-start p-3 border-b border-border-color last:border-b-0 ${n.read ? 'opacity-60' : ''}">
                            <i data-lucide="${icons[n.type]}" class="w-5 h-5 mt-1 text-text-secondary"></i>
                            <div class="flex-1">
                                <p class="text-text-primary text-sm">${n.message}</p>
                                <p class="text-xs text-text-secondary mt-1">${n.date}</p>
                            </div>
                            ${!n.read ? '<div class="w-2 h-2 bg-accent rounded-full mt-2 shrink-0"></div>' : ''}
                        </div>`).join('');
                    const footer = `<button id="mark-all-read" class="btn btn-secondary text-sm py-2 px-3">Mark all as read</button>`;
                    const modal = showModal('Notifications', `<div class="max-h-96 overflow-y-auto -mx-6">${content}</div>`, footer, {customClasses: 'p-0'});
                    modal.querySelector('#mark-all-read').addEventListener('click', () => {
                        mockDB.notifications.forEach(n => n.read = true);
                        closeModal(modal);
                        showToast('All notifications marked as read.');
                    });
                 }
            });

            document.getElementById('ai-assistant-btn').addEventListener('click', () => {
                const content = `<div class="flex flex-col h-96"><div class="flex-1 overflow-y-auto p-4 space-y-4 text-sm" id="ai-chat-history"><div class="flex gap-3"><div class="bg-accent text-white w-8 h-8 rounded-full flex items-center justify-center shrink-0"><i data-lucide="sparkles" class="w-5 h-5"></i></div><p class="bg-bg-tertiary rounded-lg p-3">Hello! I'm your AI assistant. How can I help you today? Ask me about sales trends, low-stock products, or customer insights.</p></div></div><div class="p-4 border-t border-border-color"><form id="ai-input-form" class="relative"><input type="text" id="ai-input" placeholder="Ask a question..." class="w-full form-input pr-12"><button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-accent text-white rounded-md hover:bg-accent-hover"><i data-lucide="send" class="w-5 h-5"></i></button></form></div></div>`;
                const modal = showModal('AI Assistant', content, '', {size: 'max-w-2xl', customClasses: 'p-0'});
                modal.querySelector('#ai-input-form').addEventListener('submit', e => {
                    e.preventDefault();
                    const input = modal.querySelector('#ai-input');
                    const history = modal.querySelector('#ai-chat-history');
                    if(!input.value) return;
                    history.innerHTML += `<div class="flex justify-end gap-3"><p class="bg-blue-600/50 text-blue-100 rounded-lg p-3 max-w-md">${input.value}</p></div>`;
                    // AI response logic would go here. For now, a mock response.
                    setTimeout(() => {
                        history.innerHTML += `<div class="flex gap-3"><div class="bg-accent text-white w-8 h-8 rounded-full flex items-center justify-center shrink-0"><i data-lucide="sparkles" class="w-5 h-5"></i></div><p class="bg-bg-tertiary rounded-lg p-3">Based on current trends, sales for "Bakery" items are expected to increase by 20% over the weekend.</p></div>`;
                        history.scrollTop = history.scrollHeight;
                    }, 1000);
                    input.value = '';
                })
            });
            
             document.body.addEventListener('input', e => {
                const actionTarget = e.target.closest('[data-action]');
                if (!actionTarget || actionTarget.dataset.action !== 'update-qty') return;
                const activeSale = posState.sales.find(s => s.id === posState.activeSaleId);
                const item = activeSale?.cart.find(i => i.id === actionTarget.dataset.id);
                if (item) {
                    const newQty = parseInt(e.target.value, 10);
                    if (newQty > 0 && newQty <= item.stock) {
                        item.qty = newQty;
                    } else {
                        e.target.value = item.qty; // Revert to old value if invalid
                        showToast(`Cannot set quantity to ${newQty}. Stock is ${item.stock}.`, 'error');
                    }
                    posFullRender(workspaceContent.querySelector('.view-pane'));
                }
             });
             
             const showLargeReceiptPreview = (templateId) => {
                const template = receiptTemplates[templateId];
                if (!template) return;

                // Create a mock invoice for a realistic preview
                const mockInvoice = {
                    id: 'PREVIEW-001',
                    customerName: 'Amelia Chen',
                    customer: mockDB.customers[1], // Use Jane Smith for detailed preview
                    total: 0, // Will be calculated
                    date: new Date().toISOString(),
                    items: [
                        {id: 'SKU001', name: 'Espresso Coffee Beans', qty: 1, price: 15.99},
                        {id: 'SKU101', name: 'Cybernetic Mousepad', qty: 1, price: 49.99},
                        {id: 'SKU005', name: 'Gourmet Chocolate Bar', qty: 3, price: 3.99}
                    ],
                    cashier: 'Preview Mode',
                    storeId: 'STR-PV',
                    pointsEarned: 0,
                };
                
                const subtotal = mockInvoice.items.reduce((acc, item) => acc + (item.price * item.qty), 0);
                const tax = subtotal * 0.10;
                mockInvoice.total = subtotal + tax;
                mockInvoice.pointsEarned = Math.floor(mockInvoice.total);

                const mockPaymentState = {
                    payments: [
                        { method: 'Card', amount: 80.00, ref: `TRX_${Date.now()}` },
                        { method: 'Cash', amount: 10.00 }
                    ],
                    total: mockInvoice.total,
                };
                
                const content = template.getBody(mockInvoice, mockPaymentState);
                const modal = showModal(`Preview: ${template.name}`, content, `<button data-action="close-modal" class="btn btn-secondary">Close</button>`, {size: 'max-w-2xl', customClasses: 'p-0'});
                lucide.createIcons();
             };

             const receiptTemplates = {
                modern: {
                    name: 'Futuristic',
                    preview: `<div class="bg-blue-900/50 p-4 font-sans text-[8px] leading-tight text-white"><div class="flex justify-between items-center"><div class="w-8 h-8 bg-blue-400 rounded-full flex items-center justify-center"><i data-lucide="gem" class="w-4 h-4 text-white"></i></div><p class="font-bold text-blue-300 text-[10px]">INVOICE</p></div><div class="mt-4 space-y-1"><div class="h-2 w-full bg-blue-500/50 rounded-full"></div><div class="h-2 w-3/4 bg-blue-500/50 rounded-full"></div></div><div class="mt-4 h-px bg-blue-400/50"></div><p class="text-right text-blue-300 font-bold text-[10px] mt-2">TOTAL: $25.00</p></div>`,
                    getBody: (invoice, paymentState) => {
                        const subtotal = invoice.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
                        const tax = invoice.total - subtotal;
                        const totalPaid = paymentState.payments.reduce((sum, p) => sum + p.amount, 0);
                        const changeDue = totalPaid - invoice.total;
                        
                        // AI Recommendation Logic
                        let recommendations = '';
                        const hasCoffee = invoice.items.some(i => i.id === 'SKU001');
                        const hasElectronics = invoice.items.some(i => i.category === 'Electronics');
                        if (hasCoffee) {
                            recommendations += `<p class="mt-1">You may also love our <span class="text-blue-300 font-semibold">Organic Green Tea</span>.</p>`;
                        }
                        if (!hasElectronics) {
                            recommendations += `<p class="mt-1">Check out our new <span class="text-blue-300 font-semibold">Cybernetic Mousepads</span> in store!</p>`;
                        }

                        let warrantyInfo = '';
                        const electronicItems = invoice.items.map(i => mockDB.products.find(p => p.id === i.id)).filter(p => p.category === 'Electronics');
                        if (electronicItems.length > 0) {
                             warrantyInfo = `<div class="mt-4 p-3 bg-blue-900/50 rounded-lg text-xs"><h4 class="font-bold text-blue-300 mb-1">Warranty Information</h4>${electronicItems.map(p => `<p><span class="font-medium">${p.name}:</span> ${p.warrantyInfo}</p>`).join('')}</div>`;
                        }
                        
                        return `<div class="bg-gray-900 text-gray-200 font-sans p-8" id="receipt-content" style="font-family: 'Inter', sans-serif; background: linear-gradient(145deg, #101827, #0b111e);">
                            <!-- 1. Header -->
                            <div class="flex justify-between items-start pb-4 border-b border-blue-800">
                                <div>
                                    <h1 class="text-2xl font-bold text-white flex items-center gap-3"><img src="${storeInfo.logoUrl}" class="w-8 h-8 rounded-full bg-blue-600/50" alt="logo"/> ${storeInfo.name}</h1>
                                    <p class="text-xs text-blue-300 mt-2">${storeInfo.address}<br>Ph: ${storeInfo.contact} | Web: ${storeInfo.website}<br>BIN: ${storeInfo.taxId}</p>
                                </div>
                                <div class="text-right">
                                    <h2 class="text-xl font-semibold text-white uppercase tracking-widest">Receipt</h2>
                                    <p class="text-sm font-mono text-blue-400">${invoice.id}</p>
                                </div>
                            </div>
                            <!-- 2. Transaction Info -->
                            <div class="flex justify-between text-xs mt-4 text-blue-300">
                                <p>Date: ${new Date(invoice.date).toLocaleString()}</p>
                                <p>Cashier: ${invoice.cashier} / Store: ${invoice.storeId}</p>
                            </div>
                            <!-- 3. Bill To -->
                             ${invoice.customer ? `<div class="mt-6 border-t border-blue-800 pt-4"><h3 class="text-sm font-semibold text-blue-300">Billed To:</h3><p class="text-white font-medium">${invoice.customer.name}</p><p class="text-xs text-blue-300">Loyalty ID: ${invoice.customer.loyaltyId}</p></div>` : ''}
                            <!-- 4. Itemized List -->
                            <div class="mt-6"><table class="w-full text-sm text-gray-300">
                                <thead><tr class="text-left text-blue-300 uppercase text-xs border-b-2 border-blue-800"><th class="py-2 font-semibold tracking-wider">Item / SKU</th><th class="py-2 text-center">Qty√óPrice</th><th class="py-2 text-right font-semibold tracking-wider">Total</th></tr></thead>
                                <tbody>${invoice.items.map(item => `<tr><td class="py-2 pr-2">${item.name}<br><span class="text-blue-400 text-xs font-mono">${item.id}</span></td><td class="py-2 text-center font-mono">${item.qty} √ó ${item.price.toFixed(2)}</td><td class="py-2 text-right font-mono">$${(item.qty * item.price).toFixed(2)}</td></tr>`).join('')}</tbody>
                            </table></div>
                            <!-- 5. Totals -->
                            <div class="mt-6 flex justify-end"><div class="w-full max-w-xs text-sm">
                                <div class="flex justify-between text-blue-300"><span>Subtotal:</span><span class="font-mono">$${subtotal.toFixed(2)}</span></div>
                                <div class="flex justify-between mt-1 text-blue-300"><span>Tax (10%):</span><span class="font-mono">$${tax.toFixed(2)}</span></div>
                                <div class="h-px bg-blue-800 my-2"></div>
                                <div class="flex justify-between font-bold text-2xl text-white"><span>Grand Total:</span><span class="font-mono">$${invoice.total.toFixed(2)}</span></div>
                            </div></div>
                            <!-- 6. Payment Info -->
                             <div class="mt-4 pt-4 border-t border-blue-800"><div class="w-full max-w-xs text-sm ml-auto">
                                ${paymentState.payments.map(p => `<div class="flex justify-between mt-1 text-blue-300"><span>Paid (${p.method}):</span><span class="font-mono">$${p.amount.toFixed(2)}</span></div>`).join('')}
                                ${changeDue > 0.001 ? `<div class="flex justify-between mt-1 font-semibold text-white"><span>Change Due:</span><span class="font-mono">$${changeDue.toFixed(2)}</span></div>` : ''}
                             </div></div>
                            <!-- 7. Customer Value -->
                            <div class="mt-6 text-center text-xs text-blue-300 p-3 bg-blue-500/10 rounded-lg">
                                <p>You earned <span class="font-bold text-white">${invoice.pointsEarned}</span> points on this purchase!</p>
                                <p class="mt-1">Get 15% OFF your next purchase with code: <span class="font-bold text-white font-mono bg-blue-500/20 px-1 py-0.5 rounded">WELCOME15</span></p>
                                <p class="mt-2 opacity-70">30-day return/exchange policy on most items.</p>
                            </div>
                            <!-- AI Add-ons -->
                            ${recommendations || warrantyInfo ? `<div class="mt-4 text-xs text-blue-200"><h4 class="font-bold text-blue-300">Just For You:</h4>${recommendations}${warrantyInfo}</div>` : ''}
                            <!-- 8. Footer -->
                            <div class="mt-8 text-center text-xs text-blue-400">
                                <p class="text-base font-semibold text-white">Thank you, ${invoice.customerName.split(' ')[0]}!</p>
                                <p>Rate your experience | Follow us ${storeInfo.socials}</p>
                                <p class="mt-2 opacity-70">üå± Request an e-receipt next time to save paper.</p>
                            </div>
                        </div>`;
                    }
                },
                classic: {
                    name: 'Classic',
                    preview: `<div class="bg-white p-4 font-serif text-[9px] leading-tight text-gray-800 border border-gray-300"><p style="font-family: 'Playfair Display', serif;" class="text-lg text-center text-black">Order</p><div class="my-2 h-px bg-gray-200"></div><div class="flex justify-between text-gray-500"><p>Item</p><p>$19.99</p></div><div class="my-2 h-px bg-gray-200"></div><p class="text-right font-bold text-black">Total: $19.99</p></div>`,
                    getBody: (invoice, paymentState) => {
                         const subtotal = invoice.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
                         const tax = invoice.total - subtotal;
                         const totalPaid = paymentState.payments.reduce((sum, p) => sum + p.amount, 0);
                         const changeDue = totalPaid - invoice.total;
                        return `<div class="bg-white text-gray-800 p-8" id="receipt-content" style="font-family: 'Inter', sans-serif;">
                            <div class="text-center pb-4">
                                <h1 class="text-3xl text-black" style="font-family: 'Playfair Display', serif;">${storeInfo.name}</h1>
                                <p class="text-sm text-gray-500">${storeInfo.address} &bull; ${storeInfo.contact}</p>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 pt-4 border-t border-gray-200">
                                <div><p class="font-semibold text-gray-700">INVOICE TO:</p><p>${invoice.customerName}</p>${invoice.customer?.address ? `<p>${invoice.customer.address}</p>` : ''}</div>
                                <div class="text-right"><p class="font-semibold text-gray-700">INVOICE #</p><p>${invoice.id}</p><p class="mt-2 font-semibold text-gray-700">DATE</p><p>${new Date(invoice.date).toLocaleDateString()}</p></div>
                            </div>
                            <table class="w-full text-sm mt-8">
                                <thead class="border-b-2 border-gray-800 text-gray-600 uppercase text-xs"><tr class="text-left"><th class="py-2">Description</th><th class="py-2 text-center">Qty</th><th class="py-2 text-right">Unit Price</th><th class="py-2 text-right">Amount</th></tr></thead>
                                <tbody>${invoice.items.map(item => `<tr class="border-b border-gray-200"><td class="py-3">${item.name}</td><td class="py-3 text-center">${item.qty}</td><td class="py-3 text-right" style="font-family: 'Source Code Pro', monospace;">$${item.price.toFixed(2)}</td><td class="py-3 text-right font-semibold" style="font-family: 'Source Code Pro', monospace;">$${(item.qty * item.price).toFixed(2)}</td></tr>`).join('')}</tbody>
                            </table>
                            <div class="mt-6 flex justify-end"><div class="w-full max-w-xs text-sm space-y-1">
                                <div class="flex justify-between text-gray-600"><span>Subtotal:</span><span style="font-family: 'Source Code Pro', monospace;">$${subtotal.toFixed(2)}</span></div>
                                <div class="flex justify-between text-gray-600"><span>Tax (10%):</span><span style="font-family: 'Source Code Pro', monospace;">$${tax.toFixed(2)}</span></div>
                                <div class="flex justify-between font-bold text-lg text-black mt-2 pt-2 border-t border-gray-300"><span>Total Due:</span><span style="font-family: 'Source Code Pro', monospace;">$${invoice.total.toFixed(2)}</span></div>
                                <div class="pt-2 border-t border-gray-300 mt-2">
                                ${paymentState.payments.map(p => `<div class="flex justify-between text-gray-600"><span>Paid (${p.method}):</span><span style="font-family: 'Source Code Pro', monospace;">$${p.amount.toFixed(2)}</span></div>`).join('')}
                                ${changeDue > 0.001 ? `<div class="flex justify-between font-semibold text-gray-800"><span>Change:</span><span style="font-family: 'Source Code Pro', monospace;">$${changeDue.toFixed(2)}</span></div>` : ''}
                                </div>
                            </div></div>
                            <p class="text-center text-xs text-gray-400 mt-12">Thank you for your business. Please contact us with any questions.</p>
                        </div>`;
                    }
                },
                 grocery: {
                    name: 'Super Shop',
                    preview: `<div class="bg-green-50 p-4 font-mono text-[8px] leading-tight text-green-900 border-t-4 border-green-500"><div class="flex justify-between items-center"><p class="font-bold text-lg">SALE</p><p>${new Date().toLocaleDateString()}</p></div><div class="h-px bg-green-200 my-2"></div><div class="space-y-1 text-[7px] text-gray-600"><p>Milk...........$3.99</p><p>Bread..........$2.49</p></div><div class="h-px bg-green-200 my-2"></div><p class="font-bold text-right text-lg">TOTAL: $6.48</p></div>`,
                    getBody: (invoice, paymentState) => {
                        const subtotal = invoice.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
                         const tax = invoice.total - subtotal;
                         const totalPaid = paymentState.payments.reduce((sum, p) => sum + p.amount, 0);
                         const changeDue = totalPaid - invoice.total;
                        return `<div class="bg-white text-black p-4" id="receipt-content" style="font-family: 'Source Code Pro', monospace; max-width: 380px; margin: auto;">
                            <header class="text-center mb-2">
                                <h2 class="text-3xl font-black text-green-700">${storeInfo.name.toUpperCase()}</h2>
                                <p class="text-xs">${storeInfo.address}</p>
                                <p class="text-xs">Ph: ${storeInfo.contact}</p>
                                <p class="text-xs">BIN: ${storeInfo.taxId}</p>
                            </header>
                            <div class="border-t-2 border-b-2 border-dashed border-black my-2 py-1 flex justify-between text-xs">
                                <span>Cashier: ${invoice.cashier}</span><span>Date: ${new Date(invoice.date).toLocaleString()}</span>
                            </div>
                            ${invoice.customer ? `<div class="text-center text-xs py-1"><p>MEMBER: ${invoice.customer.name.toUpperCase()} (#${invoice.customer.loyaltyId})</p></div>` : ''}
                            <table class="w-full text-sm my-2">
                                <thead><tr><th class="text-left">ITEM</th><th class="text-center">QTY</th><th class="text-right">PRICE</th></tr></thead>
                                <tbody>${invoice.items.map(item => `<tr><td class="py-0.5">${item.name}</td><td class="py-0.5 text-center">${item.qty}</td><td class="py-0.5 text-right">$${(item.qty * item.price).toFixed(2)}</td></tr>`).join('')}</tbody>
                            </table>
                             <div class="border-t-2 border-dashed border-black mt-2 pt-2 text-sm">
                                <div class="flex justify-between"><span>SUBTOTAL</span><span>$${subtotal.toFixed(2)}</span></div>
                                <div class="flex justify-between"><span>TAX @ 10%</span><span>$${tax.toFixed(2)}</span></div>
                                <div class="flex justify-between text-2xl font-bold mt-2 bg-black text-white p-2"><span>TOTAL</span><span>$${invoice.total.toFixed(2)}</span></div>
                                 <div class="border-t border-dashed border-black my-2"></div>
                                ${paymentState.payments.map(p => `<div class="flex justify-between"><span>${p.method.toUpperCase()} TENDERED</span><span>$${p.amount.toFixed(2)}</span></div>`).join('')}
                                ${changeDue > 0.001 ? `<div class="flex justify-between font-bold"><span>CHANGE</span><span>$${changeDue.toFixed(2)}</span></div>` : ''}
                            </div>
                            <div class="text-center mt-4">
                                <p class="font-bold">YOU SAVED $0.00 TODAY!</p>
                                <p class="text-xs mt-2">Points Earned: ${invoice.pointsEarned} | Total Points: ${invoice.customer?.loyaltyPoints || 0}</p>
                                <p class="text-xs mt-2">-- THANK YOU FOR SHOPPING --</p>
                            </div>
                        </div>`;
                    }
                },
                tech: {
                    name: 'Computer Shop',
                    preview: `<div class="bg-gray-900 p-4 font-sans text-[8px] leading-tight text-gray-200 border-l-2 border-cyan-400"><div class="flex justify-between items-center"><p class="font-bold text-white tracking-widest">INVOICE</p><p class="text-gray-500 font-mono">#${'INV-123'}</p></div><div class="mt-4 bg-gray-700/50 h-6 rounded flex items-center px-2 text-cyan-300 text-[7px]">PRODUCT-A</div><div class="mt-1 bg-gray-700/50 h-6 rounded"></div><p class="text-right text-cyan-400 mt-2 font-bold text-[10px]">TOTAL: $999.00</p></div>`,
                    getBody: (invoice, paymentState) => {
                         const subtotal = invoice.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
                         const tax = invoice.total - subtotal;
                         return `<div class="bg-gray-800 text-gray-200 font-sans p-8" id="receipt-content" style="font-family: 'Inter', sans-serif;">
                            <div class="flex justify-between items-start pb-4 border-b-2 border-cyan-400">
                                <div><h1 class="text-3xl font-bold text-white tracking-wider">${storeInfo.name}<span class="text-cyan-400">.</span></h1><p class="text-sm text-gray-400">${storeInfo.address}</p></div>
                                <div class="text-right"><h2 class="text-xl font-semibold text-gray-300">INVOICE</h2><p class="font-mono text-cyan-400">${invoice.id}</p></div>
                            </div>
                            <div class="grid grid-cols-2 gap-8 mt-6 text-sm">
                                <div><p class="text-gray-400 uppercase tracking-wider text-xs">Billed To</p><p class="font-medium text-white">${invoice.customerName}</p>${invoice.customer?.address ? `<p class="text-xs text-gray-400">${invoice.customer.address}</p>` : ''}</div>
                                <div class="text-right"><p class="text-gray-400 uppercase tracking-wider text-xs">Date of Issue</p><p class="font-medium text-white">${new Date(invoice.date).toLocaleDateString()}</p></div>
                            </div>
                            <div class="mt-8"><table class="w-full text-sm"><thead><tr class="text-left text-gray-400 uppercase text-xs"><th class="py-2">Item Description</th><th class="py-2 text-center">Qty</th><th class="py-2 text-right">Unit Price</th><th class="py-2 text-right">Total</th></tr></thead><tbody class="text-gray-300 divide-y divide-gray-700">${invoice.items.map(item => `<tr><td class="py-3 pr-2 font-medium">${item.name}<br><span class="font-mono text-xs text-cyan-400">${item.id}</span></td><td class="py-3 text-center font-mono">${item.qty}</td><td class="py-3 text-right font-mono">$${item.price.toFixed(2)}</td><td class="py-3 text-right font-mono font-semibold text-white">$${(item.qty * item.price).toFixed(2)}</td></tr>`).join('')}</tbody></table></div>
                             <div class="mt-8 flex justify-end"><div class="w-full max-w-sm text-sm space-y-2">
                                <div class="flex justify-between text-gray-400"><span>Subtotal:</span><span class="font-mono">$${subtotal.toFixed(2)}</span></div>
                                <div class="flex justify-between text-gray-400"><span>Tax (10%):</span><span class="font-mono">$${tax.toFixed(2)}</span></div>
                                <div class="flex justify-between font-bold text-2xl text-white mt-2 pt-2 border-t-2 border-cyan-400"><span>Grand Total:</span><span class="font-mono text-cyan-400">$${invoice.total.toFixed(2)}</span></div>
                            </div></div>
                             <p class="text-center text-xs text-gray-500 mt-12">All sales final after 30 days. Visit our website for warranty and support information.</p>
                         </div>`;
                    }
                },
                boutique: {
                    name: 'Boutique',
                    preview: `<div class="bg-rose-50 p-4 font-serif text-[9px] leading-tight text-rose-800 text-center border-t-2 border-b-2 border-rose-200"><p style="font-family: 'Playfair Display', serif;" class="text-xl text-rose-900">Purchase</p><div class="my-2 h-px bg-rose-200 w-1/2 mx-auto"></div><p class="text-rose-500">Item Name.....$45.00</p><div class="my-2 h-px bg-rose-200 w-1/2 mx-auto"></div><p class="font-bold text-rose-900">Total: $45.00</p></div>`,
                    getBody: (invoice, paymentState) => {
                        const subtotal = invoice.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
                        const tax = invoice.total - subtotal;
                         return `<div class="bg-white text-gray-700 p-8" id="receipt-content" style="font-family: 'Inter', sans-serif;">
                            <div class="text-center pb-6 border-b-2 border-rose-200">
                                <h1 class="text-4xl text-rose-800" style="font-family: 'Playfair Display', serif;">${storeInfo.name}</h1>
                                <p class="text-sm text-rose-500 mt-1 tracking-widest">Exquisite Finds for the Modern Style</p>
                            </div>
                             <div class="text-center text-xs text-rose-500 mt-4"><span>Order #${invoice.id}</span> &bull; <span>${new Date(invoice.date).toLocaleString()}</span></div>
                             <div class="mt-8 text-sm">${invoice.items.map(item => `<div class="flex justify-between py-4 border-b border-rose-100 items-center"><div class="pr-4"><p class="font-semibold text-rose-900">${item.name}</p><p class="text-xs text-rose-400">${item.id}</p></div><span class="text-rose-800" style="font-family: 'Source Code Pro', monospace;">${item.qty} &times; $${item.price.toFixed(2)}</span><span class="font-semibold text-rose-900" style="font-family: 'Source Code Pro', monospace;">$${(item.qty * item.price).toFixed(2)}</span></div>`).join('')}</div>
                             <div class="mt-6 flex justify-end"><div class="w-full max-w-xs text-sm space-y-2">
                                <div class="flex justify-between text-rose-600"><span>Subtotal</span><span style="font-family: 'Source Code Pro', monospace;">$${subtotal.toFixed(2)}</span></div>
                                <div class="flex justify-between text-rose-600"><span>Tax</span><span style="font-family: 'Source Code Pro', monospace;">$${tax.toFixed(2)}</span></div>
                                <div class="flex justify-between font-bold text-xl text-rose-800 mt-2 pt-2 border-t-2 border-rose-300"><span>Total</span><span style="font-family: 'Source Code Pro', monospace;">$${invoice.total.toFixed(2)}</span></div>
                            </div></div>
                             <p class="text-center text-sm font-semibold text-rose-800 mt-12" style="font-family: 'Playfair Display', serif;">Thank you, ${invoice.customerName.split(' ')[0]}!</p>
                             <p class="text-center text-xs text-rose-400 mt-1">Returns accepted within 14 days with receipt.</p>
                         </div>`;
                    }
                },
                 cafe: {
                    name: 'Cafe',
                    preview: `<div class="bg-amber-100 p-4 font-sans text-[8px] leading-tight text-amber-900 text-center border-2 border-amber-800 rounded-lg"><p class="text-lg font-bold">Order Up!</p><div class="h-0.5 w-full bg-amber-300 my-2 rounded-full"></div><div class="text-left"><p>Coffee....$3.50</p><p>Pastry...$4.00</p></div><div class="h-0.5 w-full bg-amber-300 my-2 rounded-full"></div><p class="mt-2 font-bold text-lg">TOTAL: $7.50</p></div>`,
                    getBody: (invoice, paymentState) => {
                        const subtotal = invoice.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
                        const tax = invoice.total - subtotal;
                        return `<div class="bg-amber-50 text-amber-900 p-4" id="receipt-content" style="font-family: 'Source Code Pro', monospace; max-width: 320px; margin: auto; border: 2px solid #92400e; border-radius: 0.5rem;">
                            <div class="text-center">
                                <p class="text-4xl">‚òï</p>
                                <h2 class="text-xl font-bold">${storeInfo.name}</h2>
                                <p class="text-xs">Your daily dose of happiness</p>
                            </div>
                            <div class="border-t-2 border-dashed border-amber-800 my-3"></div>
                            <p class="text-xs">Order #${invoice.id}</p>
                            <p class="text-xs">Date: ${new Date(invoice.date).toLocaleString()}</p>
                            <div class="my-3 space-y-1">
                                ${invoice.items.map(item => `
                                <div class="flex justify-between text-sm">
                                    <span>${item.qty} ${item.name}</span>
                                    <span>$${(item.qty * item.price).toFixed(2)}</span>
                                </div>`).join('')}
                            </div>
                            <div class="border-t-2 border-dashed border-amber-800 my-3"></div>
                            <div class="space-y-1 text-sm">
                                 <div class="flex justify-between"><span>Subtotal</span><span>$${subtotal.toFixed(2)}</span></div>
                                 <div class="flex justify-between"><span>Tax</span><span>$${tax.toFixed(2)}</span></div>
                            </div>
                             <div class="border-t-2 border-dashed border-amber-800 my-3"></div>
                            <div class="flex justify-between font-bold text-xl"><span>TOTAL</span><span>$${invoice.total.toFixed(2)}</span></div>
                            <p class="text-center font-bold text-lg mt-4">Enjoy!</p>
                            <p class="text-center text-xs">Follow us ${storeInfo.socials}</p>
                        </div>`;
                    }
                },
                bookstore: {
                    name: 'Bookstore',
                    preview: `<div class="bg-amber-50 p-4 font-serif text-[9px] leading-tight text-gray-800 border border-amber-600/30"><p class="font-bold text-xl text-amber-900 text-center tracking-widest">RECEIPT</p><div class="my-2 border-t-2 border-double border-amber-900/50"></div><p class="text-amber-800">Book Title ... $12.00</p><p class="mt-4 text-right font-bold text-amber-900">Total Due: $12.00</p></div>`,
                    getBody: (invoice, paymentState) => {
                        const subtotal = invoice.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
                        const tax = invoice.total - subtotal;
                        return `<div class="bg-amber-50 text-amber-900 p-8" id="receipt-content" style="font-family: 'Playfair Display', serif;">
                            <div class="text-center pb-4 border-b-2 border-amber-800 border-opacity-20"><h1 class="text-3xl font-bold">${storeInfo.name}</h1><p class="text-sm text-amber-800 opacity-80">Where stories live.</p></div>
                            <div class="flex justify-between mt-6 text-sm">
                                <div><p class="text-amber-800 opacity-70">Billed To</p><p class="font-sans font-medium text-amber-950">${invoice.customerName}</p></div>
                                <div class="text-right"><p class="text-amber-800 opacity-70">Invoice</p><p class="font-sans font-medium text-amber-950">${invoice.id}</p></div>
                            </div>
                            <div class="mt-6"><table class="w-full text-sm"><thead><tr class="text-left text-amber-800 opacity-70 font-sans uppercase text-xs tracking-wider"><th class="py-2">Title</th><th class="py-2 text-right">Price</th></tr></thead><tbody>${invoice.items.map(item => `<tr class="border-b border-amber-200"><td class="py-3 pr-4">${item.name}<br><span class="font-mono text-xs opacity-70">${item.id}</span></td><td class="py-3 text-right font-mono text-amber-950 font-medium">$${(item.qty * item.price).toFixed(2)}</td></tr>`).join('')}</tbody></table></div>
                            <div class="mt-6 flex justify-end"><div class="w-full max-w-xs text-sm space-y-1 font-sans">
                                <div class="flex justify-between"><span>Subtotal</span><span class="font-mono">$${subtotal.toFixed(2)}</span></div>
                                <div class="flex justify-between"><span>Tax</span><span class="font-mono">$${tax.toFixed(2)}</span></div>
                                <div class="flex justify-between font-bold text-lg mt-2 pt-2 border-t-2 border-amber-200"><span>Total</span><span class="font-mono text-amber-950">$${invoice.total.toFixed(2)}</span></div>
                            </div></div>
                            <p class="text-center text-xs text-amber-800 opacity-60 mt-12 font-sans">"A reader lives a thousand lives before he dies."</p>
                        </div>`;
                    }
                },
                 minimalist: {
                    name: 'Minimalist',
                    preview: `<div class="bg-white p-4 font-sans text-[9px] leading-tight text-gray-800 border border-gray-200"><p class="font-bold text-black text-lg">Order</p><p class="text-gray-400 text-[8px]">${'#INV-123'}</p><div class="flex justify-between mt-4 border-t border-gray-200 pt-2 text-xs"><p>Item</p><p>$10.00</p></div><div class="flex justify-between mt-2 font-bold text-sm"><p>Total</p><p>$10.00</p></div></div>`,
                    getBody: (invoice, paymentState) => {
                        const subtotal = invoice.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
                        const tax = invoice.total - subtotal;
                         return `<div class="bg-white text-gray-800 font-sans p-8" id="receipt-content" style="font-family: 'Inter', sans-serif;">
                           <div class="flex justify-between items-baseline">
                                <h1 class="text-2xl font-semibold text-black">Invoice</h1>
                                <p class="font-mono text-sm text-gray-500">${invoice.id}</p>
                           </div>
                           <div class="grid grid-cols-2 gap-8 text-sm mt-8">
                                <div><p class="text-gray-500">To</p><p class="font-medium text-black">${invoice.customerName}</p></div>
                                <div class="text-right"><p class="text-gray-500">Date</p><p class="font-medium text-black">${new Date(invoice.date).toLocaleDateString()}</p></div>
                           </div>
                           <div class="border-t border-gray-200 mt-6 pt-6 space-y-3 text-sm">
                                ${invoice.items.map(item => `<div class="flex justify-between items-center"><span class="text-black">${item.name} <span class="text-gray-500 font-mono text-xs">&times;${item.qty}</span></span><span class="font-mono text-black">$${(item.qty * item.price).toFixed(2)}</span></div>`).join('')}
                           </div>
                           <div class="border-t border-gray-200 mt-6 pt-4 flex justify-end"><div class="w-full max-w-xs text-sm space-y-2">
                                <div class="flex justify-between text-gray-500"><span>Subtotal</span><span class="font-mono text-black">$${subtotal.toFixed(2)}</span></div>
                                <div class="flex justify-between text-gray-500"><span>Tax</span><span class="font-mono text-black">$${tax.toFixed(2)}</span></div>
                                <div class="flex justify-between font-semibold text-base text-black mt-2 pt-2 border-t-2 border-black"><span>Total</span><span class="font-mono">$${invoice.total.toFixed(2)}</span></div>
                            </div></div>
                            <p class="text-xs text-gray-400 text-center mt-12">Thank you.</p>
                         </div>`;
                    }
                },
             };

             const showReceipt = (invoice, paymentState = null) => {
                const template = receiptTemplates[appState.settings.selectedReceiptTemplate] || receiptTemplates.modern;
                const content = template.getBody(invoice, paymentState);

                const footer = `<button data-action="close-modal" class="btn btn-secondary">Close</button><button id="print-receipt" class="btn btn-primary"><i data-lucide="printer" class="w-4 h-4 mr-2"></i>Print</button>`;
                const modal = showModal(`Receipt / Invoice`, content, footer, {size: 'max-w-2xl', customClasses: 'p-0'});
                lucide.createIcons();
                modal.querySelector('#print-receipt').addEventListener('click', () => {
                     showToast('Printing not available in this demo.', 'info');
                });
             };

             window.addEventListener('keydown', e => { if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); document.querySelector('[data-action="open-search"]').click(); } });
            
            // --- INITIAL LOAD ---
            window.addEventListener('resize', checkScreenSize);
            checkScreenSize();
            openOrSwitchTab('dashboard');
        });
    </script>

</body>
</html>



