<script type="module">
        // --- FIREBASE SDK IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, 
            collection, query, where, writeBatch, runTransaction, getDocs, limit, increment
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- SESSION START TIME ---
        // We record when the page loads to differentiate between new and historical notifications.
        const sessionStartTime = new Date();

        // --- GEMINI API Configuration ---
        const gemini_api_key = "AIzaSyCWKlR6mzcAaLGGUwzAk-4M1-4DoI0QbWY"; // Injected by the environment

        // --- FIREBASE CONFIG & INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCBhzyl_1KpaROyjDaXX7fyLv-gQRoOTY0",
            authDomain: "cashshilpo.firebaseapp.com",
            projectId: "cashshilpo",
            storageBucket: "cashshilpo.firebasestorage.app",
            messagingSenderId: "544846655087",
            appId: "1:544846655087:web:0269ce6564c6b42c62a79a",
            measurementId: "G-GT06B6K2T6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- SMART SYSTEM PROFILES (Remains static) ---
        let businessProfiles = {
            general: { 
                name: 'General Store', icon: 'store', 
                terminology: { product: 'Product', inventory: 'Inventory', category: 'Category' }, 
                features: { serials: true, expiry: true, service: true, hasInventoryTab: true },
                customFields: [
                    { name: 'brand', label: 'Brand', type: 'dynamic-select', source: 'productBrands' }, // MODIFIED
                    { name: 'supplier', label: 'Supplier', type: 'dynamic-select', source: 'suppliers' }, // MODIFIED
                ]
            },
            grocery: { 
                name: 'Super Shop', icon: 'shopping-cart', 
                terminology: { product: 'Item', inventory: 'Stock', category: 'Department' }, 
                features: { serials: false, expiry: true, service: false, hasInventoryTab: true },
                customFields: [
                     { name: 'brand', label: 'Brand', type: 'text' },
                     { name: 'weight', label: 'Net Weight', type: 'text', placeholder: 'e.g., 500g, 1L' },
                ]
            },
            electronics: { 
                name: 'Electronics Store', icon: 'smartphone', 
                terminology: { product: 'Device', inventory: 'Inventory', category: 'Brand' }, 
                features: { serials: true, expiry: false, service: true, hasInventoryTab: true },
                customFields: [
                     { name: 'brand', label: 'Brand', type: 'text' },
                     { name: 'model', label: 'Model', type: 'text' },
                     { name: 'specifications', label: 'Specifications', type: 'textarea' },
                ]
            },
            pharmacy: { 
                name: 'Pharmacy', icon: 'briefcase-medical', 
                terminology: { product: 'Medicine', inventory: 'Stock', category: 'Category' }, 
                features: { serials: false, expiry: true, service: false, hasInventoryTab: true },
                customFields: [
                    { name: 'manufacturer', label: 'Manufacturer', type: 'text' },
                    { name: 'genericName', label: 'Generic Name', type: 'text' },
                    { name: 'strength', label: 'Strength', type: 'text', placeholder: 'e.g., 500mg' },
                ]
            },
            restaurant: { 
                name: 'Restaurant', icon: 'utensils-crossed', 
                terminology: { product: 'Dish', inventory: 'Ingredients', category: 'Menu Section' }, 
                features: { serials: false, expiry: false, service: true, hasInventoryTab: true },
                customFields: [
                    { name: 'ingredients', label: 'Key Ingredients', type: 'textarea' },
                    { name: 'spiceLevel', label: 'Spice Level', type: 'select', options: ['Mild', 'Medium', 'Hot', 'Extra Hot'] },
                    { name: 'isVeg', label: 'Vegetarian', type: 'checkbox' },
                ]
            },
            apparel: { 
                name: 'Apparel Boutique', icon: 'shirt', 
                terminology: { product: 'Apparel', inventory: 'Stock', category: 'Collection' }, 
                features: { serials: false, expiry: false, service: false, hasInventoryTab: true },
                customFields: [
                    { name: 'color', label: 'Color', type: 'text' },
                    { name: 'size', label: 'Size', type: 'select', options: ['XS', 'S', 'M', 'L', 'XL', 'XXL'] },
                    { name: 'material', label: 'Material', type: 'text' },
                ]
            },
            repair: {
                name: 'Repair Services', icon: 'wrench',
                terminology: { product: 'Service', inventory: 'Parts', category: 'Service Type' },
                features: { serials: true, expiry: false, service: true, hasInventoryTab: true },
                customFields: [
                    { name: 'deviceDetails', label: 'Item Details', type: 'text', placeholder: 'e.g., iPhone 14 Pro, Honda Civic' },
                    { name: 'serviceDuration', label: 'Estimated Duration', type: 'text', placeholder: 'e.g., 2 hours, 3-5 days' },
                    { name: 'technician', label: 'Assigned Technician', type: 'text' },
                ]
            },
            salon: {
                name: 'Salon & Spa', icon: 'scissors',
                terminology: { product: 'Service', inventory: 'Products', category: 'Service Category' },
                features: { serials: false, expiry: false, service: true, hasInventoryTab: true },
                customFields: [
                    { name: 'duration', label: 'Duration (minutes)', type: 'text' },
                    { name: 'therapist', label: 'Stylist', type: 'text' },
                    { name: 'therapist', label: 'Therapist', type: 'text' },
                    { name: 'bookingRequired', label: 'Booking Required', type: 'checkbox' },
                ]
            },
            consulting: {
                name: 'Consulting Agency', icon: 'briefcase',
                terminology: { product: 'Service', inventory: 'Resources', category: 'Engagement Type' },
                features: { serials: false, expiry: false, service: true, hasInventoryTab: false },
                customFields: [
                    { name: 'billingType', label: 'Billing Type', type: 'select', options: ['Hourly', 'Fixed Project', 'Retainer'] },
                    { name: 'consultant', label: 'Lead Consultant', type: 'text' },
                    { name: 'deliverables', label: 'Key Deliverables', type: 'textarea' },
                ]
            },
            digital: {
                name: 'Digital Services / SaaS', icon: 'cloud-cog',
                terminology: { product: 'Plan / Service', inventory: 'Licenses', category: 'Service Tier' },
                features: { serials: false, expiry: false, service: true, hasInventoryTab: false },
                customFields: [
                    { name: 'billingCycle', label: 'Billing Cycle', type: 'select', options: ['Monthly', 'Annually', 'One-time'] },
                    { name: 'featuresList', label: 'Features Included', type: 'textarea' },
                    { name: 'supportLevel', label: 'Support Level', type: 'text', placeholder: 'e.g., Basic, Premium, 24/7' },
                ]
            }
        };
        // --- NEW: USER ROLES & PERMISSIONS ---
        // Defines the permission structure for different roles in the system.
        const userRoles = {
            admin: {
                name: 'Administrator',
                permissions: {
                    canDoEverything: true, // A master key permission, grants all permissions below
                    canAccessDashboard: { value: true, description: 'Can view the main dashboard and analytics.' },
                    canUsePOS: { value: true, description: 'Can access and use the Point of Sale terminal.' },
                    canManageInvoices: { value: true, description: 'Can view, create, and manage all invoices.' },
                    canManageInventory: { value: true, description: 'DEPRECATED: Grants all inventory permissions.' }, // MODIFIED
                    canAddProducts: { value: true, description: 'Can add new products.' }, // NEW
                    canEditProducts: { value: true, description: 'Can edit existing products.' }, // NEW
                    canDeactivateProducts: { value: true, description: 'Can activate or deactivate products.' }, // NEW
                    canDeleteProducts: { value: true, description: 'Can permanently delete products.' }, // NEW
                    canViewInventory: { value: true, description: 'Can view the inventory list and product details.' }, // NEW
                    canViewProfitAndLoss: { value: true, description: 'Can view gross profit, cost prices, and other profit-related metrics.' }, // NEW PERMISSION
                    canAccessReports: { value: true, description: 'Can generate and view all business reports.' },
                    canSeeAllReports: { value: true, description: 'Can see reports for all staff, not just their own.' }, // NEW
                    canManageCustomers: { value: true, description: 'Can add, edit, and delete customer profiles.' },
                    canManageStaff: { value: true, description: 'Can invite and manage staff roles and permissions.' },
                    canManageRoles: { value: true, description: 'Can view and edit user role permissions.' }, // NEW
                    canInviteCashiers: { value: true, description: 'Can invite new cashiers, pending admin approval.' },
                    canViewStaffPerformance: { value: true, description: 'Can view performance reports for staff.' },
                    canManageSettings: { value: true, description: 'Can change store settings, receipt templates, etc.' },
                    canRequestStaffDeactivation: { value: true, description: 'Can request to deactivate a cashier, pending admin approval.' },
                    canEditCashierDetails: { value: true, description: 'Can edit basic details of a cashier, like their name.'},
                    canDirectlyVoidInvoice: { value: true, description: 'Can directly void an invoice without a prior request.' }, // NEW
                    canManageExpenses: { value: true, description: 'Can add, view, edit, and delete all business expenses.' }, // MODIFIED
                    canAddExpenses: { value: true, description: 'Can add new business expenses.' }, // NEW
                    canEditExpenses: { value: true, description: 'Can edit expenses.' }, // NEW
                    canDeleteExpenses: { value: true, description: 'Can delete expenses.' }, // NEW
                    canManageSuppliers: { value: true, description: 'Can add, edit, and manage suppliers.' }, // NEW
                    canViewPurchaseOrders: { value: true, description: 'Can view all purchase orders.' }, // NEW
                    canCreatePurchaseOrders: { value: true, description: 'Can create new purchase orders.' }, // NEW
                    canUpdatePurchaseOrders: { value: true, description: 'Can update purchase orders (e.g., mark as received).' }, // NEW
                    canDeletePurchaseOrders: { value: true, description: 'Can delete purchase orders.' }, // NEW
                    canGenerateBarcodes: { value: true, description: 'Can access the barcode generator tool.' }, // NEW
                    canManageWarranties: { value: true, description: 'Can view warranties and create/manage warranty claims.' }, // NEW
                    canManageQuotations: { value: true, description: 'Can create, edit, and manage all quotations.' }, // <-- ADD
                    canDeleteQuotations: { value: true, description: 'Can permanently delete quotations.' },      // <-- ADD
                    canConvertToInvoice: { value: true, description: 'Can convert a quotation into a sales invoice.' }, // <-- ADD
                    canManageSubscription: { value: true, description: 'Can view and manage the store subscription.' },
                    canRequestInvoiceVoid: { value: true, description: 'Can request to void an invoice, pending manager approval.' }, // NEW
                    canCancelVoidRequest: { value: true, description: 'Can cancel their own pending void requests.' }, // NEW
                    canManagePayroll: { value: true, description: 'Can manage staff pay settings, run payroll, and view history.' },
                    canManageLoyalty: { value: true, description: 'Can configure and manage the loyalty program.' },
                    canProcessReturns: { value: true, description: 'Can process returns and issue credit.' }, 
                    canManageEMI: { value: true, description: 'Can manage EMI sales, schedules, and collections.' },

                }
            },
            manager: {
                name: 'Manager',
                permissions: {
                    canAccessDashboard: { value: true, description: 'Can view the main dashboard and analytics.' },
                    canUsePOS: { value: true, description: 'Can access and use the Point of Sale terminal.' },
                    canManageInvoices: { value: true, description: 'Can view, create, and manage all invoices.' },
                    canManageInventory: { value: false, description: 'DEPRECATED: Use granular permissions instead.' }, // MODIFIED
                    canAddProducts: { value: true, description: 'Can add new products.' }, // NEW
                    canEditProducts: { value: true, description: 'Can edit existing products.' }, // NEW
                    canDeactivateProducts: { value: true, description: 'Can activate or deactivate products.' }, // NEW
                    canDeleteProducts: { value: false, description: 'Cannot permanently delete products.' }, // NEW
                    canViewInventory: { value: true, description: 'Can view the inventory list and product details.' }, // NEW
                    canViewProfitAndLoss: { value: false, description: 'Can view gross profit, cost prices, and other profit-related metrics.' }, // NEW PERMISSION
                    canAccessReports: { value: true, description: 'Can generate and view all business reports.' },
                    canSeeAllReports: { value: true, description: 'Can see reports for all staff, not just their own.' }, // NEW
                    canManageCustomers: { value: true, description: 'Can add, edit, and delete customer profiles.' },
                    canManageStaff: { value: false, description: 'Can invite and manage staff roles and permissions.' },
                    canManageRoles: { value: false, description: 'Can view and edit user role permissions.' }, // NEW
                    canInviteCashiers: { value: true, description: 'Can invite new cashiers, pending admin approval.' },
                    canViewStaffPerformance: { value: true, description: 'Can view performance reports for staff.' },
                    canManageSettings: { value: true, description: 'Can change store settings, receipt templates, etc.' },
                    canRequestStaffDeactivation: { value: true, description: 'Can request to deactivate a cashier, pending admin approval.' },
                    canEditCashierDetails: { value: true, description: 'Can edit basic details of a cashier, like their name.'},
                    canDirectlyVoidInvoice: { value: true, description: 'Can directly void an invoice without a prior request.' }, // NEW
                    canManageExpenses: { value: true, description: 'Can add and view their own business expenses.' }, // MODIFIED
                    canAddExpenses: { value: true, description: 'Can add new business expenses.' }, // NEW
                    canEditExpenses: { value: false, description: 'Cannot edit expenses.' }, // NEW
                    canDeleteExpenses: { value: false, description: 'Cannot delete expenses.' }, // NEW
                    canManageSuppliers: { value: true, description: 'Can add, edit, and manage suppliers.' }, // NEW
                    canViewPurchaseOrders: { value: true, description: 'Can view all purchase orders.' }, // NEW
                    canCreatePurchaseOrders: { value: true, description: 'Can create new purchase orders.' }, // NEW
                    canUpdatePurchaseOrders: { value: true, description: 'Can update purchase orders (e.g., mark as received).' }, // NEW
                    canDeletePurchaseOrders: { value: false, description: 'Cannot delete purchase orders.' }, // NEW
                    canGenerateBarcodes: { value: true, description: 'Can access the barcode generator tool.' }, // NEW
                    canManageWarranties: { value: true, description: 'Can view warranties and create/manage warranty claims.' }, // NEW
                    canManageQuotations: { value: true, description: 'Can create, edit, and manage all quotations.' }, // <-- ADD
                    canDeleteQuotations: { value: false, description: 'Cannot permanently delete quotations.' },      // <-- ADD
                    canConvertToInvoice: { value: true, description: 'Can convert a quotation into a sales invoice.' }, // <-- ADD
                    canManageSubscription: { value: true, description: 'Can view and manage the store subscription.' },
                    canManagePayroll: { value: false, description: 'Cannot manage payroll.' },
                    canManageLoyalty: { value: true, description: 'Can configure and manage the loyalty program.' },
                    canProcessReturns: { value: true, description: 'Can process returns and issue credit.' }, // <-- ADD THIS
                    canManageEMI: { value: true, description: 'Can manage EMI sales, schedules, and collections.' },

                }
            },
            cashier: {
                name: 'Cashier',
                permissions: {
                    canAccessDashboard: { value: true, description: 'Can view the main dashboard and analytics.' },
                    canUsePOS: { value: true, description: 'Can access and use the Point of Sale terminal.' },
                    canManageInvoices: { value: true, description: 'Can view, create, and manage all invoices.' },
                    canManageInventory: { value: false, description: 'Can add, edit, and delete products and adjust stock.' },
                    canAddProducts: { value: false, description: 'Can add new products.' }, // NEW
                    canEditProducts: { value: false, description: 'Can edit existing products.' }, // NEW
                    canDeactivateProducts: { value: false, description: 'Can activate or deactivate products.' }, // NEW
                    canDeleteProducts: { value: false, description: 'Cannot permanently delete products.' }, // NEW
                    canViewInventory: { value: true, description: 'Can view the inventory list and product details.' }, // NEW
                    canViewProfitAndLoss: { value: false, description: 'Can view gross profit, cost prices, and other profit-related metrics.' }, // NEW PERMISSION
                    canAccessReports: { value: true, description: 'Can generate and view all business reports.' }, // MODIFIED
                    canSeeAllReports: { value: false, description: 'Can see reports for all staff, not just their own.' }, // NEW
                    canManageCustomers: { value: true, description: 'Can add, edit, and delete customer profiles.' },
                    canManageStaff: { value: false, description: 'Can invite and manage staff roles and permissions.' },
                    canManageRoles: { value: false, description: 'Can view and edit user role permissions.' }, // NEW
                    canViewStaffPerformance: { value: false, description: 'Can view performance reports for staff.' },
                    canManageSettings: { value: false, description: 'Can change store settings, receipt templates, etc.' },
                     canRequestInvoiceVoid: { value: true, description: 'Can request to void an invoice, pending manager approval.' }, // NEW
                     canCancelVoidRequest: { value: true, description: 'Can cancel their own pending void requests.' }, // NEW
                     canManageExpenses: { value: false, description: 'Cannot manage business expenses.' }, // NEW
                     canAddExpenses: { value: false, description: 'Cannot add new business expenses.' }, // NEW
                     canEditExpenses: { value: false, description: 'Cannot edit expenses.' }, // NEW
                     canDeleteExpenses: { value: false, description: 'Cannot delete expenses.' }, // NEW
                     canManageSuppliers: { value: false, description: 'Cannot manage suppliers.' }, // NEW
                     canViewPurchaseOrders: { value: false, description: 'Cannot view purchase orders.' }, // NEW
                     canCreatePurchaseOrders: { value: false, description: 'Cannot create purchase orders.' }, // NEW
                     canUpdatePurchaseOrders: { value: false, description: 'Cannot update purchase orders.' }, // NEW
                     canDeletePurchaseOrders: { value: false, description: 'Cannot delete purchase orders.' }, // NEW
                     canGenerateBarcodes: { value: false, description: 'Cannot access the barcode generator tool.' },
                     canManageWarranties: { value: true, description: 'Can view warranties and create new warranty claims.' }, // NEW
                     canManageQuotations: { value: true, description: 'Can create, edit, and manage all quotations.' }, // <-- ADD
                     canDeleteQuotations: { value: false, description: 'Cannot permanently delete quotations.' },      // <-- ADD
                     canConvertToInvoice: { value: false, description: 'Cannot convert a quotation into a sales invoice.' }, // <-- ADD
                     canManagePayroll: { value: false, description: 'Cannot manage payroll.' },
                     canManageLoyalty: { value: false, description: 'Can configure and manage the loyalty program.' },
                     canProcessReturns: { value: false, description: 'Cannot process returns.' }, // <-- ADD THIS
                     canManageEMI: { value: false, description: 'Cannot manage EMI sales.' }, // Or true if you want them to collect payments

                }
            }
        };
        // --- REAL-TIME DATA STORE ---
        // This object will be populated by Firestore listeners
        let firestoreData = {
            storeInfo: {},
            unitsOfMeasurement: [],
            products: [],
            customers: [],
            invoices: [],
             staff: [], // NEW: To hold all staff members
            notifications: [], // For now, notifications will remain local
            auditLog: [], // NEW: To hold audit logs
            expenses: [], // NEW: To hold expense records
            suppliers: [], // NEW: To hold supplier records
            purchaseOrders: [], // NEW: To hold purchase orders
            warranties: [],
            claims: [], 
            quotations: [],
            payrollSettings: {}, // Holds pay frequency, tax rate etc.
            payrollRuns: [],     // History of payroll executions
            payslips: [],        // Individual payslip details
            loyaltySettings: {},
            loyaltyTiers: [], 
            loyaltyHistory: [],
            emiSchedules: [],
        };

        // --- NEW: To manage Firestore listeners ---
        let activeListeners = [];

        // --- NEW: Security state for lock screen ---
        let isAppLocked = false;
        let lockScreenInterval = null;


        // --- UPDATED: CENTRALIZED SUBSCRIPTION STATUS CHECKER (Now takes userData) ---
        const checkSubscriptionStatus = (userData) => {
            if (!userData) {
                return { isValid: false, status: 'error', details: {} };
            }
            
            const sub = userData.subscription || {};
            const trialEndsDate = sub.trialEndsAt ? sub.trialEndsAt.toDate() : null;
            let effectiveStatus = sub.status;

            // Check if a trial has expired
            if (effectiveStatus === 'trial' && trialEndsDate && trialEndsDate < new Date()) {
                effectiveStatus = 'trial_expired';
            }

            // Check for valid statuses
            if (effectiveStatus === 'active' || effectiveStatus === 'trial') {
                // --- FIX: Return status and planId ---
                return { isValid: true, status: effectiveStatus, planId: sub.planId };
            }

            // If not valid, return the reason
            // --- FIX: Return status and planId ---
            return { isValid: false, status: effectiveStatus, planId: sub.planId, details: { trialEndsDate } };
        };

        // --- UPDATED: LOCK SCREEN FUNCTION (Added store_disabled case) ---
        const showLockScreen = (status, planId, details = {}) => {
            // --- NEW: Set lock state and start interval to prevent bypass ---
            isAppLocked = true;
            if (lockScreenInterval) clearInterval(lockScreenInterval);
            // --- END NEW ---

            const appContainer = document.getElementById('app-container');
            const loginContainer = document.getElementById('login-container');
            if(appContainer) appContainer.style.display = 'none';
            if(loginContainer) loginContainer.style.display = 'none';

            let existingOverlay = document.getElementById('lock-screen-overlay');
            if (existingOverlay) existingOverlay.remove();

            let icon, title, message, actionsHTML;
            switch(status) {
                case 'expired':
                    icon = 'calendar-x';
                    title = 'Subscription Expired';
                    message = 'Your subscription has expired. Please renew your plan to regain access to your store.';
                    actionsHTML = `
                        <button data-action="logout" class="btn btn-secondary">Sign Out</button>
                        <button data-action="renew-subscription" class="btn btn-primary">Renew Subscription</button>
                    `;
                    break;
                case 'disabled':
                    icon = 'shield-off';
                    title = 'Account Disabled';
                    message = 'Your account has been disabled by an administrator. Please contact support for more information.';
                    actionsHTML = `
                        <button data-action="logout" class="btn btn-secondary">Sign Out</button>
                        <button data-action="contact-support" class="btn btn-primary">Contact Support</button>
                    `;
                    break;
                case 'store_disabled':
                    icon = 'store';
                    title = 'Store Disabled';
                    message = 'This store has been disabled by the administrator, and you have no other active stores. Please contact support.';
                     actionsHTML = `
                        <button data-action="logout" class="btn btn-secondary">Sign Out</button>
                        <button data-action="contact-support" class="btn btn-primary">Contact Support</button>
                    `;
                    break;
                case 'trial_expired':
                    icon = 'hourglass';
                    title = 'Trial Period Ended';
                    message = `Your free trial ended on ${details.trialEndsDate ? details.trialEndsDate.toLocaleDateString() : 'N/A'}. Please upgrade to a paid plan to continue.`;
                    actionsHTML = `
                        <button data-action="logout" class="btn btn-secondary">Sign Out</button>
                        <button data-action="renew-subscription" class="btn btn-primary">Upgrade Plan</button>
                    `;
                    break;
                default:
                    icon = 'alert-triangle';
                    title = 'Access Denied';
                    message = 'You do not have an active subscription. Please contact support.';
                    actionsHTML = `<button data-action="logout" class="btn btn-secondary">Sign Out</button>`;
            }

            const overlay = document.createElement('div');
            overlay.id = 'lock-screen-overlay';
            overlay.className = 'fixed inset-0 z-[100] flex items-center justify-center bg-bg-primary/80 backdrop-blur-md';
            overlay.innerHTML = `
                <div class="glass-pane p-12 rounded-2xl text-center max-w-lg mx-4">
                    <i data-lucide="${icon}" class="w-16 h-16 text-red-500 mx-auto mb-6"></i>
                    <h1 class="text-3xl font-bold text-white mb-2">${title}</h1>
                    <p class="text-text-secondary mb-8">${message}</p>
                    <div class="flex justify-center gap-4">
                        ${actionsHTML}
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            lucide.createIcons();
            
            // --- UPDATED: Dedicated listener for lock screen actions ---
            overlay.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;

                const action = target.dataset.action;
                const user = auth.currentUser;
                
                if (action === 'logout') {
                    signOut(auth);
                } else if (action === 'renew-subscription') {
                    if (user) {
                        // --- FIX: Pass status and planId in the URL ---
                        window.location.href = `./renew-subscription.html?uid=${user.uid}&email=${user.email}&status=${status || 'expired'}&planId=${planId || 'none'}`;
                    } else {
                        showToast("Cannot identify user. Please log out and try again.", "error");
                    }
                } else if (action === 'contact-support') {
                     if (user) {
                        window.location.href = `./contact-support.html?uid=${user.uid}&email=${user.email}`;
                    } else {
                        showToast("Cannot identify user. Please log out and try again.", "error");
                    }
                }
            });
            // --- END UPDATED ---

            // --- NEW: Start interval to enforce lock screen ---
            lockScreenInterval = setInterval(() => {
                if (isAppLocked && !document.getElementById('lock-screen-overlay')) {
                    console.warn("[Security] Lock screen bypass detected. Re-locking.");
                    showLockScreen(status, details); // Re-trigger the lock screen
                }
            }, 500); // Check every half a second
        };


        // --- APPLICATION STATE (UI and Session state) ---
        let appState = { 
            tabs: [], 
            activeTabId: null, 
            isSidebarCollapsed: false,
            productFormDraft: null,
            isHeaderCollapsed: false, // NEW: For header state
            currentCurrency: 'USD', // Will be updated from storeInfo
            settings: { // Will be updated from storeInfo.settings
                selectedReceiptTemplate: 'modern',
                posLayout: 'classic', // To switch between POS layouts
                businessType: 'general',
                defaultCurrency: 'USD',
                taxRate: 10,
                defaultUnit: 'pcs',
                voidLockoutDays: 30,
                automations: { // Default automation settings
                    dynamicPricing: { enabled: false, strategy: 'balanced' },
                    fraudDetection: { enabled: true, sensitivity: 'high' },
                    inventoryOptimization: { enabled: true, analysisFrequency: 'weekly' },
                    endOfDayReports: { enabled: true, deliveryTime: '22:00' }
                },
                permissions: {} // NEW: Will hold customized role permissions
            },
            viewStates: {
                inventory: { currentPage: 1, searchQuery: '', filters: { category: 'all', stockStatus: 'all', productStructure: 'all' } },
                customers: { currentPage: 1, searchQuery: '', filters: {} },
                invoices: { currentPage: 1, searchQuery: '', filters: { status: 'all', period: 'all' }, customRange: { start: '', end: '' }, specificDate: '' },
                reports: { currentPage: 1, searchQuery: '', reportType: 'sales', filters: { cashierId: 'all' } },
                posModern: { collapsedCategories: [], isCategoryPanelCollapsed: false, activeCategory: 'top-sellers', productGridPage: 1 }, // For persisting modern POS category collapse state
                staff: { currentPage: 1, searchQuery: '', filters: { role: 'all', status: 'all' } }, // NEW: For staff view state
                expenses: { currentPage: 1, searchQuery: '', filters: { category: 'all', period: 'last30', paymentMethod: 'all' }, customRange: { start: '', end: '' } }, // MODIFIED: For expenses view state
                purchaseOrders: { currentPage: 1, searchQuery: '', filters: { status: 'all', supplierId: 'all' } }, // NEW: For purchase orders
                suppliers: { currentPage: 1, searchQuery: '' }, // NEW
                claims: { currentPage: 1, searchQuery: '', filters: { status: 'all', policy: 'all' }, activeTab: 'warranties' }, // NEW
                quotations: { currentPage: 1, searchQuery: '', filters: { status: 'all', period: 'last30' }, customRange: { start: '', end: '' } },
                 payroll: { 
                  activeTab: 'overview', // 'overview', 'settings', 'history'
                  settingsPage: 1, 
                  historyPage: 1,
                  selectedRunId: null // For viewing history details
                },
                loyalty: { currentPage: 1, searchQuery: '', filters: { tier: 'all' } },

            },
            itemsPerPage: 15, // Global items per page
            customProfiles: {}, 
            session: {
                currentUser: null,      // NEW: Will hold the logged-in user's full data
                userRole: null,         // NEW: e.g., 'admin', 'manager'
                userPermissions: {},    // NEW: Will hold the boolean permissions
                storeId: null, // The currently active storeId
                availableStores: [], // NEW: To hold all stores for a user [{id, name}]
            },
            firebaseReady: false, // Flag to check if initial data load is complete
            endOfDayReportScheduled: false, // Flag to ensure the report is scheduled only once
        };
        let posState = { sales: [], activeSaleId: null, saleCounter: 1, };
        
        // --- UPDATED: Centralized Chart Styling ---
        const chartStyles = {
            fontFamily: "'Inter', sans-serif",
            palettes: {
                // --- NEW GENTLE & PROFESSIONAL PALETTES ---
                gentleOcean: ['#38bdf8', '#7dd3fc', '#bae6fd', '#e0f2fe', '#f0f9ff'],
                softMeadow: ['#4ade80', '#86efac', '#bbf7d0', '#dcfce7', '#f0fdf4'],
                warmStone: ['#fbbf24', '#fcd34d', '#fde68a', '#fef3c7', '#fffbeb'],
                mutedSunset: ['#f472b6', '#f9a8d4', '#fbcfe8', '#fce7f3', '#fdf2f8'],
                coolSlate: ['#94a3b8', '#cbd5e1', '#e2e8f0', '#f1f5f9', '#f8fafc'],
                // --- NEWLY ADDED PALETTES ---
                red: ['#f87171', '#fca5a5', '#fecaca', '#fee2e2', '#fff5f5'], // Based on Tailwind red 400-50
                yellow: ['#fbbf24', '#fcd34d', '#fde68a', '#fef3c7', '#fffbeb'], // Based on Tailwind amber 400-50
                // --- FIX: Add missing palettes referenced in reports ---
                blue: ['#38bdf8', '#7dd3fc', '#bae6fd', '#e0f2fe', '#f0f9ff'],
                green: ['#4ade80', '#86efac', '#bbf7d0', '#dcfce7', '#f0fdf4'],
                indigo: ['#818cf8', '#a5b4fc', '#c7d2fe', '#e0e7ff', '#eef2ff'], // Fixed undefined error
                purple: ['#a78bfa', '#c4b5fd', '#ddd6fe', '#ede9fe', '#f5f3ff'],
                teal:   ['#2dd4bf', '#5eead4', '#99f6e4', '#ccfbf1', '#f0fdfa'],
            },
            createGradient(ctx, color) {
                if (!ctx || !ctx.canvas) return color;
                const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
                // Softer gradient
                const a = this.hexToRgba(color, 0.4);
                const b = this.hexToRgba(color, 0.0);
                gradient.addColorStop(0, a);
                gradient.addColorStop(1, b);
                return gradient;
            },
            hexToRgba(hex, alpha = 1) {
                let c;
                if (/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)) {
                    c = hex.substring(1).split('');
                    if (c.length == 3) {
                        c = [c[0], c[0], c[1], c[1], c[2], c[2]];
                    }
                    c = '0x' + c.join('');
                    return `rgba(${[(c >> 16) & 255, (c >> 8) & 255, c & 255].join(',')},${alpha})`;
                }
                throw new Error('Bad Hex');
            }
        };

        // --- UPDATED: Custom Glow Plugin for Charts (More Subtle) ---
        const chartGlowPlugin = {
            id: 'chartGlow',
            beforeDatasetsDraw: (chart, args, options) => {
                const { ctx } = chart;
                ctx.save();
                // Subtle shadow instead of a bright glow
                ctx.shadowColor = options.color || 'rgba(0,0,0,0.1)';
                ctx.shadowBlur = options.blur || 10;
                ctx.shadowOffsetX = options.offsetX || 0;
                ctx.shadowOffsetY = options.offsetY || 5;
            },
            afterDatasetsDraw: (chart) => {
                chart.ctx.restore();
            }
        };
        Chart.register(chartGlowPlugin);


        const getCurrentProfile = () => {
            const profileId = appState.settings.businessType;
            return businessProfiles[profileId] || appState.customProfiles[profileId] || businessProfiles.general;
        };

        // --- AI & API UTILITIES ---

        /**
         * Generates a unique 13-digit barcode number as a string.
         * It's based on the current timestamp and a random number to ensure a high degree of uniqueness.
         * This is not a valid EAN-13 with checksum, but is unique for internal use.
         * @returns {string} A 13-digit barcode string.
         */
       const generateUniqueBarcode = (prefix = '') => {
    // UPDATED: Added prefix support and increased randomness to prevent collisions.
    const timestampPart = Date.now().toString().slice(-7); // Use last 7 digits
    const randomPart = Math.floor(Math.random() * 100000).toString().padStart(5, '0'); // 5 random digits
    const fullCode = timestampPart + randomPart;
    return prefix + fullCode.slice(0, 13 - prefix.length);
};

        /**
         * A wrapper for the fetch API that includes exponential backoff for retries.
         * @param {string} url The API endpoint URL.
         * @param {object} options The fetch options (method, headers, body).
         * @param {number} retries Number of retries.
         * @returns {Promise<Response>} The fetch response.
         */
        const fetchWithRetry = async (url, options, retries = 3) => {
            let lastError;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    // Retry only on 5xx server errors
                    if (response.status >= 500 && response.status < 600) {
                        throw new Error(`Server Error: ${response.status}`);
                    }
                    return response; // Success
                } catch (error) {
                    lastError = error;
                    console.warn(`[API] Attempt ${i + 1} failed: ${error.message}. Retrying in ${Math.pow(2, i) * 1000}ms...`);
                    // Don't wait on the last attempt
                    if (i < retries - 1) {
                        await new Promise(res => setTimeout(res, Math.pow(2, i) * 1000));
                    }
                }
            }
            // After all retries, throw the last captured error
            throw lastError;
        };

        /**
         * Calls the generative AI model to get structured product data from a natural language prompt.
         * @param {string} prompt The user's prompt for the AI (e.g., product name and details).
         * @param {object} profile The current business profile to provide context to the AI.
         * @returns {Promise<object>} A promise that resolves with the AI response.
         */
        const callGenerativeAI = async (prompt, profile) => {
            // NEW: Restrict this powerful AI feature to admins only.
            if (appState.session.userRole !== 'admin') {
                console.warn(`[AI] Denied access to generative AI for role: ${appState.session.userRole}`);
                return { success: false, error: "You do not have permission to use this feature." };
            }

            console.log(`[AI] Calling Gemini API for product generation with prompt: "${prompt}"`);
            document.getElementById('ai-thinking-indicator')?.classList.remove('hidden');

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${gemini_api_key}`;

            // Dynamically build the system prompt based on the business profile
            let systemInstruction = `You are an expert data entry assistant for a Point of Sale system. Your task is to extract product information from a user's detailed prompt and return it as a structured JSON object.
            The business type is: "${profile.name}".
            Use the following terminology: The product is called a "${profile.terminology.product}", its category is a "${profile.terminology.category}".
            From the user's prompt, extract the product's name, a suitable category, its selling price, its cost price, its barcode (if available), and its initial stock quantity. Assume the currency is USD unless specified otherwise.
            Also, determine if the product is 'physical' or 'service', if it's taxable, and if it requires a serial number (${profile.features.serials ? "this business supports serial numbers" : "this business does not typically use serial numbers"}).
            Fill in the following custom fields based ONLY on the information provided in the prompt: ${profile.customFields.map(f => `"${f.label}"`).join(', ')}.
            Do not search online or invent information not present in the prompt. If a value is not found in the prompt, omit the key. The prices and stock should be numbers, not strings.`;
            
            const productSchema = {
                type: "OBJECT",
                properties: {
                    "name": { "type": "STRING" },
                    "category": { "type": "STRING" },
                    "price": { "type": "NUMBER", "description": "Selling price mentioned in the prompt." },
                    "costPrice": { "type": "NUMBER", "description": "Cost or wholesale price mentioned in the prompt." },
                    "stock": { "type": "NUMBER", "description": "The initial stock or inventory quantity mentioned." },
                    "barcode": { "type": "STRING", "description": "The barcode number (UPC, EAN, etc.) mentioned in the prompt." },
                    "productType": { "type": "STRING", "enum": ["physical", "service"] },
                    "taxable": { "type": "BOOLEAN" },
                    "isSerialized": { "type": "BOOLEAN" },
                    "customData": {
                        "type": "OBJECT",
                        "properties": profile.customFields.reduce((acc, field) => {
                            acc[field.label] = { "type": "STRING" };
                            return acc;
                        }, {}),
                    }
                },
                required: ["name", "category", "price", "productType"]
            };

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: productSchema
                }
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                document.getElementById('ai-thinking-indicator')?.classList.add('hidden');

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("[AI] API Error:", response.status, errorBody);
                    return { success: false, error: `API request failed with status ${response.status}. Check console for details.` };
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const productJson = JSON.parse(candidate.content.parts[0].text);
                    console.log("[AI] Received structured product data:", productJson);
                    return { success: true, product: productJson };
                } else {
                    console.log("[AI] No valid content found in response.", result);
                    let errorMessage = "I couldn't find detailed information for that product. The response was empty.";
                    if(result.promptFeedback?.blockReason) {
                        errorMessage = `Request was blocked: ${result.promptFeedback.blockReason}. Please refine your prompt.`;
                    }
                    return { success: false, error: errorMessage };
                }
            } catch (error) {
                document.getElementById('ai-thinking-indicator')?.classList.add('hidden');
                console.error("[AI] Network or parsing error:", error);
                return { success: false, error: "A network error occurred while contacting the AI." };
            }
        };

        /**
         * Uses the AI to interpret a user's command and return a structured intent.
         * @param {string} prompt The user's natural language command.
         * @returns {Promise<object>} A promise that resolves with the structured intent.
         */
        const getIntentFromAI = async (prompt, userRole) => {
            console.log(`[AI] Calling Gemini API for intent recognition: "${prompt}" for role: "${userRole}"`);

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${gemini_api_key}`;
            const term = getCurrentProfile().terminology;

            // --- NEW: Role-based Intent Filtering ---
            let availableIntents = [ // Base intents for everyone
                "GREETING", "ADD_ITEM_TO_SALE", "CREATE_INVOICE", "VIEW_PRODUCT_DETAILS", "CREATE_CUSTOMER",
                "CREATE_SALE_WITH_NEW_CUSTOMER", "GET_HELP", "UNKNOWN", "APPLY_DISCOUNT_TO_SALE", "UPDATE_CUSTOMER", "VIEW_PAGE"
            ];

            if (userRole === 'manager' || userRole === 'admin') {
                availableIntents.push(
                    "CREATE_PRODUCT", "UPDATE_PRODUCT", "DELETE_PRODUCT", "DELETE_CUSTOMER",
                    "QUERY_DATA", "ANALYZE_DASHBOARD", "GENERATE_REPORT"
                );
            }

            if (userRole === 'admin') {
                availableIntents.push(
                    "UPDATE_SETTING", "CREATE_PROFILE"
                );
            }

            const systemInstruction = `You are a super-powered, fully integrated AI controller for a Point of Sale application. Your primary function is to interpret user commands in English or Bengali (Bangla) and translate them into a structured JSON object representing their intent and any relevant entities. You have complete control over the software's data and navigation. Your reasoning should be a step-by-step thought process on how you interpreted the command and chose the intent and entities.

            Current user's role is: "${userRole}". Only use the intents available to this role.

            Current application context:
            - The product is called a "${term.product}".
            - The inventory is called "${term.inventory}".
            - The category is called "${term.category}".

            Available intents for the "${userRole}" role are:
            - ${availableIntents.join('\n            - ')}

            Extract entities from the user's prompt. For quantities and prices, extract only the number.
            Today is ${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}.
            
            Key command phrases & complex examples:
            - "hello", "hi" -> GREETING
            - "show me", "go to", "open" -> VIEW_PAGE
            - "add", "put" -> ADD_ITEM_TO_SALE
            - "create a product called 'Organic Honey'..." -> CREATE_PRODUCT (extract all details like price, cost, category from the prompt)
            - "create 2 new products: 1. name: 'Mug', price: 15, stock: 50. 2. name: 'Plate', price: 25, stock: 30" -> CREATE_PRODUCT, items: [{productName: 'Mug', price: 15, stock: 50}, {productName: 'Plate', price: 25, stock: 30}]
            - "what is the profit margin on 'Espresso Coffee Beans'?" -> ANALYZE_DASHBOARD, analysisType: 'profit margin', productName: 'Espresso Coffee Beans'
            - "compare sales of Coffee vs Produce this month" -> ANALYZE_DASHBOARD, analysisType: 'category comparison'
            - "generate a sales report for last week" -> GENERATE_REPORT, reportType: 'sales', dateRange: 'last week'
            - "make a new sale for John Doe with 2 organic apples and 1 coffee" -> CREATE_INVOICE
            - "apply a 10% discount to the current sale" -> APPLY_DISCOUNT_TO_SALE, discountType: 'percent', discountValue: 10
            - "list all products with stock less than 50" -> QUERY_DATA, query: 'products with stock < 50'
            - "who are my top 3 customers this month?" -> QUERY_DATA, query: 'top 3 customers this month'
            - "create a new customer John Doe, phone 555-9876, address 123 Oak St" -> CREATE_CUSTOMER
            - "delete customer John Doe" -> DELETE_CUSTOMER, customerName: "John Doe"
            - "start a sale for a new customer named Jane Smith, phone 555-4444, with 2 Organic Apples" -> CREATE_SALE_WITH_NEW_CUSTOMER
            
            Bengali examples:
            - "Hyperion X1   " -> intent: VIEW_PRODUCT_DETAILS, productName: "Hyperion X1"
            - "      ?" -> intent: ANALYZE_DASHBOARD, analysisType: "top selling products"
            - "     " -> intent: GENERATE_REPORT, reportType: 'sales', dateRange: 'last month'
            - "SKU001   " -> intent: DELETE_PRODUCT, productName: "SKU001"
            - "     " -> intent: CREATE_CUSTOMER
            `;

            const intentSchema = {
                type: "OBJECT",
                properties: {
                    "intent": { "type": "STRING", "enum": availableIntents },
                    "entities": {
                        "type": "OBJECT",
                        "properties": {
                            "productName": { "type": "STRING" },
                            "customerName": { "type": "STRING" },
                            "customerPhone": { "type": "STRING" },
                            "customerAddress": { "type": "STRING" },
                            "customerEmail": { "type": "STRING" },
                            "quantity": { "type": "NUMBER" },
                            "price": { "type": "NUMBER" },
                            "settingName": { "type": "STRING" },
                            "settingValue": { "type": "STRING" },
                            "page": { "type": "STRING", "description": "e.g., dashboard, pos, inventory, invoices, reports, customers, settings" },
                            "query": { "type": "STRING", "description": "A concise summary of the user's question about data."},
                            "analysisType": { "type": "STRING", "description": "e.g., 'top selling products', 'profit margin', 'category comparison'" },
                            "reportType": { "type": "STRING", "enum": ["sales", "inventory", "customer"] },
                            "dateRange": { "type": "STRING", "description": "e.g., 'today', 'last week', 'this month', 'last 30 days'" },
                            "discountType": { "type": "STRING", "enum": ["percent", "fixed"] },
                            "discountValue": { "type": "NUMBER" },
                            "invoiceId": { "type": "STRING" },
                            "items": { 
                                "type": "ARRAY", 
                                "description": "Used for creating invoices OR creating multiple products.",
                                "items": { 
                                    "type": "OBJECT",
                                    "properties": {
                                        "productName": { "type": "STRING" },
                                        "quantity": { "type": "NUMBER" },
                                        "category": { "type": "STRING" },
                                        "price": { "type": "NUMBER" },
                                        "costPrice": { "type": "NUMBER" },
                                        "stock": { "type": "NUMBER" }
                                    }
                                }
                            }
                        }
                    },
                    "reasoning": { "type": "STRING", "description": "A step-by-step thought process explaining how the intent and entities were chosen based on the prompt." }
                },
                required: ["intent"]
            };

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: intentSchema
                }
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const intentJson = JSON.parse(candidate.content.parts[0].text);
                    console.log("[AI] Recognized Intent:", intentJson);
                    return { success: true, ...intentJson };
                }
                return { success: false, intent: 'UNKNOWN' };
            } catch (error) {
                console.error("[AI] Intent recognition error:", error);
                return { success: false, intent: 'UNKNOWN' };
            }
        };


        // --- FIREBASE REFERENCES ---
             let storeRef, productsRef, customersRef, invoicesRef, uomRef, notificationsRef, staffRef, usersRef, auditLogRef, expensesRef, suppliersRef, purchaseOrdersRef, warrantiesRef, claimsRef, quotationsRef,  payrollSettingsRef, payrollRunsRef, payslipsRef, loyaltySettingsRef, loyaltyHistoryRef, emiSchedulesRef; // MODIFIED

        const setupFirebaseRefs = (storeId) => {
            if (!storeId) {
                console.error("Cannot setup Firebase refs without a storeId.");
                return;
            }
            storeRef = doc(db, 'stores', storeId);
            productsRef = collection(storeRef, 'products');
            customersRef = collection(storeRef, 'customers');
            invoicesRef = collection(storeRef, 'invoices');
            uomRef = collection(storeRef, 'unitsOfMeasurement');
            notificationsRef = collection(storeRef, 'notifications');
            staffRef = collection(storeRef, 'staff'); // NEW
            usersRef = collection(db, 'users'); // NEW: top-level users collection
            auditLogRef = collection(storeRef, 'auditLog'); // NEW
            expensesRef = collection(storeRef, 'expenses'); // NEW
            suppliersRef = collection(storeRef, 'suppliers'); // NEW
            purchaseOrdersRef = collection(storeRef, 'purchaseOrders'); // NEW
            warrantiesRef = collection(storeRef, 'warranties'); // NEW
            claimsRef = collection(storeRef, 'claims'); // NEW
            quotationsRef = collection(storeRef, 'quotations'); // <-- ADD THIS
             // --- Payroll References ---
            // CORRECTED: Create a subcollection 'payroll' and a document 'general' within it.
            const payrollCollectionRef = collection(storeRef, 'payroll');
            payrollSettingsRef = doc(payrollCollectionRef, 'general'); 
            
            // These remain correct
            payrollRunsRef = collection(storeRef, 'payrollRuns');
            payslipsRef = collection(storeRef, 'payslips'); 
            const loyaltyCollectionRef = collection(storeRef, 'loyalty');
            loyaltySettingsRef = doc(loyaltyCollectionRef, 'config'); // <-- ADD
            loyaltyHistoryRef = collection(storeRef, 'loyaltyHistory');
            emiSchedulesRef = collection(storeRef, 'emiSchedules'); 
        };

        // --- NEW: Function to detach all active Firestore listeners ---
        const detachAllListeners = () => {
            console.log(`[Auth] Detaching ${activeListeners.length} active Firestore listeners.`);
            activeListeners.forEach(unsubscribe => unsubscribe());
            activeListeners = [];
        };

        // --- NEW: Function to handle switching stores ---
        const switchStore = async (newStoreId) => {
            if (newStoreId === appState.session.storeId) {
                console.log("Already in this store.");
                return;
            }
            
            const user = auth.currentUser;
            if (!user) {
                showToast("You must be logged in to switch stores.", "error");
                return;
            }
            
            showToast(`Switching to new store...`, 'info');

            try {
                const userProfileRef = doc(db, 'users', user.uid);
                await updateDoc(userProfileRef, { currentStoreId: newStoreId });
                
                // Force a full page reload to re-initialize everything for the new store context.
                window.location.reload();
            } catch (error) {
                console.error("Error switching store:", error);
                showToast("Failed to switch store. Please try again.", "error");
            }
        };

        // --- REWRITTEN: Store Creation on Signup ---
        const createNewStoreForUser = async (user, businessName) => {
            console.log(`Creating new store '${businessName}' for user ${user.uid}`);

            // --- STEP 1: Create the core User Profile and Store documents ---
            const newStoreRef = doc(collection(db, 'stores'));
            const newStoreId = newStoreRef.id;
            const userProfileRef = doc(collection(db, 'users'), user.uid);

            const initialBatch = writeBatch(db);

            // Define the Store Info
const defaultStoreInfo = {
                name: businessName,
                ownerUid: user.uid, // CRITICAL: Track who owns the store for security rules
                createdAt: new Date().toISOString(),
                logoUrl: `https://placehold.co/100x100/007BFF/FFFFFF?text=${encodeURIComponent(businessName.charAt(0).toUpperCase())}`,
                address: "123 Commerce St, Business City, 12345",
                contact: "555-0101",
                website: "example.com",
                taxId: "BIN-123456789",
                socials: "@yourbusiness",
                baseCurrency: 'USD',
                defaultDisplayCurrency: 'USD',
                currencies: { 'USD': { name: 'US Dollar', symbol: '$', rate: 1 }, 'BDT': { name: 'Bangladeshi Taka', symbol: '', rate: 117.50 }, 'EUR': { name: 'Euro', symbol: '', rate: 0.92 }, 'GBP': { name: 'British Pound', symbol: '', rate: 0.79 }, 'JPY': { name: 'Japanese Yen', symbol: '', rate: 157.25 }, 'INR': { name: 'Indian Rupee', symbol: '', rate: 83.50 } },
                settings: {
                    selectedReceiptTemplate: 'modern', businessType: 'general', defaultCurrency: 'USD', taxRate: 10, defaultUnit: 'pcs',
                    voidLockoutDays: 30, // NEW
                    receiptFooterText: 'Get 15% OFF your next purchase with code: WELCOME15\n30-day return/exchange policy on most items.', // MODIFIED: Added customizable receipt text
                    automations: { dynamicPricing: { enabled: false, strategy: 'balanced' }, fraudDetection: { enabled: true, sensitivity: 'high' }, inventoryOptimization: { enabled: true, analysisFrequency: 'weekly' }, endOfDayReports: { enabled: true, deliveryTime: '22:00' } },
                    permissions: JSON.parse(JSON.stringify(userRoles)),
                    // NEW: Default dynamic categories
                    productCategories: ['Default Category', 'Seasonal'],
                    productBrands: ['Default Brand'],
                },
                customProfiles: {},
            };
            initialBatch.set(newStoreRef, defaultStoreInfo);

            // --- MODIFICATION START: Add default trial subscription ---
            const trialDurationDays = 7; // Set your desired trial duration
            const trialEndDate = new Date();
            trialEndDate.setDate(trialEndDate.getDate() + trialDurationDays);
            
            // Define the User Profile linking the user's UID to their new store ID AND add subscription
            initialBatch.set(userProfileRef, {
                stores: [{ id: newStoreId, name: businessName }],
                currentStoreId: newStoreId,
                createdAt: new Date(), // Add user creation timestamp
                subscription: {
                    status: 'trial',
                    trialEndsAt: trialEndDate, // Use Firestore Timestamp if possible, otherwise Date object
                    planId: 'trial',
                    // Add other relevant subscription fields as needed, e.g., features, limits
                },
                 // NEW: Default store limit for new users
                storeLimit: 1, // Or whatever your default limit is
            });
            // --- MODIFICATION END ---
            const defaultLoyaltySettings = {
              enabled: true,
              pointsPerDollar: 1, // Points earned per base currency unit spent
              rewardThreshold: 100, // Points needed to redeem
              rewardValue: 5, // Value of the reward in base currency
              rewardType: 'fixed_discount', // 'fixed_discount', 'percent_discount'
              earnOnTax: false, // Whether points are earned on the tax amount
              redeemLimitPerOrder: 1 // Max rewards redeemable per order
            };
            // REMOVED: This line was moved to the second batch to fix permission errors
            // initialBatch.set(doc(collection(newStoreRef, 'loyalty'), 'config'), defaultLoyaltySettings);

            // Commit the first, most critical batch
            await initialBatch.commit();
            console.log(`Step 1 Complete: Created store ${newStoreId} and user profile for ${user.uid} with trial subscription.`);

            // --- STEP 2: Create all the subcollection documents ---
            // ... (rest of the function remains the same) ...
             const subcollectionBatch = writeBatch(db);

            // ADDED: Create default loyalty settings in the second batch
            subcollectionBatch.set(doc(collection(newStoreRef, 'loyalty'), 'config'), defaultLoyaltySettings);

            // Create default Units of Measurement
            const newUomRef = collection(newStoreRef, 'unitsOfMeasurement');
            const defaultUnits = [
                { id: 'pcs', name: 'Piece(s)', allowsDecimal: false }, { id: 'kg', name: 'Kilogram', allowsDecimal: true }, { id: 'g', name: 'Gram', allowsDecimal: true },
                { id: 'ltr', name: 'Liter', allowsDecimal: true }, { id: 'ml', name: 'Milliliter', allowsDecimal: true }, { id: 'box', name: 'Box', allowsDecimal: false }, { id: 'pack', name: 'Pack', allowsDecimal: false },
            ];
            defaultUnits.forEach(unit => subcollectionBatch.set(doc(newUomRef, unit.id), unit));

            // Create a welcome Notification
            const newNotificationsRef = collection(newStoreRef, 'notifications');
            const welcomeNotification = {
                date: new Date().toISOString(), message: "Welcome to CashShilpo! Your new POS is set up and ready to go. Start by adding your first product.",
                type: 'info', read: false, targetRoles: ['admin', 'manager']
            };
            subcollectionBatch.set(doc(newNotificationsRef), welcomeNotification);

            // Create the user's staff profile *inside* their new store
            const newStaffRef = doc(collection(newStoreRef, 'staff'), user.uid);
            subcollectionBatch.set(newStaffRef, {
                name: user.displayName || user.email, email: user.email, role: 'admin', status: 'active',
                joinDate: new Date().toISOString()
            });

            await subcollectionBatch.commit();
            console.log(`Step 2 Complete: Successfully created subcollection documents for store ${newStoreId}`);

            return newStoreId; // Return the new store ID
        };

        // --- NEW: Function to add a new store to an existing user ---
        const addNewStoreToExistingUser = async (user, businessName) => {
            console.log(`Adding new store '${businessName}' for existing user ${user.uid}`);
            
            // --- STEP 1: Create the new Store document ---
            const newStoreRef = doc(collection(db, 'stores'));
            const newStoreId = newStoreRef.id;

            const newStoreData = {
                name: businessName,
                ownerUid: user.uid, // The user creating it is the owner
                createdAt: new Date().toISOString(),
                logoUrl: `https://placehold.co/100x100/007BFF/FFFFFF?text=${encodeURIComponent(businessName.charAt(0).toUpperCase())}`,
                address: "123 Commerce St, Business City, 12345",
                contact: "555-0101",
                website: "example.com",
                taxId: "BIN-123456789",
                socials: "@yourbusiness",
                baseCurrency: 'USD',
                defaultDisplayCurrency: 'USD',
                currencies: { 'USD': { name: 'US Dollar', symbol: '$', rate: 1 }, 'BDT': { name: 'Bangladeshi Taka', symbol: '', rate: 117.50 }, 'EUR': { name: 'Euro', symbol: '', rate: 0.92 }, 'GBP': { name: 'British Pound', symbol: '', rate: 0.79 }, 'JPY': { name: 'Japanese Yen', symbol: '', rate: 157.25 }, 'INR': { name: 'Indian Rupee', symbol: '', rate: 83.50 } },
                settings: {
                    selectedReceiptTemplate: 'modern', businessType: 'general', defaultCurrency: 'USD', taxRate: 10, defaultUnit: 'pcs',
                    voidLockoutDays: 30,
                    receiptFooterText: 'Get 15% OFF your next purchase with code: WELCOME15\n30-day return/exchange policy on most items.', // MODIFIED: Added customizable receipt text
                    automations: { dynamicPricing: { enabled: false, strategy: 'balanced' }, fraudDetection: { enabled: true, sensitivity: 'high' }, inventoryOptimization: { enabled: true, analysisFrequency: 'weekly' }, endOfDayReports: { enabled: true, deliveryTime: '22:00' } },
                    permissions: JSON.parse(JSON.stringify(userRoles)),
                    // NEW: Default dynamic categories
                    productCategories: ['Default Category', 'Seasonal'],
                    productBrands: ['Default Brand'],
                },
                customProfiles: {},
            };
            await setDoc(newStoreRef, newStoreData);

            // --- STEP 2: Create subcollections for the new store ---
            const subcollectionBatch = writeBatch(db);
            const newUomRef = collection(newStoreRef, 'unitsOfMeasurement');
            const defaultUnits = [
                { id: 'pcs', name: 'Piece(s)', allowsDecimal: false }, { id: 'kg', name: 'Kilogram', allowsDecimal: true }, { id: 'g', name: 'Gram', allowsDecimal: true },
                { id: 'ltr', name: 'Liter', allowsDecimal: true }, { id: 'ml', name: 'Milliliter', allowsDecimal: true }, { id: 'box', name: 'Box', allowsDecimal: false }, { id: 'pack', name: 'Pack', allowsDecimal: false },
            ];
            defaultUnits.forEach(unit => subcollectionBatch.set(doc(newUomRef, unit.id), unit));

            const newNotificationsRef = collection(newStoreRef, 'notifications');
            const welcomeNotification = {
                date: new Date().toISOString(), message: `Welcome to your new store, ${businessName}!`,
                type: 'info', read: false, targetRoles: ['admin', 'manager']
            };
            subcollectionBatch.set(doc(newNotificationsRef), welcomeNotification);

            // Add the user as the admin for this new store
            const newStaffRef = doc(collection(newStoreRef, 'staff'), user.uid);
            subcollectionBatch.set(newStaffRef, {
                name: user.displayName || user.email, email: user.email, role: 'admin', status: 'active',
                joinDate: new Date().toISOString()
            });
            const defaultLoyaltySettings = { // Same defaults as above
              enabled: true, pointsPerDollar: 1, rewardThreshold: 100, rewardValue: 5,
              rewardType: 'fixed_discount', earnOnTax: false, redeemLimitPerOrder: 1
            };
            subcollectionBatch.set(doc(collection(newStoreRef, 'loyalty'), 'config'), defaultLoyaltySettings);
            await subcollectionBatch.commit();
            
            // --- STEP 3: Update the user's profile ---
            // We use a transaction to safely read and update the user's stores array.
            const userProfileRef = doc(db, 'users', user.uid);
            await runTransaction(db, async (transaction) => {
                const userDoc = await transaction.get(userProfileRef);
                if (!userDoc.exists()) {
                    throw "User document does not exist!";
                }
                const currentStores = userDoc.data().stores || [];
                const newStores = [...currentStores, { id: newStoreId, name: businessName }];
                // Atomically update the stores array and set the current store to the new one
                transaction.update(userProfileRef, { stores: newStores, currentStoreId: newStoreId });
            });
            
            console.log(`Successfully added and switched to new store ${newStoreId}`);
            return newStoreId;
        };

        const syncStoreNameToUserProfiles = async (storeId, newStoreName) => {
            console.log(`[Sync] Starting store name sync for store ${storeId} to '${newStoreName}'.`);
            try {
                const staffSnapshot = await getDocs(staffRef);
                if (staffSnapshot.empty) {
                    console.warn('[Sync] No staff found for this store. Sync complete.');
                    return;
                }

                const batch = writeBatch(db);
                
                const userDocPromises = staffSnapshot.docs.map(staffDoc => getDoc(doc(usersRef, staffDoc.id)));
                const userDocsSnapshots = await Promise.all(userDocPromises);

                userDocsSnapshots.forEach((userDocSnap, index) => {
                    if (userDocSnap.exists()) {
                        const userId = userDocSnap.id;
                        const userProfileRef = doc(usersRef, userId);
                        const userData = userDocSnap.data();
                        const currentStores = userData.stores || [];
                        
                        const storeIndex = currentStores.findIndex(s => s.id === storeId);
                        
                        if (storeIndex > -1 && currentStores[storeIndex].name !== newStoreName) {
                            const updatedStores = [...currentStores];
                            updatedStores[storeIndex].name = newStoreName;
                            batch.update(userProfileRef, { stores: updatedStores });
                            console.log(`[Sync] Queued name update for user ${userId}.`);
                        }
                    } else {
                        const failedUserId = staffSnapshot.docs[index].id;
                        console.warn(`[Sync] User profile not found for staff ID: ${failedUserId}`);
                    }
                });

                await batch.commit();
                console.log('[Sync] Store name sync completed successfully.');

            } catch (error) {
                console.error('[Sync] Failed to sync store name across user profiles:', error);
            }
        };
// --- NEW PERMISSION AND UI LOGIC ---
// This part is new. It checks who can see what.
const checkPermission = (permission) => {
    const currentUserRole = appState.session.userRole;
    
    // --- NEW: Force disable expenses for cashiers ---
    if ((permission === 'canManageExpenses' || permission === 'canAddExpenses' || permission === 'canEditExpenses' || permission === 'canDeleteExpenses') && currentUserRole === 'cashier') {
        return false;
    }
    // --- END NEW ---
    
    // 1. Admin with 'canDoEverything' always has permission. Admin permissions are static and not editable.
    if (currentUserRole === 'admin' && userRoles.admin.permissions.canDoEverything) {
        return true;
    }

    if (!currentUserRole) return false;

    // 2. Check for customized permissions from Firestore settings first.
    // These are loaded into appState.settings.permissions on startup.
    const customPermissionInfo = appState.settings.permissions?.[currentUserRole]?.permissions?.[permission];
    if (customPermissionInfo !== undefined) {
        return customPermissionInfo.value;
    }

    // 3. Fallback to static permissions if no custom one is set (for safety, though they should always be set).
    const staticPermissionInfo = userRoles[currentUserRole]?.permissions?.[permission];
    if (staticPermissionInfo !== undefined) {
        return staticPermissionInfo.value;
    }

    return false;
};

const updateUIPermissions = () => {
    // --- MODIFICATION START: Add guard clause ---
    // Don't render UI permissions until the user session is fully populated
    if (!appState.session.currentUser || !appState.session.userRole) {
        // This prevents the "Not Logged In" flash.
        console.log("[Auth] updateUIPermissions: Waiting for session data...");
        return; 
    }
    // --- MODIFICATION END ---

    // This part hides and shows the links in your sidebar based on user role
    document.querySelectorAll('[data-permission]').forEach(el => {
        const requiredPermission = el.dataset.permission;

        // SPECIAL CASE FOR INVENTORY: The nav link requires 'canManageInventory' in the HTML,
        // but we want to show it for any inventory-related permission.
        if (el.dataset.view === 'inventory' && requiredPermission === 'canManageInventory') {
            if (checkPermission('canViewInventory') || checkPermission('canAddProducts') || checkPermission('canEditProducts') || checkPermission('canDeactivateProducts')) { // MODIFIED
                el.style.display = 'flex';
            } else {
                el.style.display = 'none';
            }
            return; // Move to the next element
        }

        // Original logic for all other elements
        if (checkPermission(requiredPermission)) {
            el.style.display = 'flex';
        } else {
            el.style.display = 'none';
        }
    });

    // This part updates your name and role at the bottom of the sidebar
    const user = appState.session.currentUser;
    const role = appState.session.userRole;
    if (user && role) {
        document.getElementById('user-name').textContent = user.name;
        document.getElementById('user-role').textContent = userRoles[role]?.name || 'Unknown Role';
        const avatarLetter = user.name ? user.name.charAt(0).toUpperCase() : '?';
        document.getElementById('user-avatar').src = `https://placehold.co/40x40/1f2937/4b5563?text=${avatarLetter}`;
        
        // NEW: Populate user menu
        const userMenuName = document.getElementById('user-menu-name');
        const userMenuEmail = document.getElementById('user-menu-email');
        if(userMenuName) userMenuName.textContent = user.name;
        if(userMenuEmail) userMenuEmail.textContent = user.email;

    } else {
         document.getElementById('user-name').textContent = 'Not Logged In';
         document.getElementById('user-role').textContent = 'No Role';
         document.getElementById('user-avatar').src = `https://placehold.co/40x40/1f2937/4b5563?text=?`;
    }
};

// --- NEW SECTION: CORE UTILITY FUNCTIONS ---
// Moved from DOMContentLoaded to be available globally sooner.
const currencyUtils = {
    get(currencyCode = appState.currentCurrency) {
        const currencies = firestoreData.storeInfo.currencies || {};
        const base = firestoreData.storeInfo.baseCurrency || 'USD';
        return currencies[currencyCode] || currencies[base] || { name: 'US Dollar', symbol: '$', rate: 1 };
    },
    convert(amountInBase, toCurrencyCode = appState.currentCurrency) {
        const rate = this.get(toCurrencyCode).rate || 1;
        return amountInBase * rate;
    },
    convertToBase(amountInCurrency, fromCurrencyCode = appState.currentCurrency) {
        const rate = this.get(fromCurrencyCode).rate || 1;
        if (rate === 0) return 0;
        return amountInCurrency / rate;
    },
    format(amountInBase, toCurrencyCode = appState.currentCurrency, options = {}) {
        if (isNaN(amountInBase)) amountInBase = 0;
        const currencyInfo = this.get(toCurrencyCode);
        const convertedAmount = this.convert(amountInBase, toCurrencyCode);
        
        // --- UPDATED: Removed automatic compact notation (1M) ---
        // Previously, this code converted >1,000,000 to "1M". 
        // This block is now removed to show full numbers or ellipsis as requested.
        /* if (options.notation === undefined && Math.abs(convertedAmount) >= 1000000) {
            options.notation = 'compact';
            options.maximumFractionDigits = 2; // e.g., 1.44M
        } 
        */
        
        const formattedWithCode = new Intl.NumberFormat(undefined, {
            style: 'currency',
            currency: toCurrencyCode,
            currencyDisplay: 'code',
            ...options
        }).format(convertedAmount);
        
        return formattedWithCode.replace(toCurrencyCode, currencyInfo.symbol);
    }
};

/**
 * Opens the Daybook modal for a specified date, adjusting content based on user role.
 * If no date is provided, it defaults to today.
 *
 * @param {string|null} dateString - Optional date string in 'YYYY-MM-DD' format.
 */
async function openDaybookModal(dateString = null) {
    // --- Role-Based Access Control ---
    const userRole = appState.session.userRole;
    const userId = appState.session.currentUser?.uid;
    const canSeeAllData = userRole === 'admin' || userRole === 'manager'; // Admins and Managers see everything
    const canSeeExpenses = checkPermission('canManageExpenses'); // Check if user can see expenses tab

    const selectedDate = dateString ? new Date(dateString + 'T00:00:00') : new Date();
    // Ensure date respects local timezone when creating the string
    const year = selectedDate.getFullYear();
    const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
    const day = String(selectedDate.getDate()).padStart(2, '0');
    const formattedDate = `${year}-${month}-${day}`;

    // --- Dynamically Build Tabs based on Role ---
    let tabsHTML = `
        <button data-tab="summary" class="daybook-tab-btn active-tab flex-shrink-0">Summary</button>
        <button data-tab="sales" class="daybook-tab-btn flex-shrink-0">Sales</button>
    `;
    if (canSeeExpenses) {
        tabsHTML += `<button data-tab="expenses" class="daybook-tab-btn flex-shrink-0">Expenses</button>`;
    }
    if (canSeeAllData) { // Only Admins/Managers see Cash Flow, Due & Discounts
        tabsHTML += `<button data-tab="cashflow" class="daybook-tab-btn flex-shrink-0">Cash Flow</button>`;
    }
    // Inventory tab might be visible based on profile, but data inside will be filtered
    tabsHTML += `<button data-tab="inventory" class="daybook-tab-btn flex-shrink-0">Inventory</button>`;
    if (canSeeAllData) {
        tabsHTML += `<button data-tab="due-discounts" class="daybook-tab-btn flex-shrink-0">Due & Discounts</button>`;
    }

    const content = `
        <div id="daybook-content" class="space-y-4">
            <!-- Header -->
            <div class="flex flex-col md:flex-row justify-between md:items-center gap-2">
                <h3 class="text-xl font-semibold text-text-primary">Daybook for ${selectedDate.toLocaleDateString()} ${userRole === 'cashier' ? `(Your Activity)` : ''}</h3>
                <input type="date" id="daybook-date-picker" value="${formattedDate}" class="form-input bg-bg-tertiary text-sm p-2 h-10 rounded-md border-border-color">
            </div>

            <!-- Tab Navigation -->
            <nav class="flex border-b border-border-color overflow-x-auto" id="daybook-tabs">
                ${tabsHTML}
            </nav>

            <!-- Tab Content -->
            <div id="daybook-tab-content" class="pt-4">
                <!-- Summary Tab -->
                <div id="tab-summary" class="daybook-tab-pane">
                    <div id="daybook-summary-kpis" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <!-- KPIs will be loaded here -->
                        ${Array(canSeeAllData ? 9 : 3).fill('<div class="glass-pane p-4 rounded-lg animate-pulse h-20"></div>').join('')}
                    </div>
                </div>

                <!-- Sales Tab -->
                <div id="tab-sales" class="daybook-tab-pane hidden space-y-4">
                    ${canSeeAllData ? `
                    <div>
                        <h4 class="font-semibold text-text-primary mb-2">Sales by Customer</h4>
                        <div id="daybook-sales-by-customer" class="daybook-section">Loading...</div>
                    </div>` : ''}
                    <div>
                        <h4 class="font-semibold text-text-primary mb-2">${canSeeAllData ? 'All Sales Invoices' : 'Your Sales Invoices'}</h4>
                        <div id="daybook-sales-details" class="daybook-section">Loading...</div>
                    </div>
                </div>

                <!-- Expenses Tab (Conditional) -->
                ${canSeeExpenses ? `
                <div id="tab-expenses" class="daybook-tab-pane hidden space-y-4">
                    ${canSeeAllData ? `
                    <div>
                        <h4 class="font-semibold text-text-primary mb-2">Expenses by Category</h4>
                        <div id="daybook-expenses-by-category" class="daybook-section">Loading...</div>
                    </div>` : ''}
                    <div>
                        <h4 class="font-semibold text-text-primary mb-2">${canSeeAllData ? 'All Expenses' : 'Your Expenses'}</h4>
                        <div id="daybook-expenses-details" class="daybook-section">Loading...</div>
                    </div>
                </div>` : ''}

                <!-- Cash Flow Tab (Conditional) -->
                 ${canSeeAllData ? `
                <div id="tab-cashflow" class="daybook-tab-pane hidden space-y-4">
                    <div>
                        <h4 class="font-semibold text-text-primary mb-2">Payments by Method</h4>
                        <div id="daybook-payments-by-method" class="daybook-section">Loading...</div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-text-primary mb-2">Due Collected & EMI Payments</h4>
                        <div id="daybook-due-collections" class="daybook-section">Loading...</div>
                    </div>
                </div>` : ''}

                <!-- Inventory Tab -->
                <div id="tab-inventory" class="daybook-tab-pane hidden space-y-4">
                    <div>
                        <h4 class="font-semibold text-text-primary mb-2">Items Sold Today ${userRole === 'cashier' ? '(Your Sales)' : ''}</h4>
                        <div id="daybook-inventory-sold" class="daybook-section">Loading...</div>
                    </div>
                </div>

                <!-- Due & Discounts Tab (Conditional) -->
                 ${canSeeAllData ? `
                <div id="tab-due-discounts" class="daybook-tab-pane hidden space-y-4">
                    <div>
                        <h4 class="font-semibold text-text-primary mb-2">New Due Amounts Added (Credit & EMI Loans)</h4>
                        <div id="daybook-new-due" class="daybook-section">Loading...</div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-text-primary mb-2">Discounts Given</h4>
                        <div id="daybook-discounts-given" class="daybook-section">Loading...</div>
                    </div>
                </div>` : ''}
            </div>
        </div>
        <style>
            .daybook-section { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 1rem; min-height: 150px; max-height: 35vh; overflow-y: auto; font-size: 0.875rem; }
            .daybook-item { display: flex; justify-content: space-between; padding: 0.5rem 0.25rem; border-bottom: 1px solid var(--border-color); }
            .daybook-item:last-child { border-bottom: none; }
            .daybook-tab-btn { padding: 0.75rem 1rem; border-bottom: 2px solid transparent; color: var(--text-secondary); font-weight: 500; }
            .daybook-tab-btn.active-tab { color: var(--accent); border-color: var(--accent); }
            .daybook-tab-pane.hidden { display: none; }
        </style>
    `;
    const footer = `<button data-action="close-modal" class="btn btn-secondary">Close</button><button id="print-daybook" class="btn btn-primary"><i data-lucide="printer" class="w-4 h-4 mr-2"></i>Print Daybook</button>`;

    // Use max-w-5xl for a wider modal to accommodate new tabs
    const modal = showModal(`Daybook`, content, footer, { size: 'max-w-5xl' });
    lucide.createIcons();

    // --- Tab switching logic ---
    const tabs = modal.querySelector('#daybook-tabs');
    const panes = modal.querySelectorAll('.daybook-tab-pane');
    tabs.addEventListener('click', (e) => {
        const btn = e.target.closest('.daybook-tab-btn');
        if (!btn) return;

        tabs.querySelectorAll('.daybook-tab-btn').forEach(t => t.classList.remove('active-tab'));
        btn.classList.add('active-tab');

        panes.forEach(p => p.classList.add('hidden'));
        const tabId = btn.dataset.tab;
        const targetPane = modal.querySelector(`#tab-${tabId}`);
        if (targetPane) { // Ensure the pane exists before trying to show it
            targetPane.classList.remove('hidden');
        } else {
             console.warn(`Daybook tab content for '${tabId}' not found.`);
             // Optionally show a default tab or message if the intended one is missing
             const summaryPane = modal.querySelector(`#tab-summary`);
             if (summaryPane) summaryPane.classList.remove('hidden');
        }
    });

    // --- Main data rendering function ---
    const renderDaybookContent = async (modalInstance, date, currentUserRole, currentUserId) => {
        const startDate = new Date(date);
        startDate.setHours(0, 0, 0, 0);
        const endDate = new Date(date);
        endDate.setHours(23, 59, 59, 999);

        // --- Set Loading States ---
        const setLoading = (selector) => {
            const el = modalInstance.querySelector(selector);
            if (el) el.innerHTML = '<p class="text-center text-text-secondary py-4">Loading...</p>';
        };
        setLoading('#daybook-summary-kpis');
        setLoading('#daybook-sales-details');
        if (canSeeAllData) setLoading('#daybook-sales-by-customer');
        if (canSeeExpenses) setLoading('#daybook-expenses-details');
        if (canSeeExpenses && canSeeAllData) setLoading('#daybook-expenses-by-category');
        if (canSeeAllData) setLoading('#daybook-payments-by-method');
        if (canSeeAllData) setLoading('#daybook-due-collections');
        setLoading('#daybook-inventory-sold');
        if (canSeeAllData) setLoading('#daybook-new-due');
        if (canSeeAllData) setLoading('#daybook-discounts-given');


        // --- Fetch Data ---
        const allInvoices = firestoreData.invoices || [];
        const allExpenses = firestoreData.expenses || [];

        // --- Filter Data Based on Role ---
        let relevantInvoices = allInvoices;
        let relevantExpenses = allExpenses;
        let relevantPayments = allInvoices.flatMap(inv => (inv.paymentDetails || []).map(p => ({...p, invoiceId: inv.id, customerName: inv.customerName, cashierId: inv.cashierId }))); // Add cashierId to payments

        if (currentUserRole === 'cashier' && currentUserId) {
            relevantInvoices = allInvoices.filter(inv => inv.cashierId === currentUserId);
            // Cashiers might only see their own expenses if canManageExpenses allows it
            if (canSeeExpenses) {
                relevantExpenses = allExpenses.filter(exp => exp.recordedBy?.id === currentUserId);
            } else {
                relevantExpenses = []; // Hide expenses if they don't have permission
            }
             // Filter payments based on the cashier who created the INVOICE
            relevantPayments = relevantPayments.filter(p => p.cashierId === currentUserId);
        }

        // Filter by Date (applies to both roles, but on potentially pre-filtered data for cashiers)
        const dailyInvoices = relevantInvoices.filter(inv => {
            const invDate = new Date(inv.date);
            return invDate >= startDate && invDate <= endDate && inv.status !== 'Void';
        });
        const dailyExpenses = relevantExpenses.filter(exp => {
            const expDate = new Date(exp.date);
            return expDate >= startDate && expDate <= endDate;
        });
        // Correctly get all relevant payments made today, regardless of invoice date
        const dailyPayments = relevantPayments.filter(p => {
                const paymentDate = new Date(p.date);
                return paymentDate >= startDate && paymentDate <= endDate;
        });

        // --- Calculate KPIs (Role-Dependent) ---
        const kpiContainer = modalInstance.querySelector('#daybook-summary-kpis');
        if (!kpiContainer) return; // Should not happen, but safety check

        if (canSeeAllData) {
            // Admin / Manager View: Calculate store-wide KPIs
            const paymentsBeforeToday = allInvoices.flatMap(inv => inv.paymentDetails || [])
                .filter(p => new Date(p.date) < startDate && p.method !== 'Add to Due');
            const expensesBeforeToday = allExpenses.filter(exp => new Date(exp.date) < startDate);

            const totalSales = dailyInvoices.reduce((sum, inv) => sum + inv.totalInBaseCurrency, 0);
            const totalExpenses = dailyExpenses.reduce((sum, exp) => sum + exp.amountInBase, 0);
            const totalPaymentsReceived = dailyPayments
                .filter(p => p.method !== 'Add to Due')
                .reduce((sum, p) => sum + currencyUtils.convertToBase(p.amount, p.currency || appState.currentCurrency), 0);
            const netCashMovement = totalPaymentsReceived - totalExpenses;
            const openingBalance = paymentsBeforeToday.reduce((sum, p) => sum + currencyUtils.convertToBase(p.amount, p.currency || appState.currentCurrency), 0)
                                 - expensesBeforeToday.reduce((sum, exp) => sum + exp.amountInBase, 0);
            const closingBalance = openingBalance + netCashMovement;
            
            // --- UPDATED: Due Collected (includes EMI installments & settlements) ---
            const totalDueCollected = dailyPayments
                .filter(p => (p.isDuePayment === true || p.isEMIPayment === true || p.isEMISettlement === true) && p.method !== 'Add to Due')
                .reduce((sum, p) => sum + currencyUtils.convertToBase(p.amount, p.currency || appState.currentCurrency), 0);
                
            // --- UPDATED: New Due Added (includes Principal + Interest of EMI loans) ---
            // Fix: Previously only calculated Principal. Now adds Interest to match Dashboard "Receivables".
            const newDueAdded = dailyInvoices.reduce((acc, inv) => {
                 const paymentsOnCreation = (inv.paymentDetails || [])
                    .filter(p => {
                         // Check if payment was made on the same day (roughly)
                         const pDate = new Date(p.date).toDateString();
                         const iDate = new Date(inv.date).toDateString();
                         return pDate === iDate && p.method !== 'Add to Due';
                    })
                    .reduce((pSum, p) => pSum + currencyUtils.convertToBase(p.amount, inv.currency || appState.currentCurrency), 0);
                 
                 let dueFromInvoice = Math.max(0, inv.totalInBaseCurrency - paymentsOnCreation);

                 // --- FIX: Add Interest for EMI Invoices ---
                 if (inv.isEMI) {
                     const schedule = firestoreData.emiSchedules.find(s => s.invoiceId === inv.id);
                     if (schedule) {
                         dueFromInvoice += (schedule.totalInterest || 0);
                     }
                 }
                 
                 return acc + dueFromInvoice;
            }, 0);

            const totalDiscounts = dailyInvoices
                .reduce((sum, inv) => sum + (inv.discountInBaseCurrency || 0), 0);

            // --- Render Summary KPIs for Admin/Manager ---
            kpiContainer.innerHTML = `
                ${renderKpiCard('Opening Balance', currencyUtils.format(openingBalance), 'text-blue-400')}
                ${renderKpiCard('Total Sales', currencyUtils.format(totalSales), 'text-green-400')}
                ${renderKpiCard('Total Expenses', currencyUtils.format(totalExpenses), 'text-red-400')}
                ${renderKpiCard('Payments Received', currencyUtils.format(totalPaymentsReceived), 'text-green-400')}
                ${renderKpiCard('Due / EMI Collected', currencyUtils.format(totalDueCollected), 'text-emerald-400')}
                ${renderKpiCard('New Due / Loan Given', currencyUtils.format(newDueAdded), 'text-orange-400')}
                ${renderKpiCard('Total Discounts', currencyUtils.format(totalDiscounts), 'text-yellow-400')}
                ${renderKpiCard('Net Cash Movement', currencyUtils.format(netCashMovement), netCashMovement >= 0 ? 'text-blue-400' : 'text-orange-400', netCashMovement >= 0 ? '+' : '')}
                ${renderKpiCard('Closing Balance', currencyUtils.format(closingBalance), 'text-blue-400')}
            `;
        } else {
            // Cashier View: Calculate cashier-specific KPIs
            const cashierTotalSales = dailyInvoices.reduce((sum, inv) => sum + inv.totalInBaseCurrency, 0);
            const cashierPaymentsReceived = dailyPayments
                .filter(p => p.method !== 'Add to Due')
                .reduce((sum, p) => sum + currencyUtils.convertToBase(p.amount, p.currency || appState.currentCurrency), 0);
             const cashierDiscountsGiven = dailyInvoices
                .reduce((sum, inv) => sum + (inv.discountInBaseCurrency || 0), 0); // Discounts on THEIR invoices

            // --- Render Summary KPIs for Cashier ---
             kpiContainer.innerHTML = `
                ${renderKpiCard('Your Sales', currencyUtils.format(cashierTotalSales), 'text-green-400')}
                ${renderKpiCard('Payments You Received', currencyUtils.format(cashierPaymentsReceived), 'text-green-400')}
                ${renderKpiCard('Discounts You Gave', currencyUtils.format(cashierDiscountsGiven), 'text-yellow-400')}
            `;
             // Add more cashier-specific KPIs if needed
        }
        lucide.createIcons();

        // --- Render Sales Tab ---
        renderSimpleList(
            '#daybook-sales-details',
            dailyInvoices, // Uses filtered invoices (all for admin/manager, cashier's own for cashier)
            inv => `<span>Invoice <span class="font-mono text-xs">${inv.id.slice(-6)}</span> (${inv.customerName})</span>
                    <span class="font-mono text-green-400">${currencyUtils.format(inv.totalInBaseCurrency)}</span>`,
            canSeeAllData ? 'No sales recorded for this date.' : 'You recorded no sales for this date.'
        );
        if (canSeeAllData) {
            renderGroupedList(
                '#daybook-sales-by-customer',
                dailyInvoices, // Uses all daily invoices for admin/manager
                'customerName',
                'totalInBaseCurrency',
                'text-green-400',
                'No sales by customer.'
            );
        }

        // --- Render Expenses Tab (Conditional) ---
        if (canSeeExpenses) {
            renderSimpleList(
                '#daybook-expenses-details',
                dailyExpenses, // Uses filtered expenses
                exp => `<span>${exp.category} ${exp.paidTo ? `(${exp.paidTo})` : ''}</span>
                        <span class="font-mono text-red-400">${currencyUtils.format(exp.amountInBase)}</span>`,
                canSeeAllData ? 'No expenses recorded for this date.' : 'You recorded no expenses for this date.'
            );
            if (canSeeAllData) {
                renderGroupedList(
                    '#daybook-expenses-by-category',
                    dailyExpenses, // Uses all daily expenses for admin/manager
                    'category',
                    'amountInBase',
                    'text-red-400',
                    'No expenses by category.'
                );
            }
        }


        // --- Render Cash Flow Tab (Conditional) ---
        if (canSeeAllData) {
            const paymentsByMethod = dailyPayments.reduce((acc, p) => {
                const method = p.method === 'Add to Due' ? 'Due Added' : p.method;
                acc[method] = (acc[method] || 0) + currencyUtils.convertToBase(p.amount, p.currency || appState.currentCurrency);
                return acc;
            }, {});
            renderSimpleList(
                '#daybook-payments-by-method',
                Object.entries(paymentsByMethod),
                ([method, amount]) => `<span>${method}</span>
                        <span class="font-mono ${method === 'Due Added' ? 'text-orange-400' : 'text-blue-400'}">
                            ${currencyUtils.format(amount)}
                        </span>`,
                'No payments received or due added.'
            );
            
            // --- UPDATED: Collections List includes EMI ---
            const dueCollectionsList = dailyPayments.filter(p => (p.isDuePayment === true || p.isEMIPayment === true || p.isEMISettlement === true) && p.method !== 'Add to Due');
            
            renderSimpleList(
                '#daybook-due-collections',
                dueCollectionsList,
                p => {
                    let typeLabel = 'Due Collection';
                    let colorClass = 'text-emerald-400';
                    if (p.isEMIPayment) { typeLabel = 'EMI Installment'; colorClass = 'text-blue-400'; }
                    if (p.isEMISettlement) { typeLabel = 'EMI Settlement'; colorClass = 'text-purple-400'; }
                    
                    return `<span>${typeLabel} <span class="font-mono text-xs text-text-secondary">(${p.customerName || 'Unknown'})</span></span>
                      <span class="font-mono ${colorClass}">${currencyUtils.format(currencyUtils.convertToBase(p.amount, p.currency || appState.currentCurrency))}</span>`
                },
                'No due or EMI collections recorded.'
            );
        }

        // --- Render Inventory Tab ---
        const itemsSold = dailyInvoices.flatMap(inv => inv.items || []).reduce((acc, item) => { // Uses filtered invoices
            const itemName = item.name || 'Unknown Item';
            acc[itemName] = (acc[itemName] || 0) + (parseFloat(item.qty) || 0);
            return acc;
        }, {});
        renderSimpleList(
            '#daybook-inventory-sold',
            Object.entries(itemsSold),
            ([name, quantity]) => `<span>${name}</span>
                                   <span class="font-mono text-text-primary">${quantity % 1 !== 0 ? quantity.toFixed(2) : quantity} units</span>`,
            canSeeAllData ? 'No items sold recorded for this date.' : 'You sold no items on this date.'
        );

        // --- Render Due & Discounts Tab (Conditional) ---
        if (canSeeAllData) {
            // --- UPDATED: Filter logic for new due ---
            // We list invoices where Total > Payments made on creation date
            const newDueInvoicesList = dailyInvoices.filter(inv => {
                 const paymentsOnCreation = (inv.paymentDetails || [])
                    .filter(p => {
                         const pDate = new Date(p.date).toDateString();
                         const iDate = new Date(inv.date).toDateString();
                         return pDate === iDate && p.method !== 'Add to Due';
                    })
                    .reduce((pSum, p) => pSum + currencyUtils.convertToBase(p.amount, inv.currency || appState.currentCurrency), 0);
                 return (inv.totalInBaseCurrency - paymentsOnCreation) > 0.01;
            });

            renderSimpleList(
                '#daybook-new-due',
                newDueInvoicesList,
                inv => {
                     const paymentsOnCreation = (inv.paymentDetails || [])
                        .filter(p => {
                             const pDate = new Date(p.date).toDateString();
                             const iDate = new Date(inv.date).toDateString();
                             return pDate === iDate && p.method !== 'Add to Due';
                        })
                        .reduce((pSum, p) => pSum + currencyUtils.convertToBase(p.amount, inv.currency || appState.currentCurrency), 0);
                     
                     let newDueAmount = Math.max(0, inv.totalInBaseCurrency - paymentsOnCreation);
                     
                     // Fix list item display to include interest
                     let emiInterest = 0;
                     if (inv.isEMI) {
                         const schedule = firestoreData.emiSchedules.find(s => s.invoiceId === inv.id);
                         if (schedule) {
                             emiInterest = schedule.totalInterest || 0;
                             newDueAmount += emiInterest;
                         }
                     }
                     
                     return `<span>${inv.isEMI ? 'EMI Loan' : 'Invoice'} <span class="font-mono text-xs">${inv.id.slice(-6)}</span> (${inv.customerName})</span>
                      <span class="font-mono text-orange-400">${currencyUtils.format(newDueAmount)}</span>`;
                },
                'No new due amounts added.'
            );

            const discountedInvoices = dailyInvoices.filter(inv => (inv.discountInBaseCurrency || 0) > 0);
            renderSimpleList(
                '#daybook-discounts-given',
                discountedInvoices,
                inv => `<span>Invoice <span class="font-mono text-xs">${inv.id.slice(-6)}</span> (${inv.customerName})</span>
                        <span class="font-mono text-yellow-400">${currencyUtils.format(inv.discountInBaseCurrency)}</span>`,
                'No discounts given.'
            );
        }
    };

    // --- Helper Functions ---
    const renderKpiCard = (title, value, colorClass, prefix = '') => `
        <div class="glass-pane p-4 rounded-lg">
            <p class="text-sm text-text-secondary">${title}</p>
            <p class="text-2xl font-bold font-mono ${colorClass}">${prefix}${value}</p>
        </div>
    `;

    const renderSimpleList = (selector, items, renderFn, emptyMsg) => {
        const container = modal.querySelector(selector);
        if(!container) return; // Add guard clause
        if (items.length > 0) {
            container.innerHTML = items.map(item => `<div class="daybook-item">${renderFn(item)}</div>`).join('');
        } else {
            container.innerHTML = `<p class="text-center text-text-secondary py-4">${emptyMsg}</p>`;
        }
    };

    const renderGroupedList = (selector, items, groupKey, sumKey, colorClass, emptyMsg) => {
        const container = modal.querySelector(selector);
        if(!container) return; // Add guard clause
        const grouped = items.reduce((acc, item) => {
            const key = item[groupKey] || 'Uncategorized';
            acc[key] = (acc[key] || 0) + item[sumKey];
            return acc;
        }, {});

        const entries = Object.entries(grouped);
        if (entries.length > 0) {
            container.innerHTML = entries
                .sort((a, b) => b[1] - a[1]) // Sort descending by amount
                .map(([key, amount]) => `
                    <div class="daybook-item">
                        <span>${key}</span>
                        <span class="font-mono ${colorClass}">${currencyUtils.format(amount)}</span>
                    </div>
                `).join('');
        } else {
            container.innerHTML = `<p class="text-center text-text-secondary py-4">${emptyMsg}</p>`;
        }
    };


    // --- Initial Render & Event Listeners ---
    // Pass userRole and userId to the render function
    await renderDaybookContent(modal, selectedDate, userRole, userId);

    modal.querySelector('#daybook-date-picker').addEventListener('change', (e) => {
        // Correctly parse the date input value to avoid timezone issues
        const [year, month, day] = e.target.value.split('-').map(Number);
        // Use UTC to prevent timezone shifts when creating the date object for rendering
        const newDate = new Date(Date.UTC(year, month - 1, day));
        modal.querySelector('h3').textContent = `Daybook for ${newDate.toLocaleDateString()} ${userRole === 'cashier' ? `(Your Activity)` : ''}`;
        // Pass userRole and userId when re-rendering
        renderDaybookContent(modal, newDate, userRole, userId);
    });

    modal.querySelector('#print-daybook').addEventListener('click', () => {
        printElement('daybook-content');
    });
}





const printElement = (elementId) => {
    const elementToPrint = document.getElementById(elementId);
    if (!elementToPrint) {
        console.error(`Element with ID '${elementId}' not found for printing.`);
        showToast('Could not find content to print.', 'error');
        return;
    }

    const printContainer = document.createElement('div');
    printContainer.id = 'print-container';
    
    const contentClone = elementToPrint.cloneNode(true);
    contentClone.id = 'printable-content';

    const printStyles = document.createElement('style');
    printStyles.innerHTML = `
        @media print {
            @page {
                size: A4;
                margin: 15mm; /* Standard margin for a professional look */
            }

            body {
                background-color: #fff !important;
            }

            /* Hide everything except the print container */
            body > *:not(#print-container) {
                display: none !important;
            }

            #print-container {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
            }

            #printable-content {
                display: block !important;
                background: white !important;
                color: black !important;
                font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
                font-size: 10pt;
                line-height: 1.4;
                border: none !important;
                box-shadow: none !important;
                width: 100%;
                margin: 0 auto;
                page-break-inside: avoid;
            }

            /* Ensure all text is black and backgrounds are transparent */
            #printable-content *, #printable-content *:before, #printable-content *:after {
                color: black !important;
                background-color: transparent !important;
                text-shadow: none !important;
                box-shadow: none !important;
            }
            
            /* Remove elements that shouldn't be printed */
            #printable-content button, #printable-content .no-print, #printable-content canvas, #printable-content iframe {
                display: none !important;
            }

            #printable-content a {
                text-decoration: none;
            }

            /* Improve table styling for clarity */
            #printable-content table {
                width: 100%;
                border-collapse: collapse;
            }
            #printable-content th, #printable-content td {
                padding: 6px 2px;
                border-bottom: 1px solid #ccc;
            }
            #printable-content th {
                font-weight: 600;
                text-align: left;
            }
            #printable-content thead tr {
                 border-bottom: 2px solid #333;
            }
             #printable-content tbody tr:last-child td {
                border-bottom: none;
            }

            /* Make sure logo is appropriately sized and monochrome */
            #printable-content img {
                max-width: 120px !important;
                filter: grayscale(100%);
            }
        }
    `;
    
    document.head.appendChild(printStyles);
    printContainer.appendChild(contentClone);
    document.body.appendChild(printContainer);

    window.print();

    // Cleanup after printing
    document.body.removeChild(printContainer);
    document.head.removeChild(printStyles);
};
const playNotificationSound = () => {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    if (!audioContext) return; // Web Audio API not supported

    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);

    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
    gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01); // Quick fade in

    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // A nice "ping" frequency
    
    oscillator.start(audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.15); // Quick fade out
    oscillator.stop(audioContext.currentTime + 0.15);
};

const showToast = (message, type = 'success') => {
    const toastsContainer = document.getElementById('toasts-container');
    if (!toastsContainer) {
        console.error("Toasts container not found in the DOM.");
        return;
    }
    const toastStyles = {
        success: { bg: 'bg-green-500/10 border-green-500/50', icon: 'check-circle', iconColor: 'text-green-400' },
        error: { bg: 'bg-red-500/10 border-red-500/50', icon: 'alert-circle', iconColor: 'text-red-400' },
        info: { bg: 'bg-blue-500/10 border-blue-500/50', icon: 'info', iconColor: 'text-blue-400' },
        warning: { bg: 'bg-yellow-500/10 border-yellow-500/50', icon: 'alert-triangle', iconColor: 'text-yellow-400' },
        stock: { bg: 'bg-yellow-500/10 border-yellow-500/50', icon: 'package-search', iconColor: 'text-yellow-400' },
        sale: { bg: 'bg-green-500/10 border-green-500/50', icon: 'receipt-text', iconColor: 'text-green-400' }
    };
    let style = toastStyles[type];
    if (!style) {
        console.warn(`[Toast] Unknown toast type: "${type}". Defaulting to 'info'.`);
        style = toastStyles.info;
    }
    const toast = document.createElement('div');
    toast.className = `toast glass-pane flex items-center gap-4 text-text-primary text-sm font-medium px-4 py-3 rounded-xl shadow-lg ${style.bg}`;
    toast.innerHTML = `<i data-lucide="${style.icon}" class="w-6 h-6 ${style.iconColor}"></i><p class="flex-1">${message}</p>`;
    toastsContainer.prepend(toast);
    lucide.createIcons();
    setTimeout(() => toast.remove(), 5000);
};

const showModal = (title, content, footer, options = {}) => {
    const modalsContainer = document.getElementById('modals-container');
    if (!modalsContainer) {
        console.error("Modals container not found in the DOM.");
        return null; // Return null to prevent further errors
    }
    const { size = 'max-w-lg', customClasses = '' } = options;
    const modalId = `modal-${Date.now()}`;
    const modalHTML = `
        <div id="${modalId}" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4 opacity-0">
            <div class="modal-content glass-pane rounded-xl shadow-2xl w-full ${size} ${customClasses} scale-95 transform">
                <div class="flex justify-between items-center p-5 border-b border-border-color">
                    <h3 class="text-xl font-semibold text-text-primary">${title}</h3>
                    <button data-action="close-modal" class="p-1 rounded-full text-text-secondary hover:bg-bg-tertiary hover:text-white">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="p-6 text-text-secondary max-h-[78vh] overflow-y-auto">${content}</div>
                ${footer ? `<div class="flex justify-end items-center p-4 bg-[var(--bg-secondary)]/50 rounded-b-xl space-x-3">${footer}</div>` : ''}
            </div>
        </div>`;
    modalsContainer.insertAdjacentHTML('beforeend', modalHTML);
    lucide.createIcons();
    const modalEl = document.getElementById(modalId);
    setTimeout(() => {
        modalEl.classList.remove('opacity-0');
        modalEl.querySelector('.modal-content').classList.remove('scale-95');
    }, 10);
    return modalEl;
};

const closeModal = (modalEl) => {
    if (!modalEl) return;
    modalEl.classList.add('opacity-0');
    modalEl.querySelector('.modal-content').classList.add('scale-95');
    setTimeout(() => modalEl.remove(), 300);
};
// --- NEW FUNCTION: Show Limit Reached Modal ---
function showLimitReachedModal(limitType, limit) {
    const user = auth.currentUser;
    if (!user) return; // Should not happen if they are trying to add stuff

    const typeText = limitType === 'products' ? 'Product' : 'Staff';
    const term = getCurrentProfile().terminology;
    const typeTerm = limitType === 'products' ? term.product : 'Staff Member';

    const content = `
        <div class="text-center">
            <i data-lucide="bar-chart-big" class="w-16 h-16 text-accent mx-auto mb-6"></i>
            <h2 class="text-2xl font-bold text-white mb-2">You've Reached Your ${typeText} Limit</h2>
            <p class="text-text-secondary mb-6">
                Your current plan allows for a maximum of <strong>${limit} ${typeTerm}(s)</strong>.
                To add more, please upgrade your subscription.
            </p>
        </div>
    `;
    const footer = `
        <button data-action="close-modal" class="btn btn-secondary">OK</button>
        <a href="./renew-subscription.html?uid=${user.uid}&email=${user.email}" target="_blank" class="btn btn-primary">
            <i data-lucide="zap" class="w-4 h-4 mr-2"></i> View Plans & Upgrade
        </a>
    `;
    const modal = showModal('Plan Limit Reached', content, footer);
    lucide.createIcons();
}
const formatAndTruncate = (label, valueToFormat, isCurrency = true) => {
    const fullValue = isCurrency 
        ? currencyUtils.format(valueToFormat, appState.currentCurrency, { minimumFractionDigits: 2, maximumFractionDigits: 2 })
        : valueToFormat.toLocaleString();

    // If a formatted number is too long, truncate it and make it clickable to show the full value.
    if (fullValue.length > 10) { 
        const truncatedValue = fullValue.substring(0, 7) + '...';
        return `<span class="cursor-pointer hover:underline" data-action="show-full-stat" data-full-value="${fullValue}" data-label="${label}">${truncatedValue}</span>`;
    }
    return fullValue;
};

const commonChartOptions = (isCurrency = true, customOptions = {}) => {
    // Start with the base options
    const options = {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
            duration: 1200,
            easing: 'easeInOutSine',
            delay: (context) => {
                let delay = 0;
                if (context.type === 'data' && context.mode === 'default') {
                    delay = context.dataIndex * 40 + context.datasetIndex * 80;
                }
                return delay;
            },
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: { color: 'rgba(255,255,255,0.06)', drawBorder: false, border: { dash: [3, 6] } },
                ticks: {
                    color: '#9ca3af',
                    font: {
                        fontFamily: chartStyles.fontFamily
                    },
                    callback: isCurrency ? (value) => currencyUtils.format(value, appState.currentCurrency, { notation: 'compact' }) : (value) => value.toLocaleString()
                }
            },
            x: {
                grid: { display: false },
                ticks: {
                    color: '#9ca3af',
                    font: {
                        fontFamily: chartStyles.fontFamily
                    }
                }
            }
        },
        plugins: {
            chartGlow: { color: 'rgba(0,0,0,0.15)', blur: 20, offsetY: 8 },
            legend: {
                labels: {
                    color: '#9ca3af',
                    usePointStyle: true,
                    pointStyle: 'rectRounded',
                    padding: 20,
                    font: {
                        fontFamily: chartStyles.fontFamily,
                        size: 13
                    }
                }
            },
            tooltip: {
                enabled: true,
                backgroundColor: 'rgba(10, 10, 15, 0.8)',
                backdropFilter: 'blur(5px)',
                titleColor: '#fff',
                bodyColor: '#cbd5e1',
                borderColor: 'rgba(255, 255, 255, 0.1)',
                borderWidth: 1,
                padding: 12,
                titleFont: { family: chartStyles.fontFamily, weight: 'bold', size: 14 },
                bodyFont: { family: chartStyles.fontFamily, size: 12 },
                displayColors: true,
                callbacks: {
                    label: (context) => isCurrency ? currencyUtils.format(context.raw, appState.currentCurrency, { notation: 'standard' }) : context.raw.toLocaleString()
                }
            }
        }
    };

    // Manually merge nested objects and spread the rest
    const { plugins, scales, ...rest } = customOptions;
    if (plugins) {
        options.plugins = { ...options.plugins, ...plugins };
    }
    if (scales) {
        options.scales.x = { ...options.scales.x, ...(scales.x || {}) };
        options.scales.y = { ...options.scales.y, ...(scales.y || {}) };
    }

    return { ...options, ...rest };
};

const renderPaginationControls = (container, totalItems, currentPage, itemsPerPage, viewType) => {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    if (totalPages <= 1) {
        container.innerHTML = '';
        return;
    }

    const startItem = (currentPage - 1) * itemsPerPage + 1;
    const endItem = Math.min(startItem + itemsPerPage - 1, totalItems);

    let paginationHTML = `<div class="flex items-center justify-between text-sm text-text-secondary">`;
    paginationHTML += `<div>Showing <span class="font-medium text-text-primary">${startItem}</span> to <span class="font-medium text-text-primary">${endItem}</span> of <span class="font-medium text-text-primary">${totalItems}</span> results</div>`;
    paginationHTML += `<div class="flex items-center gap-2">`;
    paginationHTML += `<button data-action="paginate" data-view-type="${viewType}" data-page="${currentPage - 1}" class="pagination-arrow-btn" ${currentPage === 1 ? 'disabled' : ''}><i data-lucide="chevron-left" class="w-5 h-5 pointer-events-none"></i></button>`;
    
    // Simplified pagination links (e.g., 1 ... 4 5 6 ... 10)
    const pagesToShow = [];
    if (totalPages <= 7) {
        for (let i = 1; i <= totalPages; i++) pagesToShow.push(i);
    } else {
        pagesToShow.push(1);
        if (currentPage > 3) pagesToShow.push('...');
        if (currentPage > 2) pagesToShow.push(currentPage - 1);
        if (currentPage > 1 && currentPage < totalPages) pagesToShow.push(currentPage);
        if (currentPage < totalPages - 1) pagesToShow.push(currentPage + 1);
        if (currentPage < totalPages - 2) pagesToShow.push('...');
        pagesToShow.push(totalPages);
    }
    
    const uniquePages = [...new Set(pagesToShow)];

    uniquePages.forEach(p => {
        if (p === '...') {
            paginationHTML += `<span class="pagination-ellipsis">...</span>`;
        } else {
            paginationHTML += `<button data-action="paginate" data-view-type="${viewType}" data-page="${p}" class="pagination-page-btn ${p === currentPage ? 'active' : ''}">${p}</button>`;
        }
    });

    paginationHTML += `<button data-action="paginate" data-view-type="${viewType}" data-page="${currentPage + 1}" class="pagination-arrow-btn" ${currentPage === totalPages ? 'disabled' : ''}><i data-lucide="chevron-right" class="w-5 h-5 pointer-events-none"></i></button>`;
    paginationHTML += `</div></div>`;
    container.innerHTML = paginationHTML;
    lucide.createIcons();
};
// --- NEW CODE START: CSV IMPORT/EXPORT ---

/**
 * Parses a CSV text string into an array of objects.
 * @param {string} csvText The raw CSV text content.
 * @returns {Array<Object>} An array of objects.
 */
function parseCSV(csvText) {
    const lines = csvText.replace(/\r/g, '').split('\n');
    const result = [];
    if (lines.length === 0) return result;
    
    // Use the first line as headers, trimming whitespace
    const headers = lines[0].split(',').map(h => h.trim());
    
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue; // Skip empty lines
        
        const obj = {};
        // This is a simple parser. A robust one would handle quotes.
        // For this utility, we'll assume no commas within fields.
        const values = line.split(',');
        
        headers.forEach((header, index) => {
            if (values[index]) {
                obj[header.trim()] = values[index].trim();
            }
        });
        
        if (Object.keys(obj).length > 0) {
            result.push(obj);
        }
    }
    return result;
}

/**
 * Handles the logic for importing product data from a CSV.
 * @param {Array<Object>} data The parsed CSV data.
 */
async function handleProductImport(data) {
    if (!data || data.length === 0) {
        showToast('No data found in the file to import.', 'error');
        return;
    }

    // Check permissions
    if (!checkPermission('canAddProducts')) {
        showToast('You do not have permission to import products.', 'error');
        return;
    }
    // --- NEW LIMIT CHECK ---
    const currentProductCount = firestoreData.products.filter(p => !p.parentSKU).length;
    const productLimit = firestoreData.storeInfo.planLimits?.products || 1000;
    const newProductsToImport = data.length; // Assuming 1 row = 1 new parent product

    if (currentProductCount + newProductsToImport > productLimit) {
        const remaining = Math.max(0, productLimit - currentProductCount);
        const message = remaining > 0
            ? `This import of ${newProductsToImport} products would exceed your ${productLimit} product limit. You can import up to ${remaining} more products.`
            : `You have already reached your ${productLimit} product limit and cannot import more.`;
        
        showToast(message, 'error');
        showLimitReachedModal('products', productLimit);
        return; // Stop the import
    }
    // --- END NEW LIMIT CHECK ---
    showToast(`Importing ${data.length} products... This may take a moment.`, 'info');
    
    try {
        const batch = writeBatch(db);
        let successCount = 0;
        let errorCount = 0;
        
        for (const row of data) {
            try {
                const newProductId = row.sku || `SKU${Date.now().toString().slice(-6) + successCount}`;
                const docRef = doc(productsRef, newProductId);

                const priceInDisplay = parseFloat(row.price);
                const costPriceInDisplay = parseFloat(row.costPrice);

                const newProduct = {
                    id: newProductId,
                    name: row.name || 'Unnamed Product',
                    category: row.category || 'Default Category',
                    barcode: row.barcode || null,
                    productType: row.productType === 'service' ? 'service' : 'physical',
                    hasVariants: false,
                    isSerialized: false,
                    stock: row.productType === 'service' ? 0 : (parseInt(row.stock) || 0),
                    price: !isNaN(priceInDisplay) ? currencyUtils.convertToBase(priceInDisplay) : 0,
                    costPrice: !isNaN(costPriceInDisplay) ? currencyUtils.convertToBase(costPriceInDisplay) : 0,
                    taxable: row.taxable ? row.taxable.toLowerCase() === 'true' : true,
                    status: 'active',
                    createdAt: new Date().toISOString()
                };
                
                batch.set(docRef, newProduct);
                successCount++;
            } catch (rowError) {
                console.warn("Skipping invalid row:", row, rowError);
                errorCount++;
            }
        }
        
        await batch.commit();
        showToast(`Import complete! ${successCount} products added. ${errorCount} rows failed.`, 'success');
    } catch (error) {
        console.error("Error during product import batch commit:", error);
        showToast(`Import failed: ${error.message}`, 'error');
    }
}

/**
 * Handles the logic for importing customer data from a CSV.
 * @param {Array<Object>} data The parsed CSV data.
 */
async function handleCustomerImport(data) {
    if (!data || data.length === 0) {
        showToast('No data found in the file to import.', 'error');
        return;
    }

    if (!checkPermission('canManageCustomers')) {
        showToast('You do not have permission to import customers.', 'error');
        return;
    }
    
    showToast(`Importing ${data.length} customers...`, 'info');

    try {
        const batch = writeBatch(db);
        let successCount = 0;
        let errorCount = 0;

        for (const row of data) {
            try {
                if (!row.name || !row.phone) {
                    errorCount++;
                    continue; // Skip rows without a name or phone
                }
                
                const docRef = doc(customersRef);
                
                const creditLimitInDisplay = parseFloat(row.creditLimit);
                const currentDueInDisplay = parseFloat(row.currentDue);

                const newCustomer = {
                    id: docRef.id,
                    name: row.name,
                    phone: row.phone,
                    email: row.email || '',
                    address: row.address || '',
                    loyaltyId: row.loyaltyId || null,
                    loyaltyPoints: parseInt(row.loyaltyPoints) || 0,
                    creditLimit: !isNaN(creditLimitInDisplay) ? currencyUtils.convertToBase(creditLimitInDisplay) : null,
                    currentDue: !isNaN(currentDueInDisplay) ? currencyUtils.convertToBase(currentDueInDisplay) : 0,
                    joinDate: new Date().toISOString()
                };
                
                batch.set(docRef, newCustomer);
                successCount++;
            } catch (rowError) {
                console.warn("Skipping invalid row:", row, rowError);
                errorCount++;
            }
        }
        
        await batch.commit();
        showToast(`Import complete! ${successCount} customers added. ${errorCount} rows failed.`, 'success');
    } catch (error) {
        console.error("Error during customer import batch commit:", error);
        showToast(`Import failed: ${error.message}`, 'error');
    }
}

/**
 * Opens the CSV import modal for either products or customers.
 * @param {('products'|'customers')} importType The type of data to import.
 */
function openImportModal(importType) {
    const term = getCurrentProfile().terminology;
    const title = importType === 'products' ? `Import ${term.product}s` : 'Import Customers';
    const templateName = importType === 'products' ? 'products_template.csv' : 'customers_template.csv';

    let templateHeaders = '';
    if (importType === 'products') {
        templateHeaders = 'name,sku,category,barcode,price,costPrice,stock,productType,taxable';
    } else {
        templateHeaders = 'name,phone,email,address,loyaltyId,loyaltyPoints,creditLimit,currentDue';
    }
    const templateContent = encodeURIComponent(templateHeaders);

    const content = `
        <div class="space-y-4">
            <p class="text-sm text-text-secondary">Upload a CSV file to bulk-import your data. Please ensure your file matches the template format.</p>
            <a href="data:text/csv;charset=utf-8,${templateContent}" download="${templateName}" class="btn btn-secondary w-full">
                <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                Download ${templateName}
            </a>
            <div class_name="mt-4">
                <label class="block text-sm font-medium text-text-secondary mb-1">Upload your CSV file</label>
                <input type="file" id="csv-file-input" accept=".csv" class="form-input w-full file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-accent/10 file:text-accent hover:file:bg-accent/20">
            </div>
            <p id="csv-status" class="text-sm text-text-secondary h-4"></p>
        </div>
    `;
    const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-import-btn" class="btn btn-primary" disabled>Start Import</button>`;
    const modal = showModal(title, content, footer);
    lucide.createIcons();

    const fileInput = modal.querySelector('#csv-file-input');
    const confirmBtn = modal.querySelector('#confirm-import-btn');
    const statusEl = modal.querySelector('#csv-status');
    let parsedData = null;

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) {
            confirmBtn.disabled = true;
            statusEl.textContent = '';
            return;
        }

        statusEl.textContent = `Reading ${file.name}...`;
        const reader = new FileReader();
        
        reader.onload = (event) => {
            try {
                parsedData = parseCSV(event.target.result);
                if (parsedData.length > 0) {
                    statusEl.textContent = `Found ${parsedData.length} rows. Ready to import.`;
                    confirmBtn.disabled = false;
                } else {
                    statusEl.textContent = 'File is empty or in an invalid format.';
                    confirmBtn.disabled = true;
                }
            } catch (error) {
                statusEl.textContent = `Error reading file: ${error.message}`;
                confirmBtn.disabled = true;
            }
        };

        reader.onerror = () => {
            statusEl.textContent = 'Could not read the file.';
            confirmBtn.disabled = true;
        };

        reader.readAsText(file);
    });

    confirmBtn.addEventListener('click', () => {
        if (parsedData) {
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<div class="loader-sm"></div> Importing...';
            
            // Use a timeout to allow the modal to update before the heavy lifting
            setTimeout(async () => {
                if (importType === 'products') {
                    await handleProductImport(parsedData);
                } else {
                    await handleCustomerImport(parsedData);
                }
                closeModal(modal);
            }, 100);
        }
    });
}

/**
 * Converts an array of objects to a CSV string and triggers a download.
 * @param {Object} headers An object mapping object keys to CSV header names.
 * @param {Array<Object>} data The data to export.
 * @param {string} filename The desired filename for the download.
 */
function exportToCSV(headers, data, filename) {
    const headerKeys = Object.keys(headers);
    const headerRow = headerKeys.map(key => headers[key]).join(',');
    
    const dataRows = data.map(row => {
        return headerKeys.map(key => {
            let value = row[key] === null || row[key] === undefined ? '' : row[key];
            // Simple CSV escaping for quotes
            value = String(value).replace(/"/g, '""');
            // If value contains a comma, newline, or quote, wrap it in quotes
            if (/[",\n]/.test(value)) {
                value = `"${value}"`;
            }
            return value;
        }).join(',');
    });

    const csvContent = [headerRow, ...dataRows].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

/**
 * Gathers product data and triggers a CSV export.
 */
function handleProductExport() {
    showToast('Preparing product export...', 'info');
    
    const headers = {
        id: 'sku',
        name: 'name',
        category: 'category',
        barcode: 'barcode',
        price: 'price',
        costPrice: 'costPrice',
        stock: 'stock',
        productType: 'productType',
        taxable: 'taxable'
    };
    
    const dataToExport = firestoreData.products
        .filter(p => !p.parentSKU) // Only export parent products
        .map(p => {
            // Convert currency back to display currency for the export
            const priceInDisplay = p.price ? currencyUtils.convert(p.price).toFixed(2) : 0;
            const costPriceInDisplay = p.costPrice ? currencyUtils.convert(p.costPrice).toFixed(2) : 0;

            return {
                id: p.id,
                name: p.name,
                category: p.category || '',
                barcode: p.barcode || '',
                price: priceInDisplay,
                costPrice: checkPermission('canViewProfitAndLoss') ? costPriceInDisplay : '',
                stock: p.stock || 0,
                productType: p.productType,
                taxable: p.taxable !== false
            };
        });

    exportToCSV(headers, dataToExport, 'products_export.csv');
}

/**
 * Gathers customer data and triggers a CSV export.
 */
function handleCustomerExport() {
    showToast('Preparing customer export...', 'info');

    const headers = {
        id: 'customerId',
        name: 'name',
        phone: 'phone',
        email: 'email',
        address: 'address',
        loyaltyId: 'loyaltyId',
        loyaltyPoints: 'loyaltyPoints',
        creditLimit: 'creditLimit',
        currentDue: 'currentDue',
        joinDate: 'joinDate'
    };
    
    const dataToExport = firestoreData.customers.map(c => {
        // Convert currency back to display currency
        const creditLimitInDisplay = c.creditLimit ? currencyUtils.convert(c.creditLimit).toFixed(2) : '';
        const currentDueInDisplay = c.currentDue ? currencyUtils.convert(c.currentDue).toFixed(2) : 0;

        return {
            id: c.id,
            name: c.name,
            phone: c.phone,
            email: c.email || '',
            address: c.address || '',
            loyaltyId: c.loyaltyId || '',
            loyaltyPoints: c.loyaltyPoints || 0,
            creditLimit: creditLimitInDisplay,
            currentDue: currentDueInDisplay,
            joinDate: c.joinDate
        };
    });
    
    exportToCSV(headers, dataToExport, 'customers_export.csv');
}

        document.addEventListener('DOMContentLoaded', () => {
            // --- NEW: STORE SWITCHER LOGIC ---
            const renderStoreSwitcher = () => {
                const store = appState.session.availableStores.find(s => s.id === appState.session.storeId);
                if (!store) return; // Don't render if the active store isn't in the list

                const switcherContainer = document.getElementById('store-switcher-container');
                if (!switcherContainer) {
                    console.error("Store switcher container not found in DOM.");
                    return;
                }
                
                const storeLimit = appState.session.userProfileData?.storeLimit || 1;
                const storeCount = appState.session.availableStores.length;
                const limitReached = storeCount >= storeLimit;

                switcherContainer.innerHTML = `
                    <button data-action="toggle-store-menu" class="flex items-center gap-3 px-3 py-2 rounded-lg bg-bg-secondary hover:bg-bg-tertiary transition-colors border border-border-color">
                        <i data-lucide="store" class="w-5 h-5 text-accent"></i>
                        <span class="font-semibold text-text-primary">${store.name}</span>
                        <i data-lucide="chevrons-up-down" class="w-4 h-4 text-text-secondary"></i>
                    </button>
                    <div id="store-menu" class="action-menu !w-56">
                        ${appState.session.availableStores.map(s => {
                            const isEnabled = s.isEnabled !== false; // Default to true if undefined
                            const isDisabled = !isEnabled;
                            
                            const classes = `action-menu-item ${isDisabled ? 'opacity-50 cursor-not-allowed text-text-secondary' : ''}`;
                            const actionAttr = isDisabled ? '' : `data-action="switch-store"`;
                            const titleAttr = isDisabled ? `title="This store is currently disabled"` : '';
                            const icon = isDisabled ? 'shield-off' : 'store';
                            const iconColor = isDisabled ? 'text-red-500/70' : '';

                            return `
                            <div class="${classes}" ${actionAttr} data-id="${s.id}" ${titleAttr}>
                                <i data-lucide="${icon}" class="w-4 h-4 ${iconColor}"></i>
                                <span>${s.name}</span>
                                ${s.id === appState.session.storeId ? '<i data-lucide="check" class="w-4 h-4 text-accent ml-auto"></i>' : ''}
                            </div>
                            `;
                        }).join('')}
                        ${appState.session.userRole === 'admin' ? `
                        <div class="h-px bg-border-color my-1"></div>
                        <div class="action-menu-item ${limitReached ? 'opacity-50 cursor-not-allowed' : ''}" 
                             data-action="add-new-store" 
                             ${limitReached ? `title="You have reached your store limit of ${storeLimit} store(s). Contact support to upgrade."` : ''}>
                            <i data-lucide="plus-circle" class="w-4 h-4"></i>
                            <span>Add New Store</span>
                        </div>
                        ` : ''}
                    </div>
                `;
                lucide.createIcons();
            };

            // --- NEW: Permission Change Handler ---
            const viewPermissionMap = {
                'dashboard': 'canAccessDashboard',
                'pos': 'canUsePOS',
                'inventory': ['canViewInventory', 'canAddProducts', 'canEditProducts', 'canDeactivateProducts'], // MODIFIED
                'customers': 'canManageCustomers',
                'invoices': 'canManageInvoices',
                'reports': 'canAccessReports',
                'settings': 'canManageSettings',
                'staff': ['canManageStaff', 'canInviteCashiers', 'canViewStaffPerformance', 'canEditCashierDetails'],
                'user-roles': 'canManageRoles', // NEW
                'expenses': 'canManageExpenses', // NEW
                'purchase-orders': 'canViewPurchaseOrders', // NEW
                'suppliers': 'canManageSuppliers', // NEW
                'barcode-generator': 'canGenerateBarcodes', // NEW
                'attributes': 'canEditProducts', // NEW
                'claims': 'canManageWarranties', // NEW
                'quotations': 'canManageQuotations', // NEW
                'subscription': 'canManageSubscription',
                'loyalty': 'canManageLoyalty',
                'expense': 'canManageExpenses',
                'pnl': 'canViewProfitAndLoss',
                'emi-sales': 'canManageEMI',
            };

            const handlePermissionChange = () => {
                let activeTabRemoved = false;
                const originalTabCount = appState.tabs.length;

                appState.tabs = appState.tabs.filter(tab => {
                    const requiredPermission = viewPermissionMap[tab.viewType];
                    if (!requiredPermission) return true;

                    let hasPermission = false;
                    if (Array.isArray(requiredPermission)) {
                        hasPermission = requiredPermission.some(p => checkPermission(p));
                    } else {
                        hasPermission = checkPermission(requiredPermission);
                    }

                    // Special case for cashiers who have a dedicated, limited settings view.
                    if (tab.viewType === 'settings' && appState.session.userRole === 'cashier') {
                        hasPermission = true;
                    }

                    if (!hasPermission) {
                        if (tab.id === appState.activeTabId) {
                            activeTabRemoved = true;
                        }
                        showToast(`Your access to the ${tab.name} tab has been revoked.`, 'warning');
                        return false; // Remove this tab
                    }
                    return true; // Keep this tab
                });

                // If the active tab was one of the ones removed...
                if (activeTabRemoved) {
                    // Switch to the first available tab, or the dashboard if possible.
                    if (appState.tabs.length > 0) {
                        appState.activeTabId = appState.tabs[0].id;
                    } else {
                        appState.activeTabId = null;
                        // If no tabs are left, try to open the dashboard.
                        if (checkPermission('canAccessDashboard')) {
                            // Use a timeout to avoid being in the middle of a render cycle
                            setTimeout(() => openOrSwitchTab('dashboard'), 0);
                        }
                    }
                }
                
                // Only trigger a re-render if the number of tabs has changed.
                if (originalTabCount !== appState.tabs.length) {
                    renderApp();
                    return true; // Return true to indicate a render happened
                }
                return false; // Return false if no render happened
            };
            
            // --- NEW: FULLSCREEN LOGIC ---
            const toggleFullScreen = () => {
                const doc = window.document;
                const docEl = doc.documentElement;

                const requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullscreen || docEl.msRequestFullscreen;
                const cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

                const isFullscreen = doc.fullscreenElement || doc.mozFullScreenElement || doc.webkitFullscreenElement || doc.msFullscreenElement;

                if (!isFullscreen) {
                    if (requestFullScreen) {
                        requestFullScreen.call(docEl);
                    }
                } else {
                    if (cancelFullScreen) {
                        cancelFullScreen.call(doc);
                    }
                }
            };

            const updateFullscreenIcon = () => {
                const fullscreenBtn = document.getElementById('fullscreen-btn');
                if (!fullscreenBtn) return;
                const isFullscreen = document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement;
                
                if (isFullscreen) {
                    fullscreenBtn.innerHTML = `<i data-lucide="minimize" class="w-5 h-5"></i>`;
                    fullscreenBtn.setAttribute('title', 'Exit Fullscreen');
                } else {
                    fullscreenBtn.innerHTML = `<i data-lucide="maximize" class="w-5 h-5"></i>`;
                    fullscreenBtn.setAttribute('title', 'Enter Fullscreen');
                }
                lucide.createIcons();
            };

            document.addEventListener('fullscreenchange', updateFullscreenIcon);
            document.addEventListener('webkitfullscreenchange', updateFullscreenIcon);
            document.addEventListener('mozfullscreenchange', updateFullscreenIcon);
            document.addEventListener('MSFullscreenChange', updateFullscreenIcon);
            // --- END FULLSCREEN LOGIC ---

            const jsBarcodeScript = document.createElement('script');
            jsBarcodeScript.src = 'https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js';
            document.head.appendChild(jsBarcodeScript);
            const jspdfScript = document.createElement('script');
            jspdfScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
            document.head.appendChild(jspdfScript);

            const html2canvasScript = document.createElement('script');
            html2canvasScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            document.head.appendChild(html2canvasScript);
            lucide.createIcons();

            document.head.insertAdjacentHTML('beforeend', `
                <style>
                    .scrollbar-hide::-webkit-scrollbar { display: none; }
                    .scrollbar-hide { -ms-overflow-style: none;  scrollbar-width: none; }
                    /* --- NEW: Hide number input spinners for a cleaner look --- */
                    input[type=number]::-webkit-outer-spin-button,
                    input[type=number]::-webkit-inner-spin-button {
                        -webkit-appearance: none;
                        margin: 0;
                    }
                    input[type=number] {
                        -moz-appearance: textfield;
                    }
                    /* --- END NEW --- */
                    .glass-pane-modal .modal-content {
                        background: rgba(18, 18, 18, 0.8);
                        backdrop-filter: blur(20px);
                        -webkit-backdrop-filter: blur(20px);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                    }
                    /* NEW: Notification Bell Animation */
                    .has-unread-notifications .lucide-bell {
                        animation: ring-bell 1.5s ease-in-out infinite;
                        transform-origin: top center;
                    }
                    @keyframes ring-bell {
                        0%, 100% { transform: rotate(0); }
                        10%, 30%, 50%, 70%, 90% { transform: rotate(-10deg); }
                        20%, 40%, 60%, 80% { transform: rotate(10deg); }
                    }
                    /* NEW STYLES FOR MODERN POS */
                    .category-group-header {
                        width: 100%; display: flex; justify-content: space-between; align-items: center;
                        padding: 8px 4px; font-size: 11px; text-transform: uppercase;
                        color: var(--text-secondary); font-weight: 600; letter-spacing: 0.05em;
                        cursor: pointer;
                    }
                    .category-group-header:hover { color: var(--text-primary); }
                    .category-group-icon {
                        width: 16px; height: 16px; transition: transform 0.2s ease-in-out;
                    }
                    .category-group:not(.is-open) .category-group-icon {
                        transform: rotate(-180deg);
                    }
                    .category-group-list {
                        display: grid;
                        grid-template-rows: 0fr;
                        transition: grid-template-rows 0.3s ease-in-out;
                    }
                    .category-group.is-open .category-group-list {
                        grid-template-rows: 1fr;
                    }
                    .category-group-list > div {
                        overflow: hidden;
                    }
                    .pos-category-btn {
                        display: flex; align-items: center; text-align: left;
                        width: 100%;
                        padding: 10px 12px;
                        font-size: 14px; font-weight: 500;
                        border-radius: 8px;
                        color: var(--text-secondary);
                        transition: all 0.2s ease;
                        border-left: 3px solid transparent;
                    }
                    .pos-category-btn:hover {
                        background-color: var(--bg-tertiary);
                        color: var(--text-primary);
                    }
                    .pos-category-btn.active {
                        background-color: var(--accent-glow);
                        color: var(--accent);
                        font-weight: 600;
                        border-left-color: var(--accent);
                    }
                     .product-grid-item {
                        background-color: var(--bg-secondary);
                        border-radius: 12px;
                        padding: 12px;
                        text-align: center;
                        border: 1px solid var(--border-color);
                        transition: all 0.2s ease-in-out;
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                    }
                    .product-grid-item:not(:disabled):hover {
                        transform: translateY(-4px);
                        box-shadow: 0 8px 20px -5px rgba(0,0,0,0.3);
                        border-color: var(--border-color-strong);
                    }
                     .product-grid-item:disabled {
                        cursor: not-allowed;
                    }
                     /* Styles for collapsible category panel */
                    #pos-category-panel {
                        transition: width 0.3s ease-in-out, min-width 0.3s ease-in-out, padding 0.3s ease-in-out, opacity 0.3s ease-in-out, border-width 0.3s ease-in-out;
                    }
                    #pos-category-container.category-sidebar-collapsed #pos-category-panel {
                        width: 0 !important;
                        min-width: 0 !important;
                        padding-left: 0;
                        padding-right: 0;
                        border-right-width: 0;
                        opacity: 0;
                        overflow: hidden;
                    }
                    #pos-category-sidebar-toggle {
                        position: absolute;
                        top: 50%;
                        transform: translateY(-50%);
                        z-index: 20;
                        background-color: var(--bg-primary);
                        border: 1px solid var(--border-color);
                        border-left: none;
                        width: 20px;
                        height: 48px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-top-right-radius: 999px;
                        border-bottom-right-radius: 999px;
                        color: var(--text-secondary);
                        transition: left 0.3s ease-in-out, background-color 0.2s;
                    }
                    #pos-category-sidebar-toggle:hover {
                        background-color: var(--accent);
                        color: white;
                    }
                    /* END NEW STYLES */
                    .typing-indicator .dot {
                        width: 8px;
                        height: 8px;
                        background-color: var(--accent);
                        border-radius: 50%;
                        animation: typing-bounce 1.2s infinite ease-in-out;
                    }
                    .typing-indicator .dot:nth-child(2) { animation-delay: -0.2s; }
                    .typing-indicator .dot:nth-child(3) { animation-delay: -0.4s; }
                    @keyframes typing-bounce {
                        0%, 60%, 100% { transform: translateY(0); }
                        30% { transform: translateY(-6px); }
                    }
                    .ai-modal-pane .modal-content {
                        background: rgba(10, 10, 15, 0.6); /* Darker, less transparent */
                        backdrop-filter: blur(30px);
                        -webkit-backdrop-filter: blur(30px);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        box-shadow: 0 20px 40px rgba(0,0,0,0.4);
                    }
                    #ai-chat-history {
                        background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.05) 1px, transparent 0);
                        background-size: 20px 20px;
                    }
                    .prompt-suggestion {
                        padding: 6px 14px;
                        background: rgba(255,255,255,0.05);
                        border: 1px solid rgba(255,255,255,0.1);
                        border-radius: 999px;
                        color: var(--text-secondary);
                        transition: all 0.2s ease;
                        cursor: pointer;
                    }
                    .prompt-suggestion:hover {
                        background: var(--accent);
                        color: white;
                        border-color: var(--accent);
                        transform: translateY(-2px);
                    }
                    /* Super Advanced Pagination Styles */
                    .pagination-arrow-btn {
                        display: flex; align-items: center; justify-content: center;
                        width: 36px; height: 36px;
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        background-color: var(--bg-secondary);
                        color: var(--text-secondary);
                        transition: all 0.2s ease-in-out;
                    }
                    .pagination-arrow-btn:not(:disabled):hover {
                        background-color: var(--bg-tertiary);
                        color: var(--text-primary);
                        border-color: var(--border-color-strong);
                    }
                    .pagination-arrow-btn:disabled {
                        opacity: 0.4;
                        cursor: not-allowed;
                    }
                    .pagination-page-btn {
                        display: flex; align-items: center; justify-content: center;
                        min-width: 36px; height: 36px;
                        padding: 0 8px;
                        border-radius: 8px;
                        font-weight: 500;
                        transition: all 0.2s ease-in-out;
                        border: 1px solid transparent;
                    }
                    .pagination-page-btn:hover:not(.active) {
                        background-color: var(--bg-tertiary);
                        color: var(--text-primary);
                    }
                    .pagination-page-btn.active {
                        background-color: var(--accent);
                        color: white;
                        font-weight: 600;
                        box-shadow: 0 4px 12px -2px var(--accent-glow);
                        border-color: var(--accent);
                    }
                    .pagination-ellipsis {
                        display: flex; align-items: center; justify-content: center;
                        width: 36px; height: 36px;
                        color: var(--text-secondary);
                        letter-spacing: 2px;
                    }
                    /* STYLES FOR HEADER COLLAPSE */
                    #main-header {
                        transition: all 0.3s ease-in-out;
                    }
                    body.header-collapsed #main-header {
                        height: 0px !important;
                        padding-top: 0 !important;
                        padding-bottom: 0 !important;
                        overflow: hidden;
                        border-bottom-width: 0 !important;
                        opacity: 0;
                    }
                    #workspace-content-container {
                        transition: padding-top 0.3s ease-in-out;
                    }
                    body.header-collapsed #workspace-content-container {
                        padding-top: 1.5rem; 
                    }
                    body.header-collapsed #main-tabs-container {
                        border-top: 1px solid var(--border-color);
                    }
                    /* STYLES FOR THE HEADER TOGGLE BUTTON */
                    #header-toggle-btn {
                        position: absolute;
                        left: 50%;
                        z-index: 40;
                        transform: translateX(-50%);
                        transition: top 0.3s ease-in-out, background-color 0.2s, color 0.2s, box-shadow 0.2s, border-color 0.2s;
                        border-radius: 9999px;
                        width: 28px;
                        height: 28px;
                        padding: 0;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        background-color: var(--bg-secondary);
                        border: 1px solid var(--border-color);
                        box-shadow: 0 2px 8px rgba(0,0,0,0.25);
                        color: var(--text-secondary);
                    }
                    #header-toggle-btn:hover {
                        background-color: var(--accent);
                        color: white;
                        border-color: var(--accent);
                        box-shadow: 0 4px 12px var(--accent-glow);
                    }
                    #header-toggle-btn > i {
                        width: 16px;
                        height: 16px;
                    }
                    body:not(.header-collapsed) #header-toggle-btn {
                        /* Position it centered on the header's bottom border */
                        top: 66px; /* header is h-20 (80px), button is 28px high. 80 - (28/2) = 66 */
                    }
                    body.header-collapsed #header-toggle-btn {
                        top: -14px; /* Move up to sit on the new top border, revealing it */
                    }
                    /* --- NEW: Sidebar Collapsed User Profile --- */
                    #sidebar.sidebar-collapsed #user-profile-section .user-profile-details,
                    #sidebar.sidebar-collapsed #user-profile-section [data-lucide="more-vertical"] {
                        display: none;
                    }
                    #sidebar.sidebar-collapsed #user-profile-section > .flex {
                        justify-content: center;
                    }
                    /* --- UPDATED: Barcode Sheet Styling --- */
                    #barcode-sheet-container { background-color: #a0aec0; }
                    #barcode-sheet { background-color: white; }
                    .barcode-label-item {
                        color: black;
                        font-family: Arial, sans-serif;
                        overflow: hidden;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: space-around; /* Better vertical distribution */
                        padding: 8px 4px; /* Increased vertical padding */
                        border: 1px dashed #d1d5db;
                        box-sizing: border-box; /* Ensures padding is respected */
                    }
                    .barcode-shop-name, .barcode-product-name, .barcode-price {
                        width: 100%;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        text-align: center;
                        line-height: 1.2;
                        flex-shrink: 0; /* Prevents vertical squishing */
                    }
                    .barcode-svg {
                        max-width: 100%;
                        height: auto;
                        flex-shrink: 0; /* Prevents the SVG from shrinking */
                    }
                    /* --- END UPDATED --- */
                    /* --- NEW: Advanced Variant Selector Styles --- */
                    .variant-attribute-group + .variant-attribute-group {
                        margin-top: 1rem;
                        padding-top: 1rem;
                        border-top: 1px solid var(--border-color);
                    }
                    .variant-option-btn {
                        padding: 8px 16px;
                        border: 1px solid var(--border-color-strong);
                        border-radius: 8px;
                        background-color: var(--bg-secondary);
                        color: var(--text-secondary);
                        font-weight: 500;
                        transition: all 0.2s ease;
                        cursor: pointer;
                    }
                    .variant-option-btn:not(:disabled):hover {
                        background-color: var(--bg-tertiary);
                        color: var(--text-primary);
                        border-color: var(--accent);
                    }
                    .variant-option-btn.active {
                        background-color: var(--accent);
                        color: white;
                        border-color: var(--accent);
                        box-shadow: 0 4px 12px -2px var(--accent-glow);
                    }
                    .variant-option-btn:disabled {
                        opacity: 0.4;
                        cursor: not-allowed;
                        position: relative;
                        overflow: hidden;
                    }
                     .variant-option-btn:disabled::after {
                        content: '';
                        position: absolute;
                        top: -50%;
                        left: -50%;
                        width: 200%;
                        height: 200%;
                        background-image: repeating-linear-gradient(
                            -45deg,
                            transparent,
                            transparent 4px,
                            rgba(255,255,255,0.05) 4px,
                            rgba(255,255,255,0.05) 5px
                        );
                    }
                    #selected-variant-info {
                        transition: all 0.3s ease;
                        min-height: 100px;
                    }
                    /* --- NEW: Small Loader for Buttons --- */
                    .loader-sm {
                        width: 1rem; height: 1rem;
                        border: 2px solid currentColor;
                        border-right-color: transparent;
                        border-radius: 50%;
                        display: inline-block;
                        animation: spin 0.6s linear infinite;
                        margin-right: 0.5rem;
                    }
                    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
                    /* --- NEW: Advanced Variant Tag Input Styles --- */
                    .variant-attribute-row {
                        transition: all 0.2s ease;
                    }
                    .variant-value-input-wrapper {
                        display: flex;
                        flex-wrap: wrap;
                        align-items: center;
                        gap: 8px;
                        padding: 8px;
                        background-color: var(--bg-primary); /* Darker background for contrast */
                        border: 1px solid var(--border-color-strong);
                        border-radius: 8px;
                        cursor: text; /* Make the whole area feel like an input */
                        transition: border-color 0.2s ease;
                    }
                     .variant-value-input-wrapper:focus-within {
                        border-color: var(--accent);
                        box-shadow: 0 0 0 2px var(--accent-glow);
                    }
                    .variant-value-tag {
                        display: inline-flex;
                        align-items: center;
                        gap: 6px;
                        background-color: var(--accent);
                        color: white;
                        padding: 4px 10px;
                        border-radius: 6px;
                        font-size: 14px;
                        font-weight: 500;
                        animation: pop-in 0.2s ease-out;
                    }
                    .variant-value-tag button {
                        background: none;
                        border: none;
                        color: white;
                        opacity: 0.7;
                        cursor: pointer;
                        padding: 0;
                        line-height: 1;
                        transition: opacity 0.2s ease;
                    }
                    .variant-value-tag button:hover {
                        opacity: 1;
                    }
                    .variant-value-input {
                        flex-grow: 1;
                        border: none;
                        background: transparent;
                        padding: 4px;
                        color: var(--text-primary);
                        min-width: 150px; /* Ensure there's enough space to start typing */
                        font-size: 14px;
                    }
                    .variant-value-input:focus {
                        outline: none;
                        box-shadow: none;
                        ring: 0;
                    }

                    @keyframes pop-in {
                        from {
                            transform: scale(0.8);
                            opacity: 0;
                        }
                        to {
                            transform: scale(1);
                            opacity: 1;
                        }
                    }

                </style>
            `);

            // --- STATE PERSISTENCE ---
            const saveState = () => {
    try {
        const appStateToPersist = {
            tabs: appState.tabs,
            activeTabId: appState.activeTabId,
            isSidebarCollapsed: appState.isSidebarCollapsed,
            isHeaderCollapsed: appState.isHeaderCollapsed,
            viewStates: appState.viewStates,
            productFormDraft: appState.productFormDraft, // ADD THIS LINE
        };
        localStorage.setItem('cashshilpoAppState', JSON.stringify(appStateToPersist));
        localStorage.setItem('cashshilpoPosState', JSON.stringify(posState));
    } catch (e) {
        console.error("Could not save state to localStorage", e);
    }
};

            const loadState = () => {
    try {
        const persistedAppState = JSON.parse(localStorage.getItem('cashshilpoAppState'));
        if (persistedAppState) {
            appState.tabs = persistedAppState.tabs || [];
            appState.activeTabId = persistedAppState.activeTabId || null;
            appState.isSidebarCollapsed = persistedAppState.isSidebarCollapsed || false;
            appState.isHeaderCollapsed = persistedAppState.isHeaderCollapsed || false;
            appState.productFormDraft = persistedAppState.productFormDraft || null; // ADD THIS LINE
            if (persistedAppState.viewStates) {
                // Deep merge to prevent overwriting new default states with old persisted ones
                appState.viewStates = {
                    ...appState.viewStates,
                    ...persistedAppState.viewStates,
                    inventory: { ...appState.viewStates.inventory, ...(persistedAppState.viewStates.inventory || {}) },
                    customers: { ...appState.viewStates.customers, ...(persistedAppState.viewStates.customers || {}) },
                    invoices: { ...appState.viewStates.invoices, ...(persistedAppState.viewStates.invoices || {}) },
                    reports: { ...appState.viewStates.reports, ...(persistedAppState.viewStates.reports || {}) },
                    posModern: { ...appState.viewStates.posModern, ...(persistedAppState.viewStates.posModern || {}) },
                    staff: { ...appState.viewStates.staff, ...(persistedAppState.viewStates.staff || {}) }
                };
            }
        }
        const persistedPosState = JSON.parse(localStorage.getItem('cashshilpoPosState'));
        if (persistedPosState) {
            posState.sales = persistedPosState.sales || [];
            posState.activeSaleId = persistedPosState.activeSaleId || null;
            posState.saleCounter = persistedPosState.saleCounter || 1;
            if(posState.sales.length > 0 && !posState.activeSaleId) {
                posState.activeSaleId = posState.sales.find(s => s.status === 'active')?.id || posState.sales[0].id;
            }
        }
    } catch (e) {
        console.error("Could not load persisted state", e);
        localStorage.removeItem('cashshilpoAppState');
        localStorage.removeItem('cashshilpoPosState');
    }
};
            
            loadState(); // Load state as soon as DOM is ready

            // NEW: Function to apply header collapse state and associated setup
            const applyHeaderCollapseState = () => {
                // This function assumes a main wrapper with id="app-container" exists.
                const appContainer = document.getElementById('app-container') || document.body;
                const headerToggleBtn = document.getElementById('header-toggle-btn');
                if (!appContainer || !headerToggleBtn) return;

                if (appState.isHeaderCollapsed) {
                    appContainer.classList.add('header-collapsed');
                    headerToggleBtn.setAttribute('title', 'Expand Header');
                    headerToggleBtn.innerHTML = `<i data-lucide="chevrons-down-up" class="w-4 h-4"></i>`;
                } else {
                    appContainer.classList.remove('header-collapsed');
                    headerToggleBtn.setAttribute('title', 'Collapse Header');
                    headerToggleBtn.innerHTML = `<i data-lucide="chevrons-up-down" class="w-4 h-4"></i>`;
                }
                lucide.createIcons();
            };

            const setupHeaderToggle = () => {
                const header = document.querySelector('header');
                if (!header) { 
                    console.warn("Could not find header to attach toggle.");
                    return;
                }
                
                header.id = 'main-header';
                const mainColumn = header.parentElement;
                if (!mainColumn) return;

                // Ensure the parent is a positioning context
                mainColumn.style.position = 'relative';

                // Gives the content container an ID for CSS targeting
                const contentContainer = document.getElementById('workspace-content')?.parentElement;
                if (contentContainer) contentContainer.id = 'workspace-content-container';

                // Prevent adding button if it already exists from a re-render
                let headerToggleBtn = document.getElementById('header-toggle-btn');
                if (headerToggleBtn) return;

                const toggleButtonHTML = `
                    <button id="header-toggle-btn" title="Collapse Header">
                        <i data-lucide="chevrons-up-down" class="w-4 h-4"></i>
                    </button>
                `;
                // Insert the button into the main column, not inside the header
                mainColumn.insertAdjacentHTML('beforeend', toggleButtonHTML);

                headerToggleBtn = document.getElementById('header-toggle-btn');
                if (headerToggleBtn) {
                    headerToggleBtn.addEventListener('click', () => {
                        appState.isHeaderCollapsed = !appState.isHeaderCollapsed;
                        applyHeaderCollapseState();
                        saveState();
                    });
                }
            };
            setupHeaderToggle(); // Run setup on initial load
            
            window.addEventListener('beforeunload', saveState); // Save state on page close/refresh

            const workspaceContent = document.getElementById('workspace-content');
            const mainTabsContainer = document.getElementById('main-tabs-container');
            const modalsContainer = document.getElementById('modals-container');
            const toastsContainer = document.getElementById('toasts-container');
            const sidebar = document.getElementById('sidebar');
            const sidebarToggleBtn = document.getElementById('sidebar-toggle');
            const sidebarBackdrop = document.getElementById('sidebar-backdrop');
            
            // --- NEW: USER PROFILE MODAL & MENU LOGIC ---
            function openMyProfileModal() {
                const user = appState.session.currentUser;
                if (!user) {
                    showToast("You must be logged in to view your profile.", "error");
                    return;
                }

                const roleInfo = userRoles[user.role] || { name: 'Unknown' };

                const content = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 text-center">
                            <img src="https://placehold.co/128x128/1f2937/4b5563?text=${user.name.charAt(0).toUpperCase()}" class="w-32 h-32 rounded-full mx-auto ring-4 ring-bg-secondary shadow-lg">
                            <h2 class="text-2xl font-bold text-text-primary mt-4">${user.name}</h2>
                            <p class="text-accent font-semibold">${roleInfo.name}</p>
                        </div>
                        <div class="md:col-span-2 space-y-4">
                            <h3 class="text-lg font-semibold text-text-primary">Contact Information</h3>
                            <div class="space-y-3 text-sm">
                                <div class="flex items-start gap-3"><i data-lucide="mail" class="w-4 h-4 text-text-secondary mt-0.5 shrink-0"></i><div><p class="text-text-secondary -mb-1">Email</p><p class="text-text-primary font-medium break-all">${user.email}</p></div></div>
                                <div class="flex items-start gap-3"><i data-lucide="phone" class="w-4 h-4 text-text-secondary mt-0.5 shrink-0"></i><div><p class="text-text-secondary -mb-1">Phone</p><p class="text-text-primary font-medium">${user.phone || 'Not provided'}</p></div></div>
                                <div class="flex items-start gap-3"><i data-lucide="map-pin" class="w-4 h-4 text-text-secondary mt-0.5 shrink-0"></i><div><p class="text-text-secondary -mb-1">Address</p><p class="text-text-primary font-medium">${user.address || 'Not provided'}</p></div></div>
                            </div>
                            <div class="border-t border-border-color pt-4">
                                <h3 class="text-lg font-semibold text-text-primary">Account Details</h3>
                                <div class="space-y-3 text-sm mt-3">
                                    <div class="flex items-start gap-3"><i data-lucide="calendar" class="w-4 h-4 text-text-secondary mt-0.5 shrink-0"></i><div><p class="text-text-secondary -mb-1">Joined On</p><p class="text-text-primary font-medium">${new Date(user.joinDate).toLocaleDateString()}</p></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                const footer = `<button data-action="close-modal" class="btn btn-secondary">Close</button>${user.role === 'admin' ? `<button id="edit-my-profile" class="btn btn-primary">Edit My Profile</button>` : ''}`;
                const modal = showModal('My Profile', content, footer, { size: 'max-w-3xl' });
                lucide.createIcons();
                
                const editProfileBtn = modal.querySelector('#edit-my-profile');
                if (editProfileBtn) {
                    editProfileBtn.addEventListener('click', () => {
                        closeModal(modal);
                        // Only admins will have this button, so just call the admin edit modal.
                        openAdminEditStaffModal(user.uid);
                    });
                }
            }

            async function openNotificationsModal() {
                const notifications = firestoreData.notifications;
                
                // Use negative horizontal margins to make list dividers edge-to-edge
                const content = `
                    <div class="max-h-[60vh] overflow-y-auto -mx-6">
                        <div class="divide-y divide-border-color">
                            ${notifications.length > 0 ? notifications.map(n => {
                                const icons = { success: 'check-circle', info: 'info', warning: 'alert-triangle', stock: 'package-search', sale: 'receipt-text' };
                                const colors = { success: 'green', info: 'blue', warning: 'orange', stock: 'yellow', sale: 'green' };
                                const icon = icons[n.type] || 'bell';
                                const color = colors[n.type] || 'gray';
                                // Differentiate styling for read (faded) and unread notifications.
                                return `
                                <div class="notification-item flex items-start gap-4 py-4 px-6 ${!n.read ? 'bg-blue-500/10' : 'opacity-60'} hover:opacity-100 hover:bg-bg-secondary transition-all duration-200">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center bg-${color}-500/10 text-${color}-400 shrink-0 mt-1">
                                        <i data-lucide="${icon}" class="w-5 h-5"></i>
                                    </div>
                                    <div class="flex-grow">
                                        <p class="text-sm text-text-primary">${n.message.replace(/<strong>/g, '<strong class="font-semibold text-white">')}</p>
                                        <p class="text-xs text-text-secondary mt-1">${new Date(n.date).toLocaleString()}</p>
                                    </div>
                                    ${!n.read ? '<div class="w-2.5 h-2.5 bg-blue-400 rounded-full ml-2 self-center shrink-0"></div>' : ''}
                                </div>
                                `
                            }).join('') : `<p class="text-center text-text-secondary py-8 px-6">You have no notifications.</p>`}
                        </div>
                    </div>
                `;

                const footer = notifications.length > 0 ? `<button id="clear-all-notifications-btn" class="btn btn-danger-secondary">Clear All</button>` : '';
                
                const modal = showModal('Notifications', content, footer, {size: 'max-w-lg'});
                if (!modal) return;

                lucide.createIcons();

                // Mark as read only when the close button is clicked.
                const closeBtn = modal.querySelector('button[data-action="close-modal"]');
                if (closeBtn) {
                    closeBtn.addEventListener('click', async () => {
                        const unreadNotifications = firestoreData.notifications.filter(n => !n.read);
                        if (unreadNotifications.length > 0) {
                            try {
                                const batch = writeBatch(db);
                                unreadNotifications.forEach(n => {
                                    const notifRef = doc(notificationsRef, n.id);
                                    batch.update(notifRef, { read: true });
                                });
                                await batch.commit();
                            } catch (error) {
                                console.error("Error marking notifications as read on close:", error);
                            }
                        }
                    });
                }
                
                const clearAllBtn = modal.querySelector('#clear-all-notifications-btn');
                if (clearAllBtn) {
                    clearAllBtn.addEventListener('click', async () => {
                        clearAllBtn.disabled = true;
                        clearAllBtn.textContent = 'Clearing...';
                        
                        try {
                            const batch = writeBatch(db);
                            firestoreData.notifications.forEach(n => {
                                const notifRef = doc(notificationsRef, n.id);
                                batch.delete(notifRef);
                            });
                            await batch.commit();
                            showToast('All notifications cleared.', 'success');
                            closeModal(modal);
                        } catch (error) {
                            console.error("Error clearing notifications:", error);
                            showToast('Could not clear notifications.', 'error');
                            clearAllBtn.disabled = false;
                            clearAllBtn.textContent = 'Clear All';
                        }
                    });
                }
            }

            function openGlobalSearchModal() {
                const content = `
                    <div class="-m-6">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-6 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i>
                            <input type="text" id="global-search-input" placeholder="Search products, customers, invoices..." class="w-full text-lg bg-transparent form-input border-0 border-b border-border-color rounded-none pl-14 p-5 focus:ring-0">
                        </div>
                        <div id="global-search-results" class="max-h-[60vh] overflow-y-auto p-4">
                            <div class="text-center text-text-secondary py-12">
                                <i data-lucide="search" class="w-12 h-12 mx-auto mb-4"></i>
                                <p>Find anything in your store instantly.</p>
                            </div>
                        </div>
                    </div>
                    <style>
                        .search-result-group {
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                            padding: 0.75rem;
                            border-radius: 0.5rem;
                            cursor: pointer;
                            transition: background-color 0.2s ease;
                        }
                        .search-result-group:hover {
                            background-color: var(--bg-secondary);
                        }
                    </style>
                `;
                const modal = showModal('Global Search', content, '', {size: 'max-w-3xl', customClasses: 'p-0'});
                lucide.createIcons();

                const input = modal.querySelector('#global-search-input');
                const resultsContainer = modal.querySelector('#global-search-results');
                input.focus();

                input.addEventListener('input', () => {
                    const query = input.value.toLowerCase().trim();
                    if (query.length < 1) {
                        resultsContainer.innerHTML = ` <div class="text-center text-text-secondary py-12">
                                <i data-lucide="search" class="w-12 h-12 mx-auto mb-4"></i>
                                <p>Find anything in your store instantly.</p>
                            </div>`;
                        lucide.createIcons();
                        return;
                    }

                    const term = getCurrentProfile().terminology;
                    const results = { products: [], customers: [], invoices: [] };
                    
                    // Search Products
                    firestoreData.products.forEach(p => {
                        if (!p.parentSKU && (p.name.toLowerCase().includes(query) || p.id.toLowerCase().includes(query) || p.barcode?.includes(query))) {
                            results.products.push(p);
                        }
                    });

                    // Search Customers
                    firestoreData.customers.forEach(c => {
                        if (c.name.toLowerCase().includes(query) || (c.phone || '').includes(query) || c.email?.toLowerCase().includes(query)) {
                            results.customers.push(c);
                        }
                    });

                    // Search Invoices
                    firestoreData.invoices.forEach(i => {
                        if (i.id.toLowerCase().includes(query) || i.customerName.toLowerCase().includes(query)) {
                            results.invoices.push(i);
                        }
                    });

                    let resultsHTML = '';
                    if (results.products.length > 0) {
                        resultsHTML += `<h4 class="text-xs uppercase font-semibold text-text-secondary px-2 mb-2">${term.product}s</h4>`;
                        resultsHTML += results.products.slice(0, 5).map(p => {
                            let detailsHTML;
                            let icon = 'package';
                            if (p.hasVariants) {
                                const variants = firestoreData.products.filter(v => v.parentSKU === p.id);
                                const totalStock = variants.reduce((sum, v) => sum + (v.stock || 0), 0);
                                icon = 'boxes';
                                detailsHTML = `<p class="text-xs text-text-secondary font-mono">${p.id} &bull; ${variants.length} variants &bull; Total Stock: ${totalStock}</p>`;
                            } else {
                                detailsHTML = `<p class="text-xs text-text-secondary font-mono">${p.id} &bull; Price: ${currencyUtils.format(p.price)} &bull; Stock: ${p.stock}</p>`;
                            }

                            return `
                            <div data-search-action="view-product" data-id="${p.id}" class="search-result-group">
                                <i data-lucide="${icon}" class="w-5 h-5 text-accent"></i>
                                <div>
                                    <p class="font-medium text-text-primary">${p.name}</p>
                                    ${detailsHTML}
                                </div>
                            </div>`;
                        }).join('');
                    }
                    if (results.customers.length > 0) {
                        resultsHTML += `<h4 class="text-xs uppercase font-semibold text-text-secondary px-2 mt-4 mb-2">Customers</h4>`;
                        resultsHTML += results.customers.slice(0, 5).map(c => `
                            <div data-search-action="view-customer" data-id="${c.id}" class="search-result-group">
                                <i data-lucide="user" class="w-5 h-5 text-accent"></i>
                                <div>
                                    <p class="font-medium text-text-primary">${c.name}</p>
                                    <p class="text-xs text-text-secondary">${c.phone} &bull; ${c.email}</p>
                                </div>
                            </div>
                        `).join('');
                    }
                    if (results.invoices.length > 0) {
                        resultsHTML += `<h4 class="text-xs uppercase font-semibold text-text-secondary px-2 mt-4 mb-2">Invoices</h4>`;
                        resultsHTML += results.invoices.slice(0, 5).map(i => `
                            <div data-search-action="view-invoice" data-id="${i.id}" class="search-result-group">
                                <i data-lucide="receipt-text" class="w-5 h-5 text-accent"></i>
                                <div>
                                    <p class="font-medium text-text-primary">Invoice ${i.id}</p>
                                    <p class="text-xs text-text-secondary">${i.customerName} &bull; Total: ${currencyUtils.format(i.totalInBaseCurrency, i.currency)}</p>
                                </div>
                            </div>
                        `).join('');
                    }

                    if(resultsHTML) {
                        resultsContainer.innerHTML = resultsHTML;
                    } else {
                        resultsContainer.innerHTML = `<p class="text-center py-12 text-text-secondary">No results found for "${query}".</p>`;
                    }
                    lucide.createIcons();
                });

                resultsContainer.addEventListener('click', e => {
                    const target = e.target.closest('[data-search-action]');
                    if (!target) return;
                    
                    const { searchAction, id } = target.dataset;
                    closeModal(modal);

                    switch (searchAction) {
                        case 'view-product':
                            const product = firestoreData.products.find(p => p.id === id);
                            if (product) {
                                openOrSwitchTab('inventory');
                                setTimeout(() => {
                                    const container = document.querySelector('#inventory-view-container');
                                    if (container) {
                                        if (product.hasVariants) {
                                            renderVariantDetailView(id, container);
                                        } else {
                                            renderProductDetailView(id, container);
                                        }
                                    }
                                }, 200);
                            }
                            break;
                        case 'view-customer':
                            openOrSwitchTab('customers');
                            setTimeout(() => {
                                openCustomerModal(id);
                            }, 200);
                            break;
                        case 'view-invoice':
                            openOrSwitchTab('invoices');
                            setTimeout(() => {
                                const invoice = firestoreData.invoices.find(i => i.id === id);
                                if (invoice) {
                                    if (invoice.customerId) {
                                        invoice.customer = firestoreData.customers.find(c => c.id === invoice.customerId);
                                    }
                                    showReceipt(invoice);
                                }
                            }, 200);
                            break;
                    }
                });
            }

            function openCalculatorModal(type = 'simple') {
                const content = `
                    <div class="flex flex-col h-[75vh] max-h-[650px]">
                        <!-- Tabs -->
                        <div class="border-b border-border-color flex-shrink-0">
                            <button data-tab="simple" class="form-tab px-4 py-3 text-sm font-medium ${type === 'simple' ? 'active' : ''}">Calculator</button>
                            <button data-tab="advanced" class="form-tab px-4 py-3 text-sm font-medium ${type === 'advanced' ? 'active' : ''}">Advanced Tools</button>
                        </div>

                        <!-- Panes -->
                        <div class="flex-grow overflow-hidden">
                            <!-- Simple Calculator Pane -->
                            <div class="form-pane p-4 h-full ${type === 'simple' ? 'active' : ''}" data-pane="simple">
                                <div class="flex flex-col h-full">
                                    <input id="calc-display" type="text" readonly class="w-full text-right text-4xl font-mono p-4 mb-4 bg-bg-tertiary rounded-lg border-border-color">
                                    <div class="grid grid-cols-4 gap-2 flex-grow">
                                        <button data-calc-action="clear" class="calc-btn bg-red-500/20 text-red-300">AC</button>
                                        <button data-calc-action="backspace" class="calc-btn bg-gray-500/20 text-gray-300"><i data-lucide="delete" class="w-6 h-6 pointer-events-none"></i></button>
                                        <button data-calc-action="operator" data-key="%" class="calc-btn bg-gray-500/20 text-gray-300">%</button>
                                        <button data-calc-action="operator" data-key="/" class="calc-btn operator-btn text-2xl"></button>
                                        
                                        <button data-calc-action="number" data-key="7" class="calc-btn text-2xl">7</button>
                                        <button data-calc-action="number" data-key="8" class="calc-btn text-2xl">8</button>
                                        <button data-calc-action="number" data-key="9" class="calc-btn text-2xl">9</button>
                                        <button data-calc-action="operator" data-key="*" class="calc-btn operator-btn text-2xl"></button>
                                        
                                        <button data-calc-action="number" data-key="4" class="calc-btn text-2xl">4</button>
                                        <button data-calc-action="number" data-key="5" class="calc-btn text-2xl">5</button>
                                        <button data-calc-action="number" data-key="6" class="calc-btn text-2xl">6</button>
                                        <button data-calc-action="operator" data-key="-" class="calc-btn operator-btn text-2xl">-</button>
                                        
                                        <button data-calc-action="number" data-key="1" class="calc-btn text-2xl">1</button>
                                        <button data-calc-action="number" data-key="2" class="calc-btn text-2xl">2</button>
                                        <button data-calc-action="number" data-key="3" class="calc-btn text-2xl">3</button>
                                        <button data-calc-action="operator" data-key="+" class="calc-btn operator-btn text-2xl">+</button>
                                        
                                        <button data-calc-action="number" data-key="0" class="calc-btn text-2xl col-span-2">0</button>
                                        <button data-calc-action="number" data-key="." class="calc-btn text-2xl">.</button>
                                        <button data-calc-action="equals" class="calc-btn operator-btn text-2xl">=</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Advanced Calculator Pane -->
                            <div class="form-pane p-6 h-full overflow-y-auto ${type === 'advanced' ? 'active' : ''}" data-pane="advanced">
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <!-- Profit Margin Calculator -->
                                    <div class="tool-card">
                                        <h4 class="tool-title"><i data-lucide="trending-up" class="w-5 h-5 text-accent"></i>Profit Margin</h4>
                                        <div id="profit-calc" class="tool-body">
                                            <div class="grid grid-cols-2 gap-3">
                                                <div><label class="input-label">Cost Price</label><input type="number" name="costPrice" class="form-input w-full p-2 mt-1"></div>
                                                <div><label class="input-label">Selling Price</label><input type="number" name="sellingPrice" class="form-input w-full p-2 mt-1"></div>
                                            </div>
                                            <div class="grid grid-cols-2 gap-3 result-area">
                                                <div><p class="result-label">Gross Profit</p><p id="profit-result" class="result-value text-green-400">...</p></div>
                                                <div><p class="result-label">Profit Margin</p><p id="margin-result" class="result-value text-green-400">...</p></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Discount Calculator -->
                                    <div class="tool-card">
                                         <h4 class="tool-title"><i data-lucide="percent" class="w-5 h-5 text-accent"></i>Discount</h4>
                                         <div id="discount-calc" class="tool-body">
                                            <div><label class="input-label">Original Price</label><input type="number" name="originalPrice" class="form-input w-full p-2 mt-1"></div>
                                            <div class="flex">
                                                <select name="discountType" class="form-select rounded-r-none w-24 p-2 text-sm">
                                                    <option value="percent">%</option>
                                                    <option value="fixed">${currencyUtils.get().symbol}</option>
                                                </select>
                                                <input type="number" name="discountValue" placeholder="Discount" class="w-full form-input rounded-l-none p-2">
                                            </div>
                                            <div class="result-area">
                                                <p class="result-label">Final Price</p>
                                                <p id="discount-result" class="result-value text-blue-400">...</p>
                                            </div>
                                         </div>
                                    </div>

                                    <!-- Tax Calculator -->
                                    <div class="tool-card">
                                         <h4 class="tool-title"><i data-lucide="landmark" class="w-5 h-5 text-accent"></i>Tax</h4>
                                         <div id="tax-calc" class="tool-body">
                                            <div><label class="input-label">Price (before tax)</label><input type="number" name="preTaxPrice" class="form-input w-full p-2 mt-1"></div>
                                            <div><label class="input-label">Tax Rate (%)</label><input type="number" name="taxRate" value="${appState.settings.taxRate}" class="form-input w-full p-2 mt-1"></div>
                                            <div class="grid grid-cols-2 gap-3 result-area">
                                                <div><p class="result-label">Tax Amount</p><p id="tax-amount-result" class="result-value text-yellow-400">...</p></div>
                                                <div><p class="result-label">Total (with tax)</p><p id="tax-total-result" class="result-value text-yellow-400">...</p></div>
                                            </div>
                                         </div>
                                    </div>
                                    
                                    <!-- Currency Converter -->
                                    <div class="tool-card">
                                        <h4 class="tool-title"><i data-lucide="arrow-right-left" class="w-5 h-5 text-accent"></i>Currency Converter</h4>
                                        <div id="currency-converter" class="tool-body">
                                            <div><label class="input-label">Amount</label><input type="number" name="convertAmount" class="form-input w-full p-2 mt-1"></div>
                                            <div class="grid grid-cols-2 gap-3">
                                                <div><label class="input-label">From</label><select name="convertFrom" class="form-select w-full mt-1"></select></div>
                                                <div><label class="input-label">To</label><select name="convertTo" class="form-select w-full mt-1"></select></div>
                                            </div>
                                            <div class="result-area">
                                                <p class="result-label">Converted Amount</p>
                                                <p id="currency-result" class="result-value text-purple-400">...</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Loan EMI Calculator -->
                                    <div class="tool-card">
                                        <h4 class="tool-title"><i data-lucide="banknote" class="w-5 h-5 text-accent"></i>Loan EMI</h4>
                                        <div id="loan-calc" class="tool-body">
                                            <div><label class="input-label">Loan Amount</label><input type="number" name="loanAmount" class="form-input w-full p-2 mt-1"></div>
                                            <div class="grid grid-cols-2 gap-3">
                                                <div><label class="input-label">Interest Rate (%)</label><input type="number" name="loanRate" class="form-input w-full p-2 mt-1"></div>
                                                <div><label class="input-label">Tenure (Years)</label><input type="number" name="loanTenure" class="form-input w-full p-2 mt-1"></div>
                                            </div>
                                            <div class="result-area">
                                                <p class="result-label">Monthly EMI</p>
                                                <p id="emi-result" class="result-value text-teal-400">...</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Compound Interest Calculator -->
                                    <div class="tool-card">
                                        <h4 class="tool-title"><i data-lucide="piggy-bank" class="w-5 h-5 text-accent"></i>Compound Interest</h4>
                                        <div id="interest-calc" class="tool-body">
                                            <div><label class="input-label">Principal Amount</label><input type="number" name="principal" class="form-input w-full p-2 mt-1"></div>
                                            <div class="grid grid-cols-2 gap-3">
                                                <div><label class="input-label">Annual Rate (%)</label><input type="number" name="interestRate" class="form-input w-full p-2 mt-1"></div>
                                                <div><label class="input-label">Years</label><input type="number" name="interestYears" class="form-input w-full p-2 mt-1"></div>
                                            </div>
                                            <div class="result-area">
                                                <p class="result-label">Future Value</p>
                                                <p id="future-value-result" class="result-value text-pink-400">...</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Breakeven Point Calculator -->
                                    <div class="tool-card lg:col-span-2">
                                        <h4 class="tool-title"><i data-lucide="target" class="w-5 h-5 text-accent"></i>Breakeven Point</h4>
                                        <div id="breakeven-calc" class="tool-body">
                                            <div class="grid grid-cols-3 gap-3">
                                                <div><label class="input-label">Fixed Costs</label><input type="number" name="fixedCosts" class="form-input w-full p-2 mt-1"></div>
                                                <div><label class="input-label">Price per Unit</label><input type="number" name="unitPrice" class="form-input w-full p-2 mt-1"></div>
                                                <div><label class="input-label">Cost per Unit</label><input type="number" name="unitCost" class="form-input w-full p-2 mt-1"></div>
                                            </div>
                                            <div class="grid grid-cols-2 gap-3 result-area">
                                                <div><p class="result-label">Breakeven Units</p><p id="breakeven-units-result" class="result-value text-orange-400">...</p></div>
                                                <div><p class="result-label">Breakeven Revenue</p><p id="breakeven-revenue-result" class="result-value text-orange-400">...</p></div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                    <style>
                        .calc-btn { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.75rem; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
                        .calc-btn:hover { background-color: var(--bg-tertiary); transform: scale(1.05); }
                        .calc-btn:active { transform: scale(0.95); }
                        .operator-btn { background-color: var(--accent); color: white; }
                        .tool-card { background-color: var(--bg-secondary); border-radius: 0.75rem; border: 1px solid var(--border-color); }
                        .tool-title { font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; padding: 1rem 1rem 0; }
                        .tool-body { padding: 1rem; space-y: 0.75rem; }
                        .input-label { font-size: 0.75rem; color: var(--text-secondary); }
                        .result-area { padding-top: 0.75rem; border-top: 1px solid var(--border-color-strong); margin-top: 0.75rem; }
                        .result-label { font-size: 0.75rem; color: var(--text-secondary); }
                        .result-value { font-family: monospace; font-size: 1.125rem; font-weight: 600; }
                    </style>
                `;
                const modal = showModal('Calculators', content, '', { size: 'max-w-4xl', customClasses: 'p-0' });
                lucide.createIcons();
                
                // Tab switching logic
                const tabs = modal.querySelectorAll('.form-tab');
                const panes = modal.querySelectorAll('.form-pane');
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        tabs.forEach(t => t.classList.remove('active'));
                        panes.forEach(p => p.classList.remove('active'));
                        tab.classList.add('active');
                        modal.querySelector(`.form-pane[data-pane="${tab.dataset.tab}"]`).classList.add('active');
                    });
                });

                // Simple Calculator Logic
                const display = modal.querySelector('#calc-display');
                let expression = '';

                function handleCalcInput(action, key) {
                    if (expression === 'Error' || expression === 'Infinity') {
                        expression = '';
                    }

                    switch(action) {
                        case 'number':
                            expression += key;
                            break;
                        case 'operator':
                            if (expression === '' && key !== '-') return;
                            const lastChar = expression.slice(-1);
                            if (['+', '-', '*', '/', '%'].includes(lastChar)) {
                                expression = expression.slice(0, -1) + key;
                            } else {
                                expression += key;
                            }
                            break;
                        case 'equals':
                            if (expression === '' || ['+', '-', '*', '/', '%'].includes(expression.slice(-1))) return;
                            try {
                                const result = new Function('return ' + expression)();
                                expression = String(result);
                            } catch {
                                expression = 'Error';
                            }
                            break;
                        case 'clear':
                            expression = '';
                            break;
                        case 'backspace':
                            expression = expression.slice(0, -1);
                            break;
                    }

                    display.value = expression || '0';
                }

                modal.querySelector('[data-pane="simple"]').addEventListener('click', e => {
                    const target = e.target.closest('[data-calc-action]');
                    if (!target) return;
                    handleCalcInput(target.dataset.calcAction, target.dataset.key);
                });
                
                // --- NEW: Keyboard Support for Calculator ---
                const handleKeyboardInput = (e) => {
                    // Only handle input if the modal exists and the simple calculator is visible
                    const modalExists = document.body.contains(modal);
                    const simplePane = modal.querySelector('.form-pane[data-pane="simple"]');
                    if (!modalExists || !simplePane || !simplePane.classList.contains('active')) return;
                    
                    // Don't interfere with inputs in the advanced tab or other modals
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                         if(!modal.contains(e.target) || modal.querySelector('.form-pane[data-pane="advanced"]').contains(e.target)) {
                            return;
                        }
                    }

                    const key = e.key;
                    let handled = false;

                    if ((key >= '0' && key <= '9') || key === '.') {
                        handleCalcInput('number', key);
                        handled = true;
                    } else if (['+', '-', '*', '/', '%'].includes(key)) {
                        handleCalcInput('operator', key);
                        handled = true;
                    } else if (key === 'Enter' || key === '=') {
                        handleCalcInput('equals', null);
                        handled = true;
                    } else if (key === 'Backspace') {
                        handleCalcInput('backspace', null);
                        handled = true;
                    } else if (key === 'Escape' || key.toLowerCase() === 'c') {
                        handleCalcInput('clear', null);
                        handled = true;
                    }
                    
                    if (handled) {
                        e.preventDefault();
                    }
                };
                
                document.addEventListener('keydown', handleKeyboardInput);

                // --- Cleanup on close ---
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        mutation.removedNodes.forEach((node) => {
                            if (node === modal) {
                                document.removeEventListener('keydown', handleKeyboardInput);
                                observer.disconnect();
                            }
                        });
                    });
                });
                observer.observe(modalsContainer, { childList: true });

                // Advanced Calculator Logic
                const profitCalc = modal.querySelector('#profit-calc');
                const discountCalc = modal.querySelector('#discount-calc');
                const taxCalc = modal.querySelector('#tax-calc');
                const currencyConverter = modal.querySelector('#currency-converter');
                const loanCalc = modal.querySelector('#loan-calc');
                const interestCalc = modal.querySelector('#interest-calc');
                const breakevenCalc = modal.querySelector('#breakeven-calc');

                profitCalc.addEventListener('input', () => {
                    const costInDisplay = parseFloat(profitCalc.querySelector('[name="costPrice"]').value) || 0;
                    const sellingInDisplay = parseFloat(profitCalc.querySelector('[name="sellingPrice"]').value) || 0;
                    
                    const cost = currencyUtils.convertToBase(costInDisplay);
                    const selling = currencyUtils.convertToBase(sellingInDisplay);

                    const profit = selling - cost;
                    const margin = selling > 0 ? (profit / selling) * 100 : 0;
                    
                    profitCalc.querySelector('#profit-result').textContent = currencyUtils.format(profit);
                    profitCalc.querySelector('#margin-result').textContent = `${margin.toFixed(2)}%`;
                });

                discountCalc.addEventListener('input', () => {
                    const originalInDisplay = parseFloat(discountCalc.querySelector('[name="originalPrice"]').value) || 0;
                    const original = currencyUtils.convertToBase(originalInDisplay);
                    
                    const type = discountCalc.querySelector('[name="discountType"]').value;
                    const value = parseFloat(discountCalc.querySelector('[name="discountValue"]').value) || 0;
                    
                    let finalPrice = original;
                    if (type === 'percent') {
                        finalPrice = original * (1 - value / 100);
                    } else { // 'fixed' amount is in display currency
                        const valueInBase = currencyUtils.convertToBase(value);
                        finalPrice = original - valueInBase;
                    }
                    discountCalc.querySelector('#discount-result').textContent = currencyUtils.format(finalPrice);
                });

                taxCalc.addEventListener('input', () => {
                    const preTaxInDisplay = parseFloat(taxCalc.querySelector('[name="preTaxPrice"]').value) || 0;
                    const preTax = currencyUtils.convertToBase(preTaxInDisplay);
                    
                    const rate = parseFloat(taxCalc.querySelector('[name="taxRate"]').value) || 0;
                    
                    const taxAmount = preTax * (rate / 100);
                    const total = preTax + taxAmount;
                    
                    taxCalc.querySelector('#tax-amount-result').textContent = currencyUtils.format(taxAmount);
                    taxCalc.querySelector('#tax-total-result').textContent = currencyUtils.format(total);
                });
                
                // --- NEW: Currency Converter Logic ---
                if (currencyConverter) {
                    const fromSelect = currencyConverter.querySelector('[name="convertFrom"]');
                    const toSelect = currencyConverter.querySelector('[name="convertTo"]');
                    const currencies = firestoreData.storeInfo.currencies || {};
                    const optionsHTML = Object.keys(currencies).map(code => `<option value="${code}">${code}</option>`).join('');
                    fromSelect.innerHTML = optionsHTML;
                    toSelect.innerHTML = optionsHTML;
                    fromSelect.value = appState.currentCurrency;
                    toSelect.value = firestoreData.storeInfo.baseCurrency || 'USD';
                    
                    currencyConverter.addEventListener('input', () => {
                        const amount = parseFloat(currencyConverter.querySelector('[name="convertAmount"]').value) || 0;
                        const from = fromSelect.value;
                        const to = toSelect.value;
                        const baseAmount = currencyUtils.convertToBase(amount, from);
                        const convertedAmount = currencyUtils.convert(baseAmount, to);
                        currencyConverter.querySelector('#currency-result').textContent = currencyUtils.format(baseAmount, to);
                    });
                }

                // --- NEW: Loan EMI Calculator Logic ---
                if (loanCalc) {
                    loanCalc.addEventListener('input', () => {
                        const p = parseFloat(loanCalc.querySelector('[name="loanAmount"]').value) || 0;
                        const r = (parseFloat(loanCalc.querySelector('[name="loanRate"]').value) || 0) / 12 / 100;
                        const n = (parseFloat(loanCalc.querySelector('[name="loanTenure"]').value) || 0) * 12;
                        
                        if (p > 0 && r > 0 && n > 0) {
                            const emi = (p * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
                            const emiInBase = currencyUtils.convertToBase(emi);
                            loanCalc.querySelector('#emi-result').textContent = currencyUtils.format(emiInBase);
                        } else {
                            loanCalc.querySelector('#emi-result').textContent = '...';
                        }
                    });
                }
                
                // --- NEW: Compound Interest Logic ---
                if (interestCalc) {
                    interestCalc.addEventListener('input', () => {
                        const p = parseFloat(interestCalc.querySelector('[name="principal"]').value) || 0;
                        const r = (parseFloat(interestCalc.querySelector('[name="interestRate"]').value) || 0) / 100;
                        const t = parseFloat(interestCalc.querySelector('[name="interestYears"]').value) || 0;
                        
                        if (p > 0 && r > 0 && t > 0) {
                            const futureValue = p * Math.pow(1 + r, t);
                            const futureValueInBase = currencyUtils.convertToBase(futureValue);
                            interestCalc.querySelector('#future-value-result').textContent = currencyUtils.format(futureValueInBase);
                        } else {
                            interestCalc.querySelector('#future-value-result').textContent = '...';
                        }
                    });
                }
                
                // --- NEW: Breakeven Point Logic ---
                if (breakevenCalc) {
                    breakevenCalc.addEventListener('input', () => {
                        const fixedCosts = parseFloat(breakevenCalc.querySelector('[name="fixedCosts"]').value) || 0;
                        const unitPrice = parseFloat(breakevenCalc.querySelector('[name="unitPrice"]').value) || 0;
                        const unitCost = parseFloat(breakevenCalc.querySelector('[name="unitCost"]').value) || 0;

                        const contributionMargin = unitPrice - unitCost;
                        
                        if (fixedCosts > 0 && contributionMargin > 0) {
                            const breakevenUnits = Math.ceil(fixedCosts / contributionMargin);
                            const breakevenRevenue = breakevenUnits * unitPrice;
                            
                            const breakevenUnitsInBase = currencyUtils.convertToBase(breakevenUnits);
                            const breakevenRevenueInBase = currencyUtils.convertToBase(breakevenRevenue);

                            breakevenCalc.querySelector('#breakeven-units-result').textContent = `${breakevenUnits.toLocaleString()} units`;
                            breakevenCalc.querySelector('#breakeven-revenue-result').textContent = currencyUtils.format(breakevenRevenueInBase);
                        } else {
                            breakevenCalc.querySelector('#breakeven-units-result').textContent = '...';
                            breakevenCalc.querySelector('#breakeven-revenue-result').textContent = '...';
                        }
                    });
                }
            }

            const initUserProfileMenu = () => {
                const userProfileSection = document.getElementById('user-profile-section');
                if (!userProfileSection) {
                    console.warn('User profile section not found in DOM.');
                    return;
                }

                userProfileSection.classList.remove('group');
                const trigger = userProfileSection.querySelector('.flex.items-center');
                if (trigger) {
                    trigger.dataset.action = 'toggle-user-menu';
                }

                const oldLogoutButton = userProfileSection.querySelector('button[data-action="logout"]');
                if (oldLogoutButton) {
                    oldLogoutButton.remove();
                }

                const logoutIcon = userProfileSection.querySelector('[data-lucide="log-out"]');
                if (logoutIcon) {
                    logoutIcon.dataset.lucide = 'more-vertical';
                    logoutIcon.classList.remove('opacity-0', 'group-hover:opacity-100');
                }

                const menu = document.createElement('div');
                menu.id = 'user-menu';
                menu.className = 'action-menu !w-60';
                menu.innerHTML = `
                    <div class="p-3 border-b border-border-color">
                        <p class="font-semibold text-text-primary truncate" id="user-menu-name">Loading...</p>
                        <p class="text-xs text-text-secondary truncate" id="user-menu-email">...</p>
                    </div>
                    <div class="p-1">
                        <a href="#" data-action="view-my-profile" class="action-menu-item">
                            <i data-lucide="user-circle" class="w-4 h-4"></i>
                            <span>My Profile</span>
                        </a>
                        <a href="#" data-action="show-shortcuts" class="action-menu-item">
                            <i data-lucide="keyboard" class="w-4 h-4"></i>
                            <span>Keyboard Shortcuts</span>
                        </a>
                        <div class="h-px bg-border-color my-1"></div>
                        <a href="#" data-action="logout" class="action-menu-item danger">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            <span>Sign Out</span>
                        </a>
                    </div>
                `;
                // MODIFIED: Append menu to the body to prevent it from being hidden by the sidebar's overflow when collapsed.
                document.body.appendChild(menu);
                lucide.createIcons();
            };
            
            initUserProfileMenu();
            // --- END NEW ---
            
            // --- CURRENCY UTILITY ---
            // MOVED to global scope
            
            // --- CORE UTILITY FUNCTIONS ---
            // MOVED to global scope

            // --- AUTOMATION & SIMULATION FUNCTIONS ---
        const createNotification = async (type, message, options = {}) => {
            // NEW: Default target is admin and manager. Can be overridden.
            const { targetRoles = ['admin', 'manager'] } = options;

            const notification = {
                type,
                message,
                date: new Date().toISOString(),
                read: false,
                targetRoles // NEW: Store who this notification is for
            };
            try {
                await addDoc(notificationsRef, notification);
            } catch (error) {
                console.error("Failed to create notification:", error);
            }
        };
        
        const simulateInventoryOptimization = () => {
            if (!appState.settings.automations?.inventoryOptimization?.enabled) return;
            // Admins or managers trigger this, but the notification can be for anyone.
            if (appState.session.userRole === 'cashier') return;

            const realProducts = firestoreData.products.filter(p => !p.name.toLowerCase().includes('cashshilpo'));

            const topSeller = realProducts.filter(p => p.sales > 0).sort((a,b) => b.sales - a.sales)[0];
            
            if (topSeller) {
                const messageFragment = `Sales of <strong>${topSeller.name}</strong> are high`;
                // Check if a similar notification already exists to avoid spamming, regardless of read status.
                const existing = firestoreData.notifications.some(n => n.message.includes(messageFragment));
                if (!existing) {
                    // Default targetRoles (admin/manager) is appropriate here.
                    createNotification('info', `${messageFragment}. Consider a featured promotion or increasing stock.`);
                }
            }

            const lowStockItem = realProducts.filter(p => p.productType === 'physical' && p.stock > 0 && p.stock < 10).sort((a,b) => a.stock - b.stock)[0];

            if(lowStockItem) {
                const messageFragment = `You are low on <strong>${lowStockItem.name}</strong>`;
                // Check if a similar notification already exists, regardless of read status.
                const existing = firestoreData.notifications.some(n => n.message.includes(messageFragment));
                if (!existing) {
                    // NEW: Low stock alerts go to everyone.
                    createNotification('stock', `<strong>Inventory Alert:</strong> ${messageFragment} (${lowStockItem.stock} remaining). Create a purchase order to avoid stockout.`, { targetRoles: ['admin', 'manager', 'cashier'] });
                }
            }
        };

        const simulateDynamicPricing = () => {
            if (!appState.settings.automations?.dynamicPricing?.enabled) return;
            if (appState.session.userRole === 'cashier') return; // Cashiers don't run this simulation
            
            const realProducts = firestoreData.products.filter(p => !p.name.toLowerCase().includes('cashshilpo'));
            const productToAdjust = realProducts.find(p => p.sales > 20 && p.price < 50);

            if(productToAdjust) {
                const messageFragment = `consider increasing the price of <strong>${productToAdjust.name}</strong>`;
                // Check if a similar notification already exists, regardless of read status.
                const existing = firestoreData.notifications.some(n => n.message.includes(messageFragment));
                if (!existing) {
                    const suggestedPrice = (productToAdjust.price * 1.05).toFixed(2);
                    // Default targetRoles (admin/manager) is appropriate here.
                    createNotification('info', `<strong>Pricing Suggestion:</strong> Based on demand, ${messageFragment} to ${currencyUtils.format(suggestedPrice)}.`);
                }
            }
        };

        const scheduleEndOfDayReport = () => {
            if (appState.endOfDayReportScheduled || !appState.settings.automations?.endOfDayReports?.enabled) {
                return;
            }
            if (appState.session.userRole === 'cashier') return; // Cashiers don't trigger this report
            appState.endOfDayReportScheduled = true;
            console.log("[Automation] Scheduling End of Day report...");

            const runAndReschedule = () => {
                console.log("[Automation] Running scheduled End of Day report.");
                
                // --- SMART FIX START ---
                const reportDate = new Date(); // This is the time the report is *running*
                const deliveryHour = parseInt((appState.settings.automations.endOfDayReports.deliveryTime || '22:00').split(':')[0]);

                // If the report runs early in the morning (e.g., before 6 AM),
                // assume it's for the *previous* day.
                if (deliveryHour < 6) {
                    reportDate.setDate(reportDate.getDate() - 1);
                }

                // Now, get the start and end of *that* report day.
                const reportDayStart = new Date(reportDate);
                reportDayStart.setHours(0, 0, 0, 0);
                
                const reportDayEnd = new Date(reportDate);
                reportDayEnd.setHours(23, 59, 59, 999);
                
                const reportDayString = reportDayStart.toLocaleDateString();
                // --- SMART FIX END ---

                // The actual report generation logic
                // --- MODIFIED to use new date variables ---
                const todaysInvoices = firestoreData.invoices.filter(inv => {
                    const invDate = new Date(inv.date);
                    return invDate >= reportDayStart && invDate <= reportDayEnd && inv.status !== 'Void'; // Check invoices for the *entire* report day
                });
                
                if (todaysInvoices.length > 0) {
                    const totalRevenue = todaysInvoices.reduce((sum, inv) => sum + inv.totalInBaseCurrency, 0);
                    // --- MODIFIED to include the date in the message ---
                    createNotification('sale', `<strong>End of Day Summary (${reportDayString}):</strong> You made <strong>${todaysInvoices.length}</strong> sales for a total of <strong>${currencyUtils.format(totalRevenue)}</strong>.`);
                } else {
                    console.log(`[Automation] No sales for ${reportDayString}, skipping End of Day report notification.`);
                }

                // Reschedule for the next day
                setTimeout(runAndReschedule, 24 * 60 * 60 * 1000); // 24 hours
            };

            const deliveryTime = appState.settings.automations.endOfDayReports.deliveryTime || '22:00';
            const [hours, minutes] = deliveryTime.split(':').map(Number);
            
            const now = new Date();
            const nextReportTime = new Date();
            nextReportTime.setHours(hours, minutes, 0, 0);

            if (now > nextReportTime) {
                // If the time has already passed for today, schedule it for tomorrow
                nextReportTime.setDate(nextReportTime.getDate() + 1);
            }

            const delay = nextReportTime.getTime() - now.getTime();
            console.log(`[Automation] Next report in ${Math.round(delay / 1000 / 60)} minutes.`);
            setTimeout(runAndReschedule, delay);
        };

        const simulateFraudDetection = (transactionValue, cashier) => { // NEW: Pass cashier info
             if (!appState.settings.automations?.fraudDetection?.enabled) return;
             const sensitivity = appState.settings.automations.fraudDetection.sensitivity || 'high';
             let riskScore = 0;
             if (transactionValue > 1000) riskScore += 50;
             if (transactionValue > 500) riskScore += 25;
             
             let threshold = 50;
             if(sensitivity === 'low') threshold = 80;
             if(sensitivity === 'medium') threshold = 60;

             if (riskScore > 0 && Math.random() * 100 < riskScore && riskScore > threshold) {
                 // NEW: Formatted message includes the cashier's name.
                 const cashierName = cashier ? `by cashier <strong>${cashier.name}</strong>` : '';
                 const message = `<strong>Fraud Alert:</strong> A high-value transaction of ${currencyUtils.format(transactionValue)} was just processed ${cashierName} and may require review.`;
                 // NEW: This notification is only for admins and managers.
                 createNotification('warning', message, { targetRoles: ['admin', 'manager'] });
             }
        };
        
        const runAutomations = () => {
            // These functions simulate background tasks that would run on a server.
                // We run them once on startup for demonstration.
                simulateInventoryOptimization();
                simulateDynamicPricing();
            };

            // --- VIEW CONTENT & INITIALIZERS ---
            // NOTE: All init... functions are defined later in the script
            const viewInitializers = { 
            'dashboard': initDashboard, 
            'pos': initPOS, 
            'inventory': (pane) => initInventory(pane.querySelector('#inventory-view-container')), 
            'customers': initCustomers, 
            'invoices': initInvoices, 
            'reports': initReports, 
            'settings': initSettings,
             'staff': (pane) => initStaff(pane.querySelector('#staff-view-container')), // UPDATED
            'user-roles': initUserRoles, // NEW
            'expenses': initExpenses, // NEW
            'purchase-orders': (pane) => initPurchaseOrders(pane.querySelector('#purchase-orders-view-container')), // NEW
            'suppliers': initSuppliers, // NEW
            'barcode-generator': initBarcodeGenerator, // NEW
            'attributes': initAttributes, // NEW
            'claims': initClaims, // NEW
            'quotations': initQuotations, // NEW
            'subscription': initSubscription,
            'payroll': initPayroll, 
            'loyalty': initLoyalty,
            'emi-sales': initEMI,
        };
        
        function getViewContent(viewType) {
            // --- NEW: Top-level permission check ---
            const requiredPermission = viewPermissionMap[viewType];
            let hasPermission = true;

            if (requiredPermission) {
                if (Array.isArray(requiredPermission)) {
                    hasPermission = requiredPermission.some(p => checkPermission(p));
                } else {
                    hasPermission = checkPermission(requiredPermission);
                }
            }
            
            // Special case for settings for cashiers, as they have a custom view.
            if (viewType === 'settings' && appState.session.userRole === 'cashier') {
                hasPermission = true;
            }

            if (!hasPermission) {
                return `<div class="text-center p-20 flex flex-col items-center">
                            <i data-lucide="shield-off" class="w-20 h-20 text-red-500/50 mb-6"></i>
                            <h2 class="text-2xl font-semibold">Access Denied</h2>
                            <p class="text-text-secondary mt-2">You do not have permission to view this page. Please contact an administrator.</p>
                        </div>`;
            }
            // --- END NEW ---
                 const profile = getCurrentProfile();
                 const term = profile.terminology;
                 const taxRate = appState.settings.taxRate ?? 0;
                 switch (viewType) {
                    case "dashboard":
              return `
                        <div class="space-y-8">
                            <!-- Dashboard Header -->
                            <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
                                <div>
                                    <h1 class="text-3xl font-bold text-text-primary">Welcome Back, Admin</h1>
                                    <p class="text-text-secondary" id="dashboard-date">Your business at a glance.</p>
                                </div>
                                 <div class="flex flex-col items-stretch md:items-end">
                                    <!-- Desktop: Button Group -->
                                    <div class="hidden lg:block relative max-w-full sm:max-w-md md:max-w-lg lg:max-w-xl xl:max-w-2xl">
                                        <button id="dashboard-scroll-left" class="dashboard-scroll-btn left hidden absolute -left-2 top-0 bottom-0 z-10 flex items-center bg-gradient-to-r from-bg-primary to-transparent pl-2 pr-8 text-text-secondary hover:text-text-primary transition-opacity">
                                            <i data-lucide="chevron-left" class="w-6 h-6 pointer-events-none"></i>
                                        </button>
                                        <div id="dashboard-period-tabs" class="flex items-center overflow-x-auto scrollbar-hide bg-bg-secondary p-1 rounded-lg border border-border-color">
                                            <button data-action="set-dashboard-period" data-period="today" data-label="Today" class="dashboard-period-btn active whitespace-nowrap">Today</button>
                                            <button data-action="set-dashboard-period" data-period="yesterday" data-label="Yesterday" class="dashboard-period-btn whitespace-nowrap">Yesterday</button>
                                            <button data-action="set-dashboard-period" data-period="week" data-label="This Week" class="dashboard-period-btn whitespace-nowrap">This Week</button>
                                            <button data-action="set-dashboard-period" data-period="last7" data-label="Last 7 Days" class="dashboard-period-btn whitespace-nowrap">Last 7 Days</button>
                                            <button data-action="set-dashboard-period" data-period="month" data-label="This Month" class="dashboard-period-btn whitespace-nowrap">This Month</button>
                                            <button data-action="set-dashboard-period" data-period="last30" data-label="Last 30 Days" class="dashboard-period-btn whitespace-nowrap">Last 30 Days</button>
                                            <button data-action="set-dashboard-period" data-period="year" data-label="This Year" class="dashboard-period-btn whitespace-nowrap">This Year</button>
                                            <button data-action="set-dashboard-period" data-period="custom" data-label="Custom" class="dashboard-period-btn flex items-center gap-1.5 whitespace-nowrap"><i data-lucide="calendar" class="w-4 h-4"></i>Custom</button>
                                        </div>
                                        <button id="dashboard-scroll-right" class="dashboard-scroll-btn right hidden absolute -right-2 top-0 bottom-0 z-10 flex items-center bg-gradient-to-l from-bg-primary to-transparent pr-2 pl-8 text-text-secondary hover:text-text-primary transition-opacity">
                                            <i data-lucide="chevron-right" class="w-6 h-6 pointer-events-none"></i>
                                        </button>
                                    </div>

                                   <!-- Mobile & Medium Screens: Dropdown -->
                                    <div class="lg:hidden relative" id="dashboard-period-dropdown-container">
                                        <button id="dashboard-period-dropdown-btn" class="btn btn-secondary w-full flex justify-between items-center text-sm p-2.5">
                                            <span id="selected-period-label">Today</span>
                                            <i data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                                        </button>
                                        <div id="dashboard-period-dropdown-menu" class="absolute top-full right-0 mt-2 w-full bg-bg-secondary border border-border-color rounded-lg shadow-lg z-20 hidden p-1">
                                            <a href="#" class="dashboard-period-item" data-action="set-dashboard-period" data-period="today" data-label="Today">Today</a>
                                            <a href="#" class="dashboard-period-item" data-action="set-dashboard-period" data-period="yesterday" data-label="Yesterday">Yesterday</a>
                                            <a href="#" class="dashboard-period-item" data-action="set-dashboard-period" data-period="week" data-label="This Week">This Week</a>
                                            <a href="#" class="dashboard-period-item" data-action="set-dashboard-period" data-period="last7" data-label="Last 7 Days">Last 7 Days</a>
                                            <a href="#" class="dashboard-period-item" data-action="set-dashboard-period" data-period="month" data-label="This Month">This Month</a>
                                            <a href="#" class="dashboard-period-item" data-action="set-dashboard-period" data-period="last30" data-label="Last 30 Days">Last 30 Days</a>
                                            <a href="#" class="dashboard-period-item" data-action="set-dashboard-period" data-period="year" data-label="This Year">This Year</a>
                                            <div class="h-px bg-border-color my-1"></div>
                                            <a href="#" class="dashboard-period-item flex items-center justify-between" data-action="set-dashboard-period" data-period="custom" data-label="Custom">
                                                <span>Custom Range</span>
                                                <i data-lucide="calendar" class="w-4 h-4"></i>
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <div id="dashboard-custom-range" class="hidden flex items-center gap-2 mt-2">
                                        <input type="date" id="dashboard-start-date" class="form-input text-sm p-2 h-auto bg-bg-tertiary">
                                        <span class="text-text-secondary">to</span>
                                        <input type="date" id="dashboard-end-date" class="form-input text-sm p-2 h-auto bg-bg-tertiary">
                                        <button id="dashboard-apply-range" class="btn btn-primary text-sm py-2">Apply</button>
                                    </div>
                                </div>
                            </div>
                            <!-- Main KPI Cards -->
                            <div id="dashboard-stats-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <!-- KPI Cards will be rendered here -->
                            </div>

                            <!-- Main Charts & Performance -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div class="lg:col-span-2 glass-pane p-6 rounded-xl flex flex-col">
                                    <h2 class="text-xl font-semibold mb-4 text-text-primary">Revenue Overview</h2>
                                    <div class="relative flex-grow min-h-[300px]">
                                        <canvas id="sales-chart"></canvas>
                                    </div>
                                </div>
                                <div class="glass-pane p-6 rounded-xl flex flex-col">
                                     <h2 class="text-xl font-semibold mb-4 text-text-primary">Performance Snapshot</h2>
                                     <div class="space-y-4 flex-grow">
                                        <div>
                                            <h3 class="text-sm font-semibold text-text-secondary mb-2">Top Selling ${term.product}s</h3>
                                            <ul id="top-products-list" class="space-y-2"></ul>
                                        </div>
                                        <div class="pt-4 border-t border-border-color">
                                            <h3 class="text-sm font-semibold text-text-secondary mb-2">Sales by ${term.category}</h3>
                                            <div class="relative h-40"><canvas id="category-sales-chart"></canvas></div>
                                        </div>
                                     </div>
                                </div>
                            </div>
                            
                            <!-- NEW: Hourly Sales & Payment Methods -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div class="lg:col-span-2 glass-pane p-6 rounded-xl flex flex-col">
                                    <h2 class="text-xl font-semibold mb-4 text-text-primary">Hourly Sales Breakdown</h2>
                                    <div class="relative flex-grow min-h-[300px]">
                                        <canvas id="hourly-sales-chart"></canvas>
                                    </div>
                                </div>
                                <div class="glass-pane p-6 rounded-xl flex flex-col">
                                     <h2 class="text-xl font-semibold mb-4 text-text-primary">Payment Methods</h2>
                                     <div class="relative flex-grow min-h-[300px] flex items-center justify-center">
                                        <canvas id="payment-methods-chart"></canvas>
                                     </div>
                                </div>
                            </div>

                            <!-- MODIFIED: Quick Info Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="glass-pane p-6 rounded-xl flex flex-col">
                                    <div class="flex-grow">
                                        <h2 class="text-xl font-semibold mb-4 text-text-primary flex items-center gap-2"><i data-lucide="sparkles" class="text-accent"></i>AI Insights & Quick Actions</h2>
                                        <div id="ai-insights-container" class="space-y-3 text-sm min-h-[6rem]">
                                            <!-- AI Insights will be rendered here -->
                                        </div>
                                    </div>
                                    <div class="mt-auto pt-4 border-t border-border-color grid grid-cols-2 gap-3">
                                        <button data-action="add-product" class="btn btn-secondary text-sm flex items-center justify-center py-2.5">
                                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>New ${term.product}
                                        </button>
                                        <button data-action="add-purchase-order" class="btn btn-secondary text-sm flex items-center justify-center py-2.5">
                                            <i data-lucide="file-plus-2" class="w-4 h-4 mr-2"></i>New PO
                                        </button>
                                    </div>
                                </div>
                                <div id="dashboard-middle-pane" class="glass-pane p-6 rounded-xl max-h-[50vh]">
                                     <!-- This will be dynamically filled with Recent Activity or Cashier Performance -->
                                </div>
                                <div class="glass-pane p-6 rounded-xl space-y-4 max-h-[50vh]">
                                    <div>
                                        <h2 class="text-xl font-semibold mb-2 text-text-primary">Top Customers</h2>
                                        <ul id="top-customers-list" class="space-y-2"></ul>
                                    </div>
                                    <div class="pt-4 border-t border-border-color">
                                        <h2 class="text-xl font-semibold mb-2 text-text-primary">Low Stock Alert</h2>
                                        <ul id="low-stock-list" class="space-y-2 max-h-40 overflow-y-auto"></ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <style> 
                            .dashboard-period-btn { padding: 6px 12px; font-size: 14px; font-weight: 500; border-radius: 6px; transition: all 0.2s ease; }
                            .dashboard-period-btn.active { background-color: var(--accent); color: white; } 
                            .dashboard-period-btn:not(.active):hover { background-color: var(--bg-tertiary); }
                            .dashboard-period-item { display: block; padding: 8px 12px; font-size: 14px; border-radius: 6px; }
                            .dashboard-period-item:hover { background-color: var(--bg-tertiary); }
                            .scrollbar-hide::-webkit-scrollbar { display: none; }
                            .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
                        </style>
                    `;
                    case 'pos': {
                        if (appState.settings.posLayout === 'modern') {
                            // NEW MODERN LAYOUT HTML
                             return `<div class="flex flex-col h-[90.7vh] -mx-4 md:-mx-8 -my-4 md:-my-8 bg-bg-secondary">
                                <!-- POS Tabs -->
                                <div class="relative flex-shrink-0 border-b border-border-color bg-bg-primary">
                                    <button id="pos-scroll-left" class="pos-scroll-btn-left hidden absolute left-0 top-0 bottom-0 z-10 flex items-center pl-4 pr-8 bg-gradient-to-r from-bg-primary to-transparent text-text-secondary hover:text-text-primary transition-opacity"><i data-lucide="chevron-left" class="w-6 h-6 pointer-events-none"></i></button>
                                    <div id="pos-tabs-container" class="flex items-center"></div>
                                    <button id="pos-scroll-right" class="pos-scroll-btn-right hidden absolute right-0 top-0 bottom-0 z-10 flex items-center pr-4 pl-8 bg-gradient-to-l from-bg-primary to-transparent text-text-secondary hover:text-text-primary transition-opacity"><i data-lucide="chevron-right" class="w-6 h-6 pointer-events-none"></i></button>
                                </div>
                                
                                <div class="flex flex-row flex-grow overflow-hidden">
                                    <!-- Middle: Products & Categories -->
                                    <div id="pos-product-panel" class="w-7/12 flex flex-col overflow-hidden border-r border-border-color bg-bg-primary">
                                        <div class="p-4 md:p-6 border-b border-border-color shrink-0">
                                            <div class="relative w-full">
                                                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i>
                                                <input type="text" id="pos-modern-search" placeholder="Scan or search ${term.product}s by name, SKU, or barcode..." class="w-full form-input pl-12 p-3 bg-bg-secondary focus:ring-accent" autocomplete="off">
                                                <div id="pos-search-results" class="absolute top-full left-0 right-0 mt-1 border border-border-color rounded-lg shadow-lg z-20 hidden max-h-60 overflow-y-auto bg-bg-secondary"></div>
                                            </div>
                                        </div>
                                        <div class="flex-grow flex overflow-hidden relative" id="pos-category-container">
                                            <!-- CATEGORY PANEL TOGGLE -->
                                            <button data-action="toggle-pos-category-sidebar" id="pos-category-sidebar-toggle" title="Toggle Category Panel">
                                                <i data-lucide="chevron-left" class="w-4 h-4"></i>
                                            </button>
                                            <!-- Left: Categories -->
                                            <div id="pos-category-panel" class="w-56 border-r border-border-color flex flex-col overflow-y-auto shrink-0">
                                                <nav id="pos-modern-categories" class="flex-grow p-3 space-y-2"></nav>
                                            </div>
                                            <!-- Middle: Products -->
                                            <div id="pos-modern-products-container" class="flex-grow flex flex-col overflow-hidden">
                                                <div class="flex-grow overflow-y-auto p-4 md:p-6">
                                                    <h3 id="pos-modern-product-title" class="text-xl font-semibold text-text-primary mb-4"></h3>
                                                    <div id="pos-modern-products-grid" class="grid grid-cols-2 md:grid-cols-3 gap-5"></div>
                                                </div>
                                                <!-- Pagination Footer -->
                                                <div id="pos-modern-products-pagination" class="p-4 border-t border-border-color flex-shrink-0 hidden">
                                                    <!-- Pagination controls will be rendered here -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Right: Cart -->
                                    <div class="flex-grow bg-bg-secondary flex flex-col overflow-hidden">
                                        <div class="p-4 md:p-6 border-b border-border-color flex justify-between items-center shrink-0">
                                            <h2 class="text-xl font-bold text-text-primary">Current Sale</h2>
                                            <div id="pos-customer-area">
                                                <!-- Customer button or display will go here -->
                                            </div>
                                        </div>
                                        <div id="pos-modern-cart-body" class="flex-grow overflow-y-auto p-4 md:p-6 space-y-3"></div>
                                        <div class="p-4 md:p-6 border-t border-border-color bg-bg-primary space-y-4 shrink-0">
                                            <div class="space-y-2 text-sm">
                                                <div class="flex justify-between"><p class="text-text-secondary">Subtotal:</p><p id="pos-subtotal" class="font-mono text-text-primary">$0.00</p></div>
                                                <div id="pos-discount-row" class="flex justify-between hidden"><p class="text-text-secondary">Discount:</p><p id="pos-discount" class="font-mono text-red-400">-$0.00</p></div>
                                                <div class="flex justify-between"><p class="text-text-secondary">Tax (${taxRate}%):</p><p id="pos-tax" class="font-mono text-text-primary">$0.00</p></div>
                                                <div class="flex justify-between border-t border-border-color pt-2 mt-2 font-bold text-2xl"><p class="text-text-primary">Total:</p><p id="pos-total" class="font-mono text-accent">$0.00</p></div>
                                            </div>
                                            <div class="grid grid-cols-3 gap-3">
                                                <button data-action="apply-total-discount" class="btn btn-secondary h-12 text-base">Discount</button>
                                                <button data-action="hold-sale" class="btn btn-secondary h-12 text-base">Hold</button>
                                                <button data-action="cancel-sale" class="btn btn-danger h-12 text-base">Cancel</button>
                                            </div>
                                            <button data-action="process-payment" class="col-span-2 btn btn-primary text-lg tracking-wider w-full h-16">PAY</button>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        } else {
                            // CLASSIC LAYOUT HTML (existing code)
                            return `<div class="flex flex-col -mx-4 md:-mx-8 -my-4 md:-my-8"><div class="relative flex-shrink-0 border-b border-border-color"><button id="pos-scroll-left" class="pos-scroll-btn-left hidden absolute left-0 top-0 bottom-0 z-10 flex items-center pl-4 pr-8 text-text-secondary hover:text-text-primary transition-opacity"><i data-lucide="chevron-left" class="w-6 h-6 pointer-events-none"></i></button><div id="pos-tabs-container" class="flex items-center"></div><button id="pos-scroll-right" class="pos-scroll-btn-right hidden absolute right-0 top-0 bottom-0 z-10 flex items-center pr-4 pl-8 text-text-secondary hover:text-text-primary transition-opacity"><i data-lucide="chevron-right" class="w-6 h-6 pointer-events-none"></i></button></div><div class="grid grid-cols-12 gap-6 flex-grow p-4 md:p-6 lg:p-8"><div class="h-[78vh] col-span-12 md:col-span-7 glass-pane p-4 rounded-xl flex flex-col"><div class="flex items-center border-b border-border-color pb-4 mb-4"><div class="relative w-full"><i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i><input type="text" id="pos-search" placeholder="Scan or search ${term.product}s..." class="w-full form-input pl-12 p-3 focus:ring-0" autocomplete="off"><div id="pos-search-results" class="absolute top-full left-0 right-0 mt-1 border border-border-color rounded-lg shadow-lg z-20 hidden max-h-60 overflow-y-auto"></div></div><button data-action="add-customer-to-sale" class="ml-3 bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 shrink-0"><i data-lucide="user-plus" class="w-6 h-6"></i></button></div><div class="flex-grow overflow-y-auto pr-2"><table class="w-full text-sm text-left text-text-secondary"><thead class="text-xs text-text-secondary uppercase"><tr><th class="px-6 py-3">${term.product}</th><th class="px-6 py-3 w-32 text-center">Qty</th><th class="px-6 py-3">Price</th><th class="px-6 py-3">Total</th><th class="px-6 py-3 text-right">Actions</th></tr></thead><tbody id="pos-cart-body"></tbody></table></div></div><div class="col-span-12 md:col-span-5 glass-pane p-6 rounded-xl flex flex-col justify-between"><div><h2 class="text-2xl font-bold text-text-primary mb-6">Order Summary</h2><div id="pos-customer-display" class="hidden mb-4"></div><div class="space-y-3 text-lg"><div class="flex justify-between"><p>Subtotal:</p><p id="pos-subtotal" class="font-mono text-text-primary">$0.00</p></div><div id="pos-discount-row" class="flex justify-between hidden"><p>Discount:</p><p id="pos-discount" class="font-mono text-red-400">-$0.00</p></div><div class="flex justify-between"><p>Tax (${taxRate}%):</p><p id="pos-tax" class="font-mono text-text-primary">$0.00</p></div><div class="flex justify-between border-t border-border-color pt-4 mt-2 font-bold text-2xl"><p class="text-text-primary">Total:</p><p id="pos-total" class="font-mono text-accent">$0.00</p></div></div></div><div class="grid grid-cols-2 gap-3 mt-6"><button data-action="apply-total-discount" class="btn btn-secondary text-lg col-span-2">Apply Discount</button><button data-action="hold-sale" class="btn btn-secondary text-lg">Hold</button><button data-action="cancel-sale" class="btn btn-danger text-lg">Cancel</button><button data-action="process-payment" class="col-span-2 btn btn-primary text-xl tracking-wider py-4">PAY</button></div></div></div></div>`;
                        }
                    }
                    case 'inventory': return `<div id="inventory-view-container"></div>`;
                    case 'customers': return `<div><div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-text-primary">Customer Database</h1>${checkPermission('canManageCustomers') ? `<div class="flex items-center gap-2"><button data-action="add-customer" class="btn btn-primary"><i data-lucide="user-plus" class="w-5 h-5 mr-2"></i> Add Customer</button> <button data-action="open-import-modal" data-type="customers" class="btn btn-secondary"><i data-lucide="upload" class="w-5 h-5 mr-2"></i> Import Customers</button></div>` : ''}</div><div class="bg-bg-secondary/50 rounded-xl"><table class="table-pro"><thead><tr><th>Customer</th><th>Contact</th><th>Due Balance</th><th>Loyalty ID</th><th>Actions</th></tr></thead><tbody id="customers-table-body"></tbody></table></div></div>`;
                    case 'invoices': return `<div><div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-text-primary">Invoice History</h1></div><div class="bg-bg-secondary/50 rounded-xl"><table class="table-pro"><thead><tr><th>Invoice ID</th><th>Customer</th><th>Date</th><th>Total</th><th>Status</th><th>Actions</th></tr></thead><tbody id="invoices-table-body"></tbody></table></div></div>`;
                    case 'expenses': return `<div id="expenses-view-container"></div>`; // NEW
                      case 'payroll':
            // Return an empty container; initPayroll will fill it.
            return `<div id="payroll-view-container"></div>`; 
                    case 'reports': {
                        const canSeeAllReports = checkPermission('canSeeAllReports'); // MODIFIED
                        const headerTitle = canSeeAllReports ? 'Business Reports' : 'My Sales Report';
                        const headerSubtitle = canSeeAllReports ? 'Analyze trends and performance metrics.' : 'A summary of your sales performance.';
                        return `
                        <div class="space-y-6">
                            <!-- Reports Header -->
                            <div id="reports-header" class="flex flex-col md:flex-row justify-between md:items-center gap-4">
                                <div>
                                    <h1 class="text-3xl font-bold text-text-primary">${headerTitle}</h1>
                                    <p class="text-text-secondary">${headerSubtitle}</p>
                                </div>
                                <div class="flex items-center gap-4">
                                    ${canSeeAllReports ? `
                                    <div class="flex items-center gap-1 bg-bg-secondary p-1 rounded-lg border border-border-color">
                                        <button data-action="set-report-type" data-type="sales" class="report-type-btn active px-3 py-1.5 text-sm font-semibold rounded-md flex items-center gap-2"><i data-lucide="trending-up" class="w-4 h-4"></i>Sales</button>
                                        <button data-action="set-report-type" data-type="inventory" class="report-type-btn px-3 py-1.5 text-sm font-semibold rounded-md flex items-center gap-2"><i data-lucide="boxes" class="w-4 h-4"></i>${term.inventory}</button>
                                        <button data-action="set-report-type" data-type="customer" class="report-type-btn px-3 py-1.5 text-sm font-semibold rounded-md flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i>Customer</button>
                                        <button data-action="set-report-type" data-type="activity" class="report-type-btn px-3 py-1.5 text-sm font-semibold rounded-md flex items-center gap-2"><i data-lucide="history" class="w-4 h-4"></i>Activity</button>
                                    </div>
                                    ` : ''}
                                    <div class="relative" id="report-period-dropdown-container">
                                        <button id="report-period-dropdown-btn" class="btn btn-secondary w-full flex justify-between items-center text-sm p-2.5">
                                            <span id="selected-report-period-label">Last 30 Days</span>
                                            <i data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                                        </button>
                                        <div id="report-period-dropdown-menu" class="absolute top-full right-0 mt-2 w-56 bg-bg-secondary border border-border-color rounded-lg shadow-lg z-20 hidden p-1">
                                            <a href="#" class="report-period-item" data-action="set-report-period" data-period="today" data-label="Today">Today</a>
                                            <a href="#" class="report-period-item" data-action="set-report-period" data-period="yesterday" data-label="Yesterday">Yesterday</a>
                                            <a href="#" class="report-period-item" data-action="set-report-period" data-period="week" data-label="This Week">This Week</a>
                                            <a href="#" class="report-period-item" data-action="set-report-period" data-period="last7" data-label="Last 7 Days">Last 7 Days</a>
                                            <a href="#" class="report-period-item" data-action="set-report-period" data-period="month" data-label="This Month">This Month</a>
                                            <a href="#" class="report-period-item active" data-action="set-report-period" data-period="last30" data-label="Last 30 Days">Last 30 Days</a>
                                            <a href="#" class="report-period-item" data-action="set-report-period" data-period="year" data-label="This Year">This Year</a>
                                            <div class="h-px bg-border-color my-1"></div>
                                            <a href="#" class="report-period-item flex items-center justify-between" data-action="set-report-period" data-period="custom" data-label="Custom">
                                                <span>Custom Range</span>
                                                <i data-lucide="calendar" class="w-4 h-4"></i>
                                            </a>
                                        </div>
                                    </div>
                                     ${canSeeAllReports ? `
                                    <div class="relative" id="report-cashier-filter-container">
                                        <select id="report-cashier-filter" class="form-select bg-bg-secondary border-border-color text-sm p-2.5 h-full appearance-none">
                                            <option value="all">All Staff</option>
                                        </select>
                                    </div>
                                    ` : ''}
                                    <!-- NEW CODE START -->
                                    <div class="h-8 w-px bg-border-color hidden md:block"></div>
                                    <!-- REPLACED: Old buttons with a new, clean dropdown menu -->
                                    <div class="relative">
                                        <button data-action="toggle-action-menu" class="btn btn-secondary text-sm p-2.5 flex items-center" title="Export Data">
                                            <i data-lucide="download" class="w-4 h-4"></i>
                                            <span class="hidden lg:inline ml-2">Export</span>
                                            <i data-lucide="chevron-down" class="w-4 h-4 ml-1 hidden lg:inline"></i>
                                        </button>
                                        <div class="action-menu !w-56 z-20">
                                            <div class="action-menu-item" data-action="export-products">
                                                <i data-lucide="package" class="w-4 h-4"></i>
                                                <span>Export ${term.product}s</span>
                                            </div>
                                            <div class="action-menu-item" data-action="export-customers">
                                                <i data-lucide="users" class="w-4 h-4"></i>
                                                <span>Export Customers</span>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- END REPLACEMENT -->
                                </div>
                            </div>
                             <!-- Custom Date Picker -->
                            <div id="report-custom-range" class="hidden flex items-center justify-end gap-2 bg-bg-secondary p-3 rounded-lg border border-border-color">
                                <label for="report-start-date" class="text-sm">From:</label>
                                <input type="date" id="report-start-date" class="form-input text-sm p-2 h-auto bg-bg-tertiary">
                                <label for="report-end-date" class="text-sm">To:</label>
                                <input type="date" id="report-end-date" class="form-input text-sm p-2 h-auto bg-bg-tertiary">
                                <button id="report-apply-range" class="btn btn-primary text-sm py-2">Apply</button>
                            </div>
                            <!-- Reports Content Area -->
                            <div id="reports-container" class="space-y-6">
                                <!-- Dynamic report content will be injected here -->
                            </div>
                        </div>
                        <style> 
                            .report-type-btn.active { background-color: var(--accent); color: white; }
                            .report-period-item { display: block; padding: 8px 12px; font-size: 14px; border-radius: 6px; }
                            .report-period-item:hover { background-color: var(--bg-tertiary); }
                                .kpi-card { transition: all 0.3s ease; }
                                .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.2), 0 0 15px var(--accent-glow); }
                            </style>
                        `;
                    }
                   case 'barcode-generator': 
                        return `
                        <div class="space-y-6">
                            <div>
                                <h1 class="text-3xl font-bold text-text-primary">Advanced Barcode Generator</h1>
                                <p class="text-text-secondary mt-1">Create, customize, and print barcode sheets for your products.</p>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                                <!-- Left Panel: Configuration -->
                                <div class="lg:col-span-3 space-y-4">
                                    <div class="glass-pane p-4 rounded-xl">
                                        <div class="border-b border-border-color flex mb-4">
                                            <button data-barcode-tab="single" class="form-tab active px-4 py-2 text-sm font-medium">Single</button>
                                            <button data-barcode-tab="bulk" class="form-tab px-4 py-2 text-sm font-medium">Bulk Add</button>
                                        </div>
                                        <!-- Single Add Pane -->
                                        <div id="barcode-single-pane" class="space-y-3">
                                            <div>
                                                <label class="block text-sm font-medium mb-1">Search Product</label>
                                                <div class="relative">
                                                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-text-secondary"></i>
                                                    <input type="text" id="barcode-product-search" class="form-input w-full pl-9" placeholder="Find by name or SKU...">
                                                    <div id="barcode-product-search-results" class="absolute top-full left-0 right-0 mt-1 bg-bg-tertiary border border-border-color rounded-lg shadow-lg z-20 hidden max-h-48 overflow-y-auto"></div>
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-1">Product Name (for label)</label>
                                                <input type="text" id="barcode-productName" class="form-input w-full">
                                            </div>
                                             <div>
                                                <label class="block text-sm font-medium mb-1">Price (for label)</label>
                                                <input type="text" id="barcode-price" class="form-input w-full" placeholder="e.g. 19.99">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-1">Data to Encode (Barcode Number)</label>
                                                <input type="text" id="barcode-data" class="form-input w-full" placeholder="Enter product SKU, number, etc.">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-1">Text below Barcode</label>
                                                <input type="text" id="barcode-label" class="form-input w-full" placeholder="Optional text line">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-1">Quantity</label>
                                                <input type="number" id="barcode-quantity" value="1" min="1" class="form-input w-full">
                                            </div>
                                            <button id="add-to-sheet-btn" class="btn btn-primary w-full"><i data-lucide="plus" class="w-4 h-4 mr-2"></i>Add to Sheet</button>
                                        </div>
                                        <!-- Bulk Add Pane -->
                                        <div id="barcode-bulk-pane" class="hidden space-y-3">
                                            <label class="block text-sm font-medium mb-1">Barcode Data (one per line)</label>
                                            <textarea id="bulk-barcode-data" class="form-textarea w-full h-40" placeholder="SKU001\nSKU002\nSKU003"></textarea>
                                            <button id="bulk-add-to-sheet-btn" class="btn btn-primary w-full"><i data-lucide="list-plus" class="w-4 h-4 mr-2"></i>Add All to Sheet</button>
                                        </div>
                                    </div>
                                     <div class="glass-pane p-4 rounded-xl">
                                        <h3 class="text-base font-semibold text-text-primary mb-3">Barcode List</h3>
                                        <div id="barcode-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                                            <p class="text-xs text-text-secondary text-center">Add barcodes to see them here.</p>
                                        </div>
                                         <button id="clear-sheet-btn" class="btn btn-danger-secondary w-full text-sm mt-3"><i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>Clear Sheet</button>
                                    </div>
                                </div>

                                <!-- Middle Panel: Preview -->
                                <div class="lg:col-span-6">
                                    <div class="glass-pane p-4 rounded-xl">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-base font-semibold text-text-primary">Print Preview</h3>
                                             <div class="flex items-center gap-2">
                                                <button id="download-pdf-btn" class="btn btn-secondary btn-sm" title="Download as PDF"><i data-lucide="file-type" class="w-4 h-4 text-red-400"></i></button>
                                                <button id="download-png-btn" class="btn btn-secondary btn-sm" title="Download as PNG"><i data-lucide="image" class="w-4 h-4 text-blue-400"></i></button>
                                            </div>
                                        </div>
                                        <div id="barcode-sheet-container" class="bg-gray-300 p-4 overflow-auto aspect-[8.5/11]">
                                            <div id="barcode-sheet" class="grid bg-white">
                                                <!-- Barcodes will be rendered here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right Panel: Styling -->
                                <div class="lg:col-span-3 space-y-4">
                                    <div class="glass-pane p-4 rounded-xl">
                                        <h3 class="text-base font-semibold text-text-primary mb-3">Label Content</h3>
                                        <div class="space-y-3 text-sm border-b border-border-color pb-4 mb-4">
                                            <div class="flex items-center justify-between">
                                                <label for="barcode-showShopName" class="font-medium">Show Shop Name</label>
                                                <input type="checkbox" id="barcode-showShopName" checked class="form-checkbox h-5 w-5 rounded text-accent focus:ring-accent">
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <label for="barcode-showProductName" class="font-medium">Show Product Name</label>
                                                <input type="checkbox" id="barcode-showProductName" checked class="form-checkbox h-5 w-5 rounded text-accent focus:ring-accent">
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <label for="barcode-showPrice" class="font-medium">Show Price</label>
                                                <input type="checkbox" id="barcode-showPrice" checked class="form-checkbox h-5 w-5 rounded text-accent focus:ring-accent">
                                            </div>
                                        </div>
                                        <h3 class="text-base font-semibold text-text-primary mb-3">Barcode Format</h3>
                                        <div class="space-y-3 text-sm">
                                            <div>
                                                <label class="block font-medium mb-1">Format</label>
                                                <select id="barcode-format" class="form-select w-full">
                                                    <option value="CODE128" selected>CODE128</option><option value="CODE128A">CODE128A</option><option value="CODE128B">CODE128B</option><option value="CODE128C">CODE128C</option>
                                                    <option value="EAN13">EAN-13</option><option value="EAN8">EAN-8</option><option value="UPC">UPC</option>
                                                    <option value="CODE39">CODE39</option><option value="ITF14">ITF-14</option><option value="MSI">MSI</option><option value="pharmacode">Pharmacode</option>
                                                </select>
                                            </div>
                                            <div class="grid grid-cols-2 gap-3">
                                                 <div>
                                                    <label class="block font-medium mb-1">Bar Width</label>
                                                    <input type="number" id="barcode-width" value="2" min="1" max="4" step="0.1" class="form-input w-full">
                                                </div>
                                                <div>
                                                    <label class="block font-medium mb-1">Height</label>
                                                    <input type="number" id="barcode-height" value="60" min="20" max="200" class="form-input w-full">
                                                </div>
                                            </div>
                                            <div>
                                                 <label class="block font-medium mb-1">Text Font Size (pt)</label>
                                                 <input type="number" id="barcode-labelFontSize" value="10" min="6" max="24" class="form-input w-full">
                                            </div>
                                            <div class="flex items-center justify-between pt-2 border-t border-border-color">
                                                 <label for="barcode-displayValue" class="font-medium">Show Text in Barcode</label>
                                                 <input type="checkbox" id="barcode-displayValue" checked class="form-checkbox h-5 w-5 rounded text-accent focus:ring-accent">
                                            </div>
                                        </div>
                                    </div>
                                     <div class="glass-pane p-4 rounded-xl">
                                        <h3 class="text-base font-semibold text-text-primary mb-3">Sheet Layout</h3>
                                        <div class="space-y-3 text-sm">
                                            <div class="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label class="block font-medium mb-1">Columns</label>
                                                    <input type="number" id="sheet-columns" value="3" min="1" max="10" class="form-input w-full">
                                                </div>
                                                <div>
                                                    <label class="block font-medium mb-1">Gap (px)</label>
                                                    <input type="number" id="sheet-gap" value="8" min="0" max="50" class="form-input w-full">
                                                </div>
                                            </div>
                                             <div class="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label class="block font-medium mb-1">Margin X (px)</label>
                                                    <input type="number" id="sheet-marginX" value="10" min="0" max="50" class="form-input w-full">
                                                </div>
                                                <div>
                                                    <label class="block font-medium mb-1">Margin Y (px)</label>
                                                    <input type="number" id="sheet-marginY" value="10" min="0" max="50" class="form-input w-full">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <style>
                            #barcode-sheet svg { width: 100%; height: auto; }
                            .barcode-item { background: white; color: black; text-align: center; }
                        </style>
                        `;
                         case 'attributes':
                        return `
                        <div id="attributes-view-container" class="space-y-6">
                            <div>
                                <h1 class="text-3xl font-bold text-text-primary">Manage Attributes</h1>
                                <p class="text-text-secondary mt-1">Create and manage product options like size, color, or material.</p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-1">
                                    <div class="glass-pane p-6 rounded-xl">
                                        <h3 class="text-lg font-semibold text-text-primary mb-4">New Attribute</h3>
                                        <form id="add-attribute-form" class="space-y-3">
                                            <div>
                                                <label for="new-attribute-name" class="block text-sm font-medium mb-1">Attribute Name</label>
                                                <input type="text" id="new-attribute-name" class="form-input w-full" placeholder="e.g., Color, Size" required>
                                            </div>
                                            <div>
                                                <label for="new-attribute-values" class="block text-sm font-medium mb-1">Initial Values (optional)</label>
                                                <div class="variant-value-input-wrapper" onclick="this.querySelector('.variant-value-input').focus()">
                                                    <div id="new-attribute-tags-container"></div>
                                                    <input type="text" id="new-attribute-values" class="variant-value-input" placeholder="Add values and press Enter">
                                                </div>
                                                 <p class="text-xs text-text-secondary mt-1">Press Enter after each value.</p>
                                            </div>
                                            <button type="submit" class="btn btn-primary w-full">
                                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>Create Attribute
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                <div id="attributes-list-container" class="md:col-span-2 space-y-4">
                                    <!-- Attribute cards will be rendered here by initAttributes -->
                                    <p class="text-center text-text-secondary p-8">Loading attributes...</p>
                                </div>
                            </div>
                        </div>
                        `;
                    case 'claims': return `<div id="claims-view-container"></div>`; // NEW
                    case 'loyalty': return `<div id="loyalty-view-container"></div>`; // Container for initLoyalty
                    case 'staff': return `<div id="staff-view-container"></div>`;
                    case 'purchase-orders': return `<div id="purchase-orders-view-container"></div>`; // NEW
                    case 'suppliers': return `<div id="suppliers-view-container"></div>`; // NEW
                    case 'user-roles': return `<div id="user-roles-view-container"></div>`; // NEW
                    case 'settings': {
                        const isCashier = appState.session.userRole === 'cashier';

                        // Cashier-specific settings view
                        if (isCashier) {
                            // Cashiers ONLY see POS Layout options, and can save them.
                            return `<div id="settings-form">
                                <h1 class="text-3xl font-bold text-text-primary mb-6">Settings</h1>
                                <div class="space-y-8 max-w-4xl">
                                    <div class="glass-pane p-6 rounded-lg">
                                        <h2 class="text-xl font-semibold text-text-primary border-b border-border-color pb-4 mb-4 flex items-center gap-2">
                                            <i data-lucide="layout-template" class="text-accent"></i> POS Layout
                                        </h2>
                                        <p class="text-sm text-text-secondary mb-4">Choose the layout for your Point of Sale terminal.</p>
                                        <div id="pos-layout-selector"></div>
                                    </div>
                                    <div class="flex justify-end">
                                        <button data-action="save-settings" class="btn btn-primary">Save Changes</button>
                                    </div>
                                </div>
                            </div>`;
                        }

                        // Full settings view for Admin/Manager
                        const automationsConfig = {
                            inventoryOptimization: { icon: 'brain-circuit', color: 'indigo', title: 'Inventory Optimization AI', desc: 'Get AI suggestions on what to stock, promote, or discontinue.' },
                            dynamicPricing: { icon: 'trending-up', color: 'blue', title: 'Dynamic Pricing Suggestions', desc: 'Get AI-powered price suggestions based on sales data and trends.' },
                            endOfDayReports: { icon: 'file-clock', color: 'teal', title: 'Automated End-of-Day Reports', desc: 'Receive an automated sales summary via notification each day.' },
                            fraudDetection: { icon: 'shield-alert', color: 'red', title: 'AI-Powered Fraud Detection', desc: 'Monitor transactions for suspicious activity in real-time.' }
                        };
                        const automationSettings = appState.settings.automations || {};
                        const automationsHTML = Object.entries(automationsConfig).map(([id, config]) => {
                            const setting = automationSettings[id] || { enabled: false };
                            return `
                                <div class="flex items-center justify-between p-4 bg-bg-secondary rounded-lg border border-border-color/50">
                                    <div class="flex items-center mr-4 overflow-hidden">
                                        <i data-lucide="${config.icon}" class="w-6 h-6 text-${config.color}-400 mr-4 shrink-0"></i>
                                        <div>
                                            <h4 class="font-medium text-text-primary">${config.title}</h4>
                                            <p class="text-xs text-text-secondary truncate pr-2">${config.desc}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center shrink-0">
                                        <button data-action="open-automation-settings" data-automation-id="${id}" class="p-2 text-text-secondary hover:bg-bg-tertiary hover:text-accent transition-colors rounded-md" title="Configure ${config.title}">
                                            <i data-lucide="settings-2" class="w-5 h-5 pointer-events-none"></i>
                                        </button>
                                        <div class="w-px h-6 bg-border-color mx-2"></div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" data-action="toggle-automation" data-automation-id="${id}" class="sr-only peer" ${setting.enabled ? 'checked' : ''}>
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-accent/50 dark:peer-focus:ring-accent rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-accent"></div>
                                        </label>
                                    </div>
                                </div>
                            `;
                        }).join('');

                        let permissionsHTML = '';
                        // MODIFIED: This check should be for admin only, not a configurable permission.
                        if (appState.session.userRole === 'admin') {
                            permissionsHTML += `<div id="permissions-container" class="glass-pane p-6 rounded-lg">
                                <h2 class="text-xl font-semibold text-text-primary border-b border-border-color pb-4 mb-4">Role Permissions</h2>
                                <p class="text-sm text-text-secondary mb-6">Define what different roles can see and do. Note: Administrator permissions are fixed and cannot be changed.</p>
                                <div class="space-y-8">`;
                            
                            const rolesToDisplay = { manager: userRoles.manager, cashier: userRoles.cashier };

                            Object.entries(rolesToDisplay).forEach(([roleId, role]) => {
                                permissionsHTML += `<div>
                                    <h3 class="text-lg font-semibold text-text-primary capitalize mb-3">${roleId}</h3>
                                    <div class="bg-bg-secondary rounded-lg border border-border-color divide-y divide-border-color">
                                    ${Object.entries(role.permissions).map(([permissionId, perm]) => {
                                        if (typeof perm !== 'object' || perm === null) return ''; // Skip non-object permissions like canDoEverything
                                        const isChecked = appState.settings.permissions?.[roleId]?.permissions?.[permissionId]?.value ?? perm.value;
                                        return `<div class="flex items-center justify-between p-4">
                                                    <div>
                                                        <label for="perm-${roleId}-${permissionId}" class="font-medium text-sm text-text-primary cursor-pointer">${permissionId.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</label>
                                                        <p class="text-xs text-text-secondary">${perm.description}</p>
                                                    </div>
                                                    <input type="checkbox" id="perm-${roleId}-${permissionId}" data-action="toggle-permission" data-role-id="${roleId}" data-permission-id="${permissionId}" ${isChecked ? 'checked' : ''} class="form-checkbox h-5 w-5 rounded bg-bg-tertiary border-border-color-strong text-accent focus:ring-accent focus:ring-offset-bg-secondary cursor-pointer shrink-0">
                                                 </div>`;
                                    }).join('')}
                                    </div>
                                </div>`;
                            });
                            permissionsHTML += `</div></div>`;
                        }

                        const canManageSettings = checkPermission('canManageSettings');
                        const isAdmin = appState.session.userRole === 'admin';

                        return `<div id="settings-form"><h1 class="text-3xl font-bold text-text-primary mb-6">Settings</h1><div class="space-y-8 max-w-4xl">
                        
                        ${canManageSettings ? `
                            <div class="glass-pane p-6 rounded-lg"><h2 class="text-xl font-semibold text-text-primary border-b border-border-color pb-4 mb-4">Business Profile</h2><div id="business-type-selector"></div></div>
                        ` : ''}

                        ${isAdmin ? `
                            <div class="glass-pane p-6 rounded-lg">
                                <h2 class="text-xl font-semibold text-text-primary border-b border-border-color pb-4 mb-4">Store Information</h2>
                                <div class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Store Name</label><input type="text" name="name" value="${firestoreData.storeInfo.name || ''}" class="form-input w-full"></div><div><label class="block text-sm font-medium mb-1">Contact Phone</label><input type="text" name="contact" value="${firestoreData.storeInfo.contact || ''}" class="form-input w-full"></div></div>
                                    <div><label class="block text-sm font-medium mb-1">Store Address</label><input type="text" name="address" value="${firestoreData.storeInfo.address || ''}" class="form-input w-full"></div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Website</label><input type="text" name="website" value="${firestoreData.storeInfo.website || ''}" class="form-input w-full"></div><div><label class="block text-sm font-medium mb-1">Tax ID / BIN</label><input type="text" name="taxId" value="${firestoreData.storeInfo.taxId || ''}" class="form-input w-full"></div></div>
                                    <div><label class="block text-sm font-medium mb-1">Social Media Handle</label><input type="text" name="socials" value="${firestoreData.storeInfo.socials || ''}" class="form-input w-full" placeholder="@yourbusiness"></div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${canManageSettings ? `
                            <div class="glass-pane p-6 rounded-lg"> <h2 class="text-xl font-semibold text-text-primary border-b border-border-color pb-4 mb-4">Currency Settings</h2><div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Default Display Currency</label><select id="default-currency-selector" name="defaultCurrency" class="form-select w-full max-w-xs"></select><p class="text-xs text-text-secondary mt-1">This is the currency the POS will default to on launch.</p></div></div></div>
                        ` : ''}

                        ${isAdmin ? `
                            <div class="glass-pane p-6 rounded-lg"> <h2 class="text-xl font-semibold text-text-primary border-b border-border-color pb-4 mb-4">Tax Settings</h2><div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Default Tax Rate (%)</label><input type="number" name="taxRate" value="${appState.settings.taxRate ?? 0}" class="form-input w-full max-w-xs"></div></div></div>
                        ` : ''}

                        ${canManageSettings ? `
                            <div class="glass-pane p-6 rounded-lg"><h2 class="text-xl font-semibold text-text-primary border-b border-border-color pb-4 mb-4">Unit Settings</h2><div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Default Unit of Measurement</label><select id="default-unit-selector" name="defaultUnit" class="form-select w-full max-w-xs"></select><p class="text-xs text-text-secondary mt-1">This will be the pre-selected unit when creating a new product.</p></div></div></div>
                        ` : ''}
                        
                        ${isAdmin ? `
                            <div class="glass-pane p-6 rounded-lg"><h2 class="text-xl font-semibold text-text-primary border-b border-border-color pb-4 mb-4 flex items-center gap-2"><i data-lucide="sparkles" class="text-accent"></i> Smart Actions & Automation</h2><p class="text-sm text-text-secondary mb-6">Let AI handle the routine tasks. Enable smart automations to boost efficiency and drive sales.</p><div id="automations-container" class="space-y-4">${automationsHTML}</div></div>
                        ` : ''}
                        
                        
                        <div class="glass-pane p-6 rounded-lg"><h2 class="text-xl font-semibold text-text-primary border-b border-border-color pb-4 mb-4 flex items-center gap-2"><i data-lucide="layout-template" class="text-accent"></i> POS Layout</h2><p class="text-sm text-text-secondary mb-4">Choose the layout for your Point of Sale terminal.</p><div id="pos-layout-selector"></div></div>
                        
                        ${canManageSettings ? `
                            <div class="glass-pane p-6 rounded-lg"> <h2 class="text-xl font-semibold text-text-primary border-b border-border-color pb-4 mb-4">Receipt & Invoice Customization</h2><div id="receipt-template-selector"></div></div>
                            <div class="glass-pane p-6 rounded-lg"> <h2 class="text-xl font-semibold text-text-primary border-b border-border-color pb-4 mb-4">Receipt Footer Text</h2><p class="text-sm text-text-secondary mb-4">Customize the promotional text that appears at the bottom of your receipts. Use a new line for each separate message.</p><textarea name="receiptFooterText" class="form-textarea w-full h-24">${appState.settings.receiptFooterText || ''}</textarea></div>
                            <div class="flex justify-end"><button data-action="save-settings" class="btn btn-primary">Save Changes</button></div>
                        ` : ''}

                        </div></div>`;
                    }
                    default: return `<div class="text-center p-20 flex flex-col items-center"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div><h2 class="text-2xl font-semibold">Loading ${viewType}...</h2><p class="text-text-secondary mt-2">Connecting to the cloud.</p></div><style>.loader{border-top-color:var(--accent);animation:spin 1s linear infinite;}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>`;
                }
            }

             // --- NAVIGATION & TABBING SYSTEM ---
             const renderApp = () => {
                if (!appState.firebaseReady) return; // Don't render until Firebase is ready

                const profile = getCurrentProfile();
                const inventoryNavLink = document.querySelector('[data-view="inventory"] .nav-link-text');
                if(inventoryNavLink) {
                    inventoryNavLink.textContent = profile.terminology.inventory;
                }

                // Render Notification Badge
                const notificationBtn = document.querySelector('[data-action="open-notifications"]');
                if (notificationBtn) {
                    const unreadCount = firestoreData.notifications.filter(n => !n.read).length;
                    notificationBtn.classList.toggle('has-unread-notifications', unreadCount > 0);
                    let badge = notificationBtn.querySelector('.notification-badge');
                    if (unreadCount > 0) {
                        if (!badge) {
                            badge = document.createElement('span');
                            badge.className = 'notification-badge absolute top-0 right-0 flex h-4 w-4 items-center justify-center rounded-full bg-red-500 text-[10px] font-bold text-white';
                            notificationBtn.appendChild(badge);
                        }
                        badge.textContent = unreadCount;
                    } else if (badge) {
                        badge.remove();
                    }
                }

                // Render Currency Switcher
                const currencyMenu = document.getElementById('currency-menu');
                const currencyDisplay = document.getElementById('current-currency-display');
                if(currencyDisplay) {
                    currencyDisplay.textContent = appState.currentCurrency;
                }
                if(currencyMenu && firestoreData.storeInfo.currencies) {
                    currencyMenu.innerHTML = Object.entries(firestoreData.storeInfo.currencies).map(([code, currency]) => `
                        <div class="action-menu-item" data-action="set-currency" data-currency-code="${code}">
                            <span class="font-bold text-lg ${code === appState.currentCurrency ? 'text-accent' : ''}">${currency.symbol}</span>
                            <span>${code} - ${currency.name}</span>
                        </div>
                    `).join('');
                }

                const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);

                mainTabsContainer.classList.add('relative', 'flex'); // Ensure parent is relative and flex for alignment
                
                const tabsHTML = appState.tabs.map(tab => `
                    <button data-action="switch-tab" data-id="${tab.id}" class="main-tab flex items-center gap-2 px-4 py-3 text-sm font-medium hover:bg-bg-tertiary shrink-0 ${tab.id === appState.activeTabId ? 'active' : ''}">
                        ${tab.viewType === 'inventory' ? profile.terminology.inventory : tab.name}
                        <i data-lucide="x" data-action="close-tab" data-id="${tab.id}" class="w-4 h-4 rounded-full hover:bg-bg-tertiary ml-2"></i>
                    </button>
                `).join('');

                mainTabsContainer.innerHTML = `
                    <button id="main-tabs-scroll-left" class="hidden absolute left-0 top-0 bottom-0 z-10 flex items-center pl-2 pr-6 bg-gradient-to-r from-bg-primary to-transparent text-text-secondary hover:text-text-primary transition-opacity">
                        <i data-lucide="chevron-left" class="w-5 h-5 pointer-events-none"></i>
                    </button>
                    <div id="main-tabs-scroller" class="flex items-center overflow-x-auto scrollbar-hide">
                        ${tabsHTML}
                    </div>
                    <button id="main-tabs-scroll-right" class="hidden absolute right-0 top-0 bottom-0 z-10 flex items-center pr-2 pl-6 bg-gradient-to-l from-bg-primary to-transparent text-text-secondary hover:text-text-primary transition-opacity">
                        <i data-lucide="chevron-right" class="w-5 h-5 pointer-events-none"></i>
                    </button>
                `;

                const scroller = mainTabsContainer.querySelector('#main-tabs-scroller');
                const scrollLeftBtn = mainTabsContainer.querySelector('#main-tabs-scroll-left');
                const scrollRightBtn = mainTabsContainer.querySelector('#main-tabs-scroll-right');

                const handleMainTabsOverflow = () => {
                    if (!scroller) return;
                    // A slight delay to ensure browser has calculated widths
                    setTimeout(() => {
                        if (!scroller.isConnected) return; // Check if element is still in DOM
                        const isOverflowing = scroller.scrollWidth > scroller.clientWidth;
                        const isAtStart = scroller.scrollLeft < 5;
                        const isAtEnd = scroller.scrollLeft + scroller.clientWidth >= scroller.scrollWidth - 5;
                        scrollLeftBtn?.classList.toggle('hidden', !isOverflowing || isAtStart);
                        scrollRightBtn?.classList.toggle('hidden', !isOverflowing || isAtEnd);
                    }, 50);
                };

                if(scroller && scrollLeftBtn && scrollRightBtn) {
                    scrollLeftBtn.addEventListener('click', () => scroller.scrollBy({ left: -250, behavior: 'smooth' }));
                    scrollRightBtn.addEventListener('click', () => scroller.scrollBy({ left: 250, behavior: 'smooth' }));
                    scroller.addEventListener('scroll', handleMainTabsOverflow);
                    if ('ResizeObserver' in window) {
                       new ResizeObserver(handleMainTabsOverflow).observe(scroller);
                    } else {
                        // Fallback for browsers without ResizeObserver
                        window.addEventListener('resize', handleMainTabsOverflow);
                    }
                }
                
                handleMainTabsOverflow();

                if (activeTab) {
                    workspaceContent.innerHTML = `<div class="view-pane">${getViewContent(activeTab.viewType)}</div>`;
                    viewInitializers[activeTab.viewType]?.(workspaceContent.firstElementChild);
                } else {
                    workspaceContent.innerHTML = `<div class="text-center p-20 flex flex-col items-center"><i data-lucide="layout-template" class="w-20 h-20 text-border-color-strong mb-6"></i><h2 class="text-2xl font-semibold">Workspace is empty</h2><p class="text-text-secondary mt-2">Select an item from the sidebar to open a new tab.</p></div>`;
                }
                
                 document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.toggle('active-view', activeTab && link.dataset.view === activeTab.viewType);
                });

                lucide.createIcons();
                saveState(); // Save state on every render
            };

            const openOrSwitchTab = (viewType) => {
                if (!appState.firebaseReady) { showToast("System is still loading...", "info"); return; }
                
                // --- NEW: Permission Gate ---
                const requiredPermission = viewPermissionMap[viewType];
                let hasPermission = true;

                if (requiredPermission) {
                    if (Array.isArray(requiredPermission)) {
                        hasPermission = requiredPermission.some(p => checkPermission(p));
                    } else {
                        hasPermission = checkPermission(requiredPermission);
                    }
                }
                
                // Special case for settings for cashiers, who have a custom view.
                if (viewType === 'settings' && appState.session.userRole === 'cashier') {
                    hasPermission = true;
                }

                if (!hasPermission) {
                    showToast("You do not have permission to access this page.", "error");
                    return; // Abort if no permission
                }
                // --- END NEW ---

                const existingTab = appState.tabs.find(t => t.viewType === viewType);

                if (existingTab) {
                    appState.activeTabId = existingTab.id;
                } else {
                    const newTabId = `tab_${Date.now()}`;
                    let name = viewType.charAt(0).toUpperCase() + viewType.slice(1);
                    if (viewType === 'inventory') {
                        name = getCurrentProfile().terminology.inventory;
                    }
                    appState.tabs.push({ id: newTabId, name: name, viewType: viewType });
                    appState.activeTabId = newTabId;
                }
                renderApp();
                
                // Scroll the active tab into view if it's not fully visible.
                setTimeout(() => {
                    const scroller = document.getElementById('main-tabs-scroller');
                    const activeTabElement = scroller?.querySelector(`[data-id="${appState.activeTabId}"]`);
                    if (scroller && activeTabElement) {
                        const scrollerRect = scroller.getBoundingClientRect();
                        const tabRect = activeTabElement.getBoundingClientRect();

                        const isFullyVisible = tabRect.left >= scrollerRect.left && tabRect.right <= scrollerRect.right;
                        
                        if (!isFullyVisible) {
                            activeTabElement.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                        }
                    }
                }, 100);
            };
            
            // --- FIREBASE DATA LISTENERS ---
        const initFirebaseListeners = () => {
    // StoreInfo, UoM, and Notifications are needed by everyone for basic app function
    const unsubStore = onSnapshot(storeRef, (docSnap) => {
        if(docSnap.exists()){
            const data = docSnap.data();
            const oldStoreName = firestoreData.storeInfo.name; // Capture old name
            firestoreData.storeInfo = data;
            
            // --- FIX START: Preserve user-specific POS layout preference ---
            // The onSnapshot listener for the store document reloads all store-wide settings.
            // We must preserve the user's layout choice, which is loaded once on login and stored in appState,
            // to prevent it from being overwritten by the store's default layout.
            const userPosLayoutPreference = appState.settings.posLayout;
            // --- FIX END ---
            
            // NEW: If store name changed, update session data and re-render switcher for instant UI update.
            if (appState.firebaseReady && oldStoreName && oldStoreName !== data.name) {
                const storeInSession = appState.session.availableStores.find(s => s.id === appState.session.storeId);
                if (storeInSession) {
                    storeInSession.name = data.name;
                }
                renderStoreSwitcher();
            }
            
            const firestoreSettings = data.settings || {};
            
            const basePermissions = JSON.parse(JSON.stringify(userRoles));
            const storedPermissions = firestoreSettings.permissions || {};

            for (const roleId in basePermissions) {
                if (storedPermissions[roleId]) {
                    for (const permId in basePermissions[roleId].permissions) {
                        const basePerm = basePermissions[roleId].permissions[permId];
                        const storedPerm = storedPermissions[roleId].permissions?.[permId];

                        if (typeof basePerm === 'object' && basePerm !== null &&
                            typeof storedPerm === 'object' && storedPerm !== null &&
                            storedPerm.value !== undefined) {
                            
                            basePerm.value = storedPerm.value;
                        }
                    }
                }
            }

            appState.settings = {
                ...appState.settings,
                ...firestoreSettings,
                automations: {
                    ...(appState.settings.automations || {}),
                    ...(firestoreSettings.automations || {})
                },
                permissions: basePermissions 
            };
            
            // --- FIX START: Restore the user's POS layout preference ---
            // After merging the latest store settings, we restore the user's specific preference.
            appState.settings.posLayout = userPosLayoutPreference;
            // --- FIX END ---

            appState.customProfiles = data.customProfiles || {};
            appState.currentCurrency = appState.settings.defaultCurrency || data.defaultDisplayCurrency || data.baseCurrency;
            
            // --- REFACTORED: REMOVED SUBSCRIPTION CHECK, ADDED STORE ENABLED CHECK ---
            if(appState.firebaseReady) { // Only run after initial data load is complete
                // NEW: Check if the currently active store has been disabled in real-time.
                const isEnabled = data.isEnabled !== false; // Default to true if not set
                const isCurrentlyLocked = !!document.getElementById('lock-screen-overlay');

                if (!isEnabled && !isCurrentlyLocked) {
                    showLockScreen('store_disabled');
                    return; // Stop further rendering for this store
                } else if (isEnabled && isCurrentlyLocked) {
                    // If the store was re-enabled, reload the page to grant access.
                    const lockScreenTitle = document.querySelector('#lock-screen-overlay h1');
                    if(lockScreenTitle && lockScreenTitle.textContent === 'Store Disabled') {
                        window.location.reload();
                    }
                }
            
                // --- If not locked, proceed with normal UI updates ---
                const didRender = handlePermissionChange();
                updateUIPermissions(); 
                if (!didRender) {
                    renderApp(); // Re-render to reflect any other settings changes (like currency, etc.)
                }
            }
        } // This brace closes the 'if(docSnap.exists())' block
    });
    activeListeners.push(unsubStore);

    const unsubUOM = onSnapshot(uomRef, (snapshot) => {
        firestoreData.unitsOfMeasurement = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
        if(appState.firebaseReady && appState.activeTabId) {
             const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
             if (activeTab?.viewType === 'settings' || activeTab?.viewType === 'inventory') {
                 renderApp();
             }
        }
    });
    activeListeners.push(unsubUOM);

    const unsubNotifications = onSnapshot(query(notificationsRef), (snapshot) => {
        let needsRender = false;
        const currentUserRole = appState.session.userRole; // Get current user's role

        snapshot.docChanges().forEach(change => {
            const notification = { ...change.doc.data(), id: change.doc.id };
            
            // NEW: Role-based filtering. Only process notifications meant for the current user.
            const targetRoles = notification.targetRoles || ['admin', 'manager']; // Default to admin/manager if not specified
            if (!currentUserRole || !targetRoles.includes(currentUserRole)) {
                return; // Skip this notification if the user's role is not in the target list
            }

            if (change.type === "added") {
                if (!firestoreData.notifications.some(n => n.id === notification.id)) {
                    firestoreData.notifications.push(notification);
                    needsRender = true;
                    const notificationDate = new Date(notification.date);
                    if (notificationDate > sessionStartTime) {
                        showToast(notification.message.replace(/<strong>/g, '').replace(/<\/strong>/g, ''), notification.type);
                        playNotificationSound();
                    }
                }
            }
            if (change.type === "modified") {
                const index = firestoreData.notifications.findIndex(n => n.id === notification.id);
                if (index > -1) { firestoreData.notifications[index] = notification; needsRender = true; }
            }
            if (change.type === "removed") {
                const initialLength = firestoreData.notifications.length;
                firestoreData.notifications = firestoreData.notifications.filter(n => n.id !== notification.id);
                if (firestoreData.notifications.length !== initialLength) { needsRender = true; }
            }
        });
        if (needsRender) {
            firestoreData.notifications.sort((a, b) => new Date(b.date) - new Date(a.date));
            if (appState.firebaseReady) { renderApp(); }
        }
    });
    activeListeners.push(unsubNotifications);
    // --- Loyalty Settings Listener ---
if (checkPermission('canManageLoyalty')) { // Ensure only authorized users listen
    const unsubLoyaltySettings = onSnapshot(loyaltySettingsRef, (docSnap) => {
        firestoreData.loyaltySettings = docSnap.exists() ? docSnap.data() : { // Provide defaults if missing
            enabled: true, pointsPerDollar: 1, rewardThreshold: 100, rewardValue: 5,
            rewardType: 'fixed_discount', earnOnTax: false, redeemLimitPerOrder: 1
        };
        // Re-render loyalty view if it's the active tab
        if (appState.firebaseReady && appState.activeTabId) {
            const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
            if (activeTab?.viewType === 'loyalty') {
                renderApp(); // Or call initLoyalty directly if renderApp causes issues
            }
        }
    });
    activeListeners.push(unsubLoyaltySettings);
}
    // --- Permission Gated Listeners ---
    // Products are needed for POS, Inventory management, and Dashboard reports
    if (checkPermission('canUsePOS') || checkPermission('canManageInventory') || checkPermission('canAccessDashboard')) {
        const unsubProducts = onSnapshot(productsRef, (snapshot) => {
            firestoreData.products = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            
            if (appState.firebaseReady && appState.activeTabId) {
                const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
                
                // UX Enhancement: If a product update happens while on the variant management screen,
                // refresh that specific view instead of redirecting to the main inventory list.
                if (activeTab?.viewType === 'inventory') {
                    const inventoryContainer = document.querySelector('#inventory-view-container');
                    const backButton = inventoryContainer?.querySelector('[data-action="back-to-inventory"]');
                    const generateVariantsBtn = inventoryContainer?.querySelector('[data-action="generate-variants"]');

                    // This combination of buttons is unique to the variant management view.
                    if (backButton && generateVariantsBtn) {
                        const productId = generateVariantsBtn.dataset.parentId;
                        if (productId) {
                            const parentProduct = firestoreData.products.find(p => p.id === productId);
                            if (parentProduct && parentProduct.hasVariants) {
                                // Re-render just the variant management view.
                                renderVariantManagementView(productId, inventoryContainer);
                                return; // IMPORTANT: Prevent the default renderApp() call.
                            }
                        }
                    }
                }
                
                // Default behavior for all other cases.
                renderApp();
            }
        });
        activeListeners.push(unsubProducts);
    }

    // Customers are needed for POS and Customer management
    if (checkPermission('canManageCustomers') || checkPermission('canUsePOS')) {
        const unsubCustomers = onSnapshot(customersRef, (snapshot) => {
            firestoreData.customers = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            if(appState.firebaseReady && appState.activeTabId) renderApp();
        });
        activeListeners.push(unsubCustomers);
    }

    // --- MODIFIED INVOICE LISTENER ---
    // If a user can see all reports (i.e., Admin/Manager), fetch all invoices.
    // Otherwise (i.e., a Cashier), fetch only the invoices where their UID is the cashierId.
    // This is the core fix for the data segregation issue.
    if (checkPermission('canSeeAllReports')) {
        const unsubInvoices = onSnapshot(invoicesRef, (snapshot) => {
            firestoreData.invoices = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            if(appState.firebaseReady && appState.activeTabId) renderApp();
        });
        activeListeners.push(unsubInvoices);
    } else {
        // This block will now correctly execute for cashiers.
        const currentUserId = appState.session.currentUser?.uid;
        if (currentUserId) {
            const invoicesQuery = query(invoicesRef, where("cashierId", "==", currentUserId));
            const unsubInvoices = onSnapshot(invoicesQuery, (snapshot) => {
                firestoreData.invoices = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                if(appState.firebaseReady && appState.activeTabId) renderApp();
            });
            activeListeners.push(unsubInvoices);
        } else {
            // If for some reason we don't have a user ID, ensure no invoices are loaded.
            firestoreData.invoices = [];
             if(appState.firebaseReady && appState.activeTabId) renderApp();
        }
    }
    if (checkPermission('canManageQuotations')) {
    const unsubQuotations = onSnapshot(query(quotationsRef), (snapshot) => {
        firestoreData.quotations = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
        if(appState.firebaseReady) {
            const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
            if (activeTab?.viewType === 'quotations') {
                renderApp();
            }
        }
    });
    activeListeners.push(unsubQuotations);
}
    // Staff list is needed for staff management AND for filtering reports.
    if (checkPermission('canManageStaff') || checkPermission('canAccessReports') || checkPermission('canEditCashierDetails')) {
        const unsubStaff = onSnapshot(staffRef, (snapshot) => {
            // NEW: Real-time check for current user's status change
            const currentUser = appState.session.currentUser;
            if(currentUser) {
                snapshot.docChanges().forEach(change => {
                    // Handle if the current user's record is modified (e.g., deactivated)
                    if (change.type === "modified" && change.doc.id === currentUser.uid) {
                        const newStatus = change.doc.data().status;
                        // If user is made inactive in the CURRENT store, force a reload.
                        // The onAuthStateChanged logic will then find another active store or log them out.
                        if (newStatus === 'inactive' && appState.session.userRole) { // Check role to avoid logout loop
                            showToast("Your account has been deactivated in this store. Finding an active session...", "warning");
                            setTimeout(() => window.location.reload(), 2500);
                        }
                    }
                    // NEW: Handle if the current user is removed from the current store.
                    if (change.type === "removed" && change.doc.id === currentUser.uid) {
                        showToast("Your access to this store has been revoked. Finding an active session...", "warning");
                        // Force a reload. onAuthStateChanged will handle redirection or logout.
                        setTimeout(() => window.location.reload(), 2500);
                    }
                });
            }
            
            firestoreData.staff = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            if(appState.firebaseReady) {
                 const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
                 // Only re-render if the user is on the staff or reports page
                 if (activeTab?.viewType === 'staff' || activeTab?.viewType === 'reports') {
                     renderApp();
                 }
            }
        });
        activeListeners.push(unsubStaff);
    }

    // NEW: Expenses listener, only for users who can manage them.
    if (checkPermission('canManageExpenses')) {
        const unsubExpenses = onSnapshot(query(expensesRef), (snapshot) => {
            firestoreData.expenses = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            if(appState.firebaseReady) {
                 const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
                 if (activeTab?.viewType === 'expenses') {
                     renderApp();
                 }
            }
        });
        activeListeners.push(unsubExpenses);
    }

    // NEW: Suppliers & Purchase Orders listeners
    if (checkPermission('canManageSuppliers') || checkPermission('canViewPurchaseOrders')) {
        const unsubSuppliers = onSnapshot(query(suppliersRef), (snapshot) => {
            firestoreData.suppliers = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            if(appState.firebaseReady) {
                 const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
                 if (activeTab?.viewType === 'purchase-orders' || activeTab?.viewType === 'suppliers' || activeTab?.viewType === 'inventory') {
                     renderApp();
                 }
            }
        });
        activeListeners.push(unsubSuppliers);

        const unsubPurchaseOrders = onSnapshot(query(purchaseOrdersRef), (snapshot) => {
            firestoreData.purchaseOrders = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            if(appState.firebaseReady) {
                 const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
                 if (activeTab?.viewType === 'purchase-orders') {
                     renderApp();
                 }
            }
        });
        activeListeners.push(unsubPurchaseOrders);
    }

    // --- FIX START: Add Listeners for Warranties and Claims ---
    // This will listen for new warranties and claims and update the app in real-time.
    if (checkPermission('canManageWarranties')) {
        const unsubWarranties = onSnapshot(query(warrantiesRef), (snapshot) => {
            firestoreData.warranties = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            if(appState.firebaseReady) {
                const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
                if (activeTab?.viewType === 'claims') {
                    renderApp(); // This will re-initialize the claims view
                }
            }
        });
        activeListeners.push(unsubWarranties);

        const unsubClaims = onSnapshot(query(claimsRef), (snapshot) => {
            firestoreData.claims = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            if(appState.firebaseReady) {
                 const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
                 if (activeTab?.viewType === 'claims') {
                     renderApp(); // This will re-initialize the claims view
                 }
            }
        });
        activeListeners.push(unsubClaims);
    }
    // --- FIX END ---
    // Add this inside initFirebaseListeners, preferably near the Invoice listener
    if (checkPermission('canManageEMI')) {
        const unsubEMI = onSnapshot(query(emiSchedulesRef), (snapshot) => {
            firestoreData.emiSchedules = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            if(appState.firebaseReady) {
                 const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
                 if (activeTab?.viewType === 'emi-sales') {
                     renderApp();
                 }
            }
        });
        activeListeners.push(unsubEMI);
    }
    // NEW: Audit Log listener, only for users who can see reports
    if (checkPermission('canAccessReports')) {
        const unsubAudit = onSnapshot(query(auditLogRef), (snapshot) => {
            firestoreData.auditLog = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            if(appState.firebaseReady) {
                 const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
                 // Only re-render if the user is on the reports page and looking at the activity tab
                 if (activeTab?.viewType === 'reports' && appState.viewStates.reports.reportType === 'activity') {
                     renderApp();
                 }
            }
        });
        activeListeners.push(unsubAudit);
    }
        // --- NEW: Payroll Listeners (Settings, Runs, Payslips) ---
            if (checkPermission('canManagePayroll')) {
                // Settings listener (already seemed correct, just ensuring it's here)
                const unsubPayrollSettings = onSnapshot(payrollSettingsRef, (docSnap) => {
                    firestoreData.payrollSettings = docSnap.exists() ? docSnap.data() : { payFrequency: 'monthly', payDay: 1, defaultTaxRate: 15, defaultOvertimeRate: 1.5 }; // Default if missing
                     if(appState.firebaseReady) {
                        const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
                        if (activeTab?.viewType === 'payroll') {
                            renderApp(); // Re-render payroll view if settings change
                        }
                    }
                });
                activeListeners.push(unsubPayrollSettings);

                // *** ADDED: Real-time listener for Payroll Runs ***
                const unsubPayrollRuns = onSnapshot(query(payrollRunsRef), (snapshot) => {
                    firestoreData.payrollRuns = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    if(appState.firebaseReady) {
                        const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
                        if (activeTab?.viewType === 'payroll') {
                            renderApp(); // Re-render payroll view if history changes
                        }
                    }
                });
                activeListeners.push(unsubPayrollRuns);

                // Payslips listener (optional, depending if needed live outside of run details)
                // If payslips are only viewed in the context of a run detail, a listener might be overkill.
                // const unsubPayslips = onSnapshot(query(payslipsRef), (snapshot) => {
                //     firestoreData.payslips = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                //     // Potentially re-render if needed
                // });
                // activeListeners.push(unsubPayslips);
            }
};

            // NEW helper function to centralize settings processing from a Firestore doc snapshot
            const processStoreSettings = (docSnap) => {
                if (!docSnap.exists()) {
                    console.error("Store document does not exist after attempt to load.");
                    return;
                }
                console.log("Processing store settings and permissions...");
                const data = docSnap.data();
                firestoreData.storeInfo = data;
                const firestoreSettings = data.settings || {};
                
                const basePermissions = JSON.parse(JSON.stringify(userRoles));
                const storedPermissions = firestoreSettings.permissions || {};

                // Deep merge permissions from Firestore into our base template
                for (const roleId in basePermissions) {
                    if (storedPermissions[roleId]) {
                        for (const permId in basePermissions[roleId].permissions) {
                            const basePerm = basePermissions[roleId].permissions[permId];
                            const storedPerm = storedPermissions[roleId].permissions?.[permId];

                            if (typeof basePerm === 'object' && basePerm !== null &&
                                typeof storedPerm === 'object' && storedPerm !== null &&
                                storedPerm.value !== undefined) {
                                
                                basePerm.value = storedPerm.value;
                            }
                        }
                    }
                }

                // Update appState with all settings
                appState.settings = {
                    ...appState.settings,
                    ...firestoreSettings,
                    automations: {
                        ...(appState.settings.automations || {}),
                        ...(firestoreSettings.automations || {})
                    },
                    permissions: basePermissions 
                };
                appState.customProfiles = data.customProfiles || {};
                appState.currentCurrency = appState.settings.defaultCurrency || data.defaultDisplayCurrency || data.baseCurrency;

                // Also populate the session permissions for the current user
                const currentUserRole = appState.session.userRole;
                if (currentUserRole && basePermissions[currentUserRole]) {
                    appState.session.userPermissions = basePermissions[currentUserRole].permissions || {};
                }
                console.log("Permissions successfully processed for role:", currentUserRole);
                
                // NEW: Check if any open tabs need to be closed due to permission changes
                handlePermissionChange();
            };

            // --- REWRITTEN: LOGIN & SIGNUP SCREEN ---
            const renderLoginScreen = async () => {
                const loginContainer = document.getElementById('login-container');
                if (!loginContainer) return;

                loginContainer.innerHTML = `
                    <div class="w-full max-w-md">
                        <div class="text-center mb-8">
                             <h1 class="text-3xl font-bold text-text-primary">CashShilpo</h1>
                             <p class="text-text-secondary">The smart point of sale for modern businesses.</p>
                        </div>

                        <div id="auth-form-container" class="p-8 space-y-6 rounded-xl login-card">
                            <!-- This will be filled with either login or signup form -->
                        </div>
                    </div>
                `;

                const formContainer = loginContainer.querySelector('#auth-form-container');

                const showLoginForm = () => {
                    formContainer.innerHTML = `
                        <div class="text-center">
                            <h1 class="text-2xl font-bold text-text-primary">Welcome Back</h1>
                            <p class="text-text-secondary">Sign in to manage your store.</p>
                        </div>
                        <form id="login-form" class="space-y-4">
                            <div>
                                <label for="email" class="block text-sm font-medium text-text-secondary">Email address</label>
                                <input id="email" name="email" type="email" autocomplete="email" required class="form-input w-full mt-1">
                            </div>
                            <div>
                                <label for="password" class="block text-sm font-medium text-text-secondary">Password</label>
                                <input id="password" name="password" type="password" autocomplete="current-password" required class="form-input w-full mt-1">
                            </div>
                            <p id="auth-error" class="text-red-400 text-sm hidden"></p>
                            <div>
                                <button type="submit" class="btn btn-primary w-full text-base py-3">Sign In</button>
                            </div>
                        </form>
                        <div class="text-center text-sm text-text-secondary">
                            Don't have an account? <a href="#" id="show-signup-form" class="font-medium text-accent hover:underline">Sign up</a>
                        </div>
                    `;
                    const form = formContainer.querySelector('#login-form');
                    const errorEl = formContainer.querySelector('#auth-error');
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        errorEl.classList.add('hidden');
                        try {
                            await signInWithEmailAndPassword(auth, form.email.value, form.password.value);
                            // onAuthStateChanged will handle the rest.
                        } catch (error) {
                            console.error("Login error:", error);
                            errorEl.textContent = error.message.replace('Firebase: ', '');
                            errorEl.classList.remove('hidden');
                        }
                    });
                    formContainer.querySelector('#show-signup-form').addEventListener('click', (e) => {
                        e.preventDefault();
                        showSignupForm();
                    });
                };

                const showSignupForm = () => {
                    formContainer.innerHTML = `
                        <div class="text-center">
                            <h1 class="text-2xl font-bold text-text-primary">Create Your Account</h1>
                            <p class="text-text-secondary">Get started with your new business POS.</p>
                        </div>
                        <form id="signup-form" class="space-y-4">
                            <div>
                                <label for="businessName" class="block text-sm font-medium text-text-secondary">Business Name</label>
                                <input id="businessName" name="businessName" type="text" required class="form-input w-full mt-1">
                            </div>
                            <div>
                                <label for="name" class="block text-sm font-medium text-text-secondary">Your Full Name</label>
                                <input id="name" name="name" type="text" required class="form-input w-full mt-1">
                            </div>
                            <div>
                                <label for="email" class="block text-sm font-medium text-text-secondary">Email address</label>
                                <input id="email" name="email" type="email" autocomplete="email" required class="form-input w-full mt-1">
                            </div>
                            <div>
                                <label for="password" class="block text-sm font-medium text-text-secondary">Password</label>
                                <input id="password" name="password" type="password" autocomplete="new-password" required class="form-input w-full mt-1">
                            </div>
                            <p id="auth-error" class="text-red-400 text-sm hidden"></p>
                            <div>
                                <button type="submit" class="btn btn-primary w-full text-base py-3">Create Account</button>
                            </div>
                        </form>
                         <div class="text-center text-sm text-text-secondary">
                            Already have an account? <a href="#" id="show-login-form" class="font-medium text-accent hover:underline">Log in</a>
                        </div>
                    `;
                    const form = formContainer.querySelector('#signup-form');
                    const errorEl = formContainer.querySelector('#auth-error');

                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        errorEl.classList.add('hidden');
                        const businessName = form.businessName.value;
                        const fullName = form.name.value;
                        const email = form.email.value;
                        const password = form.password.value;
                        
                        try {
                            // 1. Create user in Auth
                            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                            const user = userCredential.user;
                            
                            // It's good practice to set the display name in Auth as well
                            await updateProfile(user, { displayName: fullName });
                            
                            // 2. Create the store and all associated data
                            await createNewStoreForUser(user, businessName);

                            // Signup is complete. onAuthStateChanged will now pick up the logged-in user and proceed.
                            showToast('Account created successfully! Welcome.', 'success');
                            
                            // Force a reload to ensure the onAuthStateChanged listener runs with a clean state and all user data available.
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);

                        } catch (error) {
                            console.error("Signup error:", error);
                            errorEl.textContent = error.message.replace('Firebase: ', '');
                            errorEl.classList.remove('hidden');
                        }
                    });

                    formContainer.querySelector('#show-login-form').addEventListener('click', (e) => {
                        e.preventDefault();
                        showLoginForm();
                    });
                };
                
                showLoginForm(); // Start with the login form
                lucide.createIcons();
            };
function initBarcodeGenerator(pane) {
    // --- State management for the generator ---
    let barcodeSheetItems = [];
    let barcodeSettings = {
        format: 'CODE128',
        width: 2,
        height: 60,
        displayValue: true,
        labelFontSize: 10,
        showShopName: true,
        showProductName: true,
        showPrice: true,
    };
    let sheetLayout = {
        columns: 3,
        gap: 8,
        marginX: 10,
        marginY: 10,
    };

    // --- DOM Element References ---
    const dataInput = pane.querySelector('#barcode-data');
    const labelInput = pane.querySelector('#barcode-label');
    const productNameInput = pane.querySelector('#barcode-productName');
    const priceInput = pane.querySelector('#barcode-price');
    const addToSheetBtn = pane.querySelector('#add-to-sheet-btn');
    const barcodeListContainer = pane.querySelector('#barcode-list');
    const clearSheetBtn = pane.querySelector('#clear-sheet-btn');
    const sheetContainer = pane.querySelector('#barcode-sheet');
    const productSearchInput = pane.querySelector('#barcode-product-search');
    const productSearchResults = pane.querySelector('#barcode-product-search-results');

    // --- NEW: Elements for manual serial number entry ---
    const isSerializedCheckbox = document.createElement('input');
    isSerializedCheckbox.type = 'checkbox';
    isSerializedCheckbox.id = 'barcode-isSerialized';
    isSerializedCheckbox.className = 'form-checkbox h-5 w-5 rounded text-accent focus:ring-accent';

    const serialsWrapper = document.createElement('div');
    serialsWrapper.id = 'barcode-serials-wrapper';
    serialsWrapper.className = 'hidden';
    serialsWrapper.innerHTML = `
        <label class="block text-sm font-medium mb-1">Serial Numbers (one per line)</label>
        <textarea id="barcode-serials" class="form-textarea w-full h-24 font-mono text-xs" placeholder="SN001\nSN002\nSN003"></textarea>
    `;
    const serialsTextarea = serialsWrapper.querySelector('#barcode-serials');
    
    // Find the original quantity input and its parent to create a wrapper
    const quantityInput = pane.querySelector('#barcode-quantity');
    const quantityWrapper = document.createElement('div');
    quantityWrapper.id = 'barcode-quantity-wrapper';
    if (quantityInput) {
        const quantityLabel = pane.querySelector('label[for="barcode-quantity"]');
        if (quantityLabel) quantityWrapper.appendChild(quantityLabel);
        quantityWrapper.appendChild(quantityInput);
    }
    
    // Inject the new elements into the 'single' pane
    const singlePane = pane.querySelector('#barcode-single-pane');
    if (singlePane) {
        const checkboxContainer = document.createElement('div');
        checkboxContainer.className = 'flex items-center justify-between mt-3 pt-3 border-t border-border-color';
        checkboxContainer.innerHTML = `<label for="barcode-isSerialized" class="font-medium text-sm cursor-pointer">Track by Serial Number</label>`;
        checkboxContainer.appendChild(isSerializedCheckbox);
        
        // Find the quantity input's original position to insert the new elements correctly
        const originalQuantityInput = singlePane.querySelector('#barcode-quantity');
        if (originalQuantityInput) {
             originalQuantityInput.parentElement.replaceWith(quantityWrapper);
        }
        
        singlePane.insertBefore(serialsWrapper, addToSheetBtn);
        singlePane.insertBefore(checkboxContainer, serialsWrapper);
    }
    // --- END NEW ---

    // Tabs
    const bulkPane = pane.querySelector('#barcode-bulk-pane');

    // Bulk inputs
    const bulkDataInput = pane.querySelector('#bulk-barcode-data');
    const bulkAddBtn = pane.querySelector('#bulk-add-to-sheet-btn');

    // Styling & Layout inputs
    const formatSelect = pane.querySelector('#barcode-format');
    const widthInput = pane.querySelector('#barcode-width');
    const heightInput = pane.querySelector('#barcode-height');
    const labelFontSizeInput = pane.querySelector('#barcode-labelFontSize');
    const displayValueCheckbox = pane.querySelector('#barcode-displayValue');
    const showShopNameCheckbox = pane.querySelector('#barcode-showShopName');
    const showProductNameCheckbox = pane.querySelector('#barcode-showProductName');
    const showPriceCheckbox = pane.querySelector('#barcode-showPrice');
    const columnsInput = pane.querySelector('#sheet-columns');
    const gapInput = pane.querySelector('#sheet-gap');
    const marginXInput = pane.querySelector('#sheet-marginX');
    const marginYInput = pane.querySelector('#sheet-marginY');

    // Download buttons
    const downloadPdfBtn = pane.querySelector('#download-pdf-btn');
    const downloadPngBtn = pane.querySelector('#download-png-btn');

    // --- Core Functions ---
    const renderBarcodeList = () => {
        if (barcodeSheetItems.length === 0) {
            barcodeListContainer.innerHTML = `<p class="text-xs text-text-secondary text-center">Add barcodes to see them here.</p>`;
            return;
        }
        const groupedItems = barcodeSheetItems.reduce((acc, item) => {
            const key = item.productName || item.data;
            if (!acc[key]) {
                acc[key] = { ...item, count: 0 };
            }
            acc[key].count += item.quantity;
            return acc;
        }, {});
        barcodeListContainer.innerHTML = Object.values(groupedItems).map((item, index) => `
            <div class="flex items-center justify-between p-2 bg-bg-tertiary rounded-md text-xs">
                <div class="truncate">
                    <p class="font-semibold text-text-primary truncate" title="${item.productName || item.data}">${item.productName || item.data}</p>
                    <p class="text-text-secondary truncate font-mono">${item.data}</p>
                </div>
                <div class="flex items-center gap-2 shrink-0 ml-2">
                    <span class="font-mono text-accent">x${item.count}</span>
                    <button data-action="remove-barcode-group" data-name="${item.productName || item.data}" class="text-danger/70 hover:text-danger p-1"><i data-lucide="x" class="w-3 h-3 pointer-events-none"></i></button>
                </div>
            </div>
        `).join('');
        lucide.createIcons();
    };

    const renderBarcodeSheet = () => {
        sheetContainer.innerHTML = '';
        sheetContainer.style.gridTemplateColumns = `repeat(${sheetLayout.columns}, 1fr)`;
        sheetContainer.style.gap = `${sheetLayout.gap}px`;
        sheetContainer.parentElement.style.padding = `${sheetLayout.marginY}px ${sheetLayout.marginX}px`;

        const allItems = barcodeSheetItems.flatMap(item => Array(item.quantity).fill(item));

        if (allItems.length === 0) {
            sheetContainer.innerHTML = `<div class="absolute inset-0 flex items-center justify-center text-gray-400" style="grid-column: 1 / -1;">Your barcode sheet is empty</div>`;
            return;
        }
        
        allItems.forEach(item => {
            const labelContainer = document.createElement('div');
            labelContainer.className = 'barcode-label-item';

            let labelHTML = '';
            
            if (barcodeSettings.showShopName && firestoreData.storeInfo.name) {
                labelHTML += `<div class="barcode-shop-name font-bold" style="font-size: ${barcodeSettings.labelFontSize * 0.8}pt;">${firestoreData.storeInfo.name}</div>`;
            }
            if (barcodeSettings.showProductName && item.productName) {
                labelHTML += `<div class="barcode-product-name" style="font-size: ${barcodeSettings.labelFontSize * 0.9}pt; margin-top: 2px;">${item.productName}</div>`;
            }
            labelHTML += `<svg class="barcode-svg my-1"></svg>`;
            if (barcodeSettings.showPrice && item.price !== undefined) {
                 labelHTML += `<div class="barcode-price font-bold" style="font-size: ${barcodeSettings.labelFontSize}pt;">${currencyUtils.format(item.price)}</div>`;
            }
            labelContainer.innerHTML = labelHTML;
            const svg = labelContainer.querySelector('.barcode-svg');
            
            try {
                JsBarcode(svg, item.data, {
                    ...barcodeSettings,
                    fontSize: barcodeSettings.labelFontSize,
                    text: item.label || item.data,
                    lineColor: '#000', fontColor: '#000', background: 'transparent',
                    margin: 2, textMargin: 2, marginBottom: 5,
                });
            } catch (e) {
                console.error("Barcode generation error:", e);
                labelContainer.innerHTML = `<div class="text-red-500 text-xs p-2 break-all">Error: ${e.message}. Check data and format.</div>`;
            }
            sheetContainer.appendChild(labelContainer);
        });
    };
    
    const renderAll = () => {
        renderBarcodeList();
        renderBarcodeSheet();
    };

    const openSerialSelectorForBarcodeModal = (product) => {
        const availableSerials = product.serials || [];
        if (availableSerials.length === 0) {
            showToast('This product has no serial numbers in stock.', 'warning');
            return;
        }
        const content = `
            <p class="text-sm mb-4">Select serial numbers for <strong>${product.name}</strong> to generate barcodes.</p>
            <div class="max-h-80 overflow-y-auto -mx-6 px-6 border-y border-border-color py-2">
                <div class="space-y-2">
                    <label class="flex items-center p-2 rounded-md hover:bg-bg-tertiary cursor-pointer font-semibold border-b border-border-color mb-2">
                        <input type="checkbox" data-action="select-all-serials" class="form-checkbox h-4 w-4 rounded mr-3">
                        Select All
                    </label>
                    ${availableSerials.map(sn => `<label class="flex items-center p-2 rounded-md hover:bg-bg-tertiary cursor-pointer"><input type="checkbox" name="selectedSerials" value="${sn}" class="form-checkbox h-4 w-4 rounded mr-3"><span class="font-mono text-sm">${sn}</span></label>`).join('')}
                </div>
            </div>`;
        const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="add-serials-to-sheet" class="btn btn-primary">Add Selected to Sheet</button>`;
        const modal = showModal('Select Serial Numbers', content, footer);
        modal.querySelector('[data-action="select-all-serials"]').addEventListener('change', (e) => {
            modal.querySelectorAll('input[name="selectedSerials"]').forEach(checkbox => { checkbox.checked = e.target.checked; });
        });
        modal.querySelector('#add-serials-to-sheet').addEventListener('click', () => {
            const selectedSerials = Array.from(modal.querySelectorAll('input[name="selectedSerials"]:checked')).map(cb => cb.value);
            if (selectedSerials.length === 0) {
                showToast('No serial numbers selected.', 'info'); return;
            }
            const itemsToAdd = selectedSerials.map(serial => ({
                data: product.barcode || product.id,
                label: product.barcode || product.id,
                productName: `${product.name} (SN: ${serial})`,
                price: product.price,
                quantity: 1
            }));
            barcodeSheetItems.push(...itemsToAdd);
            renderAll();
            closeModal(modal);
            showToast(`Added ${selectedSerials.length} serial number barcodes to the sheet.`, 'success');
        });
    };

    // --- Event Listeners Setup ---

    // --- NEW: Toggle for serialization fields ---
    if (isSerializedCheckbox) {
        isSerializedCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            quantityWrapper.classList.toggle('hidden', isChecked);
            serialsWrapper.classList.toggle('hidden', !isChecked);
        });
    }
    // --- END NEW ---

    pane.querySelectorAll('[data-barcode-tab]').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabName = tab.dataset.barcodeTab;
            pane.querySelectorAll('[data-barcode-tab]').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            if (singlePane) singlePane.classList.toggle('hidden', tabName !== 'single');
            if (bulkPane) bulkPane.classList.toggle('hidden', tabName !== 'bulk');
        });
    });

    // --- UPDATED: Single item add to handle both serialized and non-serialized ---
    addToSheetBtn.addEventListener('click', () => {
        const data = dataInput.value.trim();
        const productName = productNameInput.value.trim();
        const priceStr = priceInput.value.trim().replace(/[^0-9.-]+/g,"");
        const price = priceStr ? parseFloat(priceStr) : undefined;
        const priceInBase = price !== undefined ? currencyUtils.convertToBase(price) : undefined;
        const labelText = labelInput.value.trim() || data;
        
        if (!data) { showToast('Barcode data cannot be empty.', 'error'); return; }
        if (!productName) { showToast('Product Name cannot be empty.', 'error'); return; }

        const isSerialized = isSerializedCheckbox.checked;

        if (isSerialized) {
            const serials = serialsTextarea.value.split('\n').map(s => s.trim()).filter(Boolean);
            if (serials.length === 0) {
                showToast('Please enter at least one serial number when tracking by serial.', 'error');
                return;
            }
            
            const itemsToAdd = serials.map(serial => ({
                data: data,
                label: labelText,
                productName: `${productName} (SN: ${serial})`,
                price: priceInBase,
                quantity: 1 // Each serial is a single item
            }));
            
            barcodeSheetItems.push(...itemsToAdd);
            serialsTextarea.value = '';
        } else {
            const quantity = parseInt(quantityInput.value) || 1;
            barcodeSheetItems.push({ data, label: labelText, productName, price: priceInBase, quantity });
            quantityInput.value = 1;
        }

        renderAll();

        // Clear common form fields
        dataInput.value = '';
        labelInput.value = '';
        productNameInput.value = '';
        priceInput.value = '';
        dataInput.focus();
    });
    // --- END UPDATED ---
    
    bulkAddBtn.addEventListener('click', () => {
        const lines = bulkDataInput.value.split('\n').map(l => l.trim()).filter(Boolean);
        if (lines.length === 0) { showToast('No data entered for bulk add.', 'error'); return; }
        let itemsAddedCount = 0;
        const itemsToAdd = [];
        lines.forEach(line => {
            const product = firestoreData.products.find(p => p.id === line || p.barcode === line);
            if(product) {
                if (product.isSerialized) {
                    (product.serials || []).forEach(serial => {
                        itemsToAdd.push({
                            data: product.barcode || product.id,
                            label: product.barcode || product.id,
                            productName: `${product.name} (SN: ${serial})`,
                            price: product.price,
                            quantity: 1
                        });
                        itemsAddedCount++;
                    });
                } else {
                     itemsToAdd.push({ 
                        data: product.barcode || product.id,
                        label: product.barcode || product.id,
                        productName: product.name,
                        price: product.price,
                        quantity: 1 
                    });
                    itemsAddedCount++;
                }
            }
        });
        barcodeSheetItems.push(...itemsToAdd);
        renderAll();
        bulkDataInput.value = '';
        showToast(`Added ${itemsAddedCount} items to the sheet.`, 'success');
    });

    clearSheetBtn.addEventListener('click', () => {
        if (barcodeSheetItems.length > 0) {
            barcodeSheetItems = [];
            renderAll();
            showToast('Barcode sheet cleared.', 'success');
        }
    });

    barcodeListContainer.addEventListener('click', e => {
        const removeBtn = e.target.closest('[data-action="remove-barcode-group"]');
        if (removeBtn) {
            const nameToRemove = removeBtn.dataset.name;
            barcodeSheetItems = barcodeSheetItems.filter(item => (item.productName || item.data) !== nameToRemove);
            renderAll();
        }
    });

    productSearchInput.addEventListener('input', () => {
        const query = productSearchInput.value.toLowerCase();
        if (query.length < 1) {
            productSearchResults.classList.add('hidden');
            return;
        }
        const results = firestoreData.products.filter(p => 
            !p.hasVariants && (p.name.toLowerCase().includes(query) || p.id.toLowerCase().includes(query))
        ).slice(0, 5);
        if (results.length > 0) {
            productSearchResults.innerHTML = results.map(p => {
                const parentName = p.parentSKU ? firestoreData.products.find(parent => parent.id === p.parentSKU)?.name : p.name;
                const variantInfo = p.parentSKU ? Object.values(p.variantOptions).join(' / ') : '';
                return `
                <div class="p-2 cursor-pointer hover:bg-bg-tertiary" data-id="${p.id}">
                    <p class="text-sm font-medium pointer-events-none">${parentName} ${p.isSerialized ? '<i data-lucide="barcode" class="inline w-3 h-3 ml-1 text-accent"></i>' : ''}</p>
                    <p class="text-xs text-text-secondary pointer-events-none">${variantInfo}</p>
                    <p class="text-xs text-text-secondary font-mono pointer-events-none">${p.id}</p>
                </div>`;
            }).join('');
            productSearchResults.classList.remove('hidden');
            lucide.createIcons();
        } else {
            productSearchResults.classList.add('hidden');
        }
    });
    
    productSearchResults.addEventListener('mousedown', e => {
        const target = e.target.closest('[data-id]');
        if (target) {
            const product = firestoreData.products.find(p => p.id === target.dataset.id);
            if (product) {
                if (product.isSerialized) {
                    openSerialSelectorForBarcodeModal(product);
                } else {
                    dataInput.value = product.barcode || product.id;
                    labelInput.value = product.barcode || product.id;
                    productNameInput.value = product.name;
                    priceInput.value = product.price !== undefined ? currencyUtils.convert(product.price).toFixed(2) : '';
                    quantityInput.value = 1;
                    quantityInput.focus();
                }
            }
            productSearchResults.classList.add('hidden');
            productSearchInput.value = '';
        }
    });
    document.addEventListener('click', (e) => {
        if (!productSearchInput.contains(e.target)) {
            productSearchResults.classList.add('hidden');
        }
    });
    
    const updateStylingAndLayout = () => {
        barcodeSettings = {
            format: formatSelect.value,
            width: parseFloat(widthInput.value) || 2,
            height: parseInt(heightInput.value) || 100,
            displayValue: displayValueCheckbox.checked,
            labelFontSize: parseInt(labelFontSizeInput.value) || 12,
            showShopName: showShopNameCheckbox.checked,
            showProductName: showProductNameCheckbox.checked,
            showPrice: showPriceCheckbox.checked,
        };
         sheetLayout = {
            columns: parseInt(columnsInput.value) || 3,
            gap: parseInt(gapInput.value) || 10,
            marginX: parseInt(marginXInput.value) || 10,
            marginY: parseInt(marginYInput.value) || 10,
        };
        renderBarcodeSheet();
    };
    [formatSelect, widthInput, heightInput, labelFontSizeInput, displayValueCheckbox, showShopNameCheckbox, showProductNameCheckbox, showPriceCheckbox, columnsInput, gapInput, marginXInput, marginYInput].forEach(el => el.addEventListener('input', updateStylingAndLayout));

    const downloadSheet = async (format) => {
        const originalSheet = pane.querySelector('#barcode-sheet');
        if (!originalSheet || originalSheet.children.length === 0) { showToast('Barcode sheet is empty.', 'info'); return; }
        showToast(`Generating ${format.toUpperCase()}...`, 'info');
        const clone = originalSheet.cloneNode(true);
        clone.id = 'barcode-sheet-for-export';
        clone.querySelectorAll('.barcode-shop-name, .barcode-product-name, .barcode-price').forEach(el => {
            el.style.whiteSpace = 'normal'; el.style.overflow = 'visible'; el.style.textOverflow = 'clip'; el.style.wordBreak = 'break-word';
        });
        clone.style.position = 'absolute'; clone.style.left = '-9999px'; clone.style.top = '0'; clone.style.width = '800px'; clone.style.height = 'auto';
        document.body.appendChild(clone);
        await new Promise(resolve => setTimeout(resolve, 100));
        try {
            const canvas = await html2canvas(clone, { scale: 3, useCORS: true, backgroundColor: '#ffffff' });
            if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const marginX = 10; const marginY = 10;
                const usableWidth = pdfWidth - (marginX * 2);
                const usableHeight = pdfHeight - (marginY * 2);
                const canvasAspectRatio = canvas.width / canvas.height;
                const totalImgHeightInMm = usableWidth / canvasAspectRatio;
                const numPages = Math.ceil(totalImgHeightInMm / usableHeight);
                let canvasSliceY = 0;
                for (let i = 0; i < numPages; i++) {
                    if (i > 0) pdf.addPage();
                    const sliceHeightInPx = usableHeight * (canvas.width / usableWidth);
                    const currentSliceHeight = Math.min(sliceHeightInPx, canvas.height - canvasSliceY);
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = canvas.width; tempCanvas.height = currentSliceHeight;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.drawImage(canvas, 0, canvasSliceY, canvas.width, currentSliceHeight, 0, 0, canvas.width, currentSliceHeight);
                    const imgData = tempCanvas.toDataURL('image/png');
                    const pageImageHeight = (currentSliceHeight / canvas.width) * usableWidth;
                    pdf.addImage(imgData, 'PNG', marginX, marginY, usableWidth, pageImageHeight);
                    canvasSliceY += sliceHeightInPx;
                }
                pdf.save('barcodes.pdf');
            } else {
                 const link = document.createElement('a');
                 link.download = `barcodes.${format}`;
                 link.href = canvas.toDataURL(`image/${format}`);
                 link.click();
            }
        } catch (error) {
            console.error('Download failed:', error); showToast('Failed to generate file.', 'error');
        } finally {
            if (document.body.contains(clone)) document.body.removeChild(clone);
        }
    };
    
    downloadPdfBtn.addEventListener('click', () => downloadSheet('pdf'));
    downloadPngBtn.addEventListener('click', () => downloadSheet('png'));
    
    // --- Initial Render ---
    renderAll();
}
            // --- REWRITTEN: AUTHENTICATION & APP START ---
            // This is the new "main gate" that handles multi-tenancy.
            onAuthStateChanged(auth, async (user) => {
                const mainAppContainer = document.getElementById('app-container');
                const loginContainer = document.getElementById('login-container');
                const loadingOverlay = document.getElementById('loading-overlay');

                if (user) {
                    console.log("User is signed in:", user.uid);
                    
                    // --- KEY FIX: Detach any potential lingering listeners from a previous session ---
                    detachAllListeners();

                    // 1. Find which store this user belongs to.
                    const userProfileRef = doc(db, 'users', user.uid);

                    // --- NEW: REAL-TIME USER SUBSCRIPTION LISTENER ---
                    // This is the primary gatekeeper for app access.
                    const unsubUserProfile = onSnapshot(userProfileRef, (userDocSnap) => {
                        if (!appState.firebaseReady) return; // Don't run on initial load, only on subsequent changes.

                        if (userDocSnap.exists()) {
                            const userData = userDocSnap.data();
                            appState.session.userProfileData = userData; // Keep session data in sync
                            const subscriptionCheck = checkSubscriptionStatus(userData);
                            const isCurrentlyLocked = !!document.getElementById('lock-screen-overlay');
                            const lockScreenTitleEl = document.querySelector('#lock-screen-overlay h1');
                            const isStoreDisabledLock = lockScreenTitleEl && lockScreenTitleEl.textContent === 'Store Disabled';

                            // If the subscription becomes invalid, lock the screen (unless it's already locked for a store issue)
                            if (!subscriptionCheck.isValid && !isStoreDisabledLock) {
                                if (!isCurrentlyLocked) {
                                    showLockScreen(subscriptionCheck.status, subscriptionCheck.details);
                                }
                            } 
                            // If the subscription becomes valid again, reload the app.
                            else if (subscriptionCheck.isValid && isCurrentlyLocked && !isStoreDisabledLock) {
                                window.location.reload();
                            }
                        }
                    });
                    activeListeners.push(unsubUserProfile);
                    // --- END NEW LISTENER ---


                    const userProfileSnap = await getDoc(userProfileRef);

                    if (!userProfileSnap.exists()) {
                        // This can happen if signup failed midway. It's safer to sign them out.
                        console.error(`User ${user.uid} is authenticated but has no user profile document. Forcing sign out.`);
                        await signOut(auth);
                        return; // onAuthStateChanged will be re-triggered with user=null
                    }
                    
                    const userProfileData = userProfileSnap.data();
                    appState.session.userProfileData = userProfileData; // Store the whole profile
                    const potentialStoresFromProfile = userProfileData.stores || [];
                    let storeId = userProfileData.currentStoreId;
                    
                    if (!storeId || potentialStoresFromProfile.length === 0) {
                        console.error(`User profile for ${user.uid} is missing a storeId or has no stores. Forcing sign out.`);
                        await signOut(auth);
                        return;
                    }
                    
                    // --- MODIFICATION START ---
                    // Fetch full store docs to get the isEnabled flag for the UI switcher.
                    const allUserStoreDocs = await Promise.all(potentialStoresFromProfile.map(s => getDoc(doc(db, 'stores', s.id))));
                    const allUserStores = allUserStoreDocs.map(d => d.exists() ? { id: d.id, ...d.data() } : null).filter(Boolean);
                    appState.session.availableStores = allUserStores; // This list is for the switcher UI.

                    // Now, determine which stores are actually usable for login/switching
                    const staffStatusPromises = allUserStores.map(store => getDoc(doc(db, 'stores', store.id, 'staff', user.uid)));
                    const staffStatusSnapshots = await Promise.all(staffStatusPromises);

                    const activeAndEnabledStores = allUserStores.filter((store, index) => {
                        const staffDoc = staffStatusSnapshots[index];
                        const isStaffActive = staffDoc.exists() && (staffDoc.data().status || 'active') === 'active';
                        const isStoreEnabled = store.isEnabled !== false;
                        return isStaffActive && isStoreEnabled;
                    });

                    if (activeAndEnabledStores.length === 0) {
                        console.log(`[Auth] No active and enabled stores found for user. Proceeding with logout.`);
                        showToast("Your account is inactive or all your stores are disabled. Please contact an administrator.", "error");
                        await signOut(auth);
                        return;
                    }

                    // Check if the user's last-used store is still in their active & enabled list.
                    const isCurrentStoreUsable = activeAndEnabledStores.some(s => s.id === storeId);
                    if (!isCurrentStoreUsable) {
                        storeId = activeAndEnabledStores[0].id; // Default to the first usable store
                        console.log(`[Auth] User's current store is inactive or disabled. Switching to usable store ${storeId}.`);
                        await updateDoc(userProfileRef, { currentStoreId: storeId });
                    }
                    
                    appState.session.storeId = storeId;
                    console.log(`User has ${allUserStores.length} total stores. Active and enabled store: ${storeId}`);
                    
                    // Check User's Subscription First
                    const subscriptionCheck = checkSubscriptionStatus(userProfileData);
                    if (!subscriptionCheck.isValid) {
                        console.warn(`[Auth] Access denied for user ${user.uid}. Subscription status: ${subscriptionCheck.status}.`);
                        if (loadingOverlay) loadingOverlay.style.display = 'none';
                        // --- FIX: Pass planId to showLockScreen ---
                        showLockScreen(subscriptionCheck.status, subscriptionCheck.planId, subscriptionCheck.details);
                        return; // Stop app initialization
                    }
                    // --- MODIFICATION END ---

                    // 2. Now that we have the storeId, setup all Firebase references.
                    setupFirebaseRefs(storeId);
                    
                    // 3. Fetch the user's staff profile from *within their store*.
                    const userStaffDocRef = doc(staffRef, user.uid);
                    const userStaffDocSnap = await getDoc(userStaffDocRef);

                    if (!userStaffDocSnap.exists()) {
                        console.error(`User ${user.uid} has a profile but no staff record in store ${storeId}. Forcing sign out.`);
                        await signOut(auth);
                        return;
                    }

                    const staffData = userStaffDocSnap.data();
                    
                    // 4. Check if the user's staff account is pending. The 'inactive' case is already handled.
                    const userStatus = staffData.status || 'active';
                    
                    if (userStatus === 'pending') {
                        showToast("Your account is pending approval from an administrator.", "warning");
                        await signOut(auth);
                        return;
                    }
                    
                    // 5. All checks passed! Populate session and load the app.
                    appState.session.currentUser = { uid: user.uid, email: user.email, ...staffData };
                    appState.session.userRole = staffData.role;
                    
                    console.log(`User role identified as: ${staffData.role}. Fetching store settings.`);
                    
                    // First, fetch the store settings to get permissions
                    const storeDoc = await getDoc(storeRef);
                    if (!storeDoc.exists()) { 
                        // This should ideally not happen if the user profile exists, indicates data inconsistency.
                        console.error(`Store document ${storeId} not found for user ${user.uid}. Forcing sign out.`);
                        await signOut(auth);
                        return;
                    }
                    processStoreSettings(storeDoc);
                    
                    // NEW: OVERRIDE with user preference AFTER defaults are loaded
                    const userPosLayout = staffData.preferences?.posLayout;
                    if (userPosLayout) {
                        appState.settings.posLayout = userPosLayout;
                        console.log(`[Auth] User-specific POS layout preference loaded: '${userPosLayout}'.`);
                    } else {
                        console.log(`[Auth] No user preference found. Using store default layout: '${appState.settings.posLayout}'.`);
                    }
                    
                    // Second, with permissions now loaded, initialize all real-time data listeners.
                    initFirebaseListeners();
                    
                    // --- MODIFICATION START: Moved from setTimeout ---
                    // Third, show the app UI *after* all session data is loaded.
                    appState.firebaseReady = true;
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                    if (loginContainer) loginContainer.style.display = 'none';
                    if (mainAppContainer) mainAppContainer.style.display = 'flex';
                    
                    // --- NEW: ADD STORE SWITCHER ---
                        if (!document.getElementById('store-switcher-container')) {
                            const notificationBtn = document.querySelector('[data-action="open-notifications"]');
                            if (notificationBtn) {
                                // Find the container for header action buttons
                                const headerActionsContainer = notificationBtn.parentElement;
                                if (headerActionsContainer) {
                                    const storeSwitcherHTML = `<div id="store-switcher-container" class="relative"></div>`;
                                    headerActionsContainer.insertAdjacentHTML('afterbegin', storeSwitcherHTML);
                                }
                            }
                        }
                        renderStoreSwitcher();
                        
                        // --- NEW: ADD FULLSCREEN BUTTON ---
                        if (!document.getElementById('fullscreen-btn')) {
                            const notificationBtn = document.querySelector('[data-action="open-notifications"]');
                            if (notificationBtn) {
                                const fullscreenButtonHTML = `
                                <button data-action="toggle-fullscreen" id="fullscreen-btn" title="Enter Fullscreen" class="w-10 h-10 flex items-center justify-center rounded-lg text-text-secondary hover:bg-bg-tertiary hover:text-text-primary transition-colors">
                                    <i data-lucide="maximize" class="w-5 h-5"></i>
                                </button>
                                `;
                                notificationBtn.insertAdjacentHTML('beforebegin', fullscreenButtonHTML);
                            }
                        }
                        
                        // --- NEW: ADD CALCULATOR BUTTON ---
                        if (!document.getElementById('calculator-container')) {
                        const notificationBtn = document.querySelector('[data-action="open-notifications"]');
                            if (notificationBtn) {
                                const calculatorButtonHTML = `
                                <div id="calculator-container" class="relative">
                                    <button data-action="toggle-calculator-menu" title="Calculators" class="w-10 h-10 flex items-center justify-center rounded-lg text-text-secondary hover:bg-bg-tertiary hover:text-text-primary transition-colors">
                                        <i data-lucide="calculator" class="w-5 h-5"></i>
                                    </button>
                                    <div id="calculator-menu" class="action-menu !w-48">
                                        <div class="action-menu-item" data-action="open-calculator" data-type="simple">
                                            <i data-lucide="calculator" class="w-4 h-4"></i>
                                            <span>Calculator</span>
                                        </div>
                                        <div class="action-menu-item" data-action="open-calculator" data-type="advanced">
                                            <i data-lucide="function-square" class="w-4 h-4"></i>
                                            <span>Advanced Tools</span>
                                        </div>
                                    </div>
                                </div>`;
                                notificationBtn.insertAdjacentHTML('afterend', calculatorButtonHTML);
                            }
                        }
                        
                        // --- THIS IS THE KEY FIX ---
                        // Now that all data is loaded, update UI permissions
                        updateUIPermissions(); 
                        
                        // And *now* render the main app content
                        if (appState.activeTabId && appState.tabs.length > 0) { 
                            renderApp(); 
                        } else { 
                            openOrSwitchTab('dashboard'); 
                        }
                    // --- MODIFICATION END: Removed setTimeout wrapper ---

                } else {
                    // No user is signed in. Show the login/signup screen.
                    console.log("No user signed in. Detaching listeners and rendering login screen.");
                    
                    // --- NEW: Clear lock state on logout ---
                    isAppLocked = false;
                    if (lockScreenInterval) {
                        clearInterval(lockScreenInterval);
                        lockScreenInterval = null;
                    }
                    const existingOverlay = document.getElementById('lock-screen-overlay');
                    if (existingOverlay) existingOverlay.remove();
                    // --- END NEW ---

                    // --- KEY FIX: DETACH LISTENERS ON SIGN OUT ---
                    detachAllListeners();

                    // Reset session state for a clean slate
                    appState.session.storeId = null;
                    appState.session.currentUser = null;
                    appState.session.userRole = null;
                    
                    await renderLoginScreen(); // This populates the container

                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                    if (mainAppContainer) mainAppContainer.style.display = 'none';
                    if (loginContainer) {
                        // Make login-container a full-screen, dedicated page
                        loginContainer.style.display = 'flex';
                        loginContainer.style.position = 'fixed';
                        loginContainer.style.top = '0';
                        loginContainer.style.left = '0';
                        loginContainer.style.right = '0';
                        loginContainer.style.bottom = '0';
                        loginContainer.style.zIndex = '100';
                        loginContainer.style.backgroundColor = 'var(--bg-primary, #101827)';
                        loginContainer.style.alignItems = 'center';
                        loginContainer.style.justifyContent = 'center';
                    }
                }
            });
            
            const renderCashierDashboard = (pane) => {
                pane.innerHTML = `<div class="text-center p-4">Loading cashier data...</div>`;
                const term = getCurrentProfile().terminology;
                const currencyInfo = currencyUtils.get(appState.currentCurrency);

                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);

                const todaysInvoices = firestoreData.invoices.filter(inv => new Date(inv.date) >= todayStart && inv.status !== 'Void');

                const totalSales = todaysInvoices.reduce((sum, inv) => sum + inv.totalInBaseCurrency, 0);
                const transactionCount = todaysInvoices.length;

                // --- Performance Snapshot Logic ---
                const totalItemsSold = todaysInvoices.flatMap(inv => inv.items).reduce((sum, item) => sum + (item.qty || 1), 0);
                const avgItemsPerTx = transactionCount > 0 ? (totalItemsSold / transactionCount).toFixed(1) : 0;
                const avgSaleValue = transactionCount > 0 ? totalSales / transactionCount : 0;

                const dashboardHTML = `
                    <div class="space-y-8">
                        <!-- Dashboard Header -->
                        <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
                            <div>
                                <h1 class="text-3xl font-bold text-text-primary">Your Shift Summary</h1>
                                <p class="text-text-secondary">Here's your real-time performance, ${appState.session.currentUser.name.split(' ')[0]}.</p>
                            </div>
                        </div>
                        <!-- KPI Cards for Cashier -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div class="glass-pane p-5 rounded-xl flex items-start justify-between gap-4">
                                <div class="overflow-hidden">
                                    <p class="text-sm font-medium text-text-secondary">Your Sales Today</p>
                                    <p class="text-3xl font-bold text-text-primary">${formatAndTruncate("Your Sales Today", totalSales)}</p>
                                </div>
                                <div class="w-12 h-12 rounded-full flex items-center justify-center bg-green-500/10 shrink-0"><i data-lucide="trending-up" class="w-6 h-6 text-green-400"></i></div>
                            </div>
                            <div class="glass-pane p-5 rounded-xl flex items-start justify-between gap-4">
                                <div class="overflow-hidden">
                                    <p class="text-sm font-medium text-text-secondary">Transactions</p>
                                    <p class="text-3xl font-bold text-text-primary">${transactionCount}</p>
                                </div>
                                <div class="w-12 h-12 rounded-full flex items-center justify-center bg-blue-500/10 shrink-0"><i data-lucide="receipt-text" class="w-6 h-6 text-blue-400"></i></div>
                            </div>
                            <div class="glass-pane p-5 rounded-xl flex items-start justify-between gap-4">
                                <div class="overflow-hidden">
                                    <p class="text-sm font-medium text-text-secondary">Avg. Sale Value</p>
                                    <p class="text-3xl font-bold text-text-primary">${formatAndTruncate("Avg. Sale Value", avgSaleValue)}</p>
                                </div>
                                <div class="w-12 h-12 rounded-full flex items-center justify-center bg-yellow-500/10 shrink-0"><i data-lucide="scale" class="w-6 h-6 text-yellow-400"></i></div>
                            </div>
                            <div class="glass-pane p-5 rounded-xl flex items-start justify-between gap-4">
                                <div class="overflow-hidden">
                                    <p class="text-sm font-medium text-text-secondary">Avg. Items / Sale</p>
                                    <p class="text-3xl font-bold text-text-primary">${avgItemsPerTx}</p>
                                </div>
                                <div class="w-12 h-12 rounded-full flex items-center justify-center bg-indigo-500/10 shrink-0"><i data-lucide="shopping-basket" class="w-6 h-6 text-indigo-400"></i></div>
                            </div>
                        </div>

                        <!-- Main Content Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Left Column: New Chart -->
                            <div class="glass-pane p-6 rounded-xl flex flex-col lg:col-span-2 h-96">
                                <h2 class="text-xl font-semibold mb-4 text-text-primary">Sales Breakdown by Transaction Size</h2>
                                <div class="flex-grow relative"><canvas id="cashier-sales-breakdown-chart"></canvas></div>
                            </div>

                            <!-- Right Column: Info Lists -->
                             <div class="glass-pane p-6 rounded-xl flex flex-col h-96">
                                <div class="flex flex-col flex-1 min-h-0">
                                    <h2 class="text-xl font-semibold mb-2 text-text-primary flex-shrink-0">Recent Transactions</h2>
                                    <ul id="cashier-recent-activity-feed" class="space-y-2 overflow-y-auto pr-2 flex-grow"></ul>
                                </div>
                                <div class="border-t border-border-color my-4 flex-shrink-0"></div>
                                <div class="flex flex-col flex-1 min-h-0">
                                    <h2 class="text-xl font-semibold mb-2 text-text-primary flex-shrink-0">Low Stock Alert</h2>
                                    <ul id="cashier-low-stock-list" class="space-y-2 overflow-y-auto pr-2 flex-grow"></ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bottom Row: Lookup Tool -->
                        <div class="glass-pane p-6 rounded-xl flex flex-col">
                            <h2 class="text-xl font-semibold mb-4 text-text-primary">Quick ${term.product} Lookup</h2>
                            <div class="relative">
                                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-text-secondary"></i>
                                <input type="text" id="cashier-product-lookup" placeholder="Search by name or SKU..." class="form-input w-full pl-9 text-sm">
                            </div>
                            <div id="cashier-lookup-results" class="mt-2 space-y-2 max-h-40 overflow-y-auto">
                                <p class="text-xs text-text-secondary text-center py-4">Start typing to find a ${term.product}.</p>
                            </div>
                        </div>
                    </div>
                `;
                pane.innerHTML = dashboardHTML;
                lucide.createIcons();

                // --- Logic for Chart, Lists & Lookup ---

                // Sales Breakdown Chart
                const baseBuckets = { '0-25': 0, '25-50': 0, '50-100': 0, '100-250': 0, '250+': 0 };
                
                // Convert base currency thresholds to the current display currency for chart labels
                const baseThresholds = [25, 50, 100, 250];
                const displayThresholds = baseThresholds.map(t => Math.round(currencyUtils.convert(t)));
                const bucketLabels = [
                    `${currencyInfo.symbol}0 - ${currencyInfo.symbol}${displayThresholds[0]}`,
                    `${currencyInfo.symbol}${displayThresholds[0]} - ${currencyInfo.symbol}${displayThresholds[1]}`,
                    `${currencyInfo.symbol}${displayThresholds[1]} - ${currencyInfo.symbol}${displayThresholds[2]}`,
                    `${currencyInfo.symbol}${displayThresholds[2]} - ${currencyInfo.symbol}${displayThresholds[3]}`,
                    `${currencyInfo.symbol}${displayThresholds[3]}+`
                ];

                todaysInvoices.forEach(inv => {
                    const total = inv.totalInBaseCurrency;
                    if (total <= 25) baseBuckets['0-25']++;
                    else if (total <= 50) baseBuckets['25-50']++;
                    else if (total <= 100) baseBuckets['50-100']++;
                    else if (total <= 250) baseBuckets['100-250']++;
                    else baseBuckets['250+']++;
                });

                const breakdownData = Object.values(baseBuckets);
                const breakdownCtx = pane.querySelector('#cashier-sales-breakdown-chart')?.getContext('2d');
                if (breakdownCtx) {
                    new Chart(breakdownCtx, {
                        type: 'bar',
                        data: {
                            labels: bucketLabels,
                            datasets: [{
                                label: 'Number of Sales',
                                data: breakdownData,
                                backgroundColor: chartStyles.createGradient(breakdownCtx, chartStyles.palettes.gentleOcean[0]),
                                borderColor: chartStyles.palettes.gentleOcean[0],
                                borderWidth: 2,
                                borderRadius: 4,
                            }]
                        },
                        options: commonChartOptions(false, { 
                            plugins: { 
                                legend: { display: false },
                                chartGlow: { color: chartStyles.hexToRgba(chartStyles.palettes.gentleOcean[0], 0.2), blur: 15 },
                                tooltip: { callbacks: { label: (c) => `${c.raw} sales` } }
                            },
                            scales: { 
                                y: { title: { display: true, text: 'Number of Transactions', color: '#9ca3af' } },
                                x: { grid: { display: false }, title: { display: true, text: `Transaction Total (in ${appState.currentCurrency})`, color: '#9ca3af' } }
                            }
                        })
                    });
                }

                // Recent Activity
                const recentActivityContainer = pane.querySelector('#cashier-recent-activity-feed');
                const recentInvoices = todaysInvoices.sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
                if (recentActivityContainer) {
                    recentActivityContainer.innerHTML = recentInvoices.length ? recentInvoices.map(inv => `
                        <li class="flex items-center justify-between text-sm hover:bg-bg-secondary/50 p-1.5 rounded-md">
                            <div>
                                <p class="font-medium text-text-primary truncate">${inv.customerName}</p>
                                <p class="text-xs text-text-secondary">${new Date(inv.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                            </div>
                            <span class="font-mono text-text-primary font-semibold">${currencyUtils.format(inv.totalInBaseCurrency, inv.currency)}</span>
                        </li>
                    `).join('') : `<li><p class="text-xs text-text-secondary text-center p-2">No sales recorded yet today.</p></li>`;
                }
                
                // --- SMART FIX: Low Stock List for Cashier ---
                const lowStockList = pane.querySelector('#cashier-low-stock-list');
                const lowStockProducts = firestoreData.products
                    .filter(p => p.productType === 'physical' && p.stock > 0 && p.stock < 20) // Use 20 threshold
                    .sort((a,b) => a.stock - b.stock)
                    .slice(0, 5); // Cashier dashboard only shows top 5

                if (lowStockList) {
                    lowStockList.innerHTML = lowStockProducts.length ? lowStockProducts.map(p => {
                        let productName = p.name;
                        // If this is a variant, make the name more descriptive
                        if (p.parentSKU && p.variantOptions) {
                            const parent = firestoreData.products.find(parent => parent.id === p.parentSKU);
                            const parentName = parent ? parent.name : p.name;
                            const variantInfo = Object.values(p.variantOptions).join(' / ');
                            productName = `${parentName} <span class="text-xs text-accent">(${variantInfo})</span>`;
                        }
                        
                        return `
                        <li class="flex items-center justify-between text-sm hover:bg-bg-secondary/50 p-1.5 rounded-md">
                            <span class="font-medium text-text-primary truncate pr-4">${productName}</span>
                            <span class="font-mono text-red-400 font-semibold">${p.stock} left</span>
                        </li>`;
                    }).join('') : `<li><p class="text-xs text-text-secondary text-center p-2">All products are well-stocked.</p></li>`;
                }
                // --- END SMART FIX ---

                // Product Lookup
                const lookupInput = pane.querySelector('#cashier-product-lookup');
                const lookupResults = pane.querySelector('#cashier-lookup-results');
                if (lookupInput && lookupResults) {
                    lookupInput.addEventListener('input', (e) => {
                        const query = e.target.value.toLowerCase();
                        if (query.length < 2) {
                            lookupResults.innerHTML = `<p class="text-xs text-text-secondary text-center py-4">Start typing to find a ${term.product}.</p>`;
                            return;
                        }
                        const results = firestoreData.products
                            .filter(p => (p.status || 'active') === 'active' && (p.name.toLowerCase().includes(query) || p.id.toLowerCase().includes(query))) // MODIFIED
                            .slice(0, 5);
                        
                        if (results.length) {
                            lookupResults.innerHTML = results.map(p => `
                                <div class="p-2 rounded-md bg-bg-secondary text-sm">
                                    <p class="font-medium text-text-primary">${p.name}</p>
                                    <div class="flex justify-between text-xs mt-1">
                                        <span class="text-text-secondary font-mono">${p.id}</span>
                                        <div>
                                            <span class="text-text-secondary">Price: <span class="font-mono text-accent">${currencyUtils.format(p.price)}</span></span>
                                            <span class="text-text-secondary ml-2">Stock: <span class="font-mono ${p.stock <= 0 ? 'text-red-400' : 'text-green-400'}">${p.productType === 'physical' ? p.stock : 'N/A'}</span></span>
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                        } else {
                            lookupResults.innerHTML = `<p class="text-xs text-text-secondary text-center py-4">No ${term.product}s found for "${query}".</p>`;
                        }
                    });
                }
            };

            function initDashboard(pane) {
                if (appState.session.userRole === 'cashier') {
                    renderCashierDashboard(pane);
                    return;
                }

                const term = getCurrentProfile().terminology;
                let salesChart, categoryChart, hourlySalesChart, paymentMethodsChart; // Hold chart instances

                const updateDashboardData = (period = 'today', customRange = null) => {
                    const now = new Date();
                    let startDate, endDate, prevStartDate, prevEndDate, periodLabel;

                    // Set time to end of day for comparisons
                    const todayEnd = new Date(now);
                    todayEnd.setHours(23, 59, 59, 999);

                    switch (period) {
                        case 'year':
                            startDate = new Date(now.getFullYear(), 0, 1);
                            endDate = todayEnd;
                            prevStartDate = new Date(now.getFullYear() - 1, 0, 1);
                            prevEndDate = new Date(now.getFullYear() - 1, 11, 31);
                            prevEndDate.setHours(23, 59, 59, 999);
                            periodLabel = "vs. last year";
                            break;
                        case 'month':
                            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                            endDate = todayEnd;
                            prevStartDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                            prevEndDate = new Date(now.getFullYear(), now.getMonth(), 0);
                            prevEndDate.setHours(23, 59, 59, 999);
                            periodLabel = "vs. last month";
                            break;
                        case 'last30':
                            startDate = new Date(now);
                            startDate.setDate(now.getDate() - 29);
                            startDate.setHours(0, 0, 0, 0);
                            endDate = todayEnd;
                            
                            prevEndDate = new Date(startDate);
                            prevEndDate.setDate(prevEndDate.getDate() - 1);
                            prevEndDate.setHours(23, 59, 59, 999);
                            prevStartDate = new Date(prevEndDate);
                            prevStartDate.setDate(prevEndDate.getDate() - 29);
                            prevStartDate.setHours(0, 0, 0, 0);
                            
                            periodLabel = "vs. previous 30 days";
                            break;
                        case 'week':
                            startDate = new Date(now);
                            startDate.setDate(now.getDate() - now.getDay());
                            startDate.setHours(0, 0, 0, 0);
                            endDate = todayEnd;
                            
                            prevStartDate = new Date(startDate);
                            prevStartDate.setDate(startDate.getDate() - 7);
                            prevEndDate = new Date(startDate);
                            prevEndDate.setDate(prevEndDate.getDate() - 1);
                            prevEndDate.setHours(23, 59, 59, 999);
                            periodLabel = "vs. last week";
                            break;
                        case 'last7':
                            startDate = new Date(now);
                            startDate.setDate(now.getDate() - 6);
                            startDate.setHours(0, 0, 0, 0);
                            endDate = todayEnd;

                            prevEndDate = new Date(startDate);
                            prevEndDate.setDate(prevEndDate.getDate() - 1);
                            prevEndDate.setHours(23, 59, 59, 999);
                            prevStartDate = new Date(prevEndDate);
                            prevStartDate.setDate(prevEndDate.getDate() - 6);
                            prevStartDate.setHours(0, 0, 0, 0);
                            
                            periodLabel = "vs. previous 7 days";
                            break;
                        case 'yesterday':
                            startDate = new Date(now);
                            startDate.setDate(now.getDate() - 1);
                            startDate.setHours(0, 0, 0, 0);
                            endDate = new Date(startDate);
                            endDate.setHours(23, 59, 59, 999);
                            
                            prevStartDate = new Date(startDate);
                            prevStartDate.setDate(startDate.getDate() - 1);
                            prevStartDate.setHours(0, 0, 0, 0);
                            prevEndDate = new Date(prevStartDate);
                            prevEndDate.setHours(23, 59, 59, 999);

                            periodLabel = "vs. day before";
                            break;
                        case 'custom':
                            startDate = new Date(customRange.start);
                            startDate.setHours(0, 0, 0, 0);
                            endDate = new Date(customRange.end);
                            endDate.setHours(23, 59, 59, 999);
                            
                            const diff = endDate.getTime() - startDate.getTime();
                            prevEndDate = new Date(startDate.getTime() - 86400000); // 1 day in ms
                            prevEndDate.setHours(23, 59, 59, 999);
                            prevStartDate = new Date(prevEndDate.getTime() - diff);
                            prevStartDate.setHours(0,0,0,0);
                            
                            periodLabel = "vs. previous period";
                            break;
                        case 'today':
                        default:
                            startDate = new Date(now);
                            startDate.setHours(0, 0, 0, 0);
                            endDate = todayEnd;
                            
                            prevStartDate = new Date(startDate);
                            prevStartDate.setDate(startDate.getDate() - 1);
                            prevStartDate.setHours(0,0,0,0);
                            prevEndDate = new Date(prevStartDate);
                            prevEndDate.setHours(23, 59, 59, 999);

                            periodLabel = "vs. yesterday";
                            break;
                    }
                    
                    document.getElementById('dashboard-date').textContent = `Showing data for: ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;

                    const getMetricsForPeriod = (start, end) => {
                        const relevantInvoices = firestoreData.invoices.filter(inv => {
                            const invDate = new Date(inv.date);
                            return invDate >= start && invDate <= end && inv.status !== 'Void';
                        });

                        // --- UPDATED: Revenue Calculation (Includes EMI Interest) ---
                        const totalRevenue = relevantInvoices.reduce((sum, inv) => {
                            let val = inv.totalInBaseCurrency; // This is Principal + Tax - Discount
                            if (inv.isEMI) {
                                // For EMI, revenue is defined as the Total Value (Principal + Interest)
                                const schedule = firestoreData.emiSchedules.find(s => s.invoiceId === inv.id);
                                if (schedule) {
                                    val += (schedule.totalInterest || 0);
                                }
                            }
                            return sum + val;
                        }, 0);
                        // --- END UPDATED ---

                        const totalSales = relevantInvoices.length;

                        // --- UPDATED: Gross Profit Calculation (Real World) ---
                        const grossProfit = relevantInvoices.reduce((profit, inv) => {
                            // 1. Calculate basic margin (Selling Price - Cost Price)
                            const invoiceBaseMargin = inv.items.reduce((itemProfit, item) => {
                                const cost = item.costPrice !== undefined ? item.costPrice : 0;
                                return itemProfit + ((item.price - cost) * (item.qty || 1));
                            }, 0);
                            
                            // 2. Subtract Discounts (Profit = Margin - Discounts)
                            // Note: item.price usually includes the price *before* invoice-level discount
                            const persistentDiscount = inv.persistentDiscountDetails?.amount || 0;
                            const manualDiscount = inv.manualDiscountInBase || 0;
                            const totalInvoiceDiscount = persistentDiscount + manualDiscount;

                            // 3. Add Interest (Interest is 100% profit)
                            let interestProfit = 0;
                            if (inv.isEMI) {
                                const schedule = firestoreData.emiSchedules.find(s => s.invoiceId === inv.id);
                                if (schedule) interestProfit = schedule.totalInterest || 0;
                            }
                            
                            return profit + (invoiceBaseMargin - totalInvoiceDiscount + interestProfit);
                        }, 0);
                        // --- END UPDATED ---

                        const avgTransactionValue = totalSales > 0 ? totalRevenue / totalSales : 0;
                        return { totalRevenue, totalSales, grossProfit, avgTransactionValue, relevantInvoices };
                    };
                    
                    const currentMetrics = getMetricsForPeriod(startDate, endDate);
                    const previousMetrics = getMetricsForPeriod(prevStartDate, prevEndDate);

                    // New metric calculation for receivables
                    const totalReceivables = firestoreData.customers.reduce((sum, c) => sum + (c.currentDue || 0), 0);

                    const calculateChange = (current, previous) => {
                        if (previous === 0) return current > 0 ? 100 : 0;
                        return ((current - previous) / previous) * 100;
                    };
                    
                    const formatChange = (change) => {
                        if (change === 0 || !isFinite(change)) return `<span class="text-text-secondary"></span>`;
                        const color = change > 0 ? 'text-green-400' : 'text-red-400';
                        const icon = change > 0 ? 'arrow-up-right' : 'arrow-down-right';
                        return `<span class="flex items-center text-xs font-semibold ${color}"><i data-lucide="${icon}" class="w-3 h-3 mr-1"></i>${Math.abs(change).toFixed(1)}%</span>`;
                    };

                     const colorClasses = {
                        blue: { bg: 'bg-blue-500/10', text: 'text-blue-400' },
                        green: { bg: 'bg-green-500/10', text: 'text-green-400' },
                        yellow: { bg: 'bg-yellow-500/10', text: 'text-yellow-400' },
                        indigo: { bg: 'bg-indigo-500/10', text: 'text-indigo-400' },
                        red: { bg: 'bg-red-500/10', text: 'text-red-400' },
                    };

                    let stats = [
                        { icon: 'trending-up', color: 'blue', label: "Total Revenue", value: formatAndTruncate("Total Revenue", currentMetrics.totalRevenue), change: calculateChange(currentMetrics.totalRevenue, previousMetrics.totalRevenue) },
                        { icon: 'wallet', color: 'green', label: "Gross Profit", value: formatAndTruncate("Gross Profit", currentMetrics.grossProfit), change: calculateChange(currentMetrics.grossProfit, previousMetrics.grossProfit) },
                        { icon: 'shopping-cart', color: 'yellow', label: "Total Sales", value: formatAndTruncate("Total Sales", currentMetrics.totalSales, false), change: calculateChange(currentMetrics.totalSales, previousMetrics.totalSales) },
                        { icon: 'hand-coins', color: 'red', label: "Total Receivables", value: formatAndTruncate("Total Receivables", totalReceivables), change: null }
                    ];

                    if (!checkPermission('canViewProfitAndLoss')) { // MODIFIED
                        stats = stats.filter(s => s.label !== 'Gross Profit');
                    }

                    pane.querySelector('#dashboard-stats-container').innerHTML = stats.map(s => `
                        <div class="glass-pane p-5 rounded-xl flex items-start justify-between gap-4">
                            <div class="overflow-hidden">
                                <p class="text-sm font-medium text-text-secondary">${s.label}</p>
                                <p class="text-3xl font-bold text-text-primary">${s.value}</p>
                                <div class="flex items-center text-xs mt-1">
                                    ${s.change !== null ? formatChange(s.change) : ''}
                                    <span class="text-text-secondary/70 ml-2">${s.change !== null ? periodLabel : 'Current outstanding balance'}</span>
                                </div>
                            </div>
                            <div class="w-12 h-12 rounded-full flex items-center justify-center ${colorClasses[s.color].bg} shrink-0">
                                <i data-lucide="${s.icon}" class="w-6 h-6 ${colorClasses[s.color].text}"></i>
                            </div>
                        </div>
                    `).join('');
                    
                    // Render AI Insights from notifications - NEW: Only for Admin and Manager
                    const insightsContainer = pane.querySelector('#ai-insights-container');
                    if (insightsContainer && (appState.session.userRole === 'admin' || appState.session.userRole === 'manager')) {
                        const insightNotifications = firestoreData.notifications
                            .filter(n => ['stock', 'info', 'warning'].includes(n.type))
                            .slice(0, 2); // Get the latest 2 insights
                        
                        const insightIcons = { stock: 'package-search', info: 'trending-up', warning: 'shield-alert' };
                        const insightColors = { stock: 'yellow', info: 'green', warning: 'red' };

                        if (insightNotifications.length > 0) {
                            insightsContainer.innerHTML = insightNotifications.map(n => `
                                <div class="flex items-start gap-3 p-3 bg-bg-secondary rounded-lg">
                                    <i data-lucide="${insightIcons[n.type]}" class="w-5 h-5 text-${insightColors[n.type]}-400 mt-1 shrink-0"></i>
                                    <p>${n.message.replace(/<strong>(.*?)<\/strong>/g, '<span class="font-medium text-blue-400">$1</span>')}</p>
                                </div>
                            `).join('');
                        } else {
                            insightsContainer.innerHTML = `<p class="text-sm text-text-secondary p-3">No new insights at the moment.</p>`;
                        }
                    } else if (insightsContainer) {
                        // If the user is a cashier, hide the parent container of the insights.
                        insightsContainer.closest('.glass-pane').style.display = 'none';
                    }


                    const salesByProduct = {};
                    firestoreData.invoices
                        .filter(inv => new Date(inv.date) >= startDate && inv.status !== 'Void')
                        .forEach(inv => {
                            const subtotal = inv.subtotalInBaseCurrency || inv.items.reduce((s, i) => s + (i.price * (i.qty || 1)), 0);
                            const taxableSubtotal = inv.items
                                .filter(i => i.taxable)
                                .reduce((sum, i) => sum + (i.price * (i.qty || 1)), 0);

                            // --- UPDATED: Get EMI Interest for distribution ---
                            let totalInterest = 0;
                            if (inv.isEMI) {
                                const schedule = firestoreData.emiSchedules.find(s => s.invoiceId === inv.id);
                                if (schedule) totalInterest = schedule.totalInterest || 0;
                            }
                            // --- END UPDATED ---

                            if (subtotal > 0) {
                                inv.items.forEach(item => {
                                    const itemBaseValue = item.price * (item.qty || 1);
                                    
                                    const itemDiscount = (inv.discountInBaseCurrency || 0) * (itemBaseValue / subtotal);
                                    
                                    let itemTax = 0;
                                    if (item.taxable && taxableSubtotal > 0) {
                                        itemTax = (inv.taxInBaseCurrency || 0) * (itemBaseValue / taxableSubtotal);
                                    }
                                    
                                    // --- UPDATED: Distribute Interest proportionally to items ---
                                    const itemInterest = totalInterest * (itemBaseValue / subtotal);
                                    
                                    const totalItemRevenue = (itemBaseValue - itemDiscount) + itemTax + itemInterest;
                                    // --- END UPDATED ---
                                    
                                    salesByProduct[item.id] = (salesByProduct[item.id] || 0) + totalItemRevenue;
                                });
                            }
                        });

                    const topProducts = Object.entries(salesByProduct)
                        .sort(([, a], [, b]) => b - a)
                        .slice(0, 3)
                        .map(([id, revenue]) => ({ product: firestoreData.products.find(p => p.id === id), revenue }));
                    
                    pane.querySelector('#top-products-list').innerHTML = topProducts.length ? topProducts.map(item => `
                        <li class="flex items-center justify-between text-sm hover:bg-bg-secondary/50 p-1.5 rounded-md">
                            <span class="font-medium text-text-primary truncate pr-4">${item.product?.name || 'Unknown Product'}</span>
                            <span class="font-mono text-text-secondary">${currencyUtils.format(item.revenue)}</span>
                        </li>
                    `).join('') : `<li><p class="text-xs text-text-secondary text-center p-2">No sales in this period.</p></li>`;

                    // --- NEW: Top Customers List ---
                    const customerSpending = currentMetrics.relevantInvoices.reduce((acc, inv) => {
                        if (inv.customerId) {
                            // --- UPDATED: Include Interest in Customer Spending as well ---
                            let val = inv.totalInBaseCurrency;
                            if (inv.isEMI) {
                                const schedule = firestoreData.emiSchedules.find(s => s.invoiceId === inv.id);
                                if (schedule) val += (schedule.totalInterest || 0);
                            }
                            acc[inv.customerId] = (acc[inv.customerId] || 0) + val;
                            // --- END UPDATED ---
                        }
                        return acc;
                    }, {});

                    const topCustomers = Object.entries(customerSpending)
                        .sort(([, a], [, b]) => b - a)
                        .slice(0, 3)
                        .map(([id, total]) => ({
                            customer: firestoreData.customers.find(c => c.id === id),
                            total
                        }));

                    pane.querySelector('#top-customers-list').innerHTML = topCustomers.length ? topCustomers.map(item => `
                         <li class="flex items-center justify-between text-sm hover:bg-bg-secondary/50 p-1.5 rounded-md">
                            <span class="font-medium text-text-primary truncate pr-4">${item.customer?.name || 'Unknown Customer'}</span>
                            <span class="font-mono text-text-secondary">${currencyUtils.format(item.total)}</span>
                        </li>
                    `).join('') : `<li><p class="text-xs text-text-secondary text-center p-2">No customer sales.</p></li>`;

                    // --- SMART FIX: ENHANCED LOW STOCK LIST (Live Data) ---
                    const lowStockProducts = firestoreData.products
                        .filter(p => p.productType === 'physical' && p.stock > 0 && p.stock < 20) // Use 20 as threshold
                        .sort((a,b) => a.stock - b.stock);

                    pane.querySelector('#low-stock-list').innerHTML = lowStockProducts.length ? lowStockProducts.map(p => {
                        let productName = p.name;
                        
                        // If this is a variant, make the name more descriptive
                        if (p.parentSKU && p.variantOptions) {
                            const parent = firestoreData.products.find(parent => parent.id === p.parentSKU);
                            const parentName = parent ? parent.name : p.name;
                            const variantInfo = Object.values(p.variantOptions).join(' / ');
                            productName = `${parentName} <span class="text-xs text-accent">(${variantInfo})</span>`;
                        }

                        return `
                        <li class="flex items-center justify-between text-sm hover:bg-bg-secondary/50 p-1.5 rounded-md">
                            <span class="font-medium text-text-primary truncate pr-4">${productName}</span>
                            <span class="font-mono text-red-400 font-semibold">${p.stock} left</span>
                        </li>`;
                    }).join('') : `<li><p class="text-xs text-text-secondary text-center p-2">All products are well-stocked.</p></li>`;
                    // --- END SMART FIX ---


                    const middlePane = pane.querySelector('#dashboard-middle-pane');

                    // Admins and Managers see cashier performance AND recent activity
                    if (appState.session.userRole === 'admin' || appState.session.userRole === 'manager') {
                        // --- Cashier Performance Logic ---
                        const salesByCashier = currentMetrics.relevantInvoices.reduce((acc, inv) => {
                            if (inv.cashierId && inv.cashierName) {
                                if (!acc[inv.cashierId]) {
                                    acc[inv.cashierId] = { name: inv.cashierName, total: 0, count: 0 };
                                }
                                acc[inv.cashierId].total += inv.totalInBaseCurrency;
                                acc[inv.cashierId].count++;
                            }
                            return acc;
                        }, {});
                        const performanceList = Object.values(salesByCashier).sort((a,b) => b.total - a.total);

                        // --- Recent Activity Logic ---
                        const recentInvoices = [...currentMetrics.relevantInvoices]
                            .sort((a, b) => new Date(b.date) - new Date(a.date))
                            .slice(0, 5);

                        // --- Combined HTML for the middle pane ---
                        middlePane.innerHTML = `
                            <div class="h-full flex flex-col">
                                <!-- Cashier Performance Section -->
                                <div class="flex-shrink-0">
                                    <h2 class="text-xl font-semibold mb-2 text-text-primary">Cashier Performance</h2>
                                    <ul class="space-y-2 overflow-y-auto pr-2" style="max-height: 15vh;">
                                    ${performanceList.length ? performanceList.map(cashier => `
                                        <li class="flex items-center justify-between text-sm hover:bg-bg-secondary/50 p-1.5 rounded-md">
                                            <span class="font-medium text-text-primary truncate pr-4">${cashier.name}</span>
                                            <div class="text-right">
                                                <span class="font-mono text-text-secondary">${currencyUtils.format(cashier.total)}</span>
                                                <span class="text-xs text-text-secondary/70 block">${cashier.count} sales</span>
                                            </div>
                                        </li>
                                    `).join('') : `<li><p class="text-xs text-text-secondary text-center p-2">No cashier sales in this period.</p></li>`}
                                    </ul>
                                </div>
                                <!-- Separator and Recent Activity Section -->
                                <div class="mt-4 pt-4 border-t border-border-color flex-grow flex flex-col min-h-0">
                                    <h2 class="text-xl font-semibold mb-2 text-text-primary">Recent Activity</h2>
                                    <div class="space-y-0 overflow-y-auto flex-grow pr-2">
                                        ${recentInvoices.length ? recentInvoices.map(inv => `
                                            <div class="flex items-center justify-between py-2 border-b border-border-color/50 last:border-b-0">
                                                <div>
                                                    <p class="font-medium text-text-primary text-sm">${inv.customerName}</p>
                                                    <p class="text-xs text-text-secondary font-mono">${inv.id}</p>
                                                </div>
                                                <div class="text-right">
                                                    <p class="font-semibold font-mono text-text-primary text-sm">${currencyUtils.format(inv.totalInBaseCurrency, inv.currency)}</p>
                                                    <p class="text-xs text-text-secondary">${new Date(inv.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                                                </div>
                                            </div>
                                        `).join('') : `<p class="text-xs text-text-secondary text-center p-4">No recent activity.</p>`}
                                    </div>
                                </div>
                            </div>`;
                    } else {
                        // This case is a fallback, but cashiers have their own dashboard view
                        middlePane.innerHTML = `
                            <h2 class="text-xl font-semibold mb-4 text-text-primary">Recent Activity</h2>
                            <div id="recent-activity-feed" class="space-y-0 max-h-[35vh] overflow-y-auto"></div>`;
                        
                        const recentInvoices = [...firestoreData.invoices]
                            .filter(inv => new Date(inv.date) >= startDate)
                            .sort((a, b) => new Date(b.date) - new Date(a.date))
                            .slice(0, 5);
                        middlePane.querySelector('#recent-activity-feed').innerHTML = recentInvoices.length ? recentInvoices.map(inv => `
                            <div class="flex items-center justify-between py-3 border-b border-border-color/50 last:border-b-0">
                                <div>
                                    <p class="font-medium text-text-primary">${inv.customerName}</p>
                                    <p class="text-xs text-text-secondary font-mono">${inv.id}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-semibold font-mono text-text-primary">${currencyUtils.format(inv.totalInBaseCurrency, inv.currency)}</p>
                                    <p class="text-xs text-text-secondary">${new Date(inv.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                                </div>
                            </div>
                        `).join('') : `<p class="text-xs text-text-secondary text-center p-4">No recent activity.</p>`;
                    }


                    const chartInvoices = firestoreData.invoices.filter(inv => {
                        const invDate = new Date(inv.date);
                         return invDate >= startDate && invDate <= endDate && inv.status !== 'Void';
                    });
                    let salesLabels, salesData;

                    if (period === 'today' || period === 'yesterday') {
                        salesLabels = Array.from({ length: 24 }, (_, i) => { const h = i % 12 === 0 ? 12 : i % 12; const ampm = i < 12 ? 'AM' : 'PM'; return `${h} ${ampm}`; });
                        salesData = Array(24).fill(0);
                        chartInvoices.forEach(inv => {
                            const hour = new Date(inv.date).getHours();
                            // --- UPDATED: Use full value including interest for chart data ---
                            let val = inv.totalInBaseCurrency;
                            if (inv.isEMI) {
                                const schedule = firestoreData.emiSchedules.find(s => s.invoiceId === inv.id);
                                if (schedule) val += (schedule.totalInterest || 0);
                            }
                            salesData[hour] += val;
                            // --- END UPDATED ---
                        });
                    } else { 
                        const salesByDay = chartInvoices.reduce((acc, inv) => {
                            const day = new Date(inv.date).toLocaleDateString([], { month: 'short', day: 'numeric'});
                            // --- UPDATED: Use full value including interest for chart data ---
                            let val = inv.totalInBaseCurrency;
                            if (inv.isEMI) {
                                const schedule = firestoreData.emiSchedules.find(s => s.invoiceId === inv.id);
                                if (schedule) val += (schedule.totalInterest || 0);
                            }
                            acc[day] = (acc[day] || 0) + val;
                            // --- END UPDATED ---
                            return acc;
                        }, {});
                        salesLabels = Object.keys(salesByDay);
                        salesData = Object.values(salesByDay);
                    }
                    
                    if (salesChart) {
                        salesChart.destroy();
                    }
                    const ctx = pane.querySelector('#sales-chart')?.getContext('2d');
                    if (!ctx) return;
                    
                    const gradient = chartStyles.createGradient(ctx, chartStyles.palettes.gentleOcean[0]);

                    salesChart = new Chart(ctx, {
                        type: 'line', 
                        data: { 
                            labels: salesLabels, 
                            datasets: [{ 
                                label: 'Sales', 
                                data: salesData, 
                                borderColor: chartStyles.palettes.gentleOcean[0],
                                backgroundColor: gradient, 
                                tension: 0.4, 
                                fill: true,
                                pointBackgroundColor: chartStyles.palettes.gentleOcean[0],
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: chartStyles.palettes.gentleOcean[0],
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                borderWidth: 2.5
                            }] 
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            scales: { 
                                y: { 
                                    beginAtZero: true, 
                                    grid: { color: 'rgba(255,255,255,0.05)'}, 
                                    ticks: { 
                                        color: '#9ca3af', 
                                        font: { family: chartStyles.fontFamily },
                                        callback: (value) => currencyUtils.format(value, appState.currentCurrency, { notation: 'compact' }) 
                                    } 
                                }, 
                                x: { 
                                    grid: { display: false }, 
                                    ticks: {
                                        color: '#9ca3af',
                                        font: { family: chartStyles.fontFamily }
                                    } 
                                } 
                            }, 
                            plugins: { 
                                chartGlow: { color: chartStyles.hexToRgba(chartStyles.palettes.gentleOcean[0], 0.25), blur: 15, offsetY: 7 },
                                legend: { display: false }, 
                                tooltip: { 
                                    enabled: true,
                                    backgroundColor: 'rgba(10, 10, 15, 0.8)',
                                    backdropFilter: 'blur(5px)',
                                    titleColor: '#fff',
                                    bodyColor: '#cbd5e1',
                                    borderColor: 'rgba(59, 130, 246, 0.5)',
                                    borderWidth: 1,
                                    padding: 12,
                                    titleFont: { family: chartStyles.fontFamily, weight: 'bold' },
                                    bodyFont: { family: chartStyles.fontFamily },
                                    callbacks: { 
                                        label: (context) => currencyUtils.format(context.raw, appState.currentCurrency) 
                                    } 
                                } 
                            },
                                interaction: {
                                intersect: false,
                                mode: 'index',
                            }
                        }
                    });
                    
                    
                    const categorySales = chartInvoices.flatMap(inv => inv.items).reduce((acc, item) => {
                        const product = firestoreData.products.find(p => p.id === item.id);
                        if (product) {
                            acc[product.category] = (acc[product.category] || 0) + (item.price * (item.qty || 1));
                        }
                        return acc;
                    }, {});

                    if (categoryChart) {
                       categoryChart.destroy();
                    }
                    const catCtx = pane.querySelector('#category-sales-chart')?.getContext('2d');
                    if (!catCtx) return;
                    categoryChart = new Chart(catCtx, {
                        type: 'doughnut', 
                        data: { 
                            labels: Object.keys(categorySales), 
                            datasets: [{ 
                                label: 'Sales', 
                                data: Object.values(categorySales), 
                                backgroundColor: chartStyles.palettes.softMeadow,
                                borderColor: 'var(--bg-primary)',
                                borderWidth: 3,
                                hoverOffset: 4 // More gentle hover effect
                            }] 
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                             animation: {
                                animateRotate: true,
                                animateScale: true,
                                duration: 1200
                            },
                            layout: {
                                padding: 10
                            },
                            plugins: { 
                                legend: { display: false }, 
                                tooltip: { 
                                    enabled: true,
                                    backgroundColor: 'rgba(10, 10, 15, 0.8)',
                                    backdropFilter: 'blur(5px)',
                                    titleColor: '#fff',
                                    bodyColor: '#cbd5e1',
                                    borderColor: 'rgba(255, 255, 255, 0.1)',
                                    borderWidth: 1,
                                    padding: 10,
                                    titleFont: { family: chartStyles.fontFamily, weight: 'bold' },
                                    bodyFont: { family: chartStyles.fontFamily },
                                    callbacks: { 
                                        label: (context) => `${context.label}: ${currencyUtils.format(context.raw)}` 
                                    } 
                                } 
                            } 
                        }
                    });

                    // --- NEW: Hourly Sales Chart ---
                    const hourlySalesData = Array(24).fill(0);
                    currentMetrics.relevantInvoices.forEach(inv => {
                        const hour = new Date(inv.date).getHours();
                        // --- UPDATED: Use full value including interest for chart data ---
                        let val = inv.totalInBaseCurrency;
                        if (inv.isEMI) {
                            const schedule = firestoreData.emiSchedules.find(s => s.invoiceId === inv.id);
                            if (schedule) val += (schedule.totalInterest || 0);
                        }
                        hourlySalesData[hour] += val;
                        // --- END UPDATED ---
                    });

                    if (hourlySalesChart) hourlySalesChart.destroy();
                    const hourlyCtx = pane.querySelector('#hourly-sales-chart')?.getContext('2d');
                    if (hourlyCtx) {
                         hourlySalesChart = new Chart(hourlyCtx, {
                            type: 'bar',
                            data: {
                                labels: Array.from({ length: 24 }, (_, i) => { const h = i % 12 === 0 ? 12 : i % 12; const ampm = i < 12 ? 'AM' : 'PM'; return `${h} ${ampm}`; }),
                                datasets: [{
                                    label: 'Sales',
                                    data: hourlySalesData,
                                    backgroundColor: chartStyles.createGradient(hourlyCtx, chartStyles.palettes.warmStone[0]),
                                    borderColor: chartStyles.palettes.warmStone[0],
                                    borderWidth: 2,
                                    borderRadius: 4,
                                }]
                            },
                             options: {
                                responsive: true, maintainAspectRatio: false,
                                plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => currencyUtils.format(c.raw) }}},
                                scales: { 
                                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)'}, ticks: { color: '#9ca3af', callback: (v) => currencyUtils.format(v, appState.currentCurrency, { notation: 'compact' }) } }, 
                                    x: { grid: { display: false }, ticks: { color: '#9ca3af' } } 
                                },
                             }
                         });
                    }

                    // --- NEW: Payment Methods Chart ---
                    const paymentMethodsData = currentMetrics.relevantInvoices.flatMap(inv => 
                        (inv.paymentDetails || []).map(p => ({...p, currency: inv.currency}))
                    ).reduce((acc, payment) => {
                        acc[payment.method] = (acc[payment.method] || 0) + currencyUtils.convertToBase(payment.amount, payment.currency);
                        return acc;
                    }, {});
                    
                    if(paymentMethodsChart) paymentMethodsChart.destroy();
                    const paymentCtx = pane.querySelector('#payment-methods-chart')?.getContext('2d');
                    if(paymentCtx && Object.keys(paymentMethodsData).length > 0) {
                        paymentMethodsChart = new Chart(paymentCtx, {
                            type: 'pie',
                            data: {
                                labels: Object.keys(paymentMethodsData),
                                datasets: [{
                                    data: Object.values(paymentMethodsData),
                                    backgroundColor: chartStyles.palettes.mutedSunset,
                                    borderColor: 'var(--bg-primary)',
                                    borderWidth: 3,
                                    hoverOffset: 8,
                                }]
                            },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                plugins: { legend: { position: 'bottom', labels: { color: '#9ca3af', usePointStyle: true, pointStyle: 'rectRounded' } }, tooltip: { callbacks: { label: (c) => `${c.label}: ${currencyUtils.format(c.raw)}` }}}
                            }
                        });
                    } else if (paymentCtx) {
                        paymentCtx.clearRect(0, 0, paymentCtx.canvas.width, paymentCtx.canvas.height);
                        paymentCtx.fillStyle = '#6b7280';
                        paymentCtx.textAlign = 'center';
                        paymentCtx.font = '14px ' + chartStyles.fontFamily;
                        paymentCtx.fillText('No payment data for this period.', paymentCtx.canvas.width / 2, paymentCtx.canvas.height / 2);
                    }

                    lucide.createIcons();
                };

                // Dashboard period scroller logic
                const periodTabs = pane.querySelector('#dashboard-period-tabs');
                const scrollLeftBtn = pane.querySelector('#dashboard-scroll-left');
                const scrollRightBtn = pane.querySelector('#dashboard-scroll-right');

                const handleDashboardOverflow = () => {
                    if (!periodTabs) return;
                    const isOverflowing = periodTabs.scrollWidth > periodTabs.clientWidth;
                    const isAtStart = periodTabs.scrollLeft < 5;
                    const isAtEnd = periodTabs.scrollLeft + periodTabs.clientWidth >= periodTabs.scrollWidth - 5;
                    scrollLeftBtn?.classList.toggle('hidden', !isOverflowing || isAtStart);
                    scrollRightBtn?.classList.toggle('hidden', !isOverflowing || isAtEnd);
                };

                if (periodTabs && scrollLeftBtn && scrollRightBtn) {
                    scrollLeftBtn.addEventListener('click', () => periodTabs.scrollBy({ left: -200, behavior: 'smooth' }));
                    scrollRightBtn.addEventListener('click', () => periodTabs.scrollBy({ left: 200, behavior: 'smooth' }));
                    periodTabs.addEventListener('scroll', handleDashboardOverflow);
                    if ('ResizeObserver' in window) {
                        new ResizeObserver(handleDashboardOverflow).observe(periodTabs);
                    }
                    setTimeout(handleDashboardOverflow, 50); // Initial check
                }

                // Mobile dropdown toggle logic
                const dropdownBtn = pane.querySelector('#dashboard-period-dropdown-btn');
                const dropdownMenu = pane.querySelector('#dashboard-period-dropdown-menu');
                const dropdownContainer = pane.querySelector('#dashboard-period-dropdown-container');
                const dropdownIcon = dropdownBtn?.querySelector('i[data-lucide="chevron-down"]');

                if (dropdownBtn && dropdownMenu) {
                    dropdownBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const isHidden = dropdownMenu.classList.toggle('hidden');
                        dropdownIcon?.classList.toggle('rotate-180', !isHidden);
                    });
                }

                // Listener for all period selectors
                pane.querySelectorAll('[data-action="set-dashboard-period"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const target = e.currentTarget;
                        const period = target.dataset.period;
                        const label = target.dataset.label;
                        
                        // Update desktop UI
                        pane.querySelectorAll('.dashboard-period-btn').forEach(b => b.classList.remove('active'));
                        const desktopBtn = pane.querySelector(`.dashboard-period-btn[data-period="${period}"]`);
                        if (desktopBtn) desktopBtn.classList.add('active');

                        // Update mobile UI
                        const selectedLabel = pane.querySelector('#selected-period-label');
                        if (selectedLabel) selectedLabel.textContent = label;
                        
                        if (dropdownMenu) {
                            dropdownMenu.classList.add('hidden');
                            dropdownIcon?.classList.remove('rotate-180');
                        }

                        // Handle data and custom range UI
                        const customRangeContainer = pane.querySelector('#dashboard-custom-range');
                        if (period === 'custom') {
                            customRangeContainer.classList.remove('hidden');
                        } else {
                            customRangeContainer.classList.add('hidden');
                            updateDashboardData(period);
                        }
                    });
                });
                
                pane.querySelector('#dashboard-apply-range')?.addEventListener('click', () => {
                    const startInput = pane.querySelector('#dashboard-start-date');
                    const endInput = pane.querySelector('#dashboard-end-date');
                    const start = startInput.value;
                    const end = endInput.value;
                    if (start && end) {
                        if (new Date(start) > new Date(end)) {
                            showToast('Start date cannot be after the end date.', 'error');
                            return;
                        }
                        updateDashboardData('custom', {start, end});
                    } else {
                        showToast('Please select both a start and end date.', 'error');
                    }
                });

                updateDashboardData('today');
            }

            // -----------------------------------------------------------------------------
            // 7. REPLACE ENTIRE posFullRender FUNCTION (Wrapper)
            // -----------------------------------------------------------------------------
            const posFullRender = (pane) => {
                if (!pane) return;
                if (appState.settings.posLayout === 'modern') {
                    posModernLayoutRender(pane);
                } else {
                    posClassicLayoutRender(pane);
                }
                // No changes needed directly in the wrapper itself
            };

const posModernLayoutRender = (pane) => {
                if(!pane) return;
                const tabsContainer = pane.querySelector('#pos-tabs-container');
                const cartBody = pane.querySelector('#pos-modern-cart-body');
                const subtotalEl = pane.querySelector('#pos-subtotal');
                const taxEl = pane.querySelector('#pos-tax');
                const totalEl = pane.querySelector('#pos-total');
                const customerArea = pane.querySelector('#pos-customer-area');
                const activeSale = posState.sales.find(s => s.id === posState.activeSaleId);
                const scrollLeftBtn = pane.querySelector('#pos-scroll-left');
                const scrollRightBtn = pane.querySelector('#pos-scroll-right');

                tabsContainer.innerHTML = posState.sales.map(s => {
                    let statusClass = s.id === posState.activeSaleId ? 'active' : '';
                    if (s.status === 'held') statusClass += ' held';
                    return `
                    <button data-action="switch-sale" data-id="${s.id}" class="pos-tab flex items-center gap-2 px-4 py-3 text-sm font-medium shrink-0 ${statusClass}">
                        ${s.status === 'held' ? '<i data-lucide="pause-circle" class="w-4 h-4 text-yellow-400"></i>' : ''}
                        ${s.name}
                        <i data-lucide="x" data-action="close-sale" data-id="${s.id}" class="w-4 h-4 rounded-full hover:bg-bg-tertiary"></i>
                    </button>
                    `;
                }).join('') + `<button data-action="new-sale" class="px-4 py-3 text-accent hover:text-white shrink-0"><i data-lucide="plus" class="w-5 h-5"></i></button>`;
                
                const handleOverflow = () => {
                    if (!tabsContainer) return;
                    const isOverflowing = tabsContainer.scrollWidth > tabsContainer.clientWidth;
                    const isAtStart = tabsContainer.scrollLeft < 5;
                    const isAtEnd = tabsContainer.scrollLeft + tabsContainer.clientWidth >= tabsContainer.scrollWidth - 5;
                    scrollLeftBtn?.classList.toggle('hidden', !isOverflowing || isAtStart);
                    scrollRightBtn?.classList.toggle('hidden', !isOverflowing || isAtEnd);
                };
                
                handleOverflow();
                tabsContainer.removeEventListener('scroll', handleOverflow);
                tabsContainer.addEventListener('scroll', handleOverflow);
                if ('ResizeObserver' in window) {
                   new ResizeObserver(handleOverflow).observe(tabsContainer);
                }

                if(scrollLeftBtn && scrollRightBtn && tabsContainer) {
                    scrollLeftBtn.addEventListener('click', () => tabsContainer.scrollBy({ left: -250, behavior: 'smooth' }));
                    scrollRightBtn.addEventListener('click', () => tabsContainer.scrollBy({ left: 250, behavior: 'smooth' }));
                }

                if (!activeSale) {
                    cartBody.innerHTML = '<div class="text-center p-10 flex flex-col items-center justify-center h-full"><i data-lucide="shopping-cart" class="w-12 h-12 text-border-color-strong mx-auto mb-4"></i><p>No active sale.</p><p class="text-xs text-text-secondary">Create one with the + button above!</p></div>';
                    subtotalEl.textContent = currencyUtils.format(0); 
                    taxEl.textContent = currencyUtils.format(0); 
                    totalEl.textContent = currencyUtils.format(0);
                    customerArea.innerHTML = `<button data-action="add-customer-to-sale" class="btn btn-secondary text-sm p-2"><i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>Customer</button>`;
                    lucide.createIcons();
                    saveState();
                    return;
                }
                
                // --- UPDATED: Customer Display with Tier ---
                 if(activeSale.customer) {
                     // --- Get Tier Info ---
                     let tierHTML = '';
                     const tiers = firestoreData.loyaltySettings?.loyaltyTiers || [];
                     const tier = activeSale.customer.loyaltyTierId ? tiers.find(t => t.id === activeSale.customer.loyaltyTierId) : null;
                     if (tier) {
                         tierHTML = `<span class="ml-1 px-1.5 py-0.5 text-[10px] font-semibold rounded ${tier.colorClass || 'bg-gray-500/20 text-gray-300'}">${tier.name}</span>`;
                     }
                     // --- End Get Tier Info ---
             
                     customerArea.innerHTML = `
                         <div class="flex items-center gap-2 p-1 pr-1 bg-blue-900/50 rounded-lg text-blue-200 border border-blue-700">
                             <i data-lucide="user-check" class="inline w-4 h-4 ml-1"></i>
                             <span class="font-medium text-sm truncate max-w-[150px]" title="${activeSale.customer.name}">${activeSale.customer.name}</span>
                              ${tierHTML}
                             <button data-action="remove-customer-from-sale" class="ml-1 text-blue-300 hover:text-white hover:bg-red-500/50 p-1 rounded-full"><i data-lucide="x" class="w-3 h-3 pointer-events-none"></i></button>
                         </div>`;
                 } else {
                     customerArea.innerHTML = `<button data-action="add-customer-to-sale" class="btn btn-secondary text-sm p-2"><i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>Customer</button>`;
                 }
                 // --- END UPDATED ---

                cartBody.innerHTML = activeSale.cart.length ? activeSale.cart.map(item => {
                    const effectivePriceBase = item.price;
                    const hasDiscount = item.discount && item.discount.value > 0;
                    return `
                    <div class="bg-bg-primary p-3 rounded-lg flex items-center gap-4 border border-border-color shadow-sm">
                        <img src="https://placehold.co/64x64/18181b/444444?text=${encodeURIComponent(item.name)}" class="w-12 h-12 object-cover rounded-md shrink-0">
                        <div class="flex-grow overflow-hidden">
                            <p class="font-medium text-text-primary text-sm truncate">${item.name}</p>
                            <p class="font-mono text-xs text-text-secondary">${currencyUtils.format(effectivePriceBase)}</p>
                        </div>
                        <div class="flex items-center border border-border-color-strong rounded-md bg-bg-secondary shrink-0">
                             <button ${item.isSerialized ? 'disabled' : ''} data-action="decrement-qty" data-id="${item.id}" data-serial="${item.serialNumber || ''}" class="px-2 py-1 text-text-secondary hover:bg-border-color rounded-l-md disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="minus" class="w-4 h-4 pointer-events-none"></i></button>
                            <input type="number" data-action="manual-qty" data-id="${item.id}" data-serial="${item.serialNumber || ''}" value="${item.qty}" class="w-12 text-center bg-transparent focus:ring-accent focus:ring-1 focus:bg-bg-secondary border-0 p-0 font-medium text-text-primary text-sm" ${item.isSerialized ? 'readonly' : ''} step="${item.uomId && firestoreData.unitsOfMeasurement.find(u=>u.id===item.uomId)?.allowsDecimal ? '0.01' : '1'}">
                            <button ${item.isSerialized ? 'disabled' : ''} data-action="increment-qty" data-id="${item.id}" data-serial="${item.serialNumber || ''}" class="px-2 py-1 text-text-secondary hover:bg-border-color rounded-r-md disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="plus" class="w-4 h-4 pointer-events-none"></i></button>
                        </div>
                         <p class="font-mono text-text-primary w-24 text-right shrink-0">${currencyUtils.format(effectivePriceBase * item.qty)}</p>
                         <button data-action="edit-cart-item" data-id="${item.id}" data-serial="${item.serialNumber || ''}" class="text-text-secondary hover:text-accent p-1 rounded-md shrink-0"><i data-lucide="edit" class="w-4 h-4 pointer-events-none"></i></button>
                         <button data-action="remove-from-cart" data-id="${item.id}" data-serial="${item.serialNumber || ''}" class="text-danger/70 hover:text-danger p-1 rounded-md shrink-0"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                    </div>`
                }).join('') : '<div class="text-center p-10 flex flex-col items-center justify-center h-full"><i data-lucide="scan-line" class="w-12 h-12 text-border-color-strong mx-auto mb-4"></i><p class="text-text-primary">Cart is empty</p><p class="text-xs text-text-secondary mt-1">Add products from the list to get started</p></div>';

                   // --- UPDATED: Calculate totals including potential tier discount ---
                const taxRate = (appState.settings.taxRate ?? 0) / 100;
                const subtotalBase = activeSale.cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
            
                // Calculate Tier Discount
                let tierDiscountAmountBase = 0;
                let tierDiscountPercent = 0;
                const tiers = firestoreData.loyaltySettings?.loyaltyTiers || [];
                const tiersEnabled = firestoreData.loyaltySettings?.tiersEnabled || false;
                if (tiersEnabled && activeSale.customer?.loyaltyTierId) {
                    const tier = tiers.find(t => t.id === activeSale.customer.loyaltyTierId);
                    if (tier && tier.discountPercent > 0) {
                        tierDiscountPercent = tier.discountPercent;
                        tierDiscountAmountBase = subtotalBase * (tierDiscountPercent / 100);
                    }
                }
                const subtotalAfterTierDiscount = subtotalBase - tierDiscountAmountBase;
            
                // Calculate Total Discount (Manual)
                let totalDiscountAmountBase = 0;
                if (activeSale.discount && activeSale.discount.value > 0) {
                    if (activeSale.discount.type === 'percent') {
                        totalDiscountAmountBase = subtotalAfterTierDiscount * (activeSale.discount.value / 100);
                    } else { // fixed
                        totalDiscountAmountBase = activeSale.discount.value;
                    }
                }
                const subtotalAfterTotalDiscount = subtotalAfterTierDiscount - totalDiscountAmountBase;
            
                // Calculate Taxable Amount
                const taxableItemsSubtotal = activeSale.cart.filter(i => i.taxable).reduce((acc, item) => acc + (item.price * item.qty), 0);
                const proportionOfTaxable = subtotalBase > 0 ? taxableItemsSubtotal / subtotalBase : 0;
                const tierDiscountOnTaxable = tierDiscountAmountBase * proportionOfTaxable;
                const totalDiscountOnTaxable = totalDiscountAmountBase * proportionOfTaxable;
                const taxableAmount = taxableItemsSubtotal - tierDiscountOnTaxable - totalDiscountOnTaxable;
            
                const taxBase = Math.max(0, taxableAmount * taxRate);
                const totalBase = subtotalAfterTotalDiscount + taxBase;
            
                // Update UI
                pane.querySelector('#pos-subtotal').textContent = currencyUtils.format(subtotalBase);
            
                // Tier Discount Row
                const tierDiscountRow = pane.querySelector('#pos-tier-discount-row');
                const tierDiscountEl = pane.querySelector('#pos-tier-discount');
                if (tierDiscountAmountBase > 0) {
                    if (!tierDiscountRow) {
                         const subtotalRow = pane.querySelector('#pos-subtotal').closest('div'); // Find the parent div of subtotal
                        if (subtotalRow) {
                            subtotalRow.insertAdjacentHTML('afterend', `
                                <div id="pos-tier-discount-row" class="flex justify-between">
                                    <p class="text-text-secondary">Tier Discount (${tierDiscountPercent}%):</p>
                                    <p id="pos-tier-discount" class="font-mono text-purple-400"></p>
                                </div>
                            `);
                        }
                    }
                    pane.querySelector('#pos-tier-discount-row').classList.remove('hidden');
                    pane.querySelector('#pos-tier-discount').textContent = `-${currencyUtils.format(tierDiscountAmountBase)}`;
                } else if (tierDiscountRow) {
                    tierDiscountRow.classList.add('hidden');
                }
            
                // Total Discount Row
                const totalDiscountRow = pane.querySelector('#pos-discount-row');
                const totalDiscountEl = pane.querySelector('#pos-discount');
                if (totalDiscountAmountBase > 0) {
                    totalDiscountRow.classList.remove('hidden');
                    totalDiscountEl.textContent = `-${currencyUtils.format(totalDiscountAmountBase)}`;
                } else {
                    totalDiscountRow.classList.add('hidden');
                }
            
                pane.querySelector('#pos-tax').textContent = currencyUtils.format(taxBase);
                pane.querySelector('#pos-total').textContent = currencyUtils.format(totalBase);
                // --- END UPDATED ---
                // Scroll to the bottom of the cart to show the latest item
                cartBody.scrollTop = cartBody.scrollHeight;

                lucide.createIcons();
                saveState();
            };
           // --- UPDATED FUNCTION: posClassicLayoutRender ---
const posClassicLayoutRender = (pane) => {
    // ... (This function is updated to display serial numbers in the cart)
    if(!pane) return;
    const tabsContainer = pane.querySelector('#pos-tabs-container');
    const cartBody = pane.querySelector('#pos-cart-body');
    const subtotalEl = pane.querySelector('#pos-subtotal');
    const taxEl = pane.querySelector('#pos-tax');
    const totalEl = pane.querySelector('#pos-total');
    const customerDisplay = pane.querySelector('#pos-customer-display');
    const activeSale = posState.sales.find(s => s.id === posState.activeSaleId);
    const scrollLeftBtn = pane.querySelector('#pos-scroll-left');
    const scrollRightBtn = pane.querySelector('#pos-scroll-right');

    // ... (tab rendering logic is unchanged)
    tabsContainer.innerHTML = posState.sales.map(s => {
        let statusClass = s.id === posState.activeSaleId ? 'active' : '';
        if (s.status === 'held') statusClass += ' held';
        return `
        <button data-action="switch-sale" data-id="${s.id}" class="pos-tab flex items-center gap-2 px-4 py-3 text-sm font-medium shrink-0 ${statusClass}">
            ${s.status === 'held' ? '<i data-lucide="pause-circle" class="w-4 h-4 text-yellow-400"></i>' : ''}
            ${s.name}
            <i data-lucide="x" data-action="close-sale" data-id="${s.id}" class="w-4 h-4 rounded-full hover:bg-bg-tertiary"></i>
        </button>
        `;
    }).join('') + `<button data-action="new-sale" class="px-4 py-3 text-accent hover:text-white shrink-0"><i data-lucide="plus" class="w-5 h-5"></i></button>`;
    
    const handleOverflow = () => {
        if (!tabsContainer) return;
        const isOverflowing = tabsContainer.scrollWidth > tabsContainer.clientWidth;
        const isAtStart = tabsContainer.scrollLeft < 5;
        const isAtEnd = tabsContainer.scrollLeft + tabsContainer.clientWidth >= tabsContainer.scrollWidth - 5;
        scrollLeftBtn?.classList.toggle('hidden', !isOverflowing || isAtStart);
        scrollRightBtn?.classList.toggle('hidden', !isOverflowing || isAtEnd);
    };
    
    handleOverflow();
    tabsContainer.removeEventListener('scroll', handleOverflow);
    tabsContainer.addEventListener('scroll', handleOverflow);
    if ('ResizeObserver' in window) {
       new ResizeObserver(handleOverflow).observe(tabsContainer);
    }

    if (scrollLeftBtn && scrollRightBtn) {
        scrollLeftBtn.addEventListener('click', () => tabsContainer.scrollBy({ left: -250, behavior: 'smooth' }));
        scrollRightBtn.addEventListener('click', () => tabsContainer.scrollBy({ left: 250, behavior: 'smooth' }));
    }

    // --- RENDER CART & TOTALS ---
  if (!activeSale) {
        cartBody.innerHTML = '<tr><td colspan="5"><div class="text-center p-10 flex flex-col items-center justify-center h-full"><i data-lucide="shopping-cart" class="w-12 h-12 text-border-color-strong mx-auto mb-4"></i><p>No active sale.</p><p class="text-xs text-text-secondary">Create one with the + button above!</p></div></td></tr>';
        subtotalEl.textContent = currencyUtils.format(0);
        taxEl.textContent = currencyUtils.format(0);
        totalEl.textContent = currencyUtils.format(0);
        customerDisplay.classList.add('hidden');
        customerDisplay.innerHTML = '';
        lucide.createIcons();
        saveState();
        return;
    }

    // --- UPDATED: Customer Display with Tier ---
    if(activeSale.customer) {
        customerDisplay.classList.remove('hidden');
        // --- Get Tier Info ---
        let tierHTML = '';
        const tiers = firestoreData.loyaltySettings?.loyaltyTiers || [];
        const tier = activeSale.customer.loyaltyTierId ? tiers.find(t => t.id === activeSale.customer.loyaltyTierId) : null;
        if (tier) {
            tierHTML = `<span class="ml-2 px-2 py-0.5 text-xs font-semibold rounded-full ${tier.colorClass || 'bg-gray-500/20 text-gray-300'}">${tier.name}</span>`;
        }
        // --- End Get Tier Info ---
        customerDisplay.innerHTML = `
            <div class="bg-bg-secondary border border-border-color rounded-xl p-4 flex items-center gap-4 transition-all duration-300">
                <div class="w-11 h-11 rounded-full bg-gradient-to-br from-blue-500 to-accent flex items-center justify-center shrink-0 ring-4 ring-bg-secondary">
                    <i data-lucide="user" class="w-6 h-6 text-white"></i>
                </div>
                <div class="flex-grow overflow-hidden">
                    <p class="text-sm text-text-secondary -mb-1">Customer Added</p>
                    <div class="flex items-center">
                         <p class="font-bold text-text-primary text-lg leading-tight truncate" title="${activeSale.customer.name}">${activeSale.customer.name}</p>
                         ${tierHTML}
                    </div>
                </div>
                <button data-action="remove-customer-from-sale" class="text-text-secondary hover:text-danger hover:bg-danger/10 p-2 rounded-full transition-colors ml-auto">
                    <i data-lucide="x" class="w-5 h-5 pointer-events-none"></i>
                </button>
            </div>`;
        } else {
            customerDisplay.classList.add('hidden');
            customerDisplay.innerHTML = '';
        }
        // --- END UPDATED ---

        // UPDATED cart body rendering
       cartBody.innerHTML = activeSale.cart.length ? activeSale.cart.map(item => {
        const effectivePriceBase = item.price;
        const itemTotal = effectivePriceBase * (item.qty || 1);
        const isSerialized = item.isSerialized; // Check this flag

        return `
        <tr class="border-b border-border-color last:border-b-0 hover:bg-bg-secondary/50">
            <td class="px-6 py-4">
                <div class="flex items-center gap-4">
                    <img src="https://placehold.co/64x64/18181b/444444?text=${encodeURIComponent(item.name)}" class="w-10 h-10 object-cover rounded-md shrink-0">
                    <div class="flex-grow overflow-hidden">
                        <p class="font-medium text-text-primary text-sm truncate">${item.name}</p>
                        <p class="font-mono text-xs text-text-secondary">${isSerialized ? item.serialNumber : item.id}</p>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4">
                <div class="flex items-center justify-center border border-border-color-strong rounded-md bg-bg-secondary shrink-0 max-w-[120px] mx-auto">
                    <button ${isSerialized ? 'disabled' : ''} data-action="decrement-qty" data-id="${item.id}" data-serial="${item.serialNumber || ''}" class="px-2 py-1 text-text-secondary hover:bg-border-color rounded-l-md disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="minus" class="w-4 h-4 pointer-events-none"></i></button>
                    <input type="number" data-action="manual-qty" data-id="${item.id}" data-serial="${item.serialNumber || ''}" value="${item.qty}" class="w-12 text-center bg-transparent focus:ring-accent focus:ring-1 focus:bg-bg-secondary border-0 p-0 font-medium text-text-primary text-sm" ${isSerialized ? 'readonly' : ''} step="${item.uomId && firestoreData.unitsOfMeasurement.find(u=>u.id===item.uomId)?.allowsDecimal ? '0.01' : '1'}">
                    <button ${isSerialized ? 'disabled' : ''} data-action="increment-qty" data-id="${item.id}" data-serial="${item.serialNumber || ''}" class="px-2 py-1 text-text-secondary hover:bg-border-color rounded-r-md disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="plus" class="w-4 h-4 pointer-events-none"></i></button>
                </div>
            </td>
            <td class="px-6 py-4 font-mono">${currencyUtils.format(effectivePriceBase)}</td>
            <td class="px-6 py-4 font-mono text-text-primary font-semibold">${currencyUtils.format(itemTotal)}</td>
            <td class="px-6 py-4 text-right">
                 <div class="flex items-center justify-end gap-2">
                    <button data-action="edit-cart-item" data-id="${item.id}" data-serial="${item.serialNumber || ''}" class="text-text-secondary hover:text-accent p-1 rounded-md"><i data-lucide="edit" class="w-4 h-4 pointer-events-none"></i></button>
                    <button data-action="remove-from-cart" data-id="${item.id}" data-serial="${item.serialNumber || ''}" class="text-danger/70 hover:text-danger p-1 rounded-md"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                </div>
            </td>
        </tr>
        `
    }).join('') : `<tr><td colspan="5" class="text-center p-10"><i data-lucide="scan-line" class="w-12 h-12 text-border-color-strong mx-auto mb-4"></i><p class="text-text-primary">Cart is empty</p><p class="text-xs text-text-secondary mt-1">Add products from the list to get started</p></td></tr>`;

    // ... (rest of the function, including totals calculation, remains unchanged)
    const taxRate = (appState.settings.taxRate ?? 0) / 100;
    const subtotalBase = activeSale.cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
    
    // let discountAmountBase = 0;
    // Calculate Tier Discount (Applied after line item discounts, before total discount)
    let tierDiscountAmountBase = 0;
    let tierDiscountPercent = 0;
    const tiers = firestoreData.loyaltySettings?.loyaltyTiers || [];
    const tiersEnabled = firestoreData.loyaltySettings?.tiersEnabled || false;
    if (tiersEnabled && activeSale.customer?.loyaltyTierId) {
        const tier = tiers.find(t => t.id === activeSale.customer.loyaltyTierId);
        if (tier && tier.discountPercent > 0) {
            tierDiscountPercent = tier.discountPercent;
            tierDiscountAmountBase = subtotalBase * (tierDiscountPercent / 100);
        }
    }
    const subtotalAfterTierDiscount = subtotalBase - tierDiscountAmountBase;

    // Calculate Total Discount (Manual)
    let totalDiscountAmountBase = 0;
    if (activeSale.discount && activeSale.discount.value > 0) {
        if (activeSale.discount.type === 'percent') {
            totalDiscountAmountBase = subtotalAfterTierDiscount * (activeSale.discount.value / 100);
        } else { // fixed
            totalDiscountAmountBase = activeSale.discount.value; // Assume value is already in base currency
        }
    }
    const subtotalAfterTotalDiscount = subtotalAfterTierDiscount - totalDiscountAmountBase;

    // Calculate Taxable Amount (adjust for discounts proportionally)
    const taxableItemsSubtotal = activeSale.cart.filter(i => i.taxable).reduce((acc, item) => acc + (item.price * item.qty), 0);
    const proportionOfTaxable = subtotalBase > 0 ? taxableItemsSubtotal / subtotalBase : 0;
    const tierDiscountOnTaxable = tierDiscountAmountBase * proportionOfTaxable;
    const totalDiscountOnTaxable = totalDiscountAmountBase * proportionOfTaxable; // Assuming total discount applies proportionally too
    const taxableAmount = taxableItemsSubtotal - tierDiscountOnTaxable - totalDiscountOnTaxable;

    const taxBase = Math.max(0, taxableAmount * taxRate); // Ensure tax isn't negative
    const totalBase = subtotalAfterTotalDiscount + taxBase;
    
        // Update UI Elements
    pane.querySelector('#pos-subtotal').textContent = currencyUtils.format(subtotalBase);

    // Tier Discount Row (Show if applicable)
    const tierDiscountRow = pane.querySelector('#pos-tier-discount-row'); // You'll need to add this ID in the HTML structure below
    const tierDiscountEl = pane.querySelector('#pos-tier-discount');
    if (tierDiscountAmountBase > 0) {
        if (!tierDiscountRow) { // Add row if it doesn't exist
            subtotalEl.closest('.space-y-3').insertAdjacentHTML('beforeend', `
                <div id="pos-tier-discount-row" class="flex justify-between">
                    <p class="text-text-secondary">Tier Discount (${tierDiscountPercent}%):</p>
                    <p id="pos-tier-discount" class="font-mono text-purple-400"></p>
                </div>
            `);
        }
        pane.querySelector('#pos-tier-discount-row').classList.remove('hidden');
        pane.querySelector('#pos-tier-discount').textContent = `-${currencyUtils.format(tierDiscountAmountBase)}`;
    } else if (tierDiscountRow) {
        tierDiscountRow.classList.add('hidden');
    }

    // Total Discount Row
    const totalDiscountRow = pane.querySelector('#pos-discount-row');
    const totalDiscountEl = pane.querySelector('#pos-discount');
    if (totalDiscountAmountBase > 0) {
        totalDiscountRow.classList.remove('hidden');
        totalDiscountEl.textContent = `-${currencyUtils.format(totalDiscountAmountBase)}`;
    } else {
        totalDiscountRow.classList.add('hidden');
    }

    pane.querySelector('#pos-tax').textContent = currencyUtils.format(taxBase);
    pane.querySelector('#pos-total').textContent = currencyUtils.format(totalBase);
    // --- END UPDATED ---

    const scrollContainer = cartBody.closest('.overflow-y-auto');
    if (scrollContainer) scrollContainer.scrollTop = scrollContainer.scrollHeight;

    lucide.createIcons();
    saveState();
};

           
// --- UPDATED FUNCTION: openVariantSelectorModal ---
function openVariantSelectorModal(parentProduct) {
    // ... (This function is heavily modified for serialization)
    const variants = firestoreData.products.filter(p => p.parentSKU === parentProduct.id);
    if (variants.length === 0) {
        showToast('This product has no variants defined.', 'error');
        return;
    }

    let selectedOptions = {};
    let selectedVariant = null;
    let quantity = 1;
    const isSerialized = parentProduct.isSerialized; // NEW check

    const content = `
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
            <div class="md:col-span-2">
                 <img id="variant-image" src="https://placehold.co/400x400/18181b/444444?text=${encodeURIComponent(parentProduct.name)}" class="w-full h-auto aspect-square object-cover rounded-lg">
            </div>
            <div class="md:col-span-3 flex flex-col">
                <p class="text-sm text-text-secondary">Select options for</p>
                <h3 class="text-2xl font-bold text-text-primary mb-4">${parentProduct.name}</h3>
                <div id="variant-options-container" class="space-y-4 flex-grow">
                    <!-- Attribute buttons will be rendered here -->
                </div>
                <div id="selected-variant-info" class="mt-4 p-4 bg-bg-tertiary rounded-lg flex items-center justify-center text-text-secondary">
                    <!-- Variant details will be rendered here -->
                </div>
            </div>
        </div>
    `;
    const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="add-variant-to-cart-btn" class="btn btn-primary" disabled>Add to Cart</button>`;
    const modal = showModal('Select Variant', content, footer, {size: 'max-w-4xl'});
    
    // NEW: Function to open the serial selector modal
    const openSerialSelectorForPOS = (variant, callback) => {
        const activeSale = posState.sales.find(s => s.id === posState.activeSaleId);
        const usedSerials = new Set(activeSale ? activeSale.cart.filter(item => item.isSerialized).map(item => item.serialNumber) : []);
        const availableSerials = (variant.serials || []).filter(sn => !usedSerials.has(sn));

        if (availableSerials.length === 0) {
            showToast('No available serial numbers for this variant.', 'error');
            return;
        }

        const serialContent = `
            <p class="mb-4">Select a serial number for <strong>${parentProduct.name} (${Object.values(variant.variantOptions).join('/')})</strong>.</p>
            <select id="serial-selector" class="form-select w-full">
                ${availableSerials.map(sn => `<option value="${sn}">${sn}</option>`).join('')}
            </select>
        `;
        const serialFooter = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-serial-pos" class="btn btn-primary">Add to Cart</button>`;
        const serialModal = showModal('Select Serial Number', serialContent, serialFooter);

        serialModal.querySelector('#confirm-serial-pos').addEventListener('click', () => {
            const selectedSerial = serialModal.querySelector('#serial-selector').value;
            callback(selectedSerial);
            closeModal(serialModal);
        });
    };

    const renderVariantUI = () => {
        const availableOptionsByAttr = {};
        parentProduct.variantAttributes.forEach(attr => {
            const otherSelections = {...selectedOptions};
            delete otherSelections[attr];

            const possibleVariants = variants.filter(v => 
                Object.entries(otherSelections).every(([key, val]) => v.variantOptions[key] === val)
            );
            availableOptionsByAttr[attr] = new Set(possibleVariants.map(v => v.variantOptions[attr]));
        });

        modal.querySelector('#variant-options-container').innerHTML = parentProduct.variantAttributes.map(attr => {
            const options = [...new Set(variants.map(v => v.variantOptions[attr]))];
            return `
            <div class="variant-attribute-group">
                <label class="block text-sm font-medium mb-2">${attr}</label>
                <div class="flex flex-wrap gap-2">
                    ${options.map(opt => {
                        const isSelected = selectedOptions[attr] === opt;
                        const isAvailable = availableOptionsByAttr[attr].has(opt);
                        return `
                        <button type="button" data-action="select-variant-option" data-attribute="${attr}" data-value="${opt}"
                            class="variant-option-btn ${isSelected ? 'active' : ''}" ${!isAvailable ? 'disabled' : ''}>
                            ${opt}
                        </button>`;
                    }).join('')}
                </div>
            </div>`;
        }).join('');

        const infoEl = modal.querySelector('#selected-variant-info');
        const addBtn = modal.querySelector('#add-variant-to-cart-btn');
        selectedVariant = null;
        const allOptionsSelected = Object.keys(selectedOptions).length === parentProduct.variantAttributes.length && Object.values(selectedOptions).every(v => v);

        if (allOptionsSelected) {
            selectedVariant = variants.find(v => parentProduct.variantAttributes.every(attr => v.variantOptions[attr] === selectedOptions[attr]));
            
            if (selectedVariant) {
                const stock = selectedVariant.stock || 0;
                const isOutOfStock = stock <= 0;
                
                let qtyControlsHTML = '';
                if (isSerialized) {
                    qtyControlsHTML = `<p class="text-sm text-text-secondary">Quantity: 1 (Serialized)</p>`;
                } else {
                    qtyControlsHTML = `
                    <div class="flex items-center border border-border-color-strong rounded-md bg-bg-secondary shrink-0">
                        <button data-action="adjust-qty" data-amount="-1" class="px-3 py-2 text-text-secondary hover:bg-border-color rounded-l-md" ${isOutOfStock ? 'disabled' : ''}><i data-lucide="minus" class="w-4 h-4 pointer-events-none"></i></button>
                        <span id="variant-qty" class="px-4 py-1 text-center font-medium text-text-primary text-lg">${quantity}</span>
                        <button data-action="adjust-qty" data-amount="1" class="px-3 py-2 text-text-secondary hover:bg-border-color rounded-r-md" ${isOutOfStock ? 'disabled' : ''}><i data-lucide="plus" class="w-4 h-4 pointer-events-none"></i></button>
                    </div>`;
                }

                infoEl.innerHTML = `
                    <div class="flex items-center justify-between w-full gap-4">
                        <div class="flex-grow">
                            <div class="flex justify-between items-baseline">
                                <span class="font-mono text-xs text-text-secondary">${selectedVariant.id}</span>
                                <span class="font-bold text-lg ${isOutOfStock ? 'text-red-400' : 'text-green-400'}">${isOutOfStock ? 'Out of Stock' : `${stock} in Stock`}</span>
                            </div>
                            <p class="text-2xl font-bold text-accent font-mono mt-1">${currencyUtils.format(selectedVariant.price)}</p>
                        </div>
                        ${qtyControlsHTML}
                    </div>
                `;
                addBtn.disabled = isOutOfStock;
                addBtn.textContent = `Add ${isSerialized ? '' : quantity + ' '}to Cart`;
                lucide.createIcons();
            } else {
                infoEl.innerHTML = `<span class="text-yellow-400">This combination is not available.</span>`;
                addBtn.disabled = true;
                addBtn.textContent = 'Add to Cart';
            }
        } else {
            infoEl.innerHTML = `<span class="text-text-secondary">Select all options to see details.</span>`;
            addBtn.disabled = true;
            addBtn.textContent = 'Add to Cart';
        }
    };

    modal.addEventListener('click', e => {
        const optionBtn = e.target.closest('[data-action="select-variant-option"]');
        const qtyBtn = e.target.closest('[data-action="adjust-qty"]');
        const addBtn = e.target.closest('#add-variant-to-cart-btn');

        if (optionBtn) {
            const { attribute, value } = optionBtn.dataset;
            if (selectedOptions[attribute] === value) {
                delete selectedOptions[attribute];
            } else {
                selectedOptions[attribute] = value;
            }
            quantity = 1;
            renderVariantUI();
        }

        if (qtyBtn && selectedVariant) {
            const amount = parseInt(qtyBtn.dataset.amount);
            const newQty = quantity + amount;
            if (newQty > 0 && newQty <= selectedVariant.stock) {
                quantity = newQty;
                modal.querySelector('#variant-qty').textContent = quantity;
                modal.querySelector('#add-variant-to-cart-btn').textContent = `Add ${quantity} to Cart`;
            }
        }

        if (addBtn && selectedVariant) {
            const activeSale = posState.sales.find(s => s.id === posState.activeSaleId);
            if (!activeSale) { showToast('No active sale selected.', 'error'); return; }
            
            if (isSerialized) {
                // Open serial selector
                openSerialSelectorForPOS(selectedVariant, (selectedSerial) => {
                    activeSale.cart.push({ ...selectedVariant, qty: 1, serialNumber: selectedSerial });
                    posFullRender(document.querySelector('#workspace-content .view-pane'));
                    closeModal(modal);
                    showToast('Serialized item added to cart.', 'success');
                });
            } else {
                // Original non-serialized logic
                const existingItem = activeSale.cart.find(item => item.id === selectedVariant.id);
                if (existingItem) {
                    const newTotalQty = existingItem.qty + quantity;
                    if (newTotalQty <= selectedVariant.stock) {
                        existingItem.qty = newTotalQty;
                    } else {
                        showToast(`Cannot add ${quantity}. Only ${selectedVariant.stock - existingItem.qty} more available.`, 'warning');
                        return;
                    }
                } else {
                    activeSale.cart.push({ ...selectedVariant, qty: quantity });
                }
                posFullRender(document.querySelector('#workspace-content .view-pane'));
                closeModal(modal);
            }
        }
    });

    renderVariantUI();
}


// --- REPLACED FUNCTION: addProductToActiveCart ---
            const addProductToActiveCart = (product) => {
                // This function is now a gateway that checks for variants
                if (product.hasVariants) {
                    openVariantSelectorModal(product);
                    return; // Stop here, the modal will handle adding the actual variant.
                }

                // Original logic for non-variant products
                const activeSale = posState.sales.find(s => s.id === posState.activeSaleId);
                if (!activeSale) { showToast('No active sale selected.', 'error'); return; }
                if(product.stock <= 0 && product.productType === 'physical') { showToast(`${product.name} is out of stock.`, 'error'); return; }

                if (product.isSerialized) {
                    const availableSerials = product.serials || [];
                    if(availableSerials.length === 0) { showToast(`${product.name} has no serial numbers in stock.`, 'error'); return; }
                    
                    const content = `
                        <p class="mb-4">Select a serial number for <strong>${product.name}</strong>.</p>
                        <select id="serial-selector" class="form-select w-full">
                            ${availableSerials.map(sn => `<option value="${sn}">${sn}</option>`).join('')}
                        </select>
                    `;
                    const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-serial" class="btn btn-primary">Add to Cart</button>`;
                    const modal = showModal('Select Serial Number', content, footer);

                    modal.querySelector('#confirm-serial').addEventListener('click', () => {
                        const selectedSerial = modal.querySelector('#serial-selector').value;
                         if (activeSale.cart.some(item => item.serialNumber === selectedSerial)) {
                            showToast(`Serial number ${selectedSerial} is already in the cart.`, 'error');
                            return;
                        }
                        activeSale.cart.push({ ...product, qty: 1, serialNumber: selectedSerial });
                        posFullRender(workspaceContent.querySelector('.view-pane'));
                        closeModal(modal);
                    });
                    return;
                }

                const existingItem = activeSale.cart.find(item => item.id === product.id);
                if(existingItem) {
                    if(existingItem.qty < product.stock) {
                        existingItem.qty++;
                    } else {
                        showToast(`No more stock available for ${product.name}.`, 'warning');
                        return;
                    }
                } else {
                    activeSale.cart.push({ ...product, qty: 1 });
                }
                posFullRender(workspaceContent.querySelector('.view-pane'));
            };
            
            const initClassicPOS = (pane) => {
                posClassicLayoutRender(pane);

                const searchInput = pane.querySelector('#pos-search');
                const resultsContainer = pane.querySelector('#pos-search-results');
                let activeSearchIndex = -1;

                const handleSelection = (product) => {
                    if(!product) return;
                    addProductToActiveCart(product);
                    searchInput.value = '';
                    resultsContainer.innerHTML = '';
                    resultsContainer.classList.add('hidden');
                    searchInput.focus();
                };

                searchInput.addEventListener('input', e => {
                    const query = e.target.value.toLowerCase();
                    if (!query) {
                        resultsContainer.classList.add('hidden');
                        return;
                    }
                    const filtered = firestoreData.products.filter(p => (p.status || 'active') === 'active' && !p.parentSKU && (p.name.toLowerCase().includes(query) || p.id.toLowerCase().includes(query) || p.barcode?.includes(query))).slice(0, 7);
                    
                    if (filtered.length > 0) {
                        resultsContainer.innerHTML = filtered.map(p => {
                            let stockInfo = '';
                            if (p.hasVariants) {
                                const variants = firestoreData.products.filter(v => v.parentSKU === p.id);
                                const totalStock = variants.reduce((sum, v) => sum + (v.stock || 0), 0);
                                stockInfo = `Total Stock: ${totalStock} (${variants.length} variants)`;
                            } else {
                                stockInfo = `Stock: ${p.productType === 'physical' ? (p.stock || 0) : 'N/A'}`;
                            }
                            return `
                            <div class="search-result-item p-3 cursor-pointer" data-id="${p.id}">
                                <p class="font-medium text-text-primary pointer-events-none">${p.name} ${p.hasVariants ? '<i data-lucide="boxes" class="inline w-3 h-3 ml-1 text-accent"></i>' : ''}</p>
                                <p class="text-xs text-text-secondary font-mono pointer-events-none">ID: ${p.id} / ${stockInfo}</p>
                            </div>`;
                        }).join('');
                        resultsContainer.classList.remove('hidden');
                        lucide.createIcons();
                    } else {
                        resultsContainer.innerHTML = `<p class="p-3 text-center text-text-secondary">No products found</p>`;
                        resultsContainer.classList.remove('hidden');
                    }
                    activeSearchIndex = -1;
                });
                
                resultsContainer.addEventListener('mousedown', e => {
                    const target = e.target.closest('.search-result-item');
                    if (target) {
                        const product = firestoreData.products.find(p => p.id === target.dataset.id);
                        handleSelection(product);
                    }
                });

                searchInput.addEventListener('keydown', e => {
                    const items = resultsContainer.querySelectorAll('.search-result-item');
                    
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const query = searchInput.value.trim();
                        if (!query) return;

                        // 1. Prioritize barcode scan
                        const productByBarcode = firestoreData.products.find(p => p.barcode && p.barcode === query);
                        if (productByBarcode) {
                            handleSelection(productByBarcode);
                            return;
                        }
                        
                        // 2. Check for active selection in dropdown
                        const activeItem = resultsContainer.querySelector('.search-result-item.active');
                        if (activeItem) {
                            const product = firestoreData.products.find(p => p.id === activeItem.dataset.id);
                            handleSelection(product);
                            return;
                        }

                        // 3. Fallback to SKU search
                        const productBySku = firestoreData.products.find(p => p.id.toLowerCase() === query.toLowerCase());
                        if (productBySku) {
                            handleSelection(productBySku);
                            return;
                        }
                        
                        // 4. If nothing is found
                        showToast(`Product with barcode or SKU "${query}" not found.`, 'error');
                        return;
                    }

                    if (resultsContainer.classList.contains('hidden') || items.length === 0) return;

                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        activeSearchIndex = (activeSearchIndex + 1) % items.length;
                        items.forEach((item, i) => item.classList.toggle('active', i === activeSearchIndex));
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        activeSearchIndex = (activeSearchIndex - 1 + items.length) % items.length;
                        items.forEach((item, i) => item.classList.toggle('active', i === activeSearchIndex));
                    } else if (e.key === 'Escape') {
                         resultsContainer.classList.add('hidden');
                    }
                });
                
                searchInput.addEventListener('blur', () => setTimeout(() => resultsContainer.classList.add('hidden'), 150));

                const cartBody = pane.querySelector('#pos-cart-body');
                if (cartBody) {
                    cartBody.addEventListener('change', e => {
                        const qtyInput = e.target.closest('input[data-action="manual-qty"]');
                        if (qtyInput) {
                            const activeSale = posState.sales.find(s => s.id === posState.activeSaleId);
                            if (activeSale) {
                                const { id, serial } = qtyInput.dataset;
                                const item = activeSale.cart.find(i => i.isSerialized ? i.serialNumber === serial : i.id === id);
                                if (item) {
                                    let newQty = parseFloat(qtyInput.value);
                                    const uom = firestoreData.unitsOfMeasurement.find(u => u.id === item.uomId) || { allowsDecimal: false };
                                    if (!uom.allowsDecimal) newQty = Math.round(newQty);
                                    if (isNaN(newQty) || newQty <= 0) newQty = 1;
                                    
                                    const stock = item.stock ?? Infinity;

                                    if (item.productType === 'physical' && newQty > stock) {
                                        showToast(`Only ${stock} units available.`, 'warning');
                                        newQty = stock;
                                    }
                                    
                                    item.qty = newQty;
                                    posFullRender(pane);
                                }
                            }
                        }
                    });
                }
                
                const scrollLeftBtn = pane.querySelector('#pos-scroll-left');
                const scrollRightBtn = pane.querySelector('#pos-scroll-right');
                const tabsContainer = pane.querySelector('#pos-tabs-container');

                if(scrollLeftBtn && scrollRightBtn && tabsContainer) {
                    scrollLeftBtn.addEventListener('click', () => tabsContainer.scrollBy({ left: -250, behavior: 'smooth' }));
                    scrollRightBtn.addEventListener('click', () => tabsContainer.scrollBy({ left: 250, behavior: 'smooth' }));
                }
            };

            const applyPosCategoryPanelState = (pane) => {
                const categoryContainer = pane.querySelector('#pos-category-container');
                if (!categoryContainer) return;

                const isCollapsed = appState.viewStates.posModern?.isCategoryPanelCollapsed || false;
                categoryContainer.classList.toggle('category-sidebar-collapsed', isCollapsed);

                const productsGrid = categoryContainer.querySelector('#pos-modern-products-grid');
                if (productsGrid) {
                    if (isCollapsed) {
                        productsGrid.classList.remove('md:grid-cols-3');
                        productsGrid.classList.add('md:grid-cols-4');
                    } else {
                        productsGrid.classList.remove('md:grid-cols-4');
                        productsGrid.classList.add('md:grid-cols-3');
                    }
                }
            };

            const initModernPOS = (pane) => {
                posModernLayoutRender(pane);
                applyPosCategoryPanelState(pane);

                const categoriesContainer = pane.querySelector('#pos-modern-categories');
                const productsGrid = pane.querySelector('#pos-modern-products-grid');
                const productTitle = pane.querySelector('#pos-modern-product-title');
                const paginationContainer = pane.querySelector('#pos-modern-products-pagination');
                
                let activeCategory = appState.viewStates.posModern.activeCategory || 'top-sellers';
                if (appState.viewStates.posModern.productGridPage === undefined) {
                    appState.viewStates.posModern.productGridPage = 1;
                }

                const renderCategories = () => {
                     const categories = [...new Set(firestoreData.products.filter(p => p.category).map(p => p.category))];
                     const collapsedCategories = appState.viewStates.posModern?.collapsedCategories || [];
                     categoriesContainer.innerHTML = `
                        <div class="category-group ${collapsedCategories.includes('Main') ? '' : 'is-open'}" data-group-id="Main">
                            <button data-action="toggle-category-collapse" class="category-group-header">
                                <span>Main</span>
                                <i data-lucide="chevron-up" class="category-group-icon"></i>
                            </button>
                            <div class="category-group-list">
                                <div class="space-y-1 py-1">
                                    <a href="#" data-category-id="top-sellers" class="pos-category-btn ${activeCategory === 'top-sellers' ? 'active' : ''}"><i data-lucide="star" class="w-4 h-4 mr-3"></i> Top Sellers</a>
                                    <a href="#" data-category-id="all" class="pos-category-btn ${activeCategory === 'all' ? 'active' : ''}"><i data-lucide="layout-grid" class="w-4 h-4 mr-3"></i> All Products</a>
                                </div>
                            </div>
                        </div>
                        <div class="category-group ${collapsedCategories.includes('Categories') ? '' : 'is-open'}" data-group-id="Categories">
                             <button data-action="toggle-category-collapse" class="category-group-header">
                                <span>${getCurrentProfile().terminology.category}s</span>
                                <i data-lucide="chevron-up" class="category-group-icon"></i>
                            </button>
                            <div class="category-group-list">
                                <div class="space-y-1 py-1">
                                    ${categories.map(c => `<a href="#" data-category-id="${c}" class="pos-category-btn ${activeCategory === c ? 'active' : ''}"><i data-lucide="tag" class="w-4 h-4 mr-3"></i> ${c}</a>`).join('')}
                                </div>
                            </div>
                        </div>
                     `;
                     lucide.createIcons();
                };

                const renderProducts = (categoryId) => {
                    const posProductsPerPage = 24; // Number of products per page in the grid
                    const viewState = appState.viewStates.posModern;

                    let productsToShow = [];
                    // NEW: Filter out inactive products from all POS views
                    const activeProducts = firestoreData.products.filter(p => (p.status || 'active') === 'active');

                    if (categoryId === 'top-sellers') {
                        productTitle.textContent = "Top Sellers";
                        productsToShow = activeProducts.filter(p => !p.parentSKU).sort((a,b) => (b.sales || 0) - (a.sales || 0)).slice(0, 12);
                    } else if (categoryId === 'all') {
                        productTitle.textContent = "All Products";
                        productsToShow = activeProducts.filter(p => !p.parentSKU);
                    } else {
                        productTitle.textContent = categoryId;
                        productsToShow = activeProducts.filter(p => p.category === categoryId && !p.parentSKU);
                    }
                    
                    // --- PAGINATION LOGIC START ---
                    const totalItems = productsToShow.length;
                    const totalPages = Math.ceil(totalItems / posProductsPerPage);

                    // If a filter change makes the current page invalid, reset to 1
                    if (viewState.productGridPage > totalPages) {
                        viewState.productGridPage = 1;
                    }
                    const currentPage = viewState.productGridPage || 1;
                    const startIndex = (currentPage - 1) * posProductsPerPage;
                    const paginatedProducts = productsToShow.slice(startIndex, startIndex + posProductsPerPage);
                    // --- PAGINATION LOGIC END ---

                    productsGrid.innerHTML = paginatedProducts.length ? paginatedProducts.map(p => {
                        let priceHTML;
                        let totalStock = p.stock;
                        let isOutOfStock;

                        if (p.hasVariants) {
                            const variants = firestoreData.products.filter(v => v.parentSKU === p.id);
                            const prices = variants.map(v => v.price || 0).filter(v => v > 0);
                            
                            if (prices.length > 0) {
                                const minPrice = Math.min(...prices);
                                const maxPrice = Math.max(...prices);
                                priceHTML = minPrice === maxPrice 
                                    ? currencyUtils.format(minPrice) 
                                    : `${currencyUtils.format(minPrice)} - ${currencyUtils.format(maxPrice)}`;
                            } else {
                                priceHTML = currencyUtils.format(0); // Default to 0 if no priced variants
                            }
                            totalStock = variants.reduce((sum, v) => sum + (v.stock || 0), 0);
                        } else {
                            priceHTML = currencyUtils.format(p.price || 0);
                        }
                        
                        isOutOfStock = p.productType === 'physical' && totalStock <= 0;
                        const isLowStock = p.productType === 'physical' && totalStock > 0 && totalStock < 10;
                        
                        let stockBadgeHTML = '';
                        if (isOutOfStock) {
                            stockBadgeHTML = '<div class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-lg"><span class="text-white font-bold text-sm bg-red-600/80 px-2 py-1 rounded">OUT OF STOCK</span></div>';
                        } else if (isLowStock) {
                            stockBadgeHTML = `<div class="absolute top-2 right-2"><span class="text-yellow-900 font-bold text-xs bg-yellow-400 px-2 py-1 rounded-full shadow-lg">${totalStock} LEFT</span></div>`;
                        }
                        
                        return `
                        <button data-action="add-product-from-grid" data-id="${p.id}" class="product-grid-item" ${isOutOfStock ? 'disabled' : ''}>
                            <div class="flex-grow flex flex-col">
                                <div class="relative">
                                    <img src="https://placehold.co/200x200/18181b/444444?text=${encodeURIComponent(p.name)}" class="w-full h-auto aspect-square object-cover rounded-lg ${isOutOfStock ? 'opacity-40' : ''}">
                                    ${stockBadgeHTML}
                                </div>
                                <div class="mt-3 flex-grow flex flex-col justify-center min-h-[3rem]">
                                    <p class="font-semibold text-base text-text-primary leading-tight truncate" title="${p.name}">${p.name}</p>
                                </div>
                            </div>
                            <p class="font-mono text-base text-accent mt-2">${priceHTML}</p>
                        </button>
                        `
                    }).join('') : `<div class="col-span-full text-center p-8 text-text-secondary">No ${getCurrentProfile().terminology.product}s in this category.</div>`;
                
                    // --- RENDER PAGINATION CONTROLS ---
                    if (paginationContainer) {
                        if (totalPages > 1) {
                            paginationContainer.classList.remove('hidden');
                            paginationContainer.innerHTML = `
                                <div class="flex items-center justify-between text-sm text-text-secondary">
                                    <div>Page <span class="font-medium text-text-primary">${currentPage}</span> of <span class="font-medium text-text-primary">${totalPages}</span></div>
                                    <div class="flex items-center gap-2">
                                        <button data-action="pos-product-paginate" data-page="${currentPage - 1}" class="pagination-arrow-btn" ${currentPage === 1 ? 'disabled' : ''}>
                                            <i data-lucide="chevron-left" class="w-5 h-5 pointer-events-none"></i>
                                        </button>
                                        <button data-action="pos-product-paginate" data-page="${currentPage + 1}" class="pagination-arrow-btn" ${currentPage === totalPages ? 'disabled' : ''}>
                                            <i data-lucide="chevron-right" class="w-5 h-5 pointer-events-none"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                            lucide.createIcons();
                        } else {
                            paginationContainer.innerHTML = '';
                            paginationContainer.classList.add('hidden');
                        }
                    }
                };
                
                renderCategories();
                renderProducts(activeCategory);

                categoriesContainer.addEventListener('click', e => {
                    const categoryBtn = e.target.closest('.pos-category-btn');
                    if (categoryBtn) {
                        e.preventDefault();
                        activeCategory = categoryBtn.dataset.categoryId;
                        appState.viewStates.posModern.activeCategory = activeCategory;
                        appState.viewStates.posModern.productGridPage = 1; // Reset page on category change
                        saveState();
                        categoriesContainer.querySelectorAll('.pos-category-btn').forEach(btn => btn.classList.remove('active'));
                        categoryBtn.classList.add('active');
                        renderProducts(activeCategory);
                    }

                    const collapseBtn = e.target.closest('[data-action="toggle-category-collapse"]');
                    if (collapseBtn) {
                        e.preventDefault();
                        const group = collapseBtn.parentElement;
                        const groupId = group.dataset.groupId;
                        const isClosing = group.classList.contains('is-open');
                        
                        group.classList.toggle('is-open');

                        const collapsedList = appState.viewStates.posModern.collapsedCategories || [];
                        const index = collapsedList.indexOf(groupId);

                        if (isClosing) {
                            // Add to list if it's not already there
                            if (index === -1) collapsedList.push(groupId);
                        } else {
                            // Remove from list if it exists
                            if (index > -1) collapsedList.splice(index, 1);
                        }
                        appState.viewStates.posModern.collapsedCategories = collapsedList;
                        saveState(); // Persist the change immediately
                    }
                });
                
                productsGrid.addEventListener('click', e => {
                    const target = e.target.closest('[data-action="add-product-from-grid"]');
                    if (target) {
                        const product = firestoreData.products.find(p => p.id === target.dataset.id);
                        if (product) addProductToActiveCart(product);
                    }
                });

                const searchInput = pane.querySelector('#pos-modern-search');
                const resultsContainer = pane.querySelector('#pos-search-results');
                
                const handleSelection = (product) => {
                    if(!product) return;
                    addProductToActiveCart(product);
                    searchInput.value = '';
                    resultsContainer.innerHTML = '';
                    resultsContainer.classList.add('hidden');
                    searchInput.focus();
                };

                searchInput.addEventListener('input', e => {
                    const query = e.target.value.toLowerCase();
                    if (!query) { resultsContainer.classList.add('hidden'); return; }
                    const filtered = firestoreData.products.filter(p => (p.status || 'active') === 'active' && !p.parentSKU && (p.name.toLowerCase().includes(query) || p.id.toLowerCase().includes(query) || p.barcode?.includes(query))).slice(0, 7);
                    if (filtered.length > 0) {
                        resultsContainer.innerHTML = filtered.map(p => {
                            let stockInfo = '';
                            if (p.hasVariants) {
                                const variants = firestoreData.products.filter(v => v.parentSKU === p.id);
                                const totalStock = variants.reduce((sum, v) => sum + (v.stock || 0), 0);
                                stockInfo = `Total Stock: ${totalStock} (${variants.length} variants)`;
                            } else {
                                stockInfo = `Stock: ${p.productType === 'physical' ? (p.stock || 0) : 'N/A'}`;
                            }
                            return `<div class="search-result-item p-3 cursor-pointer" data-id="${p.id}">
                                <p class="font-medium text-text-primary pointer-events-none">${p.name} ${p.hasVariants ? '<i data-lucide="boxes" class="inline w-3 h-3 ml-1 text-accent"></i>' : ''}</p>
                                <p class="text-xs text-text-secondary font-mono pointer-events-none">ID: ${p.id} / ${stockInfo}</p>
                            </div>`;
                        }).join('');
                        lucide.createIcons();
                        resultsContainer.classList.remove('hidden');
                    } else { resultsContainer.classList.add('hidden'); }
                });
                resultsContainer.addEventListener('mousedown', e => {
                    const target = e.target.closest('.search-result-item');
                    if (target) {
                        const product = firestoreData.products.find(p => p.id === target.dataset.id);
                        handleSelection(product);
                    }
                });

                searchInput.addEventListener('keydown', e => {
                    const items = resultsContainer.querySelectorAll('.search-result-item');
                    let activeSearchIndex = Array.from(items).findIndex(item => item.classList.contains('active'));

                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const query = searchInput.value.trim();
                        if (!query) return;

                        // 1. Prioritize barcode scan
                        const productByBarcode = firestoreData.products.find(p => p.barcode && p.barcode === query);
                        if (productByBarcode) {
                            handleSelection(productByBarcode);
                            return;
                        }
                        
                        // 2. Check for active selection in dropdown
                        const activeItem = resultsContainer.querySelector('.search-result-item.active');
                        if (activeItem) {
                            const product = firestoreData.products.find(p => p.id === activeItem.dataset.id);
                            handleSelection(product);
                            return;
                        }

                        // 3. Fallback to SKU search
                        const productBySku = firestoreData.products.find(p => p.id.toLowerCase() === query.toLowerCase());
                        if (productBySku) {
                            handleSelection(productBySku);
                            return;
                        }
                        
                        // 4. If nothing is found and there are results, select the first one
                        if(items.length > 0) {
                            const product = firestoreData.products.find(p => p.id === items[0].dataset.id);
                            handleSelection(product);
                            return;
                        }

                        showToast(`Product with barcode or SKU "${query}" not found.`, 'error');
                        return;
                    }

                    if (resultsContainer.classList.contains('hidden') || items.length === 0) return;

                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        activeSearchIndex = (activeSearchIndex + 1) % items.length;
                        items.forEach((item, i) => item.classList.toggle('active', i === activeSearchIndex));
                        if (items[activeSearchIndex]) items[activeSearchIndex].scrollIntoView({ block: 'nearest' });
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        activeSearchIndex = (activeSearchIndex - 1 + items.length) % items.length;
                        items.forEach((item, i) => item.classList.toggle('active', i === activeSearchIndex));
                        if (items[activeSearchIndex]) items[activeSearchIndex].scrollIntoView({ block: 'nearest' });
                    } else if (e.key === 'Escape') {
                         resultsContainer.classList.add('hidden');
                    }
                });

                searchInput.addEventListener('blur', () => setTimeout(() => resultsContainer.classList.add('hidden'), 150));
            
                // Collapsible sidebar logic
                const categoryContainer = pane.querySelector('#pos-category-container');
                const categoryPanel = pane.querySelector('#pos-category-panel');
                const toggleBtn = pane.querySelector('#pos-category-sidebar-toggle');
                const toggleIcon = toggleBtn?.querySelector('i');

                if (toggleBtn && categoryPanel && categoryContainer && toggleIcon) {
                    // This single function now handles all state and position updates for the toggle.
                    const syncSidebar = () => {
                        const isCollapsed = categoryContainer.classList.contains('category-sidebar-collapsed');
                        
                        // Update the icon based on the state
                        toggleIcon.setAttribute('data-lucide', isCollapsed ? 'chevron-right' : 'chevron-left');
                        lucide.createIcons();
                        
                        // Update the button's position
                        if (isCollapsed) {
                            toggleBtn.style.left = '0px';
                        } else {
                            // Position at the edge of the visible panel
                            toggleBtn.style.left = `${categoryPanel.offsetWidth - 1}px`;
                        }
                    };
                    
                    // Use ResizeObserver to detect any change in the panel's size.
                    // This is the most robust way to handle repositioning after animations or other layout shifts.
                    if ('ResizeObserver' in window) {
                        new ResizeObserver(() => {
                            // We wrap this in a requestAnimationFrame to ensure the repositioning happens
                            // smoothly after the browser has finished its rendering work for the resize.
                            requestAnimationFrame(syncSidebar);
                        }).observe(categoryPanel);
                    } else {
                        // Fallback for very old browsers: sync on transition end and initial load.
                        categoryPanel.addEventListener('transitionend', syncSidebar);
                        syncSidebar();
                    }
                    
                    // Run once on initialization to set the correct initial state.
                    syncSidebar();
                }

                const cartBody = pane.querySelector('#pos-modern-cart-body');
                if (cartBody) {
                    cartBody.addEventListener('change', e => {
                        const qtyInput = e.target.closest('input[data-action="manual-qty"]');
                        if (qtyInput) {
                            const activeSale = posState.sales.find(s => s.id === posState.activeSaleId);
                            if (activeSale) {
                                const { id, serial } = qtyInput.dataset;
                                const item = activeSale.cart.find(i => i.isSerialized ? i.serialNumber === serial : i.id === id);
                                if (item) {
                                    let newQty = parseFloat(qtyInput.value);
                                    const uom = firestoreData.unitsOfMeasurement.find(u => u.id === item.uomId) || { allowsDecimal: false };
                                    if (!uom.allowsDecimal) newQty = Math.round(newQty);
                                    if (isNaN(newQty) || newQty <= 0) newQty = 1;
                                    
                                    const stock = item.stock ?? Infinity;

                                    if (item.productType === 'physical' && newQty > stock) {
                                        showToast(`Only ${stock} units available.`, 'warning');
                                        newQty = stock;
                                    }
                                    
                                    item.qty = newQty;
                                    posFullRender(pane);
                                }
                            }
                        }
                    });
                }
            };
            
            function initPOS(pane) {
                if (posState.sales.length === 0) {
                    const newSaleId = `sale_${Date.now()}`;
                    posState.sales.push({ id: newSaleId, name: `Sale ${posState.saleCounter++}`, cart: [], customer: null, status: 'active', discount: { type: 'percent', value: 0 } });
                    posState.activeSaleId = newSaleId;
                }

                if (appState.settings.posLayout === 'modern') {
                    initModernPOS(pane);
                } else {
                    initClassicPOS(pane);
                }
            }
function openPaymentModal() {
    const activeSale = posState.sales.find(s => s.id === posState.activeSaleId);
    if (!activeSale || activeSale.cart.length === 0) { showToast('Cart is empty!', 'error'); return; }

    // --- NEW DISCOUNT LOGIC ---
    const taxRate = (appState.settings.taxRate ?? 0) / 100;
    const subtotalBase = activeSale.cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
    const customer = activeSale.customer;
    
    // 1. Find best persistent discount
    let tierDiscountPercent = 0;
    let customerTier = null;
    const tiers = firestoreData.loyaltySettings?.loyaltyTiers || [];
    const tiersEnabled = firestoreData.loyaltySettings?.tiersEnabled || false;
    
    if (tiersEnabled && customer?.loyaltyTierId) {
        customerTier = tiers.find(t => t.id === customer.loyaltyTierId);
        if (customerTier && customerTier.discountPercent > 0) {
            tierDiscountPercent = customerTier.discountPercent;
        }
    }
    
    const staffDiscountPercent = customer?.staffDiscountPercent || 0;
    const lifetimeDiscountPercent = customer?.lifetimeDiscountPercent || 0;
    
    const bestPersistentPercent = Math.max(staffDiscountPercent, lifetimeDiscountPercent, tierDiscountPercent);
    const persistentDiscountAmountBase = subtotalBase * (bestPersistentPercent / 100);
    const subtotalAfterPersistent = subtotalBase - persistentDiscountAmountBase;

    // 2. Apply manual discount
    let manualDiscountAmountBase = 0;
    if (activeSale.discount && activeSale.discount.value > 0) {
        if (activeSale.discount.type === 'percent') {
            manualDiscountAmountBase = subtotalAfterPersistent * (activeSale.discount.value / 100);
        } else { // fixed
            manualDiscountAmountBase = activeSale.discount.value;
        }
    }
    const subtotalAfterTotalDiscount = subtotalAfterPersistent - manualDiscountAmountBase;
    
    // 3. Calculate Tax
    const taxableItemsSubtotal = activeSale.cart.filter(i => i.taxable).reduce((acc, item) => acc + (item.price * item.qty), 0);
    const proportionOfTaxable = subtotalBase > 0 ? taxableItemsSubtotal / subtotalBase : 0;
    
    // Pro-rate both discounts
    const persistentDiscountOnTaxable = persistentDiscountAmountBase * proportionOfTaxable;
    // Manual discount's proportion is relative to the subtotal it was applied to
    const manualDiscountProportion = subtotalAfterPersistent > 0 ? (taxableItemsSubtotal - persistentDiscountOnTaxable) / subtotalAfterPersistent : 0;
    const manualDiscountOnTaxable = manualDiscountAmountBase * manualDiscountProportion;

    const taxableAmount = taxableItemsSubtotal - persistentDiscountOnTaxable - manualDiscountOnTaxable;
    const taxBase = Math.max(0, taxableAmount * taxRate);
    
    // 4. Final Total
    const totalBase = subtotalAfterTotalDiscount + taxBase;
    // --- END NEW DISCOUNT LOGIC ---

    const totalCurrent = currencyUtils.convert(totalBase);

 const getSmartSuggestions = (totalDue) => {
        const suggestions = new Set();
        if (totalDue > 1 && totalDue % 1 !== 0) suggestions.add(Math.ceil(totalDue));
        const denominations = [10, 20, 50, 100, 500, 1000, 5000, 10000];
        denominations.forEach(d => {
            if (totalDue < d * 4 && totalDue > d/10) {
                const rounded = Math.ceil(totalDue / d) * d;
                if(rounded > totalDue) suggestions.add(rounded);
            }
        });
        let finalSuggestions = [...suggestions].sort((a, b) => a - b);
        if (finalSuggestions.length < 3) {
            let lastNum = Math.max(totalDue, ...finalSuggestions);
            while(finalSuggestions.length < 3 && lastNum < totalDue * 5) {
                const magnitude = Math.pow(10, Math.floor(Math.log10(lastNum)));
                lastNum = Math.ceil((lastNum + 1) / (magnitude/2)) * (magnitude/2);
                if (!finalSuggestions.includes(lastNum)) finalSuggestions.push(lastNum);
            }
        }
        return [...new Set(finalSuggestions)].slice(0, 3);
    };

    const quickCashButtons = [...getSmartSuggestions(totalCurrent), 'Exact'];

    const paymentState = {
        total: totalCurrent,
        payments: [], activePaymentMethod: 'Cash', userInputStarted: false,
        get totalPaid() { return this.payments.reduce((sum, p) => sum + p.amount, 0); },
        get remaining() { return this.total - this.totalPaid; }
    };

    const getPaymentIcons = (method) => ({
        'Cash': 'dollar-sign',
        'Card': 'credit-card',
        'Mobile Banking': 'smartphone',
        'bKash': 'smartphone',
        'Nagad': 'smartphone',
        'Rocket': 'smartphone',
        'Upay': 'smartphone',
        'Add to Due': 'file-plus-2'
    })[method] || 'dollar-sign';

    // --- NEW: Persistent Discount Label ---
    let persistentLabel = 'Persistent Discount';
    if (bestPersistentPercent > 0) {
        if (bestPersistentPercent === staffDiscountPercent) persistentLabel = `Staff Discount (${staffDiscountPercent}%)`;
        else if (bestPersistentPercent === lifetimeDiscountPercent) persistentLabel = `Lifetime Discount (${lifetimeDiscountPercent}%)`;
        else if (bestPersistentPercent === tierDiscountPercent) persistentLabel = `${customerTier?.name || 'Tier'} Discount (${tierDiscountPercent}%)`;
    }
    // --- END NEW ---

    const content = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 -m-6 p-0">
        <!-- Left Side: Keypad & Info -->
        <div class="bg-[var(--bg-secondary)]/50 p-6 rounded-l-xl flex flex-col">
            <div class="flex-1 space-y-4">
                <p class="text-text-secondary">Total Due</p>
                <p class="text-6xl font-bold text-text-primary font-mono tracking-tighter">${currencyUtils.format(totalBase, appState.currentCurrency, { currencyDisplay: 'symbol' })}</p>
                                <!-- NEW: Totals Breakdown -->
                <div class="space-y-1 text-sm pt-2">
                    <div class="flex justify-between text-text-secondary"><span>Subtotal:</span><span class="font-mono">${currencyUtils.format(subtotalBase)}</span></div>
                    ${persistentDiscountAmountBase > 0 ? `
                        <div class="flex justify-between text-purple-400">
                            <span>${persistentLabel}:</span>
                            <span class="font-mono">-${currencyUtils.format(persistentDiscountAmountBase)}</span>
                        </div>
                    ` : ''}
                    ${manualDiscountAmountBase > 0 ? `
                        <div class="flex justify-between text-red-400">
                            <span>Manual Discount:</span>
                            <span class="font-mono">-${currencyUtils.format(manualDiscountAmountBase)}</span>
                        </div>
                    ` : ''}
                    <div class="flex justify-between text-text-secondary"><span>Tax:</span><span class="font-mono">${currencyUtils.format(taxBase)}</span></div>
                </div>
                <!-- END NEW -->
                <div id="payment-status-display" class="h-16"></div>
                <div class="space-y-2 pt-2" id="payment-splits-container"></div>
            </div>
            <div class="grid grid-cols-4 gap-2">
                ${quickCashButtons.map(val => { 
                    const amount = val === 'Exact' ? totalCurrent.toFixed(2) : val.toFixed(2);
                    const amountInBase = val === 'Exact' ? (totalBase) : (val / currencyUtils.get().rate);

                    const useCompact = val > 99999 && val !== 'Exact';
                    const display = val === 'Exact' ? 'Exact' : currencyUtils.format(
                        amountInBase,
                        appState.currentCurrency,
                        {
                            notation: useCompact ? 'compact' : 'standard',
                            maximumFractionDigits: useCompact ? 1 : 0
                        }
                    );

                    let textSize = 'text-lg';
                    if (display.length > 8) textSize = 'text-sm';
                    else if (display.length > 6) textSize = 'text-base';

                    return `<button data-payment-action="quick-cash" data-amount="${amount}" class="keypad-btn rounded-md h-12 ${textSize} font-semibold px-1 flex items-center justify-center">${display}</button>`
                }).join('')}
            </div>
        </div>
        <!-- Right Side: Actions -->
        <div class="p-6 flex flex-col">
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button data-payment-action="set-method" data-method="Cash" class="payment-method-btn btn btn-secondary h-16 flex-col gap-1 active"><i data-lucide="dollar-sign" class="w-6 h-6"></i>Cash</button>
                <button data-payment-action="set-method" data-method="Card" class="payment-method-btn btn btn-secondary h-16 flex-col gap-1"><i data-lucide="credit-card" class="w-6 h-6"></i>Card</button>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
                 <button data-payment-action="set-method" data-method="Mobile Banking" class="payment-method-btn btn btn-secondary h-16 flex-col gap-1"><i data-lucide="smartphone" class="w-6 h-6"></i>M-Banking</button>
                 <button data-payment-action="set-method" data-method="Add to Due" class="payment-method-btn btn btn-secondary h-16 flex-col gap-1" ${!activeSale.customer ? 'disabled' : ''} title="${!activeSale.customer ? 'Select a customer to enable due payment' : ''}"><i data-lucide="file-plus-2" class="w-6 h-6"></i>Add to Due</button>
            </div>

            <div id="mobile-banking-view" class="hidden my-4">
                <p class="text-sm text-center text-text-secondary mb-3">Select Mobile Banking Service</p>
                <div class="grid grid-cols-2 gap-3">
                    <button data-payment-action="set-mobile-method" data-method="bKash" class="btn btn-secondary h-16">bKash</button>
                    <button data-payment-action="set-mobile-method" data-method="Nagad" class="btn btn-secondary h-16">Nagad</button>
                    <button data-payment-action="set-mobile-method" data-method="Rocket" class="btn btn-secondary h-16">Rocket</button>
                    <button data-payment-action="set-mobile-method" data-method="Upay" class="btn btn-secondary h-16">Upay</button>
                </div>
            </div>

            <div id="payment-entry-view">
                <div class="relative mb-4">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-2xl font-mono text-text-secondary">${currencyUtils.get().symbol}</span>
                    <input type="text" id="payment-input" class="form-input w-full text-right text-4xl font-mono p-4 pr-6 bg-transparent" value="${paymentState.remaining.toFixed(2)}" readonly>
                </div>
                <div class="grid grid-cols-3 gap-2 flex-1">
                    ${['1', '2', '3', '4', '5', '6', '7', '8', '9', '00', '0', '.'].map(key => `<button data-payment-action="keypad" data-key="${key}" class="keypad-btn rounded-md text-2xl font-mono h-12">${key}</button>`).join('')}
                    <button data-payment-action="keypad" data-key="del" class="keypad-btn rounded-md text-2xl font-mono h-12 flex items-center justify-center"><i data-lucide="delete" class="w-6 h-6 pointer-events-none"></i></button>
                </div>
                <button id="add-payment-btn" data-payment-action="add-payment" class="btn btn-primary w-full mt-4 text-lg py-4">Add Payment</button>
            </div>
        </div>
    </div>`;

    const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel Transaction</button><button id="finalize-payment" class="btn btn-success text-white" disabled><i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>Finalize Payment</button>`;
    const modal = showModal('Process Payment', content, footer, {size: 'max-w-4xl', customClasses: 'p-0'});
    lucide.createIcons();

    const inputEl = modal.querySelector('#payment-input');
    const statusDisplay = modal.querySelector('#payment-status-display');
    const splitsContainer = modal.querySelector('#payment-splits-container');
    const addPaymentBtn = modal.querySelector('#add-payment-btn');
    const finalizeBtn = modal.querySelector('#finalize-payment');
    const paymentEntryView = modal.querySelector('#payment-entry-view');
    const mobileBankingView = modal.querySelector('#mobile-banking-view');

    const renderPaymentState = () => {
        const remainingValue = parseFloat(paymentState.remaining.toPrecision(15));
        inputEl.value = remainingValue > 0 ? remainingValue.toFixed(2) : '0.00';
        const remainingBase = remainingValue / currencyUtils.get().rate;
        const formattedRemaining = currencyUtils.format(remainingBase);
        const formattedChange = currencyUtils.format(Math.abs(remainingBase));

        finalizeBtn.removeAttribute('title'); // Clear title first

        if (remainingValue > 0.001) {
            statusDisplay.innerHTML = `<p class="text-text-secondary">Amount Remaining</p><p class="text-4xl font-bold text-danger font-mono tracking-tight">- ${formattedRemaining}</p>`;
            const inputValue = parseFloat(inputEl.value) || 0;
            addPaymentBtn.textContent = `Add ${currencyUtils.get().symbol}${inputValue.toFixed(2)} Payment`;
            addPaymentBtn.disabled = inputValue <= 0;

            let canFinalize = false;
            let reason = "A payment is still due.";

            if (activeSale.customer) {
                const customer = firestoreData.customers.find(c => c.id === activeSale.customer.id);
                if (customer) {
                    const potentialDue = (customer.currentDue || 0) + remainingBase;
                    if (customer.creditLimit === undefined || customer.creditLimit === null || potentialDue <= customer.creditLimit) {
                         canFinalize = true;
                    } else {
                        reason = `Remaining amount exceeds customer's credit limit of ${currencyUtils.format(customer.creditLimit || 0)}. New Due: ${currencyUtils.format(potentialDue)}`;
                    }
                } else {
                     reason = "Selected customer could not be found.";
                }
            } else {
                reason = "Select a customer to finalize a due payment.";
            }

            finalizeBtn.disabled = !canFinalize;
            if (!canFinalize) {
                finalizeBtn.setAttribute('title', reason);
            }

        } else {
            const change = Math.abs(remainingValue);
            statusDisplay.innerHTML = `<p class="text-text-secondary">Change Due</p><p class="text-4xl font-bold text-success font-mono tracking-tight">${formattedChange}</p>`;
            addPaymentBtn.textContent = 'Add Payment';
            addPaymentBtn.disabled = true;
            finalizeBtn.disabled = false;
        }

        splitsContainer.innerHTML = paymentState.payments.map((p, i) => `
            <div class="payment-split-item flex items-center justify-between p-2 bg-bg-tertiary rounded-md text-sm">
                <div class="flex items-center gap-2"><i data-lucide="${getPaymentIcons(p.method)}" class="w-4 h-4 text-accent"></i><span>${p.method} Payment</span></div>
                <div class="flex items-center gap-2"><span class="font-mono text-text-primary font-medium">${currencyUtils.get().symbol}${p.amount.toFixed(2)}</span><button data-payment-action="remove-split" data-index="${i}" class="text-danger/70 hover:text-danger"><i data-lucide="x" class="w-4 h-4 pointer-events-none"></i></button></div>
            </div>
        `).join('');
        lucide.createIcons();
        paymentState.userInputStarted = false;
    };

    modal.addEventListener('click', e => { /* ... (no changes needed in event handling logic) ... */
        const target = e.target.closest('[data-payment-action]');
        if (!target) return;
        const { paymentAction, method, amount, key, index } = target.dataset;

        switch (paymentAction) {
            case 'set-method':
                modal.querySelectorAll('.payment-method-btn').forEach(btn => btn.classList.remove('active'));
                target.classList.add('active');

                if (method === 'Mobile Banking') {
                    paymentEntryView.classList.add('hidden');
                    mobileBankingView.classList.remove('hidden');
                } else {
                    paymentEntryView.classList.remove('hidden');
                    mobileBankingView.classList.add('hidden');
                    paymentState.activePaymentMethod = method;
                    if (method === 'Add to Due') {
                        inputEl.value = paymentState.remaining.toFixed(2);
                        addPaymentBtn.click();
                    }
                }
                break;
             case 'set-mobile-method':
                paymentState.activePaymentMethod = method;
                paymentEntryView.classList.remove('hidden');
                mobileBankingView.classList.add('hidden');
                break;
            case 'quick-cash':
                inputEl.value = parseFloat(amount).toFixed(2);
                paymentState.userInputStarted = true;
                paymentState.activePaymentMethod = 'Cash';
                modal.querySelectorAll('.payment-method-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.method === 'Cash'));
                addPaymentBtn.click();
                break;
            case 'keypad': {
                let currentVal = inputEl.value;
                if (!paymentState.userInputStarted) {
                    currentVal = '';
                    paymentState.userInputStarted = true;
                }

                if (key === 'del') {
                    currentVal = currentVal.slice(0, -1) || '';
                } else if (key === '.' && !currentVal.includes('.')) {
                    currentVal += '.';
                } else if (key === '00' && currentVal !== '0') {
                    currentVal += '00';
                } else if (!isNaN(parseInt(key))) {
                    if (currentVal === '0' && key !== '.') {
                        currentVal = key;
                    } else {
                        if (currentVal.length < 12) currentVal += key;
                    }
                }
                inputEl.value = currentVal;
                break;
            }
            case 'add-payment': {
                const paymentAmount = parseFloat(inputEl.value);
                if (paymentAmount > 0) {
                    paymentState.payments.push({ method: paymentState.activePaymentMethod, amount: paymentAmount, ref: (paymentState.activePaymentMethod !== 'Cash' ? `TRX_${Date.now()}`: null) });
                    renderPaymentState();
                }
                break;
            }
             case 'remove-split':
                paymentState.payments.splice(parseInt(index), 1);
                renderPaymentState();
                break;
        }
        if (paymentAction === 'keypad' || paymentAction === 'set-method' || paymentAction === 'set-mobile-method') {
             const inputValue = parseFloat(inputEl.value) || 0;
             if(paymentState.remaining > 0.001) {
                addPaymentBtn.textContent = `Add ${currencyUtils.get().symbol}${inputValue.toFixed(2)} ${paymentState.activePaymentMethod} Payment`;
                addPaymentBtn.disabled = inputValue <= 0;
             }
        }
    });

    inputEl.addEventListener('input', () => { /* ... (no changes needed) ... */
        const inputValue = parseFloat(inputEl.value) || 0;
        if(paymentState.remaining > 0.001) {
            addPaymentBtn.textContent = `Add ${currencyUtils.get().symbol}${inputValue.toFixed(2)} Payment`;
            addPaymentBtn.disabled = inputValue <= 0;
        }
    });

    finalizeBtn.addEventListener('click', async () => {
        const newInvoiceRef = doc(invoicesRef);

        // --- ADDED LOADING STATE ---
        const originalBtnHTML = finalizeBtn.innerHTML;
        finalizeBtn.disabled = true;
        finalizeBtn.innerHTML = `<div class="loader-sm"></div> Processing...`;
        // --- END ADDED ---
        
        try {
            // Define customer variable in scope so it's available for the receipt later
            const customer = activeSale.customer ? firestoreData.customers.find(c => c.id === activeSale.customer.id) : null;

            await runTransaction(db, async (transaction) => {
                // --- READS ---
                // const customer = activeSale.customer ? firestoreData.customers.find(c => c.id === activeSale.customer.id) : null; // Moved up
                const actualPaidAmountCurrent = paymentState.payments.filter(p => p.method !== 'Add to Due').reduce((sum, p) => sum + p.amount, 0);
                const remainingAmountCurrent = totalCurrent - actualPaidAmountCurrent;
                const remainingAmountBase = remainingAmountCurrent > 0.001 ? currencyUtils.convertToBase(remainingAmountCurrent) : 0;

                const productRefs = {}; const productDocPromises = [];
                for (const item of activeSale.cart) { if (!productRefs[item.id]) { const productRef = doc(productsRef, item.id); productRefs[item.id] = productRef; productDocPromises.push(transaction.get(productRef)); } }
                let customerRef = null; let customerDocPromise = null;
                if (customer) { customerRef = doc(customersRef, customer.id); customerDocPromise = transaction.get(customerRef); }
                const productDocs = await Promise.all(productDocPromises);
                const customerDoc = customerDocPromise ? await customerDocPromise : null;

                // --- WRITES ---
                // --- UPDATED: Calculate points based on paid amount, considering tier discount ---
                const amountEligibleForPoints = totalBase - remainingAmountBase; // Base currency amount paid
                const pointsEarned = Math.floor(amountEligibleForPoints * (firestoreData.loyaltySettings?.pointsPerDollar || 1));
                // --- END UPDATED ---

                // Update stock/sales
                const productUpdates = {};
                for (const cartItem of activeSale.cart) {
                     if (!productUpdates[cartItem.id]) {
                        productUpdates[cartItem.id] = { stockChange: 0, salesChange: 0, serialsToRemove: [] };
                    }
                    productUpdates[cartItem.id].stockChange -= (cartItem.qty || 1);
                    productUpdates[cartItem.id].salesChange += (cartItem.qty || 1);
                    if (cartItem.isSerialized && cartItem.serialNumber) {
                        productUpdates[cartItem.id].serialsToRemove.push(cartItem.serialNumber);
                    }
                }
                productDocs.forEach((productDoc) => {
                    if (!productDoc.exists()) throw `Product ${productDoc.id} not found!`;
                    const productData = productDoc.data();
                    const productRef = productRefs[productDoc.id];
                    const updates = productUpdates[productDoc.id];
                    const updatePayload = { sales: (productData.sales || 0) + updates.salesChange };
                    if (productData.productType === 'physical') {
                        if (productData.isSerialized) { const newSerials = (productData.serials || []).filter(sn => !updates.serialsToRemove.includes(sn)); updatePayload.serials = newSerials; updatePayload.stock = newSerials.length; }
                        else { updatePayload.stock = (productData.stock || 0) + updates.stockChange; }
                    }
                    transaction.update(productRef, updatePayload);
                });

                               // Update customer points/due
                if (customer && customerDoc) {
                    if (!customerDoc.exists()) throw `Customer ${customer.id} not found!`;
                    const customerData = customerDoc.data();
                    let newPoints = (customerData.loyaltyPoints || 0) + pointsEarned;
                    let newCustomerDue = customerData.currentDue || 0;
                    if (remainingAmountBase > 0.001) newCustomerDue += remainingAmountBase;

                    let newTierId = customerData.loyaltyTierId || null;
                    if (firestoreData.loyaltySettings?.tiersEnabled) {
                        const tiers = firestoreData.loyaltySettings.loyaltyTiers || [];
                        const eligibleTier = tiers
                            .filter(t => newPoints >= t.pointsThreshold)
                            .sort((a, b) => b.pointsThreshold - a.pointsThreshold)[0];
                        newTierId = eligibleTier ? eligibleTier.id : null;
                    }

                    const updatePayload = {
                        loyaltyPoints: newPoints,
                        currentDue: Math.max(0, newCustomerDue),
                        loyaltyTierId: newTierId
                    };

                    // --- MODIFIED: Make credit limit check optional ---
                    // Only check the limit if it's defined AND greater than 0
                    if (customerData.creditLimit && customerData.creditLimit > 0 && newCustomerDue > customerData.creditLimit) {
                         throw `Sale exceeds customer's credit limit. Limit: ${currencyUtils.format(customerData.creditLimit || 0)}, New Due: ${currencyUtils.format(newCustomerDue)}`;
                    }
                    // --- END MODIFICATION ---

                    transaction.update(customerRef, updatePayload);
                } else if (remainingAmountBase > 0.001) {
                    throw "Cannot complete a due sale without a selected customer.";
                }

                // Create invoice & warranty records
                for (const item of activeSale.cart) {
                    if (item.isSerialized && item.serialNumber) {
                        let policyId = null; const product = firestoreData.products.find(p => p.id === item.id);
                        if (product) { if (product.parentSKU) { const parentProduct = firestoreData.products.find(p => p.id === product.parentSKU); policyId = parentProduct?.defaultWarrantyPolicyId; } else { policyId = product.defaultWarrantyPolicyId; } }
                        if (!policyId) { policyId = 'standard-1-year'; }
                        const policies = appState.settings.warrantyPolicies || { 'standard-1-year': { name: "Standard 1-Year", durationMonths: 12 } };
                        const policy = policies[policyId];
                        if(policy) { const startDate = new Date(); const expiryDate = new Date(startDate); expiryDate.setMonth(startDate.getMonth() + policy.durationMonths); const newWarrantyRef = doc(warrantiesRef); transaction.set(newWarrantyRef, { id: newWarrantyRef.id, productId: item.id, productName: item.name, serialNumber: item.serialNumber, customerId: customer?.id || null, customerName: customer?.name || 'Walk-in Customer', invoiceId: newInvoiceRef.id, policyId: policyId, policyName: policy.name, startDate: startDate.toISOString(), expiryDate: expiryDate.toISOString(), status: 'active' }); } // <-- This line is now fixed
                        else { console.warn(`Warranty policy "${policyId}" not found for ${item.id}.`); }
                    }
                }

                                // --- UPDATED: Save Discount Info to Invoice ---
                // const newInvoiceRef = doc(invoicesRef); // <-- DELETED THIS LINE
                const actualPaidInBase = currencyUtils.convertToBase(actualPaidAmountCurrent);
                let invoiceStatus = 'Paid';
                if (remainingAmountBase > 0.001) invoiceStatus = (actualPaidInBase > 0.001) ? 'Partial' : 'Due';

                const newInvoice = {
                    customerId: customer?.id || null, customerName: customer?.name || 'Walk-in Customer',
                    totalInBaseCurrency: totalBase,
                    subtotalInBaseCurrency: subtotalBase,
                    
                    // --- Store ALL Discount Details ---
                    persistentDiscountDetails: {
                        staff: staffDiscountPercent,
                        lifetime: lifetimeDiscountPercent,
                        tier: tierDiscountPercent,
                        best: bestPersistentPercent,
                        amount: persistentDiscountAmountBase
                    },
                    manualDiscountInBase: manualDiscountAmountBase,
                    manualDiscountType: activeSale.discount?.type || null,
                    manualDiscountReason: activeSale.discount?.reason || null,
                    // --- End Store Discount Details ---

                    taxInBaseCurrency: taxBase,
                    dueAmount: remainingAmountBase,
                    currency: appState.currentCurrency, exchangeRate: currencyUtils.get().rate,
                    status: invoiceStatus, date: new Date().toISOString(), items: activeSale.cart,
                    paymentDetails: paymentState.payments.map(p => ({ ...p, date: new Date().toISOString() })),
                    cashierId: appState.session.currentUser.uid, cashierName: appState.session.currentUser.name,
                    storeId: appState.session.storeId,
                    pointsEarned,
                    customerTierSnapshot: customerTier
                };
                transaction.set(newInvoiceRef, newInvoice);
                // --- END UPDATED ---

                // finalizeBtn.dataset.newInvoiceId = newInvoiceRef.id; // <-- DELETED THIS LINE

                if (customer && pointsEarned !== 0) {
                    const historyRef = doc(loyaltyHistoryRef);
                    transaction.set(historyRef, {
                        customerId: customer.id,
                        date: new Date().toISOString(),
                        type: 'earn',
                        pointsChange: pointsEarned,
                        reason: `Purchase (Invoice: ${newInvoiceRef.id.slice(-6)})`,
                        invoiceId: newInvoiceRef.id,
                        newBalance: (customerDoc.data().loyaltyPoints || 0) + pointsEarned
                    });
                }
            });

            // Post-transaction
            simulateFraudDetection(totalBase, appState.session.currentUser);
            // const newInvoiceId = finalizeBtn.dataset.newInvoiceId; // <-- DELETED THIS LINE
            const newInvoiceId = newInvoiceRef.id; // <-- ADDED THIS LINE
            const finalInvoice = {id: newInvoiceId, ...await getDoc(doc(invoicesRef, newInvoiceId)).then(d => d.data())};

            // --- FIX: Attach customer object for receipt display ---
            // If we have a customer object in scope, attach it to the invoice data
            // so the receipt template can read properties like loyaltyId or address.
            if (customer) {
                finalInvoice.customer = customer;
            }
            // --- END FIX ---

            closeModal(modal);
            showReceipt(finalInvoice, paymentState);

            posState.sales = posState.sales.filter(s => s.id !== activeSale.id);
            const newSaleId = `sale_${Date.now()}`;
            posState.sales.push({ id: newSaleId, name: `Sale ${posState.saleCounter++}`, cart: [], customer: null, status: 'active', discount: { type: 'percent', value: 0 } });
            posState.activeSaleId = newSaleId;

            renderApp();

        } catch (error) {
            console.error("Payment failed:", error);
            showToast(`Transaction failed: ${error.message}`, "error");
        } finally {
            // --- RESTORE BUTTON ---
            finalizeBtn.disabled = false;
            finalizeBtn.innerHTML = originalBtnHTML;
            // --- END RESTORE ---
        }
    });

    renderPaymentState();
}
            // --- REPLACED FUNCTION: initInventory ---
            function initInventory(container) {
                if (!container) return;
                
                // --- FIX START: Remove old event listeners ---
                // By cloning the container and replacing it, we ensure that any event listeners
                // attached in previous calls to initInventory are removed, preventing them from stacking up.
                // This solves the issue of modals opening multiple times.
                const newContainer = container.cloneNode(false);
                // --- FIX START: Add a check for parentNode to prevent crash ---
                // If container.parentNode is null, the element is detached from the DOM.
                // This can happen if a lingering event listener on a removed element is triggered.
                // This check prevents the crash and keeps the UI functional.
                if (container.parentNode) {
                    container.parentNode.replaceChild(newContainer, container);
                    container = newContainer;
                } else {
                    // If the container is detached, we can't proceed. This prevents the error.
                    return; 
                }
                // --- FIX END ---
                
                const term = getCurrentProfile().terminology;
                const viewState = appState.viewStates.inventory;
                
                // Permissions
                const canAdd = checkPermission('canAddProducts');

                // Filter out child variants from the main display
                const allProducts = firestoreData.products.filter(p => !p.parentSKU);
                const categories = ['all', ...new Set(allProducts.filter(p => p.category).map(p => p.category))];

                container.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
                            <div>
                                <h1 class="text-3xl font-bold text-text-primary">${term.inventory} Management</h1>
                                <p class="text-text-secondary">View, search, and manage all your ${term.product}s.</p>
                            </div>
                            <div class="flex items-center gap-2">
                                ${canAdd ? `<button data-action="add-product" class="btn btn-primary flex-1 md:flex-none"><i data-lucide="plus" class="w-5 h-5 mr-2"></i> Add ${term.product}</button>` : ''}
                                ${canAdd ? `<button data-action="open-import-modal" data-type="products" class="btn btn-secondary flex-1 md:flex-none"><i data-lucide="upload" class="w-5 h-5 mr-2"></i> Import</button>` : ''}

                            </div>
                        </div>
                        
                        <div class="glass-pane p-4 rounded-xl">
                             <div class="flex flex-col md:flex-row gap-3">
                                <div class="relative flex-grow">
                                    <i data-lucide="search" class="absolute left-3.5 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i>
                                    <input type="text" id="inventory-search" placeholder="Search by name, SKU, category..." class="form-input w-full pl-11" value="${viewState.searchQuery}">
                                </div>
                                <select id="inventory-category-filter" class="form-select flex-shrink-0 md:w-48">${categories.map(c => `<option value="${c}" ${viewState.filters.category === c ? 'selected' : ''}>${c === 'all' ? `All ${term.category}s` : c}</option>`).join('')}</select>
                                <select id="inventory-stock-filter" class="form-select flex-shrink-0 md:w-48">
                                    <option value="all">All Stock Status</option>
                                    <option value="in_stock" ${viewState.filters.stockStatus === 'in_stock' ? 'selected' : ''}>In Stock</option>
                                    <option value="low" ${viewState.filters.stockStatus === 'low' ? 'selected' : ''}>Low Stock</option>
                                    <option value="out" ${viewState.filters.stockStatus === 'out' ? 'selected' : ''}>Out of Stock</option>
                                </select>
                                <select id="inventory-structure-filter" class="form-select flex-shrink-0 md:w-48">
                                    <option value="all" ${viewState.filters.productStructure === 'all' ? 'selected' : ''}>All Product Types</option>
                                    <option value="variants" ${viewState.filters.productStructure === 'variants' ? 'selected' : ''}>Has Variants</option>
                                    <option value="non_variants" ${viewState.filters.productStructure === 'non_variants' ? 'selected' : ''}>Non-Variants</option>
                                    <option value="serialized" ${viewState.filters.productStructure === 'serialized' ? 'selected' : ''}>Serialized</option>
                                </select>
                            </div>
                        </div>

                        <div class="bg-bg-secondary/50 rounded-xl">
                            <table class="table-pro">
                                <thead>
                                    <tr>
                                        <th>${term.product}</th>
                                        <th>Status</th>
                                        <th>Price</th>
                                        <th>Stock</th>
                                        <th>Category</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-table-body"></tbody>
                            </table>
                        </div>
                        <div id="inventory-pagination" class="mt-4"></div>
                    </div>`;

                const renderInventoryTable = () => {
                    let filteredProducts = allProducts;
                    // Apply filters
                    if (viewState.searchQuery) {
                        const query = viewState.searchQuery.toLowerCase();
                        filteredProducts = filteredProducts.filter(p => 
                            p.name.toLowerCase().includes(query) || p.id.toLowerCase().includes(query) ||
                            p.barcode?.includes(query) || (p.category || '').toLowerCase().includes(query)
                        );
                    }
                    if (viewState.filters.category !== 'all') {
                        filteredProducts = filteredProducts.filter(p => p.category === viewState.filters.category);
                    }
                     if (viewState.filters.stockStatus !== 'all') {
                        filteredProducts = filteredProducts.filter(p => {
                            const stock = p.hasVariants 
                                ? firestoreData.products.filter(v => v.parentSKU === p.id).reduce((sum, v) => sum + (v.stock || 0), 0)
                                : p.stock;
                            if (viewState.filters.stockStatus === 'low') return p.productType === 'physical' && stock > 0 && stock < 20;
                            if (viewState.filters.stockStatus === 'out') return p.productType === 'physical' && stock <= 0;
                            if (viewState.filters.stockStatus === 'in_stock') return p.productType === 'physical' && stock > 0;
                            return true;
                        });
                    }

                    // --- NEW: Apply product structure filter ---
                    if (viewState.filters.productStructure && viewState.filters.productStructure !== 'all') {
                        const structure = viewState.filters.productStructure;
                        if (structure === 'variants') {
                            filteredProducts = filteredProducts.filter(p => p.hasVariants === true);
                        } else if (structure === 'non_variants') {
                            filteredProducts = filteredProducts.filter(p => !p.hasVariants);
                        } else if (structure === 'serialized') {
                            // A product is serialized if it's a non-variant marked as serialized,
                            // OR if it's a parent product that has the 'isSerialized' flag (meaning its variants are serialized).
                            filteredProducts = filteredProducts.filter(p => p.isSerialized === true);
                        }
                    }
                    // --- END NEW ---

                    // Sort by most recently created
                    filteredProducts.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

                    const totalItems = filteredProducts.length;
                    const startIndex = (viewState.currentPage - 1) * appState.itemsPerPage;
                    const endIndex = startIndex + appState.itemsPerPage;
                    const paginatedProducts = filteredProducts.slice(startIndex, endIndex);
                    
                    const tableBody = container.querySelector('#inventory-table-body');
                    if (tableBody) {
                        tableBody.innerHTML = paginatedProducts.length ? paginatedProducts.map(p => {
                            const isParent = p.hasVariants;
                            const status = p.status || 'active';
                            const isInactive = status === 'inactive';
                            
                            let priceHTML, stockHTML;
                            if (isParent) {
                                const variants = firestoreData.products.filter(v => v.parentSKU === p.id);
                                const prices = variants.map(v => v.price || 0).filter(v => v > 0);
                                if (prices.length > 0) {
                                    const minPrice = Math.min(...prices);
                                    const maxPrice = Math.max(...prices);
                                    priceHTML = minPrice === maxPrice ? currencyUtils.format(minPrice) : `${currencyUtils.format(minPrice)} - ${currencyUtils.format(maxPrice)}`;
                                } else {
                                    priceHTML = 'N/A';
                                }
                                
                                const totalStock = variants.reduce((sum, v) => sum + (v.stock || 0), 0);
                                stockHTML = `<div class="flex flex-col"><span class="font-medium">${totalStock.toLocaleString()}</span><span class="text-xs text-text-secondary">${variants.length} variants</span></div>`;
                            } else {
                                priceHTML = currencyUtils.format(p.price || 0);
                                if (p.productType === 'physical') {
                                    const stock = p.stock || 0;
                                    let stockColor = 'text-text-primary';
                                    if (stock <= 0) stockColor = 'text-red-400';
                                    else if (stock < 20) stockColor = 'text-yellow-400';
                                    stockHTML = `<span class="font-mono ${stockColor}">${stock.toLocaleString()} ${p.uomId || ''}</span>`;
                                } else {
                                    stockHTML = `<span class="text-xs text-text-secondary">N/A</span>`;
                                }
                            }
                            
                             // Determine actions based on permissions
                            const canEdit = checkPermission('canEditProducts');
                            const canDeactivate = checkPermission('canDeactivateProducts');
                            const canDelete = checkPermission('canDeleteProducts');

                            let actionMenuItems = `<div class="action-menu-item" data-action="view-product-details" data-id="${p.id}"><i data-lucide="eye" class="w-4 h-4"></i><span>View Details</span></div>`;
                            if(canEdit) actionMenuItems += `<div class="action-menu-item" data-action="edit-product" data-id="${p.id}"><i data-lucide="edit" class="w-4 h-4"></i><span>Edit</span></div>`;
                            if(canDeactivate) {
                                const actionText = isInactive ? 'Activate' : 'Deactivate';
                                actionMenuItems += `<div class="h-px bg-border-color my-1"></div><div class="action-menu-item" data-action="toggle-product-status" data-id="${p.id}"><i data-lucide="${isInactive ? 'eye' : 'eye-off'}" class="w-4 h-4"></i><span>${actionText}</span></div>`;
                            }
                            if(canDelete) actionMenuItems += `<div class="action-menu-item danger" data-action="delete-product" data-id="${p.id}"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Delete</span></div>`;

                            return `
                            <tr class="table-row ${isInactive ? 'opacity-50' : ''}" data-action="view-product-details" data-id="${p.id}">
                                <td>
                                    <div class="flex items-center gap-3">
                                        <img src="https://placehold.co/40x40/1f2937/4b5563?text=${p.name.charAt(0).toUpperCase()}" class="w-10 h-10 rounded-md object-cover" alt="${p.name}">
                                        <div>
                                            <p class="font-medium text-text-primary">${p.name} ${isParent ? `<i data-lucide="boxes" class="inline w-3.5 h-3.5 ml-1 text-accent" title="This product has variants"></i>` : ''}</p>
                                            <p class="font-mono text-xs text-text-secondary">${p.id}</p>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="px-2 py-1 text-xs font-semibold rounded-full ${isInactive ? 'bg-gray-700 text-gray-300' : 'bg-green-500/20 text-green-300'} capitalize">${status}</span></td>
                                <td class="font-mono">${priceHTML}</td>
                                <td>${stockHTML}</td>
                                <td><span class="text-sm">${p.category || 'N/A'}</span></td>
                                <td class="text-right">
                                    <div class="relative inline-block text-left">
                                        <button data-action="toggle-action-menu" data-id="${p.id}" class="p-2 rounded-md hover:bg-bg-tertiary">
                                            <i data-lucide="more-vertical" class="w-5 h-5 pointer-events-none"></i>
                                        </button>
                                        <div class="action-menu">
                                            ${actionMenuItems}
                                        </div>
                                    </div>
                                </td>
                            </tr>`;
                        }).join('') : `<tr><td colspan="6" class="text-center p-8 text-text-secondary">No ${term.product}s found.</td></tr>`;
                    }
                    
                    renderPaginationControls(container.querySelector('#inventory-pagination'), totalItems, viewState.currentPage, appState.itemsPerPage, 'inventory');
                    lucide.createIcons();
                };

                // --- FIX START: Add dedicated event listeners for search and filters ---
                const searchInput = container.querySelector('#inventory-search');
                const categoryFilter = container.querySelector('#inventory-category-filter');
                const stockFilter = container.querySelector('#inventory-stock-filter');
                const structureFilter = container.querySelector('#inventory-structure-filter'); // NEW

                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        viewState.searchQuery = e.target.value;
                        viewState.currentPage = 1;
                        renderInventoryTable();
                    });
                }
                if (categoryFilter) {
                    categoryFilter.addEventListener('change', (e) => {
                        viewState.filters.category = e.target.value;
                        viewState.currentPage = 1;
                        renderInventoryTable();
                    });
                }
                if (stockFilter) {
                    stockFilter.addEventListener('change', (e) => {
                        viewState.filters.stockStatus = e.target.value;
                        viewState.currentPage = 1;
                        renderInventoryTable();
                    });
                }
                
                // NEW: Event listener for the new filter
                if (structureFilter) {
                    structureFilter.addEventListener('change', (e) => {
                        viewState.filters.productStructure = e.target.value;
                        viewState.currentPage = 1;
                        renderInventoryTable();
                    });
                }
                
                // --- REFACTORED: Event Listener ---
                container.addEventListener('click', e => {
                    const row = e.target.closest('tr[data-action="view-product-details"]');
                    const actionTarget = e.target.closest('[data-action]');
                    
                    if (actionTarget) {
                        const action = actionTarget.dataset.action;
                        // Define which actions should be handled locally by this listener.
                        // All other actions will be allowed to bubble up to the global listener on `document.body`.
                        const localActions = [
                            'view-product-details', 
                            'edit-product', 
                            'back-to-inventory',
                            'add-variant',
                            'edit-variant',
                            'delete-variant',
                            // 'generate-variants', // This was the bug. Removing it allows the correct listener to fire.
                            'bulk-edit-variants',
                            'bulk-delete-variants',
                            'select-all-variants',
                            'select-variant'
                        ];

                        if (!localActions.includes(action)) {
                            // If the action is not in our local list, do nothing and let it bubble up.
                            return;
                        }

                        // For local actions, stop propagation to prevent other listeners (like the row click) from firing.
                        e.stopPropagation(); 
                        
                        const id = actionTarget.dataset.id || actionTarget.closest('[data-id]')?.dataset.id;
                        const product = firestoreData.products.find(p => p.id === id);

                        switch(action) {
                            case 'view-product-details':
                                if (product) {
                                    if (product.hasVariants) renderVariantDetailView(id, container);
                                    else renderProductDetailView(id, container);
                                }
                                break;
                            case 'edit-product':
                                if (product && checkPermission('canEditProducts')) openProductFormModal(true, product);
                                break;
                            case 'back-to-inventory':
                                initInventory(container);
                                break;
                            // The other local actions (for variants) are handled within renderVariantManagementView's own listener.
                            // Adding them to the list just ensures propagation is stopped correctly.
                        }
                    } else if (row) {
                        // This handles clicks on the row itself to open the detail view.
                        const productId = row.dataset.id;
                        const product = firestoreData.products.find(p => p.id === productId);
                        if (product) {
                           if (product.hasVariants) renderVariantDetailView(productId, container);
                           else renderProductDetailView(productId, container);
                        }
                    }
                });
                
                renderInventoryTable();
                lucide.createIcons();
            }

            // --- REFACTORED & PURIFIED: renderVariantManagementView ---
            function renderVariantManagementView(productId, container) {
                // --- FIX: Add container cleanup logic to prevent event listener stacking ---
                // This was the source of the bug where actions would fire multiple times.
                // By cloning the container and replacing it, we ensure all old listeners are
                // removed before attaching new ones.
                const newContainer = container.cloneNode(false);
                if (container.parentNode) {
                    container.parentNode.replaceChild(newContainer, container);
                    container = newContainer;
                } else {
                    return; // Container is detached from DOM, cannot proceed.
                }
                const parentProduct = firestoreData.products.find(p => p.id === productId);
                if (!parentProduct) {
                    container.innerHTML = `<p>Parent product not found.</p><button data-action="back-to-inventory" class="btn btn-secondary mt-4">Back to List</button>`;
                    return;
                }

                const term = getCurrentProfile().terminology;
                const variants = firestoreData.products.filter(p => p.parentSKU === productId);
                const totalStock = variants.reduce((sum, v) => sum + (v.stock || 0), 0);
                
                let selectedVariants = new Set();
                
                const updateBulkActionState = () => {
                    const bulkActionBar = container.querySelector('#bulk-action-bar');
                    const selectionCountEl = container.querySelector('#selection-count');
                    if (bulkActionBar) {
                        if (selectedVariants.size > 0) {
                            bulkActionBar.classList.remove('hidden');
                            if(selectionCountEl) selectionCountEl.textContent = `${selectedVariants.size} selected`;
                        } else {
                            bulkActionBar.classList.add('hidden');
                        }
                    }
                };

                container.innerHTML = `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="flex flex-col md:flex-row justify-between md:items-start gap-4">
                        <div class="flex items-start gap-4">
                            <button data-action="back-to-inventory" class="btn btn-secondary p-2 h-10 w-10 shrink-0"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                            <div>
                                <p class="text-sm text-text-secondary">Managing Variants for</p>
                                <h1 class="text-3xl font-bold text-text-primary">${parentProduct.name}</h1>
                                <div class="mt-2 flex items-center gap-4 text-sm">
                                    <span class="flex items-center gap-2"><i data-lucide="boxes" class="w-4 h-4 text-accent"></i> ${variants.length} Variants</span>
                                    <span class="flex items-center gap-2"><i data-lucide="package" class="w-4 h-4 text-accent"></i> ${totalStock} Total Stock</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                             <button data-action="generate-variants" data-parent-id="${productId}" class="btn btn-secondary"><i data-lucide="wand-2" class="w-4 h-4 mr-2"></i>Generate Variants</button>
                             <button data-action="add-variant" data-parent-id="${productId}" class="btn btn-primary"><i data-lucide="plus" class="w-4 h-4 mr-2"></i>Add Variant</button>
                        </div>
                    </div>

                    <!-- Variant Generation Helper -->
                    ${ (parentProduct.variantAttributes || []).length > 0 ? `
                    <div class="glass-pane p-4 rounded-xl flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold text-text-primary">Generate Missing Variants</h4>
                            <p class="text-sm text-text-secondary">Automatically create SKUs for all possible combinations of your variant options.</p>
                        </div>
                         <button data-action="generate-variants" data-parent-id="${productId}" class="btn btn-secondary"><i data-lucide="wand-2" class="w-4 h-4 mr-2"></i>Generate</button>
                    </div>` : ''}

                    <!-- Bulk Actions & Variant Table -->
                    <div class="bg-bg-secondary/50 rounded-xl">
                        <div id="bulk-action-bar" class="hidden p-3 border-b border-border-color bg-blue-900/50 flex items-center gap-4">
                            <span id="selection-count" class="text-sm font-medium text-blue-300"></span>
                            <div class="h-6 w-px bg-blue-700"></div>
                            <button data-action="bulk-edit-variants" class="btn btn-secondary btn-sm"><i data-lucide="edit" class="w-4 h-4 mr-2"></i>Edit Selected</button>
                            <button data-action="bulk-delete-variants" class="btn btn-danger-secondary btn-sm ml-auto"><i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>Delete Selected</button>
                        </div>
                        <table class="table-pro">
                            <thead>
                                <tr>
                                    <th class="w-12 text-center"><input type="checkbox" data-action="select-all-variants" class="form-checkbox"></th>
                                    <th>SKU</th>
                                    ${(parentProduct.variantAttributes || []).map(attr => `<th>${attr}</th>`).join('')}
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            ${variants.length ? variants.map(v => `
                                <tr class="table-row">
                                    <td class="text-center"><input type="checkbox" data-action="select-variant" data-id="${v.id}" class="form-checkbox"></td>
                                    <td class="font-mono text-xs">${v.id}</td>
                                    ${(parentProduct.variantAttributes || []).map(attr => `<td class="text-sm">${v.variantOptions?.[attr] || '-'}</td>`).join('')}
                                    <td class="font-mono">${currencyUtils.format(v.price || 0)}</td>
                                    <td>${v.stock}</td>
                                    <td class="text-right">
                                        <button data-action="edit-variant" data-id="${v.id}" class="btn btn-secondary btn-sm p-2" title="Edit Variant"><i data-lucide="edit" class="w-4 h-4 pointer-events-none"></i></button>
                                        <button data-action="delete-variant" data-id="${v.id}" class="btn btn-danger-secondary btn-sm p-2 ml-2" title="Delete Variant"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                                    </td>
                                </tr>
                            `).join('') : `<tr><td colspan="${(parentProduct.variantAttributes || []).length + 6}" class="text-center p-8 text-text-secondary">No variants created yet. Use 'Generate Variants' or 'Add Variant'.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
                `;
                lucide.createIcons();
                
                container.querySelector('[data-action="back-to-inventory"]').addEventListener('click', () => initInventory(container));
                
                const table = container.querySelector('table');
                if (table) {
                    table.addEventListener('change', e => {
                        const selectAll = e.target.closest('[data-action="select-all-variants"]');
                        const selectOne = e.target.closest('[data-action="select-variant"]');
                        if (selectAll) {
                            selectedVariants.clear();
                            table.querySelectorAll('[data-action="select-variant"]').forEach(cb => {
                                cb.checked = selectAll.checked;
                                if (selectAll.checked) {
                                    selectedVariants.add(cb.dataset.id);
                                }
                            });
                        }
                        if (selectOne) {
                            if (selectOne.checked) {
                                selectedVariants.add(selectOne.dataset.id);
                            } else {
                                selectedVariants.delete(selectOne.dataset.id);
                                container.querySelector('[data-action="select-all-variants"]').checked = false;
                            }
                        }
                        updateBulkActionState();
                    });
                }

                container.addEventListener('click', e => {
                    const target = e.target.closest('[data-action]');
                    if (!target) return;
                    
                    const { action, parentId, id } = target.dataset;

                    if (action === 'add-variant' || action === 'edit-variant') {
                        e.stopPropagation();
                        const variantParentSku = variants.find(v => v.id === id)?.parentSKU || parentId;
                        if (action === 'add-variant') openVariantFormModal(parentId);
                        else if (action === 'edit-variant') openVariantFormModal(variantParentSku, id);
                    }
                    
                    if (action === 'delete-variant') {
                        e.stopPropagation();
                        const modal = showModal('Delete Variant', 'Are you sure you want to permanently delete this variant?', `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-delete-variant" class="btn btn-danger">Delete</button>`);
                        modal.querySelector('#confirm-delete-variant').addEventListener('click', async () => {
                            await deleteDoc(doc(productsRef, id));
                            closeModal(modal);
                            showToast('Variant deleted.', 'success');
                        });
                    }
                    
                    if (action === 'bulk-delete-variants') {
                        e.stopPropagation();
                         const modal = showModal('Delete Variants', `Are you sure you want to permanently delete ${selectedVariants.size} selected variants?`, `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-delete-variants" class="btn btn-danger">Delete</button>`);
                        modal.querySelector('#confirm-delete-variants').addEventListener('click', async () => {
                            const batch = writeBatch(db);
                            selectedVariants.forEach(variantId => {
                                batch.delete(doc(productsRef, variantId));
                            });
                            await batch.commit();
                            closeModal(modal);
                            showToast(`${selectedVariants.size} variants deleted.`, 'success');
                        });
                    }

                    if (action === 'generate-variants') {
                        e.stopPropagation();
                        generateVariants(parentId);
                    }
                    
                    if (action === 'bulk-edit-variants') {
                        e.stopPropagation();
                        openBulkEditVariantsModal(Array.from(selectedVariants));
                    }
                });
            }

            function renderVariantDetailView(productId, container) {
                const parentProduct = firestoreData.products.find(p => p.id === productId);
                if (!parentProduct) {
                    container.innerHTML = `<p>Parent product not found.</p><button data-action="back-to-inventory" class="btn btn-secondary mt-4">Back to List</button>`;
                    return;
                }

                const term = getCurrentProfile().terminology;
                const allVariants = firestoreData.products.filter(p => p.parentSKU === productId);
                const attributes = parentProduct.variantAttributes || [];

                // Local state for this view
                let state = {
                    selectedOptions: {}, // e.g., { Color: 'Red', Size: 'M' }
                    selectedVariant: null,
                };

                const updateSelectedVariant = () => {
                    if (Object.keys(state.selectedOptions).length === attributes.length && attributes.length > 0) {
                        // --- FIX START: Add a guard to ensure variantOptions exists before checking attributes ---
                        state.selectedVariant = allVariants.find(v => 
                            v.variantOptions && attributes.every(attr => v.variantOptions[attr] === state.selectedOptions[attr])
                        );
                        // --- FIX END ---
                    } else {
                        state.selectedVariant = null;
                    }
                    render(); // Re-render the whole view with updated state
                };
                
                // The main render function for this view
                const render = () => {
                    const totalStock = allVariants.reduce((sum, v) => sum + (v.stock || 0), 0);

                    const getStatusBadge = (status) => {
                        const base = "px-2 py-0.5 text-xs font-semibold rounded-full inline-block";
                        if (status === 'active') return `${base} bg-green-500/20 text-green-300`;
                        if (status === 'inactive') return `${base} bg-gray-500/20 text-gray-300`;
                        return `${base} bg-gray-500/20 text-gray-300`;
                    };

                    container.innerHTML = `
                    <div class="space-y-6">
                        <!-- Header -->
                        <div class="flex flex-col md:flex-row justify-between md:items-start gap-4">
                            <div class="flex items-start gap-4">
                                <button data-action="back-to-inventory" class="btn btn-secondary p-2 h-10 w-10 shrink-0"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                                <div>
                                    <h1 class="text-3xl font-bold text-text-primary">${parentProduct.name}</h1>
                                    <p class="font-mono text-xs text-text-secondary">${parentProduct.id}</p>
                                    <div class="mt-2 flex items-center gap-4 text-sm">
                                        <span class="flex items-center gap-2"><i data-lucide="boxes" class="w-4 h-4 text-accent"></i> ${allVariants.length} Variants</span>
                                        <span class="flex items-center gap-2"><i data-lucide="package" class="w-4 h-4 text-accent"></i> ${totalStock} Total Stock</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button data-action="edit-product" data-id="${productId}" class="btn btn-secondary"><i data-lucide="edit" class="w-4 h-4 mr-2"></i>Edit Parent</button>
                                <button data-action="manage-variants" data-id="${productId}" class="btn btn-secondary"><i data-lucide="settings-2" class="w-4 h-4 mr-2"></i>Manage Variants</button>
                            </div>
                        </div>

                        <!-- Variant Selector and Details -->
                        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                            <div class="lg:col-span-2 space-y-4">
                                <h3 class="text-lg font-semibold text-text-primary">Select Options</h3>
                                ${attributes.map(attr => {
                                    // --- FIX START: The previous fix was insufficient if parent data is missing.
                                    // This new logic derives the available options directly from the variants themselves,
                                    // making it more resilient to incomplete parent product data.
                                    const options = [...new Set(allVariants.map(v => v.variantOptions?.[attr]).filter(Boolean))];
                                    // --- FIX END ---
                                    return `
                                    <div class="variant-attribute-group">
                                        <label class="block text-sm font-medium mb-2">${attr}</label>
                                        <div class="flex flex-wrap gap-2">
                                            ${options.map(opt => {
                                                const isSelected = state.selectedOptions[attr] === opt;
                                                return `<button type="button" data-action="select-variant-option" data-attribute="${attr}" data-value="${opt}"
                                                    class="variant-option-btn ${isSelected ? 'active' : ''}">${opt}</button>`;
                                            }).join('')}
                                        </div>
                                    </div>`;
                                }).join('')}
                            </div>

                            <div class="lg:col-span-3 glass-pane p-6 rounded-xl min-h-[300px]">
                                <div id="selected-variant-details" class="h-full">
                                    ${state.selectedVariant ? `
                                        <h3 class="text-xl font-bold text-text-primary">${parentProduct.name}</h3>
                                        <p class="font-mono text-xs text-text-secondary">${state.selectedVariant.id}</p>
                                        <div class="grid grid-cols-2 gap-x-6 gap-y-4 text-sm my-6">
                                            <div class="flex flex-col"><span class="text-xs text-text-secondary uppercase">Price</span><span class="text-2xl font-mono text-accent font-bold">${currencyUtils.format(state.selectedVariant.price)}</span></div>
                                            <div class="flex flex-col"><span class="text-xs text-text-secondary uppercase">Stock</span><span class="text-2xl font-mono text-text-primary font-bold">${state.selectedVariant.stock || 0}</span></div>
                                        </div>
                                        <div id="variant-barcode-container" class="my-4"></div>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between py-2 border-t border-border-color"><span class="text-text-secondary">Status</span> <span class="${getStatusBadge(state.selectedVariant.status || 'active')}">${state.selectedVariant.status || 'active'}</span></div>
                                            ${checkPermission('canViewProfitAndLoss') ? `<div class="flex justify-between py-2 border-t border-border-color"><span class="text-text-secondary">Cost Price</span> <span class="font-mono">${currencyUtils.format(state.selectedVariant.costPrice || 0)}</span></div>` : ''}
                                            ${(() => {
                                                const warrantyPolicies = appState.settings.warrantyPolicies || {};
                                                const warrantyPolicy = parentProduct.defaultWarrantyPolicyId ? warrantyPolicies[parentProduct.defaultWarrantyPolicyId] : null;
                                                if (warrantyPolicy) {
                                                    return `<div class="flex justify-between py-2 border-t border-border-color"><span class="text-text-secondary">Default Warranty</span><span class="text-text-primary font-medium">${warrantyPolicy.name}</span></div>`;
                                                }
                                                return '';
                                            })()}
                                        </div>
                                    ` : `
                                        <div class="h-full flex flex-col items-center justify-center text-center text-text-secondary">
                                            <i data-lucide="mouse-pointer-square" class="w-12 h-12 mb-4"></i>
                                            <p class="font-medium text-text-primary">Select an option for each attribute</p>
                                            <p class="text-sm">Details for the specific variant will appear here.</p>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>

                        <!-- REFINED: Common Details Section -->
                        <div class="glass-pane p-6 rounded-xl">
                            <h3 class="text-xl font-semibold text-text-primary mb-4 flex items-center gap-2">
                                <i data-lucide="list-checks" class="w-5 h-5 text-accent"></i>Common Specifications
                            </h3>
                            <div id="common-product-details" class="mt-6 flow-root">
                                <!-- Common details will be rendered here with the new list style -->
                            </div>
                        </div>

                        <!-- All Variants Table -->
                        <div class="glass-pane p-6 rounded-xl">
                            <h3 class="text-lg font-semibold text-text-primary mb-4">All Variants</h3>
                            <div class="overflow-x-auto">
                                <table class="table-pro">
                                    <thead>
                                        <tr>
                                            <th>SKU</th>
                                            ${attributes.map(attr => `<th>${attr}</th>`).join('')}
                                            <th>Price</th>
                                            <th>Stock</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${allVariants.map(v => {
                                            const isSelected = state.selectedVariant && state.selectedVariant.id === v.id;
                                            return `
                                            <tr class="table-row ${isSelected ? 'bg-blue-900/50' : ''}">
                                                <td class="font-mono text-xs">${v.id}</td>
                                                ${attributes.map(attr => `<td>${v.variantOptions?.[attr] || '-'}</td>`).join('')}
                                                <td class="font-mono">${currencyUtils.format(v.price || 0)}</td>
                                                <td>${v.stock || 0}</td>
                                                <td><span class="${getStatusBadge(v.status || 'active')}">${v.status || 'active'}</span></td>
                                            </tr>
                                            `
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    `;

                    // --- REFINED: Render Common Details ---
                    const commonDetailsContainer = container.querySelector('#common-product-details');
                    if (commonDetailsContainer) {
                        const customData = parentProduct.customData || {};
                        const customFields = getCurrentProfile().customFields || [];
                        const hasData = customFields.some(field => customData[field.label] !== undefined && customData[field.label] !== null && customData[field.label] !== '');

                        if (hasData) {
                            commonDetailsContainer.innerHTML = `
                            <dl class="-my-4 divide-y divide-border-color text-sm">
                                ${customFields.map(field => {
                                    const value = customData[field.label];
                                    if (value === null || value === undefined || value === '') return '';

                                    let displayValue = value;
                                    if (typeof value === 'boolean') {
                                        displayValue = value ? 'Yes' : 'No';
                                    }
                                    
                                    // This structure creates a clean, two-column definition list that stacks on mobile.
                                    return `
                                    <div class="grid grid-cols-1 gap-1 py-4 sm:grid-cols-3 sm:gap-4">
                                        <dt class="font-medium text-text-secondary">${field.label}</dt>
                                        <dd class="text-text-primary sm:col-span-2 whitespace-pre-wrap">${displayValue}</dd>
                                    </div>
                                    `
                                }).join('')}
                            </dl>
                            `;
                        } else {
                            commonDetailsContainer.innerHTML = `<p class="text-text-secondary">No common specifications available for this product.</p>`;
                        }
                    }


                    if (state.selectedVariant && state.selectedVariant.barcode && typeof JsBarcode === 'function') {
                        try {
                            const barcodeContainer = container.querySelector('#variant-barcode-container');
                            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                            svg.id = `barcode-${state.selectedVariant.id}`;
                            if(barcodeContainer) {
                                barcodeContainer.innerHTML = ''; // Clear previous barcode
                                barcodeContainer.appendChild(svg);
                                JsBarcode(svg, state.selectedVariant.barcode, { displayValue: true, fontSize: 14, lineColor: "#e5e7eb", fontColor: "#d1d5db", background: "transparent", margin: 10, height: 60 });
                            }
                        } catch (e) {
                            console.error("JsBarcode error:", e);
                            const barcodeContainer = container.querySelector('#variant-barcode-container');
                            if(barcodeContainer) {
                                barcodeContainer.innerHTML = `<p class="text-xs text-red-400">Invalid Barcode: ${state.selectedVariant.barcode}</p>`;
                            }
                        }
                    }
                    lucide.createIcons();
                };

                // Event listener for this specific view
                const viewSpecificListener = (e) => {
                    const target = e.target.closest('[data-action]');
                    if (!target) return;
                    const action = target.dataset.action;
                    
                    if (action === 'back-to-inventory') {
                        container.removeEventListener('click', viewSpecificListener); // Clean up listener
                        initInventory(container);
                    } else if (action === 'manage-variants') {
                        container.removeEventListener('click', viewSpecificListener); // Clean up listener
                        renderVariantManagementView(productId, container);
                    } else if (action === 'edit-product') {
                        if (parentProduct && checkPermission('canEditProducts')) {
                            openProductFormModal(true, parentProduct);
                        }
                    } else if (action === 'select-variant-option') {
                        const { attribute, value } = target.dataset;
                        if (state.selectedOptions[attribute] === value) {
                            delete state.selectedOptions[attribute]; // Deselect
                        } else {
                            state.selectedOptions[attribute] = value;
                        }
                        updateSelectedVariant();
                    }
                };
                
                // Detach other potential inventory listeners and attach our specific one
                const newContainer = container.cloneNode(false);
                if(container.parentNode) {
                    container.parentNode.replaceChild(newContainer, container);
                    container = newContainer;
                }
                container.addEventListener('click', viewSpecificListener);

                // Initial render
                render();
            }



// --- UPDATED FUNCTION: openBulkEditVariantsModal ---
function openBulkEditVariantsModal(variantIds) {
    if (variantIds.length === 0) return;

    const variantsToEdit = firestoreData.products.filter(p => variantIds.includes(p.id));
    const parent = firestoreData.products.find(p => p.id === variantsToEdit[0]?.parentSKU);
    const isSerialized = parent?.isSerialized;

    let individualFieldsHeader;
    // We now use a 10-column grid to fit the barcode field for serialized items.
    if (isSerialized) {
        individualFieldsHeader = `
            <div class="col-span-2">Variant</div>
            <div class="col-span-2">Barcode</div>
            <div class="col-span-2">Serials</div>
            <div>Price</div>
            <div>Cost</div>
            <div class="text-center">Stock</div>
            <div>Status</div>
        `;
    } else {
        // For non-serialized items, we'll expand the barcode field to fill the space.
        individualFieldsHeader = `
            <div class="col-span-2">Variant</div>
            <div class="col-span-4">Barcode</div>
            <div>Price</div>
            <div>Cost</div>
            <div class="text-center">Stock</div>
            <div>Status</div>
        `;
    }


    const bulkStockActionHTML = isSerialized ? '' : `
        <div>
            <label class="input-label">Adjust Stock Quantity</label>
             <div class="flex items-center gap-2">
                <select data-bulk-action="stock-action" class="form-select w-40">
                    <option value="set">Set to</option>
                    <option value="add">Add</option>
                    <option value="subtract">Subtract</option>
                </select>
                <input type="number" data-bulk-action="stock-value" class="form-input w-full" placeholder="Value">
            </div>
        </div>`;

    const content = `
        <form id="bulk-edit-form" class="space-y-6">
            <div class="glass-pane p-4 rounded-xl border border-border-color">
                <h3 class="text-lg font-semibold text-text-primary mb-3">Bulk Actions</h3>
                <p class="text-xs text-text-secondary mb-4">Apply a change to all selected variants below.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div><label class="input-label">Set Selling Price</label><input type="number" data-bulk-action="set-price" class="form-input w-full" placeholder="e.g., 19.99" step="0.01"></div>
                    <div><label class="input-label">Set Cost Price</label><input type="number" data-bulk-action="set-costPrice" class="form-input w-full" placeholder="e.g., 9.50" step="0.01"></div>
                    ${bulkStockActionHTML}
                    <div class="lg:col-span-2">
                        <label class="input-label">Generate Barcodes</label>
                        <div class="flex items-center gap-2"><input type="text" data-bulk-action="barcode-prefix" class="form-input w-full" placeholder="Prefix or Start Number"><button type="button" data-bulk-action="generate-barcodes" class="btn btn-secondary flex-shrink-0">Apply</button></div>
                    </div>
                    <div><label class="input-label">Set Variant Status</label><select data-bulk-action="set-status" class="form-select w-full"><option value="">(No change)</option><option value="active">Active</option><option value="inactive">Inactive</option></select></div>
                </div>
            </div>

            <div>
                 <h3 class="text-lg font-semibold text-text-primary mb-3">Edit Individual Variants (${variantIds.length})</h3>
                 <div id="individual-variants-container" class="space-y-3 max-h-[40vh] overflow-y-auto pr-2">
                    <div class="grid grid-cols-10 gap-3 items-center p-2 text-xs text-text-secondary font-semibold uppercase">${individualFieldsHeader}</div>
                    ${variantsToEdit.map(v => {
                        let fieldsHTML = '';
                        if (isSerialized) {
                            fieldsHTML = `
                                <div class="col-span-2"><input type="text" data-field="barcode" value="${v.barcode || ''}" class="form-input p-2 text-xs w-full"></div>
                                <div class="col-span-2"><textarea data-field="serials" class="form-input p-2 text-xs w-full h-20 font-mono" placeholder="One serial per line">${v.serials?.join('\n') || ''}</textarea></div>
                                <div><input type="number" data-field="price" value="${v.price ? currencyUtils.convert(v.price).toFixed(2) : ''}" class="form-input p-2 text-xs w-full" step="0.01"></div>
                                <div><input type="number" data-field="costPrice" value="${v.costPrice ? currencyUtils.convert(v.costPrice).toFixed(2) : ''}" class="form-input p-2 text-xs w-full" step="0.01"></div>
                                <div class="text-center font-mono" data-field="stock-display">${v.stock || 0}</div>
                            `;
                        } else {
                            fieldsHTML = `
                                <div class="col-span-4"><input type="text" data-field="barcode" value="${v.barcode || ''}" class="form-input p-2 text-xs w-full"></div>
                                <div><input type="number" data-field="price" value="${v.price ? currencyUtils.convert(v.price).toFixed(2) : ''}" class="form-input p-2 text-xs w-full" step="0.01"></div>
                                <div><input type="number" data-field="costPrice" value="${v.costPrice ? currencyUtils.convert(v.costPrice).toFixed(2) : ''}" class="form-input p-2 text-xs w-full" step="0.01"></div>
                                <div><input type="number" data-field="stock" value="${v.stock || 0}" class="form-input p-2 text-xs w-full"></div>
                            `;
                        }
                        return `
                        <div class="grid grid-cols-10 gap-3 items-start bg-bg-secondary p-3 rounded-lg" data-variant-id="${v.id}">
                            <div class="col-span-2">
                                <p class="font-medium text-sm text-text-primary">${Object.values(v.variantOptions || {}).join(' / ')}</p>
                                <p class="font-mono text-xs text-text-secondary">${v.id}</p>
                            </div>
                            ${fieldsHTML}
                            <div>
                                <select data-field="status" class="form-select p-2 text-xs w-full">
                                    <option value="active" ${ (v.status || 'active') === 'active' ? 'selected' : '' }>Active</option>
                                    <option value="inactive" ${ v.status === 'inactive' ? 'selected' : '' }>Inactive</option>
                                </select>
                            </div>
                        </div>
                    `}).join('')}
                 </div>
            </div>
        </form>
    `;

    const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="bulk-edit-form" class="btn btn-primary">Apply ${variantIds.length} Changes</button>`;
    const modal = showModal(`Bulk Edit ${variantIds.length} Variants`, content, footer, { size: 'max-w-7xl' });

    const individualRows = modal.querySelectorAll('[data-variant-id]');

    if (isSerialized) {
        individualRows.forEach(row => {
            const serialsTextarea = row.querySelector('[data-field="serials"]');
            const stockDisplay = row.querySelector('[data-field="stock-display"]');
            if (serialsTextarea && stockDisplay) {
                serialsTextarea.addEventListener('input', () => {
                    const serials = serialsTextarea.value.split('\n').map(s => s.trim()).filter(Boolean);
                    stockDisplay.textContent = serials.length;
                });
            }
        });
    }

    const applyBulkValue = (field, value) => {
        individualRows.forEach(row => {
            const input = row.querySelector(`[data-field="${field}"]`);
            if (input) input.value = value;
        });
    };

    modal.querySelector('[data-bulk-action="set-price"]').addEventListener('input', (e) => applyBulkValue('price', e.target.value));
    modal.querySelector('[data-bulk-action="set-costPrice"]').addEventListener('input', (e) => applyBulkValue('costPrice', e.target.value));
    modal.querySelector('[data-bulk-action="set-status"]').addEventListener('change', (e) => { if(e.target.value) applyBulkValue('status', e.target.value) });
    
    if (!isSerialized) {
        const stockValueInput = modal.querySelector('[data-bulk-action="stock-value"]');
        if (stockValueInput) {
            stockValueInput.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                if (isNaN(value)) return;
                const action = modal.querySelector('[data-bulk-action="stock-action"]').value;
                
                individualRows.forEach(row => {
                    const stockInput = row.querySelector('[data-field="stock"]');
                    if (stockInput) {
                        const originalStock = parseFloat(stockInput.dataset.originalStock || stockInput.value) || 0;
                        if (action === 'set') { stockInput.value = value; }
                        else if (action === 'add') { stockInput.value = originalStock + value; }
                        else if (action === 'subtract') { stockInput.value = Math.max(0, originalStock - value); }
                    }
                });
            });
        }
        individualRows.forEach(row => {
            const stockInput = row.querySelector('[data-field="stock"]');
            if (stockInput) {
                stockInput.addEventListener('focus', () => { stockInput.dataset.originalStock = stockInput.value; });
            }
        });
    }

    const generateBarcodesBtn = modal.querySelector('[data-bulk-action="generate-barcodes"]');
    if (generateBarcodesBtn) {
        generateBarcodesBtn.addEventListener('click', () => {
            const prefixInput = modal.querySelector('[data-bulk-action="barcode-prefix"]');
            if (!prefixInput) return;
            const prefix = prefixInput.value.trim();
            if (!prefix) { showToast('Please enter a prefix or a starting number.', 'warning'); return; }
            
            individualRows.forEach((row, index) => {
                const barcodeInput = row.querySelector('[data-field="barcode"]');
                if (barcodeInput) {
                    barcodeInput.value = generateUniqueBarcode(prefix);
                }
            });
        });
    }


    modal.querySelector('#bulk-edit-form').addEventListener('submit', async e => {
        e.preventDefault();
        const submitBtn = modal.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = `<div class="loader-sm"></div> Applying...`;

        try {
            const batch = writeBatch(db);
            let changesMade = 0;

            for (const row of individualRows) {
                const variantId = row.dataset.variantId;
                const originalVariant = variantsToEdit.find(v => v.id === variantId);
                if (!originalVariant) continue;

                const docRef = doc(productsRef, variantId);
                const updates = {};
                
                // Barcode is always editable now
                const barcodeInput = row.querySelector('[data-field="barcode"]');
                if (barcodeInput) {
                    const newBarcode = barcodeInput.value;
                    if (newBarcode !== (originalVariant.barcode || '')) updates.barcode = newBarcode;
                }

                if (isSerialized) {
                    const serialsTextarea = row.querySelector('[data-field="serials"]');
                    if (serialsTextarea) {
                        const newSerials = serialsTextarea.value.split('\n').map(s => s.trim()).filter(Boolean);
                        const originalSerials = originalVariant.serials || [];
                        // Simple comparison to see if array contents have changed
                        if (JSON.stringify(newSerials.sort()) !== JSON.stringify(originalSerials.sort())) {
                            updates.serials = newSerials;
                            updates.stock = newSerials.length;
                        }
                    }
                } else { // Not serialized
                    const stockInput = row.querySelector('[data-field="stock"]');
                    if (stockInput) {
                        const newStock = parseInt(stockInput.value);
                        if (!isNaN(newStock) && newStock !== (originalVariant.stock || 0)) updates.stock = newStock;
                    }
                }

                const newPriceDisplay = parseFloat(row.querySelector('[data-field="price"]').value);
                if (!isNaN(newPriceDisplay)) {
                    const newPriceBase = currencyUtils.convertToBase(newPriceDisplay);
                    if (Math.abs(newPriceBase - (originalVariant.price || 0)) > 0.001) updates.price = newPriceBase;
                }

                const newCostPriceDisplay = parseFloat(row.querySelector('[data-field="costPrice"]').value);
                if (!isNaN(newCostPriceDisplay) && checkPermission('canViewProfitAndLoss')) {
                    const newCostPriceBase = currencyUtils.convertToBase(newCostPriceDisplay);
                     if (Math.abs(newCostPriceBase - (originalVariant.costPrice || 0)) > 0.001) updates.costPrice = newCostPriceBase;
                }

                const newStatus = row.querySelector('[data-field="status"]').value;
                if (newStatus !== (originalVariant.status || 'active')) updates.status = newStatus;
                
                if (Object.keys(updates).length > 0) {
                    batch.update(docRef, updates);
                    changesMade++;
                }
            }

            if (changesMade === 0) {
                showToast("No changes were detected.", 'info');
                closeModal(modal);
                return;
            }

            await batch.commit();
            showToast(`${changesMade} variant(s) updated successfully.`, 'success');
            closeModal(modal);

            const parentId = variantsToEdit[0]?.parentSKU;
            if (parentId) {
                const container = document.querySelector('#inventory-view-container');
                if (container) {
                    setTimeout(() => renderVariantDetailView(parentId, container), 250);
                }
            }

        } catch (error) {
            console.error("Bulk edit failed:", error);
            showToast("An error occurred during the bulk update.", "error");
            submitBtn.disabled = false;
            submitBtn.innerHTML = `Apply ${variantIds.length} Changes`;
        }
    });
}







            // --- UPDATED FUNCTION: generateVariants ---
async function generateVariants(parentId) {
    // ... (This function is updated to copy the isSerialized flag)
    const parent = firestoreData.products.find(p => p.id === parentId);
    const generateBtn = document.querySelector(`[data-action="generate-variants"][data-parent-id="${parentId}"]`);

    if (!parent || !parent.hasVariants) {
        showToast('This product is not configured for variants.', 'error');
        return;
    }

    showToast('Generating variant combinations...', 'info');
    if (generateBtn) {
        generateBtn.disabled = true;
        generateBtn.innerHTML = `<div class="loader-sm"></div> Generating...`;
    }

    try {
        const cartesian = (...a) => a.reduce((acc, set) => acc.flatMap(c => set.map(x => [...c, x])), [[]]);
        
        const attributeValues = (parent.variantAttributes || []).map(attrName => 
            (parent.variantAttributeValues || {})[attrName] || []
        );
        
        if (attributeValues.length === 0 || attributeValues.some(arr => arr.length === 0)) {
            showToast('No variant options defined on parent product. Please edit the parent and add options.', 'error');
            return;
        }

        const combinations = cartesian(...attributeValues);
        const variantsQuery = query(productsRef, where("parentSKU", "==", parentId));
        const querySnapshot = await getDocs(variantsQuery);
        const existingVariants = querySnapshot.docs.map(doc => doc.data());
        
        const batch = writeBatch(db);
        let newVariantsCount = 0;

        for (const combo of combinations) {
            const variantOptions = {};
            parent.variantAttributes.forEach((attrName, i) => {
                variantOptions[attrName] = combo[i];
            });

            const alreadyExists = existingVariants.some(v => 
                v.variantOptions && parent.variantAttributes.every(attr => v.variantOptions[attr] === variantOptions[attr])
            );

            if (!alreadyExists) {
                const skuSuffix = combo.join('-').replace(/\s+/g, '').replace(/\//g, '-').toUpperCase();
                const newId = `${parentId}-${skuSuffix}`;
                
                const newVariantData = {
                    id: newId,
                    parentSKU: parentId,
                    name: parent.name,
                    category: parent.category,
                    productType: parent.productType,
                    hasVariants: false,
                    isSerialized: parent.isSerialized, // NEW: Inherit from parent
                    variantOptions: variantOptions,
                    barcode: generateUniqueBarcode(),
                    price: 0,
                    costPrice: 0,
                    taxable: parent.taxable !== false,
                    customData: { ...(parent.customData || {}) }
                };
                
                // NEW: Initialize serials array if parent is serialized
                if (parent.isSerialized) {
                    newVariantData.serials = [];
                    newVariantData.stock = 0;
                } else {
                    newVariantData.stock = 0;
                }

                batch.set(doc(productsRef, newId), newVariantData);
                newVariantsCount++;
            }
        }

        if (newVariantsCount > 0) {
            await batch.commit();
            showToast(`Successfully generated ${newVariantsCount} new variant(s).`, 'success');
        } else {
            showToast('All possible variants already exist.', 'info');
        }

        const container = document.querySelector('#inventory-view-container');
        if (container) {
            setTimeout(() => renderVariantDetailView(parentId, container), 250);
        }
    } catch (error) {
        console.error("Error generating variants:", error);
        showToast('An unexpected error occurred while generating variants.', 'error');
    } finally {
        if (generateBtn) {
            generateBtn.disabled = false;
            generateBtn.innerHTML = `<i data-lucide="wand-2" class="w-4 h-4 mr-2"></i>Generate Variants`;
            lucide.createIcons();
        }
    }
}


            function openSupplierModal(supplierId = null, callback = null) {
                const isEditing = !!supplierId;
                const supplier = isEditing ? firestoreData.suppliers.find(s => s.id === supplierId) : {};

                const content = `
                <form id="supplier-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Supplier Name</label>
                            <input type="text" name="name" value="${supplier.name || ''}" class="form-input w-full" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Contact Person</label>
                            <input type="text" name="contactName" value="${supplier.contactName || ''}" class="form-input w-full">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Email</label>
                            <input type="email" name="email" value="${supplier.email || ''}" class="form-input w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Phone</label>
                            <input type="tel" name="phone" value="${supplier.phone || ''}" class="form-input w-full">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Address</label>
                        <textarea name="address" class="form-textarea w-full h-20">${supplier.address || ''}</textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Website</label>
                            <input type="url" name="website" value="${supplier.website || ''}" class="form-input w-full" placeholder="https://example.com">
                        </div>
                         <div>
                            <label class="block text-sm font-medium mb-1">Tax ID / BIN</label>
                            <input type="text" name="taxId" value="${supplier.taxId || ''}" class="form-input w-full">
                        </div>
                    </div>
                     <div>
                        <label class="block text-sm font-medium mb-1">Notes</label>
                        <textarea name="notes" class="form-textarea w-full h-20">${supplier.notes || ''}</textarea>
                    </div>
                </form>
                `;
                const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="supplier-form" class="btn btn-primary">${isEditing ? 'Save Changes' : 'Create Supplier'}</button>`;
                const modal = showModal(isEditing ? 'Edit Supplier' : 'Add New Supplier', content, footer, { size: 'max-w-3xl' });

                modal.querySelector('#supplier-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const data = {
                        name: formData.get('name'),
                        contactName: formData.get('contactName'),
                        email: formData.get('email'),
                        phone: formData.get('phone'),
                        address: formData.get('address'),
                        website: formData.get('website'),
                        taxId: formData.get('taxId'),
                        notes: formData.get('notes'),
                    };

                    if (!data.name) {
                        showToast('Supplier name is required.', 'error');
                        return;
                    }

                    try {
                        if (isEditing) {
                            await updateDoc(doc(suppliersRef, supplierId), data);
                            showToast('Supplier updated successfully.', 'success');
                        } else {
                            data.createdAt = new Date().toISOString();
                            const docRef = await addDoc(suppliersRef, data);
                            showToast('Supplier added successfully.', 'success');
                            if (callback) {
                                callback({ id: docRef.id, ...data });
                            }
                        }
                        closeModal(modal);
                    } catch (error) {
                        console.error('Error saving supplier:', error);
                        showToast('Failed to save supplier.', 'error');
                    }
                });
            }

            function openManageSuppliersModal() {
                const content = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Supplier List</h3>
                        <button id="add-new-supplier-from-list" class="btn btn-primary btn-sm"><i data-lucide="plus" class="w-4 h-4 mr-2"></i>New Supplier</button>
                    </div>
                    <div id="supplier-list-container" class="max-h-96 overflow-y-auto space-y-2">
                        <!-- Supplier list will be rendered here -->
                    </div>
                `;
                const modal = showModal('Manage Suppliers', content, `<button data-action="close-modal" class="btn btn-secondary">Close</button>`, { size: 'max-w-3xl' });
                lucide.createIcons();

                const renderList = () => {
                    const container = modal.querySelector('#supplier-list-container');
                    container.innerHTML = firestoreData.suppliers.length ? firestoreData.suppliers.map(s => `
                        <div class="flex items-center justify-between p-3 bg-bg-secondary rounded-lg">
                            <div>
                                <p class="font-medium text-text-primary">${s.name}</p>
                                <p class="text-xs text-text-secondary">${s.contactName} - ${s.email}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button data-action="edit-supplier" data-id="${s.id}" class="btn btn-secondary btn-sm p-2"><i data-lucide="edit" class="w-4 h-4 pointer-events-none"></i></button>
                                <button data-action="delete-supplier" data-id="${s.id}" class="btn btn-danger-secondary btn-sm p-2"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                            </div>
                        </div>
                    `).join('') : '<p class="text-center text-text-secondary p-4">No suppliers found.</p>';
                    lucide.createIcons();
                };

                renderList();

                modal.addEventListener('click', async e => {
                    const target = e.target.closest('[data-action], #add-new-supplier-from-list');
                    if (!target) return;

                    if (target.id === 'add-new-supplier-from-list') {
                        openSupplierModal(null);
                        return;
                    }

                    const { action, id } = target.dataset;

                    if (action === 'edit-supplier') {
                        openSupplierModal(id);
                    }

                    if (action === 'delete-supplier') {
                        if (firestoreData.purchaseOrders.some(po => po.supplierId === id)) {
                            showToast('Cannot delete supplier. They are linked to existing purchase orders.', 'error');
                            return;
                        }
                         const deleteModal = showModal('Confirm Deletion', 'Are you sure you want to delete this supplier?', `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-delete" class="btn btn-danger">Delete</button>`);
                         deleteModal.querySelector('#confirm-delete').addEventListener('click', async () => {
                             await deleteDoc(doc(suppliersRef, id));
                             showToast('Supplier deleted.', 'success');
                             closeModal(deleteModal);
                         });
                    }
                });
            }

            function initPurchaseOrders(container) {
                if (!container) return;

                const canCreate = checkPermission('canCreatePurchaseOrders');
                const canManageSuppliers = checkPermission('canManageSuppliers');
                const viewState = appState.viewStates.purchaseOrders;

                const supplierOptions = firestoreData.suppliers.map(s => `<option value="${s.id}" ${viewState.filters.supplierId === s.id ? 'selected' : ''}>${s.name}</option>`).join('');

                container.innerHTML = `
                    <div>
                        <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
                            <h1 class="text-3xl font-bold text-text-primary">Purchase Orders</h1>
                            <div class="flex items-center gap-2">
                                ${canManageSuppliers ? `<button data-action="manage-suppliers" class="btn btn-secondary"><i data-lucide="truck" class="w-4 h-4 mr-2"></i> Manage Suppliers</button>` : ''}
                                ${canCreate ? `<button data-action="add-purchase-order" class="btn btn-primary"><i data-lucide="plus" class="w-5 h-5 mr-2"></i> New PO</button>` : ''}
                            </div>
                        </div>

                         <!-- Filters -->
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <div class="relative flex-grow">
                                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i>
                                <input type="text" id="po-search" placeholder="Search by PO ID or Supplier..." class="form-input w-full pl-10" value="${viewState.searchQuery}">
                            </div>
                            <select id="po-status-filter" class="form-select md:w-48">
                                <option value="all">All Statuses</option>
                                <option value="Draft" ${viewState.filters.status === 'Draft' ? 'selected' : ''}>Draft</option>
                                <option value="Ordered" ${viewState.filters.status === 'Ordered' ? 'selected' : ''}>Ordered</option>
                                <option value="Partially Received" ${viewState.filters.status === 'Partially Received' ? 'selected' : ''}>Partially Received</option>
                                <option value="Received" ${viewState.filters.status === 'Received' ? 'selected' : ''}>Received</option>
                                <option value="Cancelled" ${viewState.filters.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                            <select id="po-supplier-filter" class="form-select md:w-64">
                                <option value="all">All Suppliers</option>
                                ${supplierOptions}
                            </select>
                        </div>
                        
                        <div class="bg-bg-secondary/50 rounded-xl">
                            <table class="table-pro">
                                <thead>
                                    <tr>
                                        <th>PO Number</th>
                                        <th>Supplier</th>
                                        <th>Order Date</th>
                                        <th>Status</th>
                                        <th>Total</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="purchase-orders-table-body"></tbody>
                            </table>
                        </div>
                        <div id="purchase-orders-pagination" class="mt-4"></div>
                    </div>`;
                
                lucide.createIcons();
                renderPurchaseOrdersTable(container);

                // Add event listeners for filters
                container.querySelector('#po-search').addEventListener('input', (e) => {
                    viewState.searchQuery = e.target.value;
                    viewState.currentPage = 1;
                    renderPurchaseOrdersTable(container);
                });
                container.querySelector('#po-status-filter').addEventListener('change', (e) => {
                    viewState.filters.status = e.target.value;
                    viewState.currentPage = 1;
                    renderPurchaseOrdersTable(container);
                });
                container.querySelector('#po-supplier-filter').addEventListener('change', (e) => {
                    viewState.filters.supplierId = e.target.value;
                    viewState.currentPage = 1;
                    renderPurchaseOrdersTable(container);
                });
            }

            function renderPurchaseOrdersTable(container) {
                const viewState = appState.viewStates.purchaseOrders;
                const canUpdate = checkPermission('canUpdatePurchaseOrders');
                const canDelete = checkPermission('canDeletePurchaseOrders');

                let filteredPOs = firestoreData.purchaseOrders;

                // Apply filters
                if (viewState.searchQuery) {
                    const query = viewState.searchQuery.toLowerCase();
                    filteredPOs = filteredPOs.filter(po => {
                        const supplier = firestoreData.suppliers.find(s => s.id === po.supplierId);
                        return po.id.toLowerCase().includes(query) || (po.poNumber || '').toLowerCase().includes(query) || supplier?.name.toLowerCase().includes(query);
                    });
                }
                if (viewState.filters.status !== 'all') {
                    filteredPOs = filteredPOs.filter(po => po.status === viewState.filters.status);
                }
                if (viewState.filters.supplierId !== 'all') {
                    filteredPOs = filteredPOs.filter(po => po.supplierId === viewState.filters.supplierId);
                }

                const totalItems = filteredPOs.length;
                const startIndex = (viewState.currentPage - 1) * appState.itemsPerPage;
                const endIndex = startIndex + appState.itemsPerPage;
                const paginatedPOs = filteredPOs.sort((a,b) => new Date(b.orderDate) - new Date(a.orderDate)).slice(startIndex, endIndex);

                const getStatusBadge = (status) => {
                    const base = "px-2 py-1 text-xs font-semibold rounded-full";
                    switch (status) {
                        case 'Draft': return `${base} bg-gray-500/20 text-gray-300`;
                        case 'Ordered': return `${base} bg-blue-500/20 text-blue-300`;
                        case 'Partially Received': return `${base} bg-yellow-500/20 text-yellow-300`;
                        case 'Received': return `${base} bg-green-500/20 text-green-300`;
                        case 'Cancelled': return `${base} bg-red-500/20 text-red-300`;
                        default: return `${base} bg-gray-500/20 text-gray-300`;
                    }
                };

                const tableBody = container.querySelector('#purchase-orders-table-body');
                if (tableBody) {
                    tableBody.innerHTML = paginatedPOs.length ? paginatedPOs.map(po => {
                        const supplier = firestoreData.suppliers.find(s => s.id === po.supplierId);
                        const subtotal = (po.items || []).reduce((sum, item) => sum + ((item.quantity || 0) * (item.cost || 0)), 0);
                        const taxAmount = subtotal * ((po.taxRate || 0) / 100);
                        const total = subtotal + taxAmount + (po.shippingCost || 0);
                        
                        return `
                        <tr class="table-row" data-action="view-purchase-order" data-id="${po.id}">
                            <td class="font-mono text-xs">
                                <div>${po.poNumber || po.id}</div>
                                ${po.poNumber ? `<div class="text-text-secondary/60">${po.id}</div>` : ''}
                            </td>
                            <td class="font-medium text-text-primary">${supplier?.name || 'Unknown'}</td>
                            <td>${new Date(po.orderDate).toLocaleDateString()}</td>
                            <td><span class="${getStatusBadge(po.status)}">${po.status}</span></td>
                            <td class="font-mono text-left">${currencyUtils.format(total)}</td>
                            <td class="text-right">
                                <div class="relative inline-block text-left">
                                    <button data-action="toggle-action-menu" data-id="${po.id}" class="p-2 rounded-md hover:bg-bg-tertiary">
                                        <i data-lucide="more-vertical" class="w-5 h-5 pointer-events-none"></i>
                                    </button>
                                    <div class="action-menu">
                                        <div class="action-menu-item" data-action="view-purchase-order" data-id="${po.id}"><i data-lucide="eye" class="w-4 h-4"></i><span>View Details</span></div>
                                        ${(canUpdate && po.status !== 'Received' && po.status !== 'Cancelled') ? `<div class="action-menu-item" data-action="edit-purchase-order" data-id="${po.id}"><i data-lucide="edit" class="w-4 h-4"></i><span>Edit</span></div>` : ''}
                                        ${(canDelete && po.status === 'Draft') ? `<div class="action-menu-item danger" data-action="delete-purchase-order" data-id="${po.id}"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Delete</span></div>` : ''}
                                    </div>
                                </div>
                            </td>
                        </tr>`;
                    }).join('') : `<tr><td colspan="6" class="text-center p-8 text-text-secondary">No purchase orders found.</td></tr>`;
                }
                
                renderPaginationControls(container.querySelector('#purchase-orders-pagination'), totalItems, viewState.currentPage, appState.itemsPerPage, 'purchaseOrders');
                lucide.createIcons();
            }

            function initSuppliers(container) {
                if (!container) return;
                
                // Default to rendering the list view
                renderSupplierListView(container);
                
                // Use event delegation on the container for all actions within the supplier view
                container.addEventListener('click', e => {
                    const target = e.target.closest('[data-action]');
                    if (!target) return;
                    
                    const action = target.dataset.action;
                    const id = target.dataset.id;
                    
                    // Stop row click from firing when clicking a button/menu inside it
                    if (action !== 'view-supplier-details') {
                        e.stopPropagation();
                    }
                    
                    if (action === 'toggle-action-menu') {
                        // This logic is copied from the global handler to make it work
                        // within the supplier view's event listener, which stops propagation.
                        const menu = target.nextElementSibling;
                        if (!menu || !menu.classList.contains('action-menu')) return;
                        const isCurrentlyOpen = menu.classList.contains('open');
                        
                        // Close all other menus in the entire document
                        document.querySelectorAll('.action-menu.open').forEach(m => {
                            if (m !== menu) m.classList.remove('open', 'open-up');
                        });

                        if (!isCurrentlyOpen) {
                            const rect = target.getBoundingClientRect();
                            const menuHeight = menu.offsetHeight > 0 ? menu.offsetHeight : 220; 
                            if (rect.bottom + menuHeight > window.innerHeight) {
                                menu.classList.add('open-up');
                            } else {
                                menu.classList.remove('open-up');
                            }
                            menu.classList.add('open');
                        } else {
                             menu.classList.remove('open', 'open-up');
                        }
                    }
                    
                    if (action === 'view-supplier-details') {
                        renderSupplierDetailView(id, container);
                    }
                    if (action === 'back-to-supplier-list') {
                        renderSupplierListView(container);
                    }
                    if (action === 'edit-supplier') {
                        if (checkPermission('canManageSuppliers')) {
                            openSupplierModal(id);
                        }
                    }
                    if (action === 'delete-supplier') {
                        if (checkPermission('canManageSuppliers')) {
                            if (firestoreData.purchaseOrders.some(po => po.supplierId === id)) {
                                showToast('Cannot delete supplier. They are linked to existing purchase orders.', 'error');
                                return;
                            }
                            const supplier = firestoreData.suppliers.find(s => s.id === id);
                            const deleteModal = showModal('Confirm Deletion', `Are you sure you want to delete the supplier "${supplier?.name || 'this supplier'}"?`, `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-delete" class="btn btn-danger">Delete</button>`);
                            deleteModal.querySelector('#confirm-delete').addEventListener('click', async () => {
                                await deleteDoc(doc(suppliersRef, id));
                                showToast('Supplier deleted.', 'success');
                                closeModal(deleteModal);
                                // Go back to list view after deletion from detail view
                                renderSupplierListView(container);
                            });
                        }
                    }
                });
            }

            function renderSupplierListView(container) {
                const canManage = checkPermission('canManageSuppliers');
                const viewState = appState.viewStates.suppliers;

                // --- NEW: KPI Calculations ---
                const totalSuppliers = firestoreData.suppliers.length;
                const totalPOValue = firestoreData.purchaseOrders.reduce((sum, po) => {
                    const subtotal = (po.items || []).reduce((s, item) => s + ((item.quantity || 0) * (item.cost || 0)), 0);
                    const tax = subtotal * ((po.taxRate || 0) / 100);
                    const shipping = po.shippingCost || 0;
                    return sum + subtotal + tax + shipping;
                }, 0);
                const totalPOs = firestoreData.purchaseOrders.length;
                const avgPOValue = totalPOs > 0 ? totalPOValue / totalPOs : 0;

                container.innerHTML = `
                    <div class="space-y-6">
                        <!-- Header and KPIs -->
                        <div>
                            <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
                                <h1 class="text-3xl font-bold text-text-primary">Suppliers</h1>
                                <div class="flex items-center gap-2">
                                    ${canManage ? `<button data-action="add-supplier-from-list" class="btn btn-primary flex-1 md:flex-none"><i data-lucide="plus" class="w-5 h-5 mr-2"></i> Add Supplier</button>` : ''}
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="glass-pane p-5 rounded-xl"><p class="text-sm text-text-secondary">Total Suppliers</p><p class="text-3xl font-bold text-text-primary">${totalSuppliers}</p></div>
                                <div class="glass-pane p-5 rounded-xl"><p class="text-sm text-text-secondary">Total Purchase Value</p><p class="text-3xl font-bold font-mono text-blue-400">${currencyUtils.format(totalPOValue)}</p></div>
                                <div class="glass-pane p-5 rounded-xl"><p class="text-sm text-text-secondary">Average PO Value</p><p class="text-3xl font-bold font-mono text-blue-400">${currencyUtils.format(avgPOValue)}</p></div>
                            </div>
                        </div>

                        <!-- Search and Table -->
                        <div class="glass-pane p-6 rounded-xl">
                            <div class="flex flex-col md:flex-row gap-4 mb-4">
                                <div class="relative flex-grow">
                                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i>
                                    <input type="text" id="supplier-search" placeholder="Search by name, contact, email..." class="form-input w-full pl-10" value="${viewState.searchQuery}">
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="table-pro">
                                    <thead>
                                        <tr>
                                            <th>Supplier</th>
                                            <th>Contact Info</th>
                                            <th>Products Supplied</th>
                                            <th>Total Spent</th>
                                            <th>Last Order</th>
                                            ${canManage ? '<th>Actions</th>' : ''}
                                        </tr>
                                    </thead>
                                    <tbody id="suppliers-table-body"></tbody>
                                </table>
                            </div>
                            <div id="suppliers-pagination" class="mt-4"></div>
                        </div>
                    </div>
                `;
                
                // Event listener for the "Add Supplier" button, scoped to this view
                const addSupplierBtn = container.querySelector('[data-action="add-supplier-from-list"]');
                if (addSupplierBtn) {
                    addSupplierBtn.addEventListener('click', () => {
                        openSupplierModal(null);
                    });
                }

                renderSuppliersTable(container); // Call the function to populate the table

                container.querySelector('#supplier-search').addEventListener('input', (e) => {
                    viewState.searchQuery = e.target.value;
                    viewState.currentPage = 1;
                    renderSuppliersTable(container);
                });

                lucide.createIcons();
            }

            function renderSuppliersTable(container) {
                const viewState = appState.viewStates.suppliers;
                const canManage = checkPermission('canManageSuppliers');
                
                const supplierMetrics = firestoreData.suppliers.map(supplier => {
                    const posForSupplier = firestoreData.purchaseOrders.filter(po => po.supplierId === supplier.id);
                    const totalSpent = posForSupplier.reduce((sum, po) => {
                        const subtotal = (po.items || []).reduce((s, item) => s + ((item.quantity || 0) * (item.cost || 0)), 0);
                        const tax = subtotal * ((po.taxRate || 0) / 100);
                        const shipping = po.shippingCost || 0;
                        return sum + subtotal + tax + shipping;
                    }, 0);
                    const lastOrder = posForSupplier.length > 0 ? posForSupplier.sort((a,b) => new Date(b.orderDate) - new Date(a.orderDate))[0].orderDate : null;
                    const suppliedProducts = new Set(posForSupplier.flatMap(po => (po.items || []).map(item => item.productId)));
                    return { ...supplier, totalSpent, lastOrder, suppliedProductCount: suppliedProducts.size };
                });

                let filteredSuppliers = supplierMetrics;
                if (viewState.searchQuery) {
                    const query = viewState.searchQuery.toLowerCase();
                    filteredSuppliers = filteredSuppliers.filter(s =>
                        s.name.toLowerCase().includes(query) ||
                        (s.contactName || '').toLowerCase().includes(query) ||
                        (s.email || '').toLowerCase().includes(query)
                    );
                }

                filteredSuppliers.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

                const totalItems = filteredSuppliers.length;
                const startIndex = (viewState.currentPage - 1) * appState.itemsPerPage;
                const endIndex = startIndex + appState.itemsPerPage;
                const paginatedSuppliers = filteredSuppliers.slice(startIndex, endIndex);

                const tableBody = container.querySelector('#suppliers-table-body');
                if (tableBody) {
                    tableBody.innerHTML = paginatedSuppliers.length ? paginatedSuppliers.map(s => `
                        <tr class="table-row cursor-pointer" data-action="view-supplier-details" data-id="${s.id}">
                            <td class="font-medium text-text-primary">${s.name}</td>
                            <td>
                                <div>${s.contactName || 'N/A'}</div>
                                <div class="text-xs text-text-secondary">${s.email || s.phone || ''}</div>
                            </td>
                            <td class="text-center">${s.suppliedProductCount}</td>
                            <td class="font-mono">${currencyUtils.format(s.totalSpent)}</td>
                            <td>${s.lastOrder ? new Date(s.lastOrder).toLocaleDateString() : 'N/A'}</td>
                            ${canManage ? `
                            <td class="text-right">
                                <div class="relative inline-block text-left">
                                    <button data-action="toggle-action-menu" data-id="${s.id}" class="p-2 rounded-md hover:bg-bg-tertiary">
                                        <i data-lucide="more-vertical" class="w-5 h-5 pointer-events-none"></i>
                                    </button>
                                    <div class="action-menu">
                                        <div class="action-menu-item" data-action="edit-supplier" data-id="${s.id}"><i data-lucide="edit" class="w-4 h-4"></i><span>Edit</span></div>
                                        <div class="action-menu-item danger" data-action="delete-supplier" data-id="${s.id}"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Delete</span></div>
                                    </div>
                                </div>
                            </td>` : ''}
                        </tr>
                    `).join('') : `<tr><td colspan="${canManage ? 6 : 5}" class="text-center p-8 text-text-secondary">No suppliers found.</td></tr>`;
                }

                renderPaginationControls(container.querySelector('#suppliers-pagination'), totalItems, viewState.currentPage, appState.itemsPerPage, 'suppliers');
                lucide.createIcons();
            }

            function renderSupplierDetailView(supplierId, container) {
                const supplier = firestoreData.suppliers.find(s => s.id === supplierId);
                if (!supplier) {
                    container.innerHTML = `<p>Supplier not found.</p><button data-action="back-to-supplier-list" class="btn btn-secondary mt-4">Back to List</button>`;
                    return;
                }
                const canManage = checkPermission('canManageSuppliers');

                const posForSupplier = firestoreData.purchaseOrders.filter(po => po.supplierId === supplierId);
                const totalSpent = posForSupplier.reduce((sum, po) => {
                    const subtotal = (po.items || []).reduce((s, item) => s + ((item.quantity || 0) * (item.cost || 0)), 0);
                    const tax = subtotal * ((po.taxRate || 0) / 100);
                    const shipping = po.shippingCost || 0;
                    return sum + subtotal + tax + shipping;
                }, 0);
                const totalPOs = posForSupplier.length;
                const avgPOValue = totalPOs > 0 ? totalSpent / totalPOs : 0;
                const lastOrderDate = totalPOs > 0 ? posForSupplier.sort((a,b) => new Date(b.orderDate) - new Date(a.orderDate))[0].orderDate : null;
                const recentPOs = posForSupplier.sort((a,b) => new Date(b.orderDate) - new Date(a.orderDate)).slice(0, 5);

                container.innerHTML = `
                <div class="view-pane space-y-6">
                    <!-- Header -->
                    <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
                        <div class="flex items-center gap-4">
                             <button data-action="back-to-supplier-list" class="btn btn-secondary p-2 h-10 w-10 shrink-0"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                             <div>
                                <h1 class="text-3xl font-bold text-text-primary">${supplier.name}</h1>
                                <a href="${supplier.website}" target="_blank" class="text-text-secondary hover:text-accent transition-colors flex items-center gap-1"><i data-lucide="link" class="w-3 h-3"></i>${supplier.website || 'No website'}</a>
                             </div>
                        </div>
                         <div class="flex items-center gap-2">
                            ${canManage ? `<button data-action="delete-supplier" data-id="${supplierId}" class="btn btn-danger-secondary"><i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>Delete</button>` : ''}
                            ${canManage ? `<button data-action="edit-supplier" data-id="${supplierId}" class="btn btn-primary"><i data-lucide="edit" class="w-4 h-4 mr-2"></i>Edit Supplier</button>` : ''}
                        </div>
                    </div>

                    <!-- KPIs -->
                     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="glass-pane p-5 rounded-xl"><p class="text-sm text-text-secondary">Total Spent</p><p class="text-3xl font-bold font-mono text-blue-400">${currencyUtils.format(totalSpent)}</p></div>
                        <div class="glass-pane p-5 rounded-xl"><p class="text-sm text-text-secondary">Total Purchase Orders</p><p class="text-3xl font-bold text-text-primary">${totalPOs}</p></div>
                        <div class="glass-pane p-5 rounded-xl"><p class="text-sm text-text-secondary">Average PO Value</p><p class="text-3xl font-bold font-mono text-blue-400">${currencyUtils.format(avgPOValue)}</p></div>
                        <div class="glass-pane p-5 rounded-xl"><p class="text-sm text-text-secondary">Last Order Date</p><p class="text-3xl font-bold text-text-primary">${lastOrderDate ? new Date(lastOrderDate).toLocaleDateString() : 'N/A'}</p></div>
                    </div>
                    
                    <!-- Details & Recent POs -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 space-y-6">
                            <div class="glass-pane p-6 rounded-xl">
                                <h3 class="text-lg font-semibold text-text-primary mb-3">Contact Information</h3>
                                <div class="space-y-3 text-sm">
                                    <div class="flex items-start gap-3"><i data-lucide="user-circle" class="w-4 h-4 text-text-secondary mt-0.5 shrink-0"></i><div><p class="text-text-secondary -mb-1">Contact Person</p><p class="text-text-primary font-medium">${supplier.contactName || 'N/A'}</p></div></div>
                                    <div class="flex items-start gap-3"><i data-lucide="mail" class="w-4 h-4 text-text-secondary mt-0.5 shrink-0"></i><div><p class="text-text-secondary -mb-1">Email</p><p class="text-text-primary font-medium break-all">${supplier.email || 'N/A'}</p></div></div>
                                    <div class="flex items-start gap-3"><i data-lucide="phone" class="w-4 h-4 text-text-secondary mt-0.5 shrink-0"></i><div><p class="text-text-secondary -mb-1">Phone</p><p class="text-text-primary font-medium">${supplier.phone || 'N/A'}</p></div></div>
                                    <div class="flex items-start gap-3"><i data-lucide="map-pin" class="w-4 h-4 text-text-secondary mt-0.5 shrink-0"></i><div><p class="text-text-secondary -mb-1">Address</p><p class="text-text-primary font-medium">${supplier.address || 'N/A'}</p></div></div>
                                     <div class="flex items-start gap-3"><i data-lucide="file-badge" class="w-4 h-4 text-text-secondary mt-0.5 shrink-0"></i><div><p class="text-text-secondary -mb-1">Tax ID</p><p class="text-text-primary font-medium">${supplier.taxId || 'N/A'}</p></div></div>
                                </div>
                            </div>
                             <div class="glass-pane p-6 rounded-xl">
                                <h3 class="text-lg font-semibold text-text-primary mb-3">Notes</h3>
                                <p class="text-sm text-text-secondary whitespace-pre-wrap">${supplier.notes || 'No notes for this supplier.'}</p>
                             </div>
                        </div>
                        <div class="lg:col-span-2 glass-pane p-6 rounded-xl">
                            <h3 class="text-lg font-semibold text-text-primary mb-3">Recent Purchase Orders</h3>
                            <div class="overflow-x-auto">
                                <table class="table-pro">
                                    <thead><tr><th>PO Number</th><th>Date</th><th>Status</th><th class="text-right">Total</th></tr></thead>
                                    <tbody>
                                    ${recentPOs.length ? recentPOs.map(po => {
                                         const subtotal = (po.items || []).reduce((s, item) => s + ((item.quantity || 0) * (item.cost || 0)), 0);
                                         const tax = subtotal * ((po.taxRate || 0) / 100);
                                         const shipping = po.shippingCost || 0;
                                         const total = subtotal + tax + shipping;
                                         return `<tr class="table-row cursor-pointer" data-action="view-purchase-order" data-id="${po.id}">
                                            <td class="font-mono text-xs">${po.poNumber || po.id}</td>
                                            <td>${new Date(po.orderDate).toLocaleDateString()}</td>
                                            <td><span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-500/20 text-blue-300">${po.status}</span></td>
                                            <td class="text-right font-mono">${currencyUtils.format(total)}</td>
                                         </tr>`
                                    }).join('') : `<tr><td colspan="4" class="text-center p-8 text-text-secondary">No purchase orders found for this supplier.</td></tr>`}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                lucide.createIcons();
            }

/**
 * INSTRUCTIONS FOR UPDATING YOUR index.html FILE:
 * 1. Open your `index.html` file.
 * 2. Find the existing function named `openPurchaseOrderModal` and, if it exists from a previous copy, `openPOSerialEntryModal`.
 * 3. Delete both of those entire functions from your `<script type="module">` tag.
 * 4. Copy and paste the ENTIRE content of this file (both functions below) in their place.
 *
 * This file now contains both `openPOSerialEntryModal` and `openPurchaseOrderModal` to fix the "not defined" error.
 */

function openPOSerialEntryModal(serializedItems) {
    return new Promise((resolve, reject) => {
        const content = `
            <form id="po-serial-entry-form" class="space-y-4">
                <p class="text-sm">For status 'Received', you must enter the serial numbers for all serialized items. The quantity must match the amount ordered.</p>
                <div class="max-h-[60vh] overflow-y-auto -mx-6 px-6 space-y-4">
                    ${serializedItems.map(item => {
                        const product = firestoreData.products.find(p => p.id === item.productId);
                        return `
                        <div>
                            <label class="block text-sm font-medium mb-1">${product.name} (Qty: ${item.quantity})</label>
                            <textarea name="serials_${item.productId}" class="form-textarea w-full h-24 text-xs font-mono" placeholder="One serial per line..." data-product-id="${item.productId}" data-required-qty="${item.quantity}" required></textarea>
                            <p class="text-xs text-text-secondary mt-1 text-right">Count: <span id="serial-count-${item.productId}">0</span> / ${item.quantity}</p>
                        </div>
                        `;
                    }).join('')}
                </div>
            </form>
        `;
        const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="po-serial-entry-form" class="btn btn-primary">Confirm Serials & Receive</button>`;
        const modal = showModal('Enter Serial Numbers', content, footer, { size: 'max-w-xl' });
        
        const textareas = modal.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            textarea.addEventListener('input', () => {
                const productId = textarea.dataset.productId;
                const serials = textarea.value.split('\n').map(s => s.trim()).filter(Boolean);
                const countEl = modal.querySelector(`#serial-count-${productId}`);
                if (countEl) {
                    countEl.textContent = serials.length;
                }
            });
        });

        modal.querySelector('#po-serial-entry-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const serialsData = {};

            for (const item of serializedItems) {
                const textarea = modal.querySelector(`[name="serials_${item.productId}"]`);
                const serials = textarea.value.split('\n').map(s => s.trim()).filter(Boolean);
                
                if (serials.length !== item.quantity) {
                    const product = firestoreData.products.find(p => p.id === item.productId);
                    // Instead of rejecting, we show a toast and let the user correct it.
                    showToast(`You must enter exactly ${item.quantity} serial numbers for ${product.name}. You entered ${serials.length}.`, 'error');
                    return; // Stop form submission
                }
                
                if (new Set(serials).size !== serials.length) {
                    const product = firestoreData.products.find(p => p.id === item.productId);
                    showToast(`Duplicate serial numbers found for ${product.name}. Please ensure all serials are unique.`, 'error');
                    return; // Stop form submission
                }
                
                serialsData[item.productId] = serials;
            }

            // If all validations pass
            closeModal(modal);
            resolve(serialsData);
        });
        
        modal.querySelector('[data-action="close-modal"]').addEventListener('click', () => {
            closeModal(modal);
            resolve(null); // Resolve with null on cancel
        });
    });
}

function openPurchaseOrderModal(poId = null) {
    const isEditing = !!poId;
    const po = isEditing ? firestoreData.purchaseOrders.find(p => p.id === poId) : null;
    if (isEditing && !po) {
        showToast('Purchase Order not found.', 'error');
        return;
    }

    if (isEditing && po.status !== 'Draft') {
        openViewPurchaseOrderModal(poId);
        return;
    }

    let poData = {
        poNumber: po?.poNumber || '',
        supplierId: po?.supplierId || '',
        orderDate: po?.orderDate || new Date().toISOString().slice(0, 10),
        expectedDate: po?.expectedDate || '',
        paymentTerms: po?.paymentTerms || 'Net 30',
        items: po?.items ? JSON.parse(JSON.stringify(po.items)) : [],
        notes: po?.notes || '',
        shippingCost: po?.shippingCost || 0,
        taxRate: po?.taxRate || 0,
        status: po?.status || 'Draft',
    };

    const suppliersOptions = firestoreData.suppliers.map(s => `<option value="${s.id}" ${poData.supplierId === s.id ? 'selected' : ''}>${s.name}</option>`).join('');

    const statusFieldHTML = isEditing 
        ? `<div><label class="block text-sm font-medium mb-1">Status</label><input type="text" value="${poData.status}" class="form-input w-full bg-bg-tertiary" readonly></div>`
        : `<div>
            <label class="block text-sm font-medium mb-1">Set Initial Status</label>
            <select name="status" class="form-select w-full">
                <option value="Draft" ${poData.status === 'Draft' ? 'selected' : ''}>Draft</option>
                <option value="Ordered" ${poData.status === 'Ordered' ? 'selected' : ''}>Ordered</option>
                <option value="Received" ${poData.status === 'Received' ? 'selected' : ''}>Received</option>
            </select>
           </div>`;

    const content = `
        <form id="po-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 pb-4 border-b border-border-color">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium mb-1">Supplier</label>
                    <div class="flex items-center gap-2">
                        <select name="supplierId" class="form-select w-full flex-grow" required ${poData.items.length > 0 || isEditing ? 'disabled' : ''}>
                            <option value="" disabled ${!poData.supplierId ? 'selected' : ''}>Select a supplier</option>
                            ${suppliersOptions}
                        </select>
                        <button type="button" data-action="add-new-supplier-from-po" class="btn btn-secondary p-2 shrink-0" title="Add New Supplier" ${poData.items.length > 0 || isEditing ? 'disabled' : ''}><i data-lucide="plus" class="w-4 h-4 pointer-events-none"></i></button>
                    </div>
                </div>
                <div><label class="block text-sm font-medium mb-1">Order Date</label><input type="date" name="orderDate" value="${poData.orderDate}" class="form-input w-full" required></div>
                <div><label class="block text-sm font-medium mb-1">Expected Delivery</label><input type="date" name="expectedDate" value="${poData.expectedDate}" class="form-input w-full"></div>
                 ${statusFieldHTML}
            </div>

            <!-- Item Search & Table -->
            <div>
                <label class="block text-sm font-medium mb-1">Add Items to PO</label>
                <div class="relative">
                    <input type="text" id="po-item-search" placeholder="Search by Name/SKU, or scan Barcode and press Enter..." class="form-input w-full" ${!poData.supplierId ? 'disabled' : ''}>
                    <div id="po-item-search-results" class="absolute top-full left-0 right-0 mt-1 bg-bg-secondary border border-border-color rounded-lg shadow-lg z-20 hidden max-h-60 overflow-y-auto"></div>
                </div>
            </div>
            <div class="overflow-x-auto max-h-96 -mx-6">
                <table class="w-full text-sm">
                    <thead class="sticky top-0 bg-bg-primary z-10"><tr class="text-left text-text-secondary text-xs uppercase"><th class="px-6 py-2">Product / SKU</th><th class="px-4 py-2 w-24 text-center">Quantity</th><th class="px-4 py-2 w-32 text-center">Cost</th><th class="px-4 py-2 w-32 text-center">Total</th><th class="px-4 py-2 w-12 text-center"></th></tr></thead>
                    <tbody id="po-items-table" class="divide-y divide-border-color"></tbody>
                </table>
            </div>

            <!-- Totals & Notes -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 pt-4 border-t border-border-color">
                <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium mb-1">Notes</label><textarea name="notes" class="form-textarea w-full h-24">${poData.notes}</textarea></div>
                    <div>
                         <label class="block text-sm font-medium mb-1">Payment Terms</label>
                         <input type="text" name="paymentTerms" value="${poData.paymentTerms}" class="form-input w-full" placeholder="e.g., Net 30, Due on Receipt">
                          <label class="block text-sm font-medium mb-1 mt-2">Custom PO Number</label>
                          <input type="text" name="poNumber" value="${poData.poNumber}" class="form-input w-full" placeholder="Optional, e.g., PO-2025-001">
                    </div>
                </div>
                <div id="po-totals" class="space-y-1"></div>
            </div>
        </form>
    `;
    const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="po-form" class="btn btn-primary">${isEditing ? 'Save Changes' : 'Create PO'}</button>`;
    const modal = showModal(isEditing ? `Edit Purchase Order #${(po.poNumber || poId).slice(-6)}` : 'New Purchase Order', content, footer, { size: 'max-w-6xl' });

    // ... (All the internal helper functions remain the same)
    const itemsTableBody = modal.querySelector('#po-items-table');
    const totalsContainer = modal.querySelector('#po-totals');

    const updateTotals = () => {
        const subtotal = poData.items.reduce((sum, item) => sum + ((item.quantity || 0) * (item.cost || 0)), 0);
        const taxAmount = subtotal * (poData.taxRate / 100);
        const grandTotal = subtotal + taxAmount + poData.shippingCost;

        const subtotalEl = modal.querySelector('#po-subtotal-value');
        const taxAmountEl = modal.querySelector('#po-tax-amount-value');
        const grandTotalEl = modal.querySelector('#po-grand-total-value');

        if(subtotalEl) subtotalEl.textContent = currencyUtils.format(subtotal);
        if(taxAmountEl) taxAmountEl.textContent = currencyUtils.format(taxAmount);
        if(grandTotalEl) grandTotalEl.textContent = currencyUtils.format(grandTotal);
    };

    const renderTotals = () => {
        const shippingCostInDisplay = currencyUtils.convert(poData.shippingCost);
        totalsContainer.innerHTML = `
            <div class="grid grid-cols-2 items-center gap-y-2 text-sm">
                <span class="text-text-secondary text-left">Subtotal:</span>
                <span id="po-subtotal-value" class="font-mono text-right p-1"></span>
                <span class="text-text-secondary text-left">Shipping:</span>
                <input type="number" step="0.01" id="po-shipping-cost" class="form-input p-1 w-24 text-right justify-self-end" value="${shippingCostInDisplay.toFixed(2)}">
                <span class="text-text-secondary text-left">Tax (%):</span>
                <input type="number" step="0.01" id="po-tax-rate" class="form-input p-1 w-24 text-right justify-self-end" value="${poData.taxRate.toFixed(2)}">
                <span class="text-text-secondary text-left">Tax Amount:</span>
                <span id="po-tax-amount-value" class="font-mono text-right text-text-secondary p-1"></span>
            </div>
            <div class="grid grid-cols-2 items-center font-bold text-lg pt-2 border-t border-border-color mt-2">
                <span class="text-text-primary text-left">Total:</span>
                <span id="po-grand-total-value" class="font-mono text-accent text-right"></span>
            </div>
        `;
        updateTotals();
    };

    const renderItems = () => {
        itemsTableBody.innerHTML = poData.items.length ? poData.items.map((item, index) => {
            const product = firestoreData.products.find(p => p.id === item.productId);
            const costInDisplay = currencyUtils.convert(item.cost);
            return `
                <tr data-index="${index}">
                    <td class="px-6 py-2 align-middle">
                        <p class="font-medium text-text-primary">${product?.name || 'Unknown'}</p>
                        <p class="text-xs text-text-secondary font-mono">${item.productId}</p>
                    </td>
                    <td class="px-4 py-2 align-middle">
                        <input type="number" class="form-input w-full p-1 text-center po-item-input" data-field="quantity" value="${item.quantity}">
                    </td>
                    <td class="px-4 py-2 align-middle">
                        <input type="number" step="0.01" class="form-input w-full p-1 text-right po-item-input" data-field="cost" value="${costInDisplay.toFixed(2)}">
                    </td>
                    <td class="px-4 py-2 align-middle text-right font-mono">${currencyUtils.format((item.quantity || 0) * (item.cost || 0))}</td>
                    <td class="px-4 py-2 align-middle text-center">
                        <button type="button" data-action="remove-po-item" class="p-1 text-danger/70 hover:text-danger"><i data-lucide="x-circle" class="w-5 h-5 pointer-events-none"></i></button>
                    </td>
                </tr>`;
        }).join('') : `<tr><td colspan="5" class="text-center py-8 text-text-secondary">No items added yet.</td></tr>`;
        lucide.createIcons();
    };

    renderItems();
    renderTotals();

    const handleAddProductToPO = (product) => {
        const existingItem = poData.items.find(item => item.productId === product.id);
        if (existingItem) {
            existingItem.quantity++;
            renderItems();
            updateTotals();
            return true;
        }

        if (product.hasVariants && !product.parentSKU) {
            openPOVariantSelectorModal(product, (selectedVariants) => {
                let addedCount = 0;
                selectedVariants.forEach(variant => {
                    const existingVariant = poData.items.find(item => item.productId === variant.id);
                    if (existingVariant) {
                        existingVariant.quantity++;
                    } else {
                        poData.items.push({ productId: variant.id, quantity: 1, cost: variant.costPrice || 0, received: 0 });
                        addedCount++;
                    }
                });
                renderItems();
                updateTotals();
                if(addedCount > 0) showToast(`Added ${addedCount} new variant(s) to the PO.`, 'success');
                if (selectedVariants.length > addedCount) showToast(`${selectedVariants.length - addedCount} existing variant(s) incremented.`, 'info');
            });
        } else {
            poData.items.push({ productId: product.id, quantity: 1, cost: product.costPrice || 0, received: 0 });
            renderItems();
            updateTotals();
        }
        return true;
    };
    
    const poSearchInput = modal.querySelector('#po-item-search');
    if (poSearchInput) {
        poSearchInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const code = poSearchInput.value.trim();
                if (!code) return;

                const product = firestoreData.products.find(p => p.barcode === code || p.id === code);
                
                if (product) {
                    if (handleAddProductToPO(product)) {
                        poSearchInput.value = '';
                        poSearchInput.focus();
                        modal.querySelector('#po-item-search-results').classList.add('hidden');
                    }
                } else {
                    showToast(`No product found with barcode or SKU: ${code}`, 'error');
                }
            }
        });
    }

    modal.addEventListener('input', e => {
        const target = e.target;
        const itemInput = target.closest('.po-item-input');
        const searchInput = target.closest('#po-item-search');
        const headerInput = target.closest('[name="supplierId"], [name="orderDate"], [name="expectedDate"], [name="notes"], [name="paymentTerms"], [name="poNumber"], [name="status"]');

        if (itemInput) {
            const row = itemInput.closest('tr');
            const index = row.dataset.index; 
            const field = itemInput.dataset.field; 
            const value = parseFloat(itemInput.value) || 0; 
            if (poData.items[index]) { 
                if (field === 'cost') {
                    poData.items[index][field] = currencyUtils.convertToBase(value);
                } else {
                    poData.items[index][field] = value; 
                }
                const item = poData.items[index];
                const rowTotal = (item.quantity || 0) * (item.cost || 0);
                const totalCell = row.querySelector('td:nth-of-type(4)');
                if (totalCell) {
                    totalCell.textContent = currencyUtils.format(rowTotal);
                }
                updateTotals();
            }
        } else if (target.id === 'po-shipping-cost') { 
            poData.shippingCost = currencyUtils.convertToBase(parseFloat(target.value) || 0); 
            updateTotals();
        } else if (target.id === 'po-tax-rate') { 
            poData.taxRate = parseFloat(target.value) || 0; 
            updateTotals();
        } else if (headerInput) { 
            poData[headerInput.name] = headerInput.value; 
            if(headerInput.name === 'supplierId' && headerInput.value) { 
                modal.querySelector('#po-item-search').disabled = false;
            }
        } else if (searchInput) {
            const query = searchInput.value.toLowerCase(); const resultsContainer = modal.querySelector('#po-item-search-results');
            if (query.length < 1) { resultsContainer.classList.add('hidden'); return; }
            const filteredProducts = firestoreData.products.filter(p => 
                p.productType !== 'service' && 
                !p.parentSKU && 
                (p.name.toLowerCase().includes(query) || p.id.toLowerCase().includes(query))
            ).slice(0, 10);
            if (filteredProducts.length) {
                resultsContainer.innerHTML = filteredProducts.map(p => {
                    let detailsHTML = p.hasVariants 
                        ? `SKU: ${p.id} &bull; ${p.isSerialized ? 'Serialized Variants' : 'Has Variants'}`
                        : `SKU: ${p.id} / Cost: ${currencyUtils.format(p.costPrice || 0)}`;
                    return `<div data-action="add-po-item" data-id="${p.id}" class="p-3 cursor-pointer hover:bg-bg-tertiary"><p class="font-medium text-text-primary pointer-events-none">${p.name}</p><p class="text-xs text-text-secondary font-mono pointer-events-none">${detailsHTML}</p></div>`;
                }).join('');
                resultsContainer.classList.remove('hidden');
            } else {
                 resultsContainer.classList.add('hidden');
            }
        }
    });

    modal.addEventListener('click', e => {
        const target = e.target.closest('[data-action]'); if (!target) return;
        if (target.dataset.action === 'add-po-item') {
            const productId = target.dataset.id; 
            const product = firestoreData.products.find(p => p.id === productId);
            if (product) {
                if(handleAddProductToPO(product)) {
                    const searchInput = modal.querySelector('#po-item-search'); 
                    searchInput.value = ''; 
                    searchInput.focus(); 
                    modal.querySelector('#po-item-search-results').classList.add('hidden');
                }
            }
        }
        if (target.dataset.action === 'remove-po-item') { const index = target.closest('tr').dataset.index; poData.items.splice(index, 1); renderItems(); updateTotals(); }
        if (target.dataset.action === 'add-new-supplier-from-po') {
            openSupplierModal(null, (newSupplier) => {
                const supplierSelect = modal.querySelector('[name="supplierId"]');
                if (supplierSelect) {
                    const newOption = document.createElement('option');
                    newOption.value = newSupplier.id;
                    newOption.textContent = newSupplier.name;
                    supplierSelect.appendChild(newOption);
                    supplierSelect.value = newSupplier.id;
                    poData.supplierId = newSupplier.id;
                    const itemSearchInput = modal.querySelector('#po-item-search');
                    if (itemSearchInput) {
                        itemSearchInput.disabled = false;
                    }
                }
            });
        }
    });
    
    modal.querySelector('#po-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!poData.supplierId) { showToast('Please select a supplier.', 'error'); return; }
        if (poData.items.length === 0) { showToast('Please add at least one item.', 'error'); return; }
        
        // --- MODIFICATION START ---
        // If creating a new PO with status 'Received', handle it specially.
        if (!isEditing && poData.status === 'Received') {
            
            // This function encapsulates the logic for "Received" POs.
            const processReceivedPO = async () => {
                
                // --- NEW: Call the new hybrid modal ---
                // This modal asks for quantities, serials, selling price AND BARCODE.
                const receiveData = await openInitialReceiveModal(poData);
                if (!receiveData) { // User cancelled the 'Receive' modal
                    showToast('PO creation cancelled.', 'info');
                    return; // Stop the process
                }
                
                const { receivedItems, priceUpdates, barcodeUpdates } = receiveData;
                
                if (receivedItems.length === 0) {
                    showToast('No items were marked as received. PO created as "Ordered" instead.', 'info');
                    poData.status = 'Ordered'; // Downgrade status
                    // Let it fall through to the default save logic below.
                } else {
                    // --- User confirmed items to receive ---
                    try {
                        await runTransaction(db, async (transaction) => {
                            // 1. ALL READS MUST HAPPEN FIRST.
                            const productRefs = poData.items.map(item => doc(productsRef, item.productId));
                            const productDocs = await Promise.all(productRefs.map(ref => transaction.get(ref)));
                            
                            const productDataMap = new Map();
                            productDocs.forEach((doc, index) => {
                                if(doc.exists()) {
                                    productDataMap.set(doc.id, doc.data());
                                } else {
                                    throw new Error(`Product with ID ${productRefs[index].id} not found.`);
                                }
                            });

                            // 2. ALL WRITES CAN HAPPEN NOW.
                            const newDocRef = doc(purchaseOrdersRef);
                            
                            // Update poData.items with received quantities
                            poData.items.forEach(item => {
                                const receivedItem = receivedItems.find(r => r.productId === item.productId);
                                item.received = receivedItem ? receivedItem.quantity : 0;
                            });
                            
                            // Check if partially or fully received
                            const totalOrdered = poData.items.reduce((sum, i) => sum + i.quantity, 0);
                            const totalReceived = poData.items.reduce((sum, i) => sum + (i.received || 0), 0);
                            poData.status = totalReceived >= totalOrdered ? 'Received' : 'Partially Received';

                            // 2a. Save the PO document
                            transaction.set(newDocRef, { ...poData, id: newDocRef.id });

                            // 2b. Update stock, prices, and barcodes for each product.
                            for (const item of receivedItems) { // Loop over what was ACTUALLY received
                                const productData = productDataMap.get(item.productId);
                                // productData is guaranteed to exist from the read step
                                
                                const productRef = doc(productsRef, item.productId);
                                const updatePayload = {};
                                
                                // Calculate new weighted average cost
                                const poItem = poData.items.find(i => i.productId === item.productId);
                                const receivedCost = poItem.cost || 0;
                                const currentStock = productData.stock || 0;
                                const currentCost = productData.costPrice || 0;
                                const quantityReceived = item.quantity;
                                const totalNewStock = currentStock + quantityReceived;
                                
                                const totalCurrentValue = currentStock * currentCost;
                                const totalReceivedValue = quantityReceived * receivedCost;
                                updatePayload.costPrice = totalNewStock > 0 ? (totalCurrentValue + totalReceivedValue) / totalNewStock : receivedCost;

                                // Apply new selling price if it was provided
                                if (priceUpdates[item.productId] !== undefined) {
                                    updatePayload.price = priceUpdates[item.productId];
                                }

                                // Apply new barcode if it was provided and changed
                                if (barcodeUpdates[item.productId]) {
                                    updatePayload.barcode = barcodeUpdates[item.productId];
                                }
                                
                                // Update stock/serials
                                if (productData.isSerialized) {
                                    const newSerials = item.serials || [];
                                    const combinedSerials = [...new Set([...(productData.serials || []), ...newSerials])];
                                    updatePayload.serials = combinedSerials;
                                    updatePayload.stock = combinedSerials.length;
                                } else {
                                    updatePayload.stock = (productData.stock || 0) + item.quantity;
                                }
                                
                                transaction.update(productRef, updatePayload);
                            }
                        });

                        showToast(`PO created and stock received successfully!`, 'success');
                        closeModal(modal);
                        return; // Exit submit handler

                    } catch (error) {
                        console.error('Error creating received PO:', error);
                        showToast(`Failed to create PO and update stock: ${error.message}`, 'error');
                        return; // Exit submit handler
                    }
                }
            };
            
            await processReceivedPO(); // Run the async logic
            if (poData.status !== 'Ordered') {
                return; // Stop if processReceivedPO handled it or was cancelled
            }
            // If it falls through (e.g., user received 0 items), let the default logic save it as "Ordered".
        }
        // --- MODIFICATION END ---


        // Default logic for 'Draft' and 'Ordered' statuses, or when editing.
        try {
            if (isEditing) { 
                await updateDoc(doc(purchaseOrdersRef, poId), poData); 
                showToast(`PO #${(poData.poNumber || poId).slice(-6)} updated.`, 'success'); 
            } else { 
                const newDocRef = doc(purchaseOrdersRef);
                await setDoc(newDocRef, { ...poData, id: newDocRef.id });
                showToast(`PO #${(poData.poNumber || newDocRef.id).slice(-6)} created with status '${poData.status}'.`, 'success'); 
            }
            closeModal(modal);
        } catch (error) { console.error('Error saving PO:', error); showToast('Failed to save PO.', 'error'); }
    });
}


            function openPOVariantSelectorModal(parentProduct, onVariantSelected) {
                const variants = firestoreData.products.filter(p => p.parentSKU === parentProduct.id);
                if (variants.length === 0) {
                    showToast('This product has no variants defined.', 'error');
                    return;
                }

                let selectedVariantIds = new Set();

                const content = `
                    <p class="text-sm mb-4">Select variants of <strong>${parentProduct.name}</strong> to add to the purchase order.</p>
                    <div class="max-h-96 overflow-y-auto -mx-6">
                        <table class="w-full text-sm">
                            <thead class="sticky top-0 bg-bg-secondary z-10">
                                <tr class="text-left text-text-secondary uppercase text-xs">
                                    <th class="px-6 py-3 w-12 text-center"><input type="checkbox" data-action="select-all-po-variants" class="form-checkbox h-4 w-4 rounded text-accent focus:ring-accent"></th>
                                    <th class="px-6 py-3 font-medium">Variant</th>
                                    ${(parentProduct.variantAttributes || []).map(attr => `<th class="px-4 py-3 font-medium">${attr}</th>`).join('')}
                                    <th class="px-4 py-3 font-medium text-right">Cost Price</th>
                                    <th class="px-4 py-3 font-medium text-center">Current Stock</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-border-color">
                            ${variants.map(v => `
                                <tr data-id="${v.id}" class="po-variant-row hover:bg-bg-tertiary cursor-pointer">
                                    <td class="px-6 py-3 text-center"><input type="checkbox" data-action="select-po-variant" data-id="${v.id}" class="form-checkbox h-4 w-4 rounded text-accent focus:ring-accent pointer-events-none"></td>
                                    <td class="px-6 py-3 font-mono text-xs">${v.id}</td>
                                    ${(parentProduct.variantAttributes || []).map(attr => `<td class="px-4 py-3">${v.variantOptions?.[attr] || '-'}</td>`).join('')}
                                    <td class="px-4 py-3 text-right font-mono">${currencyUtils.format(v.costPrice || 0)}</td>
                                    <td class="px-4 py-3 text-center font-mono">${v.stock || 0}</td>
                                </tr>
                            `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="add-selected-variants-btn" class="btn btn-primary" disabled>Add Selected (0)</button>`;
                const modal = showModal('Select Variants', content, footer, { size: 'max-w-4xl', customClasses: 'p-0' });

                const addBtn = modal.querySelector('#add-selected-variants-btn');
                const tableBody = modal.querySelector('tbody');
                const selectAllCheckbox = modal.querySelector('[data-action="select-all-po-variants"]');

                const updateAddButtonState = () => {
                    if (selectedVariantIds.size > 0) {
                        addBtn.disabled = false;
                        addBtn.textContent = `Add Selected (${selectedVariantIds.size})`;
                    } else {
                        addBtn.disabled = true;
                        addBtn.textContent = 'Add Selected (0)';
                    }
                };

                tableBody.addEventListener('click', e => {
                    const row = e.target.closest('.po-variant-row');
                    if (row) {
                        const checkbox = row.querySelector('input[type="checkbox"]');
                        const variantId = row.dataset.id;
                        checkbox.checked = !checkbox.checked;
                        
                        if (checkbox.checked) {
                            selectedVariantIds.add(variantId);
                            row.classList.add('bg-blue-900/50');
                        } else {
                            selectedVariantIds.delete(variantId);
                            row.classList.remove('bg-blue-900/50');
                        }
                        
                        // Update select all checkbox state
                        const allCheckboxes = tableBody.querySelectorAll('input[type="checkbox"]');
                        const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                        selectAllCheckbox.checked = allChecked;

                        updateAddButtonState();
                    }
                });

                selectAllCheckbox.addEventListener('change', e => {
                    const isChecked = e.target.checked;
                    tableBody.querySelectorAll('.po-variant-row').forEach(row => {
                        const checkbox = row.querySelector('input[type="checkbox"]');
                        const variantId = row.dataset.id;
                        checkbox.checked = isChecked;
                        if (isChecked) {
                            selectedVariantIds.add(variantId);
                            row.classList.add('bg-blue-900/50');
                        } else {
                            selectedVariantIds.delete(variantId);
                            row.classList.remove('bg-blue-900/50');
                        }
                    });
                    updateAddButtonState();
                });

                addBtn.addEventListener('click', () => {
                    const variantsToAdd = variants.filter(v => selectedVariantIds.has(v.id));
                    onVariantSelected(variantsToAdd);
                    closeModal(modal);
                });
            }

           // --- NEW FUNCTION: openViewPurchaseOrderModal ---
function openViewPurchaseOrderModal(poId) {
    const po = firestoreData.purchaseOrders.find(p => p.id === poId);
    if (!po) { showToast('Purchase Order not found.', 'error'); return; }
    const supplier = firestoreData.suppliers.find(s => s.id === po.supplierId);
    const canUpdate = checkPermission('canUpdatePurchaseOrders');
    const subtotal = (po.items || []).reduce((sum, item) => sum + (item.quantity * item.cost), 0);
    const taxAmount = subtotal * ((po.taxRate || 0) / 100);
    const total = subtotal + taxAmount + (po.shippingCost || 0);

    const getStatusBadge = (status) => {
        const base = "px-2 py-1 text-xs font-semibold rounded-full inline-block";
        switch (status) { case 'Draft': return `${base} bg-gray-500/20 text-gray-300`; case 'Ordered': return `${base} bg-blue-500/20 text-blue-300`; case 'Partially Received': return `${base} bg-yellow-500/20 text-yellow-300`; case 'Received': return `${base} bg-green-500/20 text-green-300`; case 'Cancelled': return `${base} bg-red-500/20 text-red-300`; default: return `${base} bg-gray-500/20 text-gray-300`; }
    };

    const content = `
        <div id="po-view-content" class="p-6 space-y-6">
            <div class="flex justify-between items-start">
                <div><h3 class="text-2xl font-bold text-text-primary">Purchase Order</h3><p class="font-mono text-sm text-text-secondary">${po.poNumber || poId}</p></div>
                <div class="text-right"><span class="${getStatusBadge(po.status)}">${po.status}</span><p class="text-sm text-text-secondary mt-1">Order: ${new Date(po.orderDate).toLocaleDateString()} | Expected: ${po.expectedDate ? new Date(po.expectedDate).toLocaleDateString() : 'N/A'}</p></div>
            </div>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div class="bg-bg-secondary p-4 rounded-lg"><h4 class="text-xs uppercase font-semibold text-text-secondary mb-2">Supplier</h4><p class="font-medium text-text-primary">${supplier?.name || 'N/A'}</p><p class="text-text-secondary">${supplier?.address || ''}</p></div>
                <div class="bg-bg-secondary p-4 rounded-lg"><h4 class="text-xs uppercase font-semibold text-text-secondary mb-2">Ship To</h4><p class="font-medium text-text-primary">${firestoreData.storeInfo.name}</p><p class="text-text-secondary">${firestoreData.storeInfo.address}</p></div>
            </div>
            <div>
                <h4 class="text-xs uppercase font-semibold text-text-secondary mb-2">Items</h4>
                <div class="overflow-x-auto rounded-lg border border-border-color">
                    <table class="w-full text-sm">
                        <thead class="bg-bg-secondary"><tr class="text-left text-text-secondary text-xs uppercase"><th class="px-4 py-2 font-medium">Product</th><th class="px-4 py-2 font-medium text-center">Ordered</th><th class="px-4 py-2 font-medium text-center">Received</th><th class="px-4 py-2 font-medium text-right">Cost</th><th class="px-4 py-2 font-medium text-right">Total</th></tr></thead>
                        <tbody class="divide-y divide-border-color">
                        ${(po.items || []).map(item => { const product = firestoreData.products.find(p => p.id === item.productId); const received = item.received || 0; const progress = item.quantity > 0 ? (received / item.quantity) * 100 : 0;
                            return `<tr><td class="px-4 py-3"><p class="font-medium text-text-primary">${product?.name || 'Unknown'}</p><p class="text-xs text-text-secondary font-mono">${item.productId}</p><div class="w-full bg-bg-tertiary rounded-full h-1 mt-1.5"><div class="bg-green-500 h-1 rounded-full" style="width: ${progress}%"></div></div></td><td class="px-4 py-3 text-center font-mono">${item.quantity}</td><td class="px-4 py-3 text-center font-mono">${received}</td><td class="px-4 py-3 text-right font-mono">${currencyUtils.format(item.cost)}</td><td class="px-4 py-3 text-right font-mono">${currencyUtils.format(item.quantity * item.cost)}</td></tr>`}).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-6">
                 <div class="col-span-2 grid grid-cols-2 gap-4">
                    <div><h4 class="text-xs uppercase font-semibold text-text-secondary mb-2">Notes</h4><p class="text-sm p-4 bg-bg-secondary rounded-lg min-h-[5rem]">${po.notes || 'No notes for this order.'}</p></div>
                    <div><h4 class="text-xs uppercase font-semibold text-text-secondary mb-2">Payment Terms</h4><p class="text-sm p-4 bg-bg-secondary rounded-lg min-h-[5rem]">${po.paymentTerms || 'Not specified'}</p></div>
                 </div>
                <div class="text-right space-y-2 text-sm">
                    <div class="flex justify-between"><span>Subtotal:</span> <span class="font-mono text-text-primary">${currencyUtils.format(subtotal)}</span></div>
                    <div class="flex justify-between"><span>Shipping:</span> <span class="font-mono text-text-primary">${currencyUtils.format(po.shippingCost || 0)}</span></div>
                    <div class="flex justify-between"><span>Tax (${po.taxRate || 0}%):</span><span class="font-mono text-text-primary">${currencyUtils.format(taxAmount)}</span></div>
                    <div class="h-px bg-border-color my-1"></div>
                    <div class="flex justify-between font-bold text-xl"><span>Total:</span> <span class="font-mono text-accent">${currencyUtils.format(total)}</span></div>
                </div>
            </div>
        </div>`;

    let footer = `<button data-action="close-modal" class="btn btn-secondary">Close</button><button data-action="print-po" class="btn btn-secondary"><i data-lucide="printer" class="w-4 h-4 mr-2"></i>Print</button>`;
    if (canUpdate) { 
        if (po.status === 'Draft') { 
            footer += `<button data-action="cancel-po" data-id="${poId}" class="btn btn-danger-secondary">Cancel PO</button><button data-action="edit-purchase-order" data-id="${poId}" class="btn btn-secondary">Edit PO</button><button data-action="mark-po-ordered" data-id="${poId}" class="btn btn-primary">Mark as Ordered</button>`; 
        } else if (po.status === 'Ordered' || po.status === 'Partially Received') { 
            footer += `<button data-action="cancel-po" data-id="${poId}" class="btn btn-danger-secondary">Cancel PO</button><button data-action="receive-po-stock" data-id="${poId}" class="btn btn-primary">Receive Stock</button>`; 
        } 
    }
    const modal = showModal(`Purchase Order Details`, content, footer, { size: 'max-w-4xl', customClasses: 'p-0' });
    lucide.createIcons();
    
    modal.addEventListener('click', e => {
        const target = e.target.closest('[data-action]'); if (!target) return;
        e.stopPropagation(); // Stop event from bubbling to the global listener
        
        const action = target.dataset.action;
        const id = target.dataset.id;

        if (action === 'print-po') { printElement('po-view-content'); }
        if (action === 'edit-purchase-order') { closeModal(modal); openPurchaseOrderModal(id); }
        if (action === 'receive-po-stock') { closeModal(modal); openReceivePOStockModal(id); }
        
        if (action === 'close-modal') {
            closeModal(modal);
        }

        if (action === 'mark-po-ordered') {
            if (!checkPermission('canUpdatePurchaseOrders')) return;
            const confirmModal = showModal('Confirm Order', 'This will mark the PO as Ordered and lock it from editing. Are you sure?', `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-order" class="btn btn-primary">Yes, Mark as Ordered</button>`);
            confirmModal.querySelector('#confirm-order').addEventListener('click', async () => {
                await updateDoc(doc(purchaseOrdersRef, id), { status: 'Ordered' });
                showToast('PO marked as Ordered.', 'success');
                closeModal(confirmModal);
                closeModal(modal);
            });
        }
        
        if (action === 'cancel-po') {
            if (!checkPermission('canUpdatePurchaseOrders')) return;
            const confirmModal = showModal('Confirm Cancellation', 'Are you sure you want to cancel this Purchase Order?', `<button data-action="close-modal" class="btn btn-secondary">No</button><button id="confirm-cancel" class="btn btn-danger">Yes, Cancel PO</button>`);
            confirmModal.querySelector('#confirm-cancel').addEventListener('click', async () => {
                await updateDoc(doc(purchaseOrdersRef, id), { status: 'Cancelled' });
                showToast('PO has been cancelled.', 'success');
                closeModal(confirmModal);
                closeModal(modal);
            });
        }
    });
}

function openInitialReceiveModal(poData) {
    return new Promise((resolve) => {
        const content = `
            <form id="initial-receive-form" class="space-y-4">
                <p class="text-sm">You are creating a new PO with status "Received". Please confirm the items, quantities, selling prices, and barcodes you are adding to your inventory.</p>
                <div class="max-h-[60vh] overflow-y-auto -mx-6">
                    <table class="w-full text-sm">
                        <thead class="sticky top-0 bg-bg-secondary z-10">
                            <tr class="text-left text-text-secondary uppercase text-xs">
                                <th class="px-6 py-3 font-medium">Product</th>
                                <th class="px-6 py-3 font-medium w-32">Barcode</th>
                                <th class="px-6 py-3 font-medium text-center">Ordered Qty</th>
                                <th class="px-6 py-3 font-medium text-center w-64">Receiving Now</th>
                                <th class="px-6 py-3 font-medium text-right w-40">New Selling Price (${appState.currentCurrency})</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-border-color">
                        ${poData.items.map(item => {
                            const product = firestoreData.products.find(p => p.id === item.productId);
                            // MODIFICATION: 'remaining' is just 'item.quantity' for a new PO
                            const remaining = item.quantity;
                            if (remaining <= 0) return ''; 

                            const isSerialized = product?.isSerialized;
                            const currentPriceInBase = product?.price || 0;
                            const currentPriceInDisplay = currencyUtils.convert(currentPriceInBase).toFixed(2);
                            const currentBarcode = product?.barcode || '';
                            
                            let receivingInputHTML = '';
                            if (isSerialized) {
                                receivingInputHTML = `
                                    <textarea name="serials_${item.productId}" class="form-textarea w-full h-24 text-xs font-mono" placeholder="One serial per line..." data-action="count-serials" data-product-id="${item.productId}"></textarea>
                                    <!-- MODIFICATION: Count is out of 'remaining' (which is total ordered) -->
                                    <p class="text-xs text-text-secondary mt-1 text-center">Count: <span id="serial-count-${item.productId}">0</span> / ${remaining}</p>
                                `;
                            } else {
                                receivingInputHTML = `<input type="number" name="qty_${item.productId}" value="${remaining}" min="0" max="${remaining}" class="form-input w-24 text-center mx-auto" required>`;
                            }

                            return `
                            <tr class="hover:bg-bg-tertiary/50">
                                <td class="px-6 py-3">
                                    <p class="font-medium text-text-primary">${product?.name || 'Unknown'}</p>
                                    <p class="text-xs text-text-secondary font-mono">${item.productId}</p>
                                </td>
                                <td class="px-6 py-3">
                                    <input type="text" name="barcode_${item.productId}" value="${currentBarcode}" class="form-input w-full text-xs font-mono" placeholder="Scan/Type Barcode">
                                </td>
                                <td class="px-6 py-3 text-center font-mono">${item.quantity}</td>
                                <td class="px-6 py-3">
                                    ${receivingInputHTML}
                                </td>
                                <td class="px-6 py-3">
                                    <input type="number" step="0.01" name="price_${item.productId}" value="${currentPriceInDisplay}" class="form-input w-32 text-right" required>
                                </td>
                            </tr>
                            `;
                        }).join('')}
                        </tbody>
                    </table>
                </div>
            </form>
        `;
        const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="initial-receive-form" class="btn btn-primary">Confirm & Create PO</button>`;
        const modal = showModal('Confirm Received Stock', content, footer, { size: 'max-w-5xl', customClasses: 'p-0' }); // Increased size for extra column

        modal.addEventListener('input', e => {
            const target = e.target.closest('[data-action="count-serials"]');
            if (target) {
                const productId = target.dataset.productId;
                const serials = target.value.split('\n').map(s => s.trim()).filter(Boolean);
                const countEl = modal.querySelector(`#serial-count-${productId}`);
                if (countEl) {
                    countEl.textContent = serials.length;
                }
            }
        });

        // MODIFICATION: This submit handler now resolves with data instead of writing to Firestore
        modal.querySelector('#initial-receive-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const receivedItems = []; // This will store the received quantities/serials
            const priceUpdates = {};
            const barcodeUpdates = {}; // Store barcode updates
            let validationError = null;

            for (const item of poData.items) {
                const product = firestoreData.products.find(p => p.id === item.productId);
                // MODIFICATION: 'requiredQty' is the total ordered qty
                const requiredQty = item.quantity;
                
                // Get Price Update
                const newPriceInDisplayStr = formData.get(`price_${item.productId}`);
                if (newPriceInDisplayStr !== null) {
                    const newPriceInDisplay = parseFloat(newPriceInDisplayStr);
                    if (!isNaN(newPriceInDisplay) && newPriceInDisplay >= 0) {
                        priceUpdates[item.productId] = currencyUtils.convertToBase(newPriceInDisplay);
                    }
                }

                // Get Barcode Update
                const newBarcode = formData.get(`barcode_${item.productId}`)?.trim();
                if (newBarcode !== undefined) {
                    barcodeUpdates[item.productId] = newBarcode;
                }
                
                if (product?.isSerialized) {
                    const serials = (formData.get(`serials_${item.productId}`) || '').split('\n').map(s => s.trim()).filter(Boolean);
                    // MODIFICATION: Validation is against 'requiredQty'
                    if (serials.length !== requiredQty) {
                        validationError = `You must enter exactly ${requiredQty} serial numbers for ${product.name}. You entered ${serials.length}.`;
                        break;
                    }
                    if (new Set(serials).size !== serials.length) {
                        validationError = `Duplicate serial numbers found for ${product.name}. Please ensure all serials are unique.`;
                        break;
                    }
                    receivedItems.push({ productId: item.productId, quantity: serials.length, serials: serials });
                } else {
                    const quantity = parseInt(formData.get(`qty_${item.productId}`), 10);
                     // MODIFICATION: Validation is against 'requiredQty'
                    if (isNaN(quantity) || quantity < 0 || quantity > requiredQty) {
                        validationError = `Invalid quantity for ${product.name}. Must be between 0 and ${requiredQty}.`;
                        break;
                    }
                    if (quantity > 0) {
                        receivedItems.push({ productId: item.productId, quantity: quantity, serials: [] });
                    }
                }
            }

            if (validationError) {
                showToast(validationError, 'error');
                return;
            }
            
            closeModal(modal);
            // MODIFICATION: Resolve with the collected data
            resolve({ receivedItems, priceUpdates, barcodeUpdates });
        });
        
        modal.querySelector('[data-action="close-modal"]').addEventListener('click', () => {
            closeModal(modal);
            resolve(null); // Resolve with null on cancel
        });
    });
}
            // --- NEW FUNCTION: openReceivePOStockModal ---
function openReceivePOStockModal(poId) {
    const po = firestoreData.purchaseOrders.find(p => p.id === poId);
    if (!po) {
        showToast('Purchase Order not found.', 'error');
        return;
    }

    const content = `
        <form id="receive-po-stock-form" class="space-y-4">
            <p class="text-sm">Enter the quantity or serial numbers for items you are receiving now for PO <strong class="font-mono text-text-primary">${po.poNumber || po.id}</strong>.</p>
            <div class="max-h-[60vh] overflow-y-auto -mx-6">
                <table class="w-full text-sm">
                    <thead class="sticky top-0 bg-bg-secondary z-10">
                        <tr class="text-left text-text-secondary uppercase text-xs">
                            <th class="px-6 py-3 font-medium">Product</th>
                            <th class="px-6 py-3 font-medium w-32">Barcode</th>
                            <th class="px-6 py-3 font-medium text-center">Remaining</th>
                            <th class="px-6 py-3 font-medium text-center w-64">Receiving Now</th>
                            <th class="px-6 py-3 font-medium text-right w-40">New Selling Price (${appState.currentCurrency})</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-border-color">
                    ${po.items.map(item => {
                        const product = firestoreData.products.find(p => p.id === item.productId);
                        const remaining = item.quantity - (item.received || 0);
                        if (remaining <= 0) return ''; 

                        const isSerialized = product?.isSerialized;
                        const currentPriceInBase = product?.price || 0;
                        const currentPriceInDisplay = currencyUtils.convert(currentPriceInBase).toFixed(2);
                        const currentBarcode = product?.barcode || '';

                        let receivingInputHTML = '';
                        if (isSerialized) {
                            receivingInputHTML = `
                                <textarea name="serials_${item.productId}" class="form-textarea w-full h-24 text-xs font-mono" placeholder="One serial per line..." data-action="count-serials" data-product-id="${item.productId}"></textarea>
                                <p class="text-xs text-text-secondary mt-1 text-center">Count: <span id="serial-count-${item.productId}">0</span> / ${remaining}</p>
                            `;
                        } else {
                            receivingInputHTML = `<input type="number" name="qty_${item.productId}" value="${remaining}" min="0" max="${remaining}" class="form-input w-24 text-center mx-auto" required>`;
                        }

                        return `
                        <tr class="hover:bg-bg-tertiary/50">
                            <td class="px-6 py-3">
                                <p class="font-medium text-text-primary">${product?.name || 'Unknown'}</p>
                                <p class="text-xs text-text-secondary font-mono">${item.productId}</p>
                            </td>
                            <td class="px-6 py-3">
                                <input type="text" name="barcode_${item.productId}" value="${currentBarcode}" class="form-input w-full text-xs font-mono" placeholder="Scan/Type Barcode">
                            </td>
                            <td class="px-6 py-3 text-center font-mono">${remaining}</td>
                            <td class="px-6 py-3">
                                ${receivingInputHTML}
                            </td>
                            <td class="px-6 py-3">
                                <input type="number" step="0.01" name="price_${item.productId}" value="${currentPriceInDisplay}" class="form-input w-32 text-right" required>
                            </td>
                        </tr>
                        `;
                    }).join('')}
                    </tbody>
                </table>
            </div>
        </form>
    `;
    const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="receive-po-stock-form" class="btn btn-primary">Receive Items</button>`;
    const modal = showModal('Receive Stock', content, footer, { size: 'max-w-5xl', customClasses: 'p-0' });

    modal.addEventListener('input', e => {
        const target = e.target.closest('[data-action="count-serials"]');
        if (target) {
            const productId = target.dataset.productId;
            const serials = target.value.split('\n').map(s => s.trim()).filter(Boolean);
            const countEl = modal.querySelector(`#serial-count-${productId}`);
            if (countEl) {
                countEl.textContent = serials.length;
            }
        }
    });

    modal.querySelector('#receive-po-stock-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const receivedQuantities = {};
        const receivedSerials = {};
        const priceUpdates = {}; // To store price changes
        const barcodeUpdates = {}; // To store barcode changes
        let hasReceivedItems = false;
        let validationError = null;

        for (const item of po.items) {
            const product = firestoreData.products.find(p => p.id === item.productId);
            const remaining = item.quantity - (item.received || 0);
            
            // --- NEW: Read price from form ---
            const newPriceInDisplayStr = formData.get(`price_${item.productId}`);
            if (newPriceInDisplayStr !== null) { // Check if the field exists
                const newPriceInDisplay = parseFloat(newPriceInDisplayStr);
                if (!isNaN(newPriceInDisplay) && newPriceInDisplay >= 0) {
                    priceUpdates[item.productId] = currencyUtils.convertToBase(newPriceInDisplay);
                }
            }

            // --- NEW: Read barcode from form ---
            const newBarcode = formData.get(`barcode_${item.productId}`)?.trim();
            if (newBarcode !== undefined) {
                barcodeUpdates[item.productId] = newBarcode;
            }
            
            if (product?.isSerialized) {
                const serials = (formData.get(`serials_${item.productId}`) || '').split('\n').map(s => s.trim()).filter(Boolean);
                if (serials.length > 0) {
                    if (serials.length > remaining) {
                        validationError = `Cannot receive ${serials.length} serials for ${product.name}; only ${remaining} are remaining on this PO.`;
                        break;
                    }
                    if (new Set(serials).size !== serials.length) {
                         validationError = `Duplicate serial numbers found for ${product.name}. Please ensure all serials are unique.`;
                        break;
                    }
                    receivedQuantities[item.productId] = serials.length;
                    receivedSerials[item.productId] = serials;
                    hasReceivedItems = true;
                }
            } else {
                const quantity = parseInt(formData.get(`qty_${item.productId}`), 10);
                if (!isNaN(quantity) && quantity > 0) {
                     if (quantity > remaining) {
                        validationError = `Cannot receive ${quantity} for ${product.name}; only ${remaining} are remaining on this PO.`;
                        break;
                    }
                    receivedQuantities[item.productId] = quantity;
                    hasReceivedItems = true;
                }
            }
        }

        if (validationError) {
            showToast(validationError, 'error');
            return;
        }
        if (!hasReceivedItems) {
            showToast('No quantities entered. Nothing to receive.', 'info');
            return;
        }

        try {
            await runTransaction(db, async (transaction) => {
                // --- STAGE 1: ALL READS MUST HAPPEN FIRST ---
                const poRef = doc(purchaseOrdersRef, po.id);
                const poDocPromise = transaction.get(poRef);

                // Create an array of product references and get promises for all of them
                const productIdsToRead = Object.keys(receivedQuantities);
                const productRefs = productIdsToRead.map(id => doc(productsRef, id));
                const productDocsPromises = productRefs.map(ref => transaction.get(ref));

                // Await all reads
                const [poDoc, ...productDocs] = await Promise.all([poDocPromise, ...productDocsPromises]);

                if (!poDoc.exists()) throw new Error("PO not found.");

                // Create a map for easy lookup of product data after reading
                const productDataMap = new Map();
                productDocs.forEach((docSnap, index) => {
                    if (!docSnap.exists()) throw new Error(`Product ${productIdsToRead[index]} not found.`);
                    productDataMap.set(docSnap.id, docSnap.data());
                });

                // --- STAGE 2: ALL WRITES CAN HAPPEN NOW ---
                const currentPOData = poDoc.data();
                const updatedItems = JSON.parse(JSON.stringify(currentPOData.items));

                for (const productId in receivedQuantities) {
                    const productData = productDataMap.get(productId);
                    const poItem = currentPOData.items.find(i => i.productId === productId);
                    if (!poItem) continue;

                    const quantityReceived = receivedQuantities[productId];
                    const updatePayload = {};

                    // Calculate new weighted average cost
                    const receivedCost = poItem.cost || 0;
                    const currentStock = productData.stock || 0;
                    const currentCost = productData.costPrice || 0;
                    const totalNewStock = currentStock + quantityReceived;
                    const totalCurrentValue = currentStock * currentCost;
                    const totalReceivedValue = quantityReceived * receivedCost;
                    updatePayload.costPrice = totalNewStock > 0 ? (totalCurrentValue + totalReceivedValue) / totalNewStock : receivedCost;
                    
                    // --- NEW: Add selling price to payload if it exists ---
                    if (priceUpdates[productId] !== undefined) {
                        const newPriceBase = priceUpdates[productId];
                        // Only update if the price has actually changed
                        if (Math.abs(newPriceBase - (productData.price || 0)) > 0.001) {
                            updatePayload.price = newPriceBase;
                        }
                    }

                    // --- NEW: Add barcode to payload if changed ---
                    if (barcodeUpdates[productId] && barcodeUpdates[productId] !== (productData.barcode || '')) {
                        updatePayload.barcode = barcodeUpdates[productId];
                    }
                    
                    // Update stock/serials
                    if (productData.isSerialized) {
                        const newSerials = receivedSerials[productId] || [];
                        const combinedSerials = [...new Set([...(productData.serials || []), ...newSerials])];
                        updatePayload.serials = combinedSerials;
                        updatePayload.stock = combinedSerials.length;
                    } else {
                        updatePayload.stock = totalNewStock;
                    }
                    
                    // Queue the product update
                    const productRef = doc(productsRef, productId);
                    transaction.update(productRef, updatePayload);
                    
                    // Update the item within the PO data
                    const itemIndex = updatedItems.findIndex(i => i.productId === productId);
                    if (itemIndex > -1) {
                        updatedItems[itemIndex].received = (updatedItems[itemIndex].received || 0) + quantityReceived;
                    }
                }

                // Determine the new PO status
                const totalOrdered = updatedItems.reduce((sum, i) => sum + i.quantity, 0);
                const totalReceived = updatedItems.reduce((sum, i) => sum + (i.received || 0), 0);
                const newStatus = totalReceived >= totalOrdered ? 'Received' : 'Partially Received';

                // Queue the PO update
                transaction.update(poRef, { items: updatedItems, status: newStatus });
                
                // Queue the audit log creation
                const auditLogRefNew = doc(auditLogRef);
                transaction.set(auditLogRefNew, {
                    type: 'stock_received',
                    timestamp: new Date().toISOString(),
                    poId: po.id,
                    details: `Received stock for PO #${po.poNumber || po.id.slice(-6)}. Status: ${newStatus}.`,
                    user: { id: appState.session.currentUser.uid, name: appState.session.currentUser.name }
                });
            });
            
            showToast('Stock received and inventory updated!', 'success');
            closeModal(modal);

        } catch (error) {
            console.error("Error receiving stock:", error);
            showToast(`Failed to receive stock: ${error.message}`, 'error');
        }
    });
}





            // --- END NEW LOGIC ---

            function initCustomers(pane) {
                const tableBody = pane.querySelector('#customers-table-body');
                const viewState = appState.viewStates.customers;
                const renderTable = () => {
                    // Apply search
                    let filteredCustomers = firestoreData.customers;
                    if (viewState.searchQuery) {
                        const query = viewState.searchQuery.toLowerCase();
                        filteredCustomers = filteredCustomers.filter(c => 
                            c.name.toLowerCase().includes(query) ||
                            c.phone.includes(query) ||
                            c.email.toLowerCase().includes(query) ||
                            (c.loyaltyId || '').toLowerCase().includes(query)
                        );
                    }

                    // Sort by join date, newest first
                    filteredCustomers.sort((a, b) => new Date(b.joinDate) - new Date(a.joinDate));

                    // Apply pagination
                    const totalItems = filteredCustomers.length;
                    const startIndex = (viewState.currentPage - 1) * appState.itemsPerPage;
                    const endIndex = startIndex + appState.itemsPerPage;
                    const paginatedCustomers = filteredCustomers.slice(startIndex, endIndex);
                    const canEditDelete = checkPermission('canManageStaff'); // Admins/Managers can edit/delete
                    
                    // Inject search bar if not present
                    if (!pane.querySelector('#customer-search-container')) {
                        const header = pane.querySelector('.flex.justify-between.items-center.mb-6');
                        header.insertAdjacentHTML('afterend', `
                            <div id="customer-search-container" class="flex gap-4 mb-4">
                                <div class="relative flex-grow">
                                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i>
                                    <input type="text" id="customer-search" placeholder="Search by name, phone, email, loyalty ID..." class="form-input w-full pl-10" value="${viewState.searchQuery}">
                                </div>
                            </div>
                        `);
                        lucide.createIcons();
                        pane.querySelector('#customer-search').addEventListener('input', (e) => {
                            viewState.searchQuery = e.target.value;
                            viewState.currentPage = 1;
                            renderTable();
                        });
                    }
                    
                    tableBody.innerHTML = paginatedCustomers.length ? paginatedCustomers.map(c => `
                        <tr class="table-row">
                            <td class="font-medium text-text-primary">${c.name}</td>
                            <td><div>${c.email}</div><div class="text-xs">${c.phone}</div></td>
                            <td class="text-left">
                                ${(c.currentDue || 0) > 0 
                                    ? `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-500/20 text-red-300 inline-block font-mono">${currencyUtils.format(c.currentDue)}</span>` 
                                    : `<span class="font-mono text-text-secondary">${currencyUtils.format(0)}</span>`
                                }
                            </td>
                            <td class="font-mono text-xs">${c.loyaltyId || 'N/A'}</td>
                            <td class="text-right">
                                <div class="relative inline-block text-left">
                                    <button data-action="toggle-action-menu" data-id="${c.id}" class="p-2 rounded-md hover:bg-bg-tertiary focus:outline-none focus:ring-2 focus:ring-accent">
                                        <i data-lucide="more-vertical" class="w-5 h-5 pointer-events-none"></i>
                                    </button>
                                    <div class="action-menu">
                                        <div class="action-menu-item" data-action="receive-payment" data-id="${c.id}"><i data-lucide="hand-coins" class="w-4 h-4"></i><span>Receive Payment</span></div>
                                        <div class="h-px bg-border-color my-1"></div>
                                        ${canEditDelete ? `<div class="action-menu-item" data-action="edit-customer" data-id="${c.id}"><i data-lucide="edit" class="w-4 h-4"></i><span>Edit</span></div>` : ''}
                                        <div class="action-menu-item" data-action="view-customer-invoices" data-id="${c.id}"><i data-lucide="file-text" class="w-4 h-4"></i><span>View Invoices</span></div>
                                        ${canEditDelete ? `<div class="h-px bg-border-color my-1"></div><div class="action-menu-item danger" data-action="delete-customer" data-id="${c.id}"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Delete Customer</span></div>` : ''}
                                    </div>
                                </div>
                            </td>
                        </tr>`).join('') : `<tr><td colspan="5" class="text-center p-8 text-text-secondary" style="grid-column: 1 / -1;">No customers found.</td></tr>`;

                    // Inject pagination container if not present
                    if (!pane.querySelector('#customers-pagination')) {
                        tableBody.parentElement.parentElement.insertAdjacentHTML('afterend', '<div id="customers-pagination" class="mt-4"></div>');
                    }
                    renderPaginationControls(pane.querySelector('#customers-pagination'), totalItems, viewState.currentPage, appState.itemsPerPage, 'customers');
                    lucide.createIcons();
                };
                renderTable();
            }
            function initStaff(container) { // UPDATED FUNCTION
                if (!container) return;

                const canInvite = checkPermission('canManageStaff') || checkPermission('canInviteCashiers');
                const viewState = appState.viewStates.staff; // NEW: Get view state
                
                // Render the main structure with filters
                container.innerHTML = `
                    <div>
                        <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
                            <h1 class="text-3xl font-bold text-text-primary">Staff Management</h1>
                            ${canInvite ? `
                            <button data-action="invite-staff" class="btn btn-primary">
                                <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i> Invite Staff
                            </button>
                            ` : ''}
                        </div>
                        
                        <!-- NEW: Search and Filters -->
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <div class="relative flex-grow">
                                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i>
                                <input type="text" id="staff-search" placeholder="Search by name or email..." class="form-input w-full pl-10" value="${viewState.searchQuery}">
                            </div>
                            <select id="staff-role-filter" class="form-select md:w-48">
                                <option value="all" ${viewState.filters.role === 'all' ? 'selected' : ''}>All Roles</option>
                                <option value="admin" ${viewState.filters.role === 'admin' ? 'selected' : ''}>Administrator</option>
                                <option value="manager" ${viewState.filters.role === 'manager' ? 'selected' : ''}>Manager</option>
                                <option value="cashier" ${viewState.filters.role === 'cashier' ? 'selected' : ''}>Cashier</option>
                            </select>
                            <select id="staff-status-filter" class="form-select md:w-48">
                                <option value="all" ${viewState.filters.status === 'all' ? 'selected' : ''}>All Statuses</option>
                                <option value="active" ${viewState.filters.status === 'active' ? 'selected' : ''}>Active</option>
                                <option value="inactive" ${viewState.filters.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                <option value="pending" ${viewState.filters.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="deactivation_pending" ${viewState.filters.status === 'deactivation_pending' ? 'selected' : ''}>Deactivation Pending</option>
                            </select>
                        </div>
                        
                        <div class="bg-bg-secondary/50 rounded-xl">
                            <table class="table-pro">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Joined On</th>
                                        <th>Total Sales (30d)</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="staff-table-body"></tbody>
                            </table>
                        </div>
                        <div id="staff-pagination" class="mt-4"></div>
                    </div>
                `;

                const tableBody = container.querySelector('#staff-table-body');
                
                const getStatusBadge = (status) => {
                    const base = "px-2 py-0.5 text-xs font-semibold rounded-full inline-block";
                    if (status === 'active') return `${base} bg-green-500/20 text-green-300`;
                    if (status === 'inactive') return `${base} bg-gray-500/20 text-gray-300`;
                    if (status === 'pending') return `${base} bg-yellow-500/20 text-yellow-300`;
                    if (status === 'deactivation_pending') return `${base} bg-orange-500/20 text-orange-300`;
                    return `${base} bg-gray-500/20 text-gray-300`;
                };

                const renderStaffTable = () => {
                    let staffList = firestoreData.staff;
                    const loggedInUser = appState.session.currentUser;
                    const loggedInRole = appState.session.userRole;

                    if (loggedInRole === 'manager') {
                        staffList = staffList.filter(member => member.role !== 'admin');
                    }

                    // --- NEW: Apply Filters ---
                    if (viewState.searchQuery) {
                        const query = viewState.searchQuery.toLowerCase();
                        staffList = staffList.filter(m => 
                            m.name.toLowerCase().includes(query) || 
                            m.email.toLowerCase().includes(query)
                        );
                    }
                    if (viewState.filters.role !== 'all') {
                        staffList = staffList.filter(m => m.role === viewState.filters.role);
                    }
                    if (viewState.filters.status !== 'all') {
                        staffList = staffList.filter(m => (m.status || 'active') === viewState.filters.status);
                    }
                    // --- END NEW ---

                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                    // Pre-calculate sales for performance
                    const salesByCashier = firestoreData.invoices
                        .filter(inv => new Date(inv.date) >= thirtyDaysAgo && inv.status !== 'Void')
                        .reduce((acc, inv) => {
                            if (inv.cashierId) {
                                acc[inv.cashierId] = (acc[inv.cashierId] || 0) + inv.totalInBaseCurrency;
                            }
                            return acc;
                        }, {});

                    // --- NEW: Apply Pagination to filtered list ---
                    const totalItems = staffList.length;
                    const startIndex = (viewState.currentPage - 1) * appState.itemsPerPage;
                    const endIndex = startIndex + appState.itemsPerPage;
                    const paginatedStaff = staffList.slice(startIndex, endIndex);


                    tableBody.innerHTML = paginatedStaff.length ? paginatedStaff.map(member => {
                        const totalSales = salesByCashier[member.id] || 0;
                        const canViewPerformance = checkPermission('canViewStaffPerformance');
                        const loggedInRole = appState.session.userRole; // Get role explicitly
                        const canRequestDeactivation = checkPermission('canRequestStaffDeactivation');
                        const canEditCashier = checkPermission('canEditCashierDetails');
                        
                        // Define action menu items based on permissions and logic
                        let actionMenuItems = [];
                        
                        // --- Invitation & Deactivation Approval (Admin Only) ---
                        if (loggedInRole === 'admin') {
                            if (member.status === 'pending') {
                                actionMenuItems.push(`<div class="action-menu-item" data-action="approve-staff" data-id="${member.id}"><i data-lucide="user-check" class="w-4 h-4 text-green-400"></i><span class="text-green-400">Approve Invitation</span></div>`);
                                actionMenuItems.push(`<div class="action-menu-item danger" data-action="reject-staff" data-id="${member.id}"><i data-lucide="user-x" class="w-4 h-4"></i><span>Reject Invitation</span></div>`);
                            } else if (member.status === 'deactivation_pending') {
                                actionMenuItems.push(`<div class="action-menu-item" data-action="approve-deactivation" data-id="${member.id}"><i data-lucide="user-x" class="w-4 h-4 text-red-400"></i><span class="text-red-400">Approve Deactivation</span></div>`);
                                actionMenuItems.push(`<div class="action-menu-item" data-action="reject-deactivation" data-id="${member.id}"><i data-lucide="rotate-ccw" class="w-4 h-4"></i><span>Reject Deactivation</span></div>`);
                            }
                        }
                        
                        // --- Standard Actions (Apply to non-pending states) ---
                        const isPending = member.status === 'pending' || member.status === 'deactivation_pending';
                        if (!isPending) {
                            if (canViewPerformance) {
                                actionMenuItems.push(`<div class="action-menu-item" data-action="view-staff-performance" data-id="${member.id}"><i data-lucide="bar-chart-2" class="w-4 h-4"></i><span>View Performance</span></div>`);
                            }

                            // Admin-specific direct management actions
                            if (loggedInRole === 'admin' && loggedInUser.uid !== member.id && member.role !== 'admin') {
                                actionMenuItems.push('<div class="h-px bg-border-color my-1"></div>');
                                actionMenuItems.push(`<div class="action-menu-item" data-action="edit-staff" data-id="${member.id}"><i data-lucide="edit" class="w-4 h-4"></i><span>Edit Role/Status</span></div>`);
                                
                                const currentStatus = member.status || 'active';
                                const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
                                const toggleActionText = newStatus === 'inactive' ? 'Deactivate' : 'Activate';
                                const toggleActionIcon = newStatus === 'inactive' ? 'user-x' : 'user-check';
                                actionMenuItems.push(`<div class="action-menu-item" data-action="toggle-staff-status" data-id="${member.id}" data-new-status="${newStatus}"><i data-lucide="${toggleActionIcon}" class="w-4 h-4"></i><span>${toggleActionText} Account</span></div>`);

                                actionMenuItems.push('<div class="h-px bg-border-color my-1"></div>');
                                actionMenuItems.push(`<div class="action-menu-item danger" data-action="delete-staff" data-id="${member.id}"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Delete Staff</span></div>`);
                            }
                             
                             // Manager-specific request actions for cashiers
                            if (loggedInRole === 'manager' && member.role === 'cashier') {
                                if(canEditCashier) {
                                    actionMenuItems.push(`<div class="action-menu-item" data-action="edit-staff" data-id="${member.id}"><i data-lucide="edit" class="w-4 h-4"></i><span>Edit Name</span></div>`);
                                }
                                if (canRequestDeactivation && (member.status || 'active') === 'active') {
                                    actionMenuItems.push(`<div class="action-menu-item danger" data-action="request-deactivation" data-id="${member.id}"><i data-lucide="user-x" class="w-4 h-4"></i><span>Request Deactivation</span></div>`);
                                }
                            }
                        }


                        return `
                        <tr class="table-row" data-action="view-staff-details" data-id="${member.id}">
                            <td>
                                <div class="flex items-center gap-3">
                                    <img src="https://placehold.co/40x40/1f2937/4b5563?text=${member.name.charAt(0).toUpperCase()}" class="w-10 h-10 rounded-full" alt="${member.name}">
                                    <div>
                                        <p class="font-medium text-text-primary">${member.name}</p>
                                        <p class="text-xs text-text-secondary">${member.email}</p>
                                    </div>
                                </div>
                            </td>
                            <td><span class="font-medium capitalize">${member.role}</span></td>
                            <td><span class="${getStatusBadge(member.status || 'active')} capitalize">${(member.status || 'active').replace('_', ' ')}</span></td>
                            <td>${member.joinDate ? new Date(member.joinDate).toLocaleDateString() : 'N/A'}</td>
                            <td class="font-mono">${currencyUtils.format(totalSales)}</td>
                            <td class="text-right">
                                ${actionMenuItems.length > 0 ? `
                                <div class="relative inline-block text-left">
                                    <button data-action="toggle-action-menu" data-id="${member.id}" class="p-2 rounded-md hover:bg-bg-tertiary focus:outline-none focus:ring-2 focus:ring-accent">
                                        <i data-lucide="more-vertical" class="w-5 h-5 pointer-events-none"></i>
                                    </button>
                                    <div class="action-menu">
                                        ${actionMenuItems.join('')}
                                    </div>
                                </div>
                                ` : '<span class="text-xs text-text-secondary">No actions</span>'}
                            </td>
                        </tr>
                    `;}).join('') : `<tr><td colspan="6" class="text-center p-8 text-text-secondary" style="grid-column: 1 / -1;">No staff members found matching your criteria.</td></tr>`;
                    
                    renderPaginationControls(container.querySelector('#staff-pagination'), totalItems, viewState.currentPage, appState.itemsPerPage, 'staff'); // NEW
                    lucide.createIcons();
                };

                // --- NEW: Add event listeners ---
                container.querySelector('#staff-search').addEventListener('input', (e) => {
                    viewState.searchQuery = e.target.value;
                    viewState.currentPage = 1;
                    renderStaffTable();
                });
                container.querySelector('#staff-role-filter').addEventListener('change', (e) => {
                    viewState.filters.role = e.target.value;
                    viewState.currentPage = 1;
                    renderStaffTable();
                });
                container.querySelector('#staff-status-filter').addEventListener('change', (e) => {
                    viewState.filters.status = e.target.value;
                    viewState.currentPage = 1;
                    renderStaffTable();
                });
                // --- END NEW ---


                renderStaffTable();
            }

            // NEW FUNCTION for Staff Details View
            function renderStaffDetailView(staffId, container) {
                const member = firestoreData.staff.find(m => m.id === staffId);
                if (!member) { 
                    container.innerHTML = `<p>Staff member not found.</p>`; 
                    return; 
                }

                // --- Performance Calculation ---
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const relevantInvoices = firestoreData.invoices.filter(inv => inv.cashierId === staffId && new Date(inv.date) >= thirtyDaysAgo && inv.status !== 'Void');

                const totalSales = relevantInvoices.reduce((sum, inv) => sum + inv.totalInBaseCurrency, 0);
                const transactionCount = relevantInvoices.length;
                const avgSaleValue = transactionCount > 0 ? totalSales / transactionCount : 0;
                const itemsSold = relevantInvoices.flatMap(inv => inv.items).reduce((sum, item) => sum + (item.qty || 1), 0);
                
                const salesByDay = relevantInvoices.reduce((acc, inv) => {
                    const day = new Date(inv.date).toLocaleDateString([], { month: 'short', day: 'numeric' });
                    acc[day] = (acc[day] || 0) + inv.totalInBaseCurrency;
                    return acc;
                }, {});
                const recentTransactions = relevantInvoices.sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

                const getStatusInfo = (status) => {
                    const s = status || 'active';
                    const statuses = {
                        active: { text: 'Active', icon: 'check-circle', color: 'green' },
                        inactive: { text: 'Inactive', icon: 'x-circle', color: 'gray' },
                        pending: { text: 'Pending Approval', icon: 'clock', color: 'yellow' },
                        deactivation_pending: { text: 'Deactivation Pending', icon: 'alert-circle', color: 'orange' }
                    };
                    return statuses[s] || statuses.inactive;
                };
                const statusInfo = getStatusInfo(member.status);
                
                const canEdit = (checkPermission('canManageStaff') && member.role !== 'admin') || (checkPermission('canEditCashierDetails') && member.role === 'cashier');
                
                container.innerHTML = `
                <div class="view-pane">
                    <!-- Header -->
                    <div class="flex justify-between items-center mb-6">
                         <button data-action="back-to-staff-list" class="btn btn-secondary"><i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Back to Staff List</button>
                         ${canEdit ? `<button data-action="edit-staff" data-id="${staffId}" class="btn btn-primary"><i data-lucide="edit" class="w-4 h-4 mr-2"></i>Edit Profile</button>` : ''}
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Column: Profile -->
                        <div class="lg:col-span-1 space-y-6">
                            <div class="glass-pane p-6 rounded-xl text-center">
                                <img src="https://placehold.co/128x128/1f2937/4b5563?text=${member.name.charAt(0).toUpperCase()}" class="w-32 h-32 rounded-full mx-auto ring-4 ring-bg-secondary shadow-lg">
                                <h2 class="text-2xl font-bold text-text-primary mt-4">${member.name}</h2>
                                <p class="text-accent font-semibold capitalize">${member.role}</p>
                                <div class="mt-2 inline-flex items-center gap-2 px-3 py-1 text-xs font-medium rounded-full bg-${statusInfo.color}-500/10 text-${statusInfo.color}-400">
                                    <i data-lucide="${statusInfo.icon}" class="w-3 h-3"></i>
                                    <span>${statusInfo.text}</span>
                                </div>
                            </div>
                            <div class="glass-pane p-6 rounded-xl">
                                <h3 class="text-lg font-semibold text-text-primary mb-3">Contact Information</h3>
                                <div class="space-y-3 text-sm">
                                    <div class="flex items-start gap-3"><i data-lucide="mail" class="w-4 h-4 text-text-secondary mt-0.5 shrink-0"></i><div><p class="text-text-secondary -mb-1">Email</p><p class="text-text-primary font-medium break-all">${member.email}</p></div></div>
                                    <div class="flex items-start gap-3"><i data-lucide="phone" class="w-4 h-4 text-text-secondary mt-0.5 shrink-0"></i><div><p class="text-text-secondary -mb-1">Phone</p><p class="text-text-primary font-medium">${member.phone || 'Not provided'}</p></div></div>
                                    <div class="flex items-start gap-3"><i data-lucide="map-pin" class="w-4 h-4 text-text-secondary mt-0.5 shrink-0"></i><div><p class="text-text-secondary -mb-1">Address</p><p class="text-text-primary font-medium">${member.address || 'Not provided'}</p></div></div>
                                </div>
                            </div>
                             <div class="glass-pane p-6 rounded-xl">
                                <h3 class="text-lg font-semibold text-text-primary mb-3">Personal Information</h3>
                                <div class="space-y-3 text-sm">
                                    <div class="flex items-start gap-3"><i data-lucide="calendar" class="w-4 h-4 text-text-secondary mt-0.5 shrink-0"></i><div><p class="text-text-secondary -mb-1">Joined On</p><p class="text-text-primary font-medium">${new Date(member.joinDate).toLocaleDateString()}</p></div></div>
                                    <div class="flex items-start gap-3"><i data-lucide="cake" class="w-4 h-4 text-text-secondary mt-0.5 shrink-0"></i><div><p class="text-text-secondary -mb-1">Date of Birth</p><p class="text-text-primary font-medium">${member.dob ? new Date(member.dob).toLocaleDateString() : 'Not provided'}</p></div></div>
                                    <div class="flex items-start gap-3"><i data-lucide="shield" class="w-4 h-4 text-text-secondary mt-0.5 shrink-0"></i><div><p class="text-text-secondary -mb-1">Emergency Contact</p><p class="text-text-primary font-medium">${member.emergencyContactName || 'Not set'}</p><p class="text-xs text-text-secondary">${member.emergencyContactPhone || ''}</p></div></div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Performance -->
                        <div class="lg:col-span-2 space-y-6">
                            <div class="glass-pane p-6 rounded-xl">
                                <h3 class="text-lg font-semibold text-text-primary mb-3">Performance (Last 30 Days)</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                    <div class="bg-bg-tertiary p-4 rounded-lg"><p class="text-xs text-text-secondary uppercase">Total Sales</p><p class="text-xl font-bold font-mono">${currencyUtils.format(totalSales)}</p></div>
                                    <div class="bg-bg-tertiary p-4 rounded-lg"><p class="text-xs text-text-secondary uppercase">Transactions</p><p class="text-xl font-bold font-mono">${transactionCount}</p></div>
                                    <div class="bg-bg-tertiary p-4 rounded-lg"><p class="text-xs text-text-secondary uppercase">Avg. Sale</p><p class="text-xl font-bold font-mono">${currencyUtils.format(avgSaleValue)}</p></div>
                                    <div class="bg-bg-tertiary p-4 rounded-lg"><p class="text-xs text-text-secondary uppercase">Items Sold</p><p class="text-xl font-bold font-mono">${itemsSold}</p></div>
                                </div>
                            </div>
                            <div class="glass-pane p-6 rounded-xl h-72 flex flex-col">
                                <h3 class="text-lg font-semibold text-text-primary mb-3">Sales Trend (Last 30 Days)</h3>
                                <div class="flex-grow"><canvas id="staff-sales-chart"></canvas></div>
                            </div>
                             <div class="glass-pane p-6 rounded-xl">
                                <h3 class="text-lg font-semibold text-text-primary mb-3">Recent Transactions</h3>
                                <div class="space-y-2">
                                    ${recentTransactions.length ? recentTransactions.map(inv => `
                                    <div class="flex justify-between items-center p-2 bg-bg-tertiary rounded">
                                        <div>
                                            <p class="font-medium text-text-primary text-sm">${inv.customerName}</p>
                                            <p class="text-xs text-text-secondary font-mono">${inv.id}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-semibold font-mono text-text-primary text-sm">${currencyUtils.format(inv.totalInBaseCurrency, inv.currency)}</p>
                                            <p class="text-xs text-text-secondary">${new Date(inv.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                                        </div>
                                    </div>
                                    `).join('') : `<p class="text-sm text-text-secondary text-center p-4">No transactions in the last 30 days.</p>`}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;

                lucide.createIcons();

                const ctx = container.querySelector('#staff-sales-chart')?.getContext('2d');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: Object.keys(salesByDay),
                            datasets: [{
                                label: 'Sales',
                                data: Object.values(salesByDay),
                                borderColor: chartStyles.palettes.gentleOcean[0],
                                backgroundColor: chartStyles.createGradient(ctx, chartStyles.palettes.gentleOcean[0]),
                                tension: 0.3,
                                fill: true,
                                pointRadius: 2,
                                pointHoverRadius: 5,
                                borderWidth: 2,
                            }]
                        },
                        options: commonChartOptions(true, { scales: { x: { ticks: { maxRotation: 0, minRotation: 0 } } } })
                    });
                }
            }

            // NEW FUNCTION: Initialize Expenses View
            function initExpenses(pane) {
                const container = pane.querySelector('#expenses-view-container');
                if (!container) return;

                const viewState = appState.viewStates.expenses;
                const canManage = checkPermission('canManageExpenses');
                const allExpenses = firestoreData.expenses;
                const categories = ['All Categories', ...new Set(allExpenses.map(e => e.category))];

                container.innerHTML = `
                    <div>
                        <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
                            <h1 class="text-3xl font-bold text-text-primary">Expense Tracker</h1>
                            <div class="flex items-center gap-2">
                                ${canManage ? `<button data-action="add-expense" class="btn btn-primary flex-1 md:flex-none"><i data-lucide="plus" class="w-5 h-5 mr-2"></i> Log New Expense</button>` : ''}
                            </div>
                        </div>
                        
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <div class="relative flex-grow">
                                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i>
                                <input type="text" id="expense-search" placeholder="Search by note, category..." class="form-input w-full pl-10" value="${viewState.searchQuery}">
                            </div>
                            <select id="expense-category-filter" class="form-select md:w-48">
                                ${categories.map(c => `<option value="${c}" ${viewState.filters.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                            </select>
                        </div>

                        <div class="bg-bg-secondary/50 rounded-xl">
                            <table class="table-pro">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Category</th>
                                        <th>Amount</th>
                                        <th>Notes</th>
                                        ${canManage ? '<th>Actions</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody id="expenses-table-body"></tbody>
                            </table>
                        </div>
                        <div id="expenses-pagination" class="mt-4"></div>
                    </div>`;

                const renderExpensesTable = () => {
                    let filteredExpenses = allExpenses;
                    if (viewState.searchQuery) {
                        const query = viewState.searchQuery.toLowerCase();
                        filteredExpenses = filteredExpenses.filter(e => 
                            (e.notes || '').toLowerCase().includes(query) || 
                            e.category.toLowerCase().includes(query)
                        );
                    }
                    if (viewState.filters.category !== 'all' && viewState.filters.category !== 'All Categories') {
                        filteredExpenses = filteredExpenses.filter(e => e.category === viewState.filters.category);
                    }
                    
                    filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    const totalItems = filteredExpenses.length;
                    const startIndex = (viewState.currentPage - 1) * appState.itemsPerPage;
                    const endIndex = startIndex + appState.itemsPerPage;
                    const paginatedExpenses = filteredExpenses.slice(startIndex, endIndex);

                    const tableBody = container.querySelector('#expenses-table-body');
                    if (tableBody) {
                        tableBody.innerHTML = paginatedExpenses.length ? paginatedExpenses.map(e => `
                            <tr class="table-row">
                                <td>${new Date(e.date).toLocaleDateString()}</td>
                                <td><span class="px-2 py-1 text-xs font-semibold rounded-full bg-indigo-500/20 text-indigo-300">${e.category}</span></td>
                                <td class="font-mono text-left">${currencyUtils.format(e.amountInBase)}</td>
                                <td class="text-sm text-text-secondary truncate" title="${e.notes || ''}">${e.notes || 'N/A'}</td>
                                ${canManage ? `
                                <td class="text-right">
                                    <div class="relative inline-block text-left">
                                        <button data-action="toggle-action-menu" data-id="${e.id}" class="p-2 rounded-md hover:bg-bg-tertiary">
                                            <i data-lucide="more-vertical" class="w-5 h-5 pointer-events-none"></i>
                                        </button>
                                        <div class="action-menu">
                                            <div class="action-menu-item" data-action="edit-expense" data-id="${e.id}"><i data-lucide="edit" class="w-4 h-4"></i><span>Edit</span></div>
                                            <div class="action-menu-item danger" data-action="delete-expense" data-id="${e.id}"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Delete</span></div>
                                        </div>
                                    </div>
                                </td>
                                ` : ''}
                            </tr>
                        `).join('') : `<tr><td colspan="${canManage ? 5 : 4}" class="text-center p-8 text-text-secondary">No expenses found for this period.</td></tr>`;
                    }
                    
                    renderPaginationControls(container.querySelector('#expenses-pagination'), totalItems, viewState.currentPage, appState.itemsPerPage, 'expenses');
                    lucide.createIcons();
                };

                container.querySelector('#expense-search').addEventListener('input', (e) => {
                    viewState.searchQuery = e.target.value;
                    viewState.currentPage = 1;
                    renderExpensesTable();
                });
                container.querySelector('#expense-category-filter').addEventListener('change', (e) => {
                    viewState.filters.category = e.target.value;
                    viewState.currentPage = 1;
                    renderExpensesTable();
                });

                renderExpensesTable();
                lucide.createIcons();
            }
            function initAttributes(container) {
                if (!container) return;
                
                // State for the new attribute form
                let newAttributeValues = [];

                const renderAttributesList = () => {
                    const listContainer = container.querySelector('#attributes-list-container');
                    const attributes = appState.settings.variantAttributes || {};

                    if (Object.keys(attributes).length === 0) {
                        listContainer.innerHTML = `<div class="glass-pane p-8 rounded-xl text-center text-text-secondary">
                            <i data-lucide="tags" class="w-12 h-12 mx-auto mb-4"></i>
                            <p>No attributes have been created yet.</p>
                            <p class="text-sm">Use the form on the left to create your first attribute.</p>
                        </div>`;
                        lucide.createIcons();
                        return;
                    }

                    listContainer.innerHTML = Object.entries(attributes).map(([attrName, values]) => {
                        const tagsHTML = (values || []).map(val => `
                            <span class="variant-value-tag">
                                ${val}
                                <button type="button" data-action="delete-attribute-value" data-attr-name="${attrName}" data-value="${val}">&times;</button>
                            </span>
                        `).join('');

                        return `
                        <div class="glass-pane p-6 rounded-xl">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-lg font-semibold text-text-primary">${attrName}</h4>
                                <button data-action="delete-attribute" data-attr-name="${attrName}" class="btn btn-danger-secondary btn-sm p-2 h-auto" title="Delete Attribute">
                                    <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                                </button>
                            </div>
                            <div class="variant-value-input-wrapper" onclick="this.querySelector('.variant-value-input').focus()">
                                ${tagsHTML}
                                <input type="text" class="variant-value-input" data-attr-name="${attrName}" placeholder="Add more values and press Enter...">
                            </div>
                        </div>
                        `;
                    }).join('');
                    lucide.createIcons();
                };

                const renderNewAttributeTags = () => {
                    const tagsContainer = container.querySelector('#new-attribute-tags-container');
                    tagsContainer.innerHTML = newAttributeValues.map((val, index) => `
                        <span class="variant-value-tag">
                            ${val}
                            <button type="button" data-action="remove-new-attribute-value" data-index="${index}">&times;</button>
                        </span>
                    `).join('');
                };

                // --- Event Listeners ---
                
                // Add New Attribute Form
                const addAttributeForm = container.querySelector('#add-attribute-form');
                if (addAttributeForm) {
                    addAttributeForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const attrNameInput = container.querySelector('#new-attribute-name');
                        const newAttrName = attrNameInput.value.trim();

                        if (!newAttrName) {
                            showToast('Attribute name cannot be empty.', 'error');
                            return;
                        }
                        
                        const existingAttributes = appState.settings.variantAttributes || {};
                        if (Object.keys(existingAttributes).some(key => key.toLowerCase() === newAttrName.toLowerCase())) {
                            showToast(`Attribute "${newAttrName}" already exists.`, 'error');
                            return;
                        }

                        const newAttributes = { ...existingAttributes, [newAttrName]: newAttributeValues };

                        try {
                            await updateDoc(storeRef, { 'settings.variantAttributes': newAttributes });
                            showToast(`Attribute "${newAttrName}" created successfully.`, 'success');
                            // Reset form
                            attrNameInput.value = '';
                            newAttributeValues = [];
                            renderNewAttributeTags();
                            // The onSnapshot listener on storeRef will update appState and trigger a re-render of the list.
                        } catch (error) {
                            console.error('Error creating attribute:', error);
                            showToast('Failed to create attribute.', 'error');
                        }
                    });
                }

                // Handle tag input for new attribute
                const newAttributeValuesInput = container.querySelector('#new-attribute-values');
                if (newAttributeValuesInput) {
                    newAttributeValuesInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const value = newAttributeValuesInput.value.trim();
                            if (value && !newAttributeValues.includes(value)) {
                                newAttributeValues.push(value);
                                renderNewAttributeTags();
                            }
                            newAttributeValuesInput.value = '';
                        }
                    });
                }

                container.addEventListener('click', (e) => {
                    const removeTagBtn = e.target.closest('[data-action="remove-new-attribute-value"]');
                    if (removeTagBtn) {
                        const index = parseInt(removeTagBtn.dataset.index);
                        newAttributeValues.splice(index, 1);
                        renderNewAttributeTags();
                    }
                });

                // Handle events on the attribute list
                const listContainer = container.querySelector('#attributes-list-container');
                if (listContainer) {
                    listContainer.addEventListener('keydown', async (e) => {
                        if (e.key === 'Enter' && e.target.classList.contains('variant-value-input')) {
                            e.preventDefault();
                            const input = e.target;
                            const attrName = input.dataset.attrName;
                            const newValue = input.value.trim();
                            
                            if (!newValue) return;
                            
                            const existingAttributes = appState.settings.variantAttributes || {};
                            const currentValues = existingAttributes[attrName] || [];

                            if (currentValues.some(v => v.toLowerCase() === newValue.toLowerCase())) {
                                showToast(`Value "${newValue}" already exists for this attribute.`, 'warning');
                                input.value = '';
                                return;
                            }

                            const newAttributes = { ...existingAttributes, [attrName]: [...currentValues, newValue] };
                            
                            try {
                                await updateDoc(storeRef, { 'settings.variantAttributes': newAttributes });
                                input.value = '';
                            } catch (error) {
                                console.error('Error adding attribute value:', error);
                                showToast('Failed to add value.', 'error');
                            }
                        }
                    });

                    listContainer.addEventListener('click', async (e) => {
                        const deleteValueBtn = e.target.closest('[data-action="delete-attribute-value"]');
                        if (deleteValueBtn) {
                            const { attrName, value } = deleteValueBtn.dataset;
                            const existingAttributes = appState.settings.variantAttributes || {};
                            const currentValues = existingAttributes[attrName] || [];
                            const newValues = currentValues.filter(v => v !== value);
                            const newAttributes = { ...existingAttributes, [attrName]: newValues };

                            try {
                                await updateDoc(storeRef, { 'settings.variantAttributes': newAttributes });
                            } catch (error) {
                                console.error('Error deleting attribute value:', error);
                                showToast('Failed to delete value.', 'error');
                            }
                        }

                        const deleteAttributeBtn = e.target.closest('[data-action="delete-attribute"]');
                        if (deleteAttributeBtn) {
                            const attrName = deleteAttributeBtn.dataset.attrName;
                            const modal = showModal(
                                'Delete Attribute',
                                `<p>Are you sure you want to delete the "<strong>${attrName}</strong>" attribute? This will remove it from all products and cannot be undone.</p>`,
                                `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-delete" class="btn btn-danger">Delete</button>`
                            );

                            modal.querySelector('#confirm-delete').addEventListener('click', async () => {
                                const existingAttributes = { ...(appState.settings.variantAttributes || {}) };
                                delete existingAttributes[attrName];
                                
                                try {
                                    await updateDoc(storeRef, { 'settings.variantAttributes': existingAttributes });
                                    showToast(`Attribute "${attrName}" deleted.`, 'success');
                                    closeModal(modal);
                                } catch (error) {
                                    console.error('Error deleting attribute:', error);
                                    showToast('Failed to delete attribute.', 'error');
                                    closeModal(modal);
                                }
                            });
                        }
                    });
                }

                // Initial render
                renderAttributesList();
            }

            function initInvoices(pane) {
                const tableBody = pane.querySelector('#invoices-table-body');
                const viewState = appState.viewStates.invoices;

                // Ensure default filter state exists
                if (!viewState.filters.period) viewState.filters.period = 'all';
                if (!viewState.customRange) viewState.customRange = { start: '', end: ''};
                if (!viewState.specificDate) viewState.specificDate = '';
                if (!viewState.filters.invoiceType) viewState.filters.invoiceType = 'all'; // <-- ADD THIS

                const getStatusBadge = (status) => {
                    const base = "px-3 py-1 text-xs font-semibold rounded-full inline-block";
                    // ... (rest of getStatusBadge function is unchanged)
                    if(status === 'Paid') return `${base} bg-green-500/20 text-green-300`;
                    if(status === 'Due') return `${base} bg-red-500/20 text-red-300`;
                    if(status === 'Partial') return `${base} bg-yellow-500/20 text-yellow-300`;
                    if(status === 'Pending') return `${base} bg-yellow-500/20 text-yellow-300`;
                    if(status === 'Cancelled') return `${base} bg-gray-500/20 text-gray-300`;
                    if(status === 'Void Requested') return `${base} bg-orange-500/20 text-orange-300`;
                    if(status === 'Void') return `${base} bg-red-900/40 text-red-400 border border-red-500/50`;
                    if(status === 'Return') return `${base} bg-blue-500/20 text-blue-300`; // <-- ADD THIS
                    return `${base} bg-gray-500/20 text-gray-300`;
                };

                const renderTable = () => {
                    let filteredInvoices = [...firestoreData.invoices];

                    // 1. Apply Date Filter
                    const now = new Date();
                    let startDate, endDate = new Date(now);
                    endDate.setHours(23, 59, 59, 999);

                    switch(viewState.filters.period) {
                        case 'today': startDate = new Date(now.setHours(0,0,0,0)); break;
                        case 'yesterday':
                            startDate = new Date();
                            startDate.setDate(now.getDate() - 1);
                            startDate.setHours(0,0,0,0);
                            endDate = new Date(startDate);
                            endDate.setHours(23,59,59,999);
                            break;
                        case 'week':
                            startDate = new Date(now);
                            startDate.setDate(now.getDate() - now.getDay());
                            startDate.setHours(0,0,0,0);
                            break;
                        case 'month': startDate = new Date(now.getFullYear(), now.getMonth(), 1); break;
                        case 'last30':
                            startDate = new Date();
                            startDate.setDate(now.getDate() - 30);
                            startDate.setHours(0,0,0,0);
                            break;
                        case 'specific_date': // NEW
                            if (viewState.specificDate) {
                                startDate = new Date(viewState.specificDate);
                                startDate.setHours(0, 0, 0, 0);
                                endDate = new Date(viewState.specificDate);
                                endDate.setHours(23, 59, 59, 999);
                            } else {
                                startDate = null;
                            }
                            break;
                        case 'custom':
                            if (viewState.customRange.start && viewState.customRange.end) {
                                startDate = new Date(viewState.customRange.start);
                                startDate.setHours(0,0,0,0);
                                endDate = new Date(viewState.customRange.end);
                                endDate.setHours(23,59,59,999);
                            } else { startDate = null; }
                            break;
                        default: startDate = null; break;
                    }

                    if (startDate) {
                        filteredInvoices = filteredInvoices.filter(inv => {
                            const invDate = new Date(inv.date);
                            return invDate >= startDate && invDate <= endDate;
                        });
                    }
                    
                    // 2. Apply Search Filter
                    if (viewState.searchQuery) {
                        const query = viewState.searchQuery.toLowerCase();
                        filteredInvoices = filteredInvoices.filter(i => 
                            i.id.toLowerCase().includes(query) ||
                            i.customerName.toLowerCase().includes(query)
                        );
                    }

                    // 3. Apply Status Filter
                    if (viewState.filters.status !== 'all') {
                        filteredInvoices = filteredInvoices.filter(i => i.status === viewState.filters.status);
                    }
                    // 4. NEW: Apply Type Filter
                    if (viewState.filters.invoiceType !== 'all') {
                        if (viewState.filters.invoiceType === 'sales') {
                            filteredInvoices = filteredInvoices.filter(i => (i.invoiceType || 'sale') === 'sale');
                        } else if (viewState.filters.invoiceType === 'returns') {
                            filteredInvoices = filteredInvoices.filter(i => i.invoiceType === 'return');
                        }
                    }
                    filteredInvoices.sort((a,b) => new Date(b.date) - new Date(a.date));

                    // Apply pagination
                    const totalItems = filteredInvoices.length;
                    const startIndex = (viewState.currentPage - 1) * appState.itemsPerPage;
                    const endIndex = startIndex + appState.itemsPerPage;
                    const paginatedInvoices = filteredInvoices.slice(startIndex, endIndex);

                    // Inject controls if not present
                    if (!pane.querySelector('#invoice-controls-container')) {
                        const header = pane.querySelector('.flex.justify-between.items-center.mb-6');
                        const periodOptions = [
                            { period: 'all', label: 'All Time' }, { period: 'today', label: 'Today' },
                            { period: 'yesterday', label: 'Yesterday' }, { period: 'week', label: 'This Week' },
                            { period: 'month', label: 'This Month' }, { period: 'last30', label: 'Last 30 Days' },
                        ];
                        let currentPeriodLabel = periodOptions.find(p => p.period === viewState.filters.period)?.label;
                        if (viewState.filters.period === 'custom') currentPeriodLabel = 'Custom Range';
                        if (viewState.filters.period === 'specific_date') currentPeriodLabel = 'Specific Date';
                        if (!currentPeriodLabel) currentPeriodLabel = 'All Time';
                        
                        const periodDropdownHTML = periodOptions.map(p => `<div class="action-menu-item" data-action="set-invoice-period" data-period="${p.period}" data-label="${p.label}">${p.label}</div>`).join('');

                header.insertAdjacentHTML('afterend', `
                    <div id="invoice-controls-container" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4"> <!-- UPDATED to 4 cols -->
                        <div class="relative flex-grow md:col-span-1">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i>
                            <input type="text" id="invoice-search" placeholder="Search by ID or Customer..." class="form-input w-full pl-10" value="${viewState.searchQuery}">
                        </div>
                        <div class="relative" id="invoice-period-dropdown-container">
                            <button id="invoice-period-dropdown-btn" class="btn btn-secondary w-full flex justify-between items-center text-sm p-2.5">
                                <span id="selected-invoice-period-label">${currentPeriodLabel}</span>
                                <i data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                            </button>
                            <div id="invoice-period-dropdown-menu" class="action-menu !w-full z-20">
                                ${periodDropdownHTML}
                                <div class="h-px bg-border-color my-1"></div>
                                <div class="action-menu-item" data-action="set-invoice-period" data-period="specific_date" data-label="Specific Date">
                                    <span>Specific Date...</span><i data-lucide="calendar-day" class="w-4 h-4 ml-auto"></i>
                                </div>
                                <div class="action-menu-item" data-action="set-invoice-period" data-period="custom" data-label="Custom Range">
                                    <span>Custom Range...</span><i data-lucide="calendar-range" class="w-4 h-4 ml-auto"></i>
                                </div>
                            </div>
                        </div>
                        <!-- NEW "Type" FILTER -->
                        <select id="invoice-type-filter" class="form-select">
                            <option value="all">All Types</option>
                            <option value="sales" ${viewState.filters.invoiceType === 'sales' ? 'selected' : ''}>Sales</option>
                            <option value="returns" ${viewState.filters.invoiceType === 'returns' ? 'selected' : ''}>Returns</option>
                        </select>
                        <select id="invoice-status-filter" class="form-select">
                            <option value="all">All Statuses</option>
                            <option value="Paid" ${viewState.filters.status === 'Paid' ? 'selected' : ''}>Paid</option>
                            <option value="Partial" ${viewState.filters.status === 'Partial' ? 'selected' : ''}>Partial</option>
                            <option value="Due" ${viewState.filters.status === 'Due' ? 'selected' : ''}>Due</option>
                            <option value="Pending" ${viewState.filters.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Void Requested" ${viewState.filters.status === 'Void Requested' ? 'selected' : ''}>Void Requested</option>
                            <option value="Void" ${viewState.filters.status === 'Void' ? 'selected' : ''}>Void</option> 
                            <option value="Return" ${viewState.filters.status === 'Return' ? 'selected' : ''}>Return</option> 
                            <option value="Cancelled" ${viewState.filters.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </div>
                    <!-- Date pickers are unchanged -->
                    <div id="invoice-specific-date-picker" class="hidden flex items-center justify-end gap-2 bg-bg-secondary p-3 rounded-lg border border-border-color mb-4">
                        <label for="invoice-specific-date" class="text-sm">Select Date:</label>
                        <input type="date" id="invoice-specific-date" class="form-input text-sm p-2 h-auto bg-bg-tertiary" value="${viewState.specificDate}">
                    </div>
                    <div id="invoice-custom-range" class="hidden flex items-center justify-end gap-2 bg-bg-secondary p-3 rounded-lg border border-border-color mb-4">
                        <label for="invoice-start-date" class="text-sm">From:</label>
                        <input type="date" id="invoice-start-date" class="form-input text-sm p-2 h-auto bg-bg-tertiary" value="${viewState.customRange.start}">
                        <label for="invoice-end-date" class="text-sm">To:</label>
                        <input type="date" id="invoice-end-date" class="form-input text-sm p-2 h-auto bg-bg-tertiary" value="${viewState.customRange.end}">
                        <button id="invoice-apply-range" class="btn btn-primary text-sm py-2">Apply</button>
                    </div>
                `);
                        lucide.createIcons();
                        // Search listener
                        pane.querySelector('#invoice-search').addEventListener('input', e => {
                            viewState.searchQuery = e.target.value;
                            viewState.currentPage = 1;
                            renderTable();
                        });
                        // Status filter listener
                        pane.querySelector('#invoice-status-filter').addEventListener('change', e => {
                            viewState.filters.status = e.target.value;
                            viewState.currentPage = 1;
                            renderTable();
                        });
                       pane.querySelector('#invoice-type-filter').addEventListener('change', e => {
                            viewState.filters.invoiceType = e.target.value;
                            viewState.currentPage = 1;
                            renderTable();
                        });
                        // Period dropdown listener
                        const dropdownBtn = pane.querySelector('#invoice-period-dropdown-btn');
                        const dropdownMenu = pane.querySelector('#invoice-period-dropdown-menu');
                        dropdownBtn.addEventListener('click', e => {
                            e.stopPropagation();
                            dropdownMenu.classList.toggle('open');
                        });
                        // Period item listener
                        pane.querySelectorAll('[data-action="set-invoice-period"]').forEach(item => {
                            item.addEventListener('click', e => {
                                const period = e.currentTarget.dataset.period;
                                viewState.currentPage = 1;
                                dropdownMenu.classList.remove('open');
                                
                                pane.querySelector('#invoice-custom-range').classList.add('hidden');
                                pane.querySelector('#invoice-specific-date-picker').classList.add('hidden');

                                if (period === 'custom') {
                                    pane.querySelector('#invoice-custom-range').classList.remove('hidden');
                                } else if (period === 'specific_date') {
                                    pane.querySelector('#invoice-specific-date-picker').classList.remove('hidden');
                                } else {
                                    viewState.filters.period = period;
                                    renderTable();
                                }
                            });
                        });
                        // Specific date listener
                        pane.querySelector('#invoice-specific-date').addEventListener('change', e => {
                            const date = e.target.value;
                            if (date) {
                                viewState.filters.period = 'specific_date';
                                viewState.specificDate = date;
                                viewState.currentPage = 1;
                                renderTable();
                            }
                        });
                        // Custom range apply button
                        pane.querySelector('#invoice-apply-range').addEventListener('click', () => {
                            const start = pane.querySelector('#invoice-start-date').value;
                            const end = pane.querySelector('#invoice-end-date').value;
                            if (start && end) {
                                viewState.filters.period = 'custom';
                                viewState.customRange = { start, end };
                                viewState.currentPage = 1;
                                renderTable();
                                pane.querySelector('#invoice-custom-range').classList.add('hidden');
                            } else {
                                showToast('Please select both a start and end date.', 'error');
                            }
                        });
                    }

                    // Update UI state for filters
                    if (pane.querySelector('#selected-invoice-period-label')) {
                        const periodOptions = [ { period: 'all', label: 'All Time' }, { period: 'today', label: 'Today' }, { period: 'yesterday', label: 'Yesterday' }, { period: 'week', label: 'This Week' }, { period: 'month', label: 'This Month' }, { period: 'last30', label: 'Last 30 Days' }];
                        let currentPeriodLabel = periodOptions.find(p => p.period === viewState.filters.period)?.label;
                        if (viewState.filters.period === 'custom') currentPeriodLabel = 'Custom Range';
                        if (viewState.filters.period === 'specific_date') currentPeriodLabel = 'Specific Date';
                        if (!currentPeriodLabel) currentPeriodLabel = 'All Time';
                        pane.querySelector('#selected-invoice-period-label').textContent = currentPeriodLabel;
                    }
                    if (pane.querySelector('#invoice-custom-range')) {
                        pane.querySelector('#invoice-custom-range').classList.toggle('hidden', viewState.filters.period !== 'custom');
                    }
                    if (pane.querySelector('#invoice-specific-date-picker')) {
                        pane.querySelector('#invoice-specific-date-picker').classList.toggle('hidden', viewState.filters.period !== 'specific_date');
                    }
                    
                   tableBody.innerHTML = paginatedInvoices.length ? paginatedInvoices.map(i => {
                        // --- REFACTORED: VOID ACTION LOGIC ---
                        const canRequest = checkPermission('canRequestInvoiceVoid');
                        const canApprove = checkPermission('canApproveInvoiceVoid');
                        const canCancelRequest = checkPermission('canCancelVoidRequest');
                        const canManagerVoid = checkPermission('canDirectlyVoidInvoice');
                        const canAdminVoid = checkPermission('canDoEverything'); // Admin's master key
                        const isVoidableStatus = ['Paid', 'Partial', 'Due'].includes(i.status);
                        const isTooOld = new Date(i.date) < new Date(Date.now() - (appState.settings.voidLockoutDays || 30) * 86400000);
                        const currentUserId = appState.session.currentUser.uid;
                        
                        let voidActionItems = [];

                        if (!isTooOld) {
                             // 1. Direct Void action (Admin & Manager)
                            if ((canAdminVoid || canManagerVoid) && isVoidableStatus) {
                                voidActionItems.push(`<div class="action-menu-item danger" data-action="void-invoice" data-id="${i.id}"><i data-lucide="shield-x" class="w-4 h-4"></i><span>Void Invoice</span></div>`);
                            }
                            
                            // 2. Review Request action (Admin & Manager)
                            if (canApprove && i.status === 'Void Requested') {
                                voidActionItems.push(`<div class="action-menu-item text-orange-400" data-action="review-void-request" data-id="${i.id}"><i data-lucide="gavel" class="w-4 h-4"></i><span>Review Void Request</span></div>`);
                            }
                            
                            // 3. Request Void action (Cashier)
                            if (canRequest && isVoidableStatus && !canAdminVoid && !canManagerVoid) {
                                voidActionItems.push(`<div class="action-menu-item danger" data-action="request-void" data-id="${i.id}"><i data-lucide="shield-x" class="w-4 h-4"></i><span>Request Void</span></div>`);
                            }
                            
                            // 4. Cancel Void Request action (Cashier who made the request)
                            if (canCancelRequest && i.status === 'Void Requested' && i.voidDetails?.requestedBy === currentUserId) {
                                voidActionItems.push(`<div class="action-menu-item" data-action="cancel-void-request" data-id="${i.id}"><i data-lucide="rotate-ccw" class="w-4 h-4"></i><span>Cancel Void Request</span></div>`);
                            }
                        }
                        const voidActionItem = voidActionItems.join('');
                        // --- END REFACTORED ---
                         // --- NEW Return Action ---
                         const canReturn = checkPermission('canProcessReturns');
                         const isReturnable = (i.invoiceType || 'sale') === 'sale' && i.status !== 'Void' && i.status !== 'Cancelled';
                         let returnActionItem = '';
                         if (canReturn && isReturnable) {
                             returnActionItem = `<div class="h-px bg-border-color my-1"></div><div class="action-menu-item" data-action="initiate-return" data-id="${i.id}"><i data-lucide="undo-2" class="w-4 h-4 text-blue-400"></i><span>Process Return</span></div>`;
                         }
        
                         const isAdmin = appState.session.userRole === 'admin';
                         const isReturn = i.invoiceType === 'return';
                         const totalColor = isReturn ? 'text-blue-400' : '';
                return `
                    <tr class="table-row">
                        <td class="font-mono text-xs">${i.id} ${isReturn ? '<span class="text-blue-400">(Return)</span>' : ''}</td>
                        <td class="font-medium text-text-primary">${i.customerName}</td>
                        <td>${new Date(i.date).toLocaleDateString()}</td>
                        <td class="font-mono ${totalColor}">${currencyUtils.format(i.totalInBaseCurrency, i.currency)}</td>
                        <td><span class="${getStatusBadge(isReturn ? 'Return' : i.status)}">${isReturn ? 'Return' : i.status}</span></td>
                        <td class="text-right">
                            <div class="relative inline-block text-left">
                                <button data-action="toggle-action-menu" data-id="${i.id}" class="p-2 rounded-md hover:bg-bg-tertiary focus:outline-none focus:ring-2 focus:ring-accent">
                                    <i data-lucide="more-vertical" class="w-5 h-5 pointer-events-none"></i>
                                </button>
                                <div class="action-menu">
                                    <div class="action-menu-item" data-action="view-invoice" data-id="${i.id}"><i data-lucide="eye" class="w-4 h-4"></i><span>View Details</span></div>
                                    <div class="action-menu-item" data-action="print-invoice" data-id="${i.id}"><i data-lucide="printer" class="w-4 h-4"></i><span>Print</span></div>
                                    ${ voidActionItem ? `<div class="h-px bg-border-color my-1"></div>${voidActionItem}` : ''}
                                    ${ returnActionItem } 
                                    ${ isAdmin ? `
                                    <div class="h-px bg-border-color my-1"></div>
                                    <div class="action-menu-item danger" data-action="delete-invoice" data-id="${i.id}"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Delete Invoice</span></div>
                                    ` : ''}
                                </div>
                            </div>
                        </td>
                    </tr>`
            }).join('') : `<tr><td colspan="6" class="text-center p-8 text-text-secondary" style="grid-column: 1 / -1;">No invoices found.</td></tr>`;
            
            if (!pane.querySelector('#invoices-pagination')) {
                tableBody.parentElement.parentElement.insertAdjacentHTML('afterend', '<div id="invoices-pagination" class="mt-4"></div>');
            }
            renderPaginationControls(pane.querySelector('#invoices-pagination'), totalItems, viewState.currentPage, appState.itemsPerPage, 'invoices');
            lucide.createIcons();
        };
        renderTable();
    }
function initReports(pane) {
    // --- NEW: Force cashier report type to 'sales' ---
    if (appState.session.userRole === 'cashier') {
        appState.viewStates.reports.reportType = 'sales';
    }
    // --- END NEW ---

    const term = getCurrentProfile().terminology;
    const reportsContainer = pane.querySelector('#reports-container');
    let chartInstances = {};
    const viewState = appState.viewStates.reports;
    if (!viewState.period) viewState.period = 'last30'; // Initialize if not present
    if (!viewState.filters) viewState.filters = {}; // Initialize filters if not present
    if (!viewState.reportType) viewState.reportType = 'sales';

    const colorClasses = {
        blue: { bg: 'bg-blue-500/10', text: 'text-blue-400' },
        green: { bg: 'bg-green-500/10', text: 'text-green-400' },
        yellow: { bg: 'bg-yellow-500/10', text: 'text-yellow-400' },
        indigo: { bg: 'bg-indigo-500/10', text: 'text-indigo-400' },
        red: { bg: 'bg-red-500/10', text: 'text-red-400' },
        purple: { bg: 'bg-purple-500/10', text: 'text-purple-400' }, // NEW
        teal: { bg: 'bg-teal-500/10', text: 'text-teal-400' }, // NEW
    };

    const calculateChange = (current, previous) => {
        if (previous === 0) return current > 0 ? 100 : 0;
        return ((current - previous) / previous) * 100;
    };
    
    const formatChange = (change) => {
        if (change === 0 || !isFinite(change)) return ``;
        const color = change > 0 ? 'text-green-400' : 'text-red-400';
        const icon = change > 0 ? 'trending-up' : 'trending-down';
        return `<span class="flex items-center text-xs font-semibold ${color}"><i data-lucide="${icon}" class="w-4 h-4 mr-1"></i>${Math.abs(change).toFixed(1)}%</span>`;
    };

    const formatAndTruncate = (label, valueToFormat, isCurrency = true) => {
        const fullValue = isCurrency 
            ? currencyUtils.format(valueToFormat, appState.currentCurrency, { minimumFractionDigits: 2, maximumFractionDigits: 2 })
            : valueToFormat.toLocaleString();
        
        if (fullValue.length > 10) { 
            const truncatedValue = fullValue.substring(0, 7) + '...';
            return `<span class="cursor-pointer hover:underline" data-action="show-full-stat" data-full-value="${fullValue}" data-label="${label}">${truncatedValue}</span>`;
        }
        return fullValue;
    };

    const destroyCharts = () => {
        Object.values(chartInstances).forEach(chart => chart.destroy());
        chartInstances = {};
    };

    // --- UPDATED: Function to manage scroll button and fade visibility ---
    const updateScrollButtonsVisibility = () => {
        // Run this in a timeout to allow the DOM to update
        setTimeout(() => {
            const scroller = pane.querySelector('#report-types-scroller');
            const wrapper = pane.querySelector('#report-scroller-wrapper');
            if (!scroller || !wrapper) return;

            const leftButton = pane.querySelector('[data-action="scroll-report-types"][data-direction="-1"]');
            const rightButton = pane.querySelector('[data-action="scroll-report-types"][data-direction="1"]');

            if (!leftButton || !rightButton) return;

            const scrollLeft = scroller.scrollLeft;
            const scrollWidth = scroller.scrollWidth;
            const clientWidth = scroller.clientWidth;
            
            // Handle case where content doesn't overflow
            if (scrollWidth <= clientWidth) {
                leftButton.classList.add('hidden');
                rightButton.classList.add('hidden');
                wrapper.classList.remove('show-fade-left', 'show-fade-right');
                return;
            }

            const maxScrollLeft = scrollWidth - clientWidth;
            const tolerance = 5; // 5px tolerance

            // Check if scroll is at the beginning
            const atStart = scrollLeft < tolerance;
            // Check if scroll is at the end
            const atEnd = scrollLeft > maxScrollLeft - tolerance;

            leftButton.classList.toggle('hidden', atStart);
            rightButton.classList.toggle('hidden', atEnd);
            
            wrapper.classList.toggle('show-fade-left', !atStart);
            wrapper.classList.toggle('show-fade-right', !atEnd);

        }, 50); // A small delay
    };
    // --- END UPDATED ---

    // --- NEW/REFACTORED SECTION START ---

    // NEW: This function renders the content for the "Audit Log" sub-tab
    const renderAuditLogSubReport = (startDate, endDate, contentContainer, paginationContainer) => {
        // Find and clear the summary container for this view
        const summaryContainer = document.getElementById('activity-summary-container');
        if (summaryContainer) {
            summaryContainer.innerHTML = '';
            summaryContainer.classList.add('hidden');
        }

        let auditLogs = firestoreData.auditLog.filter(log => {
            if (!log.timestamp) return false;
            const logDate = new Date(log.timestamp);
            return logDate >= startDate && logDate <= endDate;
        });
        
        // NEW: Filter logs for managers to show only their own logs and cashier logs.
        const currentUserRole = appState.session.userRole;
        const currentUserId = appState.session.currentUser.uid;
        if (currentUserRole === 'manager') {
            const cashierIds = firestoreData.staff.filter(s => s.role === 'cashier').map(s => s.id);
            auditLogs = auditLogs.filter(log => {
                // A manager can see their own logs or logs generated by any cashier.
                return log.user?.id === currentUserId || cashierIds.includes(log.user?.id);
            });
        } else if (currentUserRole === 'cashier') {
            auditLogs = auditLogs.filter(log => log.user?.id === currentUserId);
        }
        
        // If the user can see all reports, apply the dropdown filter.
        // Otherwise (for a cashier), the data is already pre-filtered by the Firestore listener.
        if (checkPermission('canSeeAllReports')) {
            const selectedCashierId = viewState.filters.cashierId;
            if (selectedCashierId && selectedCashierId !== 'all') {
                auditLogs = auditLogs.filter(log => log.user?.id === selectedCashierId);
            }
        }

        // Paginate the table
        const totalItems = auditLogs.length;
        const startIndex = (viewState.currentPage - 1) * appState.itemsPerPage;
        const endIndex = startIndex + appState.itemsPerPage;
        const paginatedLogs = auditLogs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(startIndex, endIndex);

        contentContainer.innerHTML = `
            <div class="overflow-x-auto">
                <table class="table-pro">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>User</th>
                            <th>Action Type</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                    ${paginatedLogs.length ? paginatedLogs.map(log => `
                        <tr class="table-row">
                            <td class="text-xs">
                                <div>${new Date(log.timestamp).toLocaleDateString([], {year: 'numeric', month: '2-digit', day: '2-digit'})}</div>
                                <div class="text-text-secondary/80">${new Date(log.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second: '2-digit', hour12: true})}</div>
                            </td>
                            <td class="text-text-primary font-medium">${log.user?.name || 'System'}</td>
                            <td><span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-500/20 text-blue-300 capitalize">${log.type.replace(/_/g, ' ')}</span></td>
                            <td class="text-sm">${log.details}</td>
                        </tr>
                    `).join('') : `<tr><td colspan="4" class="text-center p-8 text-text-secondary">No audit logs in this period.</td></tr>`}
                    </tbody>
                </table>
            </div>
        `;

        renderPaginationControls(paginationContainer, totalItems, viewState.currentPage, appState.itemsPerPage, 'reports');
    };

    // REFACTORED: This was the old renderVoidedReport function, now adapted to be a sub-report
    const renderVoidedInvoicesSubReport = (startDate, endDate, contentContainer, paginationContainer) => {
         let voidedInvoices = firestoreData.invoices.filter(inv => {
            const voidDate = inv.voidDetails?.approvedAt || inv.voidDetails?.requestedAt;
            const filterDate = voidDate ? new Date(voidDate) : new Date(inv.date);
            return inv.status === 'Void' && filterDate >= startDate && filterDate <= endDate;
        });

        // NEW: Calculate summary metrics
        const totalVoidedCount = voidedInvoices.length;
        const totalVoidedAmountBase = voidedInvoices.reduce((sum, inv) => sum + inv.totalInBaseCurrency, 0);

        // Find and populate the summary container
        const summaryContainer = document.getElementById('activity-summary-container');
        if (summaryContainer) {
            summaryContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="summary-card bg-bg-secondary p-4 rounded-lg border border-border-color flex items-center gap-4">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-red-500/10 shrink-0">
                            <i data-lucide="shield-x" class="w-5 h-5 text-red-400"></i>
                        </div>
                        <div>
                            <p class="text-xs text-text-secondary uppercase font-semibold">Total Voided Invoices</p>
                            <p class="text-2xl font-bold text-text-primary">${totalVoidedCount}</p>
                        </div>
                    </div>
                    <div class="summary-card bg-bg-secondary p-4 rounded-lg border border-border-color flex items-center gap-4">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-red-500/10 shrink-0">
                            <i data-lucide="wallet-cards" class="w-5 h-5 text-red-400"></i>
                        </div>
                        <div>
                            <p class="text-xs text-text-secondary uppercase font-semibold">Total Voided Amount</p>
                            <p class="text-2xl font-bold text-text-primary font-mono">${currencyUtils.format(totalVoidedAmountBase)}</p>
                        </div>
                    </div>
                </div>
            `;
            summaryContainer.classList.remove('hidden');
            lucide.createIcons();
        }

        // If the user can see all reports, apply the dropdown filter.
        // Otherwise (for a cashier), the data is already pre-filtered by the Firestore listener.
        if (checkPermission('canSeeAllReports')) {
            const selectedCashierId = viewState.filters.cashierId;
            if (selectedCashierId && selectedCashierId !== 'all') {
                voidedInvoices = voidedInvoices.filter(inv => inv.cashierId === selectedCashierId);
            }
        }
        
        // Paginate the table
        const totalItems = voidedInvoices.length;
        const startIndex = (viewState.currentPage - 1) * appState.itemsPerPage;
        const endIndex = startIndex + appState.itemsPerPage;
        const paginatedInvoices = voidedInvoices.sort((a,b) => new Date(b.voidDetails?.approvedAt || b.date) - new Date(a.voidDetails?.approvedAt || a.date)).slice(startIndex, endIndex);

        contentContainer.innerHTML = `
            <div class="overflow-x-auto">
                <table class="table-pro">
                    <thead>
                        <tr>
                            <th>Invoice ID</th>
                            <th>Customer</th>
                            <th>Original Date</th>
                            <th>Voided On</th>
                            <th>Voided By</th>
                            <th>Reason</th>
                            <th class="text-right">Original Total</th>
                        </tr>
                    </thead>
                    <tbody>
                    ${paginatedInvoices.length ? paginatedInvoices.map(inv => {
                        const voidDetails = inv.voidDetails || {};
                        const voidedBy = voidDetails.approvedByName || voidDetails.requestedByName || 'N/A';
                        const voidedOn = voidDetails.approvedAt ? new Date(voidDetails.approvedAt).toLocaleDateString() : 'N/A';
                        const reason = voidDetails.reason || voidDetails.requestReason || 'No reason provided';

                        return `
                        <tr class="table-row">
                            <td class="font-mono text-xs">${inv.id}</td>
                            <td class="text-text-primary font-medium">${inv.customerName}</td>
                            <td>${new Date(inv.date).toLocaleDateString()}</td>
                            <td>${voidedOn}</td>
                            <td>${voidedBy}</td>
                            <td class="text-sm">${reason}</td>
                            <td class="font-mono text-right text-red-400">${currencyUtils.format(inv.totalInBaseCurrency)}</td>
                        </tr>`;
                    }).join('') : `<tr><td colspan="7" class="text-center p-8 text-text-secondary">No voided invoices in this period.</td></tr>`}
                    </tbody>
                </table>
            </div>
        `;
        
        renderPaginationControls(paginationContainer, totalItems, viewState.currentPage, appState.itemsPerPage, 'reports');
    };
    
    // NEW: This function renders the main container for the Activity report type
    const renderActivityReport = (startDate, endDate) => {
        destroyCharts();
        if (!viewState.filters.activitySubType) {
            viewState.filters.activitySubType = 'voided_invoices';
        }
        const activitySubType = viewState.filters.activitySubType;

        reportsContainer.innerHTML = `
            <div class="glass-pane p-6 rounded-xl">
                <div class="flex flex-col md:flex-row justify-between md:items-center gap-2 mb-6">
                    <h3 class="text-xl font-semibold text-text-primary">Activity Log</h3>
                    <div class="activity-tabs flex items-center gap-1 bg-bg-secondary p-1 rounded-lg border border-border-color">
                        <button data-action="set-activity-report-type" data-type="voided_invoices" class="activity-tab-btn ${activitySubType === 'voided_invoices' ? 'active' : ''}">
                            <i data-lucide="shield-x" class="w-4 h-4 mr-2"></i>Voided Invoices
                        </button>
                        <button data-action="set-activity-report-type" data-type="audit_log" class="activity-tab-btn ${activitySubType === 'audit_log' ? 'active' : ''}">
                            <i data-lucide="file-text" class="w-4 h-4 mr-2"></i>Audit Log
                        </button>
                        <!-- More buttons can be added here -->
                    </div>
                </div>

                <!-- NEW: Summary KPIs Container -->
                <div id="activity-summary-container"></div>
                
                <div id="activity-report-content"></div>
            </div>
            <div id="reports-pagination" class="mt-4"></div>
            <style>
                .activity-tab-btn { 
                    display: flex; align-items: center; justify-content: center;
                    padding: 6px 14px; 
                    border-radius: 6px; 
                    color: var(--text-secondary); 
                    font-weight: 500;
                    font-size: 14px;
                    transition: all 0.2s ease; 
                    border: 1px solid transparent;
                }
                .activity-tab-btn:hover:not(.active) { 
                    background-color: var(--bg-tertiary);
                    color: var(--text-primary); 
                }
                .activity-tab-btn.active { 
                    color: var(--accent); 
                    background-color: var(--accent-glow);
                    border-color: var(--accent);
                    box-shadow: 0 2px 8px -1px var(--accent-glow);
                }
            </style>
        `;

        const contentContainer = reportsContainer.querySelector('#activity-report-content');
        const paginationContainer = reportsContainer.querySelector('#reports-pagination');

        if (activitySubType === 'voided_invoices') {
            renderVoidedInvoicesSubReport(startDate, endDate, contentContainer, paginationContainer);
        } else if (activitySubType === 'audit_log') {
            renderAuditLogSubReport(startDate, endDate, contentContainer, paginationContainer);
        }
        lucide.createIcons();
    };

    // --- END NEW/REFACTORED SECTION ---
            // --- *** ADVANCED SALES REPORT *** ---
    const renderSalesReport = (startDate, endDate, prevStartDate, prevEndDate) => {
        destroyCharts();
        
        const getSalesMetrics = (start, end) => {
            let invoices = firestoreData.invoices.filter(inv => {
                const invDate = new Date(inv.date);
                return invDate >= start && invDate <= end && inv.status !== 'Void';
            });

            if (checkPermission('canSeeAllReports')) {
                const selectedCashierId = viewState.filters.cashierId;
                if (selectedCashierId && selectedCashierId !== 'all') {
                    invoices = invoices.filter(inv => inv.cashierId === selectedCashierId);
                }
            }

            // --- UPDATED: Gross Revenue includes EMI Interest ---
            const grossRevenue = invoices.reduce((sum, inv) => {
                let val = inv.totalInBaseCurrency;
                // Only add interest from schedule if it's NOT already part of the invoice total (Legacy Support)
                if (inv.isEMI && typeof inv.emiInterest === 'undefined') {
                    const schedule = firestoreData.emiSchedules.find(s => s.invoiceId === inv.id);
                    if (schedule) {
                        val += (schedule.totalInterest || 0);
                    }
                }
                return sum + val;
            }, 0);
            // --- END UPDATED ---
            
            // --- UPDATED: Use new discount fields for accurate calcs ---
            const totalPersistentDiscount = invoices.reduce((sum, inv) => sum + (inv.persistentDiscountDetails?.amount || 0), 0);
            const totalManualDiscount = invoices.reduce((sum, inv) => sum + (inv.manualDiscountInBase || 0), 0);
            const totalDiscounts = totalPersistentDiscount + totalManualDiscount;
            
            // Net Revenue = Gross (Inc. Interest) - Discounts
            const netRevenue = invoices.reduce((sum, inv) => {
                let val = inv.subtotalInBaseCurrency;
                if (inv.isEMI && typeof inv.emiInterest === 'undefined') {
                    const schedule = firestoreData.emiSchedules.find(s => s.invoiceId === inv.id);
                    if (schedule) {
                        val += (schedule.totalInterest || 0);
                    }
                }
                return sum + val;
            }, 0) - totalDiscounts;
            // --- END UPDATED ---

            const grossProfit = invoices.reduce((profit, inv) => {
                const invoiceProfit = inv.items.reduce((itemProfit, item) => {
                    const cost = item.costPrice !== undefined ? item.costPrice : 0;
                    // --- UPDATED: Calculate profit based on *actual* price paid for item ---
                    let itemRevenue = item.price * (item.qty || 1);
                    if (inv.subtotalInBaseCurrency > 0) {
                        const itemProportion = (item.price * (item.qty || 1)) / inv.subtotalInBaseCurrency;
                        itemRevenue -= (inv.persistentDiscountDetails?.amount || 0) * itemProportion;
                        itemRevenue -= (inv.manualDiscountInBase || 0) * itemProportion;
                    }
                    return itemProfit + (itemRevenue - (cost * (item.qty || 1)));
                }, 0);
                // For EMI, Interest is essentially 100% profit on top of the goods
                let interestProfit = inv.emiInterest || 0;
                if (inv.isEMI && typeof inv.emiInterest === 'undefined') {
                    const schedule = firestoreData.emiSchedules.find(s => s.invoiceId === inv.id);
                    if (schedule) interestProfit = schedule.totalInterest || 0;
                }
                return profit + invoiceProfit + interestProfit;
            }, 0);

            // --- NEW: Calculate COGS ---
            const cogs = invoices.reduce((sum, inv) => {
                return sum + inv.items.reduce((itemSum, item) => {
                    return itemSum + ((item.costPrice || 0) * (item.qty || 1));
                }, 0);
            }, 0);
            // --- END NEW ---

            const avgSaleValue = invoices.length > 0 ? grossRevenue / invoices.length : 0;
            const newCustomers = firestoreData.customers.filter(c => {
                const joinDate = new Date(c.joinDate);
                return joinDate >= start && joinDate <= end;
            }).length;

            return { invoices, grossRevenue, grossProfit, avgSaleValue, newCustomers, totalDiscounts, netRevenue, cogs };
        };

        const currentMetrics = getSalesMetrics(startDate, endDate);
        const previousMetrics = getSalesMetrics(prevStartDate, prevEndDate);

        let kpis = [
            { icon: 'trending-up', label: 'Gross Revenue', value: currentMetrics.grossRevenue, isCurrency: true, color: 'blue', change: calculateChange(currentMetrics.grossRevenue, previousMetrics.grossRevenue) },
            { icon: 'tag', label: 'Total Discounts', value: currentMetrics.totalDiscounts, isCurrency: true, color: 'red', change: calculateChange(currentMetrics.totalDiscounts, previousMetrics.totalDiscounts) },
            { icon: 'receipt', label: 'Net Revenue', value: currentMetrics.netRevenue, isCurrency: true, color: 'teal', change: calculateChange(currentMetrics.netRevenue, previousMetrics.netRevenue) },
            { icon: 'wallet', label: 'Gross Profit', value: currentMetrics.grossProfit, isCurrency: true, color: 'green', change: calculateChange(currentMetrics.grossProfit, previousMetrics.grossProfit) },
        ];

        if (!checkPermission('canViewProfitAndLoss')) {
            kpis = kpis.filter(kpi => kpi.label !== 'Gross Profit' && kpi.label !== 'Net Profit');
        }

        // Add 2nd row of KPIs
        kpis.push(
            { icon: 'shopping-cart', label: 'Total Sales', value: currentMetrics.invoices.length, isCurrency: false, color: 'yellow', change: calculateChange(currentMetrics.invoices.length, previousMetrics.invoices.length) },
            { icon: 'scale', label: 'Avg. Sale Value', value: currentMetrics.avgSaleValue, isCurrency: true, color: 'purple', change: calculateChange(currentMetrics.avgSaleValue, previousMetrics.avgSaleValue) },
            { icon: 'users', label: 'New Customers', value: currentMetrics.newCustomers, isCurrency: false, color: 'indigo', change: calculateChange(currentMetrics.newCustomers, previousMetrics.newCustomers) }
        );

        // --- NEW: Add COGS KPI to 2nd row for Admin ---
        if (checkPermission('canViewProfitAndLoss')) {
            kpis.push(
                { icon: 'package', label: 'COGS', value: currentMetrics.cogs, isCurrency: true, color: 'red', change: calculateChange(currentMetrics.cogs, previousMetrics.cogs) }
            );
        }
        // --- END NEW ---

        reportsContainer.innerHTML = `
            <!-- KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                ${kpis.map(kpi => `
                    <div class="kpi-card glass-pane p-5 rounded-xl flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center ${colorClasses[kpi.color].bg} shrink-0">
                            <i data-lucide="${kpi.icon}" class="w-6 h-6 ${colorClasses[kpi.color].text}"></i>
                        </div>
                        <div class="overflow-hidden">
                            <p class="text-sm font-medium text-text-secondary">${kpi.label}</p>
                            <div class="flex items-baseline gap-2">
                                <p class="text-2xl font-bold text-text-primary">${formatAndTruncate(kpi.label, kpi.value, kpi.isCurrency)}</p>
                                ${formatChange(kpi.change)}
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                ${checkPermission('canViewProfitAndLoss') ? `<div class="glass-pane p-6 rounded-xl h-96 flex flex-col"><h3 class="text-xl font-semibold text-text-primary mb-4">Revenue & Profit</h3><div class="flex-grow"><canvas id="sales-trend-chart"></canvas></div></div>` : ''}
                <div class="glass-pane p-6 rounded-xl h-96 flex flex-col"><h3 class="text-xl font-semibold text-text-primary mb-4">Top 5 Selling ${term.product}s</h3><div class="flex-grow"><canvas id="top-products-chart"></canvas></div></div>
                <div class="glass-pane p-6 rounded-xl h-96 flex flex-col"><h3 class="text-xl font-semibold text-text-primary mb-4">Revenue by ${term.category}</h3><div class="flex-grow"><canvas id="category-revenue-chart"></canvas></div></div>
                <div class="glass-pane p-6 rounded-xl h-96 flex flex-col"><h3 class="text-xl font-semibold text-text-primary mb-4">Sales by Hour of Day</h3><div class="flex-grow"><canvas id="sales-hour-chart"></canvas></div></div>
                <!-- NEW CHARTS -->
                <div class="glass-pane p-6 rounded-xl h-96 flex flex-col"><h3 class="text-xl font-semibold text-text-primary mb-4">Sales by Cashier</h3><div class="flex-grow"><canvas id="sales-cashier-chart"></canvas></div></div>
                <div class="glass-pane p-6 rounded-xl h-96 flex flex-col"><h3 class="text-xl font-semibold text-text-primary mb-4">Payment Methods</h3><div class="flex-grow flex items-center justify-center"><canvas id="sales-payment-chart"></canvas></div></div>
            </div>
            <!-- Data Table -->
            <div class="glass-pane p-6 rounded-xl">
                <h3 class="text-xl font-semibold text-text-primary mb-4">All Sales in Period</h3>
                 <div class="overflow-x-auto">
                    <table class="table-pro">
                        <thead><tr><th>Invoice ID</th><th>Customer</th><th>Date</th><th>Items</th><th>Total</th>${checkPermission('canViewProfitAndLoss') ? '<th>Profit</th>' : ''}<th>Status</th></tr></thead>
                        <tbody>
                            <!-- Data will be populated by pagination -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="reports-pagination" class="mt-4"></div>
        `;

        // Sales Trend Chart Data
        let salesLabels, revenueData, profitData, netRevenueData;
        const timeDiffDays = (endDate - startDate) / (1000 * 3600 * 24);
        const chartInvoices = currentMetrics.invoices;

        // Helper to get full invoice value including interest
        const getFullInvoiceValue = (inv) => {
            let val = inv.totalInBaseCurrency;
            if (inv.isEMI && typeof inv.emiInterest === 'undefined') {
                const s = firestoreData.emiSchedules.find(sch => sch.invoiceId === inv.id);
                if (s) val += (s.totalInterest || 0);
            }
            return val;
        };

        // Helper to get net revenue including interest
        const getNetInvoiceValue = (inv) => {
            let val = inv.subtotalInBaseCurrency;
            if (inv.isEMI && typeof inv.emiInterest === 'undefined') {
                const s = firestoreData.emiSchedules.find(sch => sch.invoiceId === inv.id);
                if (s) val += (s.totalInterest || 0);
            }
             const persistentDiscount = inv.persistentDiscountDetails?.amount || 0;
             const manualDiscount = inv.manualDiscountInBase || 0;
             return val - persistentDiscount - manualDiscount;
        };

        // Helper to get profit including interest
        const getInvoiceProfit = (inv) => {
             const persistentDiscount = inv.persistentDiscountDetails?.amount || 0;
             const manualDiscount = inv.manualDiscountInBase || 0;
             
             const baseProfit = inv.items.reduce((itemProfit, item) => {
                const cost = item.costPrice !== undefined ? item.costPrice : 0;
                let itemRevenue = item.price * (item.qty || 1);
                if (inv.subtotalInBaseCurrency > 0) {
                    const itemProportion = (item.price * (item.qty || 1)) / inv.subtotalInBaseCurrency;
                    itemRevenue -= persistentDiscount * itemProportion;
                    itemRevenue -= manualDiscount * itemProportion;
                }
                return itemProfit + (itemRevenue - (cost * (item.qty || 1)));
            }, 0);
            
            let interestProfit = inv.emiInterest || 0;
            if (inv.isEMI && typeof inv.emiInterest === 'undefined') {
                const schedule = firestoreData.emiSchedules.find(s => s.invoiceId === inv.id);
                if (schedule) interestProfit = schedule.totalInterest || 0;
            }
            return baseProfit + interestProfit;
        }


        if (timeDiffDays <= 2) { // Today, Yesterday
            salesLabels = Array.from({ length: 24 }, (_, i) => { const h = i % 12 === 0 ? 12 : i % 12; const ampm = i < 12 ? 'AM' : 'PM'; return `${h} ${ampm}`; });
            revenueData = Array(24).fill(0);
            profitData = Array(24).fill(0);
            netRevenueData = Array(24).fill(0);
            
            chartInvoices.forEach(inv => {
                const hour = new Date(inv.date).getHours();
                revenueData[hour] += getFullInvoiceValue(inv);
                netRevenueData[hour] += getNetInvoiceValue(inv);
                profitData[hour] += getInvoiceProfit(inv);
            });
        } else { // Week, Month, Year, Custom
            const salesByDay = chartInvoices.reduce((acc, inv) => {
                const day = new Date(inv.date).toLocaleDateString([], { month: 'short', day: 'numeric'});
                acc[day] = acc[day] || { revenue: 0, profit: 0, netRevenue: 0 };
                acc[day].revenue += getFullInvoiceValue(inv);
                acc[day].netRevenue += getNetInvoiceValue(inv);
                acc[day].profit += getInvoiceProfit(inv);
                return acc;
            }, {});
            salesLabels = Object.keys(salesByDay);
            revenueData = salesLabels.map(day => salesByDay[day].revenue);
            profitData = salesLabels.map(day => salesByDay[day].profit);
            netRevenueData = salesLabels.map(day => salesByDay[day].netRevenue);
        }
        
        const salesTrendCanvas = document.getElementById('sales-trend-chart');
        if (salesTrendCanvas) {
            const salesTrendCtx = salesTrendCanvas.getContext('2d');
            const trendChartDatasets = [
                { 
                    label: 'Net Revenue', data: netRevenueData, 
                    borderColor: chartStyles.palettes.gentleOcean[0], 
                    backgroundColor: chartStyles.createGradient(salesTrendCtx, chartStyles.palettes.gentleOcean[0]), 
                    tension: 0.4, fill: true, borderWidth: 2.5 
                }
            ];
            if (checkPermission('canViewProfitAndLoss')) {
                trendChartDatasets.push({ 
                    label: 'Profit', data: profitData, 
                    borderColor: chartStyles.palettes.softMeadow[0], 
                    backgroundColor: chartStyles.createGradient(salesTrendCtx, chartStyles.palettes.softMeadow[0]), 
                    tension: 0.4, fill: true, borderWidth: 2.5 
                });
            }
            chartInstances.pnl = new Chart(salesTrendCtx, {
                type: 'line',
                data: { labels: salesLabels, datasets: trendChartDatasets },
                options: commonChartOptions(true, {
                    plugins: { chartGlow: { color: chartStyles.hexToRgba(chartStyles.palettes.gentleOcean[0], 0.2), blur: 15 } }
                })
            });
        }
        
        // Top Products Chart (Remains Product-Based)
        const productSales = {};
        currentMetrics.invoices.forEach(inv => {
            const subtotal = inv.subtotalInBaseCurrency || 0;
            const persistentDiscount = inv.persistentDiscountDetails?.amount || 0;
            const manualDiscount = inv.manualDiscountInBase || 0;
            
            inv.items.forEach(item => {
                const product = firestoreData.products.find(p => p.id === item.id);
                if (product) {
                    let itemRevenue = item.price * (item.qty || 1);
                    if (subtotal > 0) {
                        const itemProportion = itemRevenue / subtotal;
                        itemRevenue -= persistentDiscount * itemProportion;
                        itemRevenue -= manualDiscount * itemProportion;
                    }
                    productSales[product.name] = (productSales[product.name] || 0) + itemRevenue;
                }
            });
        });
        const topProducts = Object.entries(productSales).sort(([,a],[,b]) => b-a).slice(0, 5);
        
        const topProductsCanvas = document.getElementById('top-products-chart');
        if (topProductsCanvas) {
            const topProductsCtx = topProductsCanvas.getContext('2d');
            chartInstances.topProducts = new Chart(topProductsCtx, {
            type: 'bar',
            data: {
                labels: topProducts.map(p => p[0]),
                datasets: [{
                    label: 'Net Revenue',
                    data: topProducts.map(p => p[1]),
                    backgroundColor: topProducts.map((_, i) => chartStyles.palettes.softMeadow[i]),
                    borderColor: topProducts.map((_, i) => chartStyles.hexToRgba(chartStyles.palettes.softMeadow[i], 0.5)),
                    borderWidth: 1, borderRadius: 6,
                    hoverBackgroundColor: chartStyles.palettes.softMeadow.map(c => chartStyles.hexToRgba(c, 0.8))
                }]
            },
            options: commonChartOptions(true, { 
                indexAxis: 'y', 
                plugins: { legend: { display: false }, chartGlow: { color: 'rgba(74, 222, 128, 0.2)', blur: 12, offsetY: 4 } } 
            })
        });
        }
        
        // Revenue by Category
        const categorySales = currentMetrics.invoices.flatMap(inv => inv.items).reduce((acc, item) => {
            const product = firestoreData.products.find(p => p.id === item.id);
            if (product && product.category) {
                acc[product.category] = (acc[product.category] || 0) + item.price * (item.qty || 1);
            }
            return acc;
        }, {});
        const categorySalesCanvas = document.getElementById('category-revenue-chart');
        if (categorySalesCanvas) {
            const categorySalesCtx = categorySalesCanvas.getContext('2d');
            chartInstances.categoryRevenue = new Chart(categorySalesCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(categorySales),
                datasets: [{
                    label: 'Revenue',
                    data: Object.values(categorySales),
                    backgroundColor: chartStyles.palettes.warmStone,
                    borderColor: 'var(--bg-primary)',
                    borderWidth: 3, hoverOffset: 12
                }]
            },
            options: commonChartOptions(true, { plugins: { legend: { position: 'right' } } })
        });
        }


        // Sales by Hour Chart Data
        const hourlySales = Array(24).fill(0);
        currentMetrics.invoices.forEach(inv => {
            const hour = new Date(inv.date).getHours();
            // UPDATED: Use full value including interest
            hourlySales[hour] += getFullInvoiceValue(inv);
        });
        const salesHourCanvas = document.getElementById('sales-hour-chart');
        if(salesHourCanvas) {
            const salesHourCtx = salesHourCanvas.getContext('2d');
            chartInstances.salesHour = new Chart(salesHourCtx, {
            type: 'bar',
            data: {
                labels: Array.from({length: 24}, (_, i) => { const h = i % 12 === 0 ? 12 : i % 12; const ampm = i < 12 ? 'AM' : 'PM'; return `${h} ${ampm}`; }),
                datasets: [{ 
                    label: 'Sales', 
                    data: hourlySales, 
                    backgroundColor: chartStyles.createGradient(salesHourCtx, chartStyles.palettes.warmStone[0]),
                    borderColor: chartStyles.palettes.warmStone[0],
                    borderWidth: 1,
                    hoverBackgroundColor: chartStyles.hexToRgba(chartStyles.palettes.warmStone[0], 0.8),
                    borderRadius: 6
                }]
            },
            options: commonChartOptions(true, { 
                plugins: { legend: { display: false }, chartGlow: { color: chartStyles.hexToRgba(chartStyles.palettes.warmStone[0], 0.25), blur: 12, offsetY: 4 } }, 
                scales: { x: { grid: { display: false } } } 
            })
        });
        }
        
        // --- NEW: Sales by Cashier Chart ---
        const salesByCashier = currentMetrics.invoices.reduce((acc, inv) => {
            const name = inv.cashierName || 'Unknown';
            // UPDATED: Use full value including interest
            acc[name] = (acc[name] || 0) + getFullInvoiceValue(inv);
            return acc;
        }, {});
        const sortedCashiers = Object.entries(salesByCashier).sort(([,a],[,b]) => b-a);
        const salesCashierCanvas = document.getElementById('sales-cashier-chart');
        if (salesCashierCanvas) {
            const salesCashierCtx = salesCashierCanvas.getContext('2d');
            chartInstances.salesCashier = new Chart(salesCashierCtx, {
                type: 'bar',
                data: {
                    labels: sortedCashiers.map(c => c[0]),
                    datasets: [{
                        label: 'Total Sales',
                        data: sortedCashiers.map(c => c[1]),
                        backgroundColor: chartStyles.palettes.mutedSunset,
                        borderColor: chartStyles.palettes.mutedSunset.map(c => chartStyles.hexToRgba(c, 0.5)),
                        borderWidth: 1, borderRadius: 6,
                    }]
                },
                options: commonChartOptions(true, { 
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false } } } 
                })
            });
        }

        // --- UPDATED: Payment Methods Chart (Includes Due/EMI) ---
        const paymentMethodsData = currentMetrics.invoices.reduce((acc, inv) => {
            // 1. Add actual payments made
            (inv.paymentDetails || []).forEach(p => {
                const amount = currencyUtils.convertToBase(p.amount, inv.currency);
                acc[p.method] = (acc[p.method] || 0) + amount;
            });

            // 2. Add Outstanding Due. For EMI, this needs to include the interest.
            // Note: Payment details capture principal-only payments usually on the invoice record for EMI unless we sync interest payments.
            // But `dueAmount` on the invoice tracks principal.
            
            let dueAmt = inv.dueAmount;
            if (inv.isEMI && typeof inv.emiInterest === 'undefined') {
                // To balance the "Gross Revenue" which now includes Interest, we must include remaining Interest in the "Due" slice.
                 const schedule = firestoreData.emiSchedules.find(s => s.invoiceId === inv.id);
                 if (schedule) {
                     dueAmt += (schedule.remainingInterest || 0);
                 }
            }

            if (dueAmt > 0.001) {
                const label = inv.isEMI ? 'EMI (Due)' : 'Credit (Due)';
                acc[label] = (acc[label] || 0) + dueAmt;
            }
            
            return acc;
        }, {});

        const salesPaymentCanvas = document.getElementById('sales-payment-chart');
        if (salesPaymentCanvas && Object.keys(paymentMethodsData).length > 0) {
            const salesPaymentCtx = salesPaymentCanvas.getContext('2d');
            chartInstances.paymentMethods = new Chart(salesPaymentCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(paymentMethodsData),
                    datasets: [{
                        data: Object.values(paymentMethodsData),
                        backgroundColor: [
                            ...chartStyles.palettes.coolSlate,
                            chartStyles.palettes.indigo[2], // Extra colors for new types
                            chartStyles.palettes.yellow[2]
                        ],
                        borderColor: 'var(--bg-primary)',
                        borderWidth: 3, hoverOffset: 8,
                    }]
                },
                options: commonChartOptions(true, { plugins: { legend: { position: 'right' } } })
            });
        } else if (salesPaymentCanvas) {
            const ctx = salesPaymentCanvas.getContext('2d');
            ctx.fillStyle = '#6b7280';
            ctx.textAlign = 'center';
            ctx.font = '14px ' + chartStyles.fontFamily;
            ctx.fillText('No payment data for this period.', ctx.canvas.width / 2, ctx.canvas.height / 2);
        }

        
        // Paginate the table
        const totalItems = currentMetrics.invoices.length;
        const startIndex = (viewState.currentPage - 1) * appState.itemsPerPage;
        const endIndex = startIndex + appState.itemsPerPage;
        const paginatedInvoices = currentMetrics.invoices.sort((a,b) => new Date(b.date) - new Date(a.date)).slice(startIndex, endIndex);

        reportsContainer.querySelector('tbody').innerHTML = paginatedInvoices.map(inv => {
            // Calculate profit including interest for EMI
            const profit = getInvoiceProfit(inv);
            
            // Get total including interest
            const displayTotal = getFullInvoiceValue(inv);

            // --- UPDATED: Status Badge Logic ---
            let statusBadgeClass = 'bg-gray-500/20 text-gray-300'; // Default
            if (inv.status === 'Paid') statusBadgeClass = 'bg-green-500/20 text-green-300';
            else if (inv.status === 'EMI') statusBadgeClass = 'bg-purple-500/20 text-purple-300';
            else if (inv.status === 'Due' || inv.status === 'Partial') statusBadgeClass = 'bg-yellow-500/20 text-yellow-300';
            else if (inv.status === 'Void') statusBadgeClass = 'bg-red-900/40 text-red-400 border border-red-500/50';
            else if (inv.status === 'Return') statusBadgeClass = 'bg-blue-500/20 text-blue-300';

            return `
            <tr class="table-row">
                <td class="font-mono text-xs">${inv.id}</td>
                <td class="text-text-primary font-medium">${inv.customerName}</td>
                <td>${new Date(inv.date).toLocaleDateString()}</td>
                <td class="text-center">${inv.items.reduce((sum, i) => sum + (i.qty || 1), 0)}</td>
                <td class="font-mono">${currencyUtils.format(displayTotal)}</td>
                ${checkPermission('canViewProfitAndLoss') ? `<td class="font-mono ${profit >= 0 ? 'text-green-400' : 'text-red-400'}">${currencyUtils.format(profit)}</td>` : ''}
                <td><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusBadgeClass}">${inv.status}</span></td>
            </tr>`
        }).join('');
        
        renderPaginationControls(reportsContainer.querySelector('#reports-pagination'), totalItems, viewState.currentPage, appState.itemsPerPage, 'reports');

        lucide.createIcons();
    };
    
    const renderInventoryReport = (startDate, endDate, prevStartDate, prevEndDate) => {
        destroyCharts();
        const physicalProducts = firestoreData.products.filter(p => p.productType === 'physical' && !p.parentSKU);
        
        const getProductStock = (product) => {
            if (product.hasVariants) {
                return firestoreData.products.filter(v => v.parentSKU === product.id).reduce((sum, v) => sum + (v.stock || 0), 0);
            }
            return product.stock || 0;
        };
        
        const productsWithCalculatedStock = physicalProducts.map(p => ({
            ...p,
            calculatedStock: getProductStock(p)
        }));
        
        const getInventoryMetrics = (start, end) => {
            let periodInvoices = firestoreData.invoices.filter(inv => {
                const invDate = new Date(inv.date);
                return invDate >= start && invDate <= end && inv.status !== 'Void';
            });

            // If the user can see all reports, apply the dropdown filter.
            // Otherwise (for a cashier), the data is already pre-filtered by the Firestore listener.
            if (checkPermission('canSeeAllReports')) {
                const selectedCashierId = viewState.filters.cashierId;
                if (selectedCashierId && selectedCashierId !== 'all') {
                    periodInvoices = periodInvoices.filter(inv => inv.cashierId === selectedCashierId);
                }
            }

            const physicalItemsSold = periodInvoices.flatMap(inv => inv.items)
                .filter(item => {
                    const product = firestoreData.products.find(p => p.id === item.id);
                    return product && product.productType === 'physical';
                });

            const unitsSold = physicalItemsSold.reduce((sum, item) => sum + (item.qty || 1), 0);
            const revenueFromInventory = physicalItemsSold.reduce((sum, item) => sum + ((item.qty || 1) * item.price), 0);
            return { unitsSold, revenueFromInventory, invoices: periodInvoices };
        };
        
        const currentMetrics = getInventoryMetrics(startDate, endDate);
        const previousMetrics = getInventoryMetrics(prevStartDate, prevEndDate);

        // Snapshot metrics (don't change with time)
        const totalValue = physicalProducts.reduce((sum, p) => {
            if (p.hasVariants) {
                const variants = firestoreData.products.filter(v => v.parentSKU === p.id);
                return sum + variants.reduce((variantSum, v) => variantSum + ((v.stock || 0) * (v.costPrice || 0)), 0);
            }
            return sum + ((p.stock || 0) * (p.costPrice || 0));
        }, 0);
        const totalSKUs = physicalProducts.length;
        
        let kpis = [
            { icon: 'dollar-sign', label: `Total ${term.inventory} Value`, value: totalValue, isCurrency: true, color: 'blue', change: null },
            { icon: 'boxes', label: `Total SKUs`, value: totalSKUs, isCurrency: false, color: 'indigo', change: null },
            { icon: 'package-check', label: `Units Sold`, value: currentMetrics.unitsSold, isCurrency: false, color: 'green', change: calculateChange(currentMetrics.unitsSold, previousMetrics.unitsSold) },
            { icon: 'trending-up', label: `Revenue from ${term.inventory}`, value: currentMetrics.revenueFromInventory, isCurrency: true, color: 'yellow', change: calculateChange(currentMetrics.revenueFromInventory, previousMetrics.revenueFromInventory) }
        ];

        /* This check was removed to show Total Inventory Value for all roles
        if (!checkPermission('canViewProfitAndLoss')) {
            kpis = kpis.filter(kpi => kpi.label !== `Total ${term.inventory} Value`);
        }
        */

        const stockValueByCategory = physicalProducts.reduce((acc, p) => {
            let value = 0;
            if (p.hasVariants) {
                 const variants = firestoreData.products.filter(v => v.parentSKU === p.id);
                 value = variants.reduce((variantSum, v) => variantSum + ((v.stock || 0) * (v.costPrice || 0)), 0);
            } else {
                value = (p.stock || 0) * (p.costPrice || 0);
            }
            const category = p.category || 'Uncategorized';
            acc[category] = (acc[category] || 0) + value;
            return acc;
        }, {});
        
        // --- NEW: Dead Stock Calculation ---
        const salesInPeriod = currentMetrics.invoices.flatMap(inv => inv.items);
        const soldProductIds = new Set(salesInPeriod.map(item => {
            const product = firestoreData.products.find(p => p.id === item.id);
            return product?.parentSKU || product?.id; // Group variants with parent
        }));
        
        const deadStockProducts = productsWithCalculatedStock.filter(p => 
            p.calculatedStock > 0 && !soldProductIds.has(p.id)
        );

        reportsContainer.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                ${kpis.map(kpi => `
                    <div class="kpi-card glass-pane p-5 rounded-xl flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center ${colorClasses[kpi.color].bg} shrink-0">
                            <i data-lucide="${kpi.icon}" class="w-6 h-6 ${colorClasses[kpi.color].text}"></i>
                        </div>
                        <div class="overflow-hidden">
                            <p class="text-sm font-medium text-text-secondary">${kpi.label}</p>
                            <div class="flex items-baseline gap-2">
                                <p class="text-2xl font-bold text-text-primary">${formatAndTruncate(kpi.label, kpi.value, kpi.isCurrency)}</p>
                                ${kpi.change !== null ? formatChange(kpi.change) : ''}
                            </div>
                        </div>
                    </div>`).join('')}
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
               <div class="glass-pane p-6 rounded-xl h-96 flex flex-col"><h3 class="text-xl font-semibold text-text-primary mb-4">Stock Value by ${term.category} <span class="text-xs font-normal text-text-secondary">(Live)</span></h3><div class="flex-grow"><canvas id="stock-value-chart"></canvas></div></div>
               <div class="glass-pane p-6 rounded-xl h-96 flex flex-col"><h3 class="text-xl font-semibold text-text-primary mb-4">Top 5 Most Stocked ${term.product}s <span class="text-xs font-normal text-text-secondary">(Live)</span></h3><div class="flex-grow"><canvas id="top-stocked-chart"></canvas></div></div>
            </div>
            <!-- NEW: Dead Stock Report -->
            <div class="glass-pane p-6 rounded-xl">
                <h3 class="text-xl font-semibold text-text-primary mb-4">Dead Stock <span class="text-xs font-normal text-text-secondary">(Items with no sales in period)</span></h3>
                <div class="overflow-x-auto max-h-96">
                    <table class="table-pro">
                        <thead><tr><th>SKU</th><th>${term.product}</th><th>${term.category}</th><th>Stock</th><th>Cost Price</th><th>Stock Value</th></tr></thead>
                        <tbody>
                            ${deadStockProducts.length ? deadStockProducts.map(p => {
                                let stockValue = 0;
                                let costPriceHTML = '';
                                if (p.hasVariants) {
                                    const variants = firestoreData.products.filter(v => v.parentSKU === p.id);
                                    stockValue = variants.reduce((sum, v) => sum + ((v.stock || 0) * (v.costPrice || 0)), 0);
                                    costPriceHTML = `<span class="text-xs text-text-secondary">Varies</span>`;
                                } else {
                                    stockValue = (p.stock || 0) * (p.costPrice || 0);
                                    costPriceHTML = `<span class="font-mono">${currencyUtils.format(p.costPrice || 0)}</span>`;
                                }
                                return `
                                <tr class="table-row">
                                    <td class="font-mono text-xs">${p.id}</td>
                                    <td class="text-text-primary font-medium">${p.name}</td>
                                    <td>${p.category || 'N/A'}</td>
                                    <td class="font-mono text-yellow-400">${p.calculatedStock}</td>
                                    <td>${costPriceHTML}</td><td class="font-mono">${currencyUtils.format(stockValue)}</td>
                                </tr>`;
                            }).join('') : `<tr><td colspan="6" class="text-center p-8 text-text-secondary">No dead stock found for this period.</td></tr>`}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="glass-pane p-6 rounded-xl">
                <h3 class="text-xl font-semibold text-text-primary mb-4">Full ${term.inventory} List <span class="text-xs font-normal text-text-secondary">(Live)</span></h3>
                <div class="overflow-x-auto">
                    <table class="table-pro">
                        <thead><tr><th>SKU</th><th>${term.product}</th><th>${term.category}</th><th>Stock</th><th>Cost Price</th><th>Stock Value</th></tr></thead>
                        <tbody id="full-inventory-list-body">
                            ${'' /* This part is overwritten by pagination, so leaving it empty is a safe optimization */}
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="reports-pagination" class="mt-4"></div>
        `;

        // Paginate table
        const totalItems = productsWithCalculatedStock.length;
        const startIndex = (viewState.currentPage - 1) * appState.itemsPerPage;
        const endIndex = startIndex + appState.itemsPerPage;
        
        const paginatedProducts = productsWithCalculatedStock.sort((a,b) => a.calculatedStock - b.calculatedStock).slice(startIndex, endIndex);

        reportsContainer.querySelector('#full-inventory-list-body').innerHTML = paginatedProducts.map(p => {
            let stockHTML, costPriceHTML, stockValue, stockForClass;

            if (p.hasVariants) {
                const variants = firestoreData.products.filter(v => v.parentSKU === p.id);
                stockValue = variants.reduce((sum, v) => sum + ((v.stock || 0) * (v.costPrice || 0)), 0);
                stockForClass = p.calculatedStock;
                stockHTML = `<span class="font-mono">${stockForClass}</span>`;
                costPriceHTML = `<span class="text-xs text-text-secondary">Varies</span>`;
            } else {
                stockForClass = p.stock || 0;
                stockValue = stockForClass * (p.costPrice || 0);
                let stockColor = '';
                if (stockForClass < 20 && stockForClass > 0) stockColor = 'text-yellow-300';
                else if (stockForClass <= 0) stockColor = 'text-red-400';
                stockHTML = `<span class="font-mono ${stockColor}">${stockForClass} ${p.uomId || ''}</span>`;
                costPriceHTML = `<span class="font-mono">${currencyUtils.format(p.costPrice || 0)}</span>`;
            }

            let stockClass = '';
            if (stockForClass <= 0) stockClass = 'bg-red-900/30';
            else if (stockForClass < 20) stockClass = 'bg-yellow-900/30';

            return `<tr class="table-row ${stockClass}">
                <td class="font-mono text-xs">${p.id}</td>
                <td class="text-text-primary font-medium">${p.name}</td>
                <td>${p.category || 'N/A'}</td>
                <td>${stockHTML}</td>
                <td>${costPriceHTML}</td><td class="font-mono">${currencyUtils.format(stockValue)}</td>
            </tr>`
        }).join('');

        renderPaginationControls(reportsContainer.querySelector('#reports-pagination'), totalItems, viewState.currentPage, appState.itemsPerPage, 'reports');

        // if(checkPermission('canViewProfitAndLoss')) { // Removed wrapper to always show chart
            const stockValueCtx = document.getElementById('stock-value-chart').getContext('2d');
            chartInstances.stockValue = new Chart(stockValueCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(stockValueByCategory),
                    datasets: [{ 
                        label: 'Stock Value', 
                        data: Object.values(stockValueByCategory), 
                        backgroundColor: Object.keys(stockValueByCategory).map((_, i) => chartStyles.palettes.coolSlate[i % chartStyles.palettes.coolSlate.length]),
                        borderColor: Object.keys(stockValueByCategory).map((_, i) => chartStyles.hexToRgba(chartStyles.palettes.coolSlate[i % chartStyles.palettes.coolSlate.length], 0.5)),
                        borderWidth: 1,
                        hoverBackgroundColor: chartStyles.palettes.coolSlate.map(c => chartStyles.hexToRgba(c, 0.8)),
                        borderRadius: 6
                    }]
                },
                options: commonChartOptions(true, {
                    plugins: {
                        legend: { display: false },
                        chartGlow: { color: 'rgba(148, 163, 184, 0.2)', blur: 15, offsetY: 5 }
                    }
                })
            });
        // } // Removed wrapper to always show chart

        const topStocked = [...productsWithCalculatedStock].sort((a,b) => b.calculatedStock - a.calculatedStock).slice(0, 5);
        const topStockedCtx = document.getElementById('top-stocked-chart').getContext('2d');
        chartInstances.topStocked = new Chart(topStockedCtx, {
            type: 'doughnut',
            data: {
                labels: topStocked.map(p => p.name),
                datasets: [{ 
                    label: 'Stock Quantity', 
                    data: topStocked.map(p => p.calculatedStock), 
                    backgroundColor: chartStyles.palettes.mutedSunset,
                    borderColor: 'var(--bg-primary)',
                    borderWidth: 3,
                    hoverOffset: 12
                }]
            },
            options: commonChartOptions(false, { plugins: { legend: { position: 'right' } } })
        });
        
        lucide.createIcons();
    };
    
    const renderCustomerReport = (startDate, endDate, prevStartDate, prevEndDate) => {
         destroyCharts();

         const getCustomerMetrics = (start, end) => {
             let periodInvoices = firestoreData.invoices.filter(inv => {
                const invDate = new Date(inv.date);
                return invDate >= start && invDate <= end && inv.status !== 'Void';
             });

            // If the user can see all reports, apply the dropdown filter.
            // Otherwise (for a cashier), the data is already pre-filtered by the Firestore listener.
            if (checkPermission('canSeeAllReports')) {
                const selectedCashierId = viewState.filters.cashierId;
                if (selectedCashierId && selectedCashierId !== 'all') {
                    periodInvoices = periodInvoices.filter(inv => inv.cashierId === selectedCashierId);
                }
            }

             const customerData = firestoreData.customers.map(customer => {
                 const customerInvoices = periodInvoices.filter(inv => inv.customerId === customer.id);
                 const totalSpent = customerInvoices.reduce((sum, inv) => sum + inv.totalInBaseCurrency, 0);
                 return { ...customer, invoiceCount: customerInvoices.length, totalSpent };
             });
             
             const totalSpentAll = customerData.reduce((sum, c) => sum + c.totalSpent, 0);
             const avgSpend = periodInvoices.length > 0 ? totalSpentAll / periodInvoices.filter(inv => inv.customerId).length : 0;
             
             const newCustomers = firestoreData.customers.filter(c => {
                 const joinDate = new Date(c.joinDate);
                 return joinDate >= start && joinDate <= end;
             }).length;
             
             return { customerData, totalSpentAll, avgSpend, newCustomers };
         };

         const currentMetrics = getCustomerMetrics(startDate, endDate);
         const previousMetrics = getCustomerMetrics(prevStartDate, prevEndDate);
         const totalCustomers = firestoreData.customers.length; // Snapshot

         const kpis = [
            { icon: 'users', label: 'Total Customers', value: totalCustomers, isCurrency: false, color: 'green', change: null },
            { icon: 'user-plus', label: `New Customers`, value: currentMetrics.newCustomers, isCurrency: false, color: 'blue', change: calculateChange(currentMetrics.newCustomers, previousMetrics.newCustomers) },
            { icon: 'wallet', label: `Total Spend`, value: currentMetrics.totalSpentAll, isCurrency: true, color: 'indigo', change: calculateChange(currentMetrics.totalSpentAll, previousMetrics.totalSpentAll) },
            { icon: 'receipt', label: `Avg. Spend / Sale`, value: currentMetrics.avgSpend, isCurrency: true, color: 'yellow', change: calculateChange(currentMetrics.avgSpend, previousMetrics.avgSpend) }
         ];

         const topCustomers = [...currentMetrics.customerData].sort((a, b) => b.totalSpent - a.totalSpent).slice(0, 5);
         
         reportsContainer.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                 ${kpis.map(kpi => `
                    <div class="kpi-card glass-pane p-5 rounded-xl flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center ${colorClasses[kpi.color].bg} shrink-0">
                            <i data-lucide="${kpi.icon}" class="w-6 h-6 ${colorClasses[kpi.color].text}"></i>
                        </div>
                        <div class="overflow-hidden">
                            <p class="text-sm font-medium text-text-secondary">${kpi.label}</p>
                            <div class="flex items-baseline gap-2">
                                <p class="text-2xl font-bold text-text-primary">${formatAndTruncate(kpi.label, kpi.value, kpi.isCurrency)}</p>
                                ${kpi.change !== null ? formatChange(kpi.change) : ''}
                            </div>
                        </div>
                    </div>`).join('')}
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-pane p-6 rounded-xl h-96 flex flex-col"><h3 class="text-xl font-semibold text-text-primary mb-4">New vs. Returning Customers</h3><div class="flex-grow"><canvas id="customer-retention-chart"></canvas></div></div>
                <div class="glass-pane p-6 rounded-xl h-96 flex flex-col"><h3 class="text-xl font-semibold text-text-primary mb-4">Top 5 Customers by Spend</h3><div class="flex-grow"><canvas id="top-customers-chart"></canvas></div></div>
            </div>
            <div class="glass-pane p-6 rounded-xl">
                <h3 class="text-xl font-semibold text-text-primary mb-4">Customer List</h3>
                <div class="overflow-x-auto">
                    <table class="table-pro">
                        <thead><tr><th>Customer Name</th><th>Join Date</th><th>Total Invoices</th><th>Total Spent</th><th>Loyalty Points</th></tr></thead>
                        <tbody>
                        ${'' /* Populated by pagination */}
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="reports-pagination" class="mt-4"></div>
         `;

         // Paginate table
         const totalItems = currentMetrics.customerData.length;
        const startIndex = (viewState.currentPage - 1) * appState.itemsPerPage;
        const endIndex = startIndex + appState.itemsPerPage;
        const paginatedCustomers = [...currentMetrics.customerData].sort((a,b) => b.totalSpent - a.totalSpent).slice(startIndex, endIndex);

        reportsContainer.querySelector('tbody').innerHTML = paginatedCustomers.length ? paginatedCustomers.map(c => `
                                    <tr class="table-row">
                                        <td class="text-text-primary font-medium">${c.name}</td>
                                        <td>${new Date(c.joinDate).toLocaleDateString()}</td>
                                        <td class="text-center">${c.invoiceCount}</td>
                                        <td class="font-mono">${currencyUtils.format(c.totalSpent)}</td>
                                        <td class="font-mono">${(c.loyaltyPoints || 0).toLocaleString()}</td>
                                    </tr>`).join('') : `<tr><td colspan="5" class="text-center p-8 text-text-secondary">No customer data for this period.</td></tr>`;

        renderPaginationControls(reportsContainer.querySelector('#reports-pagination'), totalItems, viewState.currentPage, appState.itemsPerPage, 'reports');

        // --- NEW: New vs. Returning Customer Chart ---
        const periodInvoicesForChart = firestoreData.invoices.filter(inv => {
            const invDate = new Date(inv.date);
            return invDate >= startDate && invDate <= endDate && inv.status !== 'Void' && inv.customerId;
        });
        const uniqueCustomerIdsInPeriod = [...new Set(periodInvoicesForChart.map(inv => inv.customerId))];

        let newCustomerCount = 0;
        let returningCustomerCount = 0;
        uniqueCustomerIdsInPeriod.forEach(customerId => {
            const customer = firestoreData.customers.find(c => c.id === customerId);
            if (customer) {
                const joinDate = new Date(customer.joinDate);
                if (joinDate >= startDate && joinDate <= endDate) {
                    newCustomerCount++;
                } else {
                    returningCustomerCount++;
                }
            }
        });

        const retentionCtx = document.getElementById('customer-retention-chart')?.getContext('2d');
        if (retentionCtx) {
            chartInstances.retention = new Chart(retentionCtx, {
                type: 'doughnut',
                data: {
                    labels: [`New (${newCustomerCount})`, `Returning (${returningCustomerCount})`],
                    datasets: [{
                        label: 'Customers',
                        data: [newCustomerCount, returningCustomerCount],
                        backgroundColor: [
                            chartStyles.palettes.gentleOcean[1],
                            chartStyles.palettes.softMeadow[1]
                        ],
                        borderColor: 'var(--bg-primary)',
                        borderWidth: 4,
                        hoverOffset: 8
                    }]
                },
                options: commonChartOptions(false, {
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 20
                            }
                        }
                    }
                })
            });
        }
        // --- END NEW ---

        // Top Customers by Spend Chart
        const topCustomersCtx = document.getElementById('top-customers-chart')?.getContext('2d');
        if (topCustomersCtx) {
             chartInstances.topCustomers = new Chart(topCustomersCtx, {
                type: 'bar',
                data: {
                    labels: topCustomers.map(c => c.name),
                    datasets: [{
                        label: 'Total Spend',
                        data: topCustomers.map(c => c.totalSpent),
                        backgroundColor: chartStyles.palettes.warmStone,
                        borderColor: chartStyles.palettes.warmStone.map(c => chartStyles.hexToRgba(c, 0.5)),
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: commonChartOptions(true, {
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false } }, y: { grid: { color: 'rgba(255,255,255,0.05)' } } }
                })
            });
        }

         lucide.createIcons();
    };

    // --- *** NEW EXPENSE REPORT *** ---
    const renderExpenseReport = (startDate, endDate, prevStartDate, prevEndDate) => {
        destroyCharts();

        const getExpenseMetrics = (start, end) => {
            let expenses = firestoreData.expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return expenseDate >= start && expenseDate <= end;
            });

            if (checkPermission('canSeeAllReports')) {
                const selectedCashierId = viewState.filters.cashierId;
                if (selectedCashierId && selectedCashierId !== 'all') {
                    expenses = expenses.filter(e => e.recordedBy?.id === selectedCashierId);
                }
            } else if (appState.session.userRole === 'manager') {
                // For managers without 'canSeeAllReports', filter to their own expenses
                expenses = expenses.filter(e => e.recordedBy?.id === appState.session.currentUser.uid);
            } else if (appState.session.userRole === 'cashier') {
                expenses = expenses.filter(e => e.recordedBy?.id === appState.session.currentUser.uid);
            }

            const totalExpenses = expenses.reduce((sum, e) => sum + e.amountInBase, 0);
            const expenseCount = expenses.length;
            const avgExpense = expenseCount > 0 ? totalExpenses / expenseCount : 0;
            return { expenses, totalExpenses, expenseCount, avgExpense };
        };

        const currentMetrics = getExpenseMetrics(startDate, endDate);
        const previousMetrics = getExpenseMetrics(prevStartDate, prevEndDate);

        const kpis = [
            { icon: 'dollar-sign', label: 'Total Expenses', value: currentMetrics.totalExpenses, isCurrency: true, color: 'red', change: calculateChange(currentMetrics.totalExpenses, previousMetrics.totalExpenses) },
            { icon: 'hash', label: '# of Expenses', value: currentMetrics.expenseCount, isCurrency: false, color: 'yellow', change: calculateChange(currentMetrics.expenseCount, previousMetrics.expenseCount) },
            { icon: 'scale', label: 'Avg. Expense', value: currentMetrics.avgExpense, isCurrency: true, color: 'indigo', change: calculateChange(currentMetrics.avgExpense, previousMetrics.avgExpense) }
        ];

        reportsContainer.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                ${kpis.map(kpi => `
                    <div class="kpi-card glass-pane p-5 rounded-xl flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center ${colorClasses[kpi.color].bg} shrink-0">
                            <i data-lucide="${kpi.icon}" class="w-6 h-6 ${colorClasses[kpi.color].text}"></i>
                        </div>
                        <div class="overflow-hidden">
                            <p class="text-sm font-medium text-text-secondary">${kpi.label}</p>
                            <div class="flex items-baseline gap-2">
                                <p class="text-2xl font-bold text-text-primary">${formatAndTruncate(kpi.label, kpi.value, kpi.isCurrency)}</p>
                                ${formatChange(kpi.change)}
                            </div>
                        </div>
                    </div>`).join('')}
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <div class="lg:col-span-2 glass-pane p-6 rounded-xl h-96 flex flex-col"><h3 class="text-xl font-semibold text-text-primary mb-4">Expenses by Category</h3><div class="flex-grow flex items-center justify-center"><canvas id="expense-category-chart"></canvas></div></div>
                <div class="lg:col-span-3 glass-pane p-6 rounded-xl h-96 flex flex-col"><h3 class="text-xl font-semibold text-text-primary mb-4">Expense Trend</h3><div class="flex-grow"><canvas id="expense-trend-chart"></canvas></div></div>
            </div>
            <div class="glass-pane p-6 rounded-xl">
                <h3 class="text-xl font-semibold text-text-primary mb-4">Expense List</h3>
                <div class="overflow-x-auto">
                    <table class="table-pro">
                        <thead><tr><th>Date</th><th>Category</th><th>Paid To</th><th>Amount</th><th>Method</th><th>Recorded By</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div id="reports-pagination" class="mt-4"></div>
        `;

        // Paginate table
        const totalItems = currentMetrics.expenses.length;
        const startIndex = (viewState.currentPage - 1) * appState.itemsPerPage;
        const endIndex = startIndex + appState.itemsPerPage;
        const paginatedExpenses = currentMetrics.expenses.sort((a,b) => new Date(b.date) - new Date(a.date)).slice(startIndex, endIndex);

        reportsContainer.querySelector('tbody').innerHTML = paginatedExpenses.map(e => `
            <tr class="table-row">
                <td>${new Date(e.date).toLocaleDateString()}</td>
                <td><span class="px-2 py-1 text-xs font-semibold rounded-full bg-indigo-500/20 text-indigo-300">${e.category}</span></td>
                <td class="text-sm text-text-secondary">${e.paidTo || 'N/A'}</td>
                <td class="font-mono text-left">${currencyUtils.format(e.amountInBase)}</td>
                <td class="text-sm text-text-secondary">${e.paymentMethod || 'N/A'}</td>
                <td class="text-sm text-text-secondary">${e.recordedBy?.name || 'N/A'}</td>
            </tr>
        `).join('');
        renderPaginationControls(reportsContainer.querySelector('#reports-pagination'), totalItems, viewState.currentPage, appState.itemsPerPage, 'reports');

        // Charts
        const expensesByCategory = currentMetrics.expenses.reduce((acc, e) => {
            acc[e.category] = (acc[e.category] || 0) + e.amountInBase;
            return acc;
        }, {});
        const catCtx = document.getElementById('expense-category-chart')?.getContext('2d');
        if (catCtx && Object.keys(expensesByCategory).length > 0) {
            chartInstances.category = new Chart(catCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(expensesByCategory),
                    datasets: [{ data: Object.values(expensesByCategory), backgroundColor: chartStyles.palettes.mutedSunset, borderColor: 'var(--bg-primary)', borderWidth: 4 }]
                },
                options: commonChartOptions(true, { plugins: { legend: { position: 'right' } } })
            });
        }

        const expensesByDate = currentMetrics.expenses.reduce((acc, e) => {
            const day = new Date(e.date).toISOString().split('T')[0]; // YYYY-MM-DD
            acc[day] = (acc[day] || 0) + e.amountInBase;
            return acc;
        }, {});
        const sortedDates = Object.entries(expensesByDate).sort(([dateA], [dateB]) => dateA.localeCompare(dateB));
        const trendCtx = document.getElementById('expense-trend-chart')?.getContext('2d');
        if (trendCtx && sortedDates.length > 0) {
            chartInstances.trend = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: sortedDates.map(d => new Date(d[0] + 'T00:00:00Z').toLocaleDateString([], { month: 'short', day: 'numeric', timeZone: 'UTC' })),
                    datasets: [{ 
                        label: 'Expenses', data: sortedDates.map(d => d[1]),
                        backgroundColor: chartStyles.createGradient(trendCtx, chartStyles.palettes.red[0]),
                        borderColor: chartStyles.palettes.red[0], tension: 0.3, fill: true, borderWidth: 2
                    }]
                },
                options: commonChartOptions(true, { plugins: { legend: { display: false } } })
            });
        }

        lucide.createIcons();
    };

    // --- *** NEW P&L REPORT *** ---
    const renderPnlReport = (startDate, endDate, prevStartDate, prevEndDate) => {
        destroyCharts();
        
        const getPnlMetrics = (start, end) => {
            const invoices = firestoreData.invoices.filter(inv => {
                const invDate = new Date(inv.date);
                return invDate >= start && invDate <= end && inv.status !== 'Void';
            });
            const expenses = firestoreData.expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return expenseDate >= start && expenseDate <= end;
            });
            
            // 1. Calculate Base Product Revenue (Price * Qty)
            const productRevenue = invoices.reduce((sum, inv) => sum + (inv.subtotalInBaseCurrency || 0), 0);

            // 2. Calculate EMI Interest Revenue
            const interestRevenue = invoices.reduce((sum, inv) => {
                let interest = 0;
                if (inv.isEMI) {
                    // Use stored interest, or fallback to schedule lookup if legacy data
                    if (typeof inv.emiInterest !== 'undefined') {
                        interest = inv.emiInterest;
                    } else {
                        const schedule = firestoreData.emiSchedules.find(s => s.invoiceId === inv.id);
                        if (schedule) interest = schedule.totalInterest;
                    }
                }
                return sum + interest;
            }, 0);

            // 3. Gross Revenue = Products + Interest
            const grossRevenue = productRevenue + interestRevenue;

            // 4. Discounts
            const totalDiscounts = invoices.reduce((sum, inv) => sum + (inv.persistentDiscountDetails?.amount || 0) + (inv.manualDiscountInBase || 0), 0);
            
            // 5. Net Revenue
            const netRevenue = grossRevenue - totalDiscounts;

            // 6. Cost of Goods Sold (COGS)
            const cogs = invoices.reduce((sum, inv) => {
                return sum + inv.items.reduce((itemSum, item) => {
                    return itemSum + ((item.costPrice || 0) * (item.qty || 1));
                }, 0);
            }, 0);
            
            // 7. Profits
            const grossProfit = netRevenue - cogs;
            const totalExpenses = expenses.reduce((sum, e) => sum + e.amountInBase, 0);
            const netProfit = grossProfit - totalExpenses;
            
            return { productRevenue, interestRevenue, grossRevenue, totalDiscounts, netRevenue, cogs, grossProfit, totalExpenses, netProfit };
        };

        const currentMetrics = getPnlMetrics(startDate, endDate);
        const previousMetrics = getPnlMetrics(prevStartDate, prevEndDate);

        const kpis = [
            { icon: 'trending-up', label: 'Net Revenue', value: currentMetrics.netRevenue, isCurrency: true, color: 'blue', change: calculateChange(currentMetrics.netRevenue, previousMetrics.netRevenue) },
            { icon: 'percent', label: 'Interest Income', value: currentMetrics.interestRevenue, isCurrency: true, color: 'indigo', change: calculateChange(currentMetrics.interestRevenue, previousMetrics.interestRevenue) }, // Added Interest KPI
            { icon: 'wallet', label: 'Gross Profit', value: currentMetrics.grossProfit, isCurrency: true, color: 'green', change: calculateChange(currentMetrics.grossProfit, previousMetrics.grossProfit) },
            { icon: 'credit-card', label: 'Op. Expenses', value: currentMetrics.totalExpenses, isCurrency: true, color: 'red', change: calculateChange(currentMetrics.totalExpenses, previousMetrics.totalExpenses) },
        ];
        
        const netProfitChange = calculateChange(currentMetrics.netProfit, previousMetrics.netProfit);
        const netProfitColor = currentMetrics.netProfit >= 0 ? 'text-green-400' : 'text-red-400';

        reportsContainer.innerHTML = `
            <div class="glass-pane p-6 rounded-xl text-center">
                <p class="text-sm text-text-secondary uppercase font-semibold">Net Profit</p>
                <p class="text-5xl font-bold font-mono ${netProfitColor} my-2">${currencyUtils.format(currentMetrics.netProfit)}</p>
                <div class="flex items-center justify-center">${formatChange(netProfitChange)}</div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                ${kpis.map(kpi => `
                    <div class="kpi-card glass-pane p-5 rounded-xl flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center ${colorClasses[kpi.color].bg} shrink-0">
                            <i data-lucide="${kpi.icon}" class="w-6 h-6 ${colorClasses[kpi.color].text}"></i>
                        </div>
                        <div class="overflow-hidden">
                            <p class="text-sm font-medium text-text-secondary">${kpi.label}</p>
                            <p class="text-2xl font-bold text-text-primary">${formatAndTruncate(kpi.label, kpi.value, kpi.isCurrency)}</p>
                        </div>
                    </div>`).join('')}
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-pane p-6 rounded-xl h-auto flex flex-col"><h3 class="text-xl font-semibold text-text-primary mb-4">Income vs. Expense</h3><div class="flex-grow min-h-[300px]"><canvas id="pnl-bar-chart"></canvas></div></div>
                <div class="glass-pane p-6 rounded-xl h-auto flex flex-col"><h3 class="text-xl font-semibold text-text-primary mb-4">Financial Summary</h3>
                    <div class="space-y-3 text-lg py-4">
                        <div class="flex justify-between"><span>Product Sales</span><span class="font-mono">${currencyUtils.format(currentMetrics.productRevenue)}</span></div>
                        ${currentMetrics.interestRevenue > 0 ? `<div class="flex justify-between text-indigo-400"><span>+ Interest Income (EMI)</span><span class="font-mono">${currencyUtils.format(currentMetrics.interestRevenue)}</span></div>` : ''}
                        <div class="flex justify-between font-bold border-t border-border-color pt-2"><span>Gross Revenue</span><span class="font-mono">${currencyUtils.format(currentMetrics.grossRevenue)}</span></div>
                        <div class="flex justify-between text-sm pl-4 text-text-secondary"><span>- Total Discounts</span><span class="font-mono text-red-400">(${currencyUtils.format(currentMetrics.totalDiscounts)})</span></div>
                        <div class="flex justify-between font-bold border-t border-border-color pt-2"><span>Net Revenue</span><span class="font-mono">${currencyUtils.format(currentMetrics.netRevenue)}</span></div>
                        <div class="flex justify-between text-sm pl-4 text-text-secondary"><span>- Cost of Goods Sold (COGS)</span><span class="font-mono text-red-400">(${currencyUtils.format(currentMetrics.cogs)})</span></div>
                        <div class="flex justify-between font-bold border-t border-border-color pt-2"><span>Gross Profit</span><span class="font-mono">${currencyUtils.format(currentMetrics.grossProfit)}</span></div>
                        <div class="flex justify-between text-sm pl-4 text-text-secondary"><span>- Operating Expenses</span><span class="font-mono text-red-400">(${currencyUtils.format(currentMetrics.totalExpenses)})</span></div>
                        <div class="flex justify-between font-bold text-2xl border-t-2 border-accent pt-3 mt-3"><span>Net Profit</span><span class="font-mono ${netProfitColor}">${currencyUtils.format(currentMetrics.netProfit)}</span></div>
                    </div>
                </div>
            </div>
            <div id="reports-pagination" class="mt-4"></div>
        `;

        const pnlBarCtx = document.getElementById('pnl-bar-chart')?.getContext('2d');
        if (pnlBarCtx) {
            chartInstances.pnlBar = new Chart(pnlBarCtx, {
                type: 'bar',
                data: {
                    labels: ['Revenue', 'Costs & Expenses', 'Profit'],
                    datasets: [
                        { label: 'Product Sales', data: [currentMetrics.productRevenue, 0, 0], backgroundColor: chartStyles.palettes.blue[0], stack: 'Stack 0' },
                        { label: 'Interest Income', data: [currentMetrics.interestRevenue, 0, 0], backgroundColor: chartStyles.palettes.indigo[0], stack: 'Stack 0' },
                        { label: 'COGS', data: [0, currentMetrics.cogs, 0], backgroundColor: chartStyles.palettes.yellow[0], stack: 'Stack 1' },
                        { label: 'Op. Expenses', data: [0, currentMetrics.totalExpenses, 0], backgroundColor: chartStyles.palettes.red[0], stack: 'Stack 1' },
                        { label: 'Net Profit', data: [0, 0, currentMetrics.netProfit], backgroundColor: chartStyles.palettes.green[0], stack: 'Stack 2' },
                    ]
                },
                options: commonChartOptions(true, {
                    plugins: { legend: { position: 'bottom' }, tooltip: { mode: 'index', intersect: false } },
                    scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true } }
                })
            });
        }
        
        reportsContainer.querySelector('#reports-pagination').innerHTML = ''; // No table for this view
        lucide.createIcons();
    };

    // --- *** NEW EMI REPORT *** ---
    const renderEMIReport = (startDate, endDate, prevStartDate, prevEndDate) => {
        destroyCharts();

        const getEMIMetrics = (start, end) => {
            // 1. Loans Originated (Created) in Period
            const schedules = firestoreData.emiSchedules.filter(s => {
                const date = new Date(s.createdAt);
                return date >= start && date <= end;
            });
            
            const totalPrincipal = schedules.reduce((sum, s) => sum + (s.totalPrincipal || 0), 0);
            const totalInterest = schedules.reduce((sum, s) => sum + (s.totalInterest || 0), 0);
            const count = schedules.length;
            
            // 2. Collections in Period
            // Look at all invoices' payment details. 
            // Valid collections are: Down Payments on EMI invoices, Installments, and Settlements.
            let totalCollections = 0;
            const collectionsByDate = {};

            firestoreData.invoices.forEach(inv => {
                if (inv.paymentDetails) {
                    inv.paymentDetails.forEach(p => {
                        const pDate = new Date(p.date);
                        if (pDate >= start && pDate <= end) {
                            if (p.isEMIPayment || p.isEMISettlement || (inv.isEMI && p.isDownPayment)) {
                                const amountBase = currencyUtils.convertToBase(p.amount, inv.currency);
                                totalCollections += amountBase;
                                
                                const day = pDate.toLocaleDateString();
                                collectionsByDate[day] = (collectionsByDate[day] || 0) + amountBase;
                            }
                        }
                    });
                }
            });

            return { schedules, totalPrincipal, totalInterest, count, totalCollections, collectionsByDate };
        };

        const current = getEMIMetrics(startDate, endDate);
        const previous = getEMIMetrics(prevStartDate, prevEndDate);

        const kpis = [
            { icon: 'banknote', label: 'Loans Disbursed', value: current.totalPrincipal, isCurrency: true, color: 'blue', change: calculateChange(current.totalPrincipal, previous.totalPrincipal) },
            { icon: 'percent', label: 'Projected Interest', value: current.totalInterest, isCurrency: true, color: 'indigo', change: calculateChange(current.totalInterest, previous.totalInterest) },
            { icon: 'download', label: 'EMI Collections', value: current.totalCollections, isCurrency: true, color: 'green', change: calculateChange(current.totalCollections, previous.totalCollections) },
            { icon: 'file-plus-2', label: 'New Loan Accounts', value: current.count, isCurrency: false, color: 'yellow', change: calculateChange(current.count, previous.count) },
        ];

        reportsContainer.innerHTML = `
            <!-- KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                ${kpis.map(kpi => `
                    <div class="kpi-card glass-pane p-5 rounded-xl flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center ${colorClasses[kpi.color].bg} shrink-0">
                            <i data-lucide="${kpi.icon}" class="w-6 h-6 ${colorClasses[kpi.color].text}"></i>
                        </div>
                        <div class="overflow-hidden">
                            <p class="text-sm font-medium text-text-secondary">${kpi.label}</p>
                            <div class="flex items-baseline gap-2">
                                <p class="text-2xl font-bold text-text-primary">${formatAndTruncate(kpi.label, kpi.value, kpi.isCurrency)}</p>
                                ${formatChange(kpi.change)}
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-pane p-6 rounded-xl h-96 flex flex-col"><h3 class="text-xl font-semibold text-text-primary mb-4">Disbursals vs Collections (Daily)</h3><div class="flex-grow"><canvas id="emi-trend-chart"></canvas></div></div>
                <div class="glass-pane p-6 rounded-xl h-96 flex flex-col"><h3 class="text-xl font-semibold text-text-primary mb-4">Loan Status (All Time)</h3><div class="flex-grow flex items-center justify-center"><canvas id="emi-status-chart"></canvas></div></div>
            </div>

            <!-- Table -->
            <div class="glass-pane p-6 rounded-xl">
                <h3 class="text-xl font-semibold text-text-primary mb-4">Loans Originated in Period</h3>
                <div class="overflow-x-auto">
                    <table class="table-pro">
                        <thead><tr><th>Schedule ID</th><th>Customer</th><th>Date</th><th>Principal</th><th>Interest</th><th>Tenure</th><th>Status</th></tr></thead>
                        <tbody id="emi-report-table-body"></tbody>
                    </table>
                </div>
            </div>
             <div id="reports-pagination" class="mt-4"></div>
        `;

        // Pagination & Table Population
        const totalItems = current.schedules.length;
        const startIndex = (viewState.currentPage - 1) * appState.itemsPerPage;
        const endIndex = startIndex + appState.itemsPerPage;
        const paginated = current.schedules.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(startIndex, endIndex);

        const tableBody = reportsContainer.querySelector('#emi-report-table-body');
        if (tableBody) {
            tableBody.innerHTML = paginated.length ? paginated.map(s => `
                <tr class="table-row">
                    <td class="font-mono text-xs">${s.id}</td>
                    <td>${s.customerName}</td>
                    <td>${new Date(s.createdAt).toLocaleDateString()}</td>
                    <td class="font-mono">${currencyUtils.format(s.totalPrincipal)}</td>
                    <td class="font-mono text-green-400">${currencyUtils.format(s.totalInterest)}</td>
                    <td>${s.tenureMonths} Months</td>
                    <td><span class="px-2 py-1 text-xs font-semibold rounded-full ${s.status === 'Active' ? 'bg-blue-500/20 text-blue-300' : 'bg-green-500/20 text-green-300'}">${s.status}</span></td>
                </tr>
            `).join('') : `<tr><td colspan="7" class="text-center p-8 text-text-secondary">No loans originated in this period.</td></tr>`;
        }
        
        renderPaginationControls(reportsContainer.querySelector('#reports-pagination'), totalItems, viewState.currentPage, appState.itemsPerPage, 'reports');

        // Charts
        
        // 1. Trend Chart Data Preparation
        const disbursalData = current.schedules.reduce((acc, s) => {
             const d = new Date(s.createdAt).toLocaleDateString();
             acc[d] = (acc[d] || 0) + s.totalPrincipal;
             return acc;
        }, {});
        const collectionData = current.collectionsByDate;
        
        // Combine all dates from both sets
        const allDates = [...new Set([...Object.keys(disbursalData), ...Object.keys(collectionData)])].sort((a,b) => new Date(a) - new Date(b));

        const trendCtx = document.getElementById('emi-trend-chart')?.getContext('2d');
        if (trendCtx) {
             chartInstances.emiTrend = new Chart(trendCtx, {
                type: 'bar',
                data: {
                    labels: allDates,
                    datasets: [
                        { label: 'Disbursed', data: allDates.map(d => disbursalData[d] || 0), backgroundColor: chartStyles.palettes.blue[0], borderRadius: 4 },
                        { label: 'Collected', data: allDates.map(d => collectionData[d] || 0), backgroundColor: chartStyles.palettes.green[0], borderRadius: 4 }
                    ]
                },
                options: commonChartOptions(true)
            });
        }
        
        // 2. Status Distribution (Snapshot of ALL loans for context)
        const statusCounts = firestoreData.emiSchedules.reduce((acc, s) => {
            acc[s.status] = (acc[s.status] || 0) + 1;
            return acc;
        }, {});
        
        const statusCtx = document.getElementById('emi-status-chart')?.getContext('2d');
         if (statusCtx) {
             chartInstances.emiStatus = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: [chartStyles.palettes.blue[0], chartStyles.palettes.green[0], chartStyles.palettes.red[0], chartStyles.palettes.yellow[0]],
                        borderWidth: 0
                    }]
                },
                options: commonChartOptions(false, { plugins: { legend: { position: 'right' } } })
            });
        }

        lucide.createIcons();
    };


    // --- *** MAIN RENDER LOGIC *** ---
    const renderCurrentReport = () => {
        const now = new Date();
        let startDate, endDate = new Date(now);
        let prevStartDate, prevEndDate;

        // Update UI to reflect current state before rendering
        pane.querySelectorAll('.report-type-btn').forEach(b => b.classList.toggle('active', b.dataset.type === viewState.reportType));

        switch (viewState.period) {
            case 'year':
                startDate = new Date(now.getFullYear(), 0, 1);
                prevStartDate = new Date(now.getFullYear() - 1, 0, 1);
                prevEndDate = new Date(now.getFullYear() - 1, 11, 31);
                break;
            case 'month':
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                prevStartDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                prevEndDate = new Date(now.getFullYear(), now.getMonth(), 0);
                break;
            case 'last30':
                startDate = new Date(now);
                startDate.setDate(now.getDate() - 30);
                prevEndDate = new Date(startDate);
                prevEndDate.setDate(prevEndDate.getDate() - 1);
                prevStartDate = new Date(prevEndDate);
                prevStartDate.setDate(prevEndDate.getDate() - 30);
                break;
            case 'week':
                startDate = new Date(now);
                startDate.setDate(now.getDate() - now.getDay());
                startDate.setHours(0,0,0,0);
                prevEndDate = new Date(startDate);
                prevEndDate.setDate(prevEndDate.getDate() - 1);
                prevStartDate = new Date(prevEndDate);
                prevStartDate.setDate(prevEndDate.getDate() - 6);
                break;
            case 'last7':
                 startDate = new Date(now);
                startDate.setDate(now.getDate() - 7);
                prevEndDate = new Date(startDate);
                prevEndDate.setDate(prevEndDate.getDate() - 1);
                prevStartDate = new Date(prevEndDate);
                prevStartDate.setDate(prevEndDate.getDate() - 6);
                break;
            case 'yesterday':
                startDate = new Date(now);
                startDate.setDate(now.getDate() - 1);
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(startDate);
                endDate.setHours(23, 59, 59, 999);
                prevStartDate = new Date(startDate);
                prevStartDate.setDate(startDate.getDate() - 1);
                prevEndDate = new Date(prevStartDate);
                prevEndDate.setHours(23, 59, 59, 999);
                break;
            case 'custom':
                startDate = new Date(viewState.customRange.start);
                startDate.setHours(0,0,0,0);
                endDate = new Date(viewState.customRange.end);
                endDate.setHours(23,59,59,999);
                const diff = endDate.getTime() - startDate.getTime();
                prevEndDate = new Date(startDate.getTime() - 86400000); // 1 day before start
                prevStartDate = new Date(prevEndDate.getTime() - diff);
                break;
            case 'today':
            default:
                startDate = new Date(now);
                startDate.setHours(0, 0, 0, 0);
                prevStartDate = new Date(startDate);
                prevStartDate.setDate(startDate.getDate() - 1);
                prevEndDate = new Date(prevStartDate);
                prevEndDate.setHours(23, 59, 59, 999);
                break;
        }
        
        switch(viewState.reportType) {
            case 'inventory': renderInventoryReport(startDate, endDate, prevStartDate, prevEndDate); break;
            case 'customer': renderCustomerReport(startDate, endDate, prevStartDate, prevEndDate); break;
            case 'activity': renderActivityReport(startDate, endDate); break;
            case 'expense': renderExpenseReport(startDate, endDate, prevStartDate, prevEndDate); break;
            case 'pnl': renderPnlReport(startDate, endDate, prevStartDate, prevEndDate); break;
            case 'emi': renderEMIReport(startDate, endDate, prevStartDate, prevEndDate); break; // --- NEW CASE ---
            case 'sales': default: renderSalesReport(startDate, endDate, prevStartDate, prevEndDate); break;
        }
        
        // --- NEW: Update scroll button visibility after report renders ---
        updateScrollButtonsVisibility();
    };
    
    // --- ONE-TIME EVENT LISTENERS ---
    if (!pane.dataset.reportsInitialized) {
        pane.dataset.reportsInitialized = 'true';

        const canSeeAllReports = checkPermission('canSeeAllReports');
        
        // --- UPDATED HEADER ---
        const reportTypeButtons = canSeeAllReports ? `
            <button data-action="set-report-type" data-type="sales" class="report-type-btn active px-3 py-1.5 text-sm font-semibold rounded-md flex items-center gap-2"><i data-lucide="trending-up" class="w-4 h-4"></i>Sales</button>
            <button data-action="set-report-type" data-type="inventory" class="report-type-btn px-3 py-1.5 text-sm font-semibold rounded-md flex items-center gap-2"><i data-lucide="boxes" class="w-4 h-4"></i>${term.inventory}</button>
            <button data-action="set-report-type" data-type="customer" class="report-type-btn px-3 py-1.5 text-sm font-semibold rounded-md flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i>Customer</button>
            <button data-action="set-report-type" data-type="expense" class="report-type-btn px-3 py-1.5 text-sm font-semibold rounded-md flex items-center gap-2"><i data-lucide="credit-card" class="w-4 h-4"></i>Expense</button>
            ${checkPermission('canManageEMI') ? `<button data-action="set-report-type" data-type="emi" class="report-type-btn px-3 py-1.5 text-sm font-semibold rounded-md flex items-center gap-2"><i data-lucide="banknote" class="w-4 h-4"></i>EMI</button>` : ''}
            ${checkPermission('canViewProfitAndLoss') ? `<button data-action="set-report-type" data-type="pnl" class="report-type-btn px-3 py-1.5 text-sm font-semibold rounded-md flex items-center gap-2"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i>P&L</button>` : ''}
            <button data-action="set-report-type" data-type="activity" class="report-type-btn px-3 py-1.5 text-sm font-semibold rounded-md flex items-center gap-2"><i data-lucide="history" class="w-4 h-4"></i>Activity</button>
        ` : '';

        const headerTitle = canSeeAllReports ? 'Business Reports' : 'My Sales Report';
        const headerSubtitle = canSeeAllReports ? 'Analyze trends and performance metrics.' : 'A summary of your sales performance.';
        
        pane.querySelector('#reports-header').innerHTML = `
            <div>
                <h1 class="text-3xl font-bold text-text-primary">${headerTitle}</h1>
                <p class="text-text-secondary">${headerSubtitle}</p>
            </div>
            <div class="flex-1 flex justify-end items-center gap-4 min-w-0">
                ${canSeeAllReports ? `
                <div class="flex items-center gap-2 flex-shrink min-w-0" style="max-width: 500px;">
                    <button data-action="scroll-report-types" data-direction="-1" class="btn btn-secondary !p-2 rounded-full h-9 w-9 flex-shrink-0 items-center justify-center hidden">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    </button>
                    
                    <div id="report-scroller-wrapper" class="flex-grow overflow-hidden relative min-w-0">
                        <div id="report-types-scroller" class="flex items-center gap-1 bg-bg-secondary p-1 rounded-lg border border-border-color overflow-x-auto no-scrollbar scroll-smooth whitespace-nowrap">
                            ${reportTypeButtons}
                        </div>
                    </div>
                    
                    <button data-action="scroll-report-types" data-direction="1" class="btn btn-secondary !p-2 rounded-full h-9 w-9 flex-shrink-0 items-center justify-center hidden">
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                </div>
                ` : ''}
                <div class="relative flex-shrink-0" id="report-period-dropdown-container">
                    <button id="report-period-dropdown-btn" class="btn btn-secondary flex justify-between items-center text-sm p-2.5 whitespace-nowrap">
                        <span id="selected-report-period-label">Last 30 Days</span>
                        <i data-lucide="chevron-down" class="w-4 h-4 transition-transform ml-2"></i>
                    </button>
                    <div id="report-period-dropdown-menu" class="absolute top-full right-0 mt-2 w-56 bg-bg-secondary border border-border-color rounded-lg shadow-lg z-20 hidden p-1">
                        <a href="#" class="report-period-item" data-action="set-report-period" data-period="today" data-label="Today">Today</a>
                        <a href="#" class="report-period-item" data-action="set-report-period" data-period="yesterday" data-label="Yesterday">Yesterday</a>
                        <a href="#" class="report-period-item" data-action="set-report-period" data-period="week" data-label="This Week">This Week</a>
                        <a href="#" class="report-period-item" data-action="set-report-period" data-period="last7" data-label="Last 7 Days">Last 7 Days</a>
                        <a href="#" class="report-period-item" data-action="set-report-period" data-period="month" data-label="This Month">This Month</a>
                        <a href="#" class="report-period-item active" data-action="set-report-period" data-period="last30" data-label="Last 30 Days">Last 30 Days</a>
                        <a href="#" class="report-period-item" data-action="set-report-period" data-period="year" data-label="This Year">This Year</a>
                        <div class="h-px bg-border-color my-1"></div>
                        <a href="#" class="report-period-item flex items-center justify-between" data-action="set-report-period" data-period="custom" data-label="Custom">
                            <span>Custom Range</span>
                            <i data-lucide="calendar" class="w-4 h-4"></i>
                        </a>
                    </div>
                </div>
                 ${canSeeAllReports ? `
                <div class="relative" id="report-cashier-filter-container">
                    <select id="report-cashier-filter" class="form-select bg-bg-secondary border-border-color text-sm p-2.5 h-full appearance-none">
                        <option value="all">All Staff</option>
                    </select>
                </div>
                ` : ''}
                <div class="h-8 w-px bg-border-color hidden md:block"></div>
                <div class="relative">
                    <button data-action="toggle-action-menu" class="btn btn-secondary text-sm p-2.5 flex items-center" title="Export Data">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        <span class="hidden lg:inline ml-2">Export</span>
                        <i data-lucide="chevron-down" class="w-4 h-4 ml-1 hidden lg:inline"></i>
                    </button>
                    <div class="action-menu !w-56 z-20">
                        <div class="action-menu-item" data-action="export-products">
                            <i data-lucide="package" class="w-4 h-4"></i>
                            <span>Export ${term.product}s</span>
                        </div>
                        <div class="action-menu-item" data-action="export-customers">
                            <i data-lucide="users" class="w-4 h-4"></i>
                            <span>Export Customers</span>
                        </div>
                    </div>
                </div>
            </div>
            <style>
                .no-scrollbar::-webkit-scrollbar { display: none; }
                .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

                /* NEW: Gradient fade for scroller */
                #report-scroller-wrapper {
                    position: relative;
                }
                #report-scroller-wrapper::before,
                #report-scroller-wrapper::after {
                    content: '';
                    position: absolute;
                    top: 0;
                    bottom: 0;
                    width: 30px; /* Width of the fade */
                    pointer-events: none; /* Allows clicking through */
                    transition: opacity 0.2s ease;
                    z-index: 2; /* Ensure it's above the scroller content */
                }
                #report-scroller-wrapper::before {
                    left: 0;
                    background: linear-gradient(to right, var(--bg-primary), transparent);
                    opacity: 0; /* Hidden by default */
                }
                #report-scroller-wrapper::after {
                    right: 0;
                    background: linear-gradient(to left, var(--bg-primary), transparent);
                    opacity: 0; /* Hidden by default */
                }
                
                /* NEW: Classes to control visibility */
                #report-scroller-wrapper.show-fade-left::before { opacity: 1; }
                #report-scroller-wrapper.show-fade-right::after { opacity: 1; }
            </style>
        `;

        const cashierFilter = pane.querySelector('#report-cashier-filter');
        if (cashierFilter) {
            const staff = firestoreData.staff || [];
            cashierFilter.innerHTML = '<option value="all">All Staff</option>' + staff.map(member => 
                `<option value="${member.id}" ${viewState.filters.cashierId === member.id ? 'selected' : ''}>${member.name}</option>`
            ).join('');
            
            cashierFilter.addEventListener('change', e => {
                viewState.filters.cashierId = e.target.value;
                viewState.currentPage = 1; 
                renderCurrentReport();
            });
        }

        // --- MODIFIED: Scroll listener for report type buttons ---
        pane.querySelectorAll('[data-action="scroll-report-types"]').forEach(btn => {
            btn.addEventListener('click', () => {
                const scroller = pane.querySelector('#report-types-scroller');
                if (scroller) {
                    const scrollAmount = 150; // Amount to scroll in pixels
                    const direction = parseInt(btn.dataset.direction, 10);
                    scroller.scrollBy({ left: scrollAmount * direction, behavior: 'smooth' });
                    
                    // NEW: Update visibility after a short delay to allow scroll to start
                    setTimeout(updateScrollButtonsVisibility, 100); 
                }
            });
        });

        // --- NEW: Add scroll event listener to the scroller itself ---
        const scroller = pane.querySelector('#report-types-scroller');
        if (scroller) {
            scroller.addEventListener('scroll', updateScrollButtonsVisibility);
        }
        
        // --- NEW: Initial call to set button visibility ---
        updateScrollButtonsVisibility();
        // --- NEW: Also call on resize ---
        window.addEventListener('resize', updateScrollButtonsVisibility);


        // NEW listener for the activity sub-tabs
        reportsContainer.addEventListener('click', e => {
            const target = e.target.closest('[data-action="set-activity-report-type"]');
            if (target) {
                viewState.filters.activitySubType = target.dataset.type;
                viewState.currentPage = 1; // Reset page on tab switch
                renderCurrentReport();
            }
        });

        const dropdownBtn = pane.querySelector('#report-period-dropdown-btn');
        const dropdownMenu = pane.querySelector('#report-period-dropdown-menu');
        const customRangeContainer = pane.querySelector('#report-custom-range');
        const applyRangeBtn = pane.querySelector('#report-apply-range');
        const dropdownIcon = dropdownBtn?.querySelector('i[data-lucide="chevron-down"]');

        if (dropdownBtn && dropdownMenu) {
            dropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isHidden = dropdownMenu.classList.toggle('hidden');
                dropdownIcon?.classList.toggle('rotate-180', !isHidden);
            });
        }

        pane.querySelectorAll('[data-action="set-report-period"]').forEach(item => {
            item.addEventListener('click', e => {
                e.preventDefault();
                const period = e.currentTarget.dataset.period;
                const label = e.currentTarget.dataset.label;
                viewState.currentPage = 1;

                pane.querySelector('#selected-report-period-label').textContent = label;
                pane.querySelectorAll('.report-period-item').forEach(i => i.classList.remove('active'));
                e.currentTarget.classList.add('active');
                
                if (dropdownMenu) {
                    dropdownMenu.classList.add('hidden');
                    dropdownIcon?.classList.remove('rotate-180');
                }
                
                if (period === 'custom') {
                    customRangeContainer.classList.remove('hidden');
                } else {
                    customRangeContainer.classList.add('hidden');
                    viewState.period = period;
                    renderCurrentReport();
                }
            });
        });
        
        if (applyRangeBtn) {
            applyRangeBtn.addEventListener('click', () => {
                const start = pane.querySelector('#report-start-date').value;
                const end = pane.querySelector('#report-end-date').value;
                if (start && end) {
                    if (new Date(start) > new Date(end)) {
                        showToast('Start date cannot be after end date.', 'error');
                        return;
                    }
                    viewState.period = 'custom';
                    viewState.customRange = { start, end };
                    viewState.currentPage = 1;
                    renderCurrentReport();
                } else {
                    showToast('Please select both start and end dates.', 'error');
                }
            });
        }

        pane.querySelectorAll('.report-type-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                viewState.currentPage = 1;
                viewState.reportType = e.currentTarget.dataset.type;
                renderCurrentReport();
            });
        });
    }
    
    // Always call renderCurrentReport when initReports is triggered
    // Use a timeout to ensure the DOM is ready and data has had a moment to settle during initial loads.
    setTimeout(renderCurrentReport, 0);
}





          
// --- UPDATED: Comprehensive Expenses View ---
           
            function initExpenses(pane) {
                const container = pane; // The pane is the container
                if (!container) return;

                const viewState = appState.viewStates.expenses;
                const canAdd = checkPermission('canAddExpenses');
                const canEdit = checkPermission('canEditExpenses');
                const canDelete = checkPermission('canDeleteExpenses');
                
                let chartInstances = {}; // To hold chart instances for destruction

                const destroyCharts = () => {
                    Object.values(chartInstances).forEach(chart => {
                        if (chart) chart.destroy();
                    });
                    chartInstances = {};
                };

                const renderExpensesView = () => {
                    // --- MODIFIED: Save search input state before re-rendering to prevent losing focus ---
                    const searchInputEl = container.querySelector('#expense-search');
                    const currentSearchValue = searchInputEl ? searchInputEl.value : viewState.searchQuery;
                    const isSearchFocused = searchInputEl && document.activeElement === searchInputEl;
                    // --- END MODIFICATION ---

                    destroyCharts(); // Clear old charts before re-rendering

                    // --- NEW: Filter expenses for managers ---
                    let allExpenses = firestoreData.expenses;
                    if (appState.session.userRole === 'manager') {
                        const currentUserId = appState.session.currentUser?.uid;
                        allExpenses = firestoreData.expenses.filter(e => e.recordedBy?.id === currentUserId);
                    }
                    // --- END NEW ---

                    // --- Filtering and Data Preparation ---
                    const now = new Date();
                    let startDate, endDate = new Date(now);

                    // Determine date range from viewState
                    switch (viewState.filters.period) {
                        case 'month': startDate = new Date(now.getFullYear(), now.getMonth(), 1); break;
                        case 'last30': startDate = new Date(now); startDate.setDate(now.getDate() - 30); break;
                        case 'week': startDate = new Date(now); startDate.setDate(now.getDate() - now.getDay()); break;
                        case 'today': startDate = new Date(now); startDate.setHours(0, 0, 0, 0); break;
                        case 'custom':
                            if (viewState.customRange.start && viewState.customRange.end) {
                                startDate = new Date(viewState.customRange.start);
                                startDate.setHours(0,0,0,0);
                                endDate = new Date(viewState.customRange.end);
                                endDate.setHours(23,59,59,999);
                            } else { // Fallback if custom range is not set
                                startDate = new Date(now); startDate.setDate(now.getDate() - 30);
                            }
                            break;
                        default: startDate = new Date(now); startDate.setDate(now.getDate() - 30); break;
                    }
                    
                    // Apply all filters
                    let filteredExpenses = allExpenses.filter(e => {
                        const expenseDate = new Date(e.date);
                        const isAfterStart = expenseDate >= startDate;
                        const isBeforeEnd = expenseDate <= endDate;
                        const categoryMatch = viewState.filters.category === 'all' || e.category === viewState.filters.category;
                        const paymentMethodMatch = viewState.filters.paymentMethod === 'all' || e.paymentMethod === viewState.filters.paymentMethod;
                        const searchMatch = !viewState.searchQuery || 
                            (e.notes || '').toLowerCase().includes(viewState.searchQuery.toLowerCase()) ||
                            e.category.toLowerCase().includes(viewState.searchQuery.toLowerCase()) ||
                            (e.paidTo || '').toLowerCase().includes(viewState.searchQuery.toLowerCase());
                        
                        return isAfterStart && isBeforeEnd && categoryMatch && paymentMethodMatch && searchMatch;
                    });
                    
                    filteredExpenses.sort((a, b) => {
                        const dateComparison = new Date(b.date) - new Date(a.date);
                        if (dateComparison !== 0) {
                            return dateComparison;
                        }
                        // If dates are the same, sort by creation time descending
                        return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
                    });
                    
                    filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    // --- Calculations for KPIs and Charts ---
                    const totalExpense = filteredExpenses.reduce((sum, e) => sum + e.amountInBase, 0);
                    const expenseCount = filteredExpenses.length;
                    const avgExpense = expenseCount > 0 ? totalExpense / expenseCount : 0;
                    
                    const expensesByCategory = filteredExpenses.reduce((acc, e) => {
                        acc[e.category] = (acc[e.category] || 0) + e.amountInBase;
                        return acc;
                    }, {});

                    const expensesByDate = filteredExpenses.reduce((acc, e) => {
                        const day = new Date(e.date).toLocaleDateString([], { month: 'short', day: 'numeric' });
                        acc[day] = (acc[day] || 0) + e.amountInBase;
                        return acc;
                    }, {});
                    const sortedDates = Object.entries(expensesByDate).sort(([dateA], [dateB]) => new Date(dateA) - new Date(dateB));


                    // --- Pagination ---
                    const totalItems = filteredExpenses.length;
                    const startIndex = (viewState.currentPage - 1) * appState.itemsPerPage;
                    const endIndex = startIndex + appState.itemsPerPage;
                    const paginatedExpenses = filteredExpenses.slice(startIndex, endIndex);

                    // --- Render Full View ---
                    const allCategories = ['all', ...new Set(allExpenses.map(e => e.category))];
                    const allPaymentMethods = ['all', ...new Set(firestoreData.expenses.map(e => e.paymentMethod).filter(Boolean))];

                    // Dynamically determine the label and active state for the period filter
                    const periodOptions = [
                        { period: 'today', label: 'Today' },
                        { period: 'week', label: 'This Week' },
                        { period: 'last30', label: 'Last 30 Days' },
                        { period: 'month', label: 'This Month' },
                    ];
                    
                    let currentPeriodLabel = 'Last 30 Days'; // Default
                    const currentOption = periodOptions.find(p => p.period === viewState.filters.period);
                    if (currentOption) {
                        currentPeriodLabel = currentOption.label;
                    } else if (viewState.filters.period === 'custom') {
                        currentPeriodLabel = 'Custom Range';
                    }

                    const periodDropdownHTML = periodOptions.map(p => 
                        `<div class="action-menu-item" data-action="set-expense-period" data-period="${p.period}" data-label="${p.label}">
                            <i data-lucide="calendar-days" class="w-4 h-4"></i>
                            <span>${p.label}</span>
                            ${viewState.filters.period === p.period ? '<i data-lucide="check" class="w-4 h-4 text-accent ml-auto"></i>' : ''}
                        </div>`
                    ).join('');

                    container.innerHTML = `
                        <div class="space-y-6">
                            <!-- Header -->
                            <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
                                <div>
                                    <h1 class="text-3xl font-bold text-text-primary">Expense Tracker</h1>
                                    <p class="text-text-secondary">Monitor and manage all your business expenditures.</p>
                                </div>
                                ${canAdd ? `<button data-action="add-expense" class="btn btn-primary flex-shrink-0"><i data-lucide="plus" class="w-5 h-5 mr-2"></i> Log New Expense</button>` : ''}
                            </div>
                            
                            <!-- Filters -->
                            <div class="glass-pane p-4 rounded-xl flex flex-col md:flex-row gap-3 relative z-30">
                                <div class="relative flex-grow">
                                    <i data-lucide="search" class="absolute left-3.5 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i>
                                    <input type="text" id="expense-search" placeholder="Search expenses..." class="form-input w-full pl-11" value="${viewState.searchQuery}">
                                </div>
                                <select id="expense-category-filter" class="form-select flex-shrink-0 md:w-48">${allCategories.map(c => `<option value="${c}" ${viewState.filters.category === c ? 'selected' : ''}>${c === 'all' ? 'All Categories' : c}</option>`).join('')}</select>
                                <select id="expense-payment-method-filter" class="form-select flex-shrink-0 md:w-48">${allPaymentMethods.map(p => `<option value="${p}" ${viewState.filters.paymentMethod === p ? 'selected' : ''}>${p === 'all' ? 'All Methods' : p}</option>`).join('')}</select>
                                <div class="relative flex-shrink-0 md:w-48">
                                    <button id="expense-period-dropdown-btn" data-action="toggle-expense-period-menu" class="btn btn-secondary w-full flex justify-between items-center text-sm p-2.5">
                                        <span id="selected-expense-period-label">${currentPeriodLabel}</span><i data-lucide="chevron-down" class="w-4 h-4"></i>
                                    </button>
                                    <div id="expense-period-dropdown-menu" class="action-menu !w-full z-20 p-1">
                                        ${periodDropdownHTML}
                                        <div class="h-px bg-border-color my-1"></div>
                                        <div class="action-menu-item" data-action="set-expense-period" data-period="custom" data-label="Custom">
                                            <i data-lucide="calendar-range" class="w-4 h-4"></i>
                                            <span>Custom Range...</span>
                                            ${viewState.filters.period === 'custom' ? '<i data-lucide="check" class="w-4 h-4 text-accent ml-auto"></i>' : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                             <div id="expense-custom-range" class="hidden flex items-center justify-end gap-2 bg-bg-secondary p-3 rounded-lg border border-border-color">
                                <label class="text-sm">From:</label><input type="date" id="expense-start-date" class="form-input text-sm p-2 h-auto bg-bg-tertiary">
                                <label class="text-sm">To:</label><input type="date" id="expense-end-date" class="form-input text-sm p-2 h-auto bg-bg-tertiary">
                                <button id="expense-apply-range" class="btn btn-primary text-sm py-2">Apply</button>
                            </div>
                            
                            <!-- KPIs -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="glass-pane p-5 rounded-xl"><p class="text-sm text-text-secondary">Total Expenses</p><p class="text-3xl font-bold font-mono text-red-400">${currencyUtils.format(totalExpense)}</p></div>
                                <div class="glass-pane p-5 rounded-xl"><p class="text-sm text-text-secondary"># of Expenses</p><p class="text-3xl font-bold font-mono text-text-primary">${expenseCount}</p></div>
                                <div class="glass-pane p-5 rounded-xl"><p class="text-sm text-text-secondary">Average Expense</p><p class="text-3xl font-bold font-mono text-text-primary">${currencyUtils.format(avgExpense)}</p></div>
                            </div>
                            
                            <!-- Charts -->
                            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                                <div class="lg:col-span-2 glass-pane p-6 rounded-xl h-96 flex flex-col"><h3 class="text-xl font-semibold text-text-primary mb-4">By Category</h3><div class="flex-grow flex items-center justify-center"><canvas id="expense-category-chart"></canvas></div></div>
                                <div class="lg:col-span-3 glass-pane p-6 rounded-xl h-96 flex flex-col"><h3 class="text-xl font-semibold text-text-primary mb-4">Expense Trend</h3><div class="flex-grow"><canvas id="expense-trend-chart"></canvas></div></div>
                            </div>
                            
                            <!-- Table -->
                            <div class="glass-pane rounded-xl">
                                <table class="table-pro">
                                    <thead><tr><th>Date</th><th>Category</th><th>Paid To</th><th>Amount</th><th>Method</th><th>Notes</th>${canEdit || canDelete ? '<th>Actions</th>' : ''}</tr></thead>
                                    <tbody id="expenses-table-body"></tbody>
                                </table>
                            </div>
                            <div id="expenses-pagination" class="mt-4"></div>
                        </div>
                    `;
                    
                    // --- Populate Table ---
                    const tableBody = container.querySelector('#expenses-table-body');
                    if (tableBody) {
                        tableBody.innerHTML = paginatedExpenses.length ? paginatedExpenses.map(e => `
                            <tr class="table-row">
                                <td>${new Date(e.date).toLocaleDateString()}</td>
                                <td><span class="px-2 py-1 text-xs font-semibold rounded-full bg-indigo-500/20 text-indigo-300">${e.category}</span></td>
                                <td class="text-sm text-text-secondary">${e.paidTo || 'N/A'}</td>
                                <td class="font-mono text-left">${currencyUtils.format(e.amountInBase)}</td>
                                <td class="text-sm text-text-secondary">${e.paymentMethod || 'N/A'}</td>
                                <td class="text-sm text-text-secondary truncate max-w-xs" title="${e.notes || ''}">${e.notes || 'N/A'}</td>
                                ${canEdit || canDelete ? `
                                <td class="text-right">
                                    <div class="relative inline-block text-left">
                                        <button data-action="toggle-action-menu" class="p-2 rounded-md hover:bg-bg-tertiary">
                                            <i data-lucide="more-vertical" class="w-5 h-5 pointer-events-none"></i>
                                        </button>
                                        <div class="action-menu">
                                            ${e.receiptUrl ? `<a href="${e.receiptUrl}" target="_blank" class="action-menu-item"><i data-lucide="receipt-text" class="w-4 h-4"></i><span>View Receipt</span></a>` : ''}
                                            ${canEdit ? `<div class="action-menu-item" data-action="edit-expense" data-id="${e.id}"><i data-lucide="edit" class="w-4 h-4"></i><span>Edit</span></div>` : ''}
                                            ${canDelete ? `<div class="action-menu-item danger" data-action="delete-expense" data-id="${e.id}"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Delete</span></div>` : ''}
                                        </div>
                                    </div>
                                </td>
                                ` : ''}
                            </tr>
                        `).join('') : `<tr><td colspan="${canEdit || canDelete ? 7 : 6}" class="text-center p-8 text-text-secondary">No expenses found for this period.</td></tr>`;
                    }
                    
                    renderPaginationControls(container.querySelector('#expenses-pagination'), totalItems, viewState.currentPage, appState.itemsPerPage, 'expenses');
                    
                    // --- Render Charts ---
                    const catCtx = container.querySelector('#expense-category-chart')?.getContext('2d');
                    if (catCtx && Object.keys(expensesByCategory).length > 0) {
                        chartInstances.category = new Chart(catCtx, {
                            type: 'doughnut',
                            data: {
                                labels: Object.keys(expensesByCategory),
                                datasets: [{ data: Object.values(expensesByCategory), backgroundColor: chartStyles.palettes.mutedSunset, borderColor: 'var(--bg-primary)', borderWidth: 4 }]
                            },
                            options: commonChartOptions(true, { plugins: { legend: { position: 'right' } } })
                        });
                    }

                    const trendCtx = container.querySelector('#expense-trend-chart')?.getContext('2d');
                    if (trendCtx && sortedDates.length > 0) {
                        chartInstances.trend = new Chart(trendCtx, {
                            type: 'bar',
                            data: {
                                labels: sortedDates.map(d => d[0]),
                                datasets: [{ 
                                    label: 'Expenses', 
                                    data: sortedDates.map(d => d[1]),
                                    backgroundColor: chartStyles.createGradient(trendCtx, chartStyles.palettes.coolSlate[0]),
                                    borderColor: chartStyles.palettes.coolSlate[0],
                                    borderWidth: 2,
                                    borderRadius: 4,
                                }]
                            },
                            options: commonChartOptions(true, { plugins: { legend: { display: false } } })
                        });
                    }
                    
                    lucide.createIcons();

                    // --- MODIFIED: Restore search input state after re-rendering ---
                    const newSearchInputEl = container.querySelector('#expense-search');
                    if (newSearchInputEl) {
                        newSearchInputEl.value = currentSearchValue;
                        if (isSearchFocused) {
                            newSearchInputEl.focus();
                            // Move cursor to the end to allow continuous typing
                            newSearchInputEl.setSelectionRange(currentSearchValue.length, currentSearchValue.length);
                        }
                    }
                    // --- END MODIFICATION ---
                };

                // --- Setup Event Listeners ---
                container.addEventListener('input', e => {
                    const target = e.target;
                    if (target.id === 'expense-search') {
                        viewState.searchQuery = target.value;
                        viewState.currentPage = 1;
                        renderExpensesView();
                    }
                });

                container.addEventListener('change', e => {
                    const target = e.target;
                    if (target.id === 'expense-category-filter') {
                        viewState.filters.category = target.value;
                        viewState.currentPage = 1;
                        renderExpensesView();
                    }
                    if (target.id === 'expense-payment-method-filter') {
                        viewState.filters.paymentMethod = target.value;
                        viewState.currentPage = 1;
                        renderExpensesView();
                    }
                });

                 container.addEventListener('click', e => {
                    const target = e.target.closest('[data-action]');
                    if (!target) return;
                    const action = target.dataset.action;

                    if (action === 'toggle-expense-period-menu') {
                        e.stopPropagation();
                        const dropdownMenu = container.querySelector('#expense-period-dropdown-menu');
                        if (dropdownMenu) {
                            dropdownMenu.classList.toggle('open');
                        }
                        return;
                    }

                    if (action === 'set-expense-period') {
                        const period = target.dataset.period;
                        const label = target.dataset.label;
                        viewState.currentPage = 1;
                        
                        container.querySelector('#selected-expense-period-label').textContent = label;
                        container.querySelectorAll('.report-period-item').forEach(i => i.classList.remove('active'));
                        target.classList.add('active');
                        container.querySelector('#expense-period-dropdown-menu').classList.remove('open');
                        
                        if (period === 'custom') {
                            container.querySelector('#expense-custom-range').classList.remove('hidden');
                        } else {
                            container.querySelector('#expense-custom-range').classList.add('hidden');
                            viewState.filters.period = period;
                            renderExpensesView();
                        }
                    }
                });
                
                container.querySelector('#expense-apply-range')?.addEventListener('click', () => {
                    const start = container.querySelector('#expense-start-date').value;
                    const end = container.querySelector('#expense-end-date').value;
                    if (start && end) {
                        viewState.filters.period = 'custom';
                        viewState.customRange = { start, end };
                        viewState.currentPage = 1;
                        renderExpensesView();
                    }
                });
                
                // --- Initial Render ---
                renderExpensesView();
            }

            function openAutomationSettingsModal(automationId) {
                const automationsConfig = {
                    inventoryOptimization: { icon: 'brain-circuit', color: 'indigo', title: 'Inventory Optimization AI', desc: 'Get AI suggestions on what to stock, promote, or discontinue.' },
                    dynamicPricing: { icon: 'trending-up', color: 'blue', title: 'Dynamic Pricing Suggestions', desc: 'Get AI-powered price suggestions based on sales data and trends.' },
                    endOfDayReports: { icon: 'file-clock', color: 'teal', title: 'Automated End-of-Day Reports', desc: 'Receive an automated sales summary at the end of each day.' },
                    fraudDetection: { icon: 'shield-alert', color: 'red', title: 'AI-Powered Fraud Detection', desc: 'Monitor transactions for suspicious activity in real-time.' }
                };

                const config = automationsConfig[automationId];
                if (!config) return;

                const automationSettings = appState.settings.automations || {};
                const settings = automationSettings[automationId] || {};
                let content = '';

                switch (automationId) {
                    case 'inventoryOptimization':
                        content = `
                            <form id="automation-settings-form" class="space-y-4">
                                <p class="text-sm text-text-secondary">Choose how often the AI should analyze your inventory and sales data to provide optimization suggestions.</p>
                                <div>
                                    <label for="analysisFrequency" class="block text-sm font-medium text-text-secondary mb-1">Analysis Frequency</label>
                                    <select id="analysisFrequency" name="analysisFrequency" class="form-select w-full">
                                        <option value="daily" ${settings.analysisFrequency === 'daily' ? 'selected' : ''}>Daily</option>
                                        <option value="weekly" ${settings.analysisFrequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                                        <option value="monthly" ${settings.analysisFrequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                                    </select>
                                    <p class="text-xs text-text-secondary mt-1">Suggestions will appear as notifications and on your dashboard.</p>
                                </div>
                            </form>
                        `;
                        break;
                    case 'dynamicPricing':
                        content = `
                            <form id="automation-settings-form" class="space-y-4">
                                <p class="text-sm text-text-secondary">Let the AI adjust pricing to maximize profit based on different strategies.</p>
                                <div>
                                    <label for="strategy" class="block text-sm font-medium text-text-secondary mb-1">Pricing Strategy</label>
                                    <select id="strategy" name="strategy" class="form-select w-full">
                                        <option value="conservative" ${settings.strategy === 'conservative' ? 'selected' : ''}>Conservative (Minor adjustments)</option>
                                        <option value="balanced" ${settings.strategy === 'balanced' ? 'selected' : ''}>Balanced (Moderate adjustments)</option>
                                        <option value="aggressive" ${settings.strategy === 'aggressive' ? 'selected' : ''}>Aggressive (Maximize revenue)</option>
                                    </select>
                                    <p class="text-xs text-text-secondary mt-1">The AI will suggest price changes which you can approve or reject.</p>
                                </div>
                            </form>
                        `;
                        break;
                    case 'endOfDayReports':
                        content = `
                            <form id="automation-settings-form" class="space-y-4">
                                <p class="text-sm text-text-secondary">Set a time for the system to automatically compile and deliver your end-of-day sales summary.</p>
                                <div>
                                    <label for="deliveryTime" class="block text-sm font-medium text-text-secondary mb-1">Report Delivery Time</label>
                                    <input type="time" id="deliveryTime" name="deliveryTime" value="${settings.deliveryTime || '22:00'}" class="form-input w-full">
                                    <p class="text-xs text-text-secondary mt-1">The report will be generated daily at this time and sent as a notification.</p>
                                </div>
                            </form>
                        `;
                        break;
                    case 'fraudDetection':
                        content = `
                            <form id="automation-settings-form" class="space-y-4">
                                <p class="text-sm text-text-secondary">Set the sensitivity for detecting potentially fraudulent transactions.</p>
                                <div>
                                    <label for="sensitivity" class="block text-sm font-medium text-text-secondary mb-1">Detection Sensitivity</label>
                                    <select id="sensitivity" name="sensitivity" class="form-select w-full">
                                        <option value="low" ${settings.sensitivity === 'low' ? 'selected' : ''}>Low (Fewer alerts, might miss subtle cases)</option>
                                        <option value="medium" ${settings.sensitivity === 'medium' ? 'selected' : ''}>Medium (Balanced approach)</option>
                                        <option value="high" ${settings.sensitivity === 'high' ? 'selected' : ''}>High (More alerts, catches more suspicious activity)</option>
                                    </select>
                                    <p class="text-xs text-text-secondary mt-1">High sensitivity may flag normal transactions occasionally.</p>
                                </div>
                            </form>
                        `;
                        break;
                    default:
                        content = `<p>Configuration for this automation is not available yet.</p>`;
                }
                
                const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="automation-settings-form" class="btn btn-primary">Save Settings</button>`;
                const modal = showModal(config.title, content, footer, { size: 'max-w-xl' });

                modal.querySelector('#automation-settings-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    for (const [key, value] of formData.entries()) {
                        // Check if value is a number string and convert
                        appState.settings.automations[automationId][key] = !isNaN(value) && value.trim() !== '' ? parseFloat(value) : value;
                    }
                    closeModal(modal);
                    showToast(`${config.title} settings updated. Click 'Save Changes' to make them permanent.`, 'info');
                });
            }

            function initSettings(pane) {
                const businessTypeSelectorContainer = pane.querySelector('#business-type-selector');
                const receiptSelectorContainer = pane.querySelector('#receipt-template-selector');
                const posLayoutSelectorContainer = pane.querySelector('#pos-layout-selector');
                const defaultCurrencySelector = pane.querySelector('#default-currency-selector');
                const defaultUnitSelector = pane.querySelector('#default-unit-selector');
                const automationsContainer = pane.querySelector('#automations-container');

                if (automationsContainer) {
                     automationsContainer.addEventListener('click', e => {
                        const toggleTarget = e.target.closest('[data-action="toggle-automation"]');
                        const settingsTarget = e.target.closest('[data-action="open-automation-settings"]');

                        if (toggleTarget) {
                            const automationId = toggleTarget.dataset.automationId;
                            const isEnabled = toggleTarget.checked;
                            if (!appState.settings.automations) {
                                appState.settings.automations = {};
                            }
                            if (!appState.settings.automations[automationId]) {
                                appState.settings.automations[automationId] = {};
                            }
                            appState.settings.automations[automationId].enabled = isEnabled;
                            showToast(`${automationId} ${isEnabled ? 'enabled' : 'disabled'}. Save settings to apply.`, 'info');
                        }

                        if (settingsTarget) {
                            const automationId = settingsTarget.dataset.automationId;
                            openAutomationSettingsModal(automationId);
                        }
                    });
                }

                const permissionsContainer = pane.querySelector('#permissions-container');
                if (permissionsContainer) {
                    permissionsContainer.addEventListener('click', e => {
                        const toggle = e.target.closest('[data-action="toggle-permission"]');
                        if (toggle) {
                            const { roleId, permissionId } = toggle.dataset;
                            const isEnabled = toggle.checked;
                            if (appState.settings.permissions?.[roleId]?.permissions?.[permissionId]) {
                                appState.settings.permissions[roleId].permissions[permissionId].value = isEnabled;
                                showToast(`${roleId}'s permission for '${permissionId}' ${isEnabled ? 'enabled' : 'disabled'}. Save settings to apply.`, 'info');
                            }
                        }
                    });
                }

                if (defaultCurrencySelector && firestoreData.storeInfo.currencies) {
                    defaultCurrencySelector.innerHTML = Object.entries(firestoreData.storeInfo.currencies).map(([code, currency]) => 
                        `<option value="${code}" ${appState.settings.defaultCurrency === code ? 'selected' : ''}>${code} - ${currency.name}</option>`
                    ).join('');
                }

                if (defaultUnitSelector && firestoreData.unitsOfMeasurement) {
                    defaultUnitSelector.innerHTML = firestoreData.unitsOfMeasurement.map(unit => 
                        `<option value="${unit.id}" ${appState.settings.defaultUnit === unit.id ? 'selected' : ''}>${unit.name}</option>`
                    ).join('');
                }

                const renderPosLayoutSelector = () => {
                    if (!posLayoutSelectorContainer) return;
                    const layouts = {
                        classic: {
                            name: 'Classic List View',
                            preview: `<div class="w-full h-full border border-slate-700/50 rounded-sm p-1.5 flex flex-col gap-1.5 bg-gradient-to-br from-slate-800 to-slate-900 shadow-inner">
                                          <div class="h-3 w-full bg-slate-700/50 rounded-sm flex items-center px-1 gap-1">
                                              <div class="w-1/4 h-1.5 bg-sky-500/70 rounded-full"></div>
                                              <div class="w-1/3 h-1.5 bg-slate-600/50 rounded-full"></div>
                                          </div>
                                          <div class="flex-grow flex gap-1.5">
                                              <div class="w-7/12 bg-slate-700/30 rounded-sm p-1 space-y-1">
                                                  <div class="h-2.5 w-full bg-slate-600/50 rounded-sm"></div>
                                                  <div class="h-3.5 w-full bg-slate-600/20 rounded-sm flex items-center gap-1 p-0.5"><div class="w-2.5 h-2.5 bg-slate-500/50 rounded-sm shrink-0"></div><div class="h-1 flex-grow bg-slate-500/50 rounded-full"></div></div>
                                                  <div class="h-3.5 w-full bg-slate-600/20 rounded-sm flex items-center gap-1 p-0.5"><div class="w-2.5 h-2.5 bg-slate-500/50 rounded-sm shrink-0"></div><div class="h-1 flex-grow bg-slate-500/50 rounded-full"></div></div>
                                              </div>
                                              <div class="w-5/12 bg-slate-700/30 rounded-sm p-1 flex flex-col justify-between">
                                                  <div class="space-y-1">
                                                      <div class="h-2 w-full bg-slate-600/50 rounded-full"></div>
                                                      <div class="h-2 w-2/3 bg-slate-600/50 rounded-full"></div>
                                                  </div>
                                                  <div class="h-4 w-full bg-sky-500/70 rounded-sm"></div>
                                              </div>
                                          </div>
                                      </div>`
                        },
                        modern: {
                            name: 'Modern Grid View',
                            preview: `<div class="w-full h-full border border-slate-700/50 rounded-sm flex overflow-hidden bg-gradient-to-br from-slate-800 to-slate-900 shadow-inner">
                                          <div class="w-1/4 border-r border-slate-700/50 bg-slate-800/50 p-1 flex flex-col gap-1">
                                              <div class="h-2 w-full bg-slate-600/50 rounded-full"></div>
                                              <div class="h-2 w-2/3 bg-slate-600/50 rounded-full"></div>
                                          </div>
                                          <div class="w-1/2 p-1 grid grid-cols-2 gap-1">
                                              <div class="bg-slate-700/30 rounded-sm h-8"></div>
                                              <div class="bg-slate-700/30 rounded-sm h-8"></div>
                                              <div class="bg-slate-700/30 rounded-sm h-8"></div>
                                              <div class="bg-slate-700/30 rounded-sm h-8"></div>
                                          </div>
                                          <div class="w-1/4 bg-slate-700/30 border-l border-slate-700/50 p-1 flex flex-col justify-end">
                                               <div class="h-4 w-full bg-sky-500/70 rounded-sm"></div>
                                          </div>
                                      </div>`
                        }
                    };

                    posLayoutSelectorContainer.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            ${Object.entries(layouts).map(([key, layout]) => `
                                <div data-action="select-pos-layout" data-layout-id="${key}" class="template-selector rounded-lg p-4 bg-bg-secondary ${appState.settings.posLayout === key ? 'active' : ''}">
                                    <h4 class="font-semibold text-text-primary text-sm mb-2">${layout.name}</h4>
                                    <div class="h-20 bg-bg-tertiary rounded overflow-hidden pointer-events-none">
                                        ${layout.preview}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                };

                if (posLayoutSelectorContainer) {
                    posLayoutSelectorContainer.addEventListener('click', e => {
                        const selectTarget = e.target.closest('[data-action="select-pos-layout"]');
                        if (selectTarget) {
                            const layoutId = selectTarget.dataset.layoutId;
                            if (appState.settings.posLayout !== layoutId) {
                                appState.settings.posLayout = layoutId;
                                posLayoutSelectorContainer.querySelectorAll('[data-action="select-pos-layout"]').forEach(el => el.classList.remove('active'));
                                selectTarget.classList.add('active');
                            }
                        }
                    });
                }

                const renderBusinessTypeSelector = () => {
                    if (!businessTypeSelectorContainer) return;
                    let profilesHTML = Object.entries(businessProfiles).map(([id, type]) => `
                        <div data-action="select-business-type" data-type-id="${id}" class="relative group template-selector rounded-lg p-4 bg-bg-secondary flex flex-col items-center justify-center text-center h-28 ${appState.settings.businessType === id ? 'active' : ''}">
                             <div class="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button data-action="edit-predefined-profile" data-id="${id}" class="p-1.5 bg-bg-tertiary rounded-md hover:text-accent"><i data-lucide="edit" class="w-3 h-3 pointer-events-none"></i></button>
                            </div>
                            <i data-lucide="${type.icon}" class="w-8 h-8 mb-2 text-accent"></i>
                            <h4 class="font-semibold text-text-primary text-sm">${type.name}</h4>
                        </div>
                    `).join('');

                    profilesHTML += Object.entries(appState.customProfiles).map(([id, type]) => `
                         <div data-action="select-business-type" data-type-id="${id}" class="relative group template-selector rounded-lg p-4 bg-bg-secondary flex flex-col items-center justify-center text-center h-28 ${appState.settings.businessType === id ? 'active' : ''}">
                            <div class="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button data-action="edit-custom-profile" data-id="${id}" class="p-1.5 bg-bg-tertiary rounded-md hover:text-accent"><i data-lucide="edit" class="w-3 h-3 pointer-events-none"></i></button>
                                <button data-action="delete-custom-profile" data-id="${id}" class="p-1.5 bg-bg-tertiary rounded-md hover:text-danger"><i data-lucide="trash-2" class="w-3 h-3 pointer-events-none"></i></button>
                            </div>
                            <i data-lucide="${type.icon}" class="w-8 h-8 mb-2 text-accent"></i>
                            <h4 class="font-semibold text-text-primary text-sm">${type.name}</h4>
                        </div>
                    `).join('');
                    
                    profilesHTML += `
                         <div data-action="create-custom-profile" class="template-selector rounded-lg p-4 bg-bg-secondary flex flex-col items-center justify-center text-center h-28 border-dashed border-border-color-strong hover:border-accent">
                            <i data-lucide="plus" class="w-8 h-8 mb-2 text-text-secondary"></i>
                            <h4 class="font-semibold text-text-primary text-sm">Create Your Own</h4>
                        </div>
                    `;


                    businessTypeSelectorContainer.innerHTML = `
                        <p class="text-sm text-text-secondary mb-4">Select your primary business type to tailor the system experience.</p>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                           ${profilesHTML}
                        </div>
                    `;
                    lucide.createIcons();
                };

                if (businessTypeSelectorContainer) {
                    businessTypeSelectorContainer.addEventListener('click', e => {
                        const selectTarget = e.target.closest('[data-action="select-business-type"]');
                        const createTarget = e.target.closest('[data-action="create-custom-profile"]');
                        const editCustomTarget = e.target.closest('[data-action="edit-custom-profile"]');
                        const deleteTarget = e.target.closest('[data-action="delete-custom-profile"]');
                        const editPredefinedTarget = e.target.closest('[data-action="edit-predefined-profile"]');

                        if (createTarget) {
                            openCustomProfileModal();
                        } else if (editPredefinedTarget) {
                            e.stopPropagation();
                            openCustomProfileModal(editPredefinedTarget.dataset.id, true);
                        } else if (editCustomTarget) {
                            e.stopPropagation();
                            openCustomProfileModal(editCustomTarget.dataset.id, false);
                        } else if (deleteTarget) {
                            e.stopPropagation();
                            const profileId = deleteTarget.dataset.id;
                            const profileName = appState.customProfiles[profileId].name;
                            const modal = showModal('Delete Profile', `<p>Are you sure you want to delete the "${profileName}" profile? This action cannot be undone.</p>`,
                             `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-delete" class="btn btn-danger">Delete</button>`);
                             modal.querySelector('#confirm-delete').addEventListener('click', () => {
                                 const updatedProfiles = { ...appState.customProfiles };
                                 delete updatedProfiles[profileId];
                                 let newSettings = { ...appState.settings };
                                 if(newSettings.businessType === profileId) {
                                     newSettings.businessType = 'general';
                                 }
                                 showToast(`Profile "${profileName}" deleted.`);
                                 closeModal(modal);
                                 updateDoc(storeRef, { customProfiles: updatedProfiles, settings: newSettings }).catch(err => {
                                     console.error("Failed to delete profile:", err);
                                     showToast(`Error deleting profile ${profileName}.`, 'error');
                                 });
                             });
                        } else if (selectTarget) {
                            const typeId = selectTarget.dataset.typeId;
                            if (appState.settings.businessType !== typeId) {
                                appState.settings.businessType = typeId;
                                businessTypeSelectorContainer.querySelectorAll('[data-action="select-business-type"]').forEach(el => el.classList.remove('active'));
                                selectTarget.classList.add('active');
                            }
                        }
                    });
                }

                const renderReceiptSelector = () => {
                    if (!receiptSelectorContainer) return;
                    receiptSelectorContainer.innerHTML = `
                        <p class="text-sm text-text-secondary mb-4">Choose the default design for printed and digital receipts.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            ${Object.entries(receiptTemplates)
                                .filter(([key]) => key !== 'payment')
                                .map(([key, template]) => `
                                <div data-action="select-template" data-template-id="${key}" class="template-selector rounded-lg p-4 bg-bg-secondary ${appState.settings.selectedReceiptTemplate === key ? 'active' : ''}">
                                    <div class="flex justify-between items-start mb-2">
                                        <h4 class="font-semibold text-text-primary capitalize pr-2">${template.name}</h4>
                                        <button data-action="preview-template" data-template-id="${key}" class="btn btn-secondary p-1 h-auto text-xs shrink-0"><i data-lucide="eye" class="w-4 h-4"></i></button>
                                    </div>
                                    <div class="h-40 bg-bg-tertiary rounded overflow-hidden pointer-events-none scale-[30%] origin-top-left -mb-28">
                                        ${template.preview}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    lucide.createIcons();
                };
                
                if (receiptSelectorContainer) {
                    receiptSelectorContainer.addEventListener('click', e => {
                        const previewTarget = e.target.closest('[data-action="preview-template"]');
                        const selectTarget = e.target.closest('[data-action="select-template"]');
                        if (previewTarget) {
                            e.stopPropagation();
                            const templateId = previewTarget.dataset.templateId;
                            showLargeReceiptPreview(templateId);
                        } else if (selectTarget) {
                            const templateId = selectTarget.dataset.templateId;
                            if (appState.settings.selectedReceiptTemplate !== templateId) {
                                appState.settings.selectedReceiptTemplate = templateId;
                                receiptSelectorContainer.querySelectorAll('[data-action="select-template"]').forEach(el => el.classList.remove('active'));
                                selectTarget.classList.add('active');
                            }
                        }
                    });
                }

                renderPosLayoutSelector();
                renderBusinessTypeSelector();
                renderReceiptSelector();
            }

            // NEW: Function to initialize the User Roles view
            function initUserRoles(pane) {
                const container = pane.querySelector('#user-roles-view-container');
                if (!container) return;

                if (appState.session.userRole !== 'admin') {
                    container.innerHTML = `<p class="text-center p-8">You do not have permission to manage user roles.</p>`;
                    return;
                }
                
                // --- NEW: State & Data for the redesigned UI ---
                let selectedRoleId = 'manager'; // Default to manager view

                const permissionGroups = {
                    'Dashboard & POS': {
                        icon: 'layout-dashboard',
                        permissions: ['canAccessDashboard', 'canUsePOS', 'canManageInvoices', 'canDirectlyVoidInvoice', 'canRequestInvoiceVoid', 'canCancelVoidRequest', 'canProcessReturns']
                    },
                    'Inventory & Products': {
                        icon: 'boxes',
                        permissions: ['canViewInventory', 'canAddProducts', 'canEditProducts', 'canDeactivateProducts', 'canDeleteProducts', 'canGenerateBarcodes']
                    },
                    'Purchasing & Suppliers': {
                        icon: 'truck',
                        permissions: ['canManageSuppliers', 'canViewPurchaseOrders', 'canCreatePurchaseOrders', 'canUpdatePurchaseOrders', 'canDeletePurchaseOrders']
                    },
                    'Sales & CRM': {
                        icon: 'users',
                        permissions: ['canManageCustomers', 'canManageQuotations', 'canDeleteQuotations', 'canConvertToInvoice', 'canManageLoyalty']
                    },
                    'Finance & Expenses': {
                        icon: 'banknote',
                        permissions: ['canAddExpenses', 'canEditExpenses', 'canDeleteExpenses', 'canManagePayroll']
                    },
                    'Reporting & Analytics': {
                        icon: 'bar-chart-3',
                        permissions: ['canAccessReports', 'canSeeAllReports', 'canViewProfitAndLoss']
                    },
                    'Administration': {
                        icon: 'shield',
                        permissions: ['canManageStaff', 'canManageRoles', 'canManageSettings', 'canManageWarranties', 'canManageSubscription', 'canInviteCashiers', 'canViewStaffPerformance', 'canRequestStaffDeactivation', 'canEditCashierDetails']
                    }
                };

                // Icons for individual permissions
                const permissionIcons = {
                    // Dashboard & POS
                    canAccessDashboard: 'layout-dashboard',
                    canUsePOS: 'terminal',
                    canManageInvoices: 'receipt-text',
                    canDirectlyVoidInvoice: 'shield-x',
                    canRequestInvoiceVoid: 'shield-alert',
                    canCancelVoidRequest: 'rotate-ccw',
                    canProcessReturns: 'undo-2',
                    
                    // Inventory & Products
                    canViewInventory: 'package-search',
                    canAddProducts: 'package-plus',
                    canEditProducts: 'edit',
                    canDeactivateProducts: 'eye-off',
                    canDeleteProducts: 'trash-2',
                    canGenerateBarcodes: 'barcode',
                    
                    // Purchasing & Suppliers
                    canManageSuppliers: 'truck',
                    canViewPurchaseOrders: 'file-text',
                    canCreatePurchaseOrders: 'file-plus-2',
                    canUpdatePurchaseOrders: 'file-pen-line',
                    canDeletePurchaseOrders: 'file-x-2',
                    
                    // Sales & CRM
                    canManageCustomers: 'contact',
                    canManageQuotations: 'file-check',
                    canDeleteQuotations: 'file-x',
                    canConvertToInvoice: 'file-plus',
                    canManageLoyalty: 'gem',
                    
                    // Finance & Expenses
                    canAddExpenses: 'plus-circle',
                    canEditExpenses: 'edit-2',
                    canDeleteExpenses: 'minus-circle',
                    canManagePayroll: 'landmark',
                    
                    // Reporting & Analytics
                    canAccessReports: 'bar-chart-3',
                    canSeeAllReports: 'users-2',
                    canViewProfitAndLoss: 'trending-up',
                    
                    // Administration
                    canManageStaff: 'user-cog',
                    canManageRoles: 'shield',
                    canManageSettings: 'settings',
                    canManageWarranties: 'shield-check',
                    canManageSubscription: 'credit-card',
                    canInviteCashiers: 'user-plus',
                    canViewStaffPerformance: 'activity',
                    canRequestStaffDeactivation: 'user-x',
                    canEditCashierDetails: 'file-pen-line'
                };

                // --- NEW: Main Render Function ---
                const renderUserRolesUI = () => {
                    const selectedRole = userRoles[selectedRoleId];
                    if (!selectedRole) return;

                    // Group permissions that actually exist for the selected role
                    const groupedPermissionsHTML = Object.entries(permissionGroups).map(([groupName, groupData]) => {
                        const permissionsInGroup = groupData.permissions.filter(p => selectedRole.permissions.hasOwnProperty(p));
                        if (permissionsInGroup.length === 0) return '';

                        // Check if all permissions in this group are enabled
                        const areAllEnabled = permissionsInGroup.every(pId => appState.settings.permissions?.[selectedRoleId]?.permissions?.[pId]?.value ?? selectedRole.permissions[pId].value);

                        return `
                        <div class="glass-pane p-6 rounded-xl">
                            <div class="flex justify-between items-center pb-4 border-b border-border-color">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="${groupData.icon}" class="w-6 h-6 text-accent"></i>
                                    <h4 class="text-lg font-semibold text-text-primary">${groupName}</h4>
                                </div>
                                <label class="toggle-switch-label" title="Toggle all in ${groupName}">
                                    <input type="checkbox" data-action="toggle-permission-group" data-group-name="${groupName}" class="sr-only toggle-switch-input" ${areAllEnabled ? 'checked' : ''}>
                                    <div class="toggle-switch-track"><div class="toggle-switch-thumb"></div></div>
                                </label>
                            </div>
                            <div class="divide-y divide-border-color">
                                ${permissionsInGroup.map(permissionId => {
                                    const perm = selectedRole.permissions[permissionId];
                                    const isChecked = appState.settings.permissions?.[selectedRoleId]?.permissions?.[permissionId]?.value ?? perm.value;
                                    return `
                                    <div class="flex items-center justify-between py-4">
                                        <div class="flex items-start gap-3">
                                            <i data-lucide="${permissionIcons[permissionId] || 'toggle-right'}" class="w-5 h-5 text-text-secondary mt-1 shrink-0"></i>
                                            <div>
                                                <label for="perm-${selectedRoleId}-${permissionId}" class="font-medium text-sm text-text-primary cursor-pointer">${permissionId.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</label>
                                                <p class="text-xs text-text-secondary">${perm.description}</p>
                                            </div>
                                        </div>
                                        <label class="toggle-switch-label">
                                            <input type="checkbox" id="perm-${selectedRoleId}-${permissionId}" data-action="toggle-permission" data-role-id="${selectedRoleId}" data-permission-id="${permissionId}" class="sr-only toggle-switch-input" ${isChecked ? 'checked' : ''}>
                                            <div class="toggle-switch-track"><div class="toggle-switch-thumb"></div></div>
                                        </label>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
                        `;
                    }).join('');
                    
                    const rolesToDisplay = { manager: userRoles.manager, cashier: userRoles.cashier };

                    container.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex flex-col md:flex-row justify-between md:items-start gap-4">
                            <div>
                                <h1 class="text-3xl font-bold text-text-primary">User Roles & Permissions</h1>
                                <p class="text-text-secondary mt-1">Define what different roles can see and do within the system.</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button data-action="reset-permissions" class="btn btn-secondary">
                                    <i data-lucide="rotate-ccw" class="w-4 h-4 mr-2"></i>Reset to Defaults
                                </button>
                                <button data-action="save-permissions" class="btn btn-primary">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>Save Changes
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-8">
                            <!-- Left: Role Selector -->
                            <div class="md:col-span-1 lg:col-span-1">
                                <div class="glass-pane p-4 rounded-xl space-y-2">
                                    ${Object.entries(rolesToDisplay).map(([roleId, role]) => `
                                        <button data-action="select-role" data-role-id="${roleId}" class="role-selector-btn ${selectedRoleId === roleId ? 'active' : ''}">
                                            <span class="capitalize font-semibold">${roleId}</span>
                                            <span class="text-xs">${role.name}</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Right: Permissions -->
                            <div class="md:col-span-2 lg:col-span-3 space-y-6">
                                ${groupedPermissionsHTML}
                            </div>
                        </div>
                    </div>`;

                    lucide.createIcons();
                };
                
                // --- NEW: Event Delegation ---
                container.addEventListener('click', e => {
                    const target = e.target.closest('[data-action]');
                    if (!target) return;
                    
                    const action = target.dataset.action;

                    if (action === 'select-role') {
                        selectedRoleId = target.dataset.roleId;
                        renderUserRolesUI();
                    }

                    if (action === 'save-permissions') {
                        const updatedData = { 'settings.permissions': appState.settings.permissions };
                        updateDoc(storeRef, updatedData)
                            .then(() => showToast('Role permissions saved successfully!', 'success'))
                            .catch(err => {
                                console.error("Error saving permissions:", err);
                                showToast('Failed to save permissions.', 'error');
                            });
                    }
                    
                    if (action === 'reset-permissions') {
                        const modal = showModal('Reset Permissions', `<p>Are you sure you want to reset all permissions for the <strong>${selectedRoleId}</strong> role to their default values? Your current changes will be lost.</p>`, 
                        `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-reset" class="btn btn-danger">Yes, Reset</button>`);
                        
                        modal.querySelector('#confirm-reset').addEventListener('click', () => {
                            const defaultPermissions = JSON.parse(JSON.stringify(userRoles[selectedRoleId].permissions));
                            appState.settings.permissions[selectedRoleId].permissions = defaultPermissions;
                            renderUserRolesUI();
                            showToast(`${selectedRoleId} permissions have been reset.`, 'info');
                            closeModal(modal);
                        });
                    }
                });
                
                container.addEventListener('change', e => {
                    const target = e.target.closest('[data-action]');
                    if (!target) return;
                    const action = target.dataset.action;

                    if (action === 'toggle-permission') {
                        const { roleId, permissionId } = target.dataset;
                        const isEnabled = target.checked;
                        if (appState.settings.permissions?.[roleId]?.permissions?.[permissionId]) {
                            appState.settings.permissions[roleId].permissions[permissionId].value = isEnabled;
                        }
                        // Refresh to update the master toggle if needed
                        renderUserRolesUI();
                    }

                    if (action === 'toggle-permission-group') {
                        const groupName = target.dataset.groupName;
                        const isEnabled = target.checked;
                        const group = permissionGroups[groupName];
                        if (group) {
                            group.permissions.forEach(permissionId => {
                                if (appState.settings.permissions?.[selectedRoleId]?.permissions?.[permissionId]) {
                                    appState.settings.permissions[selectedRoleId].permissions[permissionId].value = isEnabled;
                                }
                            });
                        }
                        // Refresh to update all toggles in the group
                        renderUserRolesUI();
                    }
                });

                // Initial Render
                renderUserRolesUI();
            }

            async function openCustomerModal(customerId = null, callback = null) {
    const customer = customerId ? firestoreData.customers.find(c => c.id === customerId) : {};
    const isEditing = !!customerId;
    const creditLimitInDisplay = isEditing ? currencyUtils.convert(customer.creditLimit || 0) : '';

    const userRole = appState.session.userRole;
    const isAdmin = userRole === 'admin';
    const isManager = userRole === 'manager';

    const canEditCredit = isAdmin || isManager;
    const canEditLoyalty = isAdmin;
    // --- UPDATED: Check tier settings ---
    const canAssignTier = (isAdmin || isManager) && (firestoreData.loyaltySettings?.tiersEnabled || false);
    const tiers = firestoreData.loyaltySettings?.loyaltyTiers || [];
    // --- END UPDATED ---

    const creditLimitValue = typeof creditLimitInDisplay === 'number' ? creditLimitInDisplay.toFixed(2) : creditLimitInDisplay;

    // --- UPDATED: Tier Selector HTML ---
    let tierSelectorHTML = '';
    if (canAssignTier) {
        tierSelectorHTML = `
        <div>
            <label class="block text-sm font-medium text-text-secondary mb-1">Loyalty Tier</label>
            <select name="loyaltyTierId" class="w-full form-select">
                <option value="" ${!customer.loyaltyTierId ? 'selected' : ''}>None</option>
                ${tiers.map(t => `<option value="${t.id}" ${customer.loyaltyTierId === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}
            </select>
            <p class="text-xs text-text-secondary mt-1">Manually assign or change tier.</p>
        </div>
        `;
    } else if (isEditing && customer.loyaltyTierId) {
        // Show current tier if tiers are disabled but customer had one assigned
        const currentTier = tiers.find(t=> t.id === customer.loyaltyTierId);
        tierSelectorHTML = `
         <div>
            <label class="block text-sm font-medium text-text-secondary mb-1">Loyalty Tier</label>
            <input type="text" value="${currentTier?.name || 'Unknown Tier'}" class="w-full form-input bg-bg-tertiary" readonly title="Tier system is currently disabled">
        </div>`;
    }
    // --- END UPDATED ---
// --- NEW: Staff & Lifetime Discount Fields HTML (Admin only) ---
    let adminDiscountFieldsHTML = '';
    if (isAdmin) {
        adminDiscountFieldsHTML = `
            <div>
                <label class="block text-sm font-medium text-text-secondary mb-1">Staff Discount (%)</label>
                <input type="number" name="staffDiscountPercent" value="${customer.staffDiscountPercent || ''}" class="w-full form-input" placeholder="e.g., 15">
            </div>
            <div>
                <label class="block text-sm font-medium text-text-secondary mb-1">Lifetime Discount (%)</label>
                <input type="number" name="lifetimeDiscountPercent" value="${customer.lifetimeDiscountPercent || ''}" class="w-full form-input" placeholder="e.g., 10">
            </div>
        `;
    }
    // --- END NEW ---
    const content = `<form id="customer-form" class="space-y-4">
        <div><label class="block text-sm font-medium text-text-secondary mb-1">Full Name</label><input type="text" name="name" value="${customer.name || ''}" class="w-full form-input" required></div>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-text-secondary mb-1">Email</label>
                <input type="email" name="email" value="${customer.email || ''}" class="w-full form-input">
                ${!isEditing ? '<div id="email-check-status" class="text-xs h-4 mt-1"></div>' : ''}
            </div>
            <div>
                <label class="block text-sm font-medium text-text-secondary mb-1">Phone</label>
                <input type="tel" name="phone" value="${customer.phone || ''}" class="w-full form-input">
                ${!isEditing ? '<div id="phone-check-status" class="text-xs h-4 mt-1"></div>' : ''}
            </div>
        </div>
        <div><label class="block text-sm font-medium text-text-secondary mb-1">Address</label><input type="text" name="address" value="${customer.address || ''}" class="w-full form-input"></div>
        
        <div class="border-t border-border-color pt-4 grid grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-text-secondary mb-1">Loyalty ID</label><input type="text" name="loyaltyId" value="${customer.loyaltyId || `CS-${(customer.name || 'CUST').substring(0,2).toUpperCase()}-${Date.now().toString().slice(-3)}`}" class="w-full form-input ${!canEditLoyalty ? 'bg-bg-tertiary' : ''}" ${!canEditLoyalty ? 'readonly' : ''}></div>
            <div><label class="block text-sm font-medium text-text-secondary mb-1">Credit Limit (${appState.currentCurrency})</label><input type="number" name="creditLimit" value="${creditLimitValue}" class="w-full form-input ${!canEditCredit ? 'bg-bg-tertiary' : ''}" ${!canEditCredit ? 'readonly' : ''} placeholder="Optional"></div>
            ${tierSelectorHTML}
            ${adminDiscountFieldsHTML}
        </div>
    </form>`;
    const footer = `<button type="button" data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="customer-form" class="btn btn-primary">${isEditing ? 'Save Changes' : 'Create Customer'}</button>`;
    const modal = showModal(isEditing ? 'Edit Customer' : 'Add New Customer', content, footer, { size: 'max-w-2xl' });

    // --- UPDATED: Real-time duplicate check for new customers ---
    if (!isEditing) {
        const phoneInput = modal.querySelector('input[name="phone"]');
        const emailInput = modal.querySelector('input[name="email"]');
        const phoneStatusEl = modal.querySelector('#phone-check-status');
        const emailStatusEl = modal.querySelector('#email-check-status');
        
        let phoneDebounce, emailDebounce;

        const performCheck = (field, value, statusEl) => {
            if (value.length < 5) { // Don't check for very short values (e.g., "a@b.c" is min 5)
                statusEl.textContent = '';
                return;
            }
            
            statusEl.textContent = 'Checking...';
            statusEl.classList.remove('text-green-400', 'text-yellow-400');

            // Find by exact match on the specific field
            const existingCustomer = firestoreData.customers.find(c => c[field] && c[field] === value);
            
            if (existingCustomer) {
                // Found a match. Close this modal and open the "Edit" modal.
                statusEl.textContent = 'Customer found! Loading...';
                statusEl.classList.add('text-yellow-400');
                showToast(`Existing customer found with this ${field}! Loading their details...`, 'info');
                
                setTimeout(() => {
                    closeModal(modal);
                    // Re-open the modal in "edit" mode for that customer
                    openCustomerModal(existingCustomer.id, callback);
                }, 750); // Short delay to read the message
            } else {
                // No match found.
                statusEl.textContent = `This ${field} is available.`;
                statusEl.classList.add('text-green-400');
            }
        };

        phoneInput.addEventListener('input', () => {
            clearTimeout(phoneDebounce);
            const phoneValue = phoneInput.value.trim();
            phoneDebounce = setTimeout(() => {
                if(phoneValue) performCheck('phone', phoneValue, phoneStatusEl);
                else phoneStatusEl.textContent = '';
            }, 500); // 500ms debounce
        });
        
        emailInput.addEventListener('input', () => {
            clearTimeout(emailDebounce);
            const emailValue = emailInput.value.trim();
            emailDebounce = setTimeout(() => {
                // Basic email validation before checking
                if(emailValue && emailValue.includes('@') && emailValue.includes('.')) {
                    performCheck('email', emailValue, emailStatusEl);
                }
                else {
                    emailStatusEl.textContent = '';
                }
            }, 500); // 500ms debounce
        });
    }
    // --- END UPDATED ---

    modal.querySelector('#customer-form').addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const formData = new FormData(ev.target);
        const customerName = formData.get('name'); // Get name for auto tier assignment

        // --- UPDATED: Determine Tier for New Customers ---
        let initialTierId = null;
        if (!isEditing && (firestoreData.loyaltySettings?.tiersEnabled || false)) {
            const tiers = firestoreData.loyaltySettings?.loyaltyTiers || [];
            // Find the lowest tier (assuming sorted by points)
            const lowestTier = tiers.length > 0 ? tiers[0] : null;
            if (lowestTier && lowestTier.pointsThreshold === 0) {
                initialTierId = lowestTier.id; // Assign base tier if points threshold is 0
            }
        }
        // --- END UPDATED ---

        if (isEditing) {
            const dataToUpdate = {
                name: customerName,
                email: formData.get('email'),
                phone: formData.get('phone'),
                address: formData.get('address'),
            };

            if (canEditCredit) {
                const creditLimitInDisplay = parseFloat(formData.get('creditLimit'));
                dataToUpdate.creditLimit = !isNaN(creditLimitInDisplay) ? currencyUtils.convertToBase(creditLimitInDisplay) : null;
            }
            if (canEditLoyalty) {
                dataToUpdate.loyaltyId = formData.get('loyaltyId');
            }
            // --- UPDATED: Save Tier ---
            if (canAssignTier) {
                dataToUpdate.loyaltyTierId = formData.get('loyaltyTierId') || null;
            }
            // --- END UPDATED ---
            // --- NEW: Save Staff/Lifetime Discounts ---
            if (isAdmin) {
                dataToUpdate.staffDiscountPercent = parseFloat(formData.get('staffDiscountPercent')) || 0;
                dataToUpdate.lifetimeDiscountPercent = parseFloat(formData.get('lifetimeDiscountPercent')) || 0;
            }
            // --- END NEW ---
            try {
                await updateDoc(doc(customersRef, customerId), dataToUpdate);
                showToast(`Customer updated successfully!`);
                closeModal(modal);
            } catch(error) {
                console.error("Error updating customer:", error);
                showToast("Failed to update customer.", "error");
            };

        } else { // Creating new customer
            // --- UPDATED: Final submit-time check for phone AND email ---
            const phoneOnSubmit = formData.get('phone').trim();
            const emailOnSubmit = formData.get('email').trim();

            if (phoneOnSubmit) {
                const existingCustomer = firestoreData.customers.find(c => c.phone && c.phone === phoneOnSubmit);
                if (existingCustomer) {
                    showToast(`A customer with this phone number already exists (${existingCustomer.name}).`, 'error');
                    closeModal(modal);
                    openCustomerModal(existingCustomer.id, callback);
                    return; // Stop the submission
                }
            }
            
            if (emailOnSubmit) {
                const existingCustomer = firestoreData.customers.find(c => c.email && c.email === emailOnSubmit);
                if (existingCustomer) {
                    showToast(`A customer with this email address already exists (${existingCustomer.name}).`, 'error');
                    closeModal(modal);
                    openCustomerModal(existingCustomer.id, callback);
                    return; // Stop the submission
                }
            }
            // --- END UPDATED ---

            const dataToCreate = {
                name: customerName,
                email: formData.get('email'),
                phone: formData.get('phone'),
                address: formData.get('address'),
                loyaltyPoints: 0,
                currentDue: 0,
                joinDate: new Date().toISOString(),
                // --- UPDATED: Set Initial Tier ---
                loyaltyTierId: initialTierId
            };

            if (canEditLoyalty) {
                dataToCreate.loyaltyId = formData.get('loyaltyId');
            } else {
                dataToCreate.loyaltyId = `CS-${(customerName || 'CUST').substring(0,2).toUpperCase()}-${Date.now().toString().slice(-3)}`;
            }

            if (canEditCredit) {
                const creditLimitInDisplay = parseFloat(formData.get('creditLimit'));
                dataToCreate.creditLimit = !isNaN(creditLimitInDisplay) ? currencyUtils.convertToBase(creditLimitInDisplay) : null;
            } else {
                dataToCreate.creditLimit = null;
            }
            // --- UPDATED: Save Tier for New Customer ---
            if (canAssignTier) {
                // Use manually selected tier OR the determined initial tier
                dataToCreate.loyaltyTierId = formData.get('loyaltyTierId') || initialTierId;
            }
            // --- END UPDATED ---
            // --- NEW: Save Staff/Lifetime Discounts ---
            if (isAdmin) {
                dataToCreate.staffDiscountPercent = parseFloat(formData.get('staffDiscountPercent')) || 0;
                dataToCreate.lifetimeDiscountPercent = parseFloat(formData.get('lifetimeDiscountPercent')) || 0;
            } else {
                dataToCreate.staffDiscountPercent = 0;
                dataToCreate.lifetimeDiscountPercent = 0;
            }
            // --- END NEW ---
            try {
                const docRef = await addDoc(customersRef, dataToCreate);
                if (callback) callback({ id: docRef.id, ...dataToCreate });
                showToast(`Customer added successfully!`);
                closeModal(modal);
            } catch (error) {
                 console.error("Error adding customer:", error);
                 showToast("Failed to add new customer.", "error");
                 closeModal(modal);
            };
        }
    });
}

            // NEW FUNCTION to show a customer's invoices in a modal
            function openCustomerInvoicesModal(customerId) {
                const customer = firestoreData.customers.find(c => c.id === customerId);
                if (!customer) {
                    showToast('Customer not found.', 'error');
                    return;
                }

                const customerInvoices = firestoreData.invoices
                    .filter(inv => inv.customerId === customerId)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                const getStatusBadge = (status) => {
                    const base = "px-2 py-0.5 text-xs font-semibold rounded-full inline-block";
                    if (status === 'Paid') return `${base} bg-green-500/20 text-green-300`;
                    if (status === 'Due') return `${base} bg-red-500/20 text-red-300`;
                    if (status === 'Partial') return `${base} bg-yellow-500/20 text-yellow-300`;
                    if (status === 'Void') return `${base} bg-red-900/40 text-red-400 border border-red-500/50`;
                    return `${base} bg-gray-500/20 text-gray-300`;
                };

                const content = `
                    <div class="space-y-4">
                        <p>Showing invoice history for <strong class="text-text-primary">${customer.name}</strong>.</p>
                        <div class="max-h-[60vh] overflow-y-auto -mx-6">
                            <table class="w-full text-sm">
                                <thead class="sticky top-0 bg-bg-secondary z-10">
                                    <tr class="text-left text-text-secondary uppercase text-xs">
                                        <th class="px-6 py-3 font-medium">Invoice ID</th>
                                        <th class="px-6 py-3 font-medium">Date</th>
                                        <th class="px-6 py-3 font-medium">Status</th>
                                        <th class="px-6 py-3 font-medium text-right">Total</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-border-color">
                                    ${customerInvoices.length ? customerInvoices.map(inv => `
                                        <tr class="hover:bg-bg-tertiary">
                                            <td class="px-6 py-3 font-mono">${inv.id}</td>
                                            <td class="px-6 py-3">${new Date(inv.date).toLocaleDateString()}</td>
                                            <td class="px-6 py-3"><span class="${getStatusBadge(inv.status)}">${inv.status}</span></td>
                                            <td class="px-6 py-3 text-right font-mono">${currencyUtils.format(inv.totalInBaseCurrency, inv.currency)}</td>
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="4" class="text-center p-8 text-text-secondary">No invoices found for this customer.</td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                const footer = `<button data-action="close-modal" class="btn btn-secondary">Close</button>`;
                showModal(`Invoice History: ${customer.name}`, content, footer, { size: 'max-w-3xl', customClasses: 'p-0' });
            }

async function openReceivePaymentModal(customerId) {
    const customer = firestoreData.customers.find(c => c.id === customerId);
    if (!customer) {
        showToast('Customer not found.', 'error');
        return;
    }
    const currentDueInBase = customer.currentDue || 0;
    if (currentDueInBase <= 0) {
        showToast(`${customer.name} has no outstanding balance.`, 'info');
        return;
    }
    const currentDueInDisplay = currencyUtils.convert(currentDueInBase);

    const content = `
        <form id="receive-payment-form" class="space-y-4">
            <p>Receiving payment for: <strong class="text-text-primary">${customer.name}</strong></p>
            <p class="text-lg">Current Due: <span class="font-mono font-bold text-red-400">${currencyUtils.format(currentDueInBase)}</span></p>
            <div>
                <label class="block text-sm font-medium text-text-secondary mb-1">Payment Amount (in ${appState.currentCurrency})</label>
                <input type="number" name="amount" value="${currentDueInDisplay.toFixed(2)}" step="0.01" class="form-input w-full text-lg" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-text-secondary mb-1">Payment Method</label>
                <select name="paymentMethod" class="form-select w-full">
                    <option value="Cash">Cash</option>
                    <option value="Card">Card</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-text-secondary mb-1">Notes</label>
                <textarea name="notes" class="form-textarea w-full" placeholder="e.g., Payment for invoice #..."></textarea>
            </div>
        </form>
    `;
    const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="receive-payment-form" class="btn btn-primary">Receive Payment</button>`;
    const modal = showModal('Receive Due Payment', content, footer);

    modal.querySelector('#receive-payment-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const amountInDisplay = parseFloat(formData.get('amount'));
        const notes = formData.get('notes');
        const paymentMethod = formData.get('paymentMethod');

        if (isNaN(amountInDisplay) || amountInDisplay <= 0) {
            showToast('Please enter a valid payment amount.', 'error');
            return;
        }
        
        const amountInBase = currencyUtils.convertToBase(amountInDisplay);

        if (amountInBase > (currentDueInBase + 0.001)) { // Tolerance for float issues
            showToast('Payment cannot be greater than the due amount.', 'error');
            return;
        }
        
        try {
            let paymentReceiptData;

            await runTransaction(db, async (transaction) => {
                // --- STAGE 1: ALL READS MUST HAPPEN FIRST ---
                const customerRef = doc(customersRef, customerId);
                const customerDoc = await transaction.get(customerRef);
                if (!customerDoc.exists()) throw new Error("Customer not found during transaction.");

                // CORRECT: Query for outstanding invoices INSIDE the transaction
                const invoicesQuery = query(invoicesRef,
                    where("customerId", "==", customerId),
                    where("status", "in", ["Due", "Partial"])
                );
                const outstandingInvoicesSnapshot = await getDocs(invoicesQuery);
                const outstandingInvoices = outstandingInvoicesSnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                if (outstandingInvoices.length === 0) {
                    throw new Error("No outstanding invoices found for this customer during transaction.");
                }

                // --- STAGE 2: ALL WRITES CAN HAPPEN NOW ---
                const customerData = customerDoc.data();
                let paymentToApply = amountInBase;
                let newCustomerDue = customerData.currentDue || 0;
                const appliedToInvoices = [];

                for (const invoice of outstandingInvoices) {
                    if (paymentToApply <= 0) break;
                    
                    const invoiceRef = doc(invoicesRef, invoice.id);
                    const amountToPayOnInvoice = Math.min(paymentToApply, invoice.dueAmount);
                    
                    const amountInInvoiceCurrency = currencyUtils.convert(amountToPayOnInvoice, invoice.currency);
                    
                    const newInvoiceDue = invoice.dueAmount - amountToPayOnInvoice;
                    const newStatus = newInvoiceDue < 0.001 ? 'Paid' : 'Partial';
                    
                    const paymentRecord = {
                        amount: amountInInvoiceCurrency,
                        date: new Date().toISOString(),
                        method: paymentMethod,
                        notes: notes,
                        isDuePayment: true
                    };

                    transaction.update(invoiceRef, { 
                        dueAmount: newInvoiceDue,
                        status: newStatus,
                        paymentDetails: [...(invoice.paymentDetails || []), paymentRecord]
                    });
                    
                    paymentToApply -= amountToPayOnInvoice;
                    newCustomerDue -= amountToPayOnInvoice;
                    appliedToInvoices.push({ id: invoice.id, amount: amountToPayOnInvoice });
                }
                
                transaction.update(customerRef, { currentDue: Math.max(0, newCustomerDue) });
                
                paymentReceiptData = {
                    customer: customer,
                    amountPaid: amountInBase,
                    method: paymentMethod,
                    date: new Date().toISOString(),
                    notes: notes,
                    appliedTo: appliedToInvoices,
                    newBalance: Math.max(0, newCustomerDue)
                };
            });

            await createNotification('sale', `Received payment of <strong>${currencyUtils.format(amountInBase)}</strong> from <strong>${customer.name}</strong>. New balance: ${currencyUtils.format(paymentReceiptData.newBalance)}.`);
            
            showToast('Payment received successfully!', 'success');
            closeModal(modal);
            showPaymentReceipt(paymentReceiptData);

        } catch (error) {
            console.error("Failed to receive payment:", error);
            showToast(`An error occurred: ${error.message}`, 'error');
        }
    });
}
            const showPaymentReceipt = (receiptData) => {
                const template = receiptTemplates['payment'];
                if (!template) {
                    console.error("Payment receipt template is missing.");
                    showToast("Cannot generate payment receipt.", "error");
                    return;
                }
                const content = template.getBody(receiptData);
                const footer = `<button data-action="close-modal" class="btn btn-secondary">Close</button><button id="print-payment-receipt" class="btn btn-primary"><i data-lucide="printer" class="w-4 h-4 mr-2"></i>Print</button>`;
                const modal = showModal('Payment Confirmation', content, footer, {size: 'max-w-2xl', customClasses: 'p-0'});
                lucide.createIcons();
                modal.querySelector('#print-payment-receipt').addEventListener('click', () => {
                    printElement('receipt-content');
                });
            };
            function openEditCartItemModal(itemId, serialNumber) {
                const activeSale = posState.sales.find(s => s.id === posState.activeSaleId);
                if (!activeSale) return;

                const itemIndex = activeSale.cart.findIndex(i => i.isSerialized ? i.serialNumber === serialNumber : i.id === itemId);
                if (itemIndex === -1) return;

                const item = activeSale.cart[itemIndex];
                if (item.originalPrice === undefined) {
                    item.originalPrice = item.price;
                }
                
                const uom = firestoreData.unitsOfMeasurement.find(u => u.id === item.uomId) || { name: 'units', allowsDecimal: false };
                const qtyStep = uom.allowsDecimal ? '0.01' : '1';

                const displayCurrencyCode = appState.currentCurrency;
                const displayCurrencyInfo = currencyUtils.get(displayCurrencyCode);
                const priceInDisplay = currencyUtils.convert(item.price, displayCurrencyCode);
                
                let discountValueForDisplay = item.discount?.value || '';
                if (item.discount?.type === 'fixed' && item.discount.value) {
                    discountValueForDisplay = currencyUtils.convert(item.discount.value, displayCurrencyCode).toFixed(2);
                }

                const content = `
                <form id="edit-cart-item-form" class="space-y-4">
                    <p class="text-lg font-medium text-text-primary">${item.name}</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Quantity</label>
                            <input type="number" step="${qtyStep}" name="qty" value="${item.qty}" class="w-full form-input" ${item.isSerialized ? 'readonly' : ''}>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Unit Price (in ${displayCurrencyCode})</label>
                            <input type="number" step="0.01" name="price" value="${priceInDisplay.toFixed(2)}" class="w-full form-input">
                            <p class="text-xs text-text-secondary mt-1">Original: ${currencyUtils.format(item.originalPrice, displayCurrencyCode)}</p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-secondary mb-1">Line Item Discount (Overrides Price)</label>
                        <div class="flex">
                            <select name="discountType" class="form-select rounded-r-none w-20">
                                <option value="fixed" ${item.discount?.type === 'fixed' ? 'selected' : ''}>${displayCurrencyInfo.symbol}</option>
                                <option value="percent" ${item.discount?.type === 'percent' ? 'selected' : ''}>%</option>
                            </select>
                            <input type="number" step="0.01" name="discountValue" value="${discountValueForDisplay}" placeholder="e.g., 5 or 10.50" class="w-full form-input rounded-l-none">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-secondary mb-1">Notes</label>
                        <textarea name="notes" class="form-textarea w-full h-20" placeholder="e.g., Customer requested gift wrap">${item.notes || ''}</textarea>
                    </div>
                </form>
                `;
                const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="edit-cart-item-form" class="btn btn-primary">Apply Changes</button>`;
                const modal = showModal('Edit Item Details', content, footer);

                modal.querySelector('#edit-cart-item-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    
                    const newQty = parseFloat(formData.get('qty'));
                    const manualPriceInDisplay = parseFloat(formData.get('price'));
                    const discountType = formData.get('discountType');
                    const discountValueInDisplay = parseFloat(formData.get('discountValue'));
                    const notes = formData.get('notes');

                    const editedItem = activeSale.cart[itemIndex];
                    editedItem.qty = newQty;
                    editedItem.notes = notes;

                    if (!isNaN(discountValueInDisplay) && discountValueInDisplay > 0) {
                        if (discountType === 'percent') {
                            editedItem.discount = { type: discountType, value: discountValueInDisplay };
                            editedItem.price = editedItem.originalPrice * (1 - (discountValueInDisplay / 100));
                        } else { // fixed discount
                            const discountValueInBase = currencyUtils.convertToBase(discountValueInDisplay);
                            editedItem.discount = { type: discountType, value: discountValueInBase };
                            editedItem.price = Math.max(0, editedItem.originalPrice - discountValueInBase);
                        }
                    } else {
                        delete editedItem.discount;
                        editedItem.price = currencyUtils.convertToBase(manualPriceInDisplay);
                    }
                    
                    posFullRender(workspaceContent.querySelector('.view-pane'));
                    closeModal(modal);
                    showToast(`${editedItem.name} updated in cart.`, 'info');
                });
            }

            function openStockAdjustmentModal(productId) {
                const product = firestoreData.products.find(p => p.id === productId);
                if (!product) {
                    showToast('Product not found for stock adjustment.', 'error');
                    return;
                }

                const content = `
                    <form id="stock-adjustment-form" class="space-y-4">
                        <p>Adjusting stock for: <strong class="text-text-primary">${product.name}</strong></p>
                        <p>Current Stock: <span class="font-mono text-accent">${product.stock} ${product.uomId}</span></p>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Adjustment Type</label>
                            <select name="adjustmentType" class="form-select w-full">
                                <option value="add">Add to Stock</option>
                                <option value="remove">Remove from Stock</option>
                                <option value="set">Set New Quantity</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Quantity</label>
                            <input type="number" name="quantity" class="form-input w-full" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Reason / Notes</label>
                            <textarea name="notes" class="form-textarea w-full" placeholder="e.g., Physical count correction, Damaged goods"></textarea>
                        </div>
                    </form>
                `;
                const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="stock-adjustment-form" class="btn btn-primary">Apply Adjustment</button>`;
                const modal = showModal('Stock Adjustment', content, footer);

                modal.querySelector('#stock-adjustment-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const type = formData.get('adjustmentType');
                    const quantity = parseFloat(formData.get('quantity'));
                    const notes = formData.get('notes');

                    if (isNaN(quantity) || quantity < 0) {
                        showToast('Please enter a valid, non-negative quantity.', 'error');
                        return;
                    }

                    let newStock;
                    switch (type) {
                        case 'add':
                            newStock = (product.stock || 0) + quantity;
                            break;
                        case 'remove':
                            newStock = Math.max(0, (product.stock || 0) - quantity);
                            break;
                        case 'set':
                            newStock = quantity;
                            break;
                    }

                    showToast(`Stock for ${product.name} adjusted to ${newStock}.`, 'success');
                    closeModal(modal);

                    // NEW: If a manager adjusts stock, create an audit log and notify the admin.
                    if (appState.session.userRole === 'manager') {
                        const managerName = appState.session.currentUser.name;
                        const term = getCurrentProfile().terminology;
                        const logDetails = `Manager '${managerName}' adjusted stock for ${term.product} '${product.name}'. Type: ${type}, Quantity: ${quantity}. New stock: ${newStock}. Notes: ${notes || 'N/A'}`;
                        const notificationMessage = `Manager <strong>${managerName}</strong> adjusted stock for <strong>${product.name}</strong>.`;

                        // 1. Create Audit Log
                        addDoc(auditLogRef, {
                            type: 'inventory_adjustment',
                            timestamp: new Date().toISOString(),
                            productId: product.id,
                            productName: product.name,
                            details: logDetails,
                            user: {
                                id: appState.session.currentUser.uid,
                                name: managerName
                            }
                        }).catch(console.error);

                        // 2. Create Notification for Admin
                        createNotification('info', notificationMessage, { targetRoles: ['admin'] });
                    }

                    updateDoc(doc(productsRef, productId), { stock: newStock }).catch(error => {
                        console.error("Failed to adjust stock:", error);
                        showToast(`Error adjusting stock for ${product.name}.`, 'error');
                    });
                });
            }

            function openReceiveStockModal(productId = null) {
                const product = productId ? firestoreData.products.find(p => p.id === productId) : null;
                if (productId && !product) {
                    showToast('Product not found.', 'error');
                    return;
                }
                if (product && product.productType !== 'physical') {
                    showToast('Cannot adjust stock for a service item.', 'info');
                    return;
                }

                let productSelectorHTML = '';
                if (!productId) {
                    productSelectorHTML = `
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Product</label>
                            <select name="productId" class="form-select w-full" required>
                                <option value="" disabled selected>Select a product...</option>
                                ${firestoreData.products.filter(p => p.productType === 'physical').map(p => `<option value="${p.id}">${p.name} (${p.id})</option>`).join('')}
                            </select>
                        </div>
                    `;
                }

                const content = `
                    <form id="receive-stock-form" class="space-y-4">
                        <p>Adding new stock. Current quantities will be increased.</p>
                        ${productSelectorHTML}
                        ${productId ? `<p>Receiving stock for: <strong class="text-text-primary">${product.name}</strong></p><p>Current Stock: <span class="font-mono text-accent">${product.stock} ${product.uomId}</span></p>` : ''}
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Quantity to Add</label>
                            <input type="number" name="quantity" class="form-input w-full" required min="0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Reason / Notes</label>
                            <textarea name="notes" class="form-textarea w-full" placeholder="e.g., Received from supplier, Initial stock"></textarea>
                        </div>
                    </form>
                `;
                const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="receive-stock-form" class="btn btn-primary">Add to Stock</button>`;
                const modal = showModal('Receive Stock', content, footer);

                modal.querySelector('#receive-stock-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const selectedProductId = productId || formData.get('productId');
                    const productToUpdate = firestoreData.products.find(p => p.id === selectedProductId);

                    if (!productToUpdate) {
                        showToast('Product not selected or found.', 'error');
                        return;
                    }

                    const quantity = parseFloat(formData.get('quantity'));
                    const notes = formData.get('notes');

                    if (isNaN(quantity) || quantity <= 0) {
                        showToast('Please enter a valid, positive quantity.', 'error');
                        return;
                    }

                    const newStock = (productToUpdate.stock || 0) + quantity;

                    showToast(`Stock for ${productToUpdate.name} increased by ${quantity}. New total: ${newStock}.`, 'success');
                    closeModal(modal);

                    // NEW: If a manager receives stock, create an audit log and notify the admin.
                    if (appState.session.userRole === 'manager') {
                        const managerName = appState.session.currentUser.name;
                        const term = getCurrentProfile().terminology;
                        const logDetails = `Manager '${managerName}' received stock for ${term.product} '${productToUpdate.name}'. Quantity added: ${quantity}. New stock: ${newStock}. Notes: ${notes || 'N/A'}`;
                        const notificationMessage = `Manager <strong>${managerName}</strong> received stock for <strong>${productToUpdate.name}</strong>.`;

                        // 1. Create Audit Log
                        addDoc(auditLogRef, {
                            type: 'inventory_receive',
                            timestamp: new Date().toISOString(),
                            productId: productToUpdate.id,
                            productName: productToUpdate.name,
                            details: logDetails,
                            user: {
                                id: appState.session.currentUser.uid,
                                name: managerName
                            }
                        }).catch(console.error);

                        // 2. Create Notification for Admin
                        createNotification('info', notificationMessage, { targetRoles: ['admin'] });
                    }

                    updateDoc(doc(productsRef, selectedProductId), { stock: newStock }).catch(error => {
                        console.error("Failed to receive stock:", error);
                        showToast(`Error receiving stock for ${productToUpdate.name}.`, 'error');
                    });
                });
            }

            function openEmailInvoiceModal(invoiceId) {
                const invoice = firestoreData.invoices.find(i => i.id === invoiceId);
                if (!invoice) return;

                const customer = invoice.customerId ? firestoreData.customers.find(c => c.id === invoice.customerId) : null;
                const customerEmail = customer?.email || '';

                const content = `
                    <form id="email-invoice-form" class="space-y-4">
                        <p>Send invoice <strong class="text-text-primary font-mono">${invoice.id}</strong> to:</p>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Recipient Email</label>
                            <input type="email" name="email" value="${customerEmail}" class="form-input w-full" placeholder="Enter email address" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Message (Optional)</label>
                            <textarea name="message" class="form-textarea w-full h-24">Here is your invoice from ${firestoreData.storeInfo.name}. Thank you for your business!</textarea>
                        </div>
                    </form>
                `;
                const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="email-invoice-form" class="btn btn-primary"><i data-lucide="send" class="w-4 h-4 mr-2"></i>Send Email</button>`;
                const modal = showModal('Email Invoice', content, footer);
                lucide.createIcons();
                
                modal.querySelector('#email-invoice-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const email = e.target.querySelector('[name="email"]').value;
                    showToast(`Invoice sent to ${email}.`, 'success');
                    closeModal(modal);
                });
            }

            const toggleMobileSidebar = (forceClose = false) => {
                const isOpen = sidebar.classList.contains('mobile-open');
                if (forceClose || isOpen) {
                    sidebar.classList.remove('mobile-open');
                    sidebarBackdrop.classList.add('hidden');
                } else {
                    sidebar.classList.add('mobile-open');
                    sidebarBackdrop.classList.remove('hidden');
                }
            };

            const checkScreenSize = () => {
                const isMobile = window.innerWidth < 1024;
                if (isMobile) {
                    toggleMobileSidebar(true); 
                    sidebar.classList.remove('sidebar-collapsed', 'w-20');
                    sidebar.classList.add('w-64');
                    sidebarToggleBtn.innerHTML = `<i data-lucide="menu" class="w-6 h-6"></i>`;
                } else {
                     // On desktop, respect the persisted state
                    sidebar.classList.toggle('w-64', !appState.isSidebarCollapsed);
                    sidebar.classList.toggle('w-20', appState.isSidebarCollapsed);
                    sidebar.classList.toggle('sidebar-collapsed', appState.isSidebarCollapsed);
                    sidebarToggleBtn.innerHTML = `<i data-lucide="${appState.isSidebarCollapsed ? 'panel-right-close' : 'panel-left-close'}" class="w-6 h-6"></i>`;
                }
                lucide.createIcons();
            };
            
            function showShortcutsModal() {
                const term = getCurrentProfile().terminology;
                const shortcuts = [
                    { scope: 'Global', key: ' / Ctrl + K', desc: 'Open universal search' },
                    // { scope: 'Global', key: 'Alt + Q', desc: 'Open AI Assistant' },
                    { scope: 'Global', key: 'Alt + W', desc: 'Close all open tabs' },
                    { scope: 'Global', key: '?', desc: 'Show this shortcuts guide' },
                    { scope: 'Global', key: 'Escape', desc: 'Close modals & menus' },
                    { scope: 'Navigation', key: 'Alt + D', desc: 'Go to Dashboard' },
                    { scope: 'Navigation', key: 'Alt + P', desc: 'Go to POS Terminal' },
                    { scope: 'Navigation', key: 'Alt + I', desc: 'Go to Invoices' },
                    { scope: 'Navigation', key: 'Alt + N', desc: `Go to ${term.inventory}` },
                    { scope: 'Navigation', key: 'Alt + C', desc: 'Go to Customers' },
                    { scope: 'Navigation', key: 'Alt + R', desc: 'Go to Reports' },
                    { scope: 'Navigation', key: 'Alt + S', desc: 'Go to Settings' },
                    { scope: 'Navigation', key: 'Alt + U', desc: 'Go to User Roles' },
                    { scope: 'Navigation', key: 'Alt + T', desc: 'Go to Staff' },
                    { scope: 'Navigation', key: 'Alt + E', desc: 'Go to Expenses' },
                    { scope: 'Navigation', key: 'Alt + L', desc: 'Go to Suppliers' },
                    { scope: 'Navigation', key: 'Alt + O', desc: 'Go to Purchase Orders' },
                    { scope: 'Navigation', key: 'Alt + B', desc: 'Go to Barcode Generator' },
                    { scope: 'POS Terminal', key: 'F2 / Ctrl + I', desc: `Focus ${term.product} search` },
                    { scope: 'POS Terminal', key: 'F4 / Ctrl + P', desc: 'Open Payment screen' },
                    { scope: 'POS Terminal', key: 'Alt + A', desc: 'Add Customer to sale' },
                    { scope: 'POS Terminal', key: 'Alt + N', desc: 'Create a new sale tab' },
                    { scope: 'Forms', key: ' / Ctrl + S', desc: 'Save changes in forms' },
                ];

                const groupedShortcuts = shortcuts.reduce((acc, s) => {
                    (acc[s.scope] = acc[s.scope] || []).push(s);
                    return acc;
                }, {});

                let content = Object.entries(groupedShortcuts).map(([scope, list]) => `
                    <h4 class="font-semibold text-text-primary mt-4 mb-2 text-lg">${scope}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-sm">
                        ${list.map(s => `
                            <div class="flex justify-between items-center py-1">
                                <span class="text-text-secondary">${s.desc}</span>
                                <kbd class="font-sans text-xs border border-border-color-strong rounded px-2 py-1 bg-bg-tertiary text-text-primary">${s.key}</kbd>
                            </div>
                        `).join('')}
                    </div>
                `).join('');

                    showModal('Keyboard Shortcuts', content, `<button data-action="close-modal" class="btn btn-secondary">Close</button>`, { size: 'max-w-3xl' });
            }

            sidebarToggleBtn.addEventListener('click', () => {
                if (window.innerWidth < 1024) {
                    toggleMobileSidebar();
                } else {
                    appState.isSidebarCollapsed = !appState.isSidebarCollapsed;
                    sidebar.classList.toggle('w-64', !appState.isSidebarCollapsed);
                    sidebar.classList.toggle('w-20', appState.isSidebarCollapsed);
                    sidebar.classList.toggle('sidebar-collapsed', appState.isSidebarCollapsed);
                    sidebarToggleBtn.innerHTML = `<i data-lucide="${appState.isSidebarCollapsed ? 'panel-right-close' : 'panel-left-close'}" class="w-6 h-6"></i>`;
                    lucide.createIcons();
                    saveState();
                }
            });
            
            sidebarBackdrop.addEventListener('click', () => toggleMobileSidebar(true));

            async function processAiCommand(prompt) {
                const term = getCurrentProfile().terminology;
                const userRole = appState.session.userRole; // Get current user's role

                const response = await getIntentFromAI(prompt, userRole);

                if (!response.success) {
                    return "I'm sorry, I had trouble understanding that command. Could you please rephrase it?";
                }
                
                console.log("AI Reasoning:", response.reasoning); // Log the reasoning
                const { intent, entities = {} } = response;
                
                switch (intent) {
                    case 'GREETING': {
                        // All roles can do this
                        const greetings = ["Hello! How can I assist you today?", "Hi there! What can I do for you?", "Greetings! I'm here to help with your store management."];
                        return greetings[Math.floor(Math.random() * greetings.length)];
                    }
                    case 'ADD_ITEM_TO_SALE': {
                        // All roles can do this
                        if (!entities.productName) return `Which ${term.product} would you like to add?`;
                        
                        const product = firestoreData.products.find(p => p.name.toLowerCase().includes(entities.productName.toLowerCase()) || p.id.toLowerCase() === entities.productName.toLowerCase());
                        if (product) {
                            openOrSwitchTab('pos');
                            setTimeout(() => {
                                const productToAdd = { ...product };
                                productToAdd.qty = entities.quantity || 1;
                                addProductToActiveCart(productToAdd);
                            }, 200);
                            return `<i data-lucide="check-circle" class="inline w-4 h-4 mr-1 text-green-400"></i> Understood. Adding ${entities.quantity || 1} x <strong>${product.name}</strong> to the active sale.`;
                        }
                        return `I couldn't find a ${term.product} named "${entities.productName}".`;
                    }
                    
                    case 'CREATE_PRODUCT': {
                        // Manager and Admin only
                        if (userRole !== 'manager' && userRole !== 'admin') {
                            return "I'm sorry, you don't have permission to create new products.";
                        }
                        // --- NEW LIMIT CHECK ---
                    const currentProductCount = firestoreData.products.filter(p => !p.parentSKU).length;
                    const productLimit = firestoreData.storeInfo.planLimits?.products || 1000;
                    const itemsToCreate = (entities.items && Array.isArray(entities.items)) ? entities.items.length : 1;
                    
                    if (currentProductCount + itemsToCreate > productLimit) {
                        const remaining = productLimit - currentProductCount;
                        const message = remaining > 0 
                            ? `You can only add ${remaining} more product(s) to reach your limit of ${productLimit}.`
                            : `You have already reached your limit of ${productLimit} products.`;
                        showToast(message, 'error');
                        showLimitReachedModal('products', productLimit);
                        return `I'm sorry, I can't create ${itemsToCreate} new product(s). ${message} Please upgrade your plan to add more.`;
                    }
                    // --- END NEW LIMIT CHECK ---
                        // Handle multi-product creation
                        if (entities.items && Array.isArray(entities.items) && entities.items.length > 0) {
                            let responseMsg = `Okay, I'm creating ${entities.items.length} new ${term.product}s for you:<br>`;
                            entities.items.forEach(item => {
                                // Reconstruct a detailed prompt for each item to send to the product generation AI
                                let individualPrompt = `Create a product named "${item.productName || 'Unnamed Product'}"`;
                                if (item.category) individualPrompt += `, category ${item.category}`;
                                if (item.price) individualPrompt += `, selling price ${item.price}`;
                                if (item.costPrice) individualPrompt += `, cost price ${item.costPrice}`;
                                if (item.stock) individualPrompt += `, stock ${item.stock}`;
                                // Asynchronously call the handler for each product
                                handleAiProductGeneration(individualPrompt);
                                responseMsg += `- <strong>${item.productName || 'Unnamed Product'}</strong><br>`;
                            });
                            responseMsg += `The product forms will open shortly for your review.`;
                            return responseMsg;
                        } 
                        // Handle single product creation (legacy or simple prompts)
                        else if (entities.productName) {
                            handleAiProductGeneration(prompt); // Pass the original, detailed prompt
                            return `Okay, I'm analyzing the details you provided for <strong>${entities.productName}</strong> to create a new ${term.product} listing. The product form will open shortly.`;
                        } 
                        // Handle insufficient information
                        else {
                            return `Please specify which ${term.product}(s) you'd like me to create, including details like name, price, and category.`;
                        }
                    }

                    case 'VIEW_PRODUCT_DETAILS': {
                        // All roles can do this, but with different levels of detail
                        if (!entities.productName) return `Which ${term.product} would you like me to show you details for?`;
                        const product = firestoreData.products.find(p => p.name.toLowerCase().includes(entities.productName.toLowerCase()) || p.id.toLowerCase() === entities.productName.toLowerCase());
                        if (!product) return `I couldn't find a ${term.product} named "${entities.productName}".`;
                        
                        let details = `<strong>Details for ${product.name} (SKU: ${product.id})</strong><br>`;
                        details += `- Category: ${product.category}<br>`;
                        details += `- Price: ${currencyUtils.format(product.price)}<br>`;
                        
                        // Role-based cost price visibility
                        if (userRole === 'manager' || userRole === 'admin') {
                            details += `- Cost: ${currencyUtils.format(product.costPrice)}<br>`;
                        }

                        details += `- Stock: ${product.productType === 'physical' ? product.stock : 'N/A'}<br>`;
                        if (product.customData) {
                            details += `<strong>Custom Details:</strong><br>`;
                            for (const [key, value] of Object.entries(product.customData)) {
                                if(value) details += `- ${key}: ${value}<br>`;
                            }
                        }
                        return details;
                    }

                    case 'DELETE_PRODUCT': {
                        // Manager and Admin only
                        if (userRole !== 'manager' && userRole !== 'admin') {
                            return "I'm sorry, you don't have permission to delete products.";
                        }
                        if (!entities.productName) return `Which ${term.product} do you want to delete?`;
                        const product = firestoreData.products.find(p => p.name.toLowerCase().includes(entities.productName.toLowerCase()) || p.id.toLowerCase() === entities.productName.toLowerCase());
                        if (!product) return `I couldn't find a ${term.product} named "${entities.productName}" to delete.`;

                        try {
                            await deleteDoc(doc(productsRef, product.id));
                            showToast(`${product.name} was deleted successfully.`, 'success');
                            return `<i data-lucide="trash-2" class="inline w-4 h-4 mr-1 text-red-400"></i> Okay, I have permanently deleted <strong>${product.name}</strong>.`;
                        } catch (error) {
                             console.error("AI failed to delete product:", error);
                            return `Sorry, I encountered an error while deleting ${product.name}.`;
                        }
                    }
                    
                    case 'UPDATE_PRODUCT': {
                        // Manager and Admin only
                        if (userRole !== 'manager' && userRole !== 'admin') {
                            return "I'm sorry, you don't have permission to update products.";
                        }
                        if (!entities.productName) return `Which ${term.product} do you want to update?`;
                        if (entities.quantity === undefined && entities.price === undefined) return `What do you want to update for ${entities.productName}? You can update the stock quantity or the price.`;
                        
                        const product = firestoreData.products.find(p => p.name.toLowerCase().includes(entities.productName.toLowerCase()) || p.id.toLowerCase() === entities.productName.toLowerCase());
                        if (!product) return `I couldn't find a ${term.product} named "${entities.productName}".`;

                        const updates = {};
                        let responseMsg = `Okay, I've updated <strong>${product.name}</strong>:`;

                        if (entities.quantity !== undefined) {
                            updates.stock = entities.quantity;
                            responseMsg += `<br>- Stock set to <strong>${entities.quantity}</strong>.`;
                        }
                        if (entities.price !== undefined) {
                            updates.price = entities.price; // Assuming AI gives price in base currency
                            responseMsg += `<br>- Price set to <strong>${currencyUtils.format(entities.price)}</strong>.`;
                        }
                        
                        try {
                            await updateDoc(doc(productsRef, product.id), updates);
                            showToast(`${product.name} was updated successfully.`, 'success');
                            return responseMsg;
                        } catch (error) {
                            console.error("AI failed to update product:", error);
                            return `Sorry, I encountered an error while updating ${product.name}.`;
                        }
                    }

                    case 'CREATE_INVOICE': {
                        // All roles can do this
                        if (!entities.items || entities.items.length === 0) {
                            return `I can create a new sale for you, but please tell me which ${term.product}s to add.`;
                        }
                        openOrSwitchTab('pos');

                        // Wait for the POS view to render
                        await new Promise(resolve => setTimeout(resolve, 200));

                        // Create a new sale tab
                        const newSaleId = `sale_${Date.now()}`;
                        posState.sales.push({ id: newSaleId, name: `Sale ${posState.saleCounter++}`, cart: [], customer: null, status: 'active' });
                        posState.activeSaleId = newSaleId;
                        const activeSale = posState.sales.find(s => s.id === newSaleId);

                        let responseMsg = "I've created a new sale for you";
                        
                        // Add customer if specified
                        if (entities.customerName) {
                            const customer = firestoreData.customers.find(c => c.name.toLowerCase().includes(entities.customerName.toLowerCase()));
                            if (customer) {
                                activeSale.customer = customer;
                                responseMsg += ` for <strong>${customer.name}</strong>`;
                            }
                        }
                        responseMsg += " with the following items:<br>";

                        // Add items to the cart
                        for (const item of entities.items) {
                            const product = firestoreData.products.find(p => p.name.toLowerCase().includes(item.productName.toLowerCase()));
                            if (product) {
                                activeSale.cart.push({ ...product, qty: item.quantity || 1 });
                                responseMsg += `- ${item.quantity || 1} x ${product.name}<br>`;
                            } else {
                                responseMsg += `- (Could not find a ${term.product} named "${item.productName}")<br>`;
                            }
                        }
                        
                        posFullRender(workspaceContent.querySelector('.view-pane'));
                        return responseMsg;
                    }

                    case 'APPLY_DISCOUNT_TO_SALE': {
                        // All roles can do this, but logic for limits would be elsewhere (e.g., in the discount modal)
                        openOrSwitchTab('pos');
                        await new Promise(resolve => setTimeout(resolve, 150));
                        
                        const activeSale = posState.sales.find(s => s.id === posState.activeSaleId);
                        if (!activeSale || activeSale.cart.length === 0) {
                            return "There is no active sale or the cart is empty. I can't apply a discount.";
                        }
                        if (!entities.discountType || !entities.discountValue) {
                            return "Please specify the discount type (percent or fixed) and value.";
                        }

                        // A simplified application. A real implementation would check role-based limits here.
                        activeSale.discount = { type: entities.discountType, value: entities.discountValue };
                        
                        posFullRender(workspaceContent.querySelector('.view-pane'));
                        return `I've applied a <strong>${entities.discountValue}${entities.discountType === 'percent' ? '%' : currencyUtils.get().symbol}</strong> discount to the current sale.`;
                    }
                        
                    case 'VIEW_PAGE': {
                        if (!entities.page) return "Which page would you like to see?";
                        const validPages = ['dashboard', 'pos', 'inventory', 'invoices', 'reports', 'customers', 'settings', 'quotations'];
                        const pageToOpen = entities.page.toLowerCase().replace(/\s+/g, '');
                        if (!validPages.includes(pageToOpen)) {
                            return `I can't find a page named "${entities.page}".`;
                        }

                        // Role-based page access
                        const cashierPages = ['pos', 'customers', 'invoices'];
                        if (userRole === 'cashier' && !cashierPages.includes(pageToOpen)) {
                            return `I'm sorry, you don't have permission to access the <strong>${pageToOpen}</strong> page.`;
                        }

                        // The existing `checkPermission` in the getViewContent and other places already handles this, but an upfront check is better UX.
                        openOrSwitchTab(pageToOpen);
                        return `<i data-lucide="compass" class="inline w-4 h-4 mr-1 text-blue-400"></i> Of course. Opening the <strong>${entities.page}</strong> page.`;
                    }
                    
                    case 'QUERY_DATA': {
                        // Manager and Admin only
                        if (userRole !== 'manager' && userRole !== 'admin') {
                            return "I'm sorry, you don't have permission to query business data.";
                        }
                        if (!entities.query) return "What would you like to know?";

                        const queryLower = entities.query.toLowerCase();
                        
                        // Handle simple stock checks first
                        if (queryLower.includes('stock') || queryLower.includes('how many') || queryLower.includes('')) {
                            const productName = entities.productName || queryLower.split('of ').pop().split('stock').pop().replace('?','').trim();
                            const product = firestoreData.products.find(p => p.name.toLowerCase().includes(productName.toLowerCase()));
                            if (product) {
                                if (product.productType !== 'physical') return `${product.name} is a service and does not have a stock quantity.`;
                                return `There are <strong>${product.stock}</strong> units of <strong>${product.name}</strong> in stock.`;
                            }
                            return `I couldn't find a ${term.product} named "${productName}" to check its stock.`;
                        }
                        
                        // Handle complex queries with filters
                        if (queryLower.includes('product') && (queryLower.includes('<') || queryLower.includes('>') || queryLower.includes('='))) {
                            try {
                                const [field, operator, valueStr] = queryLower.replace('products with', '').trim().split(/([<>=]+)/);
                                const value = parseFloat(valueStr);
                                if (!field || !operator || isNaN(value)) throw new Error("Invalid query format.");

                                let results = firestoreData.products;
                                if (field.trim().includes('stock')) {
                                    if (operator === '<') results = results.filter(p => p.stock < value);
                                    else if (operator === '>') results = results.filter(p => p.stock > value);
                                    else results = results.filter(p => p.stock == value);
                                } else if (field.trim().includes('price')) {
                                    if (operator === '<') results = results.filter(p => p.price < value);
                                    else if (operator === '>') results = results.filter(p => p.price > value);
                                    else results = results.filter(p => p.price == value);
                                } else {
                                     return "I can only filter products by 'stock' or 'price'.";
                                }

                                if (results.length === 0) return `No ${term.product}s found matching that criteria.`;

                                let response = `Found <strong>${results.length}</strong> ${term.product}(s) with ${field.trim()} ${operator} ${value}:<br>`;
                                response += results.slice(0, 5).map(p => `- ${p.name} (${field.trim()}: ${field.trim() === 'price' ? currencyUtils.format(p.price) : p.stock})`).join('<br>');
                                if (results.length > 5) response += `<br>...and ${results.length - 5} more.`;
                                return response;

                            } catch (e) {
                                return "I couldn't understand that filter. Please try a format like 'list all products with stock < 50'.";
                            }
                        }

                        // Handle Top X Customers query
                        if (queryLower.includes('top') && queryLower.includes('customer')) {
                             const count = parseInt(queryLower.match(/\d+/)?.[0] || '5');
                             const customerSpending = firestoreData.invoices.reduce((acc, inv) => {
                                 if (inv.customerId) {
                                     acc[inv.customerId] = (acc[inv.customerId] || 0) + inv.totalInBaseCurrency;
                                 }
                                 return acc;
                             }, {});

                             const topCustomerIds = Object.entries(customerSpending)
                                 .sort(([, a], [, b]) => b - a)
                                 .slice(0, count)
                                 .map(([id]) => id);
                            
                             if(topCustomerIds.length === 0) return "Not enough sales data to determine top customers.";

                             let response = `Your top <strong>${topCustomerIds.length}</strong> customer(s) are:<br>`;
                             topCustomerIds.forEach((id, index) => {
                                 const customer = firestoreData.customers.find(c => c.id === id);
                                 if (customer) {
                                     response += `${index + 1}. <strong>${customer.name}</strong> with ${currencyUtils.format(customerSpending[id])} spent.<br>`;
                                 }
                             });
                             return response;
                        }

                        if (queryLower.includes('last order') || queryLower.includes('last purchase')) {
                            const customerName = entities.customerName || queryLower.split('for ').pop().replace('?','').trim();
                            const customer = firestoreData.customers.find(c => c.name.toLowerCase().includes(customerName.toLowerCase()));
                            if (!customer) return `I couldn't find a customer named "${customerName}".`;

                            const lastInvoice = firestoreData.invoices
                                .filter(i => i.customerId === customer.id)
                                .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                            
                            if (lastInvoice) {
                                return `${customer.name}'s last order was on ${new Date(lastInvoice.date).toLocaleDateString()} for a total of ${currencyUtils.format(lastInvoice.totalInBaseCurrency)}.`;
                            }
                        }
                        return `I'm not equipped to answer that specific question yet, but I'm learning! You can ask me about stock levels, top customers, or filter products by price/stock.`;
                    }
                    
                    case 'ANALYZE_DASHBOARD': {
                        // Manager and Admin only
                        if (userRole !== 'manager' && userRole !== 'admin') {
                            return "I'm sorry, you don't have permission to analyze dashboard data.";
                        }
                        const analysisType = entities.analysisType || entities.query;
                        if (!analysisType) return `What aspect of the dashboard would you like me to analyze? For example: "top selling products this month".`;
                        
                        const analysisLower = analysisType.toLowerCase();

                        if (analysisLower.includes('top selling') || analysisLower.includes('best selling')) {
                             const salesByProduct = firestoreData.invoices
                                .flatMap(inv => inv.items)
                                .reduce((acc, item) => {
                                    acc[item.id] = (acc[item.id] || 0) + (item.price * (item.qty || 1));
                                    return acc;
                                }, {});

                            const topProducts = Object.entries(salesByProduct)
                                .sort(([, a], [, b]) => b - a)
                                .slice(0, 5)
                                .map(([id, revenue]) => ({ product: firestoreData.products.find(p => p.id === id), revenue }));
                            
                            if (topProducts.length === 0) {
                                return `There's not enough sales data to determine top selling ${term.product}s yet.`;
                            }
                            
                            let response = `<strong>Here are your top 5 selling ${term.product}s:</strong><br>`;
                            topProducts.forEach((item, index) => {
                                response += `${index + 1}. <strong>${item.product?.name || 'Unknown'}</strong> with ${currencyUtils.format(item.revenue)} in sales.<br>`;
                            });
                            return response;
                        }

                        if (analysisLower.includes('profit margin')) {
                            // This permission is implicitly checked by the ANALYZE_DASHBOARD check for manager/admin.
                            if (!entities.productName) {
                                return `Which ${term.product} would you like me to analyze the profit margin for?`;
                            }
                            const product = firestoreData.products.find(p => p.name.toLowerCase().includes(entities.productName.toLowerCase()));
                            if (!product) {
                                return `I couldn't find a ${term.product} named "${entities.productName}".`;
                            }
                            if (!product.costPrice || !product.price) {
                                return `I can't calculate the profit margin for <strong>${product.name}</strong> because its cost or selling price is missing.`;
                            }
                            const margin = ((product.price - product.costPrice) / product.price) * 100;
                            const profit = product.price - product.costPrice;
                            return `The profit margin for <strong>${product.name}</strong> is <strong>${margin.toFixed(2)}%</strong> (a profit of ${currencyUtils.format(profit)} per unit).`;
                        }
                        
                        if (analysisLower.includes('category comparison') || (analysisLower.includes('compare') && analysisLower.includes('vs'))) {
                            const categories = [...new Set(firestoreData.products.map(p => p.category))];
                            const comparisonMatch = prompt.toLowerCase().match(/compare sales of (.*) vs (.*)/);
                            if (!comparisonMatch) return "I can compare categories, but please phrase it like 'compare sales of Category A vs Category B'.";

                            const catA = categories.find(c => c.toLowerCase().includes(comparisonMatch[1].trim()));
                            const catB = categories.find(c => c.toLowerCase().includes(comparisonMatch[2].trim()));

                            if (!catA || !catB) return "I couldn't find one or both of those categories to compare.";

                            const salesA = firestoreData.invoices.flatMap(i => i.items).filter(item => firestoreData.products.find(p => p.id === item.id)?.category === catA).reduce((sum, item) => sum + (item.price * (item.qty || 1)), 0);
                            const salesB = firestoreData.invoices.flatMap(i => i.items).filter(item => firestoreData.products.find(p => p.id === item.id)?.category === catB).reduce((sum, item) => sum + (item.price * (item.qty || 1)), 0);

                            let response = `Here's a comparison of total sales:<br>`;
                            response += `- <strong>${catA}:</strong> ${currencyUtils.format(salesA)}<br>`;
                            response += `- <strong>${catB}:</strong> ${currencyUtils.format(salesB)}<br>`;
                            if (salesA > salesB) {
                                response += `<strong>${catA}</strong> is outperforming <strong>${catB}</strong>.`;
                            } else if (salesB > salesA) {
                                response += `<strong>${catB}</strong> is outperforming <strong>${catA}</strong>.`;
                            } else {
                                response += `Both categories have similar sales performance.`;
                            }
                            return response;
                        }


                        if (analysisLower.includes('revenue trend') || analysisLower.includes('sales performance')) {
                            const now = new Date('2025-09-18T14:39:00');
                            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                            const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                            
                            const thisMonthRevenue = firestoreData.invoices
                                .filter(i => new Date(i.date) >= startOfMonth)
                                .reduce((sum, i) => sum + i.totalInBaseCurrency, 0);
                            
                             const lastMonthRevenue = firestoreData.invoices
                                .filter(i => new Date(i.date) >= startOfLastMonth && new Date(i.date) < startOfMonth)
                                .reduce((sum, i) => sum + i.totalInBaseCurrency, 0);
                            
                            let trend = 'flat';
                            let change = 0;
                            if (lastMonthRevenue > 0) {
                                change = ((thisMonthRevenue - lastMonthRevenue) / lastMonthRevenue) * 100;
                                if (change > 5) trend = 'upward';
                                if (change < -5) trend = 'downward';
                            } else if (thisMonthRevenue > 0) {
                                trend = 'upward';
                            }
                            
                            return `This month's revenue is <strong>${currencyUtils.format(thisMonthRevenue)}</strong>. Compared to last month, the trend is <strong>${trend}</strong> (${change.toFixed(1)}%).`;
                        }
                        
                        return `I can analyze 'top selling products', 'profit margins', 'category comparisons', and 'revenue trends'. What would you like to know?`;
                    }

                    case 'GENERATE_REPORT': {
                        // Manager and Admin only
                        if (userRole !== 'manager' && userRole !== 'admin') {
                            return "I'm sorry, you don't have permission to generate reports.";
                        }
                        if (!entities.reportType) return "What type of report would you like? (sales, inventory, or customer)";
                        
                        openOrSwitchTab('reports');
                        await new Promise(resolve => setTimeout(resolve, 200));

                        const reportPane = workspaceContent.querySelector('.view-pane');
                        const reportButton = reportPane.querySelector(`.report-type-btn[data-type="${entities.reportType}"]`);
                        
                        if (reportButton) {
                            reportButton.click();
                            return `Okay, I've generated the <strong>${entities.reportType} report</strong> for you.`;
                        }
                        return `I couldn't find a report type called '${entities.reportType}'.`;
                    }

                    case 'CREATE_CUSTOMER': {
                        // All roles can do this
                        if (!entities.customerName) return "What is the name of the customer you want to create?";
                        const newCustomerData = {
                            name: entities.customerName,
                            phone: entities.customerPhone || '',
                            email: entities.customerEmail || '',
                            address: entities.customerAddress || '',
                            loyaltyPoints: 0,
                            joinDate: new Date().toISOString().slice(0, 10),
                            loyaltyId: `CS-${entities.customerName.substring(0, 2).toUpperCase()}-${Date.now().toString().slice(-4)}`
                        };
                        try {
                            await addDoc(customersRef, newCustomerData);
                            showToast(`Customer "${entities.customerName}" created successfully.`, 'success');
                            return `I've created a new profile for <strong>${entities.customerName}</strong>.`;
                        } catch (error) {
                            console.error("AI failed to create customer:", error);
                            return `I encountered an error trying to create ${entities.customerName}.`;
                        }
                    }

                    case 'DELETE_CUSTOMER': {
                        // Manager and Admin only
                        if (userRole !== 'manager' && userRole !== 'admin') {
                            return "I'm sorry, you don't have permission to delete customers.";
                        }
                        if (!entities.customerName) return "Which customer do you want to delete?";
                        const customer = firestoreData.customers.find(c => c.name.toLowerCase().includes(entities.customerName.toLowerCase()));
                        if (!customer) return `I couldn't find a customer named "${entities.customerName}".`;

                        try {
                            await deleteDoc(doc(customersRef, customer.id));
                            showToast(`Customer "${customer.name}" was deleted.`, 'success');
                            return `Okay, I have deleted <strong>${customer.name}</strong> from your records.`;
                        } catch (error) {
                            console.error("AI failed to delete customer:", error);
                            return `I couldn't delete ${customer.name}. An error occurred.`;
                        }
                    }
                    
                    case 'UPDATE_CUSTOMER': {
                        // All roles can do this (with business logic limiting cashiers elsewhere)
                        if (!entities.customerName) return "Which customer's profile do you want to update?";
                        const customer = firestoreData.customers.find(c => c.name.toLowerCase().includes(entities.customerName.toLowerCase()));
                        if (!customer) return `I couldn't find a customer named "${entities.customerName}".`;
                        
                        const updates = {};
                        if(entities.customerPhone) updates.phone = entities.customerPhone;
                        if(entities.customerEmail) updates.email = entities.customerEmail;
                        if(entities.customerAddress) updates.address = entities.customerAddress;

                        if (Object.keys(updates).length === 0) return `What information would you like to update for ${customer.name}? You can change their phone, email, or address.`;

                        try {
                            await updateDoc(doc(customersRef, customer.id), updates);
                            showToast(`Updated ${customer.name}'s profile.`, 'success');
                            return `I've updated the profile for <strong>${customer.name}</strong>.`;
                        } catch(error) {
                            console.error("AI failed to update customer:", error);
                            return `I couldn't update ${customer.name}. An error occurred.`;
                        }
                    }

                    case 'CREATE_SALE_WITH_NEW_CUSTOMER': {
                        // All roles can do this
                        if (!entities.customerName || !entities.items || entities.items.length === 0) {
                            return "To start a sale for a new customer, please provide their name and the items they want to buy.";
                        }

                        // 1. Create the new customer
                        const newCustomerData = {
                            name: entities.customerName, phone: entities.customerPhone || '', email: entities.customerEmail || '', address: entities.customerAddress || '',
                            loyaltyPoints: 0, joinDate: new Date().toISOString().slice(0, 10),
                            loyaltyId: `CS-${entities.customerName.substring(0, 2).toUpperCase()}-${Date.now().toString().slice(-4)}`
                        };
                        let newCustomerRef;
                        try {
                            newCustomerRef = await addDoc(customersRef, newCustomerData);
                            showToast(`Customer "${entities.customerName}" created.`, 'success');
                        } catch (error) {
                            return `I couldn't create the new customer profile. Please try again.`;
                        }
                        
                        // 2. Open POS and create a new sale
                        openOrSwitchTab('pos');
                        await new Promise(resolve => setTimeout(resolve, 200));

                        const newSaleId = `sale_${Date.now()}`;
                        posState.sales.push({ id: newSaleId, name: `Sale ${posState.saleCounter++}`, cart: [], customer: { id: newCustomerRef.id, ...newCustomerData }, status: 'active' });
                        posState.activeSaleId = newSaleId;
                        const activeSale = posState.sales.find(s => s.id === newSaleId);

                        let responseMsg = `I've created a new profile for <strong>${entities.customerName}</strong> and started a new sale with the following items:<br>`;

                        // 3. Add items to the cart
                        for (const item of entities.items) {
                            const product = firestoreData.products.find(p => p.name.toLowerCase().includes(item.productName.toLowerCase()));
                            if (product) {
                                activeSale.cart.push({ ...product, qty: item.quantity || 1 });
                                responseMsg += `- ${item.quantity || 1} x ${product.name}<br>`;
                            } else {
                                responseMsg += `- (Could not find a ${term.product} named "${item.productName}")<br>`;
                            }
                        }
                        
                        posFullRender(workspaceContent.querySelector('.view-pane'));
                        return responseMsg;
                    }

                    case 'CREATE_PROFILE': {
                        // Admin only
                        if (userRole !== 'admin') {
                            return "I'm sorry, only Administrators can create new business profiles.";
                        }
                        if (!entities.profileName) {
                            openCustomProfileModal();
                            return `Okay, I've opened the form for you to create a new custom business profile.`;
                        }
                        openCustomProfileModal();
                         setTimeout(() => {
                             const form = document.getElementById('custom-profile-form');
                             if(form) form.querySelector('[name="name"]').value = entities.profileName;
                         }, 100);
                        return `I've started a new profile named <strong>${entities.profileName}</strong> for you. Please fill in the rest of the details.`;
                    }

                    case 'UPDATE_SETTING': {
                        // Admin only
                        if (userRole !== 'admin') {
                            return "I'm sorry, you don't have permission to change system settings.";
                        }
                        if (!entities.settingName || !entities.settingValue) {
                            return "Which setting would you like to change, and what should its new value be?";
                        }
                        const settingName = entities.settingName.toLowerCase();
                        const settingValue = entities.settingValue;

                        if (settingName.includes('tax')) {
                            const rate = parseFloat(settingValue);
                            if (!isNaN(rate)) {
                                await updateDoc(storeRef, { 'settings.taxRate': rate });
                                showToast(`Tax rate updated to ${rate}%.`, 'success');
                                return `Okay, I've updated the tax rate to <strong>${rate}%</strong>.`;
                            }
                            return `"${settingValue}" is not a valid number for the tax rate.`;
                        }
                        if (settingName.includes('currency')) {
                            const code = settingValue.toUpperCase();
                            if(firestoreData.storeInfo.currencies[code]) {
                                await updateDoc(storeRef, { 'settings.defaultCurrency': code });
                                showToast(`Default currency set to ${code}.`, 'success');
                                return `Right away. The default currency has been set to <strong>${code}</strong>.`;
                            }
                            return `I don't recognize the currency code "${code}".`;
                        }
                        return `I can't change the "${settingName}" setting yet. I can currently update 'tax rate' or 'default currency'.`;
                    }
                        
                    case 'UNKNOWN':
                    default:
                        return "I'm sorry, I can't perform that action yet. I can help with tasks like 'add product to pos', 'show sales report', or 'what is the stock of apples?'.";
                }
            }

            document.getElementById('main-nav').addEventListener('click', e => {
                 const viewTarget = e.target.closest('[data-view]');
                if (viewTarget) { 
                    e.preventDefault(); 
                    openOrSwitchTab(viewTarget.dataset.view); 
                    if (window.innerWidth < 1024) {
                        toggleMobileSidebar(true);
                    }
                }
            });

            document.body.addEventListener('click', async e => {
                // --- NEW: Security gate to prevent actions when locked ---
                if (isAppLocked) {
                    // The only action allowed is logout, which has its own dedicated listener
                    // on the lock screen overlay itself. All other clicks are ignored.
                    return;
                }
                // --- END NEW ---
                
                // MODIFIED: Close any open pop-up menus when clicking outside
                document.querySelectorAll('.action-menu.open').forEach(openMenu => {
                    if (openMenu.id === 'user-menu') {
                        const userMenuTrigger = document.getElementById('user-profile-section');
                        // For the user menu, check if the click is outside BOTH the menu and its trigger
                        if (!userMenuTrigger.contains(e.target) && !openMenu.contains(e.target)) {
                            openMenu.classList.remove('open');
                        }
                    } else if (!openMenu.parentElement.contains(e.target)) {
                        // Original logic for other menus
                        openMenu.classList.remove('open', 'open-up');
                    }
                });

                const actionTarget = e.target.closest('[data-action]');
                if (!actionTarget) return;
                
                const action = actionTarget.dataset.action;

                // --- NEW: Global Header Actions ---
                if (action === 'open-search') {
                    e.preventDefault();
                    openGlobalSearchModal();
                    return;
                }
                if (action === 'open-notifications') {
                    openNotificationsModal();
                    return;
                }
                // --- END NEW ---
                
                // --- NEW: Calculator Actions ---
                if (action === 'toggle-calculator-menu') {
                    e.stopPropagation();
                    const menu = document.getElementById('calculator-menu');
                    if (menu) {
                        const isCurrentlyOpen = menu.classList.contains('open');
                        document.querySelectorAll('.action-menu.open').forEach(m => m.classList.remove('open', 'open-up'));
                        if (!isCurrentlyOpen) {
                            menu.classList.add('open');
                        }
                    }
                    return;
                }
                if (action === 'open-calculator') {
                    e.preventDefault();
                    const type = actionTarget.dataset.type;
                    const menu = document.getElementById('calculator-menu');
                    if (menu) menu.classList.remove('open', 'open-up');
                    openCalculatorModal(type);
                    return;
                }
                // --- END NEW ---
                
                // MODIFIED: Handle user profile menu toggle with dynamic positioning
                if (actionTarget.dataset.action === 'toggle-user-menu') {
                    e.stopPropagation();
                    const menu = document.getElementById('user-menu');
                    if (!menu) return;

                    const isCurrentlyOpen = menu.classList.contains('open');

                    // Close all OTHER menus
                    document.querySelectorAll('.action-menu.open').forEach(m => {
                        if (m !== menu) m.classList.remove('open', 'open-up');
                    });

                    if (isCurrentlyOpen) {
                        menu.classList.remove('open');
                    } else {
                        const triggerRect = actionTarget.getBoundingClientRect();
                        const sidebarEl = document.getElementById('sidebar');

                        menu.style.position = 'fixed';
                        menu.style.zIndex = '50';
                        
                        // Position the bottom of the menu at the top of the trigger button
                        menu.style.bottom = `${window.innerHeight - triggerRect.top}px`;

                        // If sidebar is collapsed, position menu to its right. Otherwise, align with the trigger's left.
                        if (sidebarEl && sidebarEl.classList.contains('sidebar-collapsed')) {
                             menu.style.left = `${triggerRect.right + 8}px`; // 8px margin
                        } else {
                            menu.style.left = `${triggerRect.left}px`;
                        }
                        
                        // Unset conflicting style properties from original absolute positioning
                        menu.style.top = 'auto';
                        menu.style.right = 'auto';
                        
                        menu.classList.add('open');
                    }
                }
                if (action === 'toggle-fullscreen') {
                    toggleFullScreen();
                }

                if (action === 'open-import-modal') {
                    e.stopPropagation();
                    const importType = actionTarget.dataset.type;
                    if (importType === 'products' && checkPermission('canAddProducts')) {
                        openImportModal('products');
                    } else if (importType === 'customers' && checkPermission('canManageCustomers')) {
                        openImportModal('customers');
                    } else {
                        showToast('You do not have permission to import this data.', 'error');
                    }
                    return; // Stop further processing
                }

                if (action === 'export-products') {
                    e.stopPropagation();
                    handleProductExport();
                    return; // Stop further processing
                }
                
                if (action === 'export-customers') {
                    e.stopPropagation();
                    handleCustomerExport();
                    return; // Stop further processing
                }

                if (action === 'pos-product-paginate') {
                    e.stopPropagation();
                    const page = parseInt(actionTarget.dataset.page);
                    appState.viewStates.posModern.productGridPage = page;
                    saveState();
                    
                    const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
                    if (activeTab?.viewType === 'pos') {
                        const currentViewPane = workspaceContent.querySelector('.view-pane');
                        // Re-initialize the POS view, which will read the new page state
                        initPOS(currentViewPane);
                    }
                    return; // Stop further execution
                }

                if (action === 'toggle-store-menu') {
                    e.stopPropagation();
                    const menu = document.getElementById('store-menu');
                    if (menu) {
                        const isCurrentlyOpen = menu.classList.contains('open');
                        document.querySelectorAll('.action-menu.open').forEach(m => m.classList.remove('open', 'open-up'));
                        if (!isCurrentlyOpen) {
                            menu.classList.add('open');
                        }
                    }
                }
                
                // --- FIX: Handle store switching ---
                if (action === 'switch-store') {
                    e.preventDefault();
                    e.stopPropagation(); // Prevent other listeners from firing
                    const storeId = actionTarget.dataset.id;
                    if (storeId) {
                        // The switchStore function is already defined globally and handles the logic
                        await switchStore(storeId);
                    }
                }
                
                if (action === 'add-new-store') {
                    e.stopPropagation();
                    
                    // --- NEW: Store Limit Check ---
                    const storeLimit = appState.session.userProfileData?.storeLimit || 1;
                    const storeCount = appState.session.availableStores.length;
                    if (storeCount >= storeLimit) {
                        showToast(`You have reached your limit of ${storeLimit} store(s). Contact support to upgrade.`, 'error');
                        return;
                    }
                    // --- END NEW ---

                    document.querySelectorAll('.action-menu.open').forEach(m => m.classList.remove('open', 'open-up'));
                    const content = `
                        <form id="add-new-store-form" class="space-y-4">
                            <p class="text-sm text-text-secondary">You are creating a new, separate business. This will not affect your existing stores.</p>
                            <div>
                                <label class="block text-sm font-medium mb-1">New Business Name</label>
                                <input type="text" name="name" class="form-input w-full" required>
                            </div>
                        </form>
                    `;
                    const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="add-new-store-form" class="btn btn-primary">Create Store</button>`;
                    const modal = showModal('Create New Store', content, footer);
                    
                    modal.querySelector('#add-new-store-form').addEventListener('submit', async (ev) => {
                        ev.preventDefault();
                        const storeName = ev.target.name.value;
                        if (!storeName.trim()) {
                            showToast('Please enter a valid business name.', 'error');
                            return;
                        }
                        
                        closeModal(modal);
                        showToast(`Creating your new store: ${storeName}...`, 'info');
                        
                        try {
                            // The function will create the store and set it as current
                            await addNewStoreToExistingUser(auth.currentUser, storeName);
                            // Then reload the page to reflect the change
                            window.location.reload();
                        } catch (error) {
                            console.error('Failed to create new store:', error);
                            showToast('There was an error creating your new store.', 'error');
                        }
                    });
                }
                
                // --- FIX: Add Product button handler ---
                if (action === 'add-product') {
                    if (!checkPermission('canAddProducts')) {
                        showToast("You don't have permission to add products.", "error");
                        return;
                    }
                    openProductFormModal(false, {}); // false for isEditing, empty object for new product
                }
                
                if (actionTarget.closest('.action-menu')) {
                    e.stopPropagation();
                }
                if (action === 'open-daybook') {
                  openDaybookModal(); // Call the function you just pasted
                  return; // Stop further processing for this click
                }

                const targetId = actionTarget.dataset.id;
                const serial = actionTarget.dataset.serial;
                const currentViewPane = workspaceContent.querySelector('.view-pane');

                if (action === 'view-my-profile') {
                    e.preventDefault();
                    // Close the menu before opening the modal
                    const menu = document.getElementById('user-menu');
                    if (menu) menu.classList.remove('open', 'open-up');
                    openMyProfileModal();
                }

                if (action === 'paginate') {
        const viewType = actionTarget.dataset.viewType;
        const page = parseInt(actionTarget.dataset.page);
        
        // Check if it's a payroll pagination action
        if (viewType === 'payrollSettings' || viewType === 'payrollHistory') {
            handlePayrollPagination(viewType, page); // <-- ADD THIS CALL
        } else if (appState.viewStates[viewType]) { // <-- Make the original logic an 'else if'
            appState.viewStates[viewType].currentPage = page;
            // Re-render the active view
            const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
            if (activeTab && viewInitializers[activeTab.viewType]) {
                const currentViewPane = workspaceContent.querySelector('.view-pane');
                viewInitializers[activeTab.viewType](currentViewPane);
            }
        }
    }

                if (action === 'show-shortcuts') { showShortcutsModal(); }
                if (action === 'switch-tab') { appState.activeTabId = targetId; renderApp(); }
                if (action === 'close-tab') {
                    e.stopPropagation();
                    const tabIdToClose = targetId;
                    const tabIndex = appState.tabs.findIndex(t => t.id === tabIdToClose);
                    appState.tabs.splice(tabIndex, 1);
                    if (appState.activeTabId === tabIdToClose) {
                        const newActiveTab = appState.tabs[tabIndex] || appState.tabs[tabIndex - 1];
                        appState.activeTabId = newActiveTab ? newActiveTab.id : null;
                    }
                    renderApp();
                }

                const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);

                // --- NEW: INVENTORY-SPECIFIC ACTIONS ---
                if (activeTab?.viewType === 'inventory') {
                    switch(action) {
                        // THIS CASE IS NOW HANDLED LOCALLY IN initInventory()
                        /*
                        case 'edit-product': {
                            if (!checkPermission('canEditProducts')) {
                                showToast("You don't have permission to edit products.", "error");
                                return;
                            }
                            e.stopPropagation();
                            const productToEdit = firestoreData.products.find(p => p.id === targetId);
                            if (productToEdit) openProductFormModal(true, productToEdit);
                            break;
                        }
                        */
                        case 'adjust-stock': {
                             if (!checkPermission('canEditProducts')) { 
                                showToast("You don't have permission to adjust stock.", "error");
                                return;
                            }
                            e.stopPropagation();
                            openStockAdjustmentModal(targetId);
                            break;
                        }
                         case 'receive-stock': {
                             if (!checkPermission('canEditProducts')) {
                                showToast("You don't have permission to receive stock.", "error");
                                return;
                            }
                            e.stopPropagation();
                            openReceiveStockModal(targetId);
                            break;
                        }
                    }
                }

                // --- NEW: PURCHASE ORDER ACTIONS ---
                if (action === 'manage-suppliers') {
                    if (checkPermission('canManageSuppliers')) {
                        openManageSuppliersModal();
                    } else {
                        showToast('You do not have permission to manage suppliers.', 'error');
                    }
                }

                if (action === 'add-purchase-order' || action === 'edit-purchase-order') {
                    e.stopPropagation();
                    const poId = action === 'edit-purchase-order' ? targetId : null;
                    const isEditing = !!poId;
                    const canPerformAction = isEditing ? checkPermission('canUpdatePurchaseOrders') : checkPermission('canCreatePurchaseOrders');

                    if (!canPerformAction) {
                         showToast('You do not have permission to perform this action.', 'error');
                         return;
                    }
                    openPurchaseOrderModal(poId);
                }

                if (action === 'view-purchase-order') {
                     e.stopPropagation(); // Stop row click if menu item is clicked
                     openViewPurchaseOrderModal(targetId);
                }

                if (action === 'mark-po-ordered') {
                    if (!checkPermission('canUpdatePurchaseOrders')) return;
                    const modal = showModal('Confirm Order', 'This will mark the PO as Ordered and lock it from editing. Are you sure?', `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-order" class="btn btn-primary">Yes, Mark as Ordered</button>`);
                    modal.querySelector('#confirm-order').addEventListener('click', async () => {
                        await updateDoc(doc(purchaseOrdersRef, targetId), { status: 'Ordered' });
                        showToast('PO marked as Ordered.', 'success');
                        closeModal(modal);
                        closeModal(document.getElementById('modals-container').querySelector('.modal-overlay')); // Close the view modal too
                    });
                }
                
                if (action === 'receive-po-stock') {
                    if (!checkPermission('canUpdatePurchaseOrders')) return;
                    closeModal(actionTarget.closest('.modal-overlay')); // Close view modal before opening receive modal
                    openReceivePOStockModal(targetId);
                }

                if (action === 'cancel-po') {
                    if (!checkPermission('canUpdatePurchaseOrders')) return;
                    const modal = showModal('Confirm Cancellation', 'Are you sure you want to cancel this Purchase Order?', `<button data-action="close-modal" class="btn btn-secondary">No</button><button id="confirm-cancel" class="btn btn-danger">Yes, Cancel PO</button>`);
                    modal.querySelector('#confirm-cancel').addEventListener('click', async () => {
                        await updateDoc(doc(purchaseOrdersRef, targetId), { status: 'Cancelled' });
                        showToast('PO has been cancelled.', 'success');
                        closeModal(modal);
                         closeModal(document.getElementById('modals-container').querySelector('.modal-overlay'));
                    });
                }
                
                if (action === 'delete-purchase-order') {
                    e.stopPropagation();
                    const po = firestoreData.purchaseOrders.find(p => p.id === targetId);
                    if (!checkPermission('canDeletePurchaseOrders') || po.status !== 'Draft') {
                        showToast('Only draft purchase orders can be deleted by authorized users.', 'error');
                        return;
                    }
                     const deleteModal = showModal('Confirm Deletion', `Are you sure you want to delete Purchase Order ${targetId}?`, `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-delete" class="btn btn-danger">Delete</button>`);
                     deleteModal.querySelector('#confirm-delete').addEventListener('click', async () => {
                         await deleteDoc(doc(purchaseOrdersRef, targetId));
                         showToast('Purchase Order deleted.', 'success');
                         closeModal(deleteModal);
                     });
                }
                // --- END NEW ACTIONS ---

                // --- NEW: SUPPLIER-SPECIFIC ACTIONS (for dedicated page) ---
                if (activeTab?.viewType === 'suppliers') {
                    if (action === 'add-supplier') {
                        if (checkPermission('canManageSuppliers')) {
                            openSupplierModal(null);
                        }
                    }
                    if (action === 'edit-supplier') {
                        e.stopPropagation();
                        if (checkPermission('canManageSuppliers')) {
                            openSupplierModal(targetId);
                        }
                    }
                    if (action === 'delete-supplier') {
                        e.stopPropagation();
                        if (checkPermission('canManageSuppliers')) {
                            if (firestoreData.purchaseOrders.some(po => po.supplierId === targetId)) {
                                showToast('Cannot delete supplier. They are linked to existing purchase orders.', 'error');
                                return;
                            }
                            const supplier = firestoreData.suppliers.find(s => s.id === targetId);
                            const deleteModal = showModal('Confirm Deletion', `Are you sure you want to delete the supplier "${supplier?.name || 'this supplier'}"?`, `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-delete" class="btn btn-danger">Delete</button>`);
                            deleteModal.querySelector('#confirm-delete').addEventListener('click', async () => {
                                await deleteDoc(doc(suppliersRef, targetId));
                                showToast('Supplier deleted.', 'success');
                                closeModal(deleteModal);
                            });
                        }
                    }
                }
                // --- END NEW ACTIONS ---

                if(activeTab?.viewType === 'pos') {
                    const activeSale = posState.sales.find(s => s.id === posState.activeSaleId);
                    switch(action) {
                        case 'switch-sale': {
                            const saleId = actionTarget.dataset.id;
                            if (posState.activeSaleId !== saleId) {
                                posState.activeSaleId = saleId;
                                posFullRender(currentViewPane);
                            }
                            break;
                        }
                        case 'new-sale': {
                            const newSaleId = `sale_${Date.now()}`;
                            posState.sales.push({ id: newSaleId, name: `Sale ${posState.saleCounter++}`, cart: [], customer: null, status: 'active', discount: { type: 'percent', value: 0 } });
                            posState.activeSaleId = newSaleId;
                            posFullRender(currentViewPane);
                            showToast('New sale created.', 'success');
                            
                            // Scroll the new tab into view
                            const tabsContainer = currentViewPane.querySelector('#pos-tabs-container');
                            if (tabsContainer) {
                                // Use a timeout to allow the DOM to update before scrolling
                                setTimeout(() => {
                                    tabsContainer.scrollTo({ left: tabsContainer.scrollWidth, behavior: 'smooth' });
                                }, 50);
                            }
                            break;
                        }
                        case 'cancel-sale': {
                            if (!activeSale || activeSale.cart.length === 0) {
                                showToast('Cart is already empty.', 'info');
                                return;
                            }
                            const modal = showModal('Cancel Sale', '<p>Are you sure you want to clear all items from this sale? This action cannot be undone.</p>',
                                `<button data-action="close-modal" class="btn btn-secondary">Keep Sale</button><button id="confirm-cancel" class="btn btn-danger">Yes, Cancel It</button>`
                            );
                            modal.querySelector('#confirm-cancel').addEventListener('click', () => {
                                activeSale.cart = [];
                                activeSale.customer = null;
                                posFullRender(currentViewPane);
                                showToast('Sale has been cancelled.', 'success');
                                closeModal(modal);
                            });
                            break;
                        }
                        case 'hold-sale': {
                            if (!activeSale || activeSale.cart.length === 0) {
                                showToast('Cannot hold an empty sale.', 'info');
                                return;
                            }
                            const heldSaleName = activeSale.name;
                            activeSale.status = 'held';
                            
                            let nextSale = posState.sales.find(s => s.status === 'active' && s.id !== activeSale.id);
                            if (!nextSale) {
                                const newSaleId = `sale_${Date.now()}`;
                                posState.sales.push({ id: newSaleId, name: `Sale ${posState.saleCounter++}`, cart: [], customer: null, status: 'active' });
                                posState.activeSaleId = newSaleId;
                            } else {
                                posState.activeSaleId = nextSale.id;
                            }

                            posFullRender(currentViewPane);
                            showToast(`${heldSaleName} is now on hold.`, 'success');
                            break;
                        }
                        case 'close-sale': {
                            e.stopPropagation();
                            const saleIdToClose = targetId;
                            const saleToClose = posState.sales.find(s => s.id === saleIdToClose);
                            
                            const closeTheTab = () => {
                                const saleIndex = posState.sales.findIndex(s => s.id === saleIdToClose);
                                if (saleIndex === -1) return;

                                posState.sales.splice(saleIndex, 1);
                                if (posState.activeSaleId === saleIdToClose) {
                                    const nextSale = posState.sales.find(s => s.status !== 'held') || posState.sales[0];
                                    posState.activeSaleId = nextSale ? nextSale.id : null;
                                }
                                if (posState.sales.length === 0) {
                                    const newSaleId = `sale_${Date.now()}`;
                                    posState.sales.push({ id: newSaleId, name: `Sale ${posState.saleCounter++}`, cart: [], customer: null, status: 'active' });
                                    posState.activeSaleId = newSaleId;
                                }
                                posFullRender(currentViewPane);
                            };
                            
                            if (saleToClose) {
                                if (saleToClose.cart.length > 0 && saleToClose.status !== 'held') {
                                    const modal = showModal('Cancel Sale', '<p>Are you sure you want to clear all items from this sale? This action cannot be undone.</p>',
                                        `<button data-action="close-modal" class="btn btn-secondary">Keep Sale</button><button id="confirm-cancel-and-close" class="btn btn-danger">Yes, Cancel It</button>`
                                    );
                                    modal.querySelector('#confirm-cancel-and-close').addEventListener('click', () => {
                                        saleToClose.cart = [];
                                        saleToClose.customer = null;
                                        closeTheTab();
                                        showToast('Sale cancelled and tab closed.', 'success');
                                        closeModal(modal);
                                    });
                                } else {
                                    closeTheTab();
                                }
                            }
                            break;
                        }
                        case 'increment-qty': {
                            e.stopPropagation();
                            if (activeSale) {
                                const item = activeSale.cart.find(i => i.isSerialized ? i.serialNumber === serial : i.id === targetId);
                                if (item) {
                                    if (item.stock === Infinity || item.qty < item.stock) {
                                        item.qty++;
                                    } else {
                                        showToast(`No more stock for ${item.name}.`, 'warning');
                                    }
                                    posFullRender(currentViewPane);
                                }
                            }
                            break;
                        }
                        case 'decrement-qty': {
                            e.stopPropagation();
                            if (activeSale) {
                                const item = activeSale.cart.find(i => i.isSerialized ? i.serialNumber === serial : i.id === targetId);
                                if (item && item.qty > 1) {
                                    item.qty--;
                                    posFullRender(currentViewPane);
                                }
                            }
                            break;
                        }
                        case 'remove-from-cart': {
                             if(activeSale) {
                                e.stopPropagation();
                                activeSale.cart = activeSale.cart.filter(item => item.isSerialized ? item.serialNumber !== serial : item.id !== targetId);
                                posFullRender(currentViewPane);
                             }
                             break;
                        }
                        case 'edit-cart-item': {
                            e.stopPropagation();
                            if(activeSale) {
                                openEditCartItemModal(targetId, serial);
                            }
                            break;
                        }
                        case 'process-payment': { 
                             openPaymentModal(); 
                             break; 
                        }
                        case 'add-customer-to-sale': {
                            if(!activeSale) { showToast('No active sale', 'error'); return; }
                            let content = `
                                <input type="text" id="customer-search" placeholder="Search by name, phone, or email..." class="form-input w-full mb-4">
                                <div id="customer-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                                <div class="text-center pt-4 border-t border-border-color mt-4">
                                    <button id="create-new-customer-btn" class="btn btn-secondary w-full">
                                        <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>Create New Customer
                                    </button>
                                </div>
                            `;
                            const modal = showModal('Select Customer', content, '');
                            lucide.createIcons();
                            const customerListEl = modal.querySelector('#customer-list');

                            const renderCustomerList = (filter = '') => {
                                const query = filter.toLowerCase();
                                const filteredCustomers = firestoreData.customers.filter(c => 
                                    c.name.toLowerCase().includes(query) ||
                                    c.phone.includes(query) ||
                                    c.email.toLowerCase().includes(query)
                                );
                                customerListEl.innerHTML = filteredCustomers.length > 0
                                    ? filteredCustomers.map(c => `<div data-action="select-customer" data-id="${c.id}" class="p-3 rounded-lg hover:bg-bg-tertiary cursor-pointer"><p class="font-medium text-text-primary">${c.name}</p><p class="text-sm">${c.phone}</p></div>`).join('')
                                    : '<p class="text-center text-sm p-4">No customers found.</p>';
                            };

                            modal.querySelector('#customer-search').addEventListener('input', e => renderCustomerList(e.target.value));
                            
                            customerListEl.addEventListener('click', e => {
                                 const customerTarget = e.target.closest('[data-action="select-customer"]');
                                 if(customerTarget) {
                                     const customer = firestoreData.customers.find(c => c.id === customerTarget.dataset.id);
                                     activeSale.customer = customer;
                                     activeSale.status = 'active';
                                     posFullRender(currentViewPane);
                                     closeModal(modal);
                                 }
                            });

                            modal.querySelector('#create-new-customer-btn').addEventListener('click', () => {
                                closeModal(modal);
                                openCustomerModal(null, (newCustomer) => {
                                    const activeSaleForCallback = posState.sales.find(s => s.id === posState.activeSaleId);
                                    if (activeSaleForCallback && newCustomer) {
                                        activeSaleForCallback.customer = newCustomer;
                                        const currentPosPane = document.getElementById('workspace-content').querySelector('.view-pane');
                                        posFullRender(currentPosPane);
                                    }
                                });
                            });

                             renderCustomerList();
                             break;
                        }
                        case 'remove-customer-from-sale': {
                            if(activeSale) activeSale.customer = null;
                            posFullRender(currentViewPane);
                            break;
                        }
                        case 'apply-total-discount': {
                            openTotalDiscountModal();
                            break;
                        }
                    }
                }
                
                // This is the code for the "logout" job
                if (action === 'logout') {
                    signOut(auth).then(() => {
                        // Clear local state to ensure a clean login next time
                        appState.tabs = [];
                        appState.activeTabId = null;
                        appState.session.currentUser = null;
                        appState.session.userRole = null;
                        appState.session.userPermissions = {};
                        posState = { sales: [], activeSaleId: null, saleCounter: 1 };
                        saveState(); // Persist the cleared state
                        // The onAuthStateChanged listener will automatically handle showing the login screen.
                        console.log('User signed out successfully.');
                        showToast('You have been logged out.', 'info');
                    }).catch(error => {
                        console.error('Sign out error', error);
                        showToast(`Error logging out: ${error.message}`, 'error');
                    });
                }

                if (action === 'invite-staff') {
                    const currentUserRole = appState.session.userRole;
                    if (currentUserRole === 'admin') {
                        openAdminInviteStaffModal();
                    } else if (currentUserRole === 'manager' && checkPermission('canInviteCashiers')) {
                        openManagerInviteCashierModal();
                    } else {
                        showToast("You do not have permission to invite staff.", "error");
                    }
                    return;
                }

                if (action === 'edit-staff') {
                    const currentUserRole = appState.session.userRole;
                     if (currentUserRole === 'admin' && checkPermission('canManageStaff')) {
                        openAdminEditStaffModal(targetId);
                    } else if (currentUserRole === 'manager' && checkPermission('canEditCashierDetails')) {
                        openManagerEditStaffModal(targetId);
                    } else {
                        showToast("You do not have permission to edit staff details.", "error");
                    }
                    return;
                }
                
                if (action === 'view-staff-details') { 
                    const staffId = actionTarget.dataset.id;
                    const container = currentViewPane.querySelector('#staff-view-container');
                    if (container) {
                        renderStaffDetailView(staffId, container);
                    }
                }

                    if (action === 'back-to-staff-list') { // NEW
                    const container = currentViewPane.querySelector('#staff-view-container');
                    if (container) {
                        // We pass currentViewPane because initStaff expects the parent pane
                        initStaff(currentViewPane.querySelector('#staff-view-container'));
                    }
                }

                // --- NEW VOID FUNCTIONS START ---
                async function voidInvoice(invoiceId, reason, requestDetails = {}) {
                    const invoice = firestoreData.invoices.find(i => i.id === invoiceId);
                    if (!invoice) {
                        showToast('Invoice not found.', 'error');
                        return;
                    }

                    try {
                        await runTransaction(db, async (transaction) => {
                            // --- STAGE 1: READS ---
                            const invoiceRef = doc(invoicesRef, invoice.id);
                            
                            // Prepare product reads
                            const productRefs = {};
                            const productDocPromises = [];
                            for (const item of invoice.items) {
                                if (!productRefs[item.id]) { // Avoid duplicate reads
                                    const productRef = doc(productsRef, item.id);
                                    productRefs[item.id] = productRef;
                                    productDocPromises.push(transaction.get(productRef));
                                }
                            }

                            // Prepare customer read
                            let customerRef = null;
                            let customerDocPromise = null;
                            if (invoice.customerId) {
                                customerRef = doc(customersRef, invoice.customerId);
                                customerDocPromise = transaction.get(customerRef);
                            }

                            // Execute all reads
                            const productDocs = await Promise.all(productDocPromises);
                            const customerDoc = customerDocPromise ? await customerDocPromise : null;

                            // --- STAGE 2: WRITES ---

                            // 1. Restore inventory for each product.
                            productDocs.forEach((productDoc) => {
                                if (productDoc.exists()) {
                                    const productData = productDoc.data();
                                    const productRef = productRefs[productDoc.id];
                                    const itemsInInvoice = invoice.items.filter(i => i.id === productDoc.id);
                                    
                                    const updatePayload = {};

                                    if (productData.productType === 'physical') {
                                        if (productData.isSerialized) {
                                            const serialsToAdd = itemsInInvoice.map(i => i.serialNumber).filter(Boolean);
                                            const newSerials = [...new Set([...(productData.serials || []), ...serialsToAdd])];
                                            updatePayload.serials = newSerials;
                                            updatePayload.stock = newSerials.length;
                                        } else {
                                            const totalQtyToRestore = itemsInInvoice.reduce((sum, i) => sum + (i.qty || 1), 0);
                                            updatePayload.stock = (productData.stock || 0) + totalQtyToRestore;
                                        }
                                    }
                                    
                                    const totalSalesToReverse = itemsInInvoice.reduce((sum, i) => sum + (i.qty || 1), 0);
                                    updatePayload.sales = Math.max(0, (productData.sales || 0) - totalSalesToReverse);
                                    
                                    transaction.update(productRef, updatePayload);
                                }
                            });

                            // 2. Reverse customer due balance and loyalty points
                            if (customerDoc && customerDoc.exists()) {
                                const customerData = customerDoc.data();
                                const newDue = (customerData.currentDue || 0) - invoice.dueAmount;
                                const newPoints = (customerData.loyaltyPoints || 0) - invoice.pointsEarned;
                                transaction.update(customerRef, {
                                    currentDue: Math.max(0, newDue),
                                    loyaltyPoints: Math.max(0, newPoints)
                                });
                            }

                            // 3. Update invoice status
                            const voidDetails = {
                                ...requestDetails,
                                approvedBy: appState.session.currentUser.uid,
                                approvedByName: appState.session.currentUser.name,
                                approvedAt: new Date().toISOString(),
                                reason: reason
                            };
                            transaction.update(invoiceRef, {
                                status: 'Void',
                                voidDetails: voidDetails
                            });

                            // 4. Create audit log
                            const auditLogRefNew = doc(auditLogRef);
                            transaction.set(auditLogRefNew, {
                                type: 'invoice_void',
                                timestamp: new Date().toISOString(),
                                originalInvoiceId: invoice.id,
                                details: `Invoice ${invoice.id} was voided.`,
                                user: {
                                    id: appState.session.currentUser.uid,
                                    name: appState.session.currentUser.name
                                },
                                voidDetails: voidDetails
                            });
                        });

                        showToast(`Invoice ${invoiceId} has been voided.`, 'success');

                        // If a manager performed the void (either directly or by approving a request), notify the admin.
                        if (appState.session.userRole === 'manager') {
                            const managerName = appState.session.currentUser.name;
                            const message = `Manager <strong>${managerName}</strong> voided invoice <strong>${invoiceId}</strong>. Reason: ${reason}`;
                            await createNotification('warning', message, { targetRoles: ['admin'] });
                        }

                    } catch (error) {
                        console.error("Failed to void invoice:", error);
                        showToast(`Error: ${error.message}`, 'error');
                    }
                }

                function openRequestVoidModal(invoiceId) {
                    const invoice = firestoreData.invoices.find(i => i.id === invoiceId);
                    if (!invoice) return;

                    const content = `
                        <form id="request-void-form" class="space-y-4">
                            <p>You are requesting to void invoice <strong class="text-text-primary font-mono">${invoice.id}</strong>. This requires approval from a manager.</p>
                            <div>
                                <label for="reason" class="block text-sm font-medium mb-1">Reason for Void Request</label>
                                <textarea name="reason" class="form-textarea w-full" required></textarea>
                            </div>
                        </form>`;
                    const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="request-void-form" class="btn btn-danger">Submit Request</button>`;
                    const modal = showModal('Request Invoice Void', content, footer);

                    modal.querySelector('#request-void-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const reason = e.target.reason.value;
                        
                        const voidDetails = {
                            requestedBy: appState.session.currentUser.uid,
                            requestedByName: appState.session.currentUser.name,
                            requestedAt: new Date().toISOString(),
                            requestReason: reason
                        };
                        
                        await updateDoc(doc(invoicesRef, invoiceId), {
                            status: 'Void Requested',
                            voidDetails: voidDetails
                        });
                        
                        await createNotification('warning', `<strong>${appState.session.currentUser.name}</strong> requested to void invoice <strong>${invoiceId}</strong>. Reason: ${reason}`, { targetRoles: ['admin', 'manager'] });

                        showToast('Void request submitted for approval.', 'success');
                        closeModal(modal);
                    });
                }

                function openDirectVoidModal(invoiceId) {
                    const invoice = firestoreData.invoices.find(i => i.id === invoiceId);
                    if (!invoice) return;

                    const content = `
                        <form id="direct-void-form" class="space-y-4">
                            <p>You are about to void invoice <strong class="text-text-primary font-mono">${invoice.id}</strong>. This will restore inventory and reverse the transaction. This action is irreversible.</p>
                            <div>
                                <label for="reason" class="block text-sm font-medium mb-1">Reason for Void</label>
                                <textarea name="reason" class="form-textarea w-full" required></textarea>
                            </div>
                        </form>`;
                    const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="direct-void-form" class="btn btn-danger">Confirm Void</button>`;
                    const modal = showModal('Void Invoice', content, footer);
                    
                    modal.querySelector('#direct-void-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const reason = e.target.reason.value;
                        closeModal(modal);
                        await voidInvoice(invoiceId, reason);
                    });
                }
                
                function openReviewVoidRequestModal(invoiceId) {
                    const invoice = firestoreData.invoices.find(i => i.id === invoiceId);
                    if (!invoice || !invoice.voidDetails) return;

                    const content = `
                        <div class="space-y-4">
                            <p>Reviewing void request for invoice <strong class="text-text-primary font-mono">${invoice.id}</strong>.</p>
                            <div class="bg-bg-tertiary p-3 rounded-lg">
                                <p class="text-xs text-text-secondary">Requested by: <strong>${invoice.voidDetails.requestedByName}</strong> on ${new Date(invoice.voidDetails.requestedAt).toLocaleString()}</p>
                                <p class="mt-2">Reason: <span class="text-text-primary">${invoice.voidDetails.requestReason}</span></p>
                            </div>
                            <div>
                                <label for="approval-reason" class="block text-sm font-medium mb-1">Your Reason / Notes (Required for Approval)</label>
                                <textarea id="approval-reason" class="form-textarea w-full"></textarea>
                            </div>
                        </div>
                    `;
                    const footer = `
                        <button id="reject-void" class="btn btn-secondary">Reject Request</button>
                        <button id="approve-void" class="btn btn-danger">Approve & Void Invoice</button>`;
                    const modal = showModal('Review Void Request', content, footer);

                    modal.querySelector('#reject-void').addEventListener('click', async () => {
                        await updateDoc(doc(invoicesRef, invoiceId), {
                            status: 'Paid', // Revert to a default "good" state. A more complex system might store the pre-request state.
                            voidDetails: null
                        });
                        showToast('Void request rejected.', 'info');
                        closeModal(modal);
                    });

                    modal.querySelector('#approve-void').addEventListener('click', async () => {
                        const reason = modal.querySelector('#approval-reason').value;
                        if (!reason.trim()) {
                            showToast('A reason for approval is required.', 'error');
                            return;
                        }
                        closeModal(modal);
                        await voidInvoice(invoiceId, reason, invoice.voidDetails);
                    });
                }
                // --- NEW VOID FUNCTIONS END ---

                if (action === 'close-modal') { closeModal(actionTarget.closest('.modal-overlay')); }

                if (action === 'view-staff-performance') {
                    openViewStaffPerformanceModal(targetId);
                }

                if (action === 'toggle-staff-status') {
                    if (!checkPermission('canManageStaff')) {
                        showToast("You don't have permission to change staff status.", "error");
                        return;
                    }
                    const member = firestoreData.staff.find(m => m.id === targetId);
                    if (!member) return;
                    const newStatus = actionTarget.dataset.newStatus;
                    const actionText = newStatus === 'inactive' ? 'Deactivate' : 'Activate';

                    const modal = showModal(
                        `${actionText} Account`,
                        `<p>Are you sure you want to ${actionText.toLowerCase()} the account for <strong>${member.name}</strong>? An inactive user will not be able to log in.</p>`,
                        `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-status-change" class="btn ${newStatus === 'inactive' ? 'btn-danger' : 'btn-primary'}">${actionText}</button>`
                    );
                    modal.querySelector('#confirm-status-change').addEventListener('click', async () => {
                        try {
                            await updateDoc(doc(staffRef, targetId), { status: newStatus });
                            showToast(`${member.name}'s account has been ${newStatus}.`, 'success');
                            closeModal(modal);
                        } catch (error) {
                            showToast('Failed to update status.', 'error');
                            console.error(error);
                        }
                    });
                }

                if (action === 'delete-staff') {
                    if (!checkPermission('canManageStaff')) {
                        showToast("You don't have permission to delete staff.", "error");
                        return;
                    }
                    const member = firestoreData.staff.find(m => m.id === targetId);
                    if (!member) return;
                    
                    const modal = showModal(
                        'Delete Staff Member',
                        `<div class="space-y-2"><p>Are you sure you want to permanently delete <strong>${member.name}</strong>?</p><p class="text-sm text-yellow-300 bg-yellow-900/50 p-3 rounded-lg"><i data-lucide="alert-triangle" class="inline w-4 h-4 mr-1"></i> This action is irreversible and will remove their access and data permanently.</p></div>`,
                        `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-delete" class="btn btn-danger">Yes, Delete Permanently</button>`
                    );
                    lucide.createIcons();
                    modal.querySelector('#confirm-delete').addEventListener('click', async () => {
                        try {
                            // Note: In a real app, you might want to disable the Auth user too, but that requires a backend. Here we just delete the Firestore doc.
                            await deleteDoc(doc(staffRef, targetId));
                            showToast(`${member.name} has been deleted.`, 'success');
                            closeModal(modal);
                        } catch (error) {
                            showToast('Failed to delete staff member.', 'error');
                            console.error(error);
                        }
                    });
                }

                if (action === 'approve-staff') {
                    if (!checkPermission('canManageStaff')) return;
                    const member = firestoreData.staff.find(m => m.id === targetId);
                    if (!member) return;
                    const modal = showModal('Approve Staff Member', `<p>Are you sure you want to approve <strong>${member.name}</strong>? They will be granted access to the system as a Cashier.</p>`, `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-approve" class="btn btn-primary">Approve</button>`);
                    modal.querySelector('#confirm-approve').addEventListener('click', async () => {
                        try {
                            await updateDoc(doc(staffRef, targetId), { status: 'active' });
                            showToast(`${member.name} has been approved and is now active.`, 'success');
                            closeModal(modal);
                        } catch (error) {
                            showToast('Failed to approve staff member.', 'error');
                            console.error(error);
                        }
                    });
                }

                if (action === 'request-deactivation') {
                    if (!checkPermission('canRequestStaffDeactivation')) return;
                    openRequestDeactivationModal(targetId);
                }
                
                if (action === 'approve-deactivation') {
                    if (!checkPermission('canManageStaff')) return;
                    const member = firestoreData.staff.find(m => m.id === targetId);
                    if (!member) return;
                    const modal = showModal('Approve Deactivation', `<p>Are you sure you want to approve the request to deactivate <strong>${member.name}</strong>? Their account will become inactive and they will not be able to log in.</p>`, `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-approve-deactivation" class="btn btn-danger">Yes, Deactivate</button>`);
                    modal.querySelector('#confirm-approve-deactivation').addEventListener('click', async () => {
                        try {
                            await updateDoc(doc(staffRef, targetId), { status: 'inactive', deactivationRequest: null });
                            showToast(`${member.name} has been deactivated.`, 'success');
                            closeModal(modal);
                        } catch (error) {
                            showToast('Failed to deactivate staff member.', 'error');
                            console.error(error);
                        }
                    });
                }

                if (action === 'reject-deactivation') {
                    if (!checkPermission('canManageStaff')) return;
                    const member = firestoreData.staff.find(m => m.id === targetId);
                    if (!member) return;
                    const modal = showModal('Reject Deactivation', `<p>Are you sure you want to reject the request to deactivate <strong>${member.name}</strong>? Their account will remain active.</p>`, `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-reject-deactivation" class="btn btn-primary">Reject Request</button>`);
                    modal.querySelector('#confirm-reject-deactivation').addEventListener('click', async () => {
                        try {
                            await updateDoc(doc(staffRef, targetId), { status: 'active', deactivationRequest: null });
                            showToast(`Deactivation request for ${member.name} has been rejected.`, 'success');
                            closeModal(modal);
                        } catch (error) {
                            showToast('Failed to reject request.', 'error');
                            console.error(error);
                        }
                    });
                }

                if (action === 'close-modal') { closeModal(actionTarget.closest('.modal-overlay')); }
                if (action === 'set-currency') {
                    appState.currentCurrency = actionTarget.dataset.currencyCode;
                    renderApp();
                }

                if (action === 'toggle-action-menu') {
                    e.stopPropagation(); 
                    const menu = actionTarget.nextElementSibling;
                    if (!menu || !menu.classList.contains('action-menu')) return;
                    const isCurrentlyOpen = menu.classList.contains('open');
                    document.querySelectorAll('.action-menu.open').forEach(m => {
                        if (m !== menu) m.classList.remove('open', 'open-up');
                    });

                    if (!isCurrentlyOpen) {
                        const rect = actionTarget.getBoundingClientRect();
                        const menuHeight = menu.offsetHeight > 0 ? menu.offsetHeight : 220; 
                        if (rect.bottom + menuHeight > window.innerHeight) {
                            menu.classList.add('open-up');
                        } else {
                            menu.classList.remove('open-up');
                        }
                        menu.classList.add('open');
                    } else {
                         menu.classList.remove('open', 'open-up');
                    }
                }
                if (action === 'initiate-return') {
                  e.stopPropagation();
                  if (checkPermission('canProcessReturns')) {
                      openReturnModal(targetId);
                  } else {
                      showToast('You do not have permission to process returns.', 'error');
                  }
                  return;
                }
                if (action === 'add-quotation' || action === 'edit-quotation') {
    e.stopPropagation();
    const quotationId = action === 'edit-quotation' ? targetId : null;
    if (checkPermission('canManageQuotations')) {
        openQuotationModal(quotationId);
    } else {
        showToast('You do not have permission to manage quotations.', 'error');
    }
}

if (action === 'view-quotation') {
    e.stopPropagation();
    viewQuotationModal(targetId);
}

if (action === 'delete-quotation') {
    e.stopPropagation();
    if (!checkPermission('canDeleteQuotations')) {
        showToast('You do not have permission to delete quotations.', 'error');
        return;
    }
    const q = firestoreData.quotations.find(q => q.id === targetId);
    if (!q) return;
    
    const deleteModal = showModal('Delete Quotation', `Are you sure you want to delete Quotation #${q.quotationNumber || q.id}?`, `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-delete" class="btn btn-danger">Delete</button>`);
    deleteModal.querySelector('#confirm-delete').addEventListener('click', async () => {
        await deleteDoc(doc(quotationsRef, targetId));
        showToast('Quotation deleted.', 'success');
        closeModal(deleteModal);
    });
}

if (action === 'convert-to-invoice') {
    e.stopPropagation();
    closeModal(actionTarget.closest('.modal-overlay'));
    if (!checkPermission('canConvertToInvoice')) {
        showToast('You do not have permission to convert quotations.', 'error');
        return;
    }
    convertToInvoice(targetId);
}

if (action === 'mark-quotation-sent') {
    e.stopPropagation();
    const qId = targetId;
    await updateDoc(doc(quotationsRef, qId), { status: 'Sent' });
    showToast('Quotation marked as sent.', 'success');
    closeModal(actionTarget.closest('.modal-overlay'));
    viewQuotationModal(qId); // Re-open the view modal
}

                if (action === 'show-full-stat') {
                    const label = actionTarget.dataset.label;
                    const fullValue = actionTarget.dataset.fullValue;
                    const content = `<p class="text-2xl font-mono text-center p-4">${fullValue}</p>`;
                    showModal(label, content, `<button data-action="close-modal" class="btn btn-secondary">Close</button>`, { size: 'max-w-md' });
                }

                if (action === 'toggle-product-status') { // NEW
                    if (!checkPermission('canDeactivateProducts')) {
                        showToast("You don't have permission to change product status.", "error");
                        return;
                    }
                    const productId = targetId;
                    const product = firestoreData.products.find(p => p.id === productId);
                    if (!product) return;
                    
                    const term = getCurrentProfile().terminology;
                    const currentStatus = product.status || 'active';
                    const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
                    const actionText = newStatus === 'inactive' ? 'Deactivate' : 'Activate';

                    const modal = showModal(
                        `${actionText} ${term.product}`,
                        `<p>Are you sure you want to ${actionText.toLowerCase()} <strong>${product.name}</strong>? An inactive product will be hidden from the POS terminal.</p>`,
                        `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-status-change" class="btn ${newStatus === 'inactive' ? 'btn-danger' : 'btn-primary'}">${actionText}</button>`
                    );

                    modal.querySelector('#confirm-status-change').addEventListener('click', async () => {
                        try {
                            // 1. Update Firestore document
                            await updateDoc(doc(productsRef, productId), { status: newStatus });
                            
                            // 2. Create Audit Log
                            await addDoc(auditLogRef, {
                                type: 'product_status_change',
                                timestamp: new Date().toISOString(),
                                productId: product.id,
                                productName: product.name,
                                details: `Product status changed from '${currentStatus}' to '${newStatus}'.`,
                                user: {
                                    id: appState.session.currentUser.uid,
                                    name: appState.session.currentUser.name
                                }
                            });
                            
                            // NEW: If a manager deactivates a product, create a notification for the admin.
                            // If a manager deactivates a product, create a notification for the admin.
                            if (appState.session.userRole === 'manager' && newStatus === 'inactive') {
                                const managerName = appState.session.currentUser.name;
                                const message = `Manager <strong>${managerName}</strong> deactivated ${term.product}: <strong>${product.name}</strong>.`;
                                await createNotification('warning', message, { targetRoles: ['admin'] });
                            }
                            
                            showToast(`${product.name} has been ${newStatus}.`, 'success');
                            closeModal(modal);

                            // FIX: Get the current inventory container from the DOM. This was the source of the ReferenceError.
                            const inventoryContainer = document.querySelector('#inventory-view-container');
                            
                            // Refresh the view if it's the product detail view, otherwise the snapshot listener will refresh the list.
                            if (inventoryContainer && inventoryContainer.querySelector('#product-detail-view')) {
                                renderProductDetailView(productId, inventoryContainer);
                            }
                        } catch (error) {
                            showToast('Failed to update product status.', 'error');
                            console.error(error);
                        }
                    });
                }

                if (action === 'delete-product') {
                    if (!checkPermission('canDeleteProducts')) { // MODIFIED to use new permission
                        showToast("You don't have permission to delete products.", "error");
                        return;
                    }
                     const productIdToDelete = targetId;
                    const productToDelete = firestoreData.products.find(p => p.id === productIdToDelete);
                    if (!productToDelete) return;

                    const modal = showModal(
                        'Confirm Deletion',
                        `<p>Are you sure you want to permanently delete <strong>${productToDelete.name}</strong>? This action cannot be undone.</p>`,
                        `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-delete-product" class="btn btn-danger">Delete</button>`
                    );

                    modal.querySelector('#confirm-delete-product').addEventListener('click', async () => { // MODIFIED to be async
                        closeModal(modal);
                        try {
                            // 1. Create Audit Log for deletion
                             await addDoc(auditLogRef, {
                                type: 'product_delete',
                                timestamp: new Date().toISOString(),
                                productId: productToDelete.id,
                                productName: productToDelete.name,
                                details: `Product '${productToDelete.name}' was permanently deleted.`,
                                user: {
                                    id: appState.session.currentUser.uid,
                                    name: appState.session.currentUser.name
                                }
                            });
                            
                            // NEW: If a manager deletes a product, create a notification for the admin.
                            if (appState.session.userRole === 'manager') {
                                const managerName = appState.session.currentUser.name;
                                const message = `Manager <strong>${managerName}</strong> deleted ${term.product}: <strong>${productToDelete.name}</strong>.`;
                                await createNotification('warning', message, { targetRoles: ['admin'] });
                            }
                            
                            // 2. Delete the product document
                            await deleteDoc(doc(productsRef, productIdToDelete));

                            showToast(`Product "${productToDelete.name}" has been deleted.`, 'success');

                        } catch (err) {
                            console.error("Failed to delete product or log action:", err);
                            showToast(`Error deleting ${productToDelete.name}.`, 'error');
                        }
                    });
                }
// --- NEW VOID ACTIONS ---
                if (action === 'request-void') {
                    openRequestVoidModal(targetId);
                }
                if (action === 'review-void-request') {
                    openReviewVoidRequestModal(targetId);
                }
                if (action === 'void-invoice') {
                    openDirectVoidModal(targetId);
                }
                if (action === 'cancel-void-request') {
                    const invoiceId = targetId;
                    const invoice = firestoreData.invoices.find(i => i.id === invoiceId);
                    if (!invoice || invoice.status !== 'Void Requested' || invoice.voidDetails.requestedBy !== appState.session.currentUser.uid) {
                        showToast("Cannot cancel this request.", "error");
                        return;
                    }

                    const modal = showModal(
                        'Cancel Void Request',
                        `<p>Are you sure you want to cancel your request to void invoice <strong>${invoiceId}</strong>?</p>`,
                        `<button data-action="close-modal" class="btn btn-secondary">No</button><button id="confirm-cancel-void" class="btn btn-primary">Yes, Cancel Request</button>`
                    );

                    modal.querySelector('#confirm-cancel-void').addEventListener('click', async () => {
                        try {
                            let previousStatus = 'Paid'; // Default
                            if (invoice.dueAmount > 0.001) {
                                if (Math.abs(invoice.dueAmount - invoice.totalInBaseCurrency) < 0.001) {
                                    previousStatus = 'Due';
                                } else {
                                    previousStatus = 'Partial';
                                }
                            }
                            await updateDoc(doc(invoicesRef, invoiceId), {
                                status: previousStatus,
                                voidDetails: null
                            });
                            showToast('Void request has been cancelled.', 'success');
                            closeModal(modal);
                        } catch (error) {
                            console.error("Error cancelling void request:", error);
                            showToast('Failed to cancel request.', 'error');
                        }
                    });
                }


                if (action === 'close-modal') { closeModal(actionTarget.closest('.modal-overlay')); }

                if (action === 'view-staff-performance') {
                    openProductFormModal(isEditing, product);
                }

                if (action === 'receive-payment') {
                    e.stopPropagation();
                    openReceivePaymentModal(targetId);
                }

                if (action === 'view-product-details') {
                    const container = currentViewPane.querySelector('#inventory-view-container');
                    if (container) {
                        const product = firestoreData.products.find(p => p.id === targetId);
                        if (product.hasVariants) {
                            renderVariantManagementView(targetId, container);
                        } else {
                             renderProductDetailView(targetId, container);
                        }
                    }
                }
                
                 if (action === 'add-customer') {
                    if (!checkPermission('canManageCustomers')) {
                        showToast("You don't have permission to add customers.", "error");
                        return;
                    }
                    e.stopPropagation();
                    openCustomerModal(null);
                 }
                 if(action === 'edit-customer') {
                   if (!checkPermission('canManageStaff')) {
                       showToast("You don't have permission to edit customers.", "error");
                       return;
                   }
                   e.stopPropagation();
                   const customerId = targetId;
                   openCustomerModal(customerId);
                }

                if (action === 'delete-customer') {
                    if (!checkPermission('canManageStaff')) {
                        showToast("You don't have permission to delete customers.", "error");
                        return;
                    }
                    e.stopPropagation();
                    const customerId = targetId;
                    const customer = firestoreData.customers.find(c => c.id === customerId);
                    if (!customer) {
                        showToast('Customer not found.', 'error');
                        return;
                    }
                
                    const hasInvoices = firestoreData.invoices.some(inv => inv.customerId === customerId);
                    if (hasInvoices) {
                        showToast('Cannot delete customer. They are associated with existing invoices.', 'error');
                        return;
                    }
                    
                    if (customer.currentDue && customer.currentDue > 0) {
                        showToast(`Cannot delete ${customer.name}. They have an outstanding balance of ${currencyUtils.format(customer.currentDue)}.`, 'error');
                        return;
                    }
                
                    const modal = showModal(
                        'Delete Customer',
                        `<p>Are you sure you want to permanently delete <strong>${customer.name}</strong>? This action cannot be undone.</p>`,
                        `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-delete-customer" class="btn btn-danger">Delete</button>`
                    );
                    modal.querySelector('#confirm-delete-customer').addEventListener('click', async () => {
                        try {
                            await deleteDoc(doc(customersRef, customerId));
                            showToast(`Customer "${customer.name}" has been deleted.`, 'success');
                            closeModal(modal);
                        } catch (error) {
                            console.error('Error deleting customer:', error);
                            showToast('Failed to delete customer.', 'error');
                            closeModal(modal);
                        }
                    });
                }

                if (action === 'view-customer-invoices') {
                    e.stopPropagation();
                    openCustomerInvoicesModal(targetId);
                }

                if (action === 'view-invoice' || action === 'print-invoice') {
                    const invoiceId = targetId;
                    const invoice = firestoreData.invoices.find(i => i.id === invoiceId);
                    if (!invoice) return;

                    if (invoice.customerId) {
                        invoice.customer = firestoreData.customers.find(c => c.id === invoice.customerId);
                    }
                    showReceipt(invoice);
                }

                if (action === 'email-invoice') {
                    openEmailInvoiceModal(targetId);
                }
                
                if (action === 'delete-invoice') {
                    if (appState.session.userRole !== 'admin') {
                        showToast("You do not have permission to delete invoices.", "error");
                        return;
                    }
                    const invoiceId = targetId;
                    const invoice = firestoreData.invoices.find(i => i.id === invoiceId);
                    if (!invoice) {
                        showToast("Invoice not found.", "error");
                        return;
                    }

                    const modal = showModal(
                        'Delete Invoice',
                        `<p>Are you sure you want to permanently delete invoice <strong>${invoiceId}</strong>? This action will restore stock and is irreversible.</p>`,
                        `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-delete" class="btn btn-danger">Delete</button>`
                    );

                    modal.querySelector('#confirm-delete').addEventListener('click', async () => {
                        closeModal(modal);
                        showToast(`Deleting invoice and restoring stock...`, 'info');

                        try {
                            await runTransaction(db, async (transaction) => {
                                // --- STAGE 1: READS ---
                                const invoiceRef = doc(invoicesRef, invoiceId);
                                
                                const productRefs = {};
                                const productDocPromises = [];
                                for (const item of invoice.items) {
                                    // Use item.id which corresponds to the product's SKU/ID
                                    const productId = item.id; 
                                    if (!productRefs[productId]) {
                                        const productRef = doc(productsRef, productId);
                                        productRefs[productId] = productRef;
                                        productDocPromises.push(transaction.get(productRef));
                                    }
                                }
                                const productDocs = await Promise.all(productDocPromises);

                                // --- STAGE 2: WRITES ---

                                // 1. Restore inventory for each product.
                                productDocs.forEach((productDoc) => {
                                    if (productDoc.exists()) {
                                        const productData = productDoc.data();
                                        const productRef = productRefs[productDoc.id];
                                        const itemsInInvoice = invoice.items.filter(i => i.id === productDoc.id);
                                        
                                        const updatePayload = {};

                                        if (productData.productType === 'physical') {
                                            if (productData.isSerialized) {
                                                const serialsToAddBack = itemsInInvoice.map(i => i.serialNumber).filter(Boolean);
                                                const newSerials = [...new Set([...(productData.serials || []), ...serialsToAddBack])];
                                                updatePayload.serials = newSerials;
                                                updatePayload.stock = newSerials.length;
                                            } else {
                                                const totalQtyToRestore = itemsInInvoice.reduce((sum, i) => sum + (i.qty || 1), 0);
                                                updatePayload.stock = (productData.stock || 0) + totalQtyToRestore;
                                            }
                                        }
                                        
                                        if (Object.keys(updatePayload).length > 0) {
                                            transaction.update(productRef, updatePayload);
                                        }
                                    }
                                });

                                // 2. Delete the invoice document
                                transaction.delete(invoiceRef);
                            });

                            showToast(`Invoice ${invoiceId} deleted and stock restored.`, 'success');
                        } catch (error) {
                            console.error("Error deleting invoice:", error);
                            showToast(`Failed to delete invoice: ${error.message}`, 'error');
                        }
                    });
                }

                if (action === 'delete-expense') { // NEW
                    const expenseId = actionTarget.dataset.id;
                    const expense = firestoreData.expenses.find(e => e.id === expenseId);
                    if (!expense) return;

                    const modal = showModal(
                        'Delete Expense',
                        `<p>Are you sure you want to permanently delete this expense of <strong>${currencyUtils.format(expense.amountInBase)}</strong> for <strong>${expense.category}</strong>?</p>`,
                        `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-delete-expense" class="btn btn-danger">Delete</button>`
                    );
                    modal.querySelector('#confirm-delete-expense').addEventListener('click', async () => {
                        closeModal(modal);
                        try {
                            await deleteDoc(doc(expensesRef, expenseId));
                            showToast('Expense deleted successfully.', 'success');
                        } catch (error) {
                            console.error("Error deleting expense:", error);
                            showToast('Failed to delete expense.', 'error');
                        }
                    });
                }

                if (action === 'add-expense' || action === 'edit-expense') {
                    if (!checkPermission('canManageExpenses')) {
                        showToast("You don't have permission to manage expenses.", "error");
                        return;
                    }
                    const expenseId = action === 'edit-expense' ? targetId : null;
                    openExpenseModal(expenseId);
                }

                if (action === 'save-settings') {
                    const settingsForm = document.getElementById('settings-form');
                    const currentUser = appState.session.currentUser;

                    const promises = [];

                    // --- Part 1: Save User-Specific POS Layout (for all roles) ---
                    const userStaffRef = doc(staffRef, currentUser.uid);
                    promises.push(
                        updateDoc(userStaffRef, { 'preferences.posLayout': appState.settings.posLayout })
                            .then(() => {
                                if (!currentUser.preferences) currentUser.preferences = {};
                                currentUser.preferences.posLayout = appState.settings.posLayout;
                            })
                    );

                    // --- Part 2: Save Store-Wide Settings (for Manager/Admin) ---
                    if (currentUser.role !== 'cashier') {
                        if (!checkPermission('canManageSettings')) {
                            showToast("You don't have permission to change settings.", "error");
                            return;
                        }

                        const oldStoreName = firestoreData.storeInfo.name;
                        const nameInput = settingsForm.querySelector('[name="name"]');
                        const taxInput = settingsForm.querySelector('[name="taxRate"]');
                        const parsedTax = parseFloat(taxInput?.value);

                        const storeUpdates = {
                            name: nameInput?.value || oldStoreName,
                            address: settingsForm.querySelector('[name="address"]')?.value,
                            contact: settingsForm.querySelector('[name="contact"]')?.value,
                            website: settingsForm.querySelector('[name="website"]')?.value,
                            taxId: settingsForm.querySelector('[name="taxId"]')?.value,
                            socials: settingsForm.querySelector('[name="socials"]')?.value,
                            'settings.defaultCurrency': settingsForm.querySelector('[name="defaultCurrency"]')?.value,
                            'settings.businessType': appState.settings.businessType,
                            'settings.selectedReceiptTemplate': appState.settings.selectedReceiptTemplate,
                            'settings.taxRate': !isNaN(parsedTax) ? parsedTax : appState.settings.taxRate,
                            'settings.defaultUnit': settingsForm.querySelector('[name="defaultUnit"]')?.value,
                            'settings.receiptFooterText': settingsForm.querySelector('[name="receiptFooterText"]')?.value,
                            'settings.automations': appState.settings.automations,
                            'customProfiles': appState.customProfiles,
                        };

                        if (currentUser.role === 'admin') {
                            storeUpdates['settings.permissions'] = appState.settings.permissions;
                            if (storeUpdates.name && storeUpdates.name !== oldStoreName) {
                                storeUpdates.logoUrl = `https://placehold.co/100x100/007BFF/FFFFFF?text=${encodeURIComponent(storeUpdates.name.charAt(0).toUpperCase())}`;
                            }
                        }
                        
                        promises.push(updateDoc(storeRef, storeUpdates));
                    }

                    // --- Execute all saves ---
                    try {
                        await Promise.all(promises);
                        showToast('Settings saved successfully!', 'success');

                        const newStoreName = settingsForm.querySelector('[name="name"]')?.value;
                        const oldStoreName = firestoreData.storeInfo.name;
                        if (currentUser.role === 'admin' && newStoreName && newStoreName !== oldStoreName) {
                            syncStoreNameToUserProfiles(appState.session.storeId, newStoreName);
                        }
                    } catch (error) {
                        console.error("Error saving settings:", error);
                        showToast('Failed to save settings.', 'error');
                    }
                }

                if (action === 'grant-store-access') {
                    // This action is now handled inside openAdminEditStaffModal to pass necessary data.
                    // This is a placeholder to prevent any other logic from firing.
                    e.stopPropagation();
                }

                if (action === 'toggle-pos-category-sidebar') {
                    appState.viewStates.posModern.isCategoryPanelCollapsed = !appState.viewStates.posModern.isCategoryPanelCollapsed;
                    applyPosCategoryPanelState(currentViewPane);
                    saveState();
                }
            });
            
            async function handleAiProductGeneration(prompt) {
                if (!prompt) {
                    showToast('Please enter a product description.', 'error');
                    return;
                }
                
                // Pass the current profile to the AI call for context
                const profile = getCurrentProfile();
                const aiResponse = await callGenerativeAI(prompt, profile);

                if (aiResponse.success && aiResponse.product) {
                    showToast('Product details generated! Please review and save.', 'success');
                    // The AI returns a product object, now we pass it to the form modal
                    // The API returns prices in USD, which is our base currency, so no conversion needed here.
                    openProductFormModal(false, aiResponse.product);
                } else {
                    showToast(aiResponse.error || 'Failed to generate product details.', 'error');
                }
            }

            function openExpenseModal(expenseId = null) {
                const isEditing = !!expenseId;
                const expense = isEditing ? firestoreData.expenses.find(e => e.id === expenseId) : {};
                const amountInDisplay = isEditing ? currencyUtils.convert(expense.amountInBase || 0).toFixed(2) : '';

                const isManager = appState.session.userRole === 'manager';

                const baseCategories = ['Rent', 'Utilities', 'Supplies', 'Salaries', 'Marketing', 'Maintenance', 'Travel', 'Insurance', 'Taxes', 'Miscellaneous'];
                const paymentMethods = ['Cash', 'Card', 'Bank Transfer', 'Other'];

                const content = `
                <form id="expense-form" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Amount (${appState.currentCurrency})</label>
                            <input type="number" name="amount" value="${amountInDisplay}" class="w-full form-input" required step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Date</label>
                            <input type="date" name="date" value="${expense.date || new Date().toISOString().slice(0, 10)}" class="w-full form-input" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-secondary mb-1">Paid To (Vendor/Recipient)</label>
                        <input type="text" name="paidTo" value="${expense.paidTo || ''}" class="w-full form-input" placeholder="e.g., Office Supplies Co.">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Category</label>
                            ${isManager ? `
                                <input type="text" name="category" value="Utilities" class="w-full form-input bg-bg-tertiary" readonly>
                            ` : `
                                <div id="category-wrapper">
                                    <!-- This container will be dynamically filled -->
                                </div>
                            `}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Payment Method</label>
                            <select name="paymentMethod" class="form-select w-full">
                                ${paymentMethods.map(p => `<option value="${p}" ${expense.paymentMethod === p ? 'selected' : ''}>${p}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-secondary mb-1">Receipt URL (Optional)</label>
                        <input type="url" name="receiptUrl" value="${expense.receiptUrl || ''}" class="w-full form-input" placeholder="https://">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-secondary mb-1">Notes (Optional)</label>
                        <textarea name="notes" class="form-textarea w-full h-24">${expense.notes || ''}</textarea>
                    </div>
                </form>
                `;

                const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="expense-form" class="btn btn-primary">${isEditing ? 'Save Changes' : 'Log Expense'}</button>`;
                const modal = showModal(isEditing ? 'Edit Expense' : 'Log New Expense', content, footer);

                // --- NEW: Dynamic Category UI Logic ---
                const renderCategorySelector = (selectedCategory = null) => {
                    const customCategories = appState.settings.expenseCategories || [];
                    const allCategories = [...new Set([...baseCategories, ...customCategories])].sort();
                    const categoryWrapper = modal.querySelector('#category-wrapper');

                    categoryWrapper.innerHTML = `
                        <select name="category" class="form-select w-full" required>
                            <option value="" disabled ${!selectedCategory ? 'selected' : ''}>Select a category...</option>
                            ${allCategories.map(c => `<option value="${c}" ${selectedCategory === c ? 'selected' : ''}>${c}</option>`).join('')}
                            <option value="--new--" class="text-accent font-semibold border-t border-border-color mt-1 pt-1">-- Add New Category --</option>
                        </select>
                    `;
                    
                    const categorySelect = categoryWrapper.querySelector('select');
                    categorySelect.addEventListener('change', () => {
                        if (categorySelect.value === '--new--') {
                            renderNewCategoryInput(selectedCategory);
                        }
                    });
                };

                const renderNewCategoryInput = (previousSelection) => {
                    const categoryWrapper = modal.querySelector('#category-wrapper');
                    categoryWrapper.innerHTML = `
                        <div class="flex items-center gap-2">
                            <input type="text" id="new-expense-category-input" class="form-input w-full" placeholder="New category name...">
                            <button type="button" id="save-new-category-btn" class="btn btn-success p-2 shrink-0" title="Save Category"><i data-lucide="check" class="w-4 h-4 pointer-events-none"></i></button>
                            <button type="button" id="cancel-new-category-btn" class="btn btn-secondary p-2 shrink-0" title="Cancel"><i data-lucide="x" class="w-4 h-4 pointer-events-none"></i></button>
                        </div>
                    `;
                    lucide.createIcons();

                    const newCategoryInput = categoryWrapper.querySelector('#new-expense-category-input');
                    newCategoryInput.focus();

                    categoryWrapper.querySelector('#cancel-new-category-btn').addEventListener('click', () => {
                        renderCategorySelector(previousSelection);
                    });
                    
                    const saveNewCategory = async () => {
                        const newCategoryName = newCategoryInput.value.trim();
                        if (!newCategoryName) {
                            showToast('Please enter a name for the new category.', 'error');
                            newCategoryInput.focus();
                            return;
                        }

                        const currentCustomCategories = appState.settings.expenseCategories || [];
                        const allExistingCategories = [...baseCategories, ...currentCustomCategories];

                        if (!allExistingCategories.find(c => c.toLowerCase() === newCategoryName.toLowerCase())) {
                            const updatedCategories = [...currentCustomCategories, newCategoryName];
                            await updateDoc(storeRef, { 'settings.expenseCategories': updatedCategories });
                            showToast(`New category "${newCategoryName}" saved.`, 'info');
                            renderCategorySelector(newCategoryName);
                        } else {
                            showToast(`Category "${newCategoryName}" already exists.`, 'warning');
                            renderCategorySelector(newCategoryName);
                        }
                    };

                    categoryWrapper.querySelector('#save-new-category-btn').addEventListener('click', saveNewCategory);
                    newCategoryInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            saveNewCategory();
                        } else if (e.key === 'Escape') {
                            renderCategorySelector(previousSelection);
                        }
                    });
                };

                // Initial Render
                if (!isManager) {
                    renderCategorySelector(expense.category);
                }
                // --- END NEW ---

                modal.querySelector('#expense-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const amountInDisplay = parseFloat(formData.get('amount'));
                    const finalCategory = formData.get('category');

                    if (!finalCategory) {
                        showToast('Please select or create a category.', 'error');
                        return;
                    }

                    const data = {
                        amountInBase: currencyUtils.convertToBase(amountInDisplay),
                        currency: appState.currentCurrency,
                        date: formData.get('date'),
                        category: finalCategory,
                        paidTo: formData.get('paidTo'),
                        paymentMethod: formData.get('paymentMethod'),
                        receiptUrl: formData.get('receiptUrl'),
                        notes: formData.get('notes'),
                        recordedBy: {
                            id: appState.session.currentUser.uid,
                            name: appState.session.currentUser.name
                        },
                        lastUpdatedAt: new Date().toISOString()
                    };

                    try {
                        if (isEditing) {
                            await updateDoc(doc(expensesRef, expenseId), data);
                            showToast('Expense updated successfully.', 'success');
                        } else {
                            data.createdAt = new Date().toISOString();
                            const docRef = await addDoc(expensesRef, data);
                            showToast('Expense logged successfully.', 'success');

                            if (appState.session.userRole === 'manager') {
                                const managerName = appState.session.currentUser.name;
                                const logDetails = `Manager '${managerName}' logged a new expense of ${currencyUtils.format(data.amountInBase)} for '${data.category}'.`;
                                
                                await addDoc(auditLogRef, {
                                    type: 'expense_add',
                                    timestamp: new Date().toISOString(),
                                    expenseId: docRef.id,
                                    details: logDetails,
                                    user: {
                                        id: appState.session.currentUser.uid,
                                        name: managerName
                                    }
                                });

                                const notificationMessage = `Manager <strong>${managerName}</strong> logged a new expense of <strong>${currencyUtils.format(data.amountInBase)}</strong> for '${data.category}'.`;
                                await createNotification('info', notificationMessage, { targetRoles: ['admin'] });
                            }
                        }
                        closeModal(modal);
                        // The onSnapshot listener should handle this, but as a direct fix
                        // to ensure the UI refreshes, we'll manually trigger a re-render if the
                        // expenses tab is currently active.
                        const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
                        if (activeTab?.viewType === 'expenses') {
                            renderApp();
                        }
                    } catch (error) {
                        console.error('Error saving expense:', error);
                        showToast('Failed to save expense.', 'error');
                    }
                });
            }

            const openCustomProfileModal = (profileId = null, isTemplate = false) => {
                const isEditing = profileId !== null && !isTemplate;
                    const baseProfile = isTemplate
                    ? businessProfiles[profileId]
                    : (isEditing ? appState.customProfiles[profileId] : {
                        name: 'New Custom Profile',
                        icon: 'box',
                        terminology: { product: 'Item', inventory: 'Stock', category: 'Type' },
                        features: { serials: false, expiry: false, service: false, hasInventoryTab: true },
                        customFields: []
                    });
                const currentProfile = JSON.parse(JSON.stringify(baseProfile));

                if (isTemplate) {
                    currentProfile.name = `${currentProfile.name} (Custom)`;
                }
                
                let fieldsHTML = currentProfile.customFields.map((field) => {
                    // Pre-defined dynamic selects are not editable here.
                    if (field.type === 'dynamic-select' && (field.source === 'productBrands' || field.source === 'suppliers')) {
                        return '';
                    }

                    let fieldType = field.type;
                    let optionsValue = field.options?.join(',') || '';
                    
                    if (field.type === 'dynamic-select' && field.source?.startsWith('customSelect_')) {
                        fieldType = 'select';
                        const customOptions = appState.settings.customSelectOptions?.[field.source] || [];
                        optionsValue = customOptions.join(',');
                    }

                    return `
                    <div class="custom-field-row flex items-center gap-2 p-2 bg-bg-tertiary rounded">
                        <input type="text" value="${field.label}" placeholder="Field Label" class="form-input p-2 flex-1 custom-field-label">
                        <select class="form-select p-2 custom-field-type">
                            <option value="text" ${fieldType === 'text' ? 'selected' : ''}>Text</option>
                            <option value="textarea" ${fieldType === 'textarea' ? 'selected' : ''}>Text Area</option>
                            <option value="select" ${fieldType === 'select' ? 'selected' : ''}>Select</option>
                            <option value="checkbox" ${fieldType === 'checkbox' ? 'selected' : ''}>Checkbox</option>
                        </select>
                         <input type="text" value="${optionsValue}" placeholder="Options (comma-sep)" class="form-input p-2 flex-1 custom-field-options ${fieldType !== 'select' ? 'hidden' : ''}">
                        <button type="button" data-action="remove-custom-field" class="btn btn-danger p-2 h-auto"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                    </div>
                    `;
                }).join('');

                const content = `
                    <form id="custom-profile-form" class="space-y-4">
                        <div><label class="block text-sm font-medium mb-1">Profile Name</label><input type="text" name="name" value="${currentProfile.name}" class="form-input w-full"></div>
                        <h4 class="font-semibold text-text-primary pt-2 border-t border-border-color">Terminology</h4>
                        <div class="grid grid-cols-3 gap-2">
                             <div><label class="block text-xs font-medium mb-1">Product</label><input type="text" name="term_product" value="${currentProfile.terminology.product}" class="form-input w-full p-2 text-sm"></div>
                             <div><label class="block text-xs font-medium mb-1">Inventory</label><input type="text" name="term_inventory" value="${currentProfile.terminology.inventory}" class="form-input w-full p-2 text-sm"></div>
                             <div><label class="block text-xs font-medium mb-1">Category</label><input type="text" name="term_category" value="${currentProfile.terminology.category}" class="form-input w-full p-2 text-sm"></div>
                        </div>
                         <h4 class="font-semibold text-text-primary pt-2 border-t border-border-color">Features</h4>
                         <div class="grid grid-cols-3 gap-2 text-sm">
                            <div class="flex items-center"><input type="checkbox" id="feature_serials" name="feature_serials" class="h-4 w-4 rounded" ${currentProfile.features.serials ? 'checked' : ''}><label for="feature_serials" class="ml-2">Serial Tracking</label></div>
                            <div class="flex items-center"><input type="checkbox" id="feature_expiry" name="feature_expiry" class="h-4 w-4 rounded" ${currentProfile.features.expiry ? 'checked' : ''}><label for="feature_expiry" class="ml-2">Expiry Tracking</label></div>
                            <div class="flex items-center"><input type="checkbox" id="feature_service" name="feature_service" class="h-4 w-4 rounded" ${currentProfile.features.service ? 'checked' : ''}><label for="feature_service" class="ml-2">Service Items</label></div>
                         </div>
                         <h4 class="font-semibold text-text-primary pt-2 border-t border-border-color">Product Form Configuration</h4>
                         <div class="grid grid-cols-3 gap-2 text-sm">
                            <div class="flex items-center"><input type="checkbox" id="feature_inventory_tab" name="feature_inventory_tab" class="h-4 w-4 rounded" ${currentProfile.features.hasInventoryTab !== false ? 'checked' : ''}><label for="feature_inventory_tab" class="ml-2">Enable Inventory Tab</label></div>
                         </div>
                         <h4 class="font-semibold text-text-primary pt-2 border-t border-border-color">Custom Fields</h4>
                         <div id="custom-fields-container" class="space-y-2">${fieldsHTML}</div>
                         <button type="button" data-action="add-custom-field" class="btn btn-secondary text-sm w-full"><i data-lucide="plus" class="w-4 h-4 mr-2"></i>Add Field</button>
                    </form>
                `;
                const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="custom-profile-form" class="btn btn-primary">Save Custom Profile</button>`;
                const modal = showModal('Customize Business Profile', content, footer, {size: 'max-w-3xl'});
                lucide.createIcons();
                
                const fieldsContainer = modal.querySelector('#custom-fields-container');
                
                modal.addEventListener('click', e => {
                    const target = e.target.closest('[data-action]');
                    if(!target) return;

                    if(target.dataset.action === 'add-custom-field') {
                        const newField = document.createElement('div');
                        newField.className = "custom-field-row flex items-center gap-2 p-2 bg-bg-tertiary rounded";
                        newField.innerHTML = `
                            <input type="text" placeholder="Field Label" class="form-input p-2 flex-1 custom-field-label">
                            <select class="form-select p-2 custom-field-type">
                                <option value="text">Text</option>
                                <option value="textarea">Text Area</option>
                                <option value="select">Select</option>
                                <option value="checkbox">Checkbox</option>
                            </select>
                            <input type="text" placeholder="Options (comma-sep)" class="form-input p-2 flex-1 custom-field-options hidden">
                            <button type="button" data-action="remove-custom-field" class="btn btn-danger p-2 h-auto"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                        `;
                        fieldsContainer.appendChild(newField);
                        lucide.createIcons();
                    }

                    if (target.dataset.action === 'remove-custom-field') {
                        target.closest('.custom-field-row').remove();
                    }
                });

                modal.addEventListener('change', e => {
                    if (e.target.classList.contains('custom-field-type')) {
                        const optionsInput = e.target.parentElement.querySelector('.custom-field-options');
                        optionsInput.classList.toggle('hidden', e.target.value !== 'select');
                    }
                });
                
                modal.querySelector('#custom-profile-form').addEventListener('submit', async e => {
                    e.preventDefault();
                    const formData = new FormData(e.target);

                    const newProfile = {
                        name: formData.get('name'),
                        icon: currentProfile.icon || 'box',
                        terminology: {
                            product: formData.get('term_product'),
                            inventory: formData.get('term_inventory'),
                            category: formData.get('term_category')
                        },
                        features: {
                            serials: formData.has('feature_serials'),
                            expiry: formData.has('feature_expiry'),
                            service: formData.has('feature_service'),
                            hasInventoryTab: formData.has('feature_inventory_tab')
                        },
                        customFields: []
                    };

                    const customSelectOptions = {};
                    
                    fieldsContainer.querySelectorAll('.custom-field-row').forEach(row => {
                        const label = row.querySelector('.custom-field-label').value.trim();
                        const type = row.querySelector('.custom-field-type').value;
                        if (label) {
                            const fieldName = label.toLowerCase().replace(/\s+/g, '_');
                            let field = { name: fieldName, label, type };
                            
                            if (type === 'select') {
                                const options = row.querySelector('.custom-field-options').value.split(',').map(s => s.trim()).filter(Boolean);
                                // This is the key logic for the feature request
                                field.type = 'dynamic-select';
                                const sourceId = `customSelect_${fieldName}`;
                                field.source = sourceId;
                                customSelectOptions[sourceId] = options;
                            }
                            newProfile.customFields.push(field);
                        }
                    });
                    
                    // Re-add predefined fields that were filtered out from the UI
                    if (baseProfile.customFields) {
                        const predefinedDynamicFields = baseProfile.customFields.filter(field => 
                            field.type === 'dynamic-select' && (field.source === 'productBrands' || field.source === 'suppliers')
                        );
                        newProfile.customFields.unshift(...predefinedDynamicFields);
                    }

                    const newId = isEditing ? profileId : `custom_${Date.now()}`;
                    const updatedProfiles = { ...appState.customProfiles, [newId]: newProfile };
                    const newSettings = { ...appState.settings, businessType: newId };
                    
                    // Merge new custom select options with existing ones in settings
                    newSettings.customSelectOptions = { ...(appState.settings.customSelectOptions || {}), ...customSelectOptions };

                    try {
                        await updateDoc(storeRef, { customProfiles: updatedProfiles, settings: newSettings });
                        showToast('Custom profile saved and applied!', 'success');
                        closeModal(modal);
                    } catch (error) {
                        showToast('Failed to save profile.', 'error');
                        console.error(error);
                    }
                });
            };

            // --- REPLACED FUNCTION: openProductFormModal ---
            // --- UPDATED FUNCTION: openProductFormModal ---
function openProductFormModal(isEditing, product) {
     if (!isEditing) {
        // We count only parent products, not variants, against the limit
        const currentProductCount = firestoreData.products.filter(p => !p.parentSKU).length;
        // Use a fallback limit (e.g., 1000) just in case planLimits isn't set
        const productLimit = firestoreData.storeInfo.planLimits?.products || 1000; 

        if (currentProductCount >= productLimit) {
            showToast(`You have reached your limit of ${productLimit} products. Please upgrade your plan to add more.`, 'error');
            showLimitReachedModal('products', productLimit);
            return; // Stop the function
        }
    }
    // If creating a NEW product AND a non-empty draft exists...
    if (!isEditing && appState.productFormDraft && Object.keys(appState.productFormDraft).length > 0) {
        const draftModal = showModal(
            'Draft Found',
            'You have a previously saved product draft. Would you like to continue editing it or start a new one?',
            `<button id="discard-draft" class="btn btn-secondary">Start New</button><button id="continue-draft" class="btn btn-primary">Continue Draft</button>`
        );

        draftModal.querySelector('#discard-draft').addEventListener('click', () => {
            appState.productFormDraft = null; // Clear the draft
            saveState(); // Persist the cleared state
            closeModal(draftModal);
            // Re-call this function to open a blank form.
            _buildProductFormModal(false, {}); // Pass an empty object
        });

        draftModal.querySelector('#continue-draft').addEventListener('click', () => {
            closeModal(draftModal);
            // Call the internal builder function, passing the draft data.
            _buildProductFormModal(false, appState.productFormDraft);
        });

        return; // Stop execution here; the modal choice will continue the flow.
    }

    // If no draft exists or if we're editing, proceed to build the form immediately.
    _buildProductFormModal(isEditing, product);
}
function _buildProductFormModal(isEditing, productData) {
    const profile = getCurrentProfile();
    const term = profile.terminology;
    const features = profile.features || {};

    const displayCurrency = appState.currentCurrency;
    const selectedProductType = productData.productType || 'physical';
    
    const modalState = {
        hasVariants: productData.hasVariants || false,
        isSerialized: productData.isSerialized || false,
        variantAttributes: productData.variantAttributeValues ? 
            Object.entries(productData.variantAttributeValues).map(([name, values]) => ({ name, values })) : []
    };
    
    const uomOptions = firestoreData.unitsOfMeasurement.map(uom => {
        const selected = isEditing ? (productData.uomId === uom.id) : (appState.settings.defaultUnit === uom.id);
        return `<option value="${uom.id}" ${selected ? 'selected' : ''}>${uom.name}</option>`;
    }).join('');

    const warrantyPolicies = appState.settings.warrantyPolicies || {};
    const warrantyOptions = Object.entries(warrantyPolicies).map(([id, policy]) => 
        `<option value="${id}" ${productData.defaultWarrantyPolicyId === id ? 'selected' : ''}>${policy.name}</option>`
    ).join('');

    let warrantyFieldHTML = '';
    if (features.serials) {
        warrantyFieldHTML = `
        <div id="warranty-policy-field" class="hidden">
            <label for="defaultWarrantyPolicyId" class="block text-sm font-medium text-text-secondary mb-1">Default Warranty Policy</label>
            <select id="defaultWarrantyPolicyId" name="defaultWarrantyPolicyId" class="form-select w-full">
                <option value="">None</option>
                <option value="standard-1-year" ${productData.defaultWarrantyPolicyId === 'standard-1-year' ? 'selected' : ''}>Standard 1-Year</option>
                ${warrantyOptions}
            </select>
            <p class="text-xs text-text-secondary mt-1">Applies to serialized items. Can be set on parent products with serialized variants.</p>
        </div>
        `;
    }
    
    const getCustomFieldsHTML = (data) => {
        const fields = profile.customFields || [];
        const customData = data.customData || {};

        return fields.map(field => {
            const value = customData[field.label] || '';
            switch (field.type) {
                case 'dynamic-select':
                    return `<div><label class="block text-sm font-medium text-text-secondary mb-1">${field.label}</label><div id="${field.name}-selector-container"></div></div>`;
                case 'text':
                    return `<div><label class="block text-sm font-medium text-text-secondary mb-1">${field.label}</label><input type="text" name="customData_${field.name}" value="${value}" class="w-full form-input" placeholder="${field.placeholder || ''}"></div>`;
                case 'textarea':
                    return `<div><label class="block text-sm font-medium text-text-secondary mb-1">${field.label}</label><textarea name="customData_${field.name}" class="w-full form-textarea">${value}</textarea></div>`;
                case 'select':
                    return `<div><label class="block text-sm font-medium text-text-secondary mb-1">${field.label}</label><select name="customData_${field.name}" class="w-full form-select">${field.options.map(o => `<option value="${o}" ${value === o ? 'selected' : ''}>${o}</option>`).join('')}</select></div>`;
                case 'checkbox':
                    return `<div class="flex items-center"><input type="checkbox" name="customData_${field.name}" class="h-4 w-4 rounded" ${value ? 'checked' : ''}><label class="ml-2">${field.label}</label></div>`;
                default:
                    return '';
            }
        }).join('');
    };

    const content = `
        <form id="product-form" class="space-y-4">
            <input type="hidden" name="id" value="${productData.id || ''}">
            <div class="border-b border-border-color flex space-x-4">
                <button type="button" data-tab="general" class="form-tab active px-1 py-3 text-sm font-medium">General</button>
                <button type="button" data-tab="variants" class="form-tab px-1 py-3 text-sm font-medium" ${!modalState.hasVariants ? 'disabled' : ''}>Variants</button>
                <button type="button" data-tab="inventory" class="form-tab px-1 py-3 text-sm font-medium">${term.inventory}</button>
                <button type="button" data-tab="pricing" class="form-tab px-1 py-3 text-sm font-medium">Pricing & Tax</button>
            </div>
            <div id="form-content" class="pt-4">
                <!-- GENERAL PANE -->
                <div class="form-pane active" data-pane="general">
                    <div class="space-y-4">
                        <div><label class="block text-sm font-medium text-text-secondary mb-1">${term.product} Name</label><input type="text" name="name" value="${productData.name || ''}" class="w-full form-input"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-text-secondary mb-1">SKU</label><input type="text" name="sku" value="${productData.id || `SKU${Date.now().toString().slice(-4)}`}" class="w-full form-input bg-bg-tertiary" ${isEditing ? 'readonly' : ''}></div>
                            <div>
                                <label class="block text-sm font-medium text-text-secondary mb-1">${term.category}</label>
                                <div id="category-selector-container"></div>
                            </div>
                        </div>
                        
                        <label class="flex items-center p-4 rounded-lg bg-bg-secondary border border-border-color cursor-pointer hover:bg-bg-tertiary transition-colors">
                            <input type="checkbox" id="hasVariants" name="hasVariants" class="form-checkbox h-5 w-5 rounded text-accent focus:ring-accent" ${modalState.hasVariants ? 'checked' : ''} ${isEditing ? 'disabled' : ''}>
                            <div class="ml-4">
                                <span class="font-medium text-text-primary">This ${term.product} has variants</span>
                                <p class="text-xs text-text-secondary">Enable to manage versions like size or color. Price, stock, and barcode will be managed per variant.</p>
                            </div>
                        </label>
                        
                        <div id="barcode-field-container">
                            <label class="block text-sm font-medium text-text-secondary mb-1">Barcode (UPC/EAN)</label><input type="text" name="barcode" value="${productData.barcode || ''}" class="w-full form-input" placeholder="Scan or type barcode here">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">${term.product} Type</label>
                            <select name="productType" class="form-select w-full">
                                <option value="physical" ${selectedProductType === 'physical' ? 'selected' : ''}>Physical</option>
                                ${features.service ? `<option value="service" ${selectedProductType === 'service' ? 'selected' : ''}>Service</option>` : ''}
                            </select>
                        </div>
                        ${getCustomFieldsHTML(productData)}
                        <div class="border-t border-border-color pt-4 mt-4 space-y-3">
                            ${features.serials ? `<div class="flex items-center"><input type="checkbox" id="isSerialized" name="isSerialized" class="h-4 w-4 rounded" ${modalState.isSerialized ? 'checked' : ''} ${isEditing ? 'disabled' : ''}><label for="isSerialized" class="ml-2">Track by Serial Number</label></div>` : ''}
                            
                            <!-- SERIAL NUMBER SECTION IS NOW REMOVED -->

                            ${features.expiry ? `<div class="flex items-center"><input type="checkbox" id="hasExpiry" name="hasExpiry" class="h-4 w-4 rounded" ${productData.hasExpiry ? 'checked' : ''}><label for="hasExpiry" class="ml-2">Track by Expiry Date</label></div>` : ''}
                            ${warrantyFieldHTML}
                        </div>
                    </div>
                </div>
                <div class="form-pane" data-pane="variants">
                    <div id="variant-attributes-section" class="mt-4 ${modalState.hasVariants ? '' : 'hidden'}">
                        <label class="block text-sm font-medium text-text-secondary mb-2">Variant Options</label>
                        <div id="variant-attributes-list" class="space-y-3"></div>
                        <div id="add-attribute-controls" class="flex items-center gap-2 mt-3 border-t border-border-color pt-3" ${isEditing ? 'hidden' : ''}></div>
                        <p class="text-xs text-text-secondary mt-2">Define the attributes that differentiate your variants.</p>
                    </div>
                    <div id="variant-info-message" class="mt-4 ${modalState.hasVariants ? 'hidden' : ''}">
                        <p class="text-sm text-center p-4 bg-bg-secondary rounded-lg">Price, stock, and barcode will be managed for each variant individually.</p>
                    </div>
                </div>
                <div class="form-pane" data-pane="inventory"><div id="inventory-pane-content"></div></div>
                <div class="form-pane" data-pane="pricing"><div id="pricing-pane-content"></div></div>
            </div>
        </form>
    `;

    const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="product-form" class="btn btn-primary">${isEditing ? 'Save Changes' : `Create ${term.product}`}</button>`;
    const modal = showModal(isEditing ? `Edit ${term.product}` : `Add New ${term.product}`, content, footer, { size: 'max-w-3xl' });
    
    // --- HELPER FUNCTIONS ---

    const renderAttributes = () => {
        const attributesList = modal.querySelector('#variant-attributes-list');
        if (!attributesList) return;

        if (modalState.variantAttributes.length === 0) {
            attributesList.innerHTML = '<p class="text-sm text-text-secondary text-center">No attributes defined. Add one below.</p>';
            return;
        }

        attributesList.innerHTML = modalState.variantAttributes.map((attr, index) => {
            const tagsHTML = attr.values.map(val => `
                <span class="variant-value-tag">
                    ${val}
                    <button type="button" data-action="remove-variant-value" data-attr-index="${index}" data-value="${val}" ${isEditing ? 'disabled' : ''}>&times;</button>
                </span>
            `).join('');

            // Check if this attribute has predefined values in settings
            const predefinedValues = appState.settings.variantAttributes?.[attr.name];
            let inputHTML = `<input type="text" data-index="${index}" class="variant-value-input" placeholder="Add values and press Enter..." ${isEditing ? 'disabled' : ''}>`;
            
            // If it has predefined values, create a datalist for autocomplete suggestions
            if (predefinedValues && predefinedValues.length > 0) {
                const datalistId = `datalist-${attr.name.replace(/\s+/g, '-')}-${index}`;
                inputHTML = `
                    <input type="text" list="${datalistId}" data-index="${index}" class="variant-value-input" placeholder="Select or type a value..." ${isEditing ? 'disabled' : ''}>
                    <datalist id="${datalistId}">
                        ${predefinedValues.map(val => `<option value="${val}"></option>`).join('')}
                    </datalist>
                `;
            }

            return `
            <div class="variant-attribute-row bg-bg-secondary p-4 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                    <label class="font-medium text-text-primary">${attr.name}</label>
                    ${!isEditing ? `<button type="button" data-action="remove-attribute" data-index="${index}" class="text-danger/70 hover:text-danger p-1"><i data-lucide="x" class="w-4 h-4 pointer-events-none"></i></button>` : ''}
                </div>
                <div class="variant-value-input-wrapper" ${!isEditing ? `onclick="this.querySelector('.variant-value-input').focus()"` : ''}>
                    ${tagsHTML}
                    ${inputHTML}
                </div>
            </div>`;
        }).join('');
        lucide.createIcons();
    };

    const renderAttributeSelector = () => {
        const addAttributeControls = modal.querySelector('#add-attribute-controls');
        if (!addAttributeControls || isEditing) {
            if (addAttributeControls) addAttributeControls.innerHTML = '';
            return;
        }

        const allAttributes = Object.keys(appState.settings.variantAttributes || {});
        const availableAttributes = allAttributes.filter(attrName => 
            !modalState.variantAttributes.some(a => a.name === attrName)
        );

        const optionsHTML = availableAttributes.map(attrName => `<option value="${attrName}">${attrName}</option>`).join('');

        addAttributeControls.innerHTML = `
            <select id="attribute-selector" class="form-select flex-grow">
                <option value="" selected>-- Add existing attribute --</option>
                ${optionsHTML}
                <option value="--new--" class="text-accent font-semibold border-t border-border-color mt-1 pt-1">-- Create New Attribute --</option>
            </select>
            <div id="new-attribute-input-container" class="hidden flex-grow flex items-center gap-2">
                <input type="text" id="new-attribute-name" class="form-input w-full" placeholder="New attribute name...">
                <button type="button" id="add-attribute-btn" class="btn btn-primary p-2 shrink-0"><i data-lucide="plus" class="w-4 h-4 pointer-events-none"></i></button>
            </div>
        `;
        lucide.createIcons();
    };

    const setupDynamicSelect = (containerId, options) => {
        const { fieldName, source, currentValue, createNewText } = options;
        const container = modal.querySelector(`#${containerId}`);
        if (!container) return;
        
        let dataList = [];
        let valueField = 'id';
        let nameField = 'name';

        if (source === 'suppliers') {
            dataList = firestoreData.suppliers || [];
        } else if (source?.startsWith('customSelect_')) {
            const customOptions = appState.settings.customSelectOptions?.[source] || [];
            dataList = customOptions.map(item => ({ id: item, name: item }));
        } else {
            // Assumes it's a simple array in settings like 'productCategories' or 'productBrands'
            dataList = (appState.settings[source] || []).map(item => ({ id: item, name: item }));
        }

        container.innerHTML = `<input type="hidden" name="${fieldName}" value="${currentValue || ''}">`;

        const renderSelect = (selectedValue) => {
            const existingUI = container.querySelector('.dynamic-select-ui');
            if (existingUI) existingUI.remove();

            const hiddenInput = container.querySelector(`input[name="${fieldName}"]`);
            if (hiddenInput) hiddenInput.value = selectedValue || '';

            const uiWrapper = document.createElement('div');
            uiWrapper.className = 'dynamic-select-ui';

            const selectOptions = dataList.map(item => 
                `<option value="${item[valueField]}" ${selectedValue === item[valueField] ? 'selected' : ''}>${item[nameField]}</option>`
            ).join('');
            
            uiWrapper.innerHTML = `
                <select class="form-select w-full">
                    <option value="" disabled ${!selectedValue ? 'selected' : ''}>Select...</option>
                    ${selectOptions}
                    <option value="--new--" class="text-accent font-semibold border-t border-border-color mt-1 pt-1">-- ${createNewText} --</option>
                </select>
            `;

            container.appendChild(uiWrapper);
            
            const selectEl = uiWrapper.querySelector('select');
            selectEl.addEventListener('change', () => {
                if (selectEl.value === '--new--') {
                    renderInput(selectedValue);
                } else {
                    if (hiddenInput) hiddenInput.value = selectEl.value;
                }
            });
        };

        const renderInput = (previousValue) => {
            const existingUI = container.querySelector('.dynamic-select-ui');
            if (existingUI) existingUI.remove();

            const uiWrapper = document.createElement('div');
            uiWrapper.className = 'dynamic-select-ui flex items-center gap-2';
            uiWrapper.innerHTML = `
                <input type="text" class="form-input flex-grow" placeholder="New ${fieldName.replace('customData_','')} name...">
                <button type="button" class="btn btn-success p-2 shrink-0" title="Save"><i data-lucide="check" class="w-4 h-4 pointer-events-none"></i></button>
                <button type="button" class="btn btn-secondary p-2 shrink-0" title="Cancel"><i data-lucide="x" class="w-4 h-4 pointer-events-none"></i></button>
            `;
            container.appendChild(uiWrapper);
            lucide.createIcons();

            const inputEl = uiWrapper.querySelector('input');
            inputEl.focus();

            const saveBtn = uiWrapper.querySelector('.btn-success');
            const cancelBtn = uiWrapper.querySelector('.btn-secondary');

            const handleSave = async () => {
                const newValue = inputEl.value.trim();
                if (!newValue) {
                    showToast(`${fieldName.replace('customData_','')} name cannot be empty.`, 'error');
                    return;
                }

                try {
                    if (source === 'suppliers') {
                        const existing = dataList.find(s => s.name.toLowerCase() === newValue.toLowerCase());
                        if (existing) {
                            showToast('Supplier already exists.', 'warning');
                            renderSelect(existing.id);
                        } else {
                            const newDocRef = await addDoc(suppliersRef, { name: newValue });
                            dataList.push({ id: newDocRef.id, name: newValue });
                            renderSelect(newDocRef.id);
                        }
                    } else if (source?.startsWith('customSelect_')) {
                        const existing = dataList.find(item => item.name.toLowerCase() === newValue.toLowerCase());
                        if (existing) {
                            showToast(`${fieldName.replace('customData_','')} already exists.`, 'warning');
                            renderSelect(existing.id);
                        } else {
                            const { arrayUnion } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
                            await updateDoc(storeRef, { [`settings.customSelectOptions.${source}`]: arrayUnion(newValue) });
                            dataList.push({ id: newValue, name: newValue });
                            renderSelect(newValue);
                        }
                    } else { // 'productCategories', 'productBrands'
                        const existing = dataList.find(item => item.name.toLowerCase() === newValue.toLowerCase());
                        if (existing) {
                            showToast(`${fieldName.replace('customData_','')} already exists.`, 'warning');
                            renderSelect(existing.id);
                        } else {
                            const { arrayUnion } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
                            await updateDoc(storeRef, { [`settings.${source}`]: arrayUnion(newValue) });
                            dataList.push({ id: newValue, name: newValue });
                            renderSelect(newValue);
                        }
                    }
                } catch(err) {
                    showToast(`Failed to save new ${fieldName.replace('customData_','')}.`, 'error');
                    console.error(err);
                }
            };
            
            saveBtn.addEventListener('click', handleSave);
            inputEl.addEventListener('keydown', e => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSave();
                } else if (e.key === 'Escape') {
                    renderSelect(previousValue);
                }
            });
            cancelBtn.addEventListener('click', () => renderSelect(previousValue));
        };
        
        renderSelect(currentValue);
    };

    const renderPanes = () => {
        const inventoryPane = modal.querySelector('[data-pane="inventory"] #inventory-pane-content');
        const pricingPane = modal.querySelector('[data-pane="pricing"] #pricing-pane-content');
        const barcodeContainer = modal.querySelector('#barcode-field-container');
        const warrantyContainer = modal.querySelector('#warranty-policy-field');
        
        const shouldShowWarranty = modalState.isSerialized; // <-- FIX 1: Only show if 'isSerialized' is checked
        if(warrantyContainer) warrantyContainer.classList.toggle('hidden', !shouldShowWarranty);
        
        if (modalState.hasVariants) {
            barcodeContainer.classList.add('hidden');
            inventoryPane.innerHTML = `<p class="text-sm text-center p-6 bg-bg-secondary rounded-lg">Stock is managed individually for each variant.</p>`;
            pricingPane.innerHTML = `<p class="text-sm text-center p-6 bg-bg-secondary rounded-lg">Price & Cost are managed for each variant.</p>`;
        } else {
            barcodeContainer.classList.remove('hidden');
            
            inventoryPane.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-1 gap-4">
                        <div><label class="block text-sm font-medium text-text-secondary mb-1">Unit of Measure</label><select name="uomId" class="form-select w-full">${uomOptions}</select></div>
                    </div>
                    <div id="stock-quantity-section" class="${modalState.isSerialized ? 'hidden' : ''}">
                        ${isEditing ? `
                        <div><label class="block text-sm font-medium text-text-secondary mb-1">Current Stock</label><input type="number" name="stock" value="${productData.stock || '0'}" class="w-full form-input"></div>
                        ` : `
                        <p class="text-sm text-center p-6 bg-bg-secondary rounded-lg">Initial stock is set to 0. Use "Receive Stock" or "Adjust Stock" from the main inventory view to add items.</p>
                        `}
                    </div>
                </div>`;
            pricingPane.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    ${checkPermission('canViewProfitAndLoss') ? `<div><label class="block text-sm font-medium text-text-secondary mb-1">Cost Price (in ${displayCurrency})</label><input type="number" name="costPrice" step="0.01" value="${ isEditing && productData.costPrice ? currencyUtils.convert(productData.costPrice, displayCurrency).toFixed(2) : ''}" class="w-full form-input"></div>` : ''}
                    <div><label class="block text-sm font-medium text-text-secondary mb-1">Selling Price (in ${displayCurrency})</label><input type="number" name="price" step="0.01" value="${ isEditing && productData.price ? currencyUtils.convert(productData.price, displayCurrency).toFixed(2) : ''}" class="w-full form-input"></div>
                </div>
                <div class="flex items-center mt-4"><input type="checkbox" id="taxable" name="taxable" class="h-4 w-4 rounded" ${productData.taxable !== false ? 'checked' : ''}><label for="taxable" class="ml-2">This item is taxable</label></div>`;
        }
    };

    // --- EVENT LISTENERS ---

    // Tab switching
    modal.querySelectorAll('.form-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            modal.querySelectorAll('.form-tab').forEach(t => t.classList.remove('active'));
            modal.querySelectorAll('.form-pane').forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            modal.querySelector(`.form-pane[data-pane="${tab.dataset.tab}"]`).classList.add('active');
        });
    });

    // Main feature toggles
    modal.querySelector('#hasVariants')?.addEventListener('change', (e) => {
        modalState.hasVariants = e.target.checked;
        
        // Toggle UI sections visibility
        modal.querySelector('#variant-attributes-section').classList.toggle('hidden', !modalState.hasVariants);
        modal.querySelector('#variant-info-message').classList.toggle('hidden', modalState.hasVariants);
        
        // Enable/disable the Variants tab itself
        const variantsTabButton = modal.querySelector('button[data-tab="variants"]');
        if (variantsTabButton) {
            variantsTabButton.disabled = !modalState.hasVariants;
        }
        
        // If user unchecks variants, switch them back to the General tab
        if (!modalState.hasVariants) {
            const generalTabButton = modal.querySelector('button[data-tab="general"]');
            if (generalTabButton) generalTabButton.click();
        }

        renderPanes(); // This handles hiding barcode field etc.
    });

    modal.querySelector('#isSerialized')?.addEventListener('change', (e) => {
        modalState.isSerialized = e.target.checked;
        renderPanes();
    });
    
    // Variant attribute management
    const attributesList = modal.querySelector('#variant-attributes-list');
    attributesList.addEventListener('click', e => {
        const removeAttrBtn = e.target.closest('[data-action="remove-attribute"]');
        if (removeAttrBtn && !isEditing) {
            modalState.variantAttributes.splice(parseInt(removeAttrBtn.dataset.index), 1);
            renderAttributes();
            renderAttributeSelector();
        }
        const removeValueBtn = e.target.closest('[data-action="remove-variant-value"]');
         if (removeValueBtn) {
            const { attrIndex, value } = removeValueBtn.dataset;
            const attr = modalState.variantAttributes[attrIndex];
            if (attr) {
                attr.values = attr.values.filter(v => v !== value);
                renderAttributes();
            }
        }
    });
    attributesList.addEventListener('keydown', e => {
        const valueInput = e.target.closest('.variant-value-input');
        if (valueInput && e.key === 'Enter') {
            e.preventDefault();
            const value = valueInput.value.trim();
            const index = parseInt(valueInput.dataset.index);
            const attr = modalState.variantAttributes[index];
            if (value && attr && !attr.values.find(v => v.toLowerCase() === value.toLowerCase())) {
                attr.values.push(value);
                renderAttributes();
                const newInputs = modal.querySelectorAll('.variant-value-input');
                if(newInputs[index]) newInputs[index].focus();
            }
            valueInput.value = '';
        }
    });
    
    // --- NEW: Handle datalist selection automatically ---
    attributesList.addEventListener('input', e => {
        const valueInput = e.target.closest('.variant-value-input');
        // Only act if not editing
        if (!valueInput || isEditing) return;

        const value = valueInput.value.trim();
        const index = parseInt(valueInput.dataset.index);
        const attr = modalState.variantAttributes[index];
        
        if (!value || !attr) return;

        // Find the datalist associated with this input
        const datalistId = valueInput.getAttribute('list');
        const datalist = modal.querySelector(`#${datalistId}`);
        if (!datalist) return; // Not an input with a datalist, so do nothing

        // Check if the typed value is an exact match for one of the datalist options
        const options = Array.from(datalist.options).map(opt => opt.value);
        const isExactMatch = options.includes(value);

        if (isExactMatch) {
            if (!attr.values.find(v => v.toLowerCase() === value.toLowerCase())) {
                attr.values.push(value);
                renderAttributes(); // This rebuilds the list
                
                // After rebuilding, we need to find the new input for this attribute and focus it
                const newInputs = modal.querySelectorAll('.variant-value-input');
                if (newInputs[index]) {
                    // We must clear the value *after* renderAttributes
                    newInputs[index].value = ''; 
                    newInputs[index].focus();
                }
            } else {
                // It's a match but already added, just clear the input
                valueInput.value = '';
            }
        }
    });
    // --- END NEW ---
    
    // Logic for adding new attributes from dropdown/input
    const addAttributeControls = modal.querySelector('#add-attribute-controls');
    if (addAttributeControls) {
        addAttributeControls.addEventListener('change', e => {
            const selector = e.target.closest('#attribute-selector');
            if (selector) {
                const selectedValue = selector.value;
                if (selectedValue === '--new--') {
                    selector.classList.add('hidden');
                    addAttributeControls.querySelector('#new-attribute-input-container').classList.remove('hidden');
                    addAttributeControls.querySelector('input').focus();
                } else if (selectedValue) {
                    // If the attribute is not already added to the product
                    if (!modalState.variantAttributes.find(a => a.name === selectedValue)) {
                        // Add the attribute with an empty values array.
                        // The user will select values from the input, which will now have a datalist.
                        modalState.variantAttributes.push({ name: selectedValue, values: [] });
                        renderAttributes();
                    }
                    // Re-render the selector dropdown to remove the just-added attribute from the list of options.
                    renderAttributeSelector(); 
                }
            }
        });
        addAttributeControls.addEventListener('click', e => {
            const addBtn = e.target.closest('#add-attribute-btn');
            if (addBtn) {
                const input = addAttributeControls.querySelector('#new-attribute-name');
                const name = input.value.trim();
                if (name && !modalState.variantAttributes.find(a => a.name.toLowerCase() === name.toLowerCase())) {
                    modalState.variantAttributes.push({ name: name, values: [] });
                    renderAttributes();
                    input.value = '';
                    addAttributeControls.querySelector('#attribute-selector').classList.remove('hidden');
                    addAttributeControls.querySelector('#new-attribute-input-container').classList.add('hidden');
                    renderAttributeSelector();
                } else if (name) {
                    showToast(`Attribute "${name}" already exists.`, 'warning');
                }
            }
        });
    }

    // --- FORM SUBMISSION ---
    modal.querySelector('#product-form').addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const formData = new FormData(ev.target);
        
        const name = formData.get('name');
        if (!name || !name.trim()) { showToast(`${term.product} Name is required.`, 'error'); return; }
        const sku = isEditing ? productData.id : formData.get('sku');
        if (!sku || !sku.trim()) { showToast('SKU is required.', 'error'); return; }

        const newProductData = {
            name: formData.get('name'), category: formData.get('category'),
            productType: formData.get('productType'), customData: {},
            status: productData.status || 'active', hasVariants: modalState.hasVariants,
            isSerialized: modalState.isSerialized,
            defaultWarrantyPolicyId: formData.get('defaultWarrantyPolicyId'),
            variantAttributes: modalState.hasVariants ? modalState.variantAttributes.map(a => a.name) : [],
            variantAttributeValues: modalState.hasVariants ? modalState.variantAttributes.reduce((acc, attr) => {
                acc[attr.name] = attr.values;
                return acc;
            }, {}) : {},
        };
        
        profile.customFields.forEach(field => {
            if (field.type === 'checkbox') {
                newProductData.customData[field.label] = formData.has(`customData_${field.name}`);
            } else {
                const value = formData.get(`customData_${field.name}`);
                if (value) { newProductData.customData[field.label] = value; }
            }
        });
        
        if (!modalState.hasVariants) {
            const costPriceInDisplay = parseFloat(formData.get('costPrice'));
            const priceInDisplay = parseFloat(formData.get('price'));
            Object.assign(newProductData, {
                barcode: formData.get('barcode') || generateUniqueBarcode(),
                uomId: formData.get('uomId'), taxable: formData.has('taxable'),
                hasExpiry: formData.has('hasExpiry'),
            });
            if (modalState.isSerialized) {
                // Serials are no longer added here.
                // For new serialized products, stock starts at 0.
                // For existing serialized products, stock is managed elsewhere, so we don't update it here.
                if (!isEditing) {
                    newProductData.serials = [];
                    newProductData.stock = 0;
                }
            } else {
                 if (isEditing) { newProductData.stock = parseFloat(formData.get('stock')); } 
                 else { newProductData.stock = 0; }
            }
            if (!isNaN(priceInDisplay)) { newProductData.price = currencyUtils.convertToBase(priceInDisplay, appState.currentCurrency); } 
            else if (!isEditing) { newProductData.price = 0; }
            if (!isNaN(costPriceInDisplay) && checkPermission('canViewProfitAndLoss')) { newProductData.costPrice = currencyUtils.convertToBase(costPriceInDisplay, appState.currentCurrency); } 
            else if (!isEditing) { newProductData.costPrice = 0; }
        }

        if (!isEditing) { newProductData.createdAt = new Date().toISOString(); }
        
        const productPromise = isEditing
            ? updateDoc(doc(productsRef, sku), newProductData)
            : setDoc(doc(productsRef, sku), newProductData);
        
        let settingsUpdatePromise = Promise.resolve();
        if (modalState.hasVariants && !isEditing) {
            const { arrayUnion } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
            const settingsUpdates = {};
            let needsUpdate = false;
            
            modalState.variantAttributes.forEach(attr => {
                const existingAttrValues = appState.settings.variantAttributes?.[attr.name] || [];
                const newValues = attr.values.filter(v => !existingAttrValues.includes(v));
                if (newValues.length > 0) {
                    settingsUpdates[`settings.variantAttributes.${attr.name}`] = arrayUnion(...newValues);
                    needsUpdate = true;
                }
            });
            if (needsUpdate) {
                settingsUpdatePromise = updateDoc(storeRef, settingsUpdates);
            }
        }
        try {
            await Promise.all([productPromise, settingsUpdatePromise]);
            showToast(`${term.product} ${isEditing ? 'updated' : 'created'} successfully!`, 'success');
            
            // Clear draft on successful creation
            if (!isEditing) {
                appState.productFormDraft = null;
                saveState(); // Persist the cleared draft state
            }

            closeModal(modal);
            if (isEditing && newProductData.hasVariants) {
                const container = document.querySelector('#inventory-view-container');
                if (container) {
                    setTimeout(() => renderVariantDetailView(sku, container), 250);
                }
            } else if (!isEditing && newProductData.hasVariants) {
                const container = document.querySelector('#inventory-view-container');
                if (container) { setTimeout(() => renderVariantManagementView(sku, container), 250); }
            }
        } catch(error) {
            console.error("Error saving product:", error);
            showToast("Failed to save product.", "error");
        }
    });

    // --- NEW: DRAFT SAVING LOGIC ---
    const form = modal.querySelector('#product-form');

    const saveDraft = () => {
        if (isEditing) return;

        const formData = new FormData(form);
        const draftData = {
            id: formData.get('sku'),
            name: formData.get('name'),
            category: formData.get('category'),
            barcode: formData.get('barcode'),
            productType: formData.get('productType'),
            hasVariants: modalState.hasVariants,
            isSerialized: modalState.isSerialized,
            hasExpiry: formData.has('hasExpiry'),
            defaultWarrantyPolicyId: formData.get('defaultWarrantyPolicyId'),
            variantAttributeValues: modalState.hasVariants ? modalState.variantAttributes.reduce((acc, attr) => {
                acc[attr.name] = attr.values;
                return acc;
            }, {}) : {},
            uomId: formData.get('uomId'),
            stock: parseFloat(formData.get('stock')),
            serials: (formData.get('serials') || '').split('\n').map(s => s.trim()).filter(Boolean),
            costPrice: currencyUtils.convertToBase(parseFloat(formData.get('costPrice')) || 0, displayCurrency),
            price: currencyUtils.convertToBase(parseFloat(formData.get('price')) || 0, displayCurrency),
            taxable: formData.has('taxable'),
            customData: {},
        };

        profile.customFields.forEach(field => {
            if (field.type === 'checkbox') {
                draftData.customData[field.label] = formData.has(`customData_${field.name}`);
            } else {
                const value = formData.get(`customData_${field.name}`);
                if (value) { draftData.customData[field.label] = value; }
            }
        });

        // Only save if there's meaningful data
        if (draftData.name || draftData.id !== `SKU${Date.now().toString().slice(-4)}`) {
            appState.productFormDraft = draftData;
        }
    };
    
    let debounceTimer;
    form.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(saveDraft, 500);
    });
    form.addEventListener('change', saveDraft);

    modal.querySelectorAll('[data-action="close-modal"]').forEach(btn => {
        btn.addEventListener('click', () => {
            if (!isEditing && appState.productFormDraft) {
                saveState();
                showToast('Draft saved.', 'info');
            }
            // --- FIX 2: Explicitly close the modal ---
            // The global listener should catch this, but we add it here
            // to be 100% certain the modal closes as requested.
            closeModal(modal);
        });
    });

    // --- INITIALIZATION ---
    renderPanes();
    renderAttributes();
    renderAttributeSelector();
    setupDynamicSelect('category-selector-container', { fieldName: 'category', source: 'productCategories', currentValue: productData.category, createNewText: 'Add New Category' });
    profile.customFields.forEach(field => {
        if (field.type === 'dynamic-select') {
            setupDynamicSelect(`${field.name}-selector-container`, {
                fieldName: `customData_${field.name}`, source: field.source,
                currentValue: productData.customData ? productData.customData[field.label] : null,
                createNewText: `Add New ${field.label}`
            });
        }
    });
}
            // --- NEW FUNCTION: renderVariantManagementView ---
            function renderVariantManagementView(productId, container) {
                const parentProduct = firestoreData.products.find(p => p.id === productId);
                if (!parentProduct) {
                    container.innerHTML = `<p>Parent product not found.</p><button data-action="back-to-inventory" class="btn btn-secondary mt-4">Back to List</button>`;
                    return;
                }

                const term = getCurrentProfile().terminology;
                const variants = firestoreData.products.filter(p => p.parentSKU === productId);
                const totalStock = variants.reduce((sum, v) => sum + (v.stock || 0), 0);
                
                // --- NEW: Add state for checkboxes ---
                let selectedVariants = new Set();
                
                const updateBulkActionState = () => {
                    const bulkEditBtn = container.querySelector('[data-action="bulk-edit-variants"]');
                    if (bulkEditBtn) {
                        bulkEditBtn.disabled = selectedVariants.size === 0;
                    }
                };

                container.innerHTML = `
                <div class="view-pane space-y-6">
                    <!-- Header -->
                    <div class="flex flex-col md:flex-row justify-between md:items-start gap-4">
                        <div class="flex items-start gap-4">
                            <button data-action="back-to-inventory" class="btn btn-secondary p-2 h-10 w-10 shrink-0"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                            <div>
                                <h1 class="text-3xl font-bold text-text-primary">${parentProduct.name}</h1>
                                <p class="font-mono text-xs text-text-secondary">${parentProduct.id}</p>
                                <div class="mt-2 flex items-center gap-4 text-sm">
                                    <span class="flex items-center gap-2"><i data-lucide="boxes" class="w-4 h-4 text-accent"></i> ${variants.length} Variants</span>
                                    <span class="flex items-center gap-2"><i data-lucide="package" class="w-4 h-4 text-accent"></i> ${totalStock} Total Stock</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                             
                             <button data-action="generate-variants" data-parent-id="${productId}" class="btn btn-secondary"><i data-lucide="wand-2" class="w-4 h-4 mr-2"></i>Generate Variants</button>
                             <button data-action="add-variant" data-parent-id="${productId}" class="btn btn-primary"><i data-lucide="plus" class="w-4 h-4 mr-2"></i>Add Variant</button>
                        </div>
                    </div>

                    <!-- Bulk Actions & Variant Table -->
                    <div class="bg-bg-secondary/50 rounded-xl">
                        <div class="p-4 border-b border-border-color flex items-center gap-4">
                            <button data-action="bulk-edit-variants" class="btn btn-secondary" disabled><i data-lucide="edit" class="w-4 h-4 mr-2"></i>Edit Selected</button>
                        </div>
                        <table class="table-pro">
                            <thead>
                                <tr>
                                    <th class="w-12 text-center"><input type="checkbox" data-action="select-all-variants" class="form-checkbox"></th>
                                    <th>SKU</th>
                                    ${(parentProduct.variantAttributes || []).map(attr => `<th>${attr}</th>`).join('')}
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            ${variants.length ? variants.map(v => `
                                <tr class="table-row">
                                    <td class="text-center"><input type="checkbox" data-action="select-variant" data-id="${v.id}" class="form-checkbox"></td>
                                    <td class="font-mono text-xs">${v.id}</td>
                                    ${(parentProduct.variantAttributes || []).map(attr => `<td class="text-sm">${v.variantOptions?.[attr] || '-'}</td>`).join('')}
                                    <td class="font-mono">${currencyUtils.format(v.price || 0)}</td>
                                    <td>${v.stock}</td>
                                    <td class="text-right">
                                        <button data-action="edit-variant" data-id="${v.id}" class="btn btn-secondary btn-sm p-2"><i data-lucide="edit" class="w-4 h-4 pointer-events-none"></i></button>
                                        <button data-action="delete-variant" data-id="${v.id}" class="btn btn-danger-secondary btn-sm p-2 ml-2"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                                    </td>
                                </tr>
                            `).join('') : `<tr><td colspan="${(parentProduct.variantAttributes || []).length + 5}" class="text-center p-8 text-text-secondary">No variants created yet. Use 'Generate Variants' or 'Add Variant'.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
                `;
                lucide.createIcons();
                
                container.querySelector('[data-action="back-to-inventory"]').addEventListener('click', () => initInventory(container));
                
                const table = container.querySelector('table');
                if (table) {
                    table.addEventListener('change', e => {
                        const selectAll = e.target.closest('[data-action="select-all-variants"]');
                        const selectOne = e.target.closest('[data-action="select-variant"]');
                        if (selectAll) {
                            table.querySelectorAll('[data-action="select-variant"]').forEach(cb => {
                                cb.checked = selectAll.checked;
                                if (selectAll.checked) {
                                    selectedVariants.add(cb.dataset.id);
                                } else {
                                    selectedVariants.clear();
                                }
                            });
                        }
                        if (selectOne) {
                            if (selectOne.checked) {
                                selectedVariants.add(selectOne.dataset.id);
                            } else {
                                selectedVariants.delete(selectOne.dataset.id);
                            }
                        }
                        updateBulkActionState();
                    });
                }

                container.addEventListener('click', e => {
                    const target = e.target.closest('[data-action]');
                    if (!target) return;
                    
                    const { action, parentId, id } = target.dataset;

                    if (action === 'add-variant' || action === 'edit-variant' || action === 'edit-product') {
                        e.stopPropagation();
                        // Find the appropriate function to call
                        const variantParentSku = variants.find(v => v.id === id)?.parentSKU;
                        if (action === 'add-variant') openVariantFormModal(parentId);
                        else if (action === 'edit-variant') openVariantFormModal(variantParentSku, id);
                        else if (action === 'edit-product') openProductFormModal(true, parentProduct);
                    }
                    
                    if (action === 'delete-variant') {
                        e.stopPropagation();
                        const modal = showModal('Delete Variant', 'Are you sure you want to permanently delete this variant?', `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-delete-variant" class="btn btn-danger">Delete</button>`);
                        modal.querySelector('#confirm-delete-variant').addEventListener('click', async () => {
                            await deleteDoc(doc(productsRef, id));
                            closeModal(modal);
                            showToast('Variant deleted.', 'success');
                            // The onSnapshot listener will trigger a re-render.
                        });
                    }

                    if (action === 'generate-variants') {
                        e.stopPropagation();
                        generateVariants(parentId);
                    }
                    
                    if (action === 'bulk-edit-variants') {
                        e.stopPropagation();
                        openBulkEditVariantsModal(Array.from(selectedVariants));
                    }
                });
            }
           // --- UPDATED FUNCTION: openVariantFormModal ---
function openVariantFormModal(parentSKU, variantSKU = null) {
    // ... (This function is heavily modified for serialization)
    const isEditing = !!variantSKU;
    const parentProduct = firestoreData.products.find(p => p.id === parentSKU);
    const variant = isEditing ? firestoreData.products.find(v => v.id === variantSKU) : {};

    if (!parentProduct) {
        showToast('Parent product not found.', 'error'); return;
    }
    const term = getCurrentProfile().terminology;
    const displayCurrency = appState.currentCurrency;

    // NEW: Determine if the form should show serialization fields
    const isSerialized = parentProduct.isSerialized;

    let inventoryHTML = '';
    if (isSerialized) {
        inventoryHTML = `
            <div>
                <label class="block text-sm font-medium mb-1">Serial Numbers (one per line)</label>
                <textarea name="serials" class="form-textarea w-full h-24 font-mono text-xs">${variant.serials?.join('\n') || ''}</textarea>
                <p class="text-xs text-text-secondary mt-1">Stock quantity will be automatically set to the number of serials entered.</p>
            </div>
        `;
    } else {
        inventoryHTML = `
            <div>
                <label class="block text-sm font-medium mb-1">Stock Quantity</label>
                <input type="number" name="stock" value="${variant.stock || 0}" class="form-input w-full">
            </div>
        `;
    }

    const content = `
    <form id="variant-form" class="space-y-4">
        <p class="text-sm">Creating a new variant for <strong class="text-text-primary">${parentProduct.name}</strong>.</p>
        <div class="grid grid-cols-2 gap-4">
            ${(parentProduct.variantAttributes || []).map(attr => `
                <div>
                    <label class="block text-sm font-medium mb-1">${attr}</label>
                    <input type="text" name="option_${attr}" value="${variant.variantOptions?.[attr] || ''}" class="form-input w-full" required>
                </div>
            `).join('')}
        </div>
        <div class="grid grid-cols-2 gap-4 border-t border-border-color pt-4">
             <div><label class="block text-sm font-medium mb-1">Variant SKU</label><input type="text" name="id" value="${variant.id || `${parentSKU}-`}" class="form-input w-full" ${isEditing ? 'readonly' : ''} required></div>
             <div><label class="block text-sm font-medium mb-1">Barcode</label><input type="text" name="barcode" value="${variant.barcode || ''}" class="form-input w-full"></div>
        </div>
         <div class="grid grid-cols-2 gap-4">
            ${checkPermission('canViewProfitAndLoss') ? `<div><label class="block text-sm font-medium mb-1">Cost Price (${displayCurrency})</label><input type="number" step="0.01" name="costPrice" value="${variant.costPrice ? currencyUtils.convert(variant.costPrice).toFixed(2) : ''}" class="form-input w-full"></div>` : ''}
            <div><label class="block text-sm font-medium mb-1">Selling Price (${displayCurrency})</label><input type="number" step="0.01" name="price" value="${variant.price ? currencyUtils.convert(variant.price).toFixed(2) : ''}" class="form-input w-full" required></div>
         </div>
         ${inventoryHTML}
    </form>
    `;
    const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="variant-form" class="btn btn-primary">${isEditing ? 'Save Changes' : 'Create Variant'}</button>`;
    const modal = showModal(isEditing ? `Edit Variant` : 'Add New Variant', content, footer);

    modal.querySelector('#variant-form').addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const newId = formData.get('id');

        if (!isEditing && firestoreData.products.some(p => p.id === newId)) {
            showToast(`SKU "${newId}" already exists. Please choose a unique SKU.`, 'error');
            return;
        }
        
        const priceInDisplay = parseFloat(formData.get('price')) || 0;
        const costPriceInDisplay = parseFloat(formData.get('costPrice')) || 0;

        const variantData = {
            parentSKU: parentSKU,
            name: parentProduct.name,
            category: parentProduct.category,
            productType: parentProduct.productType,
            hasVariants: false,
            isSerialized: parentProduct.isSerialized, // Inherit from parent
            barcode: formData.get('barcode') || generateUniqueBarcode(),
            price: currencyUtils.convertToBase(priceInDisplay),
            costPrice: currencyUtils.convertToBase(costPriceInDisplay),
            taxable: parentProduct.taxable !== false,
            variantOptions: {},
            customData: { ...(parentProduct.customData || {}) }
        };

        if (isSerialized) {
            const serials = formData.get('serials').split('\n').map(s => s.trim()).filter(Boolean);
            variantData.serials = serials;
            variantData.stock = serials.length;
        } else {
            variantData.stock = parseFloat(formData.get('stock')) || 0;
        }

        parentProduct.variantAttributes.forEach(attr => {
            variantData.variantOptions[attr] = formData.get(`option_${attr}`);
        });

        try {
            await setDoc(doc(productsRef, newId), variantData, { merge: true });
            showToast('Variant saved successfully!', 'success');
            closeModal(modal);

            const container = document.querySelector('#inventory-view-container');
            if (container) {
                setTimeout(() => renderVariantDetailView(parentSKU, container), 250);
            }
        } catch (error) {
            console.error('Error saving variant:', error);
            showToast('Failed to save variant.', 'error');
        }
    });
}
            function openTotalDiscountModal() {
                const activeSale = posState.sales.find(s => s.id === posState.activeSaleId);
                if (!activeSale) {
                    showToast('No active sale to apply a discount to.', 'error');
                    return;
                }
                
                const subtotalBase = activeSale.cart.reduce((acc, item) => {
                    const price = item.originalPrice !== undefined ? item.originalPrice : item.price;
                    return acc + (price * (item.qty || 1));
                }, 0);

                const displayCurrencyInfo = currencyUtils.get(appState.currentCurrency);
                
                let initialDiscountValueForDisplay = '';
                // Logic to determine initial input value based on current discount
                if (activeSale.discount?.value) {
                    if (activeSale.discount.type === 'fixed') {
                        initialDiscountValueForDisplay = currencyUtils.convert(activeSale.discount.value, appState.currentCurrency).toFixed(2);
                    } else { // percent
                        initialDiscountValueForDisplay = activeSale.discount.value;
                    }
                }
                
                const content = `
                <form id="total-discount-form" class="space-y-4">
                    <div class="p-4 bg-bg-tertiary rounded-lg space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-text-secondary">Subtotal</span>
                            <span class="font-mono text-text-primary font-medium">${currencyUtils.format(subtotalBase)}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-text-secondary">Discount Amount</span>
                            <span id="discount-preview" class="font-mono text-red-400 font-medium">-${currencyUtils.format(0)}</span>
                        </div>
                        <div class="flex justify-between text-lg border-t border-border-color pt-2 mt-2">
                            <span class="text-text-primary font-bold">New Total (Est.)</span>
                            <span id="new-total-preview" class="font-mono text-accent font-bold">${currencyUtils.format(subtotalBase)}</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-secondary mb-1">Discount Method</label>
                        <div class="flex">
                            <select id="discount-type-selector" name="discountType" class="form-select rounded-r-none w-40">
                                <option value="percent" ${activeSale.discount?.type === 'percent' ? 'selected' : ''}>Percentage (%)</option>
                                <option value="fixed" ${activeSale.discount?.type === 'fixed' ? 'selected' : ''}>Fixed Amount (${displayCurrencyInfo.symbol})</option>
                                <option value="set-total">Set Manual Total</option>
                            </select>
                            <input type="number" step="0.01" id="discount-value-input" name="discountValue" value="${initialDiscountValueForDisplay}" placeholder="e.g., 5 or 10.50" class="w-full form-input rounded-l-none">
                        </div>
                        <p id="discount-helper-text" class="text-xs text-text-secondary mt-1">Leave value blank or 0 to remove discount.</p>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-text-secondary mb-1">Reason (Optional)</label>
                        <input type="text" name="discountReason" value="${activeSale.discount?.reason || ''}" placeholder="e.g., Holiday promotion, Staff discount" class="w-full form-input">
                    </div>
                </form>
                `;
                const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="total-discount-form" class="btn btn-primary">Apply Discount</button>`;
                const modal = showModal('Apply Total Discount', content, footer);
                
                const typeSelector = modal.querySelector('#discount-type-selector');
                const valueInput = modal.querySelector('#discount-value-input');
                const discountPreviewEl = modal.querySelector('#discount-preview');
                const newTotalPreviewEl = modal.querySelector('#new-total-preview');
                const submitBtn = modal.querySelector('button[type="submit"]');
                const helperText = modal.querySelector('#discount-helper-text');

                const updateDiscountPreview = () => {
                    const type = typeSelector.value;
                    const value = parseFloat(valueInput.value) || 0;
                    let discountAmountBase = 0;
                    let error = null;

                    if (value < 0) {
                        error = "Value can't be negative.";
                    } else if (type === 'percent') {
                        if (value > 100) { error = "Percent discount cannot exceed 100%."; } 
                        else { discountAmountBase = subtotalBase * (value / 100); }
                    } else if (type === 'fixed') {
                        const valueInBase = currencyUtils.convertToBase(value, appState.currentCurrency);
                        if (valueInBase > subtotalBase) { error = "Fixed discount cannot be greater than the subtotal."; } 
                        else { discountAmountBase = valueInBase; }
                    } else if (type === 'set-total') {
                        const newTotalInBase = currencyUtils.convertToBase(value, appState.currentCurrency);
                        if (newTotalInBase > subtotalBase) { error = "New total cannot be greater than the original subtotal."; }
                        else { discountAmountBase = subtotalBase - newTotalInBase; }
                    }
                    
                    if (error) {
                        discountPreviewEl.textContent = error;
                        discountPreviewEl.classList.remove('text-red-400');
                        discountPreviewEl.classList.add('text-yellow-400');
                        newTotalPreviewEl.textContent = '-';
                        submitBtn.disabled = true;
                    } else {
                        discountPreviewEl.textContent = `-${currencyUtils.format(discountAmountBase)}`;
                        discountPreviewEl.classList.add('text-red-400');
                        discountPreviewEl.classList.remove('text-yellow-400');
                        const newTotalBase = subtotalBase - discountAmountBase;
                        newTotalPreviewEl.textContent = currencyUtils.format(newTotalBase);
                        submitBtn.disabled = false;
                    }
                };

                const setupInputForType = (type) => {
                    if (type === 'set-total') {
                        valueInput.placeholder = 'e.g., 250.00';
                        helperText.textContent = `Enter the final price you want for the total.`;
                        const currentDiscountValue = activeSale.discount?.value || 0;
                        const currentDiscountType = activeSale.discount?.type || 'percent';
                        const currentDiscountAmountBase = currentDiscountType === 'percent' ? subtotalBase * (currentDiscountValue/100) : currentDiscountValue;
                        const currentTotalBase = subtotalBase - currentDiscountAmountBase;
                        valueInput.value = currencyUtils.convert(currentTotalBase).toFixed(2);
                    } else {
                        valueInput.placeholder = 'e.g., 5 or 10.50';
                        helperText.textContent = 'Leave value blank or 0 to remove discount.';
                        if (type === 'percent' && activeSale.discount?.type === 'percent') {
                           valueInput.value = activeSale.discount.value || '';
                        } else if (type === 'fixed' && activeSale.discount?.type === 'fixed') {
                            valueInput.value = activeSale.discount.value ? currencyUtils.convert(activeSale.discount.value).toFixed(2) : '';
                        } else {
                            valueInput.value = '';
                        }
                    }
                    updateDiscountPreview();
                };
                
                typeSelector.addEventListener('input', () => setupInputForType(typeSelector.value));
                valueInput.addEventListener('input', updateDiscountPreview);
                
                // Initial setup and calculation
                setupInputForType(typeSelector.value);
                
                modal.querySelector('#total-discount-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const subtotalBaseForSubmit = activeSale.cart.reduce((acc, item) => {
                        const price = item.originalPrice !== undefined ? item.originalPrice : item.price;
                        return acc + (price * (item.qty || 1));
                    }, 0);

                    const formData = new FormData(e.target);
                    const type = formData.get('discountType');
                    const valueInDisplay = parseFloat(formData.get('discountValue')) || 0;
                    
                    let discountTypeToSave = 'fixed'; // Default to fixed
                    let discountValueToSave = 0;

                    if (valueInDisplay === 0) {
                        discountTypeToSave = activeSale.discount?.type || 'percent'; // Keep old type if removing
                        discountValueToSave = 0;
                    } else if (type === 'set-total') {
                        const newTotalInBase = currencyUtils.convertToBase(valueInDisplay, appState.currentCurrency);
                        if (newTotalInBase < 0 || newTotalInBase > subtotalBaseForSubmit) { updateDiscountPreview(); return; }
                        discountTypeToSave = 'fixed';
                        discountValueToSave = subtotalBaseForSubmit - newTotalInBase;
                    } else if (type === 'percent') {
                        if (valueInDisplay < 0 || valueInDisplay > 100) { updateDiscountPreview(); return; }
                        discountTypeToSave = 'percent';
                        discountValueToSave = valueInDisplay;
                    } else { // fixed
                        const valueInBase = currencyUtils.convertToBase(valueInDisplay, appState.currentCurrency);
                        if (valueInBase < 0 || valueInBase > subtotalBaseForSubmit) { updateDiscountPreview(); return; }
                        discountTypeToSave = 'fixed';
                        discountValueToSave = valueInBase;
                    }

                    activeSale.cart.forEach(item => {
                        if (item.discount) {
                            item.price = item.originalPrice;
                            delete item.discount;
                            delete item.originalPrice;
                        }
                    });

                    activeSale.discount = { 
                        type: discountTypeToSave, 
                        value: discountValueToSave,
                        reason: formData.get('discountReason')
                    };
                    
                    showToast('Discount applied successfully.', 'success');
                    closeModal(modal);
                    posFullRender(document.getElementById('workspace-content').querySelector('.view-pane'));
                });
            }

            const renderProductDetailView = (productId, container) => {
                const product = firestoreData.products.find(p => p.id === productId);
                if (!product) { 
                    container.innerHTML = `<p>Product not found.</p>`; 
                    return; 
                }

                const profile = getCurrentProfile();
                const term = profile.terminology;

                let customDataHTML = '';
                if(product.customData && Object.keys(product.customData).length > 0){
                    customDataHTML = Object.entries(product.customData).map(([key, value]) => {
                        if (value === true) value = "Yes";
                        if (value === false) value = "No";
                        if (!value) return '';
                        return `<div class="flex justify-between py-3 border-b border-border-color/50"><span class="text-text-secondary">${key}</span><span class="text-text-primary font-medium text-right">${value}</span></div>`
                    }).join('');
                }

                const warrantyPolicies = appState.settings.warrantyPolicies || {};
                const warrantyPolicy = product.defaultWarrantyPolicyId ? warrantyPolicies[product.defaultWarrantyPolicyId] : null;
                
                if (warrantyPolicy) {
                    customDataHTML += `<div class="flex justify-between py-3 border-b border-border-color/50"><span class="text-text-secondary">Default Warranty</span><span class="text-text-primary font-medium text-right">${warrantyPolicy.name}</span></div>`;
                }

                if (!customDataHTML.trim()) {
                    customDataHTML = '<p class="text-sm text-text-secondary py-3">No additional details available.</p>';
                }
                
                let advancedInventoryHTML = '';
                if(product.isSerialized && product.serials && product.serials.length > 0) {
                    advancedInventoryHTML = `<h4 class="font-semibold text-text-primary mt-6 mb-2">Serial Numbers in Stock</h4><div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs font-mono">${product.serials.map(sn => `<span class="bg-bg-tertiary px-2 py-1 rounded text-text-secondary">${sn}</span>`).join('')}</div>`;
                }
                 if(product.hasExpiry && product.batches && product.batches.length > 0) {
                    advancedInventoryHTML = `<h4 class="font-semibold text-text-primary mt-6 mb-2">Batches</h4><table class="w-full text-left text-sm"><thead class="text-xs text-text-secondary uppercase"><tr><th class="py-1 font-normal">Batch ID</th><th class="py-1 font-normal">Expiry</th><th class="py-1 text-right font-normal">Stock</th></tr></thead><tbody>${product.batches.map(b => `<tr class="border-b border-border-color/50"><td class="py-2">${b.batchId}</td><td class="py-2">${b.expiryDate}</td><td class="py-2 text-right">${b.stock}</td></tr>`).join('')}</tbody></table>`;
                }

                const content = `
                <div class="view-pane">
                    <div class="flex justify-between items-center mb-6">
                         <button data-action="back-to-inventory" class="btn btn-secondary"><i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Back to ${term.inventory}</button>
                         ${checkPermission('canManageInventory') ? `<button data-action="edit-product" data-id="${productId}" class="btn btn-primary"><i data-lucide="edit" class="w-4 h-4 mr-2"></i>Edit ${term.product}</button>` : ''}
                    </div>
                    <div class="glass-pane p-8 rounded-xl grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="md:col-span-1">
                            <img src="https://placehold.co/400x400/121212/444444?text=${encodeURIComponent(product.name)}" class="rounded-lg w-full aspect-square object-cover" alt="${product.name}">
                        </div>
                        <div class="md:col-span-2">
                            <h2 class="text-3xl font-bold text-text-primary">${product.name}</h2>
                            <p class="font-mono text-xs text-text-secondary mb-4">${product.id}</p>
                            
                            <div class="grid grid-cols-2 gap-x-6 gap-y-4 text-sm my-6">
                                <div class="flex flex-col"><span class="text-xs text-text-secondary uppercase">Price</span><span class="text-2xl font-mono text-accent font-bold">${currencyUtils.format(product.price)}</span></div>
                                <div class="flex flex-col"><span class="text-xs text-text-secondary uppercase">Stock</span><span class="text-2xl font-mono text-text-primary font-bold">${product.productType === 'physical' ? product.stock : 'N/A'}</span></div>
                                <div class="flex flex-col"><span class="text-xs text-text-secondary uppercase">${term.category}</span><span class="text-text-primary font-medium">${product.category}</span></div>
                                <div class="flex flex-col"><span class="text-xs text-text-secondary uppercase">${term.product} Type</span><span class="text-text-primary font-medium capitalize">${product.productType}</span></div>
                            </div>
                            
                            <div id="barcode-container" class="mt-2 mb-4"></div>

                            <div class="border-t border-border-color pt-2 text-sm">${customDataHTML}</div>
                            ${advancedInventoryHTML}
                        </div>
                    </div>
                </div>`;
                
                container.innerHTML = content;

                if (product.barcode && typeof JsBarcode === 'function') {
                    try {
                        const barcodeContainer = container.querySelector('#barcode-container');
                        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                        svg.id = `barcode-${product.id}`;
                        barcodeContainer.appendChild(svg);

                        JsBarcode(svg, product.barcode, {
                            displayValue: true,
                            fontSize: 14,
                            lineColor: "#e5e7eb",
                            fontColor: "#d1d5db",
                            background: "transparent",
                            margin: 10,
                            height: 60
                        });
                    } catch (e) {
                        console.error("JsBarcode error:", e);
                        container.querySelector('#barcode-container').innerHTML = `<p class="text-xs text-red-400">Invalid Barcode: ${product.barcode}</p>`;
                    }
                }

                lucide.createIcons();

                container.querySelector('[data-action="back-to-inventory"]').addEventListener('click', () => {
                    initInventory(container);
                });
                
                const editButton = container.querySelector(`[data-action="edit-product"]`);
                if (editButton) {
                    editButton.addEventListener('click', () => {
                        openProductFormModal(true, product);
                    });
                }
            };


            document.getElementById('ai-assistant-btn').addEventListener('click', () => {
                const term = getCurrentProfile().terminology;
                const promptSuggestions = [
                    `Add 2 Espresso Coffee Beans to the current sale`,
                    `Create a new sale for customer "Jane Doe" with 1 Organic Apple`,
                    `What is the profit margin on "Hyperion X1 Smartphone"?`,
                    `Delete customer "John Doe"`,
                    `      ?`
                ];

                const content = `<div class="ai-chat-container flex flex-col h-[80vh] max-h-[900px] bg-transparent">
                    <div class="ai-chat-header p-4 border-b border-white/10 flex items-center gap-4 shrink-0">
                        <div class="relative">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-accent to-blue-500 flex items-center justify-center ring-2 ring-white/20">
                                <i data-lucide="sparkles" class="w-7 h-7 text-white"></i>
                            </div>
                            <div class="absolute bottom-0 right-0 w-4 h-4 bg-green-500 rounded-full border-2 border-bg-secondary"></div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-white">Global AI Assistant</h3>
                            <p class="text-xs text-green-300">Online</p>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto p-4 space-y-6 text-sm" id="ai-chat-history">
                        <!-- Initial Welcome Message -->
                        <div class="ai-message flex gap-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 self-end bg-bg-tertiary">
                                <i data-lucide="sparkles" class="w-5 h-5 text-accent"></i>
                            </div>
                            <div class="bg-bg-secondary rounded-2xl rounded-bl-lg p-3 max-w-md border border-white/10 shadow-lg">
                                <p class="text-text-primary">I'm now fully integrated with your system. You can ask me to do anything from analyzing sales data to creating a ${term.product}. How can I help?</p>
                            </div>
                        </div>
                    </div>

                    <div class="ai-chat-footer p-4 border-t border-white/10 shrink-0">
                        <!-- Prompt Suggestions -->
                        <div class="w-full overflow-x-auto pb-3 mb-2 scrollbar-hide" id="ai-prompt-suggestions-container">
                             <div class="flex items-center gap-2 text-xs whitespace-nowrap">
                                ${promptSuggestions.map(p => `<button class="prompt-suggestion">${p}</button>`).join('')}
                             </div>
                        </div>
                        <!-- Input Form -->
                        <form id="ai-input-form" class="relative">
                            <textarea id="ai-input" placeholder="Ask the AI anything..." class="w-full form-input pr-14 pl-5 py-3 bg-bg-tertiary/80 border-border-color rounded-xl resize-none" rows="1"></textarea>
                            <button type="submit" class="absolute right-3 top-1/2 -translate-y-1/2 p-2.5 bg-accent text-white rounded-lg hover:bg-accent-hover transition-all duration-300 disabled:opacity-50 disabled:scale-90">
                                <i data-lucide="send-horizontal" class="w-5 h-5"></i>
                            </button>
                        </form>
                    </div>
                </div>`;

                const modal = showModal('AI Assistant', content, '', {size: 'max-w-2xl', customClasses: 'p-0 ai-modal-pane'});
                lucide.createIcons();

                const input = modal.querySelector('#ai-input');
                const form = modal.querySelector('#ai-input-form');
                const history = modal.querySelector('#ai-chat-history');
                
                modal.querySelector('#ai-prompt-suggestions-container').addEventListener('click', e => {
                    const target = e.target.closest('.prompt-suggestion');
                    if(target) {
                        input.value = target.textContent;
                        form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                    }
                });

                // Auto-resize textarea
                input.addEventListener('input', () => {
                    input.style.height = 'auto';
                    const scrollHeight = input.scrollHeight;
                    if (scrollHeight < 150) { // Max height of ~4 rows
                        input.style.height = scrollHeight + 'px';
                    } else {
                        input.style.height = '150px';
                    }
                });

                form.addEventListener('submit', async e => {
                    e.preventDefault();
                    const userPrompt = input.value;
                    if (!userPrompt.trim()) return;
                    
                    const sanitizedPrompt = userPrompt.replace(/</g, "&lt;").replace(/>/g, "&gt;");

                    // Display user's prompt
                    const userMessage = document.createElement('div');
                    userMessage.className = 'user-message flex justify-end gap-3';
                    userMessage.innerHTML = `
                        <div class="bg-gradient-to-br from-accent to-blue-500 text-white rounded-2xl rounded-br-lg p-3 max-w-md border border-blue-400/50 shadow-lg">
                           <p class="break-words">${sanitizedPrompt}</p>
                        </div>`;
                    history.appendChild(userMessage);

                    // Hide suggestions after first prompt
                    const suggestions = modal.querySelector('#ai-prompt-suggestions-container');
                    if(suggestions) suggestions.style.display = 'none';
                    
                    input.value = '';
                    input.style.height = 'auto';
                    input.disabled = true;
                    form.querySelector('button').disabled = true;

                    // Show typing indicator
                    const typingIndicator = document.createElement('div');
                    typingIndicator.className = 'ai-message flex gap-3 typing-indicator';
                    typingIndicator.innerHTML = `
                        <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 self-end bg-bg-tertiary">
                            <i data-lucide="sparkles" class="w-5 h-5 text-accent"></i>
                        </div>
                        <div class="bg-bg-secondary rounded-2xl rounded-bl-lg p-3 max-w-md flex items-center gap-2">
                            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                        </div>`;
                    history.appendChild(typingIndicator);
                    history.scrollTop = history.scrollHeight;

                    // Process command and display AI's response
                    const aiResponse = await processAiCommand(userPrompt);
                    
                    typingIndicator.remove(); // Remove typing indicator
                    
                    const aiMessage = document.createElement('div');
                    aiMessage.className = 'ai-message flex gap-3';
                    aiMessage.innerHTML = `
                        <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 self-end bg-bg-tertiary">
                            <i data-lucide="sparkles" class="w-5 h-5 text-accent"></i>
                        </div>
                        <div class="bg-bg-secondary rounded-2xl rounded-bl-lg p-3 max-w-md border border-white/10 shadow-lg">
                            <p class="text-text-primary break-words">${aiResponse}</p>
                        </div>`;
                    history.appendChild(aiMessage);
                    history.scrollTop = history.scrollHeight;
                    lucide.createIcons();
                    
                    input.disabled = false;
                    form.querySelector('button').disabled = false;
                    input.focus();
                    
                    const existingModal = document.getElementById(modal.id);
                    if (aiResponse.toLowerCase().includes("opening") || aiResponse.toLowerCase().includes("creating")) {
                       setTimeout(() => { if (existingModal) closeModal(existingModal); }, 1500);
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        form.requestSubmit();
                    }
                });
            });
             
             const showLargeReceiptPreview = (templateId) => {
                const template = receiptTemplates[templateId];
                if (!template) return;

                const mockInvoice = {
                    id: 'PREVIEW-001',
                    customerName: 'Amelia Chen',
                    customer: firestoreData.customers.length > 0 ? firestoreData.customers[0] : { name: 'Amelia Chen', loyaltyId: 'CUST-PREVIEW'},
                    total: 0, 
                    date: new Date().toISOString(),
                    items: [],
                    cashier: 'Preview Mode',
                    storeId: 'STR-PV',
                    pointsEarned: 0,
                    currency: appState.currentCurrency,
                    exchangeRate: currencyUtils.get().rate,
                };
                
                // Safely add products to the mock invoice for preview
                if (firestoreData.products.length > 0) mockInvoice.items.push(JSON.parse(JSON.stringify(firestoreData.products[0])));
                if (firestoreData.products.length > 1) mockInvoice.items.push({ ...JSON.parse(JSON.stringify(firestoreData.products[1])), serialNumber: 'SN-HX1-PREVIEW'});
                if (firestoreData.products.length > 2) mockInvoice.items.push({ ...JSON.parse(JSON.stringify(firestoreData.products[2])), qty: 2.5 });
                
                // If there are no products at all, add a generic placeholder to prevent errors
                if (mockInvoice.items.length === 0) {
                    mockInvoice.items.push({ id: 'SKU-PV', name: 'Sample Product', price: 25.00, qty: 1, taxable: true });
                }

                const taxRate = (appState.settings.taxRate ?? 0) / 100;
                const subtotalBase = mockInvoice.items.reduce((acc, item) => acc + (item.price * (item.qty || 1)), 0);
                const taxableSubtotal = mockInvoice.items.filter(i => i.taxable).reduce((acc, item) => acc + (item.price * (item.qty || 1)), 0);
                const taxBase = taxableSubtotal * taxRate;
                mockInvoice.totalInBaseCurrency = subtotalBase + taxBase;
                mockInvoice.total = currencyUtils.convert(mockInvoice.totalInBaseCurrency);
                mockInvoice.pointsEarned = Math.floor(mockInvoice.totalInBaseCurrency);

                const mockPaymentState = {
                    payments: [
                        { method: 'Card', amount: currencyUtils.convert(80.00) },
                        { method: 'Cash', amount: currencyUtils.convert(10.00) }
                    ],
                    total: mockInvoice.total,
                };
                
                const content = template.getBody(mockInvoice, mockPaymentState);
                const modal = showModal(`Preview: ${template.name}`, content, `<button data-action="close-modal" class="btn btn-secondary">Close</button>`, {size: 'max-w-2xl', customClasses: 'p-0'});
                lucide.createIcons();
             };

const receiptTemplates = {
    modern: {
        name: 'Futuristic',
        preview: `<div class="bg-white p-4 font-sans text-[8px] leading-tight text-black border border-gray-300"><div class="flex justify-between items-center"><div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center"><i data-lucide="gem" class="w-4 h-4 text-gray-600"></i></div><p class="font-bold text-gray-800 text-[10px]">INVOICE</p></div><div class="mt-4 space-y-1"><div class="h-2 w-full bg-gray-200 rounded-full"></div><div class="h-2 w-3/4 bg-gray-200 rounded-full"></div></div><div class="mt-4 h-px bg-gray-300"></div><p class="text-right text-gray-800 font-bold text-[10px] mt-2">TOTAL: ${currencyUtils.format(25, appState.currentCurrency)}</p></div>`,
        getBody: (invoice, paymentState) => {
            const { storeInfo } = firestoreData;
            const taxRate = (appState.settings.taxRate ?? 0);
            const currency = invoice.currency || appState.currentCurrency;
            const symbol = currencyUtils.get(currency).symbol;
            // --- NEW: Handle Return Logic ---
            const isReturn = invoice.invoiceType === 'return';
            const title = isReturn ? 'Return Receipt' : (invoice.isEMI ? 'EMI Invoice' : 'Receipt');
            const totalLabel = isReturn ? 'Total Credited' : 'Grand Total';
            const totalColor = isReturn ? 'text-blue-600' : 'text-gray-900';
            const thankYouMessage = isReturn ? 'Your return has been processed.' : `Thank you, ${invoice.customerName.split(' ')[0]}!`;
            // --- END NEW ---
            // --- UPDATED: Use stored discount values ---
            const subtotalBase = invoice.subtotalInBaseCurrency;
            const persistentDiscount = invoice.persistentDiscountDetails || {};
            const persistentDiscountBase = persistentDiscount.amount || 0;
            const manualDiscountBase = invoice.manualDiscountInBase || 0;
            const taxBase = invoice.taxInBaseCurrency;
            const totalBase = invoice.totalInBaseCurrency;
            const tier = invoice.customerTierSnapshot; // Get tier snapshot
            
            let persistentLabel = 'Persistent Discount';
            if (persistentDiscount.best > 0) {
                if (persistentDiscount.best === persistentDiscount.staff) persistentLabel = `Staff Discount (${persistentDiscount.staff}%)`;
                else if (persistentDiscount.best === persistentDiscount.lifetime) persistentLabel = `Lifetime Discount (${persistentDiscount.lifetime}%)`;
                else if (persistentDiscount.best === persistentDiscount.tier) persistentLabel = `${tier?.name || 'Tier'} Discount (${persistentDiscount.tier}%)`;
            }
            // --- END UPDATED ---

            const payments = paymentState ? paymentState.payments : invoice.paymentDetails || [];
            const totalPaidCurrent = payments.reduce((sum, p) => sum + p.amount, 0);
            const changeDueCurrent = paymentState ? totalPaidCurrent - paymentState.total : 0;
            const amountDueBase = invoice.dueAmount || 0;

            let recommendations = '';
            const purchasedProductIds = new Set(invoice.items.map(item => item.id));
            const recommendationCandidates = firestoreData.products.filter(p => !p.parentSKU && (p.status || 'active') === 'active' && !purchasedProductIds.has(p.id));
            if (recommendationCandidates.length > 0) { recommendationCandidates.sort((a, b) => (b.sales || 0) - (a.sales || 0)); const recommendedProduct = recommendationCandidates[0]; if (recommendedProduct) { recommendations += `<p class="mt-1">Check out our popular <span class="text-gray-800 font-semibold">${recommendedProduct.name}</span> in store!</p>`; } }

            let warrantyInfo = '';
             const electronicItems = invoice.items.filter(p => p.category === 'Electronics'); if (electronicItems.length > 0) { warrantyInfo = `<div class="mt-4 p-3 bg-gray-100 rounded-lg text-xs"><h4 class="font-bold text-gray-700 mb-1">Warranty Information</h4>${electronicItems.map(p => `<p><span class="font-medium">${p.name}:</span> 2-Year Limited Warranty</p>`).join('')}</div>`; }

            // --- EMI SECTION ---
            let emiDetailsHTML = '';
            if (invoice.isEMI) {
                const schedule = firestoreData.emiSchedules.find(s => s.invoiceId === invoice.id);
                if (schedule) {
                    const nextPayment = schedule.schedule.find(p => p.status === 'Pending' || p.status === 'Partial');
                    const nextDueText = nextPayment ? new Date(nextPayment.dueDate).toLocaleDateString() : 'Paid';
                    emiDetailsHTML = `
                    <div class="mt-4 border-t border-gray-200 pt-4">
                        <h4 class="font-bold text-gray-700 mb-2 text-xs uppercase tracking-wide flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-banknote"><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></svg>
                            EMI Loan Details
                        </h4>
                        <div class="bg-gray-50 p-3 rounded-lg text-xs space-y-1">
                            <div class="flex justify-between text-gray-600"><span>Loan Principal:</span> <span class="font-mono">${currencyUtils.format(schedule.totalPrincipal, currency)}</span></div>
                            <div class="flex justify-between text-gray-600"><span>Down Payment:</span> <span class="font-mono">${currencyUtils.format(schedule.downPayment, currency)}</span></div>
                            <div class="flex justify-between text-gray-600"><span>Interest Rate:</span> <span>${schedule.interestRate}% p.a.</span></div>
                            <div class="flex justify-between text-gray-600"><span>Tenure:</span> <span>${schedule.tenureMonths} Months</span></div>
                            <div class="h-px bg-gray-200 my-1"></div>
                            <div class="flex justify-between font-bold text-gray-800 text-sm">
                                <span>Monthly EMI:</span> <span class="font-mono">${currencyUtils.format(schedule.emiAmount, currency)}</span>
                            </div>
                            <div class="flex justify-between text-gray-500 mt-1">
                                <span>Next Due Date:</span> <span>${nextDueText}</span>
                            </div>
                        </div>
                    </div>`;
                }
            }

            return `<div class="bg-white text-gray-800 font-sans p-8" id="receipt-content" style="font-family: 'Inter', sans-serif;">
                    <header class="flex justify-between items-start pb-4 border-b border-gray-300">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-3"><img src="${storeInfo.logoUrl}" class="w-8 h-8 rounded-full" alt="logo"/> ${storeInfo.name}</h1>
                            <p class="text-xs text-gray-600 mt-2">${storeInfo.address}<br>Ph: ${storeInfo.contact} | Web: ${storeInfo.website}<br>BIN: ${storeInfo.taxId}</p>
                        </div>
                        <div class="text-right">
                            <h2 class="text-xl font-semibold ${isReturn ? 'text-blue-600' : 'text-gray-700'} uppercase tracking-widest">${title}</h2>
                            <p class="text-sm font-mono text-gray-500">${invoice.id}</p>
                            ${isReturn ? `<p class="text-xs text-gray-500 mt-1">Original: ${invoice.returnOfInvoiceId}</p>` : ''}
                        </div>
                    </header>
                    <section class="flex justify-between text-xs mt-4 text-gray-500">
                        <p>Date: ${new Date(invoice.date).toLocaleString()}</p><p>Cashier: ${invoice.cashierName} / Store: ${storeInfo.name}</p>
                    </section>
                    ${invoice.customer ? `<section class="mt-6 border-t border-gray-200 pt-4"><h3 class="text-sm font-semibold text-gray-500">${isReturn ? 'Credited To' : 'Billed To'}:</h3><p class="text-gray-900 font-medium">${invoice.customer.name}</p><p class="text-xs text-gray-500">Loyalty ID: ${invoice.customer.loyaltyId || 'N/A'}</p></section>` : ''}
                    <section class="mt-6">
                        <table class="w-full text-sm text-gray-700">
                            <thead><tr class="text-left text-gray-600 uppercase text-xs border-b-2 border-gray-800"><th class="py-2 font-semibold tracking-wider">Item ${isReturn ? 'Returned' : '/ SKU'}</th><th class="py-2 text-center">QtyPrice</th><th class="py-2 text-right font-semibold tracking-wider">Total</th></tr></thead>
                            <tbody>${invoice.items.map(item => `<tr>
                                <td class="py-2 pr-2" style="vertical-align: top;">
                                    ${item.isSerialized && !isReturn ? `
                                        <div style="float: right; margin-left: 12px; border-radius: 50%; border: 1.5px solid #a0aec0; color: #4a5568; width: 75px; height: 75px; text-align: center; font-family: 'Arial Black', Gadget, sans-serif; transform: rotate(-10deg); padding: 5px; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, rgba(200, 200, 200, 0.1) 0%, rgba(200, 200, 200, 0) 70%); box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);">
                                            <span style="font-weight: 900; text-transform: uppercase; font-size: 8px; line-height: 1; letter-spacing: 0.5px; color: #718096;">WARRANTY</span>
                                            <span style="font-size: 20px; font-weight: 900; line-height: 1.1; margin: 2px 0; color: #2d3748;">1<span style="font-size: 14px;">Y</span></span>
                                            <span style="font-size: 7px; line-height: 1; text-transform: uppercase; letter-spacing: 0.5px; color: #718096;">PROTECTED</span>
                                        </div>` : ''}
                                    <div style="overflow: hidden;">
                                        ${item.name}<br>
                                        <span class="text-gray-500 text-xs font-mono">${item.id} ${item.serialNumber ? `(SN: ${item.serialNumber})` : ''}</span>
                                    </div>
                                </td>
                                <td class="py-2 text-center font-mono">${item.qty || 1}  ${currencyUtils.format(item.price, currency)}</td>
                                <td class="py-2 text-right font-mono">${currencyUtils.format((item.qty || 1) * item.price, currency)}</td>
                            </tr>`).join('')}</tbody>
                        </table>
                    </section>
                    <section class="mt-6 flex justify-end">
                        <div class="w-full max-w-xs text-sm">
                            <div class="flex justify-between text-gray-600"><span>Subtotal:</span><span class="font-mono">${currencyUtils.format(subtotalBase, currency)}</span></div>
                            ${persistentDiscountBase > 0 ? `<div class="flex justify-between text-purple-600"><span>${persistentLabel}:</span><span class="font-mono">-${currencyUtils.format(persistentDiscountBase, currency)}</span></div>` : ''}
                            ${manualDiscountBase > 0 ? `<div class="flex justify-between text-red-600"><span>Manual Discount:</span><span class="font-mono">-${currencyUtils.format(manualDiscountBase, currency)}</span></div>` : ''}
                            <div class="flex justify-between text-gray-600"><span>Tax (${taxRate}%):</span><span class="font-mono">${currencyUtils.format(taxBase, currency)}</span></div>
                            <div class="h-px bg-gray-800 my-2"></div>
                            <div class="flex justify-between font-bold text-2xl ${totalColor}"><span>${totalLabel}:</span><span class="font-mono">${currencyUtils.format(totalBase, currency)}</span></div>
                        </div>
                    </section>
                    <section class="mt-4 pt-4 border-t border-gray-300">
                        <div class="w-full max-w-xs text-sm ml-auto">
                            ${!isReturn ? payments.map(p => `<div class="flex justify-between mt-1 text-gray-600"><span>Paid (${p.method}):</span><span class="font-mono">${symbol}${p.amount.toFixed(2)}</span></div>`).join('') : ''}
                            ${amountDueBase > 0.001 ? `<div class="flex justify-between mt-1 font-bold text-red-600"><span>Remaining Due:</span><span class="font-mono">${currencyUtils.format(amountDueBase, currency)}</span></div>` : ''}
                            ${changeDueCurrent > 0.001 ? `<div class="flex justify-between mt-1 font-semibold text-gray-900"><span>Change Due:</span><span class="font-mono">${symbol}${changeDueCurrent.toFixed(2)}</span></div>` : ''}
                            ${isReturn ? `<div class="flex justify-between mt-2 pt-2 border-t border-gray-300 font-bold text-blue-600"><span>Status:</span><span>Amount Credited</span></div>` : ''}
                            ${!isReturn && invoice.status === 'Paid' && amountDueBase < 0.001 && changeDueCurrent < 0.001 ? `<div class="flex justify-between mt-2 pt-2 border-t border-gray-300 font-bold text-green-600"><span>Status:</span><span>Paid in Full</span></div>` : ''}
                        </div>
                    </section>
                    ${emiDetailsHTML}
                    <section class="mt-6 text-center text-xs text-gray-600 p-3 bg-gray-100 rounded-lg">
                        ${isReturn ? `<p class="font-bold text-gray-900">Return Reason: ${invoice.notes || 'N/A'}</p>` : `<p>You earned <span class="font-bold text-gray-900">${invoice.pointsEarned || 0}</span> points on this purchase!</p>`}
                        <p class="mt-1">${(storeInfo.settings.receiptFooterText || '').replace(/\n/g, '<br>')}</p>
                    </section>
                    ${recommendations || warrantyInfo ? `<div class="mt-4 text-xs text-gray-700"><h4 class="font-bold text-gray-600">Just For You:</h4>${recommendations}${warrantyInfo}</div>` : ''}
                    <footer class="mt-8 text-center text-xs text-gray-500">
                        <p class="text-base font-semibold text-gray-900">${thankYouMessage}</p>
                        <p>Rate your experience | Follow us ${storeInfo.socials}</p>
                        ${!isReturn ? `<p class="mt-2 opacity-70"> Request an e-receipt next time to save paper.</p>` : ''}
                    </footer>
                    <div class="mt-4 pt-4 border-t border-gray-200 text-center text-[10px] text-gray-400"> 
                        <p>Powered by CashShilpo</p>
                    </div>
                </div>`;
            }
        },
    thermal: {
        name: 'Thermal Receipt',
        preview: `<div class="bg-white p-2 font-mono text-[6px] leading-tight text-black h-full w-full flex flex-col justify-between"><div class="text-center"><p class="font-bold">YOUR STORE</p><p>123 Business Rd.</p></div><div class="border-t border-dashed border-black pt-1 my-1"><div class="flex justify-between"><p>Item 1</p><p>$10.00</p></div><div class="flex justify-between"><p>Item 2</p><p>$15.00</p></div></div><div class="border-t border-dashed border-black pt-1 my-1 font-bold flex justify-between"><p>TOTAL</p><p>$25.00</p></div><div class="text-center text-[5px]">Thank you!</div></div>`,
        getBody: (invoice, paymentState) => {
            const { storeInfo } = firestoreData;
            const taxRate = (appState.settings.taxRate ?? 0);
            const currency = invoice.currency || appState.currentCurrency;
            const symbol = currencyUtils.get(currency).symbol;
            // --- NEW: Handle Return Logic ---
            const isReturn = invoice.invoiceType === 'return';
            const title = isReturn ? 'RETURN RECEIPT' : (invoice.isEMI ? 'EMI LOAN INVOICE' : 'SALES RECEIPT');
            const totalLabel = isReturn ? 'TOTAL CREDIT' : 'TOTAL';
            const thankYouMessage = isReturn ? 'Your return is complete.' : 'Thank you for your business!';
            // --- END NEW ---

            // --- UPDATED: Use stored discount values ---
            const subtotalBase = invoice.subtotalInBaseCurrency;
            const persistentDiscount = invoice.persistentDiscountDetails || {};
            const persistentDiscountBase = persistentDiscount.amount || 0;
            const manualDiscountBase = invoice.manualDiscountInBase || 0;
            const taxBase = invoice.taxInBaseCurrency;
            const totalBase = invoice.totalInBaseCurrency;
            const tier = invoice.customerTierSnapshot;

            let persistentLabel = 'Persistent Discount';
            if (persistentDiscount.best > 0) {
                if (persistentDiscount.best === persistentDiscount.staff) persistentLabel = `Staff Disc (${persistentDiscount.staff}%)`;
                else if (persistentDiscount.best === persistentDiscount.lifetime) persistentLabel = `VIP Disc (${persistentDiscount.lifetime}%)`;
                else if (persistentDiscount.best === persistentDiscount.tier) persistentLabel = `${tier?.name || 'Tier'} Disc (${persistentDiscount.tier}%)`;
            }
            // --- END UPDATED ---

            const payments = paymentState ? paymentState.payments : invoice.paymentDetails || [];
            const totalPaidCurrent = payments.reduce((sum, p) => sum + p.amount, 0);
            const changeDueCurrent = paymentState ? totalPaidCurrent - paymentState.total : 0;
            const amountDueBase = invoice.dueAmount || 0;

            const formatThermal = (amountInBase) => { const converted = currencyUtils.convert(amountInBase, currency); return `${symbol}${converted.toFixed(2)}`; };

            // --- EMI SECTION ---
            let emiDetailsHTML = '';
            if (invoice.isEMI) {
                const schedule = firestoreData.emiSchedules.find(s => s.invoiceId === invoice.id);
                if (schedule) {
                    emiDetailsHTML = `
                    <div style="border-top: 1px dashed #000; margin: 10px 0;"></div>
                    <section style="font-size: 11px;">
                        <p style="font-weight: bold; text-align: center; margin-bottom: 5px;">EMI LOAN DETAILS</p>
                        <table style="width: 100%;">
                            <tr><td>Principal:</td><td style="text-align: right;">${formatThermal(schedule.totalPrincipal)}</td></tr>
                            <tr><td>Down Pmt:</td><td style="text-align: right;">${formatThermal(schedule.downPayment)}</td></tr>
                            <tr><td>Rate:</td><td style="text-align: right;">${schedule.interestRate}%</td></tr>
                            <tr><td>Tenure:</td><td style="text-align: right;">${schedule.tenureMonths} Months</td></tr>
                            <tr style="font-weight: bold;"><td>Monthly EMI:</td><td style="text-align: right;">${formatThermal(schedule.emiAmount)}</td></tr>
                        </table>
                    </section>`;
                }
            }

            return `
                    <div id="receipt-content" style="width: 302px; margin: 0 auto; background: #fff; color: #000; font-family: 'Courier New', monospace; font-size: 12px; padding: 20px;">
                        <header style="text-align: center;"> 
                            <h1 style="font-size: 20px; font-weight: bold; margin: 0;">${storeInfo.name}</h1>
                            <p style="font-size: 11px; margin: 2px 0;">${storeInfo.address}</p>
                            <p style="font-size: 11px; margin: 2px 0;">Ph: ${storeInfo.contact}</p>
                            ${storeInfo.taxId ? `<p style="font-size: 11px; margin: 2px 0;">BIN: ${storeInfo.taxId}</p>` : ''}
                            <h2 style="font-size: 16px; font-weight: bold; margin-top: 10px;">${title}</h2>
                        </header>
                        <div style="border-top: 1px dashed #000; margin: 10px 0;"></div>
                        <section style="font-size: 11px;"> 
                            <p>${isReturn ? 'Return ID' : 'Receipt ID'}: ${invoice.id}</p>
                            ${isReturn ? `<p>Original ID: ${invoice.returnOfInvoiceId}</p>` : ''}
                            <p>Date: ${new Date(invoice.date).toLocaleString()}</p>
                            <p>Cashier: ${invoice.cashierName}</p>
                            ${invoice.customer ? `<p>Customer: ${invoice.customer.name}</p>` : ''}
                        </section>
                        <div style="border-top: 1px dashed #000; margin: 10px 0;"></div>
                        <section> 
                            <table style="width: 100%; font-size: 12px;">
                                <thead><tr><th style="text-align: left; font-weight: bold;">ITEM ${isReturn ? 'RETURNED' : ''}</th><th style="text-align: right; font-weight: bold;">TOTAL</th></tr></thead>
                                <tbody>${invoice.items.map(item => `<tr><td colspan="2">${item.name} ${item.serialNumber ? `(SN: ${item.serialNumber})` : ''}</td></tr><tr><td style="padding-left: 10px;">${item.qty || 1} x ${formatThermal(item.price)}</td><td style="text-align: right;">${formatThermal((item.qty || 1) * item.price)}</td></tr>`).join('')}</tbody>
                            </table>
                        </section>
                        <div style="border-top: 1px dashed #000; margin: 10px 0;"></div>
                        <section> 
                            <table style="width: 100%; font-size: 12px;">
                                <tbody>
                                    <tr><td>Subtotal:</td><td style="text-align: right;">${formatThermal(subtotalBase)}</td></tr>
                                    ${persistentDiscountBase > 0 ? `<tr><td>${persistentLabel}:</td><td style="text-align: right;">-${formatThermal(persistentDiscountBase)}</td></tr>` : ''}
                                    ${manualDiscountBase > 0 ? `<tr><td>Manual Discount:</td><td style="text-align: right;">-${formatThermal(manualDiscountBase)}</td></tr>` : ''}
                                    <tr><td>Tax (${taxRate}%):</td><td style="text-align: right;">${formatThermal(taxBase)}</td></tr>
                                    <tr style="font-weight: bold; font-size: 16px; border-top: 1px solid #000; margin-top: 5px; padding-top: 5px;"><td>${totalLabel}:</td><td style="text-align: right;">${formatThermal(totalBase)}</td></tr>
                                </tbody>
                            </table>
                        </section>
                        <div style="border-top: 1px dashed #000; margin: 10px 0;"></div>
                        <section> 
                            <table style="width: 100%; font-size: 12px;">
                                <tbody>
                                    ${isReturn ? `<tr><td style="font-weight: bold;">AMOUNT CREDITED:</td><td style="text-align: right; font-weight: bold;">${formatThermal(totalBase)}</td></tr>` : ''}
                                    ${!isReturn ? payments.map(p => `<tr><td>${p.method} Paid:</td><td style="text-align: right;">${symbol}${p.amount.toFixed(2)}</td></tr>`).join('') : ''}
                                    ${!isReturn && changeDueCurrent > 0.001 ? `<tr><td>Change Due:</td><td style="text-align: right;">${symbol}${changeDueCurrent.toFixed(2)}</td></tr>` : ''}
                                    ${!isReturn && amountDueBase > 0.001 ? `<tr style="font-weight: bold;"><td>Amount Due:</td><td style="text-align: right;">${formatThermal(amountDueBase)}</td></tr>` : ''}
                                </tbody>
                            </table>
                        </section>
                        ${emiDetailsHTML}
                        <div style="border-top: 1px dashed #000; margin: 10px 0;"></div>
                        <footer style="text-align: center; font-size: 11px;">
                            <p style="margin-bottom: 5px;">${thankYouMessage}</p>
                            <p>${(storeInfo.settings.receiptFooterText || '').replace(/\n/g, '<br>')}</p>
                            ${isReturn ? `<p style="margin-top: 5px;">Return Reason: ${invoice.notes || 'N/A'}</p>` : `<p style="margin-top: 5px;">Points Earned: ${invoice.pointsEarned || 0}</p>`}
                        </footer>
                        <div style="text-align: center; font-size: 10px; margin-top: 10px;">
                            Powered by CashShilpo
                        </div>
                    </div>`;
            }
        },
    payment: { 
        name: 'Payment Receipt',
        // ... existing payment receipt code ...
        preview: `<div class="bg-green-900/50 p-4 font-sans text-[8px] leading-tight text-white"><div class="flex justify-between items-center"><div class="w-8 h-8 bg-green-400 rounded-full flex items-center justify-center"><i data-lucide="check" class="w-4 h-4 text-white"></i></div><p class="font-bold text-green-300 text-[10px]">PAYMENT</p></div><div class="mt-4 text-[10px]"><p>RECEIVED: ${currencyUtils.format(100)}</p></div><div class="mt-2 h-px bg-green-400/50"></div><p class="text-right text-green-300 font-bold text-[10px] mt-2">NEW BALANCE: ${currencyUtils.format(50)}</p></div>`,
        getBody: (receiptData) => {
             const { storeInfo } = firestoreData;
             return `<div class="bg-gray-900 text-gray-200 font-sans p-8" id="receipt-content" style="font-family: 'Inter', sans-serif; background: linear-gradient(145deg, #101827, #0b111e);">
                <header class="flex justify-between items-start pb-4 border-b border-green-800">
                    <div> <h1 class="text-2xl font-bold text-white flex items-center gap-3"><img src="${storeInfo.logoUrl}" class="w-8 h-8 rounded-full bg-green-600/50" alt="logo"/> ${storeInfo.name}</h1> <p class="text-xs text-green-300 mt-2">${storeInfo.address}<br>Ph: ${storeInfo.contact}</p> </div>
                    <div class="text-right"> <h2 class="text-xl font-semibold text-white uppercase tracking-widest">Payment Receipt</h2> <p class="text-sm font-mono text-green-400">PAY-${Date.now().toString().slice(-6)}</p> </div>
                </header>
                <section class="flex justify-between text-xs mt-4 text-green-300"> <p>Date: ${new Date(receiptData.date).toLocaleString()}</p> </section>
                 <section class="mt-6 border-t border-green-800 pt-4"> <h3 class="text-sm font-semibold text-green-300">Payment From:</h3> <p class="text-white font-medium">${receiptData.customer.name}</p> <p class="text-xs text-green-300">Loyalty ID: ${receiptData.customer.loyaltyId}</p> </section>
                 <section class="mt-6 p-6 bg-green-500/10 rounded-lg text-center"> <p class="text-sm text-green-200">Amount Received</p> <p class="text-4xl font-bold font-mono text-white">${currencyUtils.format(receiptData.amountPaid)}</p> <p class_name="text-sm text-green-200 mt-1">via ${receiptData.method}</p> </section>
                 <section class="mt-6"> <h4 class="text-sm font-semibold text-green-300 mb-2">Payment applied to the following invoice(s):</h4> <div class="space-y-1 text-sm"> ${receiptData.appliedTo.map(item => `<div class="flex justify-between items-center p-2 bg-bg-tertiary rounded"> <span class="font-mono text-xs text-green-300">${item.id}</span> <span class="font-mono text-white">${currencyUtils.format(item.amount)}</span> </div>`).join('')} </div> </section>
                 <section class="mt-6 pt-4 border-t border-green-800 text-right"> <p class="text-sm text-green-200">Previous Balance: ${currencyUtils.format(receiptData.customer.currentDue)}</p> <p class="text-sm text-green-200">Amount Paid: -${currencyUtils.format(receiptData.amountPaid)}</p> <p class="text-lg font-bold text-white mt-1">New Outstanding Balance: <span class="font-mono">${currencyUtils.format(receiptData.newBalance)}</span></p> </section>
                 <footer class="mt-8 text-center text-xs text-green-400"> <p class="text-base font-semibold text-white">Thank you for your payment!</p> </footer>
                 <div class="mt-4 pt-4 border-t border-green-800/50 text-center text-[10px] text-green-400/50"> <p>Powered by CashShilpo</p> </div>
            </div>`;
        }
    }
};

          const showReceipt = (invoice, paymentState = null) => {
             // --- UPDATED: Ensure selectedReceiptTemplate exists before accessing it ---
             const templateKey = appState.settings.selectedReceiptTemplate;
             const template = receiptTemplates[templateKey] || receiptTemplates.modern; // Fallback to modern
             // --- END UPDATED ---
             const content = template.getBody(invoice, paymentState);
             
             // --- NEW: Change modal title for returns ---
             const isReturn = invoice.invoiceType === 'return';
             const modalTitle = isReturn ? 'Return Receipt / Credit Note' : 'Receipt / Invoice';
        
             const footer = `<button data-action="close-modal" class="btn btn-secondary">Close</button><button id="print-receipt" class="btn btn-primary"><i data-lucide="printer" class="w-4 h-4 mr-2"></i>Print</button>`;
             const modal = showModal(modalTitle, content, footer, {size: 'max-w-2xl', customClasses: 'p-0'}); // <-- UPDATED TITLE
             lucide.createIcons();
             modal.querySelector('#print-receipt').addEventListener('click', () => {
                 printElement('receipt-content');
             });
          };
          // This helper function might be used in multiple places now
           const _getTierColorClass = (tier) => {
               if (!tier || !tier.color) return 'bg-gray-500/20 text-gray-300 border border-gray-500/50';
               // Attempt to generate Tailwind-like classes dynamically.
               // NOTE: This relies on Tailwind JIT or having these colors defined.
               // A safer approach might be to store the full class string in the tier object.
               const colorName = tier.color.startsWith('#') ? 'custom' : tier.color.split('-')[0]; // Simple extraction
               const intensity = '500'; // Default intensity
               const textColor = `${colorName}-300`;
               const bgColor = `${colorName}-${intensity}/20`;
               const borderColor = `${colorName}-${intensity}/50`;
               // Construct the classes - use bracket notation for arbitrary values if needed
               return `bg-[${tier.color}]/20 text-[${tier.color}] border border-[${tier.color}]/50`;
           };
            function openAdminInviteStaffModal() {
                                // --- NEW LIMIT CHECK ---
                const currentStaffCount = firestoreData.staff.length;
                const staffLimit = firestoreData.storeInfo.planLimits?.staff || 5;

                if (currentStaffCount >= staffLimit) {
                    showToast(`You have reached your limit of ${staffLimit} staff members. Please upgrade your plan to add more.`, 'error');
                    showLimitReachedModal('staff', staffLimit);
                    return; // Stop the function
                }
                // --- END NEW LIMIT CHECK ---
                const currentUserRole = appState.session.userRole;
                const content = `
                    <form id="invite-staff-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium mb-1">Full Name</label><input type="text" name="name" class="form-input w-full" required></div>
                            <div><label class="block text-sm font-medium mb-1">Date of Birth</label><input type="date" name="dob" class="form-input w-full"></div>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium mb-1">Email</label><input type="email" name="email" class="form-input w-full" required></div>
                            <div><label class="block text-sm font-medium mb-1">Phone</label><input type="tel" name="phone" class="form-input w-full"></div>
                        </div>
                        <div><label class="block text-sm font-medium mb-1">Address</label><input type="text" name="address" class="form-input w-full"></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-border-color pt-4">
                            <div><label class="block text-sm font-medium mb-1">Emergency Contact Name</label><input type="text" name="emergencyContactName" class="form-input w-full"></div>
                            <div><label class="block text-sm font-medium mb-1">Emergency Contact Phone</label><input type="tel" name="emergencyContactPhone" class="form-input w-full"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-border-color pt-4">
                            <div><label class="block text-sm font-medium mb-1">Role</label>
                                <select name="role" class="form-select w-full">
                                    <option value="cashier">Cashier</option>
                                    ${currentUserRole === 'admin' ? `<option value="manager">Manager</option><option value="admin">Administrator</option>` : ''}
                                </select>
                            </div>
                            <div><label class="block text-sm font-medium mb-1">Password</label><input type="password" name="password" class="form-input w-full" required placeholder="Min. 6 characters"></div>
                        </div>
                        <p id="invite-error" class="text-red-400 text-sm hidden"></p>
                    </form>`;
                const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="invite-staff-form" class="btn btn-primary">Create Account</button>`;
                const modal = showModal('Invite New Staff Member', content, footer, { size: 'max-w-3xl' });
                
                modal.querySelector('#invite-staff-form').addEventListener('submit', async (ev) => {
                    ev.preventDefault();
                    const errorEl = modal.querySelector('#invite-error');
                    errorEl.classList.add('hidden');
                    
                    const tempApp = initializeApp(firebaseConfig, `temp-app-${Date.now()}`);
                    const tempAuth = getAuth(tempApp);

                    const name = ev.target.name.value;
                    const email = ev.target.email.value;
                    const password = ev.target.password.value;
                    const role = ev.target.role.value;

                    try {
                        const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
                        
                        // Use a batch to ensure both documents are created successfully
                        const batch = writeBatch(db);

                        // 1. Create the staff document inside the store
                        const newStaffRef = doc(staffRef, userCredential.user.uid);
                        batch.set(newStaffRef, { 
                            name, 
                            email, 
                            role, 
                            phone: ev.target.phone.value,
                            address: ev.target.address.value,
                            dob: ev.target.dob.value,
                            emergencyContactName: ev.target.emergencyContactName.value,
                            emergencyContactPhone: ev.target.emergencyContactPhone.value,
                            joinDate: new Date().toISOString(),
                            status: 'active'
                        });

                        // 2. Create the user profile document in the top-level 'users' collection
                        const newUserProfileRef = doc(usersRef, userCredential.user.uid);
                        // --- MODIFICATION START: Get the admin's current subscription ---
                        const adminSubscription = appState.session.userProfileData?.subscription || { status: 'trial' }; // Fallback just in case
                        // --- END MODIFICATION ---

                        batch.set(newUserProfileRef, {
                            stores: [{ id: appState.session.storeId, name: firestoreData.storeInfo.name }],
                            currentStoreId: appState.session.storeId,
                            // --- MODIFICATION START: Add the subscription object ---
                            subscription: adminSubscription
                            // --- END MODIFICATION ---
                        });

                        await batch.commit();
                        
                        showToast('Staff member created successfully!', 'success');
                        closeModal(modal);
                    } catch (error) {
                        console.error("Error inviting staff:", error);
                        errorEl.textContent = error.message.replace('Firebase: ', '');
                        errorEl.classList.remove('hidden');
                    } finally {
                        // No public API to delete temp app, will be garbage collected.
                    }
                });
            }

            function openManagerInviteCashierModal() {
                                // --- NEW LIMIT CHECK ---
                const currentStaffCount = firestoreData.staff.length;
                const staffLimit = firestoreData.storeInfo.planLimits?.staff || 5;

                if (currentStaffCount >= staffLimit) {
                    showToast(`You have reached your limit of ${staffLimit} staff members. Please upgrade your plan to add more.`, 'error');
                    showLimitReachedModal('staff', staffLimit);
                    return; // Stop the function
                }
                // --- END NEW LIMIT CHECK ---
                const content = `
                    <form id="invite-cashier-form" class="space-y-4">
                        <p class="text-sm text-text-secondary">You are inviting a new Cashier. This will require approval from an Administrator before they can log in.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium mb-1">Full Name</label><input type="text" name="name" class="form-input w-full" required></div>
                             <div><label class="block text-sm font-medium mb-1">Phone</label><input type="tel" name="phone" class="form-input w-full"></div>
                        </div>
                        <div><label class="block text-sm font-medium mb-1">Email</label><input type="email" name="email" class="form-input w-full" required></div>
                        <div><label class="block text-sm font-medium mb-1">Temporary Password</label><input type="password" name="password" class="form-input w-full" required placeholder="Min. 6 characters"></div>
                        <p id="invite-error" class="text-red-400 text-sm hidden"></p>
                    </form>`;
                const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="invite-cashier-form" class="btn btn-primary">Send Invitation</button>`;
                const modal = showModal('Invite New Cashier', content, footer, { size: 'max-w-2xl' });

                modal.querySelector('#invite-cashier-form').addEventListener('submit', async (ev) => {
                    ev.preventDefault();
                    const errorEl = modal.querySelector('#invite-error');
                    errorEl.classList.add('hidden');
                    
                    const tempApp = initializeApp(firebaseConfig, `temp-app-${Date.now()}`);
                    const tempAuth = getAuth(tempApp);

                    const name = ev.target.name.value;
                    const email = ev.target.email.value;
                    const password = ev.target.password.value;

                    try {
                        const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
                        
                        // Use a batch to ensure both documents are created successfully
                        const batch = writeBatch(db);

                        // 1. Create the staff document inside the store
                        const newStaffRef = doc(staffRef, userCredential.user.uid);
                        batch.set(newStaffRef, { 
                            name, 
                            email, 
                            role: 'cashier',
                            phone: ev.target.phone.value,
                            joinDate: new Date().toISOString(),
                            status: 'pending',
                            invitedBy: appState.session.currentUser.uid
                        });

                        // 2. Create the user profile document in the top-level 'users' collection
                        const newUserProfileRef = doc(usersRef, userCredential.user.uid);
                        // --- MODIFICATION START: Get the manager's (i.e., the store's) current subscription ---
                        const managerSubscription = appState.session.userProfileData?.subscription || { status: 'trial' }; // Fallback just in case
                        // --- END MODIFICATION ---

                        batch.set(newUserProfileRef, {
                            stores: [{ id: appState.session.storeId, name: firestoreData.storeInfo.name }],
                            currentStoreId: appState.session.storeId,
                            // --- MODIFICATION START: Add the subscription object ---
                            subscription: managerSubscription
                            // --- END MODIFICATION ---
                        });

                        await batch.commit();
                        
                        await createNotification('info', `Manager <strong>${appState.session.currentUser.name}</strong> has invited a new cashier, <strong>${name}</strong>, who requires approval.`, { targetRoles: ['admin'] });

                        showToast('Invitation sent for admin approval!', 'success');
                        closeModal(modal);
                    } catch (error) {
                        console.error("Error inviting cashier:", error);
                        errorEl.textContent = error.message.replace('Firebase: ', '');
                        errorEl.classList.remove('hidden');
                    }
                });
            }

            function openRequestDeactivationModal(staffId) {
                const member = firestoreData.staff.find(m => m.id === staffId);
                if (!member) return showToast('Staff member not found.', 'error');

                const content = `
                    <form id="request-deactivation-form" class="space-y-4">
                        <p>You are requesting to deactivate the account for <strong class="text-text-primary">${member.name}</strong>. Please provide a reason for this request. An administrator will review and approve or deny it.</p>
                        <div>
                            <label class="block text-sm font-medium mb-1">Reason for Deactivation</label>
                            <textarea name="reason" class="form-textarea w-full h-24" placeholder="e.g., End of contract, Performance issues..." required></textarea>
                        </div>
                        <p id="request-error" class="text-red-400 text-sm hidden"></p>
                    </form>
                `;
                const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="request-deactivation-form" class="btn btn-danger">Submit Request</button>`;
                const modal = showModal('Request Deactivation', content, footer);

                modal.querySelector('#request-deactivation-form').addEventListener('submit', async (ev) => {
                    ev.preventDefault();
                    const reason = ev.target.reason.value;
                    if (!reason.trim()) {
                        const errorEl = modal.querySelector('#request-error');
                        errorEl.textContent = 'A reason is required.';
                        errorEl.classList.remove('hidden');
                        return;
                    }

                    try {
                        const deactivationRequest = {
                            reason: reason,
                            requestedBy: appState.session.currentUser.uid,
                            requestedByName: appState.session.currentUser.name,
                            date: new Date().toISOString()
                        };

                        await updateDoc(doc(staffRef, staffId), {
                            status: 'deactivation_pending',
                            deactivationRequest: deactivationRequest
                        });
                        
                        await createNotification(
                            'warning',
                            `Manager <strong>${appState.session.currentUser.name}</strong> has requested to deactivate cashier <strong>${member.name}</strong>. Reason: ${reason}`,
                            { targetRoles: ['admin'] }
                        );

                        showToast('Deactivation request sent for admin approval.', 'success');
                        closeModal(modal);
                    } catch (error) {
                        console.error("Error requesting deactivation:", error);
                        showToast('Failed to send deactivation request.', 'error');
                    }
                });
            }

            function openViewStaffPerformanceModal(staffId) {
                const member = firestoreData.staff.find(m => m.id === staffId);
                if (!member) return showToast("Staff member not found.", "error");

                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                const relevantInvoices = firestoreData.invoices.filter(inv => inv.cashierId === staffId && new Date(inv.date) >= thirtyDaysAgo && inv.status !== 'Void');

                const totalSales = relevantInvoices.reduce((sum, inv) => sum + inv.totalInBaseCurrency, 0);
                const transactionCount = relevantInvoices.length;
                const avgSaleValue = transactionCount > 0 ? totalSales / transactionCount : 0;
                const itemsSold = relevantInvoices.flatMap(inv => inv.items).reduce((sum, item) => sum + (item.qty || 1), 0);

                const salesByDay = relevantInvoices.reduce((acc, inv) => {
                    const day = new Date(inv.date).toLocaleDateString([], { month: 'short', day: 'numeric' });
                    acc[day] = (acc[day] || 0) + inv.totalInBaseCurrency;
                    return acc;
                }, {});

                const content = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                            <div class="bg-bg-tertiary p-4 rounded-lg"><p class="text-xs text-text-secondary uppercase">Total Sales</p><p class="text-xl font-bold font-mono">${currencyUtils.format(totalSales)}</p></div>
                            <div class="bg-bg-tertiary p-4 rounded-lg"><p class="text-xs text-text-secondary uppercase">Transactions</p><p class="text-xl font-bold font-mono">${transactionCount}</p></div>
                            <div class="bg-bg-tertiary p-4 rounded-lg"><p class="text-xs text-text-secondary uppercase">Avg. Sale Value</p><p class="text-xl font-bold font-mono">${currencyUtils.format(avgSaleValue)}</p></div>
                            <div class="bg-bg-tertiary p-4 rounded-lg"><p class="text-xs text-text-secondary uppercase">Items Sold</p><p class="text-xl font-bold font-mono">${itemsSold}</p></div>
                        </div>
                        <div class="h-64"><canvas id="staff-sales-chart"></canvas></div>
                    </div>
                `;
                const modal = showModal(`Performance: ${member.name} (Last 30 Days)`, content, `<button data-action="close-modal" class="btn btn-secondary">Close</button>`, { size: 'max-w-3xl' });

                const ctx = modal.querySelector('#staff-sales-chart').getContext('2d');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: Object.keys(salesByDay),
                            datasets: [{
                                label: 'Sales',
                                data: Object.values(salesByDay),
                                borderColor: chartStyles.palettes.gentleOcean[0],
                                backgroundColor: chartStyles.createGradient(ctx, chartStyles.palettes.gentleOcean[0]),
                                tension: 0.3,
                                fill: true
                            }]
                        },
                        options: commonChartOptions(true)
                    });
                }
            }

            function openAdminEditStaffModal(staffId) {
                const member = firestoreData.staff.find(m => m.id === staffId);
                if (!member) return showToast("Staff member not found.", "error");

                const content = `
                    <form id="edit-staff-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium mb-1">Full Name</label><input type="text" name="name" value="${member.name || ''}" class="form-input w-full"></div>
                            <div><label class="block text-sm font-medium mb-1">Date of Birth</label><input type="date" name="dob" value="${member.dob || ''}" class="form-input w-full"></div>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium mb-1">Email</label><input type="email" value="${member.email}" class="form-input w-full bg-bg-tertiary" readonly></div>
                            <div><label class="block text-sm font-medium mb-1">Phone</label><input type="tel" name="phone" value="${member.phone || ''}" class="form-input w-full"></div>
                        </div>
                        <div><label class="block text-sm font-medium mb-1">Address</label><input type="text" name="address" value="${member.address || ''}" class="form-input w-full"></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-border-color pt-4">
                            <div><label class="block text-sm font-medium mb-1">Emergency Contact Name</label><input type="text" name="emergencyContactName" value="${member.emergencyContactName || ''}" class="form-input w-full"></div>
                            <div><label class="block text-sm font-medium mb-1">Emergency Contact Phone</label><input type="tel" name="emergencyContactPhone" value="${member.emergencyContactPhone || ''}" class="form-input w-full"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-border-color pt-4">
                            <div><label class="block text-sm font-medium mb-1">Role</label>
                                <select name="role" class="form-select w-full" ${member.role === 'admin' ? 'disabled' : ''}>
                                    <option value="cashier" ${member.role === 'cashier' ? 'selected' : ''}>Cashier</option>
                                    <option value="manager" ${member.role === 'manager' ? 'selected' : ''}>Manager</option>
                                </select>
                            </div>
                            <div><label class="block text-sm font-medium mb-1">Account Status</label>
                                <select name="status" class="form-select w-full">
                                    <option value="active" ${member.status === 'active' || !member.status ? 'selected' : ''}>Active</option>
                                    <option value="inactive" ${member.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                    <option value="pending" ${member.status === 'pending' ? 'selected' : ''}>Pending</option>
                                </select>
                            </div>
                        </div>
                    </form>`;
                const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="edit-staff-form" class="btn btn-primary">Save Changes</button>`;
                const modal = showModal('Edit Staff Member', content, footer, { size: 'max-w-3xl' });
                
                modal.querySelector('#edit-staff-form').addEventListener('submit', async (ev) => {
                    ev.preventDefault();
                    const formData = new FormData(ev.target);
                    try {
                        await updateDoc(doc(staffRef, staffId), { 
                            name: formData.get('name'),
                            dob: formData.get('dob'),
                            phone: formData.get('phone'),
                            address: formData.get('address'),
                            emergencyContactName: formData.get('emergencyContactName'),
                            emergencyContactPhone: formData.get('emergencyContactPhone'),
                            role: formData.get('role'), 
                            status: formData.get('status')
                        });
                        showToast(`${member.name}'s profile updated.`, 'success');
                        closeModal(modal);
                    } catch (error) {
                        console.error("Error updating staff profile:", error);
                        showToast(`Error: ${error.message}`, 'error');
                    }
                });
            }

            function openManagerEditStaffModal(staffId) {
                const member = firestoreData.staff.find(m => m.id === staffId);
                if (!member) return showToast("Staff member not found.", "error");

                const content = `
                    <form id="edit-staff-form-manager" class="space-y-4">
                         <p class="text-sm text-text-secondary">As a manager, you can update a cashier's contact and emergency information.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium mb-1">Full Name</label><input type="text" name="name" value="${member.name || ''}" class="form-input w-full"></div>
                             <div><label class="block text-sm font-medium mb-1">Phone</label><input type="tel" name="phone" value="${member.phone || ''}" class="form-input w-full"></div>
                        </div>
                        <div><label class="block text-sm font-medium mb-1">Address</label><input type="text" name="address" value="${member.address || ''}" class="form-input w-full"></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-border-color pt-4">
                            <div><label class="block text-sm font-medium mb-1">Emergency Contact Name</label><input type="text" name="emergencyContactName" value="${member.emergencyContactName || ''}" class="form-input w-full"></div>
                            <div><label class="block text-sm font-medium mb-1">Emergency Contact Phone</label><input type="tel" name="emergencyContactPhone" value="${member.emergencyContactPhone || ''}" class="form-input w-full"></div>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-border-color pt-4">
                            <div><label class="block text-sm font-medium mb-1">Email</label><input type="email" value="${member.email}" class="form-input w-full bg-bg-tertiary" readonly></div>
                            <div><label class="block text-sm font-medium mb-1">Role</label><input type="text" value="${member.role}" class="form-input w-full bg-bg-tertiary" readonly></div>
                         </div>
                    </form>`;
                const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="edit-staff-form-manager" class="btn btn-primary">Save Changes</button>`;
                const modal = showModal('Edit Cashier Details', content, footer, { size: 'max-w-2xl' });

                modal.querySelector('#edit-staff-form-manager').addEventListener('submit', async (ev) => {
                    ev.preventDefault();
                    const formData = new FormData(ev.target);
                    try {
                        await updateDoc(doc(staffRef, staffId), { 
                            name: formData.get('name'),
                            phone: formData.get('phone'),
                            address: formData.get('address'),
                            emergencyContactName: formData.get('emergencyContactName'),
                            emergencyContactPhone: formData.get('emergencyContactPhone'),
                        });
                        showToast(`${formData.get('name')}'s details have been updated.`, 'success');
                        closeModal(modal);
                    } catch (error) {
                        console.error("Error updating staff name:", error);
                        showToast(`Error: ${error.message}`, 'error');
                    }
                });
            }

            async function openAdminEditStaffModal(staffId) {
                const member = firestoreData.staff.find(m => m.id === staffId);
                if (!member) return showToast("Staff member not found.", "error");

                let userStores = [];
                let userProfileError = null;
                try {
                    const userProfileRef = doc(usersRef, staffId);
                    const userProfileSnap = await getDoc(userProfileRef);
                    if (userProfileSnap.exists()) {
                        userStores = userProfileSnap.data().stores || [];
                    } else {
                        console.warn(`User profile for staff ${staffId} not found in 'users' collection.`);
                        userStores = [{ id: appState.session.storeId, name: firestoreData.storeInfo.name }];
                    }
                } catch (error) {
                    console.error("Failed to fetch user profile for store access list:", error);
                    userProfileError = "Could not load store access list.";
                }

                let storeAccessHTML = '';
                if (member.role === 'manager') {
                    storeAccessHTML = `
                        <div class="border-t border-border-color pt-4 mt-4">
                            <h4 class="text-base font-semibold text-text-primary mb-2">Store Access</h4>
                            ${userProfileError ? `<p class="text-sm text-red-400">${userProfileError}</p>` : `
                            <div class="space-y-2 max-h-40 overflow-y-auto pr-2">
                                ${userStores.map(store => `
                                    <div class="flex items-center gap-2 p-2 bg-bg-tertiary rounded-md text-sm">
                                        <i data-lucide="store" class="w-4 h-4 text-text-secondary"></i>
                                        <span class="text-text-primary font-medium">${store.name}</span>
                                        <span class="text-xs text-text-secondary font-mono ml-auto">ID: ${store.id}</span>
                                    </div>
                                `).join('')}
                            </div>
                             <div class="grid grid-cols-2 gap-2 mt-3">
                                <button type="button" data-action="grant-store-access" data-id="${staffId}" class="btn btn-secondary w-full text-sm">
                                    <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i>Grant Access
                                </button>
                                <button type="button" data-action="remove-store-access" data-id="${staffId}" class="btn btn-danger-secondary w-full text-sm">
                                    <i data-lucide="minus-circle" class="w-4 h-4 mr-2"></i>Remove Access
                                </button>
                            </div>
                            `}
                        </div>
                    `;
                }

                const content = `
                    <form id="edit-staff-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium mb-1">Full Name</label><input type="text" name="name" value="${member.name || ''}" class="form-input w-full"></div>
                            <div><label class="block text-sm font-medium mb-1">Date of Birth</label><input type="date" name="dob" value="${member.dob || ''}" class="form-input w-full"></div>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium mb-1">Email</label><input type="email" value="${member.email}" class="form-input w-full bg-bg-tertiary" readonly></div>
                            <div><label class="block text-sm font-medium mb-1">Phone</label><input type="tel" name="phone" value="${member.phone || ''}" class="form-input w-full"></div>
                        </div>
                        <div><label class="block text-sm font-medium mb-1">Address</label><input type="text" name="address" value="${member.address || ''}" class="form-input w-full"></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-border-color pt-4">
                            <div><label class="block text-sm font-medium mb-1">Emergency Contact Name</label><input type="text" name="emergencyContactName" value="${member.emergencyContactName || ''}" class="form-input w-full"></div>
                            <div><label class="block text-sm font-medium mb-1">Emergency Contact Phone</label><input type="tel" name="emergencyContactPhone" value="${member.emergencyContactPhone || ''}" class="form-input w-full"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-border-color pt-4">
                            <div><label class="block text-sm font-medium mb-1">Role</label>
                                <select name="role" class="form-select w-full" ${member.role === 'admin' ? 'disabled' : ''}>
                                    <option value="cashier" ${member.role === 'cashier' ? 'selected' : ''}>Cashier</option>
                                    <option value="manager" ${member.role === 'manager' ? 'selected' : ''}>Manager</option>
                                </select>
                            </div>
                            <div><label class="block text-sm font-medium mb-1">Account Status</label>
                                <select name="status" class="form-select w-full">
                                    <option value="active" ${member.status === 'active' || !member.status ? 'selected' : ''}>Active</option>
                                    <option value="inactive" ${member.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                    <option value="pending" ${member.status === 'pending' ? 'selected' : ''}>Pending</option>
                                </select>
                            </div>
                        </div>
                    </form>
                    ${storeAccessHTML}
                    `;
                const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="edit-staff-form" class="btn btn-primary">Save Changes</button>`;
                const modal = showModal('Edit Staff Member', content, footer, { size: 'max-w-3xl' });
                lucide.createIcons();
                
                const grantAccessBtn = modal.querySelector('[data-action="grant-store-access"]');
                if (grantAccessBtn) {
                    grantAccessBtn.addEventListener('click', () => {
                        closeModal(modal);
                        openGrantStoreAccessModal(staffId, member.name, userStores);
                    });
                }
                const removeAccessBtn = modal.querySelector('[data-action="remove-store-access"]');
                if (removeAccessBtn) {
                    removeAccessBtn.addEventListener('click', () => {
                        closeModal(modal);
                        openRemoveStoreAccessModal(staffId, member.name, userStores);
                    });
                }
                
                modal.querySelector('#edit-staff-form').addEventListener('submit', async (ev) => {
                    ev.preventDefault();
                    const formData = new FormData(ev.target);
                    const updates = { 
                        name: formData.get('name'),
                        dob: formData.get('dob'),
                        phone: formData.get('phone'),
                        address: formData.get('address'),
                        emergencyContactName: formData.get('emergencyContactName'),
                        emergencyContactPhone: formData.get('emergencyContactPhone'),
                        role: formData.get('role') || member.role, // Preserve admin role if field is disabled
                        status: formData.get('status')
                    };
                    try {
                        const isEditingSelfAsAdmin = member.role === 'admin' && staffId === auth.currentUser.uid;
                        const isEditingManager = member.role === 'manager';

                        if (isEditingSelfAsAdmin) {
                            // Admins are global. Sync all changes, including status, across all stores.
                            console.log(`[Profile Sync] Syncing admin profile for ${member.name} across all associated stores.`);
                            const batch = writeBatch(db);
                            const userProfileRef = doc(usersRef, staffId);
                            const userProfileSnap = await getDoc(userProfileRef);

                            if (userProfileSnap.exists()) {
                                const userStores = userProfileSnap.data().stores || [];
                                userStores.forEach(store => {
                                    const storeStaffRef = doc(db, 'stores', store.id, 'staff', staffId);
                                    batch.update(storeStaffRef, updates);
                                });
                                await batch.commit();
                            } else {
                                console.warn(`[Profile Sync] Could not find user profile for admin ${staffId}. Updating current store only.`);
                                await updateDoc(doc(staffRef, staffId), updates);
                            }
                        } else if (isEditingManager) {
                            // Managers have global profile info but store-specific status.
                            console.log(`[Profile Sync] Syncing manager profile for ${member.name}. Status is store-specific.`);
                            
                            // Separate the status from other profile updates.
                            const { status, ...globalUpdates } = updates;

                            const batch = writeBatch(db);
                            const userProfileRef = doc(usersRef, staffId);
                            const userProfileSnap = await getDoc(userProfileRef);

                            if (userProfileSnap.exists()) {
                                const userStores = userProfileSnap.data().stores || [];
                                
                                // 1. Apply global profile updates to all stores the manager belongs to.
                                userStores.forEach(store => {
                                    const storeStaffRef = doc(db, 'stores', store.id, 'staff', staffId);
                                    batch.update(storeStaffRef, globalUpdates);
                                });

                                // 2. Apply the status update ONLY to the current store.
                                // The `staffRef` variable is already scoped to the current active store.
                                const currentStoreStaffRef = doc(staffRef, staffId);
                                batch.update(currentStoreStaffRef, { status: status });
                                
                                await batch.commit();

                            } else {
                                console.warn(`[Profile Sync] Could not find user profile for manager ${staffId}. Updating current store only.`);
                                await updateDoc(doc(staffRef, staffId), updates); // Fallback to updating just the current store with all data.
                            }
                        } else {
                            // Logic for editing other staff members (e.g., cashiers), which is always store-specific.
                            await updateDoc(doc(staffRef, staffId), updates);
                        }

                        // If the logged-in user is editing their own profile, update the session state
                        if (appState.session.currentUser && appState.session.currentUser.uid === staffId) {
                            appState.session.currentUser = { ...appState.session.currentUser, ...updates };
                            appState.session.userRole = updates.role; // Explicitly update the session role
                            updateUIPermissions();
                        }
                        
                        showToast(`${member.name}'s profile updated.`, 'success');
                        closeModal(modal);
                    } catch (error) {
                        console.error("Error updating staff profile:", error);
                        showToast(`Error: ${error.message}`, 'error');
                    }
                });
            }

            async function openGrantStoreAccessModal(staffId, staffName, userStores) {
                const adminStores = appState.session.availableStores;
                const currentStoreIds = userStores.map(s => s.id);
                const grantableStores = adminStores.filter(store => !currentStoreIds.includes(store.id));

                if (grantableStores.length === 0) {
                    showToast(`There are no other stores to grant access to.`, 'info');
                    return;
                }

                const content = `
                    <form id="grant-access-form" class="space-y-4">
                        <p class="text-sm text-text-secondary">Select which store(s) you want to grant access to for <strong class="text-text-primary">${staffName}</strong>. They will be added as a 'Cashier' by default.</p>
                        <div class="space-y-2 max-h-60 overflow-y-auto p-2 bg-bg-tertiary rounded-lg">
                            ${grantableStores.map(store => `
                                <label class="flex items-center p-2 rounded-md hover:bg-bg-secondary cursor-pointer">
                                    <input type="checkbox" name="storeIds" value="${store.id}" class="form-checkbox h-4 w-4 rounded mr-3">
                                    <div>
                                        <p class="text-text-primary font-medium">${store.name}</p>
                                        <p class="text-xs text-text-secondary font-mono">${store.id}</p>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                    </form>
                `;
                const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="grant-access-form" class="btn btn-primary">Grant Access</button>`;
                const modal = showModal(`Grant Store Access`, content, footer);

                modal.querySelector('#grant-access-form').addEventListener('submit', async (ev) => {
                    ev.preventDefault();
                    const formData = new FormData(ev.target);
                    const selectedStoreIds = formData.getAll('storeIds');

                    if (selectedStoreIds.length === 0) {
                        showToast('Please select at least one store.', 'error');
                        return;
                    }
                    
                    closeModal(modal);
                    showToast(`Granting access to ${selectedStoreIds.length} store(s)...`, 'info');

                    try {
                        const member = firestoreData.staff.find(m => m.id === staffId);
                        if (!member) throw new Error("Staff member data not found locally.");

                        const batch = writeBatch(db);
                        
                        const userProfileRef = doc(usersRef, staffId);
                        const newStoresToAdd = grantableStores.filter(s => selectedStoreIds.includes(s.id));
                        const userProfileUpdate = {
                            stores: [...userStores, ...newStoresToAdd]
                        };
                        batch.update(userProfileRef, userProfileUpdate);

                        newStoresToAdd.forEach(store => {
                            const newStaffDocRef = doc(db, 'stores', store.id, 'staff', staffId);
                            // BUG FIX: The original code incorrectly set the role to 'cashier' and didn't copy all profile data.
                            // This corrected version copies the member's actual role and all their relevant personal details.
                            // Performance data like sales are store-specific and are correctly NOT copied.
                            batch.set(newStaffDocRef, {
                                name: member.name,
                                email: member.email,
                                role: member.role, // FIX: Use the member's existing role instead of hardcoding 'cashier'
                                status: 'active',
                                joinDate: new Date().toISOString(),
                                // FIX: Add all other relevant profile fields from the original store profile
                                phone: member.phone || null,
                                address: member.address || null,
                                dob: member.dob || null,
                                emergencyContactName: member.emergencyContactName || null,
                                emergencyContactPhone: member.emergencyContactPhone || null
                            });
                        });
                        
                        await batch.commit();
                        showToast(`${staffName} has been granted access to ${selectedStoreIds.length} new store(s).`, 'success');

                    } catch (error) {
                        console.error("Failed to grant store access:", error);
                        showToast("An error occurred while granting access.", "error");
                    }
                });
            }


            async function openRemoveStoreAccessModal(staffId, staffName, userStores) {
                if (userStores.length <= 1) {
                    showToast(`${staffName} only has access to one store. To remove access, deactivate or delete their account.`, 'warning');
                    return;
                }

                const content = `
                    <form id="remove-access-form" class="space-y-4">
                        <p class="text-sm text-text-secondary">Select the store from which you want to remove access for <strong class="text-text-primary">${staffName}</strong>. This is a permanent action for that store.</p>
                        <div class="space-y-2 max-h-60 overflow-y-auto p-2 bg-bg-tertiary rounded-lg">
                            ${userStores.map(store => `
                                <label class="flex items-center p-2 rounded-md hover:bg-bg-secondary cursor-pointer">
                                    <input type="radio" name="storeId" value="${store.id}" class="form-radio h-4 w-4 mr-3 text-accent focus:ring-accent">
                                    <div>
                                        <p class="text-text-primary font-medium">${store.name}</p>
                                        <p class="text-xs text-text-secondary font-mono">${store.id}</p>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                    </form>
                `;
                const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="remove-access-form" class="btn btn-danger">Confirm Removal</button>`;
                const modal = showModal('Remove Store Access', content, footer);

                modal.querySelector('#remove-access-form').addEventListener('submit', async (ev) => {
                    ev.preventDefault();
                    const formData = new FormData(ev.target);
                    const storeIdToRemove = formData.get('storeId');

                    if (!storeIdToRemove) {
                        showToast('Please select a store to remove.', 'error');
                        return;
                    }
                    
                    closeModal(modal);
                    showToast(`Removing access from store...`, 'info');

                    try {
                        const batch = writeBatch(db);
                        
                        // 1. Delete the staff document from the specified store
                        const staffDocToRemoveRef = doc(db, 'stores', storeIdToRemove, 'staff', staffId);
                        batch.delete(staffDocToRemoveRef);
                        
                        // 2. Update the user's top-level profile to remove the store from their list
                        const userProfileRef = doc(usersRef, staffId);
                        const updatedStores = userStores.filter(s => s.id !== storeIdToRemove);
                        const userProfileUpdate = { stores: updatedStores };
                        
                        // If the store being removed is their current store, switch them to another one.
                        const userProfileSnap = await getDoc(userProfileRef);
                        if (userProfileSnap.exists() && userProfileSnap.data().currentStoreId === storeIdToRemove) {
                            userProfileUpdate.currentStoreId = updatedStores[0]?.id || null;
                        }
                        batch.update(userProfileRef, userProfileUpdate);

                        await batch.commit();
                        showToast(`${staffName}'s access has been removed from the selected store.`, 'success');

                    } catch (error) {
                        console.error("Failed to remove store access:", error);
                        showToast("An error occurred while removing access.", "error");
                    }
                });
            }

            // --- FIX: Comprehensive Keyboard Shortcut Handler ---
            window.addEventListener('keydown', e => {
                // Don't trigger shortcuts if the user is typing in an input, unless it's a special key like Escape.
                const activeEl = document.activeElement;
                const isTyping = activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.isContentEditable);

                // Global Escape handler for modals and menus
                if (e.key === 'Escape') {
                    // Find the topmost open modal or action menu and close it.
                    const openMenus = document.querySelectorAll('.action-menu.open');
                    if (openMenus.length > 0) {
                        openMenus[openMenus.length - 1].classList.remove('open', 'open-up');
                        e.preventDefault();
                        return;
                    }
                    const openModals = document.querySelectorAll('.modal-overlay');
                    if (openModals.length > 0) {
                        closeModal(openModals[openModals.length - 1]);
                        e.preventDefault();
                        return;
                    }
                    return; // Allow escape to work as default if nothing is open
                }

                // Handle '?' shortcut specifically: only trigger if NOT typing.
                if (e.key === '?') {
                    if (!isTyping) {
                        e.preventDefault(); // Prevent '?' from appearing anywhere else
                        showShortcutsModal();
                    }
                    // If the user IS typing, we do nothing, allowing the '?' to be entered into the input.
                    return; // Exit handler after dealing with '?'
                }

                // For all other shortcuts, if the user is typing without a modifier, ignore the keypress.
                if (isTyping && !e.ctrlKey && !e.metaKey && !e.altKey) {
                    return;
                }
                
                // --- Global Shortcuts ---
                if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'k') {
                    e.preventDefault();
                    document.querySelector('[data-action="open-search"]').click();
                    return;
                }
                
                if (e.altKey && e.key.toLowerCase() === 'q') {
                    e.preventDefault();
                    document.getElementById('ai-assistant-btn').click();
                    return;
                }

                if (e.altKey && e.key.toLowerCase() === 'w') {
                    e.preventDefault();
                    if (appState.tabs.length > 0) {
                        const modal = showModal(
                            'Close All Tabs',
                            `<p>Are you sure you want to close all ${appState.tabs.length} open tabs?</p>`,
                            `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-close-all" class="btn btn-danger">Yes, Close All</button>`
                        );
                        modal.querySelector('#confirm-close-all').addEventListener('click', () => {
                            appState.tabs = [];
                            appState.activeTabId = null;
                            closeModal(modal);
                            // After closing all, open the dashboard as a default view
                            openOrSwitchTab('dashboard'); 
                        });
                    }
                    return;
                }

                // --- Navigation Shortcuts ---
                if (e.altKey) {
                    let viewToOpen = null;
                    switch(e.key.toLowerCase()) {
                        case 'd': viewToOpen = 'dashboard'; break;
                        case 'p': viewToOpen = 'pos'; break;
                        case 'i': viewToOpen = 'invoices'; break;
                        case 'n': viewToOpen = 'inventory'; break;
                        case 'c': viewToOpen = 'customers'; break;
                        case 'r': viewToOpen = 'reports'; break;
                        case 's': viewToOpen = 'settings'; break;
                        case 'u': viewToOpen = 'user-roles'; break;
                        case 't': viewToOpen = 'staff'; break;
                        case 'e': viewToOpen = 'expenses'; break;
                        case 'l': viewToOpen = 'suppliers'; break;
                        case 'o': viewToOpen = 'purchase-orders'; break;
                        case 'b': viewToOpen = 'barcode-generator'; break;
                    }
                    if (viewToOpen) {
                        e.preventDefault();
                        openOrSwitchTab(viewToOpen);
                        return;
                    }
                }

                // --- Context-Dependent Shortcuts ---
                const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
                if (!activeTab) return;

                if (activeTab.viewType === 'pos') {
                    if ((e.key === 'F2' || ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'i'))) {
                        e.preventDefault();
                        const posSearchInput = document.querySelector('#pos-search, #pos-modern-search');
                        if (posSearchInput) posSearchInput.focus();
                        return;
                    }
                    if ((e.key === 'F4' || ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'p'))) {
                        e.preventDefault();
                        const paymentBtn = document.querySelector('[data-action="process-payment"]');
                        if(paymentBtn && !paymentBtn.disabled) paymentBtn.click();
                        return;
                    }
                    if (e.altKey && e.key.toLowerCase() === 'a') {
                        e.preventDefault();
                        const addCustomerBtn = document.querySelector('[data-action="add-customer-to-sale"]');
                        if (addCustomerBtn) addCustomerBtn.click();
                        return;
                    }
                }

                // --- Save Forms ---
                if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 's') {
                    const openModal = document.querySelector('.modal-overlay:not(.opacity-0)');
                    if (openModal) {
                        const form = openModal.querySelector('form');
                        if (form) {
                            e.preventDefault();
                            // Find the submit button for that form
                            const submitBtn = openModal.querySelector('button[type="submit"]');
                            if (submitBtn && !submitBtn.disabled) {
                                submitBtn.click();
                            }
                        }
                    } else if (activeTab.viewType === 'settings') {
                         e.preventDefault();
                         const saveSettingsBtn = document.querySelector('[data-action="save-settings"]');
                         if (saveSettingsBtn && !saveSettingsBtn.disabled) {
                             saveSettingsBtn.click();
                         }
                    }
                }
            });
            /**
 * Main initializer for the Warranty & Claims view.
 * @param {HTMLElement} container The main container element for the view.
 */
function initClaims(container) {
    if (!container) return;

    // Make sure container has no old listeners
    const newContainer = container.cloneNode(false);
    if (container.parentNode) {
        container.parentNode.replaceChild(newContainer, container);
    }
    container = newContainer;

    // View state for this tab
    const viewState = appState.viewStates.claims;
    if (!viewState.activeTab) {
        viewState.activeTab = 'warranties'; // Default to warranties tab
    }
    if (!viewState.filters) {
        viewState.filters = { status: 'all', policy: 'all' };
    }
    if (viewState.searchQuery === undefined) {
        viewState.searchQuery = '';
    }

    // --- START MODIFICATION: Split render functions to prevent input focus loss ---

    // This function updates only the dynamic parts of the warranties table
    const _updateWarrantiesTable = () => {
        const contentContainer = container.querySelector('#claims-tab-content');
        if (!contentContainer) return;

        let filteredWarranties = firestoreData.warranties;
        if (viewState.searchQuery) {
            const query = viewState.searchQuery.toLowerCase();
            filteredWarranties = filteredWarranties.filter(w => 
                w.productName.toLowerCase().includes(query) ||
                w.serialNumber.toLowerCase().includes(query) ||
                w.customerName.toLowerCase().includes(query)
            );
        }
        if (viewState.filters.policy && viewState.filters.policy !== 'all') {
            filteredWarranties = filteredWarranties.filter(w => w.policyId === viewState.filters.policy);
        }
        
        const totalItems = filteredWarranties.length;
        const startIndex = (viewState.currentPage - 1) * appState.itemsPerPage;
        const paginatedWarranties = filteredWarranties
            .sort((a,b) => new Date(b.startDate) - new Date(a.startDate))
            .slice(startIndex, startIndex + appState.itemsPerPage);

        const tableBody = contentContainer.querySelector('#warranties-table-body');
        if (tableBody) {
            tableBody.innerHTML = paginatedWarranties.length ? paginatedWarranties.map(w => `
                <tr class="table-row">
                    <td>
                        <p class="font-medium text-text-primary">${w.productName}</p>
                        <p class="text-xs text-text-secondary font-mono">${w.serialNumber}</p>
                    </td>
                    <td>${w.customerName}</td>
                    <td>${w.policyName}</td>
                    <td>${new Date(w.expiryDate).toLocaleDateString()}</td>
                    <td class="text-right">
                        <button data-action="create-claim" data-warranty-id="${w.id}" class="btn btn-primary btn-sm"><i data-lucide="shield-plus" class="w-4 h-4 mr-2"></i>New Claim</button>
                    </td>
                </tr>
            `).join('') : `<tr><td colspan="5" class="text-center p-8">No active warranties found matching your criteria.</td></tr>`;
        }
        renderPaginationControls(contentContainer.querySelector('#claims-pagination'), totalItems, viewState.currentPage, appState.itemsPerPage, 'claims');
        lucide.createIcons();
    };

    // This function updates only the dynamic parts of the claims table
    const _updateClaimsTable = () => {
        const contentContainer = container.querySelector('#claims-tab-content');
        if (!contentContainer) return;

        let filteredClaims = firestoreData.claims;
        if (viewState.searchQuery) {
            const query = viewState.searchQuery.toLowerCase();
            filteredClaims = filteredClaims.filter(c => 
                c.id.toLowerCase().includes(query) ||
                c.productName.toLowerCase().includes(query) ||
                c.serialNumber.toLowerCase().includes(query) ||
                c.customerName.toLowerCase().includes(query)
            );
        }
        if (viewState.filters.status && viewState.filters.status !== 'all') {
            filteredClaims = filteredClaims.filter(c => c.status === viewState.filters.status);
        }

        const totalItems = filteredClaims.length;
        const startIndex = (viewState.currentPage - 1) * appState.itemsPerPage;
        const paginatedClaims = filteredClaims
            .sort((a,b) => new Date(b.claimDate) - new Date(a.claimDate))
            .slice(startIndex, startIndex + appState.itemsPerPage);
        
        const getStatusBadge = (status) => {
            const base = "px-2 py-1 text-xs font-semibold rounded-full";
            switch (status) { case 'Pending': return `${base} bg-yellow-500/20 text-yellow-300`; case 'Approved': return `${base} bg-blue-500/20 text-blue-300`; case 'Rejected': return `${base} bg-red-500/20 text-red-300`; case 'Completed': return `${base} bg-green-500/20 text-green-300`; default: return `${base} bg-gray-500/20 text-gray-300`; }
        };

        const tableBody = contentContainer.querySelector('#claims-table-body');
        if (tableBody) {
            tableBody.innerHTML = paginatedClaims.length ? paginatedClaims.map(c => `
                <tr class="table-row">
                    <td class="font-mono text-xs">${c.id}</td>
                    <td>${c.productName}<br><span class="text-xs text-text-secondary font-mono">${c.serialNumber}</span></td>
                    <td>${c.customerName}</td>
                    <td>${new Date(c.claimDate).toLocaleDateString()}</td>
                    <td><span class="${getStatusBadge(c.status)}">${c.status}</span></td>
                    <td class="text-right">
                        <button data-action="view-claim" data-id="${c.id}" class="btn btn-secondary btn-sm"><i data-lucide="eye" class="w-4 h-4 mr-2"></i>Details</button>
                    </td>
                </tr>
            `).join('') : `<tr><td colspan="6" class="text-center p-8">No claims found matching your criteria.</td></tr>`;
        }
        renderPaginationControls(contentContainer.querySelector('#claims-pagination'), totalItems, viewState.currentPage, appState.itemsPerPage, 'claims');
        lucide.createIcons();
    };


    // --- Tab-Specific Render Functions ---
    const renderWarrantiesList = (contentContainer) => {
        const policies = appState.settings.warrantyPolicies || {};
        const policyOptions = Object.entries(policies).map(([id, policy]) => 
            `<option value="${id}" ${viewState.filters.policy === id ? 'selected' : ''}>${policy.name}</option>`
        ).join('');

        contentContainer.innerHTML = `
            <div class="space-y-4">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="relative flex-grow">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i>
                        <input type="text" id="warranty-search" placeholder="Search by product, serial, or customer..." class="form-input w-full pl-10" value="${viewState.searchQuery || ''}">
                    </div>
                    <select id="warranty-policy-filter" class="form-select md:w-64">
                        <option value="all">All Policies</option>
                        ${policyOptions}
                    </select>
                </div>

                <div class="bg-bg-secondary/50 rounded-xl">
                    <table class="table-pro">
                        <thead><tr><th>Product / Serial</th><th>Customer</th><th>Policy</th><th>Expires On</th><th>Actions</th></tr></thead>
                        <tbody id="warranties-table-body"></tbody>
                    </table>
                </div>
                <div id="claims-pagination" class="mt-4"></div>
            </div>`;
        _updateWarrantiesTable();
    };

    const renderClaimsList = (contentContainer) => {
        const statusOptions = ['Pending', 'Approved', 'Rejected', 'Completed'];

        contentContainer.innerHTML = `
            <div class="space-y-4">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="relative flex-grow">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i>
                        <input type="text" id="claim-search" placeholder="Search by ID, product, serial, customer..." class="form-input w-full pl-10" value="${viewState.searchQuery || ''}">
                    </div>
                    <select id="claim-status-filter" class="form-select md:w-64">
                        <option value="all">All Statuses</option>
                        ${statusOptions.map(s => `<option value="${s}" ${viewState.filters.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>
                </div>
                
                <div class="bg-bg-secondary/50 rounded-xl">
                    <table class="table-pro">
                        <thead><tr><th>Claim ID</th><th>Product</th><th>Customer</th><th>Claim Date</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="claims-table-body"></tbody>
                    </table>
                </div>
                <div id="claims-pagination" class="mt-4"></div>
            </div>`;
        _updateClaimsTable();
    };
    
    // --- END MODIFICATION ---

    const renderClaimsSettings = (contentContainer) => {
        const policies = appState.settings.warrantyPolicies || {
            'standard-1-year': { name: "Standard 1-Year", durationMonths: 12, description: "Covers manufacturing defects." }
        };
        contentContainer.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass-pane p-6 rounded-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-text-primary">Warranty Policies</h3>
                        <button data-action="add-policy" class="btn btn-primary btn-sm"><i data-lucide="plus" class="w-4 h-4 mr-2"></i>New Policy</button>
                    </div>
                    <div class="space-y-2">
                        ${Object.entries(policies).map(([id, policy]) => `
                            <div class="flex items-center justify-between p-3 bg-bg-secondary rounded-lg">
                                <div>
                                    <p class="font-medium text-text-primary">${policy.name}</p>
                                    <p class="text-xs text-text-secondary">${policy.durationMonths} months - ${policy.description || 'No description'}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button data-action="edit-policy" data-id="${id}" class="btn btn-secondary btn-sm p-2"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                    <button data-action="delete-policy" data-id="${id}" class="btn btn-danger-secondary btn-sm p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        `).join('')}
                        ${Object.keys(policies).length === 0 ? '<p class="text-sm text-center text-text-secondary p-4">No custom policies defined.</p>' : ''}
                    </div>
                </div>
            </div>
        `;
    };

    // --- Main Render Function ---
    const render = () => {
        container.innerHTML = `
            <div class="space-y-6">
                <!-- Header -->
                <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-text-primary">Warranty & Claims</h1>
                        <p class="text-text-secondary">Manage product warranties and process customer claims.</p>
                    </div>
                </div>
                <!-- Tabs -->
                <div class="border-b border-border-color flex space-x-4">
                    <button data-action="set-claims-tab" data-tab="warranties" class="form-tab ${viewState.activeTab === 'warranties' ? 'active' : ''} px-1 py-3 text-sm font-medium">Active Warranties</button>
                    <button data-action="set-claims-tab" data-tab="claims" class="form-tab ${viewState.activeTab === 'claims' ? 'active' : ''} px-1 py-3 text-sm font-medium">Claims</button>
                    ${checkPermission('canManageSettings') ? `<button data-action="set-claims-tab" data-tab="settings" class="form-tab ${viewState.activeTab === 'settings' ? 'active' : ''} px-1 py-3 text-sm font-medium">Settings</button>` : ''}
                </div>
                <!-- Tab Content -->
                <div id="claims-tab-content">
                    <!-- Dynamic content will be rendered here -->
                </div>
            </div>`;

        // Render the content for the active tab
        const tabContentContainer = container.querySelector('#claims-tab-content');
        switch (viewState.activeTab) {
            case 'claims':
                renderClaimsList(tabContentContainer);
                break;
            case 'settings':
                if (checkPermission('canManageSettings')) {
                    renderClaimsSettings(tabContentContainer);
                }
                break;
            case 'warranties':
            default:
                renderWarrantiesList(tabContentContainer);
                break;
        }

        lucide.createIcons();
    };

    // --- Event Delegation ---
    container.addEventListener('click', e => {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const { action, tab, id, warrantyId } = target.dataset;

        if (action === 'set-claims-tab') {
            viewState.activeTab = tab;
            viewState.currentPage = 1; // Reset page when switching tabs
            viewState.searchQuery = ''; // Reset search
            viewState.filters = { status: 'all', policy: 'all' }; // Reset filters
            render();
        }
        if (action === 'add-policy' || action === 'edit-policy') {
            openWarrantyPolicyModal(id);
        }
        if (action === 'delete-policy') {
            const policiesInUse = new Set(firestoreData.products.map(p => p.defaultWarrantyPolicyId));
            if (policiesInUse.has(id)) {
                showToast('Cannot delete policy. It is set as a default on one or more products.', 'error');
                return;
            }
            const modal = showModal('Delete Policy', `Are you sure you want to delete this policy? This cannot be undone.`, `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-delete-policy" class="btn btn-danger">Delete</button>`);
            modal.querySelector('#confirm-delete-policy').addEventListener('click', async () => {
                const updatedPolicies = { ...(appState.settings.warrantyPolicies || {}) };
                delete updatedPolicies[id];
                try {
                    await updateDoc(storeRef, { 'settings.warrantyPolicies': updatedPolicies });
                    showToast('Policy deleted.', 'success');
                    closeModal(modal);
                } catch (error) {
                    showToast('Failed to delete policy.', 'error');
                }
            });
        }
        if (action === 'create-claim') {
            openClaimModal(null, warrantyId);
        }
        if (action === 'view-claim') {
            openClaimModal(id);
        }
    });

    // --- MODIFICATION: Listeners now call the update functions ---
    container.addEventListener('input', e => {
        const target = e.target;
        if (target.id === 'warranty-search' || target.id === 'claim-search') {
            viewState.searchQuery = target.value;
            viewState.currentPage = 1;
            if (viewState.activeTab === 'warranties') {
                _updateWarrantiesTable();
            } else if (viewState.activeTab === 'claims') {
                _updateClaimsTable();
            }
        }
    });

    container.addEventListener('change', e => {
        const target = e.target;
        if (target.id === 'warranty-policy-filter') {
            viewState.filters.policy = target.value;
            viewState.currentPage = 1;
            _updateWarrantiesTable();
        }
        if (target.id === 'claim-status-filter') {
            viewState.filters.status = target.value;
            viewState.currentPage = 1;
            _updateClaimsTable();
        }
    });

    // Initial render
    render();
}
// --- END UPDATED FUNCTION ---

            /**
 * Opens a modal to create or view/edit a warranty claim.
 * @param {string|null} claimId The ID of the claim to edit/view, or null to create a new one.
 * @param {string|null} warrantyId The ID of the warranty to create a claim for.
 */
function initSubscription(pane) {
    if (!pane) return;

    // 1. Get User and Subscription Data
    const userProfile = appState.session.userProfileData;
    const subscription = userProfile?.subscription || {};
    const subscriptionCheck = checkSubscriptionStatus(userProfile);

    let statusText, statusColor, planName, expiryDate, daysRemaining, progressPercent;

    const trialEndsDate = subscription.trialEndsAt ? subscription.trialEndsAt.toDate() : null;
    const expiry = subscription.expiresAt ? subscription.expiresAt.toDate() : trialEndsDate;

    // 2. Determine Current Status and Plan Details
    if (subscriptionCheck.isValid) {
        if (subscription.status === 'trial') {
            statusText = 'Active Trial';
            statusColor = 'bg-yellow-500/20 text-yellow-300';
            planName = 'Trial Plan';
        } else {
            statusText = 'Active';
            statusColor = 'bg-green-500/20 text-green-300';
            planName = subscription.planId ? `${subscription.planId.charAt(0).toUpperCase() + subscription.planId.slice(1)} Plan` : 'Active Plan';
        }
        expiryDate = expiry ? expiry.toLocaleDateString() : 'N/A';
        const today = new Date();
        const timeDiff = expiry ? expiry.getTime() - today.getTime() : 0;
        daysRemaining = Math.max(0, Math.ceil(timeDiff / (1000 * 3600 * 24)));

        const startDate = userProfile.createdAt ? userProfile.createdAt.toDate() : new Date();
        const totalDuration = expiry ? expiry.getTime() - startDate.getTime() : 0;
        const elapsedDuration = today.getTime() - startDate.getTime();
        progressPercent = totalDuration > 0 ? Math.min(100, (elapsedDuration / totalDuration) * 100) : 0;

    } else {
        statusText = 'Expired';
        statusColor = 'bg-red-500/20 text-red-300';
        // --- FIX: Use subscriptionCheck.planId if available ---
        planName = subscription.planId ? `${subscription.planId.charAt(0).toUpperCase() + subscription.planId.slice(1)} Plan` : 'No Active Plan';
        expiryDate = expiry ? expiry.toLocaleDateString() : 'N/A';
        daysRemaining = 0;
        progressPercent = 100;
    }

    // 3. Define Plan Features for Comparison Table
    const plans = {
        trial: { name: 'Trial', price: 'Free', features: { 'basic_reporting': true, 'multi_user': false, 'priority_support': false, 'advanced_analytics': false } },
        monthly: { name: 'Monthly', price: '$5.99/mo', features: { 'basic_reporting': true, 'multi_user': true, 'priority_support': false, 'advanced_analytics': false } },
        yearly: { name: 'Yearly', price: '$59.99/yr', features: { 'basic_reporting': true, 'multi_user': true, 'priority_support': true, 'advanced_analytics': false } },
        premium: { name: 'Premium', price: '$99.99/yr', features: { 'basic_reporting': true, 'multi_user': true, 'priority_support': true, 'advanced_analytics': true } }
    };

    const featureDescriptions = {
        'basic_reporting': 'Standard Sales Reports',
        'multi_user': 'Invite Staff Members',
        'priority_support': 'Priority Customer Support',
        'advanced_analytics': 'AI Insights & Analytics'
    };

    // --- FIX: Get status and planId for the URL ---
    const subStatus = subscriptionCheck.status || (subscriptionCheck.isValid ? 'active' : 'expired');
    const subPlanId = subscription.planId || 'none';

    // 4. Construct the HTML for the View
    pane.innerHTML = `
        <div class="space-y-8 max-w-5xl mx-auto">
            <div>
                <h1 class="text-3xl font-bold text-text-primary">Subscription Management</h1>
                <p class="text-text-secondary mt-1">View your current plan, usage, and upgrade options.</p>
            </div>

            <!-- Current Plan Card -->
            <div class="glass-pane p-8 rounded-2xl grid grid-cols-1 md:grid-cols-3 gap-8 items-center">
                <div class="md:col-span-2">
                    <div class="flex items-center gap-4">
                        <span class="px-3 py-1 text-sm font-semibold rounded-full ${statusColor}">${statusText}</span>
                    </div>
                    <h2 class="text-4xl font-bold text-white mt-4">${planName}</h2>
                    <p class="text-text-secondary mt-1">
                        ${statusText === 'Expired' ? 'Your plan expired on' : 'Your plan renews on'} <strong class="text-text-primary">${expiryDate}</strong>
                    </p>
                    
                    <div class="mt-6">
                        <div class="w-full bg-bg-secondary rounded-full h-2.5">
                            <div class="bg-accent h-2.5 rounded-full" style="width: ${progressPercent}%"></div>
                        </div>
                        <p class="text-sm text-right text-text-secondary mt-2">${daysRemaining} days remaining</p>
                    </div>
                </div>
                <div class="text-center md:text-right">
                    <!-- FIX: Add status and planId to the URL -->
                    <a href="./renew-subscription.html?uid=${auth.currentUser.uid}&email=${auth.currentUser.email}&status=${subStatus}&planId=${subPlanId}" class="btn btn-primary text-base py-3 px-8 w-full md:w-auto">
                        <i data-lucide="zap" class="w-5 h-5 mr-2"></i>
                        ${subscriptionCheck.isValid ? 'Upgrade Plan' : 'Renew Subscription'}
                    </a>
                </div>
            </div>
        </div>
    `;

    // 5. Initialize Icons
    lucide.createIcons();
}

function openClaimModal(claimId = null, warrantyId = null) {
    const isEditing = !!claimId;
    let claim = isEditing ? firestoreData.claims.find(c => c.id === claimId) : {};
    const warranty = isEditing ? firestoreData.warranties.find(w => w.id === claim.warrantyId) : firestoreData.warranties.find(w => w.id === warrantyId);

    if (!warranty) {
        showToast('Associated warranty not found.', 'error');
        return;
    }

    const isViewingOnly = isEditing && !checkPermission('canManageWarranties');

    const content = `
        <form id="claim-form" class="space-y-4">
            <div class="grid grid-cols-2 gap-4 p-4 bg-bg-secondary rounded-lg">
                <div><p class="text-xs text-text-secondary">Product</p><p class="font-medium">${warranty.productName}</p></div>
                <div><p class="text-xs text-text-secondary">Serial Number</p><p class="font-mono text-sm">${warranty.serialNumber}</p></div>
                <div><p class="text-xs text-text-secondary">Customer</p><p class="font-medium">${warranty.customerName}</p></div>
                <div><p class="text-xs text-text-secondary">Warranty Expires</p><p class="font-medium">${new Date(warranty.expiryDate).toLocaleDateString()}</p></div>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Customer's Reported Issue</label>
                <textarea name="reportedIssue" class="form-textarea w-full h-24" ${isViewingOnly ? 'readonly' : ''} required>${claim.reportedIssue || ''}</textarea>
            </div>
            
            ${isEditing ? `
            <div class="border-t border-border-color pt-4 space-y-4">
                 <div>
                    <label class="block text-sm font-medium mb-1">Claim Status</label>
                    <select name="status" class="form-select w-full" ${!checkPermission('canManageWarranties') ? 'disabled' : ''}>
                        <option value="Pending" ${claim.status === 'Pending' ? 'selected' : ''}>Pending</option>
                        <option value="Approved" ${claim.status === 'Approved' ? 'selected' : ''}>Approved</option>
                        <option value="Rejected" ${claim.status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                        <option value="Completed" ${claim.status === 'Completed' ? 'selected' : ''}>Completed</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Internal Notes / Resolution</label>
                    <textarea name="resolutionNotes" class="form-textarea w-full h-24" ${!checkPermission('canManageWarranties') ? 'disabled' : ''}>${claim.resolutionNotes || ''}</textarea>
                </div>
            </div>
            ` : ''}
        </form>
    `;

    const footer = isViewingOnly
        ? `<button data-action="close-modal" class="btn btn-secondary">Close</button>`
        : `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="claim-form" class="btn btn-primary">${isEditing ? 'Update Claim' : 'Create Claim'}</button>`;

    const modal = showModal(isEditing ? `Claim Details #${claimId}` : 'New Warranty Claim', content, footer, { size: 'max-w-2xl' });

    modal.querySelector('#claim-form').addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        const claimData = {
            warrantyId: warranty.id,
            productId: warranty.productId,
            productName: warranty.productName,
            serialNumber: warranty.serialNumber,
            customerId: warranty.customerId,
            customerName: warranty.customerName,
            reportedIssue: formData.get('reportedIssue'),
            status: isEditing ? formData.get('status') : 'Pending',
            resolutionNotes: isEditing ? formData.get('resolutionNotes') : '',
        };

        try {
            if (isEditing) {
                claimData.updatedAt = new Date().toISOString();
                await updateDoc(doc(claimsRef, claimId), claimData);
                showToast('Claim updated successfully.', 'success');
            } else {
                claimData.claimDate = new Date().toISOString();
                claimData.filedBy = { id: appState.session.currentUser.uid, name: appState.session.currentUser.name };
                const newDocRef = doc(claimsRef); // Generate ref with new ID
                claimData.id = newDocRef.id; // Assign ID to the data
                await setDoc(newDocRef, claimData); // Set the document with its own ID
                
                await createNotification('warning', `New warranty claim filed by <strong>${claimData.filedBy.name}</strong> for <strong>${claimData.productName}</strong>.`, { targetRoles: ['admin', 'manager'] });
                showToast('New claim created successfully.', 'success');
            }
            closeModal(modal);
        } catch (error) {
            console.error('Failed to save claim:', error);
            showToast('Could not save the claim.', 'error');
        }
    });
}

function openWarrantyPolicyModal(policyId = null) {
    const isEditing = !!policyId;
    const policies = appState.settings.warrantyPolicies || {};
    const policy = isEditing ? policies[policyId] : {};

    const content = `
        <form id="policy-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1">Policy Name</label>
                <input type="text" name="name" value="${policy.name || ''}" class="form-input w-full" placeholder="e.g., 1-Year Limited Warranty" required>
            </div>
             <div>
                <label class="block text-sm font-medium mb-1">Duration (in Months)</label>
                <input type="number" name="durationMonths" value="${policy.durationMonths || ''}" class="form-input w-full" placeholder="e.g., 12" required>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Coverage Description</label>
                <textarea name="description" class="form-textarea w-full h-24" placeholder="e.g., Covers manufacturing defects. Does not cover accidental damage.">${policy.description || ''}</textarea>
            </div>
        </form>
    `;

    const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="policy-form" class="btn btn-primary">${isEditing ? 'Save Changes' : 'Create Policy'}</button>`;
    const modal = showModal(isEditing ? 'Edit Warranty Policy' : 'New Warranty Policy', content, footer);
    
    modal.querySelector('#policy-form').addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const newPolicyData = {
            name: formData.get('name'),
            durationMonths: parseInt(formData.get('durationMonths')),
            description: formData.get('description'),
        };

        if (!newPolicyData.name || isNaN(newPolicyData.durationMonths) || newPolicyData.durationMonths <= 0) {
            showToast('Please provide a valid name and duration.', 'error');
            return;
        }

        const newId = isEditing ? policyId : `policy_${Date.now()}`;
        const updatedPolicies = { ...policies, [newId]: newPolicyData };

        try {
            await updateDoc(storeRef, { 'settings.warrantyPolicies': updatedPolicies });
            showToast('Warranty policy saved successfully.', 'success');
            closeModal(modal);
        } catch(error) {
            console.error('Failed to save policy:', error);
            showToast('Could not save the policy.', 'error');
        }
    });
}
// --- QUOTATION MAIN VIEW ---

function initQuotations(container) {
    if (!container) return;
    
    // Clean up old listeners by replacing the container node
    const newContainer = container.cloneNode(false);
    if (container.parentNode) {
        container.parentNode.replaceChild(newContainer, container);
    }
    container = newContainer;

    const viewState = appState.viewStates.quotations;
    const canCreate = checkPermission('canManageQuotations');

    container.innerHTML = `
        <div class="space-y-6">
            <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-text-primary">Quotations</h1>
                    <p class="text-text-secondary">Create and manage price quotes for your customers.</p>
                </div>
                ${canCreate ? `<button data-action="add-quotation" class="btn btn-primary flex-shrink-0"><i data-lucide="plus" class="w-5 h-5 mr-2"></i> New Quotation</button>` : ''}
            </div>
            
            <div class="glass-pane p-4 rounded-xl flex flex-col md:flex-row gap-3">
                <div class="relative flex-grow">
                    <i data-lucide="search" class="absolute left-3.5 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i>
                    <input type="text" id="quotation-search" placeholder="Search by ID, customer name..." class="form-input w-full pl-11" value="${viewState.searchQuery}">
                </div>
                <select id="quotation-status-filter" class="form-select flex-shrink-0 md:w-48">
                    <option value="all" ${viewState.filters.status === 'all' ? 'selected' : ''}>All Statuses</option>
                    <option value="Draft" ${viewState.filters.status === 'Draft' ? 'selected' : ''}>Draft</option>
                    <option value="Sent" ${viewState.filters.status === 'Sent' ? 'selected' : ''}>Sent</option>
                    <option value="Accepted" ${viewState.filters.status === 'Accepted' ? 'selected' : ''}>Accepted</option>
                    <option value="Invoiced" ${viewState.filters.status === 'Invoiced' ? 'selected' : ''}>Invoiced</option>
                    <option value="Expired" ${viewState.filters.status === 'Expired' ? 'selected' : ''}>Expired</option>
                </select>
            </div>

            <div class="bg-bg-secondary/50 rounded-xl">
                <table class="table-pro">
                    <thead>
                        <tr>
                            <th>Quote #</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Expires On</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="quotations-table-body"></tbody>
                </table>
            </div>
            <div id="quotations-pagination" class="mt-4"></div>
        </div>`;

    renderQuotationsTable(container);

    container.addEventListener('input', e => {
        if (e.target.id === 'quotation-search') {
            viewState.searchQuery = e.target.value;
            viewState.currentPage = 1;
            renderQuotationsTable(container);
        }
    });

    container.addEventListener('change', e => {
        if (e.target.id === 'quotation-status-filter') {
            viewState.filters.status = e.target.value;
            viewState.currentPage = 1;
            renderQuotationsTable(container);
        }
    });

    lucide.createIcons();
}

function renderQuotationsTable(container) {
    const viewState = appState.viewStates.quotations;
    const canEdit = checkPermission('canManageQuotations');
    const canDelete = checkPermission('canDeleteQuotations');
    const canConvert = checkPermission('canConvertToInvoice');
    
    let filteredQuotations = [...firestoreData.quotations];

    // Apply filters
    if (viewState.searchQuery) {
        const query = viewState.searchQuery.toLowerCase();
        filteredQuotations = filteredQuotations.filter(q => 
            (q.quotationNumber || q.id).toLowerCase().includes(query) ||
            q.customerName.toLowerCase().includes(query)
        );
    }
    if (viewState.filters.status !== 'all') {
        filteredQuotations = filteredQuotations.filter(q => q.status === viewState.filters.status);
    }
    
    // Sort and paginate
    filteredQuotations.sort((a, b) => new Date(b.date) - new Date(a.date));
    const totalItems = filteredQuotations.length;
    const startIndex = (viewState.currentPage - 1) * appState.itemsPerPage;
    const paginatedQuotations = filteredQuotations.slice(startIndex, startIndex + appState.itemsPerPage);
    
    const getStatusBadge = (status) => {
        const base = "px-2 py-1 text-xs font-semibold rounded-full";
        switch (status) {
            case 'Draft': return `${base} bg-gray-500/20 text-gray-300`;
            case 'Sent': return `${base} bg-blue-500/20 text-blue-300`;
            case 'Accepted': return `${base} bg-green-500/20 text-green-300`;
            case 'Invoiced': return `${base} bg-indigo-500/20 text-indigo-300`;
            case 'Expired': return `${base} bg-red-500/20 text-red-300`;
            default: return `${base} bg-gray-500/20 text-gray-300`;
        }
    };

    const tableBody = container.querySelector('#quotations-table-body');
    tableBody.innerHTML = paginatedQuotations.length ? paginatedQuotations.map(q => {
        let actionMenuItems = [];
        actionMenuItems.push(`<div class="action-menu-item" data-action="view-quotation" data-id="${q.id}"><i data-lucide="eye" class="w-4 h-4"></i><span>View / Print</span></div>`);
        
        if (canEdit && q.status === 'Draft') {
             actionMenuItems.push(`<div class="action-menu-item" data-action="edit-quotation" data-id="${q.id}"><i data-lucide="edit" class="w-4 h-4"></i><span>Edit</span></div>`);
        }
        if (canConvert && (q.status === 'Sent' || q.status === 'Accepted' || q.status === 'Draft')) {
             actionMenuItems.push(`<div class="action-menu-item" data-action="convert-to-invoice" data-id="${q.id}"><i data-lucide="file-check-2" class="w-4 h-4"></i><span>Convert to Invoice</span></div>`);
        }
        if (canDelete && q.status === 'Draft') {
             actionMenuItems.push('<div class="h-px bg-border-color my-1"></div>');
             actionMenuItems.push(`<div class="action-menu-item danger" data-action="delete-quotation" data-id="${q.id}"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Delete</span></div>`);
        }

        return `
        <tr class="table-row" data-action="view-quotation" data-id="${q.id}">
            <td class="font-mono text-xs">${q.quotationNumber || q.id}</td>
            <td class="font-medium text-text-primary">${q.customerName}</td>
            <td>${new Date(q.date).toLocaleDateString()}</td>
            <td>${new Date(q.expiryDate).toLocaleDateString()}</td>
            <td class="font-mono">${currencyUtils.format(q.totalInBase)}</td>
            <td><span class="${getStatusBadge(q.status)}">${q.status}</span></td>
            <td class="text-right">
                <div class="relative inline-block text-left">
                    <button data-action="toggle-action-menu" class="p-2 rounded-md hover:bg-bg-tertiary">
                        <i data-lucide="more-vertical" class="w-5 h-5 pointer-events-none"></i>
                    </button>
                    <div class="action-menu">
                        ${actionMenuItems.join('')}
                    </div>
                </div>
            </td>
        </tr>`;
    }).join('') : `<tr><td colspan="7" class="text-center p-8 text-text-secondary">No quotations found.</td></tr>`;
    
    renderPaginationControls(container.querySelector('#quotations-pagination'), totalItems, viewState.currentPage, appState.itemsPerPage, 'quotations');
    lucide.createIcons();
}

// --- QUOTATION MODAL FUNCTIONS ---
function openQuoteVariantSelectorModal(parentProduct, onVariantsSelected) {
    const variants = firestoreData.products.filter(p => p.parentSKU === parentProduct.id);
    if (variants.length === 0) {
        showToast('This product has no variants defined.', 'error');
        return;
    }

    let selectedVariantIds = new Set();

    const content = `
        <p class="text-sm mb-4">Select variants of <strong>${parentProduct.name}</strong> to add to the quotation.</p>
        <div class="max-h-96 overflow-y-auto -mx-6">
            <table class="w-full text-sm">
                <thead class="sticky top-0 bg-bg-secondary z-10">
                    <tr class="text-left text-text-secondary uppercase text-xs">
                        <th class="px-6 py-3 w-12 text-center"><input type="checkbox" data-action="select-all-quote-variants" class="form-checkbox h-4 w-4 rounded text-accent focus:ring-accent"></th>
                        <th class="px-6 py-3 font-medium">Variant</th>
                        ${(parentProduct.variantAttributes || []).map(attr => `<th class="px-4 py-3 font-medium">${attr}</th>`).join('')}
                        <th class="px-4 py-3 font-medium text-right">Price</th>
                        <th class="px-4 py-3 font-medium text-center">Current Stock</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-border-color">
                ${variants.map(v => `
                    <tr data-id="${v.id}" class="quote-variant-row hover:bg-bg-tertiary cursor-pointer">
                        <td class="px-6 py-3 text-center"><input type="checkbox" data-id="${v.id}" class="form-checkbox h-4 w-4 rounded text-accent focus:ring-accent pointer-events-none"></td>
                        <td class="px-6 py-3 font-mono text-xs">${v.id}</td>
                        ${(parentProduct.variantAttributes || []).map(attr => `<td class="px-4 py-3">${v.variantOptions?.[attr] || '-'}</td>`).join('')}
                        <td class="px-4 py-3 text-right font-mono">${currencyUtils.format(v.price || 0)}</td>
                        <td class="px-4 py-3 text-center font-mono">${v.stock || 0}</td>
                    </tr>
                `).join('')}
                </tbody>
            </table>
        </div>
    `;

    const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="add-selected-variants-btn" class="btn btn-primary" disabled>Add Selected (0)</button>`;
    const modal = showModal('Select Variants', content, footer, { size: 'max-w-4xl', customClasses: 'p-0' });

    const addBtn = modal.querySelector('#add-selected-variants-btn');
    const tableBody = modal.querySelector('tbody');
    const selectAllCheckbox = modal.querySelector('[data-action="select-all-quote-variants"]');

    const updateAddButtonState = () => {
        if (selectedVariantIds.size > 0) {
            addBtn.disabled = false;
            addBtn.textContent = `Add Selected (${selectedVariantIds.size})`;
        } else {
            addBtn.disabled = true;
            addBtn.textContent = 'Add Selected (0)';
        }
    };

    tableBody.addEventListener('click', e => {
        const row = e.target.closest('.quote-variant-row');
        if (row) {
            const checkbox = row.querySelector('input[type="checkbox"]');
            const variantId = row.dataset.id;
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                selectedVariantIds.add(variantId);
                row.classList.add('bg-blue-900/50');
            } else {
                selectedVariantIds.delete(variantId);
                row.classList.remove('bg-blue-900/50');
            }
            
            const allCheckboxes = tableBody.querySelectorAll('input[type="checkbox"]');
            selectAllCheckbox.checked = Array.from(allCheckboxes).every(cb => cb.checked);
            updateAddButtonState();
        }
    });

    selectAllCheckbox.addEventListener('change', e => {
        const isChecked = e.target.checked;
        tableBody.querySelectorAll('.quote-variant-row').forEach(row => {
            const checkbox = row.querySelector('input[type="checkbox"]');
            const variantId = row.dataset.id;
            checkbox.checked = isChecked;
            if (isChecked) {
                selectedVariantIds.add(variantId);
                row.classList.add('bg-blue-900/50');
            } else {
                selectedVariantIds.delete(variantId);
                row.classList.remove('bg-blue-900/50');
            }
        });
        updateAddButtonState();
    });

    addBtn.addEventListener('click', () => {
        const variantsToAdd = variants.filter(v => selectedVariantIds.has(v.id));
        onVariantsSelected(variantsToAdd);
        closeModal(modal);
    });
}


/**
 * [HELPER] Opens a modal to collect serial numbers when converting a quote to an invoice.
 * @param {Array} serializedItems Array of items from the quotation that require serial numbers.
 * @returns {Promise<object|null>} A promise that resolves with an object mapping productId to an array of serials, or null if cancelled.
 */
function openInvoiceSerialEntryModal(serializedItems) {
    return new Promise((resolve) => {
        const content = `
            <form id="invoice-serial-entry-form" class="space-y-4">
                <p class="text-sm text-text-secondary">To create the invoice, please select the serial numbers for the following items from your stock.</p>
                <div class="max-h-[60vh] overflow-y-auto -mx-6 px-6 space-y-4">
                    ${serializedItems.map(item => {
                        const product = firestoreData.products.find(p => p.id === item.productId);
                        const availableSerials = product?.serials || [];
                        return `
                        <div>
                            <label class="block text-sm font-medium mb-2">${item.name} (Select ${item.quantity})</label>
                            <div class="space-y-1 p-2 bg-bg-tertiary rounded-lg border border-border-color max-h-48 overflow-y-auto">
                                <!-- Select All Checkbox -->
                                <label class="flex items-center p-2 rounded-md hover:bg-bg-secondary cursor-pointer font-semibold border-b border-border-color mb-1">
                                    <input type="checkbox" data-action="select-all-serials-for-item" data-product-id="${item.productId}" class="form-checkbox h-4 w-4 rounded mr-3 text-accent focus:ring-accent">
                                    Select All Available
                                </label>
                                <!-- Individual Serial Checkboxes -->
                                ${availableSerials.map(sn => `
                                    <label class="flex items-center p-2 rounded-md hover:bg-bg-secondary cursor-pointer">
                                        <input type="checkbox" name="serials_${item.productId}" value="${sn}" class="form-checkbox h-4 w-4 rounded mr-3 text-accent focus:ring-accent">
                                        <span class="font-mono text-sm">${sn}</span>
                                    </label>
                                `).join('')}
                            </div>
                            <p class="text-xs text-text-secondary mt-1 text-right">Selected: <span id="serial-count-${item.productId}">0</span> / ${item.quantity}</p>
                        </div>
                        `;
                    }).join('')}
                </div>
            </form>`;
        const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="invoice-serial-entry-form" class="btn btn-primary">Confirm Serials & Create Invoice</button>`;
        const modal = showModal('Select Serial Numbers', content, footer, { size: 'max-w-xl' });

        // Use event delegation on the modal for better performance
        modal.addEventListener('change', e => {
            const target = e.target;
            
            // Handle "Select All" checkbox
            if (target.matches('[data-action="select-all-serials-for-item"]')) {
                const productId = target.dataset.productId;
                const isChecked = target.checked;
                const itemCheckboxes = modal.querySelectorAll(`input[name="serials_${productId}"]`);
                itemCheckboxes.forEach(cb => cb.checked = isChecked);
                // Trigger a change on the first checkbox to update the count
                if (itemCheckboxes.length > 0) itemCheckboxes[0].dispatchEvent(new Event('change', { bubbles: true }));
            }
            
            // Handle individual checkboxes
            if (target.matches('input[name^="serials_"]')) {
                const productId = target.name.replace('serials_', '');
                const countSpan = modal.querySelector(`#serial-count-${productId}`);
                const parentP = countSpan.parentElement;

                // FIX: Read required quantity from the parent <p> element's full text content,
                // as the span's content only contains the count and causes an error on the first click.
                const requiredQty = parseInt(parentP.textContent.split('/')[1].trim());

                const selectedCheckboxes = modal.querySelectorAll(`input[name="serials_${productId}"]:checked`);
                
                // FIX: Only update the span with the new count, not the whole text string.
                countSpan.textContent = selectedCheckboxes.length;

                // Update "Select All" state
                const allItemCheckboxes = modal.querySelectorAll(`input[name="serials_${productId}"]`);
                const selectAllCheckbox = modal.querySelector(`[data-action="select-all-serials-for-item"][data-product-id="${productId}"]`);
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = selectedCheckboxes.length === allItemCheckboxes.length && allItemCheckboxes.length > 0;
                }
            }
        });

        modal.querySelector('#invoice-serial-entry-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const serialsData = {};
            let isValid = true;

            for (const item of serializedItems) {
                const checkboxes = modal.querySelectorAll(`input[name="serials_${item.productId}"]:checked`);
                const selectedSerials = Array.from(checkboxes).map(cb => cb.value);
                const requiredQty = item.quantity;

                if (selectedSerials.length !== requiredQty) {
                    showToast(`You must select exactly ${requiredQty} serial number(s) for ${item.name}.`, 'error');
                    isValid = false;
                    break;
                }
                serialsData[item.productId] = selectedSerials;
            }

            if (isValid) {
                closeModal(modal);
                resolve(serialsData);
            }
        });
        
        modal.querySelector('[data-action="close-modal"]').addEventListener('click', () => {
            closeModal(modal);
            resolve(null);
        });
    });
}


function viewQuotationModal(quotationId) {
    const q = firestoreData.quotations.find(q => q.id === quotationId);
    if (!q) return;

    const { storeInfo } = firestoreData;
    const customer = firestoreData.customers.find(c => c.id === q.customerId);
    const canConvert = checkPermission('canConvertToInvoice');
    const canEdit = checkPermission('canManageQuotations') && q.status === 'Draft';

    const content = `<div id="quotation-view-content" class="bg-white text-gray-800 font-sans p-10">
        <header class="flex justify-between items-start pb-6 border-b-2 border-gray-200">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">${storeInfo.name}</h1>
                <p class="text-xs text-gray-500">${storeInfo.address}<br>Ph: ${storeInfo.contact} | Web: ${storeInfo.website}<br>BIN: ${storeInfo.taxId}</p>
            </div>
            <div class="text-right">
                <h2 class="text-4xl font-extrabold text-gray-400 uppercase tracking-widest">Quotation</h2>
                <p class="text-sm font-mono text-gray-500">${q.quotationNumber || q.id}</p>
            </div>
        </header>
        <div class="grid grid-cols-2 gap-8 my-6 text-sm">
            <div>
                <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Quote For</h3>
                <p class="font-bold text-gray-900">${customer?.name || q.customerName}</p>
                <p class="text-gray-600">${customer?.address || ''}</p>
                <p class="text-gray-600">${customer?.email || ''}</p>
            </div>
            <div class="text-right">
                 <p><strong class="text-gray-500">Date Issued:</strong> ${new Date(q.date).toLocaleDateString()}</p>
                 <p><strong class="text-gray-500">Valid Until:</strong> ${new Date(q.expiryDate).toLocaleDateString()}</p>
            </div>
        </div>
        <table class="w-full text-sm">
            <thead class="bg-gray-100 text-gray-600"><tr class="text-left"><th class="py-2 px-4 font-bold">Item Description</th><th class="py-2 px-4 text-center font-bold">Qty</th><th class="py-2 px-4 text-right font-bold">Unit Price</th><th class="py-2 px-4 text-right font-bold">Total</th></tr></thead>
            <tbody>${q.items.map(item => `
                <tr class="border-b border-gray-100">
                    <td class="py-3 px-4"><p class="font-semibold text-gray-800">${item.name}</p><p class="text-xs text-gray-500 font-mono">${item.productId}</p></td>
                    <td class="py-3 px-4 text-center">${item.quantity}</td>
                    <td class="py-3 px-4 text-right font-mono">${currencyUtils.format(item.price)}</td>
                    <td class="py-3 px-4 text-right font-mono">${currencyUtils.format(item.quantity * item.price)}</td>
                </tr>
            `).join('')}</tbody>
        </table>
        <div class="flex justify-end mt-6">
            <div class="w-full max-w-sm space-y-2 text-sm">
                <div class="flex justify-between"><span class="text-gray-600">Subtotal:</span><span class="font-mono">${currencyUtils.format(q.subtotalInBase)}</span></div>
                <div class="flex justify-between"><span class="text-gray-600">Tax (${appState.settings.taxRate}%):</span><span class="font-mono">${currencyUtils.format(q.taxInBase)}</span></div>
                <div class="h-px bg-gray-200 my-2"></div>
                <div class="flex justify-between font-bold text-2xl text-gray-900"><span>Total:</span><span class="font-mono">${currencyUtils.format(q.totalInBase)}</span></div>
            </div>
        </div>
        ${q.notes ? `<div class="mt-6 border-t border-gray-200 pt-4"><h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Terms & Conditions</h4><p class="text-xs text-gray-600 whitespace-pre-wrap">${q.notes}</p></div>` : ''}
        <footer class="mt-10 text-center text-xs text-gray-400">Thank you for your business!</footer>
    </div>`;
    
    let footer = `<button data-action="close-modal" class="btn btn-secondary">Close</button><button data-action="print-po" class="btn btn-secondary"><i data-lucide="printer" class="w-4 h-4 mr-2"></i>Print</button>`;
    if (q.status === 'Draft' && canEdit) {
        footer += `<button data-action="mark-quotation-sent" data-id="${q.id}" class="btn btn-secondary"><i data-lucide="send" class="w-4 h-4 mr-2"></i>Mark as Sent</button>`;
    }
    if (canConvert && (q.status === 'Sent' || q.status === 'Accepted' || q.status === 'Draft')) {
        footer += `<button data-action="convert-to-invoice" data-id="${q.id}" class="btn btn-primary"><i data-lucide="file-check-2" class="w-4 h-4 mr-2"></i>Convert to Invoice</button>`;
    }

    const modal = showModal(`Quotation #${q.quotationNumber || q.id}`, content, footer, { size: 'max-w-4xl', customClasses: 'p-0' });
    modal.querySelector('[data-action="print-po"]').addEventListener('click', () => printElement('quotation-view-content'));
    lucide.createIcons();
}
async function openQuotationModal(quotationId = null) {
    const isEditing = !!quotationId;
    const quotation = isEditing ? firestoreData.quotations.find(q => q.id === quotationId) : null;
    
    if (isEditing && !quotation) {
        showToast('Quotation not found.', 'error'); return;
    }
    
    let quoteData = {
        items: quotation?.items ? JSON.parse(JSON.stringify(quotation.items)) : [],
        manualTaxAmount: quotation?.taxInBase,
    };
    
    const thirtyDaysFromNow = new Date();
    thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
    
    const initialCustomer = quotation ? firestoreData.customers.find(c => c.id === quotation.customerId) : null;

    const content = `
        <form id="quotation-form" class="space-y-4">
            <input type="hidden" name="customerId" value="${initialCustomer?.id || ''}">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 pb-4 border-b border-border-color">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium mb-1">Customer</label>
                    <div id="customer-selector-container" class="relative"></div>
                </div>
                <div><label class="block text-sm font-medium mb-1">Quotation Date</label><input type="date" name="date" value="${(quotation?.date || new Date().toISOString()).slice(0, 10)}" class="form-input w-full" required></div>
                <div><label class="block text-sm font-medium mb-1">Expiry Date</label><input type="date" name="expiryDate" value="${(quotation?.expiryDate || thirtyDaysFromNow.toISOString()).slice(0, 10)}" class="form-input w-full" required></div>
            </div>

            <div>
                <label class="block text-sm font-medium mb-1">Add Items to Quotation</label>
                <div class="relative">
                    <input type="text" id="quote-item-search" placeholder="Search by Name/SKU, or scan Barcode..." class="form-input w-full">
                    <div id="quote-item-search-results" class="absolute top-full left-0 right-0 mt-1 bg-bg-secondary border border-border-color rounded-lg shadow-lg z-20 hidden max-h-60 overflow-y-auto"></div>
                </div>
            </div>
            <div class="overflow-x-auto max-h-80 -mx-6">
                <table class="w-full text-sm">
                    <thead class="sticky top-0 bg-bg-primary z-10"><tr class="text-left text-text-secondary text-xs uppercase"><th class="px-6 py-2">Product / SKU</th><th class="px-4 py-2 w-24">Qty</th><th class="px-4 py-2 w-32">Price</th><th class="px-4 py-2 w-32">Total</th><th class="px-4 py-2 w-12"></th></tr></thead>
                    <tbody id="quote-items-table" class="divide-y divide-border-color"></tbody>
                </table>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 pt-4 border-t border-border-color">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium mb-1">Notes / Terms & Conditions</label>
                    <textarea name="notes" class="form-textarea w-full h-24">${quotation?.notes || ''}</textarea>
                </div>
                <div id="quote-totals" class="space-y-1"></div>
            </div>
        </form>
    `;
    const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="quotation-form" class="btn btn-primary">${isEditing ? 'Save Changes' : 'Create Quotation'}</button>`;
    const modal = showModal(isEditing ? `Edit Quotation #${quotation.quotationNumber}` : 'New Quotation', content, footer, { size: 'max-w-6xl' });

    const customerSelectorContainer = modal.querySelector('#customer-selector-container');
    const hiddenCustomerIdInput = modal.querySelector('input[name="customerId"]');

    const updateTotals = () => {
        const subtotal = quoteData.items.reduce((sum, item) => sum + ((item.quantity || 0) * (item.price || 0)), 0);
        const defaultTaxRate = appState.settings.taxRate ?? 0;
        let taxAmount;
        if (quoteData.manualTaxAmount !== undefined) { taxAmount = quoteData.manualTaxAmount; } 
        else {
            const taxableSubtotal = quoteData.items.filter(i => i.taxable).reduce((acc, item) => acc + (item.price * (item.quantity || 1)), 0);
            taxAmount = taxableSubtotal * (defaultTaxRate / 100);
        }
        const grandTotal = subtotal + taxAmount;
        modal.querySelector('#quote-totals').innerHTML = `
            <div class="grid grid-cols-2 items-center gap-y-2 text-sm">
                <span class="text-text-secondary text-left">Subtotal:</span><span class="font-mono text-right p-1">${currencyUtils.format(subtotal)}</span>
                <span class="text-text-secondary text-left flex items-center gap-1">Tax (${defaultTaxRate}%) <button type="button" id="reset-tax-btn" title="Reset to default tax rate" class="${quoteData.manualTaxAmount !== undefined ? '' : 'hidden'} text-accent/70 hover:text-accent"><i data-lucide="rotate-ccw" class="w-3 h-3"></i></button></span>
                <input type="number" step="0.01" id="quote-tax-amount" class="form-input p-1 w-24 text-right justify-self-end font-mono" value="${currencyUtils.convert(taxAmount).toFixed(2)}">
            </div>
            <div class="grid grid-cols-2 items-center font-bold text-lg pt-2 border-t border-border-color mt-2">
                <span class="text-text-primary text-left">Total:</span><span class="font-mono text-accent text-right">${currencyUtils.format(grandTotal)}</span>
            </div>`;
        lucide.createIcons();
    };

    const renderItems = () => {
        const itemsTableBody = modal.querySelector('#quote-items-table');
        itemsTableBody.innerHTML = quoteData.items.length ? quoteData.items.map((item, index) => {
            const product = firestoreData.products.find(p => p.id === item.productId);
            const displayName = item.name || product?.name || 'Unknown';
            return `<tr data-index="${index}"><td class="px-6 py-2 align-middle"><p class="font-medium text-text-primary">${displayName}</p><p class="text-xs text-text-secondary font-mono">${item.productId}</p></td><td class="px-4 py-2 align-middle"><input type="number" class="form-input w-full p-1 text-center quote-item-input" data-field="quantity" value="${item.quantity}"></td><td class="px-4 py-2 align-middle"><input type="number" step="0.01" class="form-input w-full p-1 text-right quote-item-input" data-field="price" value="${currencyUtils.convert(item.price).toFixed(2)}"></td><td class="px-4 py-2 align-middle text-right font-mono">${currencyUtils.format((item.quantity || 0) * (item.price || 0))}</td><td class="px-4 py-2 align-middle text-center"><button type="button" data-action="remove-quote-item" class="p-1 text-danger/70 hover:text-danger"><i data-lucide="x-circle" class="w-5 h-5 pointer-events-none"></i></button></td></tr>`;
        }).join('') : `<tr><td colspan="5" class="text-center py-8 text-text-secondary">No items added yet.</td></tr>`;
        lucide.createIcons();
    };

    const renderCustomerSelector = (selectedCustomer) => {
        let buttonText = selectedCustomer ? `<div class="text-left"><p class="font-medium text-text-primary">${selectedCustomer.name}</p><p class="text-xs text-text-secondary">${selectedCustomer.email || selectedCustomer.phone}</p></div>` : `<span class="text-text-secondary">Select a customer...</span>`;
        customerSelectorContainer.innerHTML = `<button type="button" id="customer-select-btn" class="form-input w-full flex justify-between items-center text-left h-auto py-2">${buttonText}<i data-lucide="chevrons-up-down" class="w-4 h-4 text-text-secondary"></i></button><div id="customer-select-dropdown" class="absolute top-full left-0 right-0 mt-1 bg-bg-secondary border border-border-color rounded-lg shadow-lg z-30 hidden"><div class="p-2 border-b border-border-color"><input type="text" id="customer-search-input" placeholder="Search customers..." class="form-input w-full text-sm"></div><div id="customer-options-list" class="max-h-48 overflow-y-auto"></div><div class="p-2 border-t border-border-color"><button type="button" id="add-new-customer-from-quote" class="btn btn-secondary w-full text-sm"><i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>Add New Customer</button></div></div>`;
        lucide.createIcons();
        const renderOptions = (filter = '') => { const query = filter.toLowerCase(); const customers = firestoreData.customers.filter(c => c.name.toLowerCase().includes(query) || (c.email||'').toLowerCase().includes(query) || (c.phone||'').includes(query)); modal.querySelector('#customer-options-list').innerHTML = customers.map(c => `<div data-action="select-customer-from-quote" data-id="${c.id}" class="px-4 py-2.5 cursor-pointer hover:bg-bg-tertiary"><p class="font-medium text-text-primary text-sm pointer-events-none">${c.name}</p><p class="text-xs text-text-secondary pointer-events-none">${c.email || c.phone}</p></div>`).join(''); };
        renderOptions();
        modal.querySelector('#customer-search-input').addEventListener('input', e => renderOptions(e.target.value));
    };

    renderItems();
    updateTotals();
    renderCustomerSelector(initialCustomer);
    
    const searchInput = modal.querySelector('#quote-item-search');
    searchInput.addEventListener('input', e => {
        const query = e.target.value.toLowerCase();
        const resultsContainer = modal.querySelector('#quote-item-search-results');
        if (query.length < 2) { resultsContainer.classList.add('hidden'); return; }
        const filteredProducts = firestoreData.products.filter(p => !p.parentSKU && (p.name.toLowerCase().includes(query) || p.id.toLowerCase().includes(query))).slice(0, 5);
        if (filteredProducts.length > 0) {
            resultsContainer.innerHTML = filteredProducts.map(p => `<div data-action="add-quote-item" data-id="${p.id}" class="p-3 cursor-pointer hover:bg-bg-tertiary"><p class="font-medium text-text-primary pointer-events-none">${p.name}</p><p class="text-xs text-text-secondary font-mono pointer-events-none">${p.id} / Price: ${currencyUtils.format(p.price)}</p></div>`).join('');
            resultsContainer.classList.remove('hidden');
        } else { resultsContainer.classList.add('hidden'); }
    });

    modal.addEventListener('click', e => {
        const target = e.target.closest('[data-action]');
        if (!target) {
            const dropdown = modal.querySelector('#customer-select-dropdown');
            if (dropdown && !dropdown.contains(e.target) && !modal.querySelector('#customer-select-btn').contains(e.target)) {
                dropdown.classList.add('hidden');
            }
            return;
        }
        const action = target.dataset.action;

        if (action === 'add-quote-item') {
            const productId = target.dataset.id;
            const product = firestoreData.products.find(p => p.id === productId);
            if (product) {
                if (product.hasVariants) {
                    openQuoteVariantSelectorModal(product, (selectedVariants) => {
                        let addedCount = 0;
                        selectedVariants.forEach(variant => {
                            const existing = quoteData.items.find(i => i.productId === variant.id);
                            if (existing) {
                                existing.quantity++;
                            } else {
                                // *** FIX IS HERE ***
                                // Safely create the variant name, even if variantOptions is missing.
                                const variantOptionsText = variant.variantOptions ? Object.values(variant.variantOptions).join('/') : '';
                                quoteData.items.push({
                                    productId: variant.id,
                                    name: `${product.name} (${variantOptionsText})`,
                                    quantity: 1,
                                    price: variant.price || 0,
                                    taxable: variant.taxable === true
                                });
                                addedCount++;
                            }
                        });
                        if(addedCount > 0) showToast(`Added ${addedCount} new variant(s) to quote.`, 'success');
                        if(selectedVariants.length > addedCount) showToast(`${selectedVariants.length - addedCount} existing variant(s) incremented.`, 'info');
                        
                        renderItems();
                        updateTotals();
                    });
                } else {
                    const existing = quoteData.items.find(i => i.productId === productId);
                    if(existing) { 
                        existing.quantity++; 
                    } else {
                        quoteData.items.push({ 
                            productId: product.id, 
                            name: product.name, 
                            quantity: 1, 
                            price: product.price || 0,
                            taxable: product.taxable === true
                        });
                    }
                    renderItems();
                    updateTotals();
                }
            }
            searchInput.value = '';
            searchInput.focus();
            modal.querySelector('#quote-item-search-results').classList.add('hidden');
        }
        
        if (action === 'remove-quote-item') { const index = target.closest('tr').dataset.index; quoteData.items.splice(index, 1); renderItems(); updateTotals(); }
        if (action === 'select-customer-from-quote') { const customerId = target.dataset.id; const customer = firestoreData.customers.find(c => c.id === customerId); if (customer) { hiddenCustomerIdInput.value = customer.id; renderCustomerSelector(customer); modal.querySelector('#customer-select-dropdown').classList.add('hidden'); } }

    });
    
    customerSelectorContainer.addEventListener('click', e => { const btn = e.target.closest('#customer-select-btn'); const dropdown = modal.querySelector('#customer-select-dropdown'); if (btn) { dropdown.classList.toggle('hidden'); if (!dropdown.classList.contains('hidden')) { modal.querySelector('#customer-search-input').focus(); } } const addNewBtn = e.target.closest('#add-new-customer-from-quote'); if (addNewBtn) { dropdown.classList.add('hidden'); openCustomerModal(null, (newCustomer) => { hiddenCustomerIdInput.value = newCustomer.id; renderCustomerSelector(newCustomer); }); } });
    
    modal.addEventListener('input', e => { 
        const itemInput = e.target.closest('.quote-item-input'); 
        if (itemInput) { 
            const row = itemInput.closest('tr'); 
            const index = row.dataset.index; 
            const field = itemInput.dataset.field; 
            const value = parseFloat(itemInput.value) || 0; 
            if (quoteData.items[index]) { 
                if (field === 'price') { quoteData.items[index][field] = currencyUtils.convertToBase(value); } 
                else { quoteData.items[index][field] = value; } 
                row.querySelector('td:nth-of-type(4)').textContent = currencyUtils.format((quoteData.items[index].quantity || 0) * (quoteData.items[index].price || 0)); 
                updateTotals(); 
            } 
        } 
        const taxAmountInput = e.target.closest('#quote-tax-amount'); 
        if (taxAmountInput) { 
            const manualAmountDisplay = parseFloat(taxAmountInput.value) || 0; 
            quoteData.manualTaxAmount = currencyUtils.convertToBase(manualAmountDisplay); 
            updateTotals(); 
        } 
    });
    
    modal.addEventListener('click', e => { 
        const resetTaxBtn = e.target.closest('#reset-tax-btn'); 
        if (resetTaxBtn) { 
            delete quoteData.manualTaxAmount; 
            updateTotals(); 
        } 
    });

    modal.querySelector('#quotation-form').addEventListener('submit', async e => { 
        e.preventDefault(); 
        const formData = new FormData(e.target); 
        const customerId = formData.get('customerId'); 
        const customer = firestoreData.customers.find(c => c.id === customerId); 
        if (!customer) { showToast('Please select a valid customer.', 'error'); return; } 
        const subtotal = quoteData.items.reduce((sum, item) => sum + (item.quantity * item.price), 0); 
        let taxAmount; 
        if (quoteData.manualTaxAmount !== undefined) { taxAmount = quoteData.manualTaxAmount; } 
        else { const taxRate = (appState.settings.taxRate ?? 0) / 100; const taxableSubtotal = quoteData.items.filter(i => i.taxable).reduce((acc, item) => acc + (item.price * (item.quantity || 1)), 0); taxAmount = taxableSubtotal * taxRate; } 
        const grandTotal = subtotal + taxAmount; 
        const data = { customerId: customerId, customerName: customer.name, date: formData.get('date'), expiryDate: formData.get('expiryDate'), items: quoteData.items, notes: formData.get('notes'), subtotalInBase: subtotal, taxInBase: taxAmount, totalInBase: grandTotal, status: isEditing ? quotation.status : 'Draft', createdBy: { id: appState.session.currentUser.uid, name: appState.session.currentUser.name } }; 
        try { 
            if (isEditing) { await updateDoc(doc(quotationsRef, quotationId), data); showToast('Quotation updated successfully.', 'success'); } 
            else { const countQuery = query(quotationsRef); const querySnapshot = await getDocs(countQuery); const nextNumber = querySnapshot.size + 1; data.quotationNumber = `Q-${new Date().getFullYear()}-${String(nextNumber).padStart(4, '0')}`; const newDocRef = doc(quotationsRef); await setDoc(newDocRef, data); showToast('Quotation created successfully.', 'success'); } 
            closeModal(modal); 
        } catch (error) { console.error('Error saving quotation:', error); showToast(`Failed to save quotation: ${error.message}`, 'error'); } 
    });
}


/**
 * [FIX] This function was missing, causing a "getProductStock is not defined" error.
 */
function getProductStock(product) {
    if (!product) return 0;
    if (product.productType !== 'physical') return Infinity;

    if (product.hasVariants) {
        return firestoreData.products
            .filter(v => v.parentSKU === product.id)
            .reduce((sum, v) => sum + (v.stock || 0), 0);
    }
    return product.stock || 0;
}


/**
 * [ENHANCEMENT] This function has been updated to provide a professional
 * user flow after creating an invoice, guiding the user to the next logical steps.
 */
async function convertToInvoice(quotationId) {
    const q = firestoreData.quotations.find(q => q.id === quotationId);
    if (!q) {
        showToast('Quotation not found.', 'error');
        return;
    }

    let outOfStockItems = [];
    const serializedItemsInQuote = [];
    for (const item of q.items) {
        const product = firestoreData.products.find(p => p.id === item.productId);
        if (product && product.productType === 'physical') {
            if (product.isSerialized) {
                const availableSerials = product.serials || [];
                if (availableSerials.length < item.quantity) {
                    outOfStockItems.push({ name: item.name, needed: item.quantity, available: availableSerials.length });
                } else {
                    serializedItemsInQuote.push(item);
                }
            } else {
                const stock = getProductStock(product);
                if (stock < item.quantity) {
                    outOfStockItems.push({ name: item.name, needed: item.quantity, available: stock });
                }
            }
        }
    }

    if (outOfStockItems.length > 0) {
        let errorMsg = 'Cannot convert to invoice, insufficient stock for:<br>' + outOfStockItems.map(item => `<strong>${item.name}</strong> (Needs ${item.needed}, have ${item.available})`).join('<br>');
        showModal('Insufficient Stock', errorMsg, `<button data-action="close-modal" class="btn btn-secondary">OK</button>`);
        return;
    }
    
    let serialsData = {};
    if (serializedItemsInQuote.length > 0) {
        const collectedSerials = await openInvoiceSerialEntryModal(serializedItemsInQuote);
        if (!collectedSerials) {
            showToast('Invoice conversion cancelled.', 'info');
            return;
        }
        serialsData = collectedSerials;
    }
    
    const newInvoiceItems = [];
    for (const item of q.items) {
        const product = firestoreData.products.find(p => p.id === item.productId);
        
        // FIX: Map `productId` from the quotation item to `id` for invoice item consistency.
        const { productId, ...restOfItem } = item;
        const invoiceItem = { 
            ...restOfItem, 
            id: productId, // This ensures the SKU is correctly displayed on the receipt
            costPrice: product?.costPrice || 0, 
            isSerialized: product?.isSerialized || false 
        };

        if (serialsData[item.productId]) {
            const selectedSerials = serialsData[item.productId];
            for (const serial of selectedSerials) {
                newInvoiceItems.push({ ...invoiceItem, qty: 1, serialNumber: serial, isSerialized: true });
            }
        } else {
            newInvoiceItems.push(invoiceItem);
        }
    }

    const newInvoiceData = {
        customerId: q.customerId, customerName: q.customerName,
        totalInBaseCurrency: q.totalInBase, subtotalInBaseCurrency: q.subtotalInBase,
        taxInBaseCurrency: q.taxInBase, discountInBaseCurrency: 0,
        dueAmount: q.totalInBase, currency: appState.currentCurrency,
        exchangeRate: currencyUtils.get().rate, status: 'Due',
        date: new Date().toISOString(), items: newInvoiceItems, paymentDetails: [],
        cashierId: appState.session.currentUser.uid, cashierName: appState.session.currentUser.name,
        storeId: appState.session.storeId, pointsEarned: 0, notes: q.notes,
        linkedQuotationId: q.id
    };

    try {
        const newInvoiceRef = doc(invoicesRef);

        await runTransaction(db, async (transaction) => {
            // --- STAGE 1: READS ---
            const customerRef = doc(customersRef, q.customerId);
            const customerDoc = await transaction.get(customerRef);
            if (!customerDoc.exists()) throw new Error("Customer for this quotation no longer exists.");

            const productRefsToRead = [...new Set(newInvoiceData.items.map(item => item.id))];
            const productDocsPromises = productRefsToRead.map(id => transaction.get(doc(productsRef, id)));
            const productDocs = await Promise.all(productDocsPromises);
            const productDataMap = new Map(productDocs.map(doc => [doc.id, doc.data()]));

            // --- STAGE 2: AGGREGATE CHANGES (DO NOT WRITE YET) ---
            const productUpdatePayloads = {};

            for (const item of newInvoiceData.items) {
                const productId = item.id;
                const productData = productDataMap.get(productId);
                if (!productData) continue;

                if (!productUpdatePayloads[productId]) {
                    productUpdatePayloads[productId] = {
                        serials: [...(productData.serials || [])],
                        stock: productData.stock || 0,
                        warrantiesToCreate: []
                    };
                }
                const payload = productUpdatePayloads[productId];

                if (item.serialNumber) {
                    payload.serials = payload.serials.filter(sn => sn !== item.serialNumber);
                    
                    let policyId = null;
                    if (productData.parentSKU) {
                        // This is a variant. Find its parent to get the warranty policy.
                        const parentProduct = firestoreData.products.find(p => p.id === productData.parentSKU);
                        policyId = parentProduct?.defaultWarrantyPolicyId;
                    } else {
                        // This is a standalone serialized product. Get policy directly.
                        policyId = productData.defaultWarrantyPolicyId;
                    }

                    if (!policyId) {
                        policyId = 'standard-1-year'; // Fallback
                    }
                    
                    const policies = appState.settings.warrantyPolicies || { 'standard-1-year': { name: "Standard 1-Year", durationMonths: 12 } };
                    const policy = policies[policyId];

                    if(policy) {
                        const startDate = new Date();
                        const expiryDate = new Date(startDate);
                        expiryDate.setMonth(startDate.getMonth() + policy.durationMonths);
                        payload.warrantiesToCreate.push({
                            productId: productId, productName: item.name, serialNumber: item.serialNumber,
                            customerId: newInvoiceData.customerId, customerName: newInvoiceData.customerName,
                            invoiceId: newInvoiceRef.id, policyId: policyId, policyName: policy.name,
                            startDate: startDate.toISOString(), expiryDate: expiryDate.toISOString(), status: 'active'
                        });
                    }
                } else if (productData.productType === 'physical') {
                    payload.stock -= (item.qty || 1);
                }
            }

            // --- STAGE 3: EXECUTE ALL WRITES ---
            transaction.set(newInvoiceRef, {...newInvoiceData, id: newInvoiceRef.id});
            transaction.update(doc(quotationsRef, q.id), { status: 'Invoiced', linkedInvoiceId: newInvoiceRef.id });
            const newDue = (customerDoc.data().currentDue || 0) + q.totalInBase;
            transaction.update(customerRef, { currentDue: newDue });

            for (const productId in productUpdatePayloads) {
                const payload = productUpdatePayloads[productId];
                const productRef = doc(productsRef, productId);
                const productData = productDataMap.get(productId);
                const finalUpdate = {};

                if (productData.isSerialized) {
                    finalUpdate.serials = payload.serials;
                    finalUpdate.stock = payload.serials.length;
                } else if (productData.productType === 'physical') {
                    finalUpdate.stock = payload.stock;
                }
                
                if (Object.keys(finalUpdate).length > 0) {
                    transaction.update(productRef, finalUpdate);
                }

                for (const warrantyData of payload.warrantiesToCreate) {
                    const newWarrantyRef = doc(warrantiesRef);
                    transaction.set(newWarrantyRef, { ...warrantyData, id: newWarrantyRef.id });
                }
            }
        });

        // Manually update local state to fix the UI race condition
        const customerIndex = firestoreData.customers.findIndex(c => c.id === q.customerId);
        if (customerIndex > -1) {
            firestoreData.customers[customerIndex].currentDue = (firestoreData.customers[customerIndex].currentDue || 0) + q.totalInBase;
        }

        showToast(`Quotation converted to Invoice #${newInvoiceRef.id.slice(-6)}.`, 'success');
        
        const guidanceModal = showModal(
            'Invoice Created Successfully',
            `Invoice <strong class="font-mono">${newInvoiceRef.id}</strong> has been created with a 'Due' status.
             <br><br>You can now view the invoice history or receive payment for this customer's outstanding balance.`,
            `<button data-action="close-modal" class="btn btn-secondary">Close</button>
             <button id="view-invoices-now" class="btn btn-secondary">View Invoices</button>
             <button id="receive-payment-now" class="btn btn-primary">Receive Payment</button>`
        );
        
        guidanceModal.querySelector('#view-invoices-now').addEventListener('click', () => {
            closeModal(guidanceModal);
            openOrSwitchTab('invoices');
        });
        
        guidanceModal.querySelector('#receive-payment-now').addEventListener('click', () => {
            closeModal(guidanceModal);
            openReceivePaymentModal(newInvoiceData.customerId);
        });

    } catch (error) {
        console.error('Failed to convert quotation:', error);
        showToast(`Error converting quotation to invoice: ${error.message}`, 'error');
    }
}

// --- Main Initializer for Payroll View ---
async function initPayroll(container) {
    if (!container) return;
    
    // Ensure container is clean (prevents duplicate event listeners)
    const newContainer = container.cloneNode(false);
    if (container.parentNode) {
        container.parentNode.replaceChild(newContainer, container);
    }
    container = newContainer;

    if (!checkPermission('canManagePayroll')) {
        container.innerHTML = `<div class="text-center p-20"><i data-lucide="shield-off" class="w-16 h-16 mx-auto text-red-500/50 mb-4"></i><h2 class="text-xl font-semibold">Access Denied</h2><p class="text-text-secondary">You do not have permission to manage payroll.</p></div>`;
        lucide.createIcons();
        return;
    }

    // Fetch payroll settings if not already loaded (consider a dedicated listener later)
    if (Object.keys(firestoreData.payrollSettings).length === 0) {
        try {
            const settingsSnap = await getDoc(payrollSettingsRef);
            if (settingsSnap.exists()) {
                firestoreData.payrollSettings = settingsSnap.data();
            } else {
                // Initialize default settings if none exist
                const defaultSettings = { payFrequency: 'monthly', payDay: 1, defaultTaxRate: 15, defaultOvertimeRate: 1.5 };
                await setDoc(payrollSettingsRef, defaultSettings);
                firestoreData.payrollSettings = defaultSettings;
            }
        } catch (error) {
            console.error("Error fetching/creating payroll settings:", error);
            showToast("Could not load payroll settings.", "error");
            firestoreData.payrollSettings = { payFrequency: 'monthly', payDay: 1, defaultTaxRate: 15, defaultOvertimeRate: 1.5 }; // Fallback
        }
    }
    
    // Fetch recent payroll runs (consider pagination or more efficient loading later)
    if (firestoreData.payrollRuns.length === 0) { // Only fetch if not already loaded
        try {
            const runsQuery = query(payrollRunsRef, limit(20)); // Fetch last 20 runs for history
            const runsSnapshot = await getDocs(runsQuery);
    } catch (error) {
        console.error("Error fetching payroll runs:", error);
        showToast("Could not load payroll history.", "error");
        }
    }

    const viewState = appState.viewStates.payroll;
    const activeTab = viewState.activeTab || 'overview';

    container.innerHTML = `
        <div class="space-y-6">
            <!-- Header -->
            <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-text-primary">Payroll Management</h1>
                    <p class="text-text-secondary">Process salaries, manage pay settings, and view history.</p>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="border-b border-border-color flex space-x-4">
                <button data-action="set-payroll-tab" data-tab="overview" class="form-tab ${activeTab === 'overview' ? 'active' : ''} px-1 py-3 text-sm font-medium">Overview & Run Payroll</button>
                <button data-action="set-payroll-tab" data-tab="settings" class="form-tab ${activeTab === 'settings' ? 'active' : ''} px-1 py-3 text-sm font-medium">Staff Pay Settings</button>
                <button data-action="set-payroll-tab" data-tab="history" class="form-tab ${activeTab === 'history' ? 'active' : ''} px-1 py-3 text-sm font-medium">Payroll History</button>
            </div>
            
            <!-- Tab Content -->
            <div id="payroll-tab-content">
                <!-- Content injected by render functions -->
            </div>
        </div>
        
        <style>
            /* Specific styles for payroll modals or elements if needed */
            .payslip-modal-content { font-family: 'Courier New', monospace; font-size: 11px; line-height: 1.4; color: #333; background-color: #fff; }
            .payslip-modal-content table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
            .payslip-modal-content th, .payslip-modal-content td { border: 1px solid #ccc; padding: 4px 6px; }
            .payslip-modal-content th { background-color: #f2f2f2; font-weight: bold; text-align: left;}
            .payslip-modal-content .totals-table td:first-child { text-align: right; font-weight: bold; }
        </style>
    `;

    const tabContentContainer = container.querySelector('#payroll-tab-content');

    // Render the active tab
    switch(activeTab) {
        case 'settings':
            renderStaffPaySettings(tabContentContainer);
            break;
        case 'history':
            renderPayrollHistory(tabContentContainer);
            break;
        case 'overview':
        default:
            renderPayrollOverview(tabContentContainer);
            break;
    }

    // --- Event Delegation for Payroll ---
    container.addEventListener('click', e => {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const action = target.dataset.action;
        const id = target.dataset.id;
        const tab = target.dataset.tab;

        switch(action) {
            case 'set-payroll-tab':
                if (viewState.activeTab === tab) return; // Do nothing if clicking same tab

                viewState.activeTab = tab;
                
                // 1. Update tab button active states
                container.querySelectorAll('[data-action="set-payroll-tab"]').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tab);
                });

                // 2. Get the content container - REMOVED REDECLARATION
                // const tabContentContainer = container.querySelector('#payroll-tab-content'); // <-- This was the error
                if (!tabContentContainer) { // <-- Now uses the variable from the outer scope
                    console.error("Payroll tab content container not found!");
                    return; // <-- Fixed typo here (was 'return; _')
                }

                // 3. Render new content
                switch(tab) {
                    case 'settings':
                        renderStaffPaySettings(tabContentContainer);
                        break;
                    case 'history':
                         // If we're viewing a specific run, reset to list view
                        if (viewState.selectedRunId) {
                            viewState.selectedRunId = null;
                        }
                        renderPayrollHistory(tabContentContainer);
                        break;
                    case 'overview':
                    default:
                        renderPayrollOverview(tabContentContainer);
                        break;
                }
                
                lucide.createIcons(); // Re-process icons for new content
                break;
            case 'edit-pay-settings':
                openStaffPaySettingsModal(id);
                break;
            case 'run-payroll':
                runPayrollProcess();
                break;
            case 'view-payroll-run':
                viewState.selectedRunId = id;
                renderPayrollHistoryDetails(tabContentContainer, id);
                break;
            case 'back-to-history-list':
                viewState.selectedRunId = null;
                renderPayrollHistory(tabContentContainer);
                break;
            case 'view-payslip':
                const runId = target.dataset.runId;
                const payslipId = target.dataset.payslipId;
                viewPayslipModal(runId, payslipId);
                break;
             case 'edit-payroll-general-settings':
                openPayrollGeneralSettingsModal();
                break;
        }
    });

    lucide.createIcons();
}


// --- Payroll Overview Tab ---
function renderPayrollOverview(container) {
    const settings = firestoreData.payrollSettings;
    const staffWithPay = firestoreData.staff.filter(s => (s.status || 'active') === 'active' && s.payType && s.payRate);
    
    // Basic calculation for next pay date (can be improved)
    const today = new Date();
    let nextPayDate = new Date(today.getFullYear(), today.getMonth(), settings.payDay || 1);
    if (settings.payFrequency === 'monthly') {
        if (today.getDate() > (settings.payDay || 1)) {
            nextPayDate.setMonth(nextPayDate.getMonth() + 1);
        }
    } // Add 'weekly', 'bi-weekly' logic if needed

    container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Left: Payroll Summary & Action -->
            <div class="md:col-span-1 space-y-4">
                <div class="glass-pane p-6 rounded-xl text-center">
                    <p class="text-sm text-text-secondary uppercase font-semibold">Next Payroll Date</p>
                    <p class="text-3xl font-bold text-accent mt-2">${nextPayDate.toLocaleDateString()}</p>
                    <p class="text-xs text-text-secondary capitalize">${settings.payFrequency}</p>
                </div>
                <div class="glass-pane p-6 rounded-xl">
                     <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold text-text-primary">General Settings</h3>
                        <button data-action="edit-payroll-general-settings" class="btn btn-secondary btn-sm p-2"><i data-lucide="settings" class="w-4 h-4"></i></button>
                    </div>
                    <div class="space-y-2 text-sm">
                        <p><strong class="text-text-secondary">Frequency:</strong> <span class="capitalize text-text-primary">${settings.payFrequency}</span></p>
                        <p><strong class="text-text-secondary">Pay Day:</strong> <span class="text-text-primary">Day ${settings.payDay || '1'}</span></p>
                        <p><strong class="text-text-secondary">Default Tax Rate:</strong> <span class="text-text-primary">${settings.defaultTaxRate || 0}%</span></p>
                        <p><strong class="text-text-secondary">Overtime Rate:</strong> <span class="text-text-primary">${settings.defaultOvertimeRate || 1.5}x</span></p>
                    </div>
                </div>
                <button data-action="run-payroll" class="btn btn-primary btn-lg w-full text-lg py-4">
                    <i data-lucide="play-circle" class="w-6 h-6 mr-2"></i> Run Payroll Now
                </button>
            </div>
            
            <!-- Right: Staff List for Payroll -->
            <div class="md:col-span-2 glass-pane p-6 rounded-xl">
                <h3 class="text-lg font-semibold text-text-primary mb-4">Staff Ready for Payroll (${staffWithPay.length})</h3>
                <div class="max-h-[60vh] overflow-y-auto">
                    <table class="table-pro">
                        <thead>
                            <tr><th>Name</th><th>Pay Type</th><th>Rate</th><th>Est. Gross (Current Period)</th></tr>
                        </thead>
                        <tbody>
                            ${staffWithPay.length ? staffWithPay.map(staff => {
                                const rateDisplay = staff.payType === 'hourly' 
                                    ? `${currencyUtils.format(staff.payRate)}/hr` 
                                    : currencyUtils.format(staff.payRate);
                                // Placeholder for estimated gross - needs timesheet data or assumption
                                const estGross = staff.payType === 'fixed' ? staff.payRate : 0; 
                                return `
                                <tr class="table-row">
                                    <td>${staff.name}</td>
                                    <td class="capitalize">${staff.payType}</td>
                                    <td class="font-mono">${rateDisplay}</td>
                                    <td class="font-mono">${currencyUtils.format(estGross)}</td>
                                </tr>`;
                            }).join('') : `<tr><td colspan="4" class="text-center p-8 text-text-secondary">No staff members have pay settings configured.</td></tr>`}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    lucide.createIcons();
}

// --- Staff Pay Settings Tab ---
function renderStaffPaySettings(container) {
    const viewState = appState.viewStates.payroll;
    const staffList = firestoreData.staff.filter(s => (s.status || 'active') === 'active'); // Show active staff

    // Simple pagination logic
    const totalItems = staffList.length;
    const startIndex = ((viewState.settingsPage || 1) - 1) * appState.itemsPerPage;
    const paginatedStaff = staffList.slice(startIndex, startIndex + appState.itemsPerPage);

    container.innerHTML = `
        <div class="glass-pane p-6 rounded-xl">
            <h3 class="text-lg font-semibold text-text-primary mb-4">Manage Staff Pay Details</h3>
            <p class="text-sm text-text-secondary mb-4">Set pay type, rate, and bank information for each staff member.</p>
            <div class="overflow-x-auto">
                <table class="table-pro">
                    <thead>
                        <tr><th>Name</th><th>Pay Type</th><th>Pay Rate</th><th>Bank Details</th><th>Actions</th></tr>
                    </thead>
                    <tbody>
                        ${paginatedStaff.length ? paginatedStaff.map(staff => {
                            const rateDisplay = staff.payRate 
                                ? (staff.payType === 'hourly' ? `${currencyUtils.format(staff.payRate)}/hr` : currencyUtils.format(staff.payRate))
                                : 'Not Set';
                            const bankSet = staff.bankAccount && staff.bankName;
                            return `
                            <tr class="table-row">
                                <td>${staff.name}</td>
                                <td class="capitalize">${staff.payType || 'Not Set'}</td>
                                <td class="font-mono">${rateDisplay}</td>
                                <td>${bankSet ? `<span class="text-green-400 flex items-center gap-1"><i data-lucide="check" class="w-4 h-4"></i>Set</span>` : `<span class="text-yellow-400 flex items-center gap-1"><i data-lucide="alert-triangle" class="w-4 h-4"></i>Not Set</span>`}</td>
                                <td><button data-action="edit-pay-settings" data-id="${staff.id}" class="btn btn-secondary btn-sm"><i data-lucide="edit" class="w-4 h-4 mr-2"></i>Edit</button></td>
                            </tr>`;
                        }).join('') : `<tr><td colspan="5" class="text-center p-8 text-text-secondary">No active staff members found.</td></tr>`}
                    </tbody>
                </table>
            </div>
             <div id="payroll-settings-pagination" class="mt-4"></div>
        </div>
    `;
    
    renderPaginationControls(container.querySelector('#payroll-settings-pagination'), totalItems, viewState.settingsPage || 1, appState.itemsPerPage, 'payrollSettings');
    lucide.createIcons();
}

// --- Payroll History Tab ---
function renderPayrollHistory(container) {
     const viewState = appState.viewStates.payroll;
     const runs = firestoreData.payrollRuns; // Already fetched in initPayroll

    // Simple pagination logic
    const totalItems = runs.length;
    const startIndex = ((viewState.historyPage || 1) - 1) * appState.itemsPerPage;
    const paginatedRuns = runs.sort((a,b) => new Date(b.runDate) - new Date(a.runDate)).slice(startIndex, startIndex + appState.itemsPerPage);

    container.innerHTML = `
        <div class="glass-pane p-6 rounded-xl">
            <h3 class="text-lg font-semibold text-text-primary mb-4">Past Payroll Runs</h3>
             <div class="overflow-x-auto">
                <table class="table-pro">
                    <thead>
                        <tr><th>Run Date</th><th>Period Covered</th><th>Total Paid</th><th># Employees</th><th>Status</th><th>Actions</th></tr>
                    </thead>
                    <tbody>
                        ${paginatedRuns.length ? paginatedRuns.map(run => {
                            return `
                            <tr class="table-row">
                                <td>${new Date(run.runDate).toLocaleDateString()}</td>
                                <td>${new Date(run.periodStart).toLocaleDateString()} - ${new Date(run.periodEnd).toLocaleDateString()}</td>
                                <td class="font-mono">${currencyUtils.format(run.totalGrossPay)}</td>
                                <td class="text-center">${run.employeeCount}</td>
                                <td><span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-500/20 text-green-300">Completed</span></td>
                                <td><button data-action="view-payroll-run" data-id="${run.id}" class="btn btn-secondary btn-sm"><i data-lucide="eye" class="w-4 h-4 mr-2"></i>Details</button></td>
                            </tr>`;
                        }).join('') : `<tr><td colspan="6" class="text-center p-8 text-text-secondary">No payroll history found.</td></tr>`}
                    </tbody>
                </table>
            </div>
            <div id="payroll-history-pagination" class="mt-4"></div>
        </div>
    `;
     renderPaginationControls(container.querySelector('#payroll-history-pagination'), totalItems, viewState.historyPage || 1, appState.itemsPerPage, 'payrollHistory');
    lucide.createIcons();
}

// --- Payroll History Details View ---
async function renderPayrollHistoryDetails(container, runId) {
    const run = firestoreData.payrollRuns.find(r => r.id === runId);
    if (!run) {
        showToast("Payroll run not found.", "error");
        renderPayrollHistory(container); // Go back to list
        return;
    }

    // Fetch payslips for this specific run
    let payslips = [];
    try {
        const payslipsQuery = query(payslipsRef, where("payrollRunId", "==", runId));
        const payslipsSnapshot = await getDocs(payslipsQuery);
        payslips = payslipsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    } catch (error) {
        console.error("Error fetching payslips for run:", error);
        showToast("Could not load payslip details.", "error");
    }

    container.innerHTML = `
        <div class="space-y-6">
            <div class="flex items-center gap-4">
                <button data-action="back-to-history-list" class="btn btn-secondary p-2 h-10 w-10 shrink-0"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                <div>
                    <h2 class="text-2xl font-bold text-text-primary">Payroll Details - ${new Date(run.runDate).toLocaleDateString()}</h2>
                    <p class="text-text-secondary text-sm">Period: ${new Date(run.periodStart).toLocaleDateString()} to ${new Date(run.periodEnd).toLocaleDateString()}</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                 <div class="glass-pane p-5 rounded-xl"><p class="text-sm text-text-secondary">Total Gross Pay</p><p class="text-3xl font-bold font-mono text-blue-400">${currencyUtils.format(run.totalGrossPay)}</p></div>
                 <div class="glass-pane p-5 rounded-xl"><p class="text-sm text-text-secondary">Total Deductions</p><p class="text-3xl font-bold font-mono text-red-400">${currencyUtils.format(run.totalDeductions)}</p></div>
                 <div class="glass-pane p-5 rounded-xl"><p class="text-sm text-text-secondary">Total Net Pay</p><p class="text-3xl font-bold font-mono text-green-400">${currencyUtils.format(run.totalNetPay)}</p></div>
            </div>

            <div class="glass-pane p-6 rounded-xl">
                <h3 class="text-lg font-semibold text-text-primary mb-4">Employee Payslips (${payslips.length})</h3>
                 <div class="overflow-x-auto">
                    <table class="table-pro">
                        <thead>
                            <tr><th>Employee</th><th>Gross Pay</th><th>Deductions</th><th>Net Pay</th><th>Actions</th></tr>
                        </thead>
                        <tbody>
                            ${payslips.length ? payslips.map(slip => `
                                <tr class="table-row">
                                    <td>${slip.employeeName}</td>
                                    <td class="font-mono">${currencyUtils.format(slip.grossPay)}</td>
                                    <td class="font-mono text-red-400">${currencyUtils.format(slip.totalDeductions)}</td>
                                    <td class="font-mono text-green-400">${currencyUtils.format(slip.netPay)}</td>
                                    <td><button data-action="view-payslip" data-run-id="${runId}" data-payslip-id="${slip.id}" class="btn btn-secondary btn-sm"><i data-lucide="receipt-text" class="w-4 h-4 mr-2"></i>View</button></td>
                                </tr>
                            `).join('') : `<tr><td colspan="5" class="text-center p-8 text-text-secondary">No payslip details found for this run.</td></tr>`}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    lucide.createIcons();
}


// --- Modal for Staff Pay Settings ---
function openStaffPaySettingsModal(staffId) {
    const staff = firestoreData.staff.find(s => s.id === staffId);
    if (!staff) return;

    const content = `
        <form id="pay-settings-form" class="space-y-4">
            <p>Editing pay settings for: <strong class="text-text-primary">${staff.name}</strong></p>
            <div>
                <label class="block text-sm font-medium mb-1">Pay Type</label>
                <select name="payType" class="form-select w-full">
                    <option value="" ${!staff.payType ? 'selected' : ''}>Not Set</option>
                    <option value="hourly" ${staff.payType === 'hourly' ? 'selected' : ''}>Hourly</option>
                    <option value="fixed" ${staff.payType === 'fixed' ? 'selected' : ''}>Fixed Salary</option>
                </select>
            </div>
            <div>
                 <label class="block text-sm font-medium mb-1">Pay Rate (${appState.currentCurrency})</label>
                <input type="number" step="0.01" name="payRate" value="${staff.payRate ? currencyUtils.convert(staff.payRate).toFixed(2) : ''}" class="form-input w-full" placeholder="Enter rate per hour or fixed amount">
            </div>
            <div class="border-t border-border-color pt-4">
                <h4 class="text-base font-semibold mb-2">Bank Details (Optional)</h4>
                <div>
                    <label class="block text-sm font-medium mb-1">Bank Name</label>
                    <input type="text" name="bankName" value="${staff.bankName || ''}" class="form-input w-full">
                </div>
                 <div>
                    <label class="block text-sm font-medium mb-1">Account Number</label>
                    <input type="text" name="bankAccount" value="${staff.bankAccount || ''}" class="form-input w-full">
                </div>
            </div>
        </form>
    `;
    const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="pay-settings-form" class="btn btn-primary">Save Settings</button>`;
    const modal = showModal('Edit Pay Settings', content, footer);

    modal.querySelector('#pay-settings-form').addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const payRateInDisplay = parseFloat(formData.get('payRate'));
        
        const updates = {
            payType: formData.get('payType'),
            payRate: !isNaN(payRateInDisplay) ? currencyUtils.convertToBase(payRateInDisplay) : null,
            bankName: formData.get('bankName'),
            bankAccount: formData.get('bankAccount'),
        };

        try {
            await updateDoc(doc(staffRef, staffId), updates);
            showToast('Pay settings updated successfully.', 'success');
            closeModal(modal);
            // Re-render if on the settings tab
            if (appState.viewStates.payroll.activeTab === 'settings') {
                const container = document.getElementById('payroll-tab-content');
                if (container) renderStaffPaySettings(container);
            }
        } catch (error) {
            console.error('Error updating pay settings:', error);
            showToast('Failed to update settings.', 'error');
        }
    });
}

// --- Modal for General Payroll Settings ---
function openPayrollGeneralSettingsModal() {
    const settings = firestoreData.payrollSettings;
    
    const content = `
        <form id="payroll-general-settings-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1">Pay Frequency</label>
                <select name="payFrequency" class="form-select w-full">
                    <option value="monthly" ${settings.payFrequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                    <option value="weekly" ${settings.payFrequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                    <option value="bi-weekly" ${settings.payFrequency === 'bi-weekly' ? 'selected' : ''}>Bi-Weekly</option>
                </select>
            </div>
            <div>
                 <label class="block text-sm font-medium mb-1">Pay Day of Month (for Monthly)</label>
                <input type="number" min="1" max="31" name="payDay" value="${settings.payDay || 1}" class="form-input w-full">
            </div>
             <div>
                 <label class="block text-sm font-medium mb-1">Default Income Tax Rate (%)</label>
                <input type="number" step="0.1" name="defaultTaxRate" value="${settings.defaultTaxRate || 0}" class="form-input w-full">
            </div>
             <div>
                 <label class="block text-sm font-medium mb-1">Default Overtime Rate (Multiplier)</label>
                <input type="number" step="0.1" name="defaultOvertimeRate" value="${settings.defaultOvertimeRate || 1.5}" class="form-input w-full" placeholder="e.g., 1.5 for time-and-a-half">
            </div>
        </form>
    `;
    const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="payroll-general-settings-form" class="btn btn-primary">Save Settings</button>`;
    const modal = showModal('Payroll General Settings', content, footer);

    modal.querySelector('#payroll-general-settings-form').addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        const updates = {
            payFrequency: formData.get('payFrequency'),
            payDay: parseInt(formData.get('payDay')) || 1,
            defaultTaxRate: parseFloat(formData.get('defaultTaxRate')) || 0,
            defaultOvertimeRate: parseFloat(formData.get('defaultOvertimeRate')) || 1.5,
        };

        try {
            await setDoc(payrollSettingsRef, updates, { merge: true });
            firestoreData.payrollSettings = updates; // Update local state
            showToast('General payroll settings updated.', 'success');
            closeModal(modal);
            // Re-render if on the overview tab
            if (appState.viewStates.payroll.activeTab === 'overview') {
                const container = document.getElementById('payroll-tab-content');
                if (container) renderPayrollOverview(container);
            }
        } catch (error) {
            console.error('Error updating general payroll settings:', error);
            showToast('Failed to update settings.', 'error');
        }
    });
}

async function runPayrollProcess() {
    const staffToPay = firestoreData.staff.filter(s => (s.status || 'active') === 'active' && s.payType && s.payRate);
    if (staffToPay.length === 0) {
        showToast("No staff members have pay settings configured.", "warning");
        return;
    }

    // Basic period calculation (needs refinement for different frequencies)
    const today = new Date();
    const periodEnd = new Date(today); // Pay up to today
    const periodStart = new Date(today.getFullYear(), today.getMonth(), 1); // Assume monthly for now

    const modalContent = `
        <p>You are about to run payroll for <strong>${staffToPay.length}</strong> staff member(s) for the period:</p>
        <p class="font-medium my-2">${periodStart.toLocaleDateString()} - ${periodEnd.toLocaleDateString()}</p>
        <p class="text-sm text-text-secondary">This will calculate gross pay, apply deductions (based on default settings), and record the payroll run. Ensure all pay rates and hours (if applicable) are correct before proceeding.</p>
        <div class="mt-4 p-3 bg-yellow-900/50 text-yellow-300 rounded-lg text-sm border border-yellow-700">
            <i data-lucide="alert-triangle" class="inline w-4 h-4 mr-1"></i> This is a simulation. Actual fund transfers are not performed.
        </div>
    `;
    const modalFooter = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-run-payroll" class="btn btn-primary">Confirm & Run Payroll</button>`;
    const confirmModal = showModal('Confirm Payroll Run', modalContent, modalFooter);
    lucide.createIcons();

    confirmModal.querySelector('#confirm-run-payroll').addEventListener('click', async () => {
        closeModal(confirmModal);
        showToast("Processing payroll... please wait.", "info");

        try {
            const batch = writeBatch(db);
            const payrollRunId = `RUN-${Date.now()}`;
            const runDate = new Date().toISOString();
            let totalGrossPayRun = 0;
            let totalDeductionsRun = 0;
            let totalNetPayRun = 0;

            for (const staff of staffToPay) {
                // --- Pay Calculation Logic (Simplified) ---
                let grossPay = 0;
                let hoursWorked = 0; // Needs timesheet integration later
                let overtimeHours = 0; // Needs timesheet integration later

                if (staff.payType === 'fixed') {
                    grossPay = staff.payRate; // Assuming rate is for the period
                } else if (staff.payType === 'hourly') {
                    // TODO: Replace with actual hours from timesheets
                    hoursWorked = 40; // Placeholder: Assume 40 hours for weekly/bi-weekly
                    if (firestoreData.payrollSettings.payFrequency === 'monthly') hoursWorked = 160; // Placeholder monthly

                    grossPay = hoursWorked * staff.payRate;
                    // TODO: Add overtime calculation
                    // overtimeHours = Math.max(0, hoursWorked - 40); // Simple weekly OT example
                    // grossPay += overtimeHours * staff.payRate * (firestoreData.payrollSettings.defaultOvertimeRate - 1);
                }

                // --- Deductions (Simplified Tax) ---
                const taxRate = (firestoreData.payrollSettings.defaultTaxRate || 0) / 100;
                const taxDeduction = grossPay * taxRate;
                // TODO: Add other deductions (benefits, etc.)
                const totalDeductions = taxDeduction;
                const netPay = grossPay - totalDeductions;

                totalGrossPayRun += grossPay;
                totalDeductionsRun += totalDeductions;
                totalNetPayRun += netPay;

                // Create Payslip document
                const payslipRef = doc(payslipsRef); // Auto-generate ID
                batch.set(payslipRef, {
                    id: payslipRef.id,
                    payrollRunId: payrollRunId,
                    employeeId: staff.id,
                    employeeName: staff.name,
                    runDate: runDate,
                    periodStart: periodStart.toISOString(),
                    periodEnd: periodEnd.toISOString(),
                    payType: staff.payType,
                    payRate: staff.payRate,
                    hoursWorked: hoursWorked, // Store calculated/assumed hours
                    overtimeHours: overtimeHours,
                    grossPay: grossPay,
                    deductions: [ // Example structure
                        { name: 'Income Tax', amount: taxDeduction },
                    ],
                    totalDeductions: totalDeductions,
                    netPay: netPay,
                    bankName: staff.bankName || null,
                    bankAccount: staff.bankAccount || null,
                });
            }

            // Create PayrollRun document
            const payrollRunRef = doc(payrollRunsRef, payrollRunId);
            batch.set(payrollRunRef, {
                id: payrollRunId,
                runDate: runDate,
                periodStart: periodStart.toISOString(),
                periodEnd: periodEnd.toISOString(),
                employeeCount: staffToPay.length,
                totalGrossPay: totalGrossPayRun,
                totalDeductions: totalDeductionsRun,
                totalNetPay: totalNetPayRun,
                processedBy: { id: appState.session.currentUser.uid, name: appState.session.currentUser.name }
            });

            await batch.commit();

            // --- *** NEW: Add Expense Record after successful payroll commit *** ---
            try {
                if (totalGrossPayRun > 0) {
                    const expenseData = {
                        amountInBase: totalGrossPayRun,
                        currency: appState.currentCurrency, // Use the current display currency context
                        date: runDate.slice(0, 10), // Use the date part of the run date
                        category: 'Salaries', // Or 'Payroll'
                        paidTo: 'Staff Salaries',
                        paymentMethod: 'Bank Transfer', // Or a suitable default
                        notes: `Payroll Run ID: ${payrollRunId}. Period: ${periodStart.toLocaleDateString()} - ${periodEnd.toLocaleDateString()}.`,
                        recordedBy: {
                            id: appState.session.currentUser.uid,
                            name: appState.session.currentUser.name
                        },
                        createdAt: runDate,
                        lastUpdatedAt: runDate
                    };
                    await addDoc(expensesRef, expenseData);
                    console.log(`[Payroll] Successfully logged payroll expense ID: ${payrollRunId}`);
                }
            } catch (expenseError) {
                // Log the error but don't stop the success message for payroll itself
                console.error("[Payroll] Failed to automatically log payroll expense:", expenseError);
                showToast("Payroll run saved, but failed to log expense automatically.", "warning");
            }
            // --- *** END NEW EXPENSE LOGIC *** ---


            showToast(`Payroll for ${staffToPay.length} employees completed successfully!`, "success");

            // Refresh history view if active
             if (appState.viewStates.payroll.activeTab === 'history') {
                const container = document.getElementById('payroll-tab-content');
                if (container) initPayroll(container.parentElement); // Re-init the whole payroll view to refresh data
             } else {
                 // Fetch latest runs again for next history view
                 const runsQuery = query(payrollRunsRef, limit(20));
                 const runsSnapshot = await getDocs(runsQuery);
                 firestoreData.payrollRuns = runsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
             }

        } catch (error) {
            console.error("Error running payroll:", error);
            showToast(`Payroll failed: ${error.message}`, "error");
        }
    });
}
// --- View Payslip Modal ---
async function viewPayslipModal(runId, payslipId) {
    let payslip;
    try {
        const payslipSnap = await getDoc(doc(payslipsRef, payslipId));
        if (!payslipSnap.exists()) throw new Error("Payslip not found");
        payslip = payslipSnap.data();
    } catch (error) {
        showToast("Could not load payslip details.", "error");
        console.error(error);
        return;
    }
    
    const run = firestoreData.payrollRuns.find(r => r.id === runId); // Get run details from local data
    
    const modalContent = `
        <div id="payslip-print-area" class="payslip-modal-content p-6">
            <h2 style="text-align: center; font-size: 16px; font-weight: bold; margin-bottom: 15px;">Payslip</h2>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <div>
                    <p><strong>Employee:</strong> ${payslip.employeeName}</p>
                    <p><strong>ID:</strong> ${payslip.employeeId.slice(-6)}</p>
                </div>
                <div>
                    <p><strong>Pay Period:</strong> ${new Date(payslip.periodStart).toLocaleDateString()} - ${new Date(payslip.periodEnd).toLocaleDateString()}</p>
                    <p><strong>Pay Date:</strong> ${new Date(payslip.runDate).toLocaleDateString()}</p>
                </div>
            </div>
            
            <table style="margin-top: 15px;">
                <thead><tr><th>Earnings</th><th>Hours/Units</th><th>Rate</th><th>Amount</th></tr></thead>
                <tbody>
                    <tr>
                        <td>${payslip.payType === 'fixed' ? 'Salary' : 'Regular Hours'}</td>
                        <td>${payslip.hoursWorked || '-'}</td>
                        <td>${currencyUtils.format(payslip.payRate)} ${payslip.payType === 'hourly' ? '/hr' : ''}</td>
                        <td style="text-align: right;">${currencyUtils.format(payslip.grossPay)}</td>
                    </tr>
                    <!-- Add rows for overtime, bonuses etc. if implemented -->
                </tbody>
                <tfoot>
                    <tr style="font-weight: bold;">
                        <td colspan="3" style="text-align: right;">Gross Pay:</td>
                        <td style="text-align: right;">${currencyUtils.format(payslip.grossPay)}</td>
                    </tr>
                </tfoot>
            </table>
            
            <table>
                <thead><tr><th>Deductions</th><th>Amount</th></tr></thead>
                <tbody>
                    ${payslip.deductions.map(d => `
                        <tr><td>${d.name}</td><td style="text-align: right;">${currencyUtils.format(d.amount)}</td></tr>
                    `).join('')}
                    <!-- Add more deduction rows if needed -->
                </tbody>
                 <tfoot>
                    <tr style="font-weight: bold;">
                        <td style="text-align: right;">Total Deductions:</td>
                        <td style="text-align: right;">${currencyUtils.format(payslip.totalDeductions)}</td>
                    </tr>
                </tfoot>
            </table>
            
             <table class="totals-table" style="width: 50%; margin-left: auto; margin-top: 15px;">
                <tbody>
                    <tr><td>Gross Pay:</td><td style="text-align: right;">${currencyUtils.format(payslip.grossPay)}</td></tr>
                    <tr><td>Total Deductions:</td><td style="text-align: right;">-${currencyUtils.format(payslip.totalDeductions)}</td></tr>
                    <tr style="font-weight: bold; font-size: 14px; background-color: #eee;"><td>Net Pay:</td><td style="text-align: right;">${currencyUtils.format(payslip.netPay)}</td></tr>
                </tbody>
            </table>

            ${payslip.bankName ? `
            <div style="margin-top: 15px; border-top: 1px solid #ccc; padding-top: 10px;">
                <p><strong>Payment Method:</strong> Direct Deposit</p>
                <p><strong>Bank:</strong> ${payslip.bankName}</p>
                <p><strong>Account:</strong> ****${payslip.bankAccount.slice(-4)}</p>
            </div>
            ` : `<p style="margin-top: 10px;"><strong>Payment Method:</strong> Other/Manual</p>`}
        </div>
    `;

    const modalFooter = `<button data-action="close-modal" class="btn btn-secondary">Close</button><button id="print-payslip-btn" class="btn btn-primary"><i data-lucide="printer" class="w-4 h-4 mr-2"></i>Print Payslip</button>`;
    const payslipModal = showModal(`Payslip - ${payslip.employeeName}`, modalContent, modalFooter, { size: 'max-w-2xl' });
    lucide.createIcons();

    payslipModal.querySelector('#print-payslip-btn').addEventListener('click', () => {
        printElement('payslip-print-area');
    });
}

// --- Pagination Handler for Payroll Sub-Tabs ---
function handlePayrollPagination(viewType, page) {
    const viewState = appState.viewStates.payroll;
    if (viewType === 'payrollSettings') {
        viewState.settingsPage = page;
        const container = document.getElementById('payroll-tab-content');
        if (container) renderStaffPaySettings(container);
    } else if (viewType === 'payrollHistory') {
         viewState.historyPage = page;
         const container = document.getElementById('payroll-tab-content');
         if (container) renderPayrollHistory(container);
    }
}
/**
 * Initializes the Loyalty Program management view.
 * @param {HTMLElement} container The container element for the view.
 */
function initLoyalty(container) {
    if (!container) return;

    // Ensure container is clean
    const newContainer = container.cloneNode(false);
    if (container.parentNode) {
        container.parentNode.replaceChild(newContainer, container);
    }
    container = newContainer; // Use the clean container

    if (!checkPermission('canManageLoyalty')) {
        container.innerHTML = `<div class="text-center p-20"><i data-lucide="shield-off" class="w-16 h-16 mx-auto text-red-500/50 mb-4"></i><h2 class="text-xl font-semibold">Access Denied</h2><p class="text-text-secondary">You do not have permission to manage the loyalty program.</p></div>`;
        lucide.createIcons();
        return;
    }

    const viewState = appState.viewStates.loyalty;
    // --- UPDATED: Get tiers from settings ---
    const settings = firestoreData.loyaltySettings || {};
    const tiers = settings.loyaltyTiers || []; // Get tiers from settings now
    const tiersEnabled = settings.tiersEnabled || false;

    // --- KPIs ---
    const activeCustomers = firestoreData.customers.filter(c => (c.loyaltyPoints || 0) > 0);
    const totalPointsOutstanding = activeCustomers.reduce((sum, c) => sum + (c.loyaltyPoints || 0), 0);
    const potentialRewardValue = settings.rewardThreshold > 0
        ? Math.floor(totalPointsOutstanding / settings.rewardThreshold) * settings.rewardValue
        : 0;

    // --- UPDATED: Tier Filter Options ---
    const tierFilterOptions = tiersEnabled
        ? `<option value="all" ${viewState.filters.tier === 'all' ? 'selected' : ''}>All Tiers</option>` +
          tiers.map(t => `<option value="${t.id}" ${viewState.filters.tier === t.id ? 'selected' : ''}>${t.name}</option>`).join('') +
          `<option value="none" ${viewState.filters.tier === 'none' ? 'selected' : ''}>No Tier</option>`
        : '';

    container.innerHTML = `
        <div class="space-y-6">
            <!-- Header & KPIs -->
            <div>
                <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
                     <div>
                        <h1 class="text-3xl font-bold text-text-primary">Loyalty Program</h1>
                        <p class="text-text-secondary">Manage members, points, and program settings.</p>
                    </div>
                    <button data-action="edit-loyalty-settings" class="btn btn-primary flex-shrink-0">
                        <i data-lucide="settings" class="w-5 h-5 mr-2"></i> Configure Program
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="glass-pane p-5 rounded-xl">
                        <p class="text-sm text-text-secondary">Program Status</p>
                        <p class="text-3xl font-bold ${settings.enabled ? 'text-green-400' : 'text-red-400'}">
                            ${settings.enabled ? 'Active' : 'Disabled'} ${settings.enabled && tiersEnabled ? `(Tiers Active)` : ''}
                        </p>
                    </div>
                    <div class="glass-pane p-5 rounded-xl">
                        <p class="text-sm text-text-secondary">Active Members</p>
                        <p class="text-3xl font-bold text-text-primary">${activeCustomers.length}</p>
                    </div>
                    <div class="glass-pane p-5 rounded-xl">
                        <p class="text-sm text-text-secondary">Total Points Outstanding</p>
                        <p class="text-3xl font-bold text-text-primary font-mono">${totalPointsOutstanding.toLocaleString()}</p>
                        ${settings.rewardThreshold > 0 ? `<p class="text-xs text-text-secondary mt-1">Potential Reward Value: ${currencyUtils.format(potentialRewardValue)}</p>` : ''}
                    </div>
                </div>
            </div>

            <!-- Customer Loyalty List -->
            <div class="glass-pane p-6 rounded-xl">
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <div class="relative flex-grow">
                        <i data-lucide="search" class="absolute left-3.5 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i>
                        <input type="text" id="loyalty-search" placeholder="Search customers..." class="form-input w-full pl-11" value="${viewState.searchQuery || ''}">
                    </div>
                    ${tiersEnabled ? `
                    <select id="loyalty-tier-filter" class="form-select md:w-48">
                        ${tierFilterOptions}
                    </select>
                    ` : ''}
                </div>
                <div class="overflow-x-auto">
                    <table class="table-pro">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                ${tiersEnabled ? '<th>Tier</th>' : ''}
                                <th>Points Balance</th>
                                <th>Rewards Available</th>
                                <th>Last Activity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="loyalty-customers-table-body"></tbody>
                    </table>
                </div>
                <div id="loyalty-pagination" class="mt-4"></div>
            </div>
        </div>
    `;

    renderLoyaltyCustomerList(container);

    // --- Event Listeners ---
    container.addEventListener('input', e => {
        if (e.target.id === 'loyalty-search') {
            viewState.searchQuery = e.target.value;
            viewState.currentPage = 1;
            renderLoyaltyCustomerList(container);
        }
    });

    // --- UPDATED: Add listener for tier filter ---
    container.addEventListener('change', e => {
        if (e.target.id === 'loyalty-tier-filter') {
            viewState.filters.tier = e.target.value;
            viewState.currentPage = 1;
            renderLoyaltyCustomerList(container);
        }
    });

    container.addEventListener('click', e => {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const action = target.dataset.action;
        const customerId = target.dataset.customerId;

        if (action === 'edit-loyalty-settings') {
            openLoyaltySettingsModal();
        }
        if (action === 'adjust-loyalty-points') {
            openAdjustPointsModal(customerId);
        }
        if (action === 'view-loyalty-history') {
            openLoyaltyHistoryModal(customerId);
        }
        // Handle action menu toggle if needed
        if (action === 'toggle-action-menu') {
            e.stopPropagation();
            const menu = target.nextElementSibling;
            if (!menu || !menu.classList.contains('action-menu')) return;
            const isCurrentlyOpen = menu.classList.contains('open');
            document.querySelectorAll('.action-menu.open').forEach(m => m !== menu && m.classList.remove('open', 'open-up'));
            if (!isCurrentlyOpen) {
                const rect = target.getBoundingClientRect();
                const menuHeight = menu.offsetHeight > 0 ? menu.offsetHeight : 150;
                menu.classList.toggle('open-up', rect.bottom + menuHeight > window.innerHeight);
                menu.classList.add('open');
            } else {
                menu.classList.remove('open', 'open-up');
            }
        }
    });

    lucide.createIcons();
}
/**
 * Renders the paginated list of customers with loyalty points.
 * @param {HTMLElement} container The main container for the loyalty view.
 */
function renderLoyaltyCustomerList(container) {
    const viewState = appState.viewStates.loyalty;
    // --- UPDATED: Get tier info ---
    const settings = firestoreData.loyaltySettings || {};
    const tiers = settings.loyaltyTiers || [];
    const tiersEnabled = settings.tiersEnabled || false;
    const tierMap = new Map(tiers.map(t => [t.id, t])); // For easy lookup
    // --- END UPDATED ---

    const tableBody = container.querySelector('#loyalty-customers-table-body');
    const paginationContainer = container.querySelector('#loyalty-pagination');
    if (!tableBody || !paginationContainer) return;

    let filteredCustomers = firestoreData.customers;

    // Apply search filter
    if (viewState.searchQuery) {
        const query = viewState.searchQuery.toLowerCase();
        filteredCustomers = filteredCustomers.filter(c =>
            c.name.toLowerCase().includes(query) ||
            (c.loyaltyId || '').toLowerCase().includes(query) ||
            (c.email || '').toLowerCase().includes(query)
        );
    }

    // --- UPDATED: Apply Tier Filter ---
    if (tiersEnabled && viewState.filters.tier !== 'all') {
        if (viewState.filters.tier === 'none') {
            filteredCustomers = filteredCustomers.filter(c => !c.loyaltyTierId);
        } else {
            filteredCustomers = filteredCustomers.filter(c => c.loyaltyTierId === viewState.filters.tier);
        }
    }
    // --- END UPDATED ---

    // Sort by points descending
    filteredCustomers.sort((a, b) => (b.loyaltyPoints || 0) - (a.loyaltyPoints || 0));

    // Pagination
    const totalItems = filteredCustomers.length;
    const startIndex = (viewState.currentPage - 1) * appState.itemsPerPage;
    const paginatedCustomers = filteredCustomers.slice(startIndex, startIndex + appState.itemsPerPage);

    // --- UPDATED: Table headers based on tiers enabled ---
    const headers = ['Customer', tiersEnabled ? 'Tier' : null, 'Points Balance', 'Rewards Available', 'Last Activity', 'Actions'].filter(Boolean);
    const colCount = headers.length;
    container.querySelector('thead tr').innerHTML = headers.map(h => `<th>${h}</th>`).join('');
    // --- END UPDATED ---

    tableBody.innerHTML = paginatedCustomers.length ? paginatedCustomers.map(c => {
        const points = c.loyaltyPoints || 0;
        const rewardsAvailable = settings.rewardThreshold > 0 ? Math.floor(points / settings.rewardThreshold) : 0;
        const lastInvoice = firestoreData.invoices
            .filter(inv => inv.customerId === c.id)
            .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        const lastActivity = lastInvoice ? new Date(lastInvoice.date).toLocaleDateString() : 'N/A';

        // --- UPDATED: Get Tier Info ---
        const tier = c.loyaltyTierId ? tierMap.get(c.loyaltyTierId) : null;
        const tierCellHTML = tiersEnabled ? `
            <td>
                ${tier ? `<span class="px-2 py-0.5 text-xs font-semibold rounded-full ${tier.colorClass || 'bg-gray-500/20 text-gray-300'}">${tier.name}</span>` : '<span class="text-xs text-text-secondary">None</span>'}
            </td>
        ` : '';
        // --- END UPDATED ---

        return `
            <tr class="table-row">
                <td>
                    <p class="font-medium text-text-primary">${c.name}</p>
                    <p class="text-xs text-text-secondary">${c.email || c.phone || ''}</p>
                </td>
                ${tierCellHTML}
                <td class="font-mono text-lg font-semibold text-accent">${points.toLocaleString()}</td>
                <td class="text-center font-medium">${rewardsAvailable}</td>
                <td class="text-sm text-text-secondary">${lastActivity}</td>
                <td class="text-right">
                    <div class="relative inline-block text-left">
                        <button data-action="toggle-action-menu" class="p-2 rounded-md hover:bg-bg-tertiary">
                            <i data-lucide="more-vertical" class="w-5 h-5 pointer-events-none"></i>
                        </button>
                        <div class="action-menu">
                            <div class="action-menu-item" data-action="adjust-loyalty-points" data-customer-id="${c.id}">
                                <i data-lucide="edit" class="w-4 h-4"></i><span>Adjust Points</span>
                            </div>
                            <div class="action-menu-item" data-action="view-loyalty-history" data-customer-id="${c.id}">
                                <i data-lucide="history" class="w-4 h-4"></i><span>View History</span>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>`;
    }).join('') : `<tr><td colspan="${colCount}" class="text-center p-8 text-text-secondary">No customers found matching criteria.</td></tr>`;

    renderPaginationControls(paginationContainer, totalItems, viewState.currentPage, appState.itemsPerPage, 'loyalty');
    lucide.createIcons();
}

/**
 * Opens the modal to configure loyalty program settings.
 */
function openLoyaltySettingsModal() {
    // Provide defaults if settings or tiers don't exist
    const settings = firestoreData.loyaltySettings || {
        enabled: true, pointsPerDollar: 1, earnOnTax: false,
        rewardThreshold: 100, rewardValue: 5, rewardType: 'fixed_discount',
        redeemLimitPerOrder: 1, tiersEnabled: false, loyaltyTiers: []
    };
    const tiers = settings.loyaltyTiers || [];
    const rewardValueInDisplay = currencyUtils.convert(settings.rewardValue || 0).toFixed(2);

    // --- UPDATED: Function to render the tier rows ---
    const renderTierRows = (tiersData) => {
        if (!tiersData || tiersData.length === 0) {
            return '<p class="text-sm text-center text-text-secondary py-4">No tiers defined. Add the first tier below.</p>';
        }
        return tiersData.map((tier, index) => `
            <div class="tier-row grid grid-cols-12 gap-2 items-center p-2 bg-bg-tertiary rounded" data-tier-id="${tier.id}" data-index="${index}">
                <div class="col-span-4"><input type="text" class="form-input p-2 text-sm" name="tier_name_${index}" value="${tier.name}" placeholder="Tier Name (e.g., Gold)"></div>
                <div class="col-span-3"><input type="number" class="form-input p-2 text-sm" name="tier_points_${index}" value="${tier.pointsThreshold}" placeholder="Points Required"></div>
                <div class="col-span-3"><input type="number" step="0.1" class="form-input p-2 text-sm" name="tier_discount_${index}" value="${tier.discountPercent || 0}" placeholder="Discount %"></div>
                <div class="col-span-1"><input type="color" class="form-input p-1 h-9 w-full" name="tier_color_${index}" value="${tier.color || '#cccccc'}"></div>
                <div class="col-span-1 text-right"><button type="button" data-action="remove-loyalty-tier" data-index="${index}" class="btn btn-danger-secondary p-2 h-9 w-9"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button></div>
            </div>
        `).join('');
    };

    const content = `
        <form id="loyalty-settings-form" class="space-y-6">
            <div class="flex items-center justify-between p-4 bg-bg-secondary rounded-lg border border-border-color">
                <label for="loyalty-enabled" class="font-medium text-text-primary">Enable Loyalty Program</label>
                <label class="toggle-switch-label">
                    <input type="checkbox" id="loyalty-enabled" name="enabled" class="sr-only toggle-switch-input" ${settings.enabled ? 'checked' : ''}>
                    <div class="toggle-switch-track"><div class="toggle-switch-thumb"></div></div>
                </label>
            </div>

            <!-- Points Earning -->
            <div class="glass-pane p-4 rounded-xl border border-border-color">
                <h4 class="font-semibold text-text-primary mb-3">Points Earning</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Points per ${appState.currentCurrency} Spent</label>
                        <input type="number" step="0.1" name="pointsPerDollar" value="${settings.pointsPerDollar || 1}" class="form-input w-full" required>
                    </div>
                    <div class="flex items-center pt-6">
                        <input type="checkbox" id="earnOnTax" name="earnOnTax" class="h-4 w-4 rounded" ${settings.earnOnTax ? 'checked' : ''}>
                        <label for="earnOnTax" class="ml-2 text-sm">Award points on tax amount</label>
                    </div>
                </div>
            </div>

            <!-- Reward Configuration -->
            <div class="glass-pane p-4 rounded-xl border border-border-color">
                <h4 class="font-semibold text-text-primary mb-3">Reward Configuration</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Points Needed for Reward</label>
                        <input type="number" name="rewardThreshold" value="${settings.rewardThreshold || 100}" class="form-input w-full" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Reward Value (${appState.currentCurrency})</label>
                        <input type="number" step="0.01" name="rewardValue" value="${rewardValueInDisplay}" class="form-input w-full" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Reward Type</label>
                        <select name="rewardType" class="form-select w-full">
                            <option value="fixed_discount" ${settings.rewardType === 'fixed_discount' ? 'selected' : ''}>Fixed Discount</option>
                        </select>
                    </div>
                </div>
                 <div class="mt-4">
                    <label class="block text-sm font-medium mb-1">Max Rewards per Order</label>
                    <input type="number" name="redeemLimitPerOrder" value="${settings.redeemLimitPerOrder || 1}" class="form-input w-full md:w-1/3" min="1" required>
                </div>
            </div>

            <!-- Tier System -->
            <div class="glass-pane p-4 rounded-xl border border-border-color">
                <div class="flex items-center justify-between pb-3 border-b border-border-color mb-4">
                    <h4 class="font-semibold text-text-primary">Tier System</h4>
                    <label class="toggle-switch-label">
                        <input type="checkbox" id="tiers-enabled" name="tiersEnabled" class="sr-only toggle-switch-input" ${settings.tiersEnabled ? 'checked' : ''}>
                        <div class="toggle-switch-track"><div class="toggle-switch-thumb"></div></div>
                    </label>
                </div>
                <div id="tier-settings-container" class="${settings.tiersEnabled ? '' : 'hidden'}">
                    <p class="text-sm text-text-secondary mb-4">Define tiers based on points. Customers automatically move up. Tiers should be ordered by points ascending.</p>
                    <div class="grid grid-cols-12 gap-2 text-xs font-semibold text-text-secondary px-2 mb-2">
                        <div class="col-span-4">Tier Name</div>
                        <div class="col-span-3">Points Required</div>
                        <div class="col-span-3">Discount %</div>
                        <div class="col-span-1">Color</div>
                        <div class="col-span-1"></div>
                    </div>
                    <div id="tier-rows-container" class="space-y-2">
                        ${renderTierRows(tiers)}
                    </div>
                    <button type="button" data-action="add-loyalty-tier" class="btn btn-secondary w-full mt-4 text-sm">
                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i>Add Tier
                    </button>
                </div>
            </div>

        </form>
    `;
    const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="loyalty-settings-form" class="btn btn-primary">Save Settings</button>`;
    const modal = showModal('Configure Loyalty Program', content, footer, { size: 'max-w-3xl' });
    lucide.createIcons();

    const tierSettingsContainer = modal.querySelector('#tier-settings-container');
    const tierRowsContainer = modal.querySelector('#tier-rows-container');

    // --- UPDATED: Toggle Tier Settings Visibility ---
    modal.querySelector('#tiers-enabled').addEventListener('change', (e) => {
        tierSettingsContainer.classList.toggle('hidden', !e.target.checked);
    });

    // --- UPDATED: Add/Remove Tier Rows ---
    modal.addEventListener('click', e => {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        if (target.dataset.action === 'add-loyalty-tier') {
            const index = tierRowsContainer.children.length;
            const newRow = document.createElement('div');
            const newTierId = `tier_${Date.now()}`; // Simple unique ID
            newRow.className = 'tier-row grid grid-cols-12 gap-2 items-center p-2 bg-bg-tertiary rounded';
            newRow.dataset.tierId = newTierId;
            newRow.dataset.index = index;
            newRow.innerHTML = `
                <div class="col-span-4"><input type="text" class="form-input p-2 text-sm" name="tier_name_${index}" placeholder="Tier Name"></div>
                <div class="col-span-3"><input type="number" class="form-input p-2 text-sm" name="tier_points_${index}" placeholder="Points Required"></div>
                <div class="col-span-3"><input type="number" step="0.1" class="form-input p-2 text-sm" name="tier_discount_${index}" placeholder="Discount %"></div>
                <div class="col-span-1"><input type="color" class="form-input p-1 h-9 w-full" name="tier_color_${index}" value="#cccccc"></div>
                <div class="col-span-1 text-right"><button type="button" data-action="remove-loyalty-tier" data-index="${index}" class="btn btn-danger-secondary p-2 h-9 w-9"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button></div>
            `;
            // Remove placeholder if present
            const placeholder = tierRowsContainer.querySelector('p');
            if(placeholder) placeholder.remove();

            tierRowsContainer.appendChild(newRow);
            lucide.createIcons();
        }

        if (target.dataset.action === 'remove-loyalty-tier') {
            target.closest('.tier-row').remove();
            // Re-index remaining rows to ensure form submission works correctly
            tierRowsContainer.querySelectorAll('.tier-row').forEach((row, newIndex) => {
                row.dataset.index = newIndex;
                row.querySelectorAll('input, button').forEach(input => {
                    if (input.name) input.name = input.name.replace(/_\d+$/, `_${newIndex}`);
                    if (input.dataset.index) input.dataset.index = newIndex;
                });
            });
             if (tierRowsContainer.children.length === 0) {
                 tierRowsContainer.innerHTML = '<p class="text-sm text-center text-text-secondary py-4">No tiers defined. Add the first tier below.</p>';
             }
        }
    });

    modal.querySelector('#loyalty-settings-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const rewardValueInDisplay = parseFloat(formData.get('rewardValue'));

        // --- UPDATED: Process Tier Data ---
        const updatedTiers = [];
        let maxIndex = -1;
        formData.forEach((value, key) => {
            if (key.startsWith('tier_name_')) {
                maxIndex = Math.max(maxIndex, parseInt(key.split('_').pop()));
            }
        });

        for (let i = 0; i <= maxIndex; i++) {
            const name = formData.get(`tier_name_${i}`);
            if (!name) continue; // Skip if row was deleted but index remains

            const points = parseInt(formData.get(`tier_points_${i}`));
            const discount = parseFloat(formData.get(`tier_discount_${i}`));
            const color = formData.get(`tier_color_${i}`);
            // Find existing ID or generate one if row was newly added
            const rowElement = tierRowsContainer.querySelector(`.tier-row[data-index="${i}"]`);
            const id = rowElement?.dataset.tierId || `tier_${Date.now()}_${i}`;


            if (!isNaN(points) && !isNaN(discount)) {
                updatedTiers.push({
                    id: id,
                    name: name,
                    pointsThreshold: points,
                    discountPercent: discount,
                    color: color,
                    // --- UPDATED: Generate color class dynamically ---
                    colorClass: `bg-[${color}]/20 text-[${color}] border border-[${color}]/50`
                });
            }
        }
        // Sort tiers by points threshold before saving
        updatedTiers.sort((a, b) => a.pointsThreshold - b.pointsThreshold);
        // --- END UPDATED ---

        const newSettings = {
            enabled: formData.has('enabled'),
            pointsPerDollar: parseFloat(formData.get('pointsPerDollar')) || 1,
            earnOnTax: formData.has('earnOnTax'),
            rewardThreshold: parseInt(formData.get('rewardThreshold')) || 100,
            rewardValue: currencyUtils.convertToBase(rewardValueInDisplay),
            rewardType: formData.get('rewardType'),
            redeemLimitPerOrder: parseInt(formData.get('redeemLimitPerOrder')) || 1,
            // --- UPDATED: Save tier info ---
            tiersEnabled: formData.has('tiersEnabled'),
            loyaltyTiers: updatedTiers
        };

        try {
            await setDoc(loyaltySettingsRef, newSettings, { merge: true });
            firestoreData.loyaltySettings = newSettings; // Update local state
            showToast('Loyalty settings updated successfully.', 'success');
            closeModal(modal);
            const container = document.getElementById('loyalty-view-container');
            if (container) initLoyalty(container);
        } catch (error) {
            console.error('Error saving loyalty settings:', error);
            showToast('Failed to save settings.', 'error');
        }
    });
}

/**
 * Opens a modal to manually adjust a customer's loyalty points.
 * @param {string} customerId The ID of the customer.
 */
function openAdjustPointsModal(customerId) {
    const customer = firestoreData.customers.find(c => c.id === customerId);
    if (!customer) return;

    const currentPoints = customer.loyaltyPoints || 0;

    const content = `
        <form id="adjust-points-form" class="space-y-4">
            <p>Adjusting points for: <strong class="text-text-primary">${customer.name}</strong></p>
            <p>Current Balance: <span class="font-mono text-accent font-semibold">${currentPoints.toLocaleString()} points</span></p>
            <div>
                <label class="block text-sm font-medium mb-1">Points to Add/Subtract</label>
                <input type="number" name="points" class="form-input w-full" placeholder="Enter positive to add, negative to subtract" required>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Reason for Adjustment</label>
                <input type="text" name="reason" class="form-input w-full" placeholder="e.g., Promotion, Correction, Manual redemption" required>
            </div>
        </form>
    `;
    const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="adjust-points-form" class="btn btn-primary">Apply Adjustment</button>`;
    const modal = showModal('Adjust Loyalty Points', content, footer);

    modal.querySelector('#adjust-points-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const pointsAdjustment = parseInt(formData.get('points'));
        const reason = formData.get('reason').trim();

        if (isNaN(pointsAdjustment)) {
            showToast('Please enter a valid number for points.', 'error');
            return;
        }
        if (!reason) {
            showToast('Please provide a reason for the adjustment.', 'error');
            return;
        }

        const newPoints = Math.max(0, currentPoints + pointsAdjustment);
        const adjustmentType = pointsAdjustment > 0 ? 'adjust_add' : 'adjust_subtract';

        try {
            const batch = writeBatch(db);

            // Update customer points balance
            batch.update(doc(customersRef, customerId), { loyaltyPoints: newPoints });

            // --- MODIFIED: Add to top-level loyaltyHistory collection ---
            const historyRef = doc(loyaltyHistoryRef); // Generate new doc ref in the top-level collection
            batch.set(historyRef, {
                customerId: customerId, // <-- ADD customerId field
                date: new Date().toISOString(),
                type: adjustmentType,
                pointsChange: pointsAdjustment,
                reason: reason,
                newBalance: newPoints // Store the balance after the transaction
            });
            // --- END MODIFICATION ---

            await batch.commit();

            showToast(`Points adjusted for ${customer.name}. New balance: ${newPoints}.`, 'success');
            closeModal(modal);
            // Optionally re-render the list if visible
            const loyaltyContainer = document.getElementById('loyalty-view-container');
            if(loyaltyContainer) renderLoyaltyCustomerList(loyaltyContainer);

        } catch (error) {
            console.error('Error adjusting points:', error);
            showToast('Failed to adjust points.', 'error');
        }
    });
}

// --- MODIFIED FUNCTION: openLoyaltyHistoryModal ---
/**
 * Opens a modal displaying the loyalty point transaction history for a customer.
 * Fetches data from the top-level '/stores/{storeId}/loyaltyHistory' collection.
 * @param {string} customerId The ID of the customer.
 */
async function openLoyaltyHistoryModal(customerId) {
     const customer = firestoreData.customers.find(c => c.id === customerId);
        if (!customer) return;

    const modalContent = `
        <p class="mb-4">Showing loyalty history for: <strong class="text-text-primary">${customer.name}</strong></p>
        <div class="max-h-[60vh] overflow-y-auto -mx-6">
            <table class="w-full text-sm">
                <thead class="sticky top-0 bg-bg-secondary z-10">
                    <tr class="text-left text-text-secondary uppercase text-xs">
                        <th class="px-6 py-3 font-medium">Date</th>
                        <th class="px-6 py-3 font-medium">Type</th>
                        <th class="px-6 py-3 font-medium text-center">Points Change</th>
                        <th class="px-6 py-3 font-medium">Details</th>
                        <th class="px-6 py-3 font-medium text-right">New Balance</th>
                    </tr>
                </thead>
                <tbody id="loyalty-history-table-body" class="divide-y divide-border-color">
                    <tr><td colspan="5" class="text-center p-8 text-text-secondary">Loading history...</td></tr>
                </tbody>
            </table>
        </div>
    `;
    const modalFooter = `<button data-action="close-modal" class="btn btn-secondary">Close</button>`;
    const modal = showModal('Loyalty History', modalContent, modalFooter, { size: 'max-w-3xl', customClasses: 'p-0' });

    try {
        // --- MODIFIED: Query the top-level collection ---
        const historyQuery = query(loyaltyHistoryRef, where("customerId", "==", customerId));
        const historySnapshot = await getDocs(historyQuery);
        // --- END MODIFICATION ---

        const historyData = historySnapshot.docs.map(doc => doc.data());

        // Sort by date descending
        historyData.sort((a, b) => new Date(b.date) - new Date(a.date));

        const tableBody = modal.querySelector('#loyalty-history-table-body');
        if (historyData.length > 0) {
            tableBody.innerHTML = historyData.map(entry => {
                const pointsChange = entry.pointsChange || 0;
                const pointsClass = pointsChange > 0 ? 'text-green-400' : (pointsChange < 0 ? 'text-red-400' : 'text-text-secondary');
                const pointsPrefix = pointsChange > 0 ? '+' : '';
                const typeText = (entry.type || 'unknown').replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()); // Format type nicely

                let details = entry.reason || '';
                if (entry.invoiceId) {
                    details += ` (Invoice: ${entry.invoiceId.slice(-6)})`;
                }

                return `
                    <tr class="hover:bg-bg-tertiary">
                        <td class="px-6 py-3">${new Date(entry.date).toLocaleString()}</td>
                        <td class="px-6 py-3">${typeText}</td>
                        <td class="px-6 py-3 text-center font-mono ${pointsClass}">${pointsPrefix}${pointsChange}</td>
                        <td class="px-6 py-3 text-xs text-text-secondary">${details}</td>
                        <td class="px-6 py-3 text-right font-mono">${entry.newBalance !== undefined ? entry.newBalance.toLocaleString() : 'N/A'}</td>
                    </tr>
                `;
            }).join('');
        } else {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-text-secondary">No loyalty history found for this customer.</td></tr>`;
        }
    } catch (error) {
                console.error("Error fetching loyalty history:", error);
                modal.querySelector('#loyalty-history-table-body').innerHTML = `<tr><td colspan="5" class="text-center p-8 text-red-400">Could not load history. ${error.message}</td></tr>`; // Show error message in UI
                showToast("Failed to load loyalty history.", "error");
     }
}
async function openReturnModal(invoiceId) {
        const originalInvoice = firestoreData.invoices.find(i => i.id === invoiceId);
        if (!originalInvoice) {
            showToast('Original invoice not found.', 'error');
            return;
        }

        // Find all previous returns for this invoice to calculate remaining returnable items
        const previousReturns = firestoreData.invoices.filter(i => i.returnOfInvoiceId === invoiceId);
        
        const returnedItemsMap = new Map();
        previousReturns.flatMap(r => r.items).forEach(item => {
            const key = item.serialNumber || item.id;
            returnedItemsMap.set(key, (returnedItemsMap.get(key) || 0) + item.qty);
        });

        const returnableItems = [];
        for (const item of originalInvoice.items) {
            if (item.isSerialized) {
                const key = item.serialNumber;
                if (!returnedItemsMap.has(key)) { // This serial has not been returned
                    returnableItems.push({ ...item, maxQty: 1, returnQty: 0, isReturnable: true });
                }
            } else {
                const key = item.id;
                const originalQty = item.qty;
                const returnedQty = returnedItemsMap.get(key) || 0;
                const maxQty = originalQty - returnedQty;
                if (maxQty > 0) {
                    returnableItems.push({ ...item, maxQty: maxQty, returnQty: 0, isReturnable: true });
                }
            }
        }

        if (returnableItems.length === 0) {
            showToast('All items from this invoice have already been returned.', 'info');
            return;
        }

        // Local state for the modal
        let returnData = {
            items: returnableItems,
            reason: ''
        };

        const content = `
            <form id="return-form" class="space-y-4">
                <p>Select items to return from Invoice <strong class="font-mono text-text-primary">${invoiceId}</strong>.</p>
                <div class="max-h-80 overflow-y-auto -mx-6">
                    <table class="w-full text-sm">
                        <thead class="sticky top-0 bg-bg-secondary z-10">
                            <tr class="text-left text-text-secondary uppercase text-xs">
                                <th class="px-6 py-3 font-medium w-16 text-center"><i data-lucide="check-square" class="w-4 h-4 mx-auto"></i></th>
                                <th class="px-6 py-3 font-medium">Product</th>
                                <th class="px-6 py-3 font-medium text-center">Max Returnable</th>
                                <th class="px-6 py-3 font-medium w-32">Return Qty</th>
                                <th class="px-6 py-3 font-medium text-right">Credit Amount</th>
                            </tr>
                        </thead>
                        <tbody id="return-items-table" class="divide-y divide-border-color">
                            <!-- Items will be rendered here by JS -->
                        </tbody>
                    </table>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-border-color">
                    <div>
                        <label class="block text-sm font-medium mb-1">Reason for Return</label>
                        <input type="text" id="return-reason" class="form-input w-full" placeholder="e.g., Damaged item, Wrong size" required>
                    </div>
                    <div id="return-total-summary" class="space-y-1 text-right bg-bg-secondary p-4 rounded-lg">
                        <div class="flex justify-between text-sm">
                            <span class="text-text-secondary">Subtotal Credit:</span>
                            <span id="return-subtotal" class="font-mono text-text-primary font-medium">${currencyUtils.format(0)}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-text-secondary">Tax Credit (Est.):</span>
                            <span id="return-tax" class="font-mono text-text-primary font-medium">${currencyUtils.format(0)}</span>
                        </div>
                        <div class="flex justify-between text-lg font-bold border-t border-border-color pt-2 mt-2">
                            <span class="text-text-primary">Total Credit:</span>
                            <span id="return-total" class="font-mono text-blue-400">${currencyUtils.format(0)}</span>
                        </div>
                    </div>
                </div>
            </form>
        `;
        const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button type="submit" form="return-form" class="btn btn-primary">Process Return</button>`;
        const modal = showModal('Process Return', content, footer, { size: 'max-w-4xl', customClasses: 'p-0' });
        lucide.createIcons();

        const tableBody = modal.querySelector('#return-items-table');

        const updateReturnTotals = () => {
            let subtotal = 0;
            let taxableSubtotal = 0;
            
            returnData.items.forEach(item => {
                if (item.returnQty > 0) {
                    const itemSubtotal = item.price * item.returnQty;
                    subtotal += itemSubtotal;
                    if (item.taxable) {
                        taxableSubtotal += itemSubtotal;
                    }
                }
            });

            // Calculate tax credit proportionally based on the original tax rate
            const originalSubtotal = originalInvoice.subtotalInBaseCurrency || 1;
            const originalTax = originalInvoice.taxInBaseCurrency || 0;
            const effectiveTaxRate = originalTax / originalSubtotal;
            
            const taxCredit = taxableSubtotal * effectiveTaxRate;
            const totalCredit = subtotal + taxCredit;

            modal.querySelector('#return-subtotal').textContent = currencyUtils.format(subtotal);
            modal.querySelector('#return-tax').textContent = currencyUtils.format(taxCredit);
            modal.querySelector('#return-total').textContent = currencyUtils.format(totalCredit);
        };

        const renderReturnItems = () => {
            tableBody.innerHTML = returnData.items.map((item, index) => {
                const itemTotalCredit = (item.returnQty || 0) * item.price;
                return `
                <tr class="hover:bg-bg-tertiary/50">
                    <td class="px-6 py-3 text-center">
                        <input type="checkbox" data-index="${index}" data-action="toggle-return-item" class="form-checkbox h-5 w-5 rounded text-accent focus:ring-accent" ${item.returnQty > 0 ? 'checked' : ''}>
                    </td>
                    <td class="px-6 py-3">
                        <p class="font-medium text-text-primary">${item.name}</p>
                        <p class="text-xs text-text-secondary font-mono">${item.id} ${item.serialNumber ? `(SN: ${item.serialNumber})` : ''}</p>
                    </td>
                    <td class="px-6 py-3 text-center font-mono">${item.maxQty}</td>
                    <td class="px-4 py-2">
                        <input type="number" data-index="${index}" data-action="set-return-qty" value="${item.returnQty}" min="0" max="${item.maxQty}" class="form-input w-full p-1 text-center" ${item.isSerialized ? 'readonly' : ''}>
                    </td>
                    <td class="px-6 py-3 text-right font-mono">${currencyUtils.format(itemTotalCredit)}</td>
                </tr>
                `;
            }).join('');
            updateReturnTotals();
        };

        modal.addEventListener('change', e => {
            const target = e.target.closest('[data-action]');
            if (!target) return;

            const index = parseInt(target.dataset.index);
            const item = returnData.items[index];
            if (!item) return;

            if (target.dataset.action === 'toggle-return-item') {
                item.returnQty = target.checked ? item.maxQty : 0;
                renderReturnItems();
            }

            if (target.dataset.action === 'set-return-qty') {
                let newQty = parseFloat(target.value);
                if (isNaN(newQty) || newQty < 0) newQty = 0;
                if (newQty > item.maxQty) newQty = item.maxQty;
                item.returnQty = newQty;
                
                // Update checkbox state
                const checkbox = modal.querySelector(`input[data-action="toggle-return-item"][data-index="${index}"]`);
                if (checkbox) checkbox.checked = newQty > 0;
                
                renderReturnItems(); // Re-render to update total
            }
        });
        
        modal.querySelector('#return-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const reason = modal.querySelector('#return-reason').value;
            if (!reason) {
                showToast('A reason for the return is required.', 'error');
                return;
            }

            const itemsToReturn = returnData.items.filter(item => item.returnQty > 0)
                .map(item => ({ ...item, qty: item.returnQty })); // Finalize the qty
            
            if (itemsToReturn.length === 0) {
                showToast('Please select at least one item to return.', 'error');
                return;
            }

            closeModal(modal);
            await processReturnTransaction(invoiceId, itemsToReturn, reason);
        });

        renderReturnItems();
    }

    /**
     * [NEW] Executes the Firestore transaction for a return.
     */
    async function processReturnTransaction(originalInvoiceId, itemsToReturn, reason) {
        showToast('Processing return...', 'info');

        // --- NEW: Define newReturnInvoiceRef outside the transaction ---
        const newReturnInvoiceRef = doc(invoicesRef);

        try {
            await runTransaction(db, async (transaction) => {
                // --- STAGE 1: READS ---
                const originalInvoiceRef = doc(invoicesRef, originalInvoiceId);
                const originalInvoiceDoc = await transaction.get(originalInvoiceRef);
                if (!originalInvoiceDoc.exists()) throw new Error("Original invoice not found.");
                const originalInvoice = originalInvoiceDoc.data();

                // --- MODIFICATION START ---
                // Only prepare to read/update customer if one is associated with the invoice
                let customerRef = null;
                let customerDocPromise = null;
                if (originalInvoice.customerId) {
                    customerRef = doc(customersRef, originalInvoice.customerId);
                    customerDocPromise = transaction.get(customerRef); // Get the promise
                }
                // --- MODIFICATION END ---

                // Read all products involved in the return
                const productRefs = {};
                const productDocPromises = [];
                for (const item of itemsToReturn) {
                    if (!productRefs[item.id]) {
                        const productRef = doc(productsRef, item.id);
                        productRefs[item.id] = productRef;
                        productDocPromises.push(transaction.get(productRef));
                    }
                }
                
                // --- Await all reads together ---
                const productDocs = await Promise.all(productDocPromises);
                const customerDoc = customerDocPromise ? await customerDocPromise : null; // Await the customer promise
                
                // Check if a customer was expected but not found
                if (originalInvoice.customerId && (!customerDoc || !customerDoc.exists())) {
                    throw new Error("Customer associated with invoice not found.");
                }
                // --- END MODIFICATION ---

                // --- STAGE 2: CALCULATIONS ---
                const returnSubtotal = itemsToReturn.reduce((sum, i) => sum + (i.price * i.qty), 0);
                const returnTaxableSubtotal = itemsToReturn.filter(i => i.taxable).reduce((sum, i) => sum + (i.price * i.qty), 0);
                
                const originalTaxableSubtotal = originalInvoice.items.filter(i => i.taxable).reduce((acc, item) => acc + (item.price * (item.qty || 1)), 0);
                const effectiveTaxRate = (originalInvoice.taxInBaseCurrency || 0) / (originalTaxableSubtotal || 1);
                
                const returnTax = returnTaxableSubtotal * effectiveTaxRate;
                const returnTotal = returnSubtotal + returnTax; // <-- FIX: Defined 'returnTotal' here

                // --- STAGE 3: WRITES ---

                // 1. Create new "Return" invoice
                // const newReturnInvoiceRef = doc(invoicesRef); // Moved outside
                transaction.set(newReturnInvoiceRef, {
                    id: newReturnInvoiceRef.id,
                    invoiceType: 'return',
                    returnOfInvoiceId: originalInvoiceId,
                    customerId: originalInvoice.customerId,
                    customerName: originalInvoice.customerName,
                    date: new Date().toISOString(),
                    items: itemsToReturn,
                    subtotalInBaseCurrency: -returnSubtotal, // Negative value
                    taxInBaseCurrency: -returnTax,         // Negative value
                    totalInBaseCurrency: -returnTotal,     // Negative value
                    status: 'Return',
                    notes: reason,
                    cashierId: appState.session.currentUser.uid,
                    cashierName: appState.session.currentUser.name,
                    storeId: appState.session.storeId,
                    currency: originalInvoice.currency,
                    exchangeRate: originalInvoice.exchangeRate,
                });

                // 2. Update Customer Balance
                // --- MODIFICATION START ---
                // Only update customer balance if a customerDoc was successfully fetched
                if (customerDoc && customerDoc.exists()) {
                    const customerData = customerDoc.data();
                    const newCustomerDue = (customerData.currentDue || 0) - returnTotal; // <-- FIX: Uses 'returnTotal'
                    transaction.update(customerRef, { currentDue: Math.max(0, newCustomerDue) });
                }
                // --- MODIFICATION END ---

                // 3. Update Product Stock
                productDocs.forEach((productDoc) => {
                    if (!productDoc.exists()) throw new Error(`Product ${productDoc.id} not found.`);
                    const productData = productDoc.data();
                    const productRef = productRefs[productDoc.id];
                    const itemsForThisProduct = itemsToReturn.filter(i => i.id === productDoc.id);
                    
                    const updatePayload = {};
                    if (productData.productType === 'physical') {
                        if (productData.isSerialized) {
                            const serialsToRestore = itemsForThisProduct.map(i => i.serialNumber).filter(Boolean);
                            const newSerials = [...new Set([...(productData.serials || []), ...serialsToRestore])];
                            updatePayload.serials = newSerials;
                            updatePayload.stock = newSerials.length;
                        } else {
                            const totalQtyToRestore = itemsForThisProduct.reduce((sum, i) => sum + i.qty, 0);
                            updatePayload.stock = (productData.stock || 0) + totalQtyToRestore;
                        }
                    }
                    
                    if (Object.keys(updatePayload).length > 0) {
                        transaction.update(productRef, updatePayload);
                    }
                });

                // 4. Update original invoice (optional, but good practice)
                transaction.update(originalInvoiceRef, { hasReturn: true });

                // 5. Create Audit Log
                const auditLogRefNew = doc(auditLogRef);
                transaction.set(auditLogRefNew, {
                    type: 'invoice_return',
                    timestamp: new Date().toISOString(),
                    originalInvoiceId: originalInvoiceId,
                    returnInvoiceId: newReturnInvoiceRef.id,
                    details: `Processed return for ${currencyUtils.format(returnTotal)}. Reason: ${reason}`, // <-- FIX: Uses 'returnTotal'
                    user: {
                        id: appState.session.currentUser.uid,
                        name: appState.session.currentUser.name
                    }
                });
            });

            showToast('Return processed successfully! Stock and customer balance updated.', 'success');
            // Notify admin
            createNotification('info', `A return of <strong>${currencyUtils.format(itemsToReturn.reduce((sum, i) => sum + (i.price * i.qty), 0))}</strong> was processed by <strong>${appState.session.currentUser.name}</strong>.`, { targetRoles: ['admin'] });

            // --- FIX START: Fetch the new invoice data before showing receipt ---
            const newReturnInvoiceSnap = await getDoc(newReturnInvoiceRef);
            if(newReturnInvoiceSnap.exists()) {
                const newInvoiceData = newReturnInvoiceSnap.data();
                 // Manually add customer data if it exists, as showReceipt expects it
                if (newInvoiceData.customerId) {
                    newInvoiceData.customer = firestoreData.customers.find(c => c.id === newInvoiceData.customerId);
                }
                showReceipt(newInvoiceData);
            }
            // --- FIX END ---

        } catch (error) {
            console.error("Failed to process return:", error);
            showToast(`Error processing return: ${error.message}`, 'error');
        }
    }
    // --- EMI SALES FEATURE LOGIC ---

    function initEMI(container) {
        if (!container) return;
        
        // Cleanup old listeners
        const newContainer = container.cloneNode(false);
        if (container.parentNode) {
            container.parentNode.replaceChild(newContainer, container);
        }
        container = newContainer;

        const viewState = appState.viewStates.emi || { activeTab: 'dashboard' };
        appState.viewStates.emi = viewState;

        // --- KPIs Calculation ---
        const allSchedules = firestoreData.emiSchedules || [];
        const activeSchedules = allSchedules.filter(s => s.status === 'Active');
        const totalReceivablePrincipal = activeSchedules.reduce((sum, s) => sum + (s.remainingPrincipal || 0), 0);
        const totalReceivableInterest = activeSchedules.reduce((sum, s) => sum + (s.remainingInterest || 0), 0);
        
        // Check for defaulters (missed payment date)
        const today = new Date();
        today.setHours(0,0,0,0);
        const defaulters = activeSchedules.filter(s => {
            const nextPayment = s.schedule.find(p => p.status === 'Pending' || p.status === 'Partial');
            return nextPayment && new Date(nextPayment.dueDate) < today;
        });

        container.innerHTML = `
            <div class="space-y-6">
                <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-text-primary">EMI Sales</h1>
                        <p class="text-text-secondary">Manage installments, create loan schedules, and track collections.</p>
                    </div>
                    <button data-action="create-new-emi" class="btn btn-primary">
                        <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i> New EMI Sale
                    </button>
                </div>

                <!-- KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="glass-pane p-4 rounded-xl border-l-4 border-blue-500">
                        <p class="text-xs text-text-secondary uppercase font-semibold">Total Active Loans</p>
                        <p class="text-2xl font-bold text-text-primary mt-1">${activeSchedules.length}</p>
                    </div>
                    <div class="glass-pane p-4 rounded-xl border-l-4 border-green-500">
                        <p class="text-xs text-text-secondary uppercase font-semibold">Principal Receivable</p>
                        <p class="text-2xl font-bold text-text-primary mt-1 font-mono">${currencyUtils.format(totalReceivablePrincipal)}</p>
                    </div>
                    <div class="glass-pane p-4 rounded-xl border-l-4 border-indigo-500">
                        <p class="text-xs text-text-secondary uppercase font-semibold">Interest Earning</p>
                        <p class="text-2xl font-bold text-text-primary mt-1 font-mono">${currencyUtils.format(totalReceivableInterest)}</p>
                    </div>
                    <div class="glass-pane p-4 rounded-xl border-l-4 border-red-500">
                        <p class="text-xs text-text-secondary uppercase font-semibold">Overdue Accounts</p>
                        <p class="text-2xl font-bold text-red-400 mt-1">${defaulters.length}</p>
                    </div>
                </div>

                <!-- Active EMIs Table -->
                <div class="glass-pane p-6 rounded-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-text-primary">Active Schedules</h3>
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-text-secondary"></i>
                            <input type="text" id="emi-search" placeholder="Search customer or ID..." class="form-input pl-9 py-1.5 text-sm w-64">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="table-pro">
                            <thead>
                                <tr>
                                    <th>Schedule ID</th>
                                    <th>Customer</th>
                                    <th>Next Due</th>
                                    <th>Amount Due</th>
                                    <th>Progress</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="emi-list-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;

        const renderEMIList = () => {
            const tbody = container.querySelector('#emi-list-body');
            const query = (container.querySelector('#emi-search').value || '').toLowerCase();
            
            let filtered = allSchedules.filter(s => 
                s.customerName.toLowerCase().includes(query) || 
                s.id.toLowerCase().includes(query) ||
                s.productSummary.toLowerCase().includes(query)
            );

            // Sort by status (Active first) then date
            filtered.sort((a,b) => {
                if (a.status === 'Active' && b.status !== 'Active') return -1;
                if (a.status !== 'Active' && b.status === 'Active') return 1;
                return new Date(b.createdAt) - new Date(a.createdAt);
            });

            tbody.innerHTML = filtered.length ? filtered.map(s => {
                const nextPayment = s.schedule.find(p => p.status === 'Pending' || p.status === 'Partial');
                const isOverdue = nextPayment && new Date(nextPayment.dueDate) < today;
                
                // Calculate progress based on principal paid vs total principal
                const paidPrincipal = s.totalPrincipal - s.remainingPrincipal;
                const progress = Math.round((paidPrincipal / s.totalPrincipal) * 100) || 0;
                
                return `
                <tr class="table-row ${isOverdue ? 'bg-red-500/5' : ''}">
                    <td class="font-mono text-xs">
                        <div>${s.id}</div>
                        <div class="text-text-secondary/70 truncate max-w-[150px]">${s.productSummary}</div>
                    </td>
                    <td class="font-medium text-text-primary">${s.customerName}</td>
                    <td class="${isOverdue ? 'text-red-400 font-bold' : ''}">
                        ${nextPayment ? new Date(nextPayment.dueDate).toLocaleDateString() : '<span class="text-green-400">Completed</span>'}
                        ${isOverdue ? '<i data-lucide="alert-circle" class="inline w-3 h-3 ml-1"></i>' : ''}
                    </td>
                    <td class="font-mono">
                        ${nextPayment 
                            ? currencyUtils.format(nextPayment.amount - (nextPayment.paidAmount || 0)) 
                            : currencyUtils.format(0)}
                    </td>
                    <td>
                        <div class="flex items-center gap-2">
                            <div class="w-16 bg-bg-tertiary h-1.5 rounded-full overflow-hidden">
                                <div class="bg-accent h-full" style="width: ${progress}%"></div>
                            </div>
                            <span class="text-xs">${progress}%</span>
                        </div>
                    </td>
                    <td>
                        <span class="px-2 py-0.5 rounded text-[10px] uppercase font-bold 
                            ${s.status === 'Active' ? (isOverdue ? 'bg-red-500/20 text-red-300' : 'bg-blue-500/20 text-blue-300') : 'bg-green-500/20 text-green-300'}">
                            ${isOverdue ? 'Overdue' : s.status}
                        </span>
                    </td>
                    <td>
                        <button data-action="view-emi-details" data-id="${s.id}" class="btn btn-secondary btn-sm">Manage</button>
                    </td>
                </tr>
                `;
            }).join('') : `<tr><td colspan="7" class="text-center p-8 text-text-secondary">No EMI schedules found.</td></tr>`;
            lucide.createIcons();
        };

        renderEMIList();

        // Listeners
        container.querySelector('#emi-search').addEventListener('input', renderEMIList);
        
        container.addEventListener('click', e => {
            const target = e.target.closest('[data-action]');
            if(!target) return;
            const action = target.dataset.action;
            const id = target.dataset.id;

            if (action === 'create-new-emi') {
                openCreateEMIModal();
            }
            if (action === 'view-emi-details') {
                openEMIDetailsModal(id);
            }
        });
        
        lucide.createIcons();
    }

    function openCreateEMIModal() {
        // ... (This function is mostly unchanged until the calculation logic)
        let emiCart = [];
        let selectedCustomer = null;
        
        // --- NEW: Get symbol for UI labels ---
        const currencySymbol = currencyUtils.get(appState.currentCurrency).symbol;

        const content = `
            <div class="flex flex-col h-[75vh]">
                <!-- Top: Customer & Product Selection -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b border-border-color pb-4 mb-4 flex-shrink-0">
                    <div>
                        <label class="block text-sm font-medium mb-1">Customer</label>
                        <div id="emi-customer-selector" class="flex gap-2"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Add Product</label>
                        <div class="relative">
                            <input type="text" id="emi-product-search" placeholder="Scan or search..." class="form-input w-full">
                            <div id="emi-product-results" class="absolute top-full left-0 right-0 bg-bg-secondary border border-border-color z-20 hidden max-h-48 overflow-y-auto rounded-lg shadow-xl"></div>
                        </div>
                    </div>
                </div>

                <!-- Middle: Cart & Calculation -->
                <div class="flex-grow grid grid-cols-1 md:grid-cols-3 gap-6 overflow-hidden">
                    <!-- Cart List -->
                    <div class="md:col-span-2 flex flex-col overflow-hidden bg-bg-tertiary/30 rounded-lg border border-border-color">
                        <div class="p-3 bg-bg-secondary border-b border-border-color font-semibold text-sm">Selected Products</div>
                        <div id="emi-cart-list" class="flex-grow overflow-y-auto p-2 space-y-2">
                            <p class="text-center text-text-secondary p-4 text-sm">No items added.</p>
                        </div>
                        <div class="p-3 bg-bg-secondary border-t border-border-color flex justify-between font-bold">
                            <span>Total Product Value:</span>
                            <span id="emi-cart-total" class="font-mono text-accent">$0.00</span>
                        </div>
                    </div>

                    <!-- Calculator -->
                    <div class="flex flex-col bg-bg-secondary p-4 rounded-lg border border-border-color overflow-y-auto">
                        <h3 class="font-bold text-text-primary mb-4 flex items-center gap-2"><i data-lucide="calculator" class="w-4 h-4"></i> Loan Calculator</h3>
                        
                        <div class="space-y-3 text-sm">
                            <div>
                                <label class="block text-xs text-text-secondary mb-1">Down Payment (${appState.currentCurrency})</label>
                                <div class="flex gap-2">
                                    <input type="number" id="emi-down-payment" value="0" class="form-input w-full font-mono">
                                    <select id="emi-dp-method" class="form-select w-24 text-xs">
                                        <option value="Cash">Cash</option>
                                        <option value="Card">Card</option>
                                        <option value="Mobile Banking">M-Bank</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs text-text-secondary mb-1">Interest Rate (% p.a.)</label>
                                    <input type="number" id="emi-interest-rate" value="12" class="form-input w-full font-mono">
                                </div>
                                <div>
                                    <label class="block text-xs text-text-secondary mb-1">Tenure (Months)</label>
                                    <input type="number" id="emi-tenure" value="6" class="form-input w-full font-mono">
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs text-text-secondary mb-1">Processing Fee (Flat ${appState.currentCurrency})</label>
                                <input type="number" id="emi-proc-fee" value="0" class="form-input w-full font-mono">
                            </div>
                            
                            <div>
                                <label class="block text-xs text-text-secondary mb-1">First EMI Date</label>
                                <input type="date" id="emi-start-date" class="form-input w-full" value="${new Date().toISOString().slice(0,10)}">
                            </div>

                            <div class="h-px bg-border-color my-2"></div>

                            <div class="space-y-1 text-right">
                                <div class="flex justify-between text-text-secondary"><span>Principal Loan:</span> <span id="calc-principal" class="font-mono">0.00</span></div>
                                <div class="flex justify-between text-text-secondary"><span>Total Interest:</span> <span id="calc-interest" class="font-mono">0.00</span></div>
                                <div class="flex justify-between font-bold text-lg text-accent border-t border-border-color pt-2 mt-2">
                                    <span>Monthly EMI:</span> <span id="calc-emi-amount" class="font-mono">0.00</span>
                                </div>
                                <div class="flex justify-between text-xs text-text-secondary mt-1">
                                    <span>Total Payable:</span> <span id="calc-total-payable" class="font-mono">0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        const footer = `<button data-action="close-modal" class="btn btn-secondary">Cancel</button><button id="confirm-create-emi" class="btn btn-primary" disabled>Confirm & Create Sale</button>`;
        
        const modal = showModal('Create EMI Sale', content, footer, { size: 'max-w-5xl' });
        
        // --- Helper Logic for Modal ---
        
        const updateCalculator = () => {
            const cartTotal = emiCart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            
            // --- UPDATED: Convert inputs from Display Currency to Base Currency ---
            const downPaymentDisplay = parseFloat(modal.querySelector('#emi-down-payment').value) || 0;
            const downPayment = currencyUtils.convertToBase(downPaymentDisplay, appState.currentCurrency);
            
            const procFeeDisplay = parseFloat(modal.querySelector('#emi-proc-fee').value) || 0;
            const procFee = currencyUtils.convertToBase(procFeeDisplay, appState.currentCurrency);
            // --- END UPDATED ---

            const rate = parseFloat(modal.querySelector('#emi-interest-rate').value) || 0;
            const tenure = parseFloat(modal.querySelector('#emi-tenure').value) || 0;

            const principal = Math.max(0, cartTotal - downPayment);
            
            // EMI Calculation: P * r * (1+r)^n / ((1+r)^n - 1)
            let emi = 0;
            let totalInterest = 0;

            if (principal > 0 && tenure > 0) {
                if (rate > 0) {
                    const monthlyRate = rate / 12 / 100;
                    emi = (principal * monthlyRate * Math.pow(1 + monthlyRate, tenure)) / (Math.pow(1 + monthlyRate, tenure) - 1);
                    totalInterest = (emi * tenure) - principal;
                } else {
                    emi = principal / tenure;
                }
            }

            const totalPayable = (emi * tenure) + downPayment + procFee;

            modal.querySelector('#emi-cart-total').textContent = currencyUtils.format(cartTotal);
            modal.querySelector('#calc-principal').textContent = currencyUtils.format(principal);
            modal.querySelector('#calc-interest').textContent = currencyUtils.format(totalInterest);
            modal.querySelector('#calc-emi-amount').textContent = currencyUtils.format(emi);
            modal.querySelector('#calc-total-payable').textContent = currencyUtils.format(totalPayable);

            const confirmBtn = modal.querySelector('#confirm-create-emi');
            confirmBtn.disabled = !(emiCart.length > 0 && selectedCustomer && principal > 0);
        };

        // --- Search & Cart Logic ---
        const searchInput = modal.querySelector('#emi-product-search');
        const resultsDiv = modal.querySelector('#emi-product-results');
        
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            if(query.length < 2) { resultsDiv.classList.add('hidden'); return; }
            
            const hits = firestoreData.products.filter(p => !p.parentSKU && (p.name.toLowerCase().includes(query) || p.id.toLowerCase().includes(query))).slice(0, 5);
            resultsDiv.innerHTML = hits.map(p => `
                <div class="p-2 hover:bg-bg-tertiary cursor-pointer text-sm" data-add-id="${p.id}">
                    <div class="font-bold">${p.name}</div>
                    <div class="flex justify-between text-xs text-text-secondary">
                        <span>${p.id}</span>
                        <span>${currencyUtils.format(p.price)}</span>
                    </div>
                </div>
            `).join('');
            resultsDiv.classList.remove('hidden');
        });

        resultsDiv.addEventListener('click', e => {
            const itemDiv = e.target.closest('[data-add-id]');
            if(itemDiv) {
                const product = firestoreData.products.find(p => p.id === itemDiv.dataset.addId);
                if(product) {
                    const existing = emiCart.find(i => i.id === product.id);
                    if(existing) existing.qty++;
                    else emiCart.push({ ...product, qty: 1 });
                    renderCart();
                    searchInput.value = '';
                    resultsDiv.classList.add('hidden');
                }
            }
        });

        const renderCart = () => {
            const cartListContainer = modal.querySelector('#emi-cart-list');
            if(emiCart.length === 0) {
                cartListContainer.innerHTML = '<p class="text-center text-text-secondary p-4 text-sm">No items added.</p>';
            } else {
                cartListContainer.innerHTML = emiCart.map((item, idx) => `
                    <div class="flex justify-between items-center bg-bg-primary p-2 rounded border border-border-color text-sm">
                        <div>
                            <div class="font-medium">${item.name}</div>
                            <div class="text-xs text-text-secondary">${item.qty} x ${currencyUtils.format(item.price)}</div>
                        </div>
                        <button data-remove-idx="${idx}" class="text-red-400 hover:text-red-300 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                `).join('');
            }
            lucide.createIcons();
            updateCalculator();
        };

        modal.querySelector('#emi-cart-list').addEventListener('click', e => {
            const btn = e.target.closest('[data-remove-idx]');
            if(btn) {
                emiCart.splice(parseInt(btn.dataset.removeIdx), 1);
                renderCart();
            }
        });

        // --- Customer Selector ---
        const customerDiv = modal.querySelector('#emi-customer-selector');
        
        const renderCustomerSelect = () => {
            customerDiv.innerHTML = `
                <select id="emi-customer-select" class="form-select w-full">
                    <option value="">Select Customer...</option>
                    ${firestoreData.customers.map(c => `<option value="${c.id}" ${selectedCustomer?.id === c.id ? 'selected' : ''}>${c.name} (${c.phone})</option>`).join('')}
                </select>
                <button id="add-new-customer-emi" class="btn btn-secondary p-2 shrink-0" title="Add Customer"><i data-lucide="plus" class="w-4 h-4 pointer-events-none"></i></button>
            `;
            lucide.createIcons();
        };
        renderCustomerSelect();

        customerDiv.addEventListener('change', (e) => {
            if (e.target.id === 'emi-customer-select') {
                selectedCustomer = firestoreData.customers.find(c => c.id === e.target.value);
                updateCalculator();
            }
        });

        customerDiv.addEventListener('click', (e) => {
            const btn = e.target.closest('#add-new-customer-emi');
            if (btn) {
                openCustomerModal(null, (newCustomer) => {
                    if (!firestoreData.customers.find(c => c.id === newCustomer.id)) {
                        firestoreData.customers.push(newCustomer);
                    }
                    selectedCustomer = newCustomer;
                    renderCustomerSelect();
                    updateCalculator();
                });
            }
        });

        ['emi-down-payment', 'emi-interest-rate', 'emi-tenure', 'emi-proc-fee'].forEach(id => {
            modal.querySelector(`#${id}`).addEventListener('input', updateCalculator);
        });

        // --- Final Submission ---
        modal.querySelector('#confirm-create-emi').addEventListener('click', async () => {
            if(!selectedCustomer || emiCart.length === 0) return;
            
            const btn = modal.querySelector('#confirm-create-emi');
            btn.disabled = true;
            btn.innerHTML = `<div class="loader-sm"></div> Creating...`;

            try {
                await runTransaction(db, async (transaction) => {
                    const cartTotal = emiCart.reduce((sum, item) => sum + (item.price * item.qty), 0);
                    
                    // --- UPDATED: Convert inputs to Base Currency for Storage ---
                    const downPaymentDisplay = parseFloat(modal.querySelector('#emi-down-payment').value) || 0;
                    const downPayment = currencyUtils.convertToBase(downPaymentDisplay, appState.currentCurrency);
                    
                    const procFeeDisplay = parseFloat(modal.querySelector('#emi-proc-fee').value) || 0;
                    const procFee = currencyUtils.convertToBase(procFeeDisplay, appState.currentCurrency);
                    // --- END UPDATED ---

                    const dpMethod = modal.querySelector('#emi-dp-method').value;
                    const rate = parseFloat(modal.querySelector('#emi-interest-rate').value) || 0;
                    const tenure = parseFloat(modal.querySelector('#emi-tenure').value) || 0;
                    const startDateStr = modal.querySelector('#emi-start-date').value;
                    const principal = cartTotal - downPayment;

                    // --- NEW: Read Customer First ---
                    const customerRef = doc(customersRef, selectedCustomer.id);
                    const customerDoc = await transaction.get(customerRef);
                    if (!customerDoc.exists()) throw "Customer not found";
                    const currentCustomerDue = customerDoc.data().currentDue || 0;

                    // 2. Generate Schedule & Calculate Total Interest (Moved up to calculate totals for invoice)
                    const schedule = [];
                    const monthlyRate = rate / 12 / 100;
                    const emiAmount = (principal * monthlyRate * Math.pow(1 + monthlyRate, tenure)) / (Math.pow(1 + monthlyRate, tenure) - 1);
                    
                    let currentDate = new Date(startDateStr);
                    let balance = principal;
                    let totalScheduleInterest = 0;
                    
                    for(let i=1; i<=tenure; i++) {
                        const interestPart = balance * monthlyRate;
                        const principalPart = emiAmount - interestPart;
                        balance -= principalPart;
                        totalScheduleInterest += interestPart;
                        
                        schedule.push({
                            installmentNo: i,
                            dueDate: currentDate.toISOString(),
                            amount: emiAmount,
                            interestComponent: interestPart,
                            principalComponent: principalPart,
                            status: 'Pending',
                            paidAmount: 0 
                        });
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    }

                    // 1. Create Invoice (Revenue = Principal + Interest)
                    // FIX: Total Invoice Amount should reflect total debt created (Principal + Interest)
                    const invoiceTotal = cartTotal + totalScheduleInterest;
                    const invoiceDue = principal + totalScheduleInterest;

                    const invoiceRef = doc(invoicesRef);
                    const invoiceData = {
                        customerId: selectedCustomer.id,
                        customerName: selectedCustomer.name,
                        date: new Date().toISOString(),
                        items: emiCart,
                        totalInBaseCurrency: invoiceTotal, 
                        subtotalInBaseCurrency: cartTotal,
                        taxInBaseCurrency: 0, 
                        discountInBaseCurrency: 0,
                        dueAmount: invoiceDue, 
                        status: 'EMI',
                        cashierId: appState.session.currentUser.uid,
                        cashierName: appState.session.currentUser.name,
                        storeId: appState.session.storeId,
                        currency: appState.currentCurrency,
                        exchangeRate: currencyUtils.get().rate,
                        isEMI: true,
                        emiInterest: totalScheduleInterest, // Explicitly store interest for reports
                        paymentDetails: downPayment > 0 ? [{
                            amount: currencyUtils.convert(downPayment, appState.currentCurrency),
                            date: new Date().toISOString(),
                            method: dpMethod,
                            notes: 'EMI Down Payment',
                            isDownPayment: true
                        }] : []
                    };
                    transaction.set(invoiceRef, invoiceData);


                    // 3. Create EMI Schedule Doc
                    const scheduleRef = doc(emiSchedulesRef);
                    const scheduleData = {
                        invoiceId: invoiceRef.id,
                        customerId: selectedCustomer.id,
                        customerName: selectedCustomer.name,
                        productSummary: emiCart.map(i => i.name).join(', '),
                        totalPrincipal: principal,
                        totalInterest: totalScheduleInterest,
                        interestRate: rate,
                        tenureMonths: tenure,
                        downPayment: downPayment,
                        processingFee: procFee,
                        emiAmount: emiAmount,
                        remainingPrincipal: principal,
                        remainingInterest: totalScheduleInterest,
                        startDate: startDateStr,
                        schedule: schedule,
                        status: 'Active',
                        createdAt: new Date().toISOString()
                    };
                    transaction.set(scheduleRef, scheduleData);

                    // 4. Inventory
                    emiCart.forEach(item => {
                        if (item.productType === 'physical') {
                            const productRef = doc(productsRef, item.id);
                            transaction.update(productRef, { 
                                stock: increment(-item.qty),
                                sales: increment(item.qty)
                            });
                        }
                    });
                    
                    // 5. Audit
                    const logRef = doc(auditLogRef);
                    transaction.set(logRef, {
                        type: 'emi_creation',
                        timestamp: new Date().toISOString(),
                        details: `Created EMI for ${selectedCustomer.name}. Loan: ${currencyUtils.format(principal)}. DP: ${currencyUtils.format(downPayment)}`,
                        user: { id: appState.session.currentUser.uid, name: appState.session.currentUser.name }
                    });

                    // --- CORRECT LOGIC: Dashboard "Receivables" must include Interest ---
                    // Revenue (Invoice) = 6000
                    // Customer Due = 6000 (Principal) + 211.74 (Interest) = 6211.74
                    const totalLoanPayable = principal + totalScheduleInterest;
                    transaction.update(customerRef, {
                        currentDue: currentCustomerDue + totalLoanPayable
                    });
                });

                showToast('EMI Sale created successfully!', 'success');
                closeModal(modal);
                const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
                if(activeTab?.viewType === 'emi-sales') initEMI(document.querySelector('.view-pane'));

            } catch (error) {
                console.error("EMI Creation Failed:", error);
                showToast(`Failed to create EMI: ${error.message}`, 'error');
                btn.disabled = false;
                btn.textContent = 'Confirm & Create Sale';
            }
        });
    }

    function openEMIDetailsModal(scheduleId) {
        // ... (This function remains unchanged)
        const schedule = firestoreData.emiSchedules.find(s => s.id === scheduleId);
        if(!schedule) return;

        // Calc Helpers
        const paidInstallments = schedule.schedule.filter(s => s.status === 'Paid').length;
        const nextDue = schedule.schedule.find(s => s.status === 'Pending' || s.status === 'Partial');

        const content = `
            <div class="space-y-6">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-bold text-text-primary">EMI Details</h2>
                        <p class="text-sm text-text-secondary font-mono">${schedule.id}</p>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <span class="px-3 py-1 rounded-full bg-blue-500/20 text-blue-300 font-bold text-sm uppercase">${schedule.status}</span>
                        ${schedule.status === 'Active' ? `<button id="settle-loan-btn" class="text-xs text-accent hover:underline">Settle Loan Early</button>` : ''}
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="p-3 bg-bg-tertiary rounded-lg">
                        <p class="text-xs text-text-secondary">Customer</p>
                        <p class="font-medium">${schedule.customerName}</p>
                    </div>
                    <div class="p-3 bg-bg-tertiary rounded-lg">
                        <p class="text-xs text-text-secondary">Monthly Amount</p>
                        <p class="font-mono font-bold text-accent">${currencyUtils.format(schedule.emiAmount)}</p>
                    </div>
                    <div class="p-3 bg-bg-tertiary rounded-lg">
                        <p class="text-xs text-text-secondary">Progress</p>
                        <p class="font-medium">${paidInstallments} / ${schedule.tenureMonths}</p>
                    </div>
                    <div class="p-3 bg-bg-tertiary rounded-lg">
                        <p class="text-xs text-text-secondary">Remaining Principal</p>
                        <p class="font-mono font-bold text-text-primary">${currencyUtils.format(schedule.remainingPrincipal)}</p>
                    </div>
                </div>

                <div class="border border-border-color rounded-xl overflow-hidden">
                    <table class="table-pro">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Due Date</th>
                                <th>Amount</th>
                                <th>Paid</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm">
                            ${schedule.schedule.map((p, idx) => {
                                const isPaid = p.status === 'Paid';
                                const isPartial = p.status === 'Partial';
                                return `
                                <tr class="${isPaid ? 'bg-green-500/5' : ''}">
                                    <td>${p.installmentNo}</td>
                                    <td>${new Date(p.dueDate).toLocaleDateString()}</td>
                                    <td class="font-mono">${currencyUtils.format(p.amount)}</td>
                                    <td class="font-mono ${isPartial ? 'text-yellow-400 font-bold' : ''}">
                                        ${currencyUtils.format(p.paidAmount || 0)}
                                    </td>
                                    <td>
                                        <span class="${isPaid ? 'text-green-400' : (new Date(p.dueDate) < new Date() && !isPaid ? 'text-red-400 font-bold' : (isPartial ? 'text-yellow-400' : 'text-text-secondary'))}">
                                            ${p.status}
                                        </span>
                                    </td>
                                    <td>
                                        ${!isPaid && schedule.status === 'Active' ? `
                                            <button data-action="pay-installment-modal" data-schedule-id="${schedule.id}" data-index="${idx}" class="btn btn-primary btn-xs">
                                                Pay
                                            </button>` 
                                        : (p.paidDate ? `<span class="text-xs text-text-secondary">Pd: ${new Date(p.paidDate).toLocaleDateString()}</span>` : '-')}
                                        <button data-action="add-note" data-index="${idx}" class="text-text-secondary hover:text-accent ml-2" title="Add Note/Penalty"><i data-lucide="message-square" class="w-3 h-3"></i></button>
                                    </td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        const footer = `<button data-action="close-modal" class="btn btn-secondary">Close</button>`;
        const modal = showModal('Manage EMI', content, footer, { size: 'max-w-4xl' });

        // --- Handle Settle Loan ---
        const settleBtn = modal.querySelector('#settle-loan-btn');
        if(settleBtn) {
            settleBtn.addEventListener('click', () => {
                const amountToPay = schedule.remainingPrincipal;
                const settleModal = showModal(
                    'Settle Loan Early',
                    `<p>Foreclosing loan for <strong>${schedule.customerName}</strong>.</p>
                     <p class="mt-2">Pay Remaining Principal: <strong class="text-xl text-accent font-mono">${currencyUtils.format(amountToPay)}</strong></p>
                     <p class="text-sm text-text-secondary">Future interest will be waived.</p>
                     <div class="mt-4">
                        <label class="block text-sm mb-1">Payment Method</label>
                        <select id="settle-method" class="form-select w-full">
                            <option value="Cash">Cash</option>
                            <option value="Card">Card</option>
                            <option value="Mobile Banking">M-Bank</option>
                        </select>
                     </div>
                    `,
                    `<button data-action="close-modal" class="btn btn-secondary">Cancel</button>
                     <button id="confirm-settle" class="btn btn-success text-white">Confirm Payment & Close Loan</button>`
                );
                
                settleModal.querySelector('#confirm-settle').addEventListener('click', async () => {
                    // Logic to update Invoice (add payment), set schedule to Completed, set remaining installments to Waived
                    closeModal(settleModal);
                    closeModal(modal);
                    await processSettlement(schedule, amountToPay, settleModal.querySelector('#settle-method').value);
                });
            });
        }

        // --- Handle Installment Payment Click ---
        modal.addEventListener('click', async e => {
            const btn = e.target.closest('[data-action="pay-installment-modal"]');
            if(btn) {
                const index = parseInt(btn.dataset.index);
                const installment = schedule.schedule[index];
                const dueBase = installment.amount - (installment.paidAmount || 0); // This is in Base Currency

                // --- NEW: Convert Due to Display Currency ---
                const dueDisplay = currencyUtils.convert(dueBase, appState.currentCurrency);
                // --- END NEW ---

                const payModal = showModal(
                    'Receive Installment',
                    `<p>Installment #${installment.installmentNo}</p>
                     <div class="my-4 p-3 bg-bg-tertiary rounded border border-border-color">
                        <div class="flex justify-between text-sm"><span>Total Installment:</span> <span class="font-mono">${currencyUtils.format(installment.amount)}</span></div>
                        <div class="flex justify-between text-sm"><span>Already Paid:</span> <span class="font-mono text-yellow-400">${currencyUtils.format(installment.paidAmount || 0)}</span></div>
                        <div class="flex justify-between font-bold text-lg mt-2 pt-2 border-t border-border-color"><span>Due Now:</span> <span class="font-mono text-accent">${currencyUtils.format(dueBase)}</span></div>
                     </div>
                     <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm mb-1">Amount Paying (${appState.currentCurrency})</label>
                            <!-- UPDATED: Pre-fill with formatted display currency value -->
                            <input type="number" id="pay-amount" value="${dueDisplay.toFixed(2)}" class="form-input w-full font-mono">
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Method</label>
                            <select id="pay-method" class="form-select w-full">
                                <option value="Cash">Cash</option>
                                <option value="Card">Card</option>
                                <option value="Mobile Banking">M-Bank</option>
                            </select>
                        </div>
                     </div>`,
                    `<button data-action="close-modal" class="btn btn-secondary">Cancel</button>
                     <button id="confirm-pay-installment" class="btn btn-primary">Receive Payment</button>`
                );

                payModal.querySelector('#confirm-pay-installment').addEventListener('click', async () => {
                    // --- NEW: Read input in Display Currency and convert to Base ---
                    const payAmtDisplay = parseFloat(payModal.querySelector('#pay-amount').value);
                    const payAmtBase = currencyUtils.convertToBase(payAmtDisplay, appState.currentCurrency);
                    // --- END NEW ---

                    const method = payModal.querySelector('#pay-method').value;
                    
                    if(isNaN(payAmtBase) || payAmtBase <= 0) { showToast('Invalid Amount', 'error'); return; }
                    if(payAmtBase > dueBase + 0.01) { showToast('Amount exceeds due value.', 'error'); return; }

                    closeModal(payModal);
                    closeModal(modal);
                    await processInstallmentPayment(schedule, index, payAmtBase, method);
                });
            }
            
            // Note logic placeholder
            if (e.target.closest('[data-action="add-note"]')) {
                showToast("Note feature coming in next update.", "info");
            }
        });
    }

    // --- Helper: Process Installment ---
    async function processInstallmentPayment(schedule, index, amount, method) {
        showToast('Processing payment...', 'info');
        try {
            await runTransaction(db, async (transaction) => {
                // 1. Read fresh schedule
                const schedRef = doc(emiSchedulesRef, schedule.id);
                const schedDoc = await transaction.get(schedRef);
                if (!schedDoc.exists()) throw "Schedule not found";
                const freshSched = schedDoc.data();
                
                // 2. Read Invoice
                const invoiceRef = doc(invoicesRef, freshSched.invoiceId);
                const invoiceDoc = await transaction.get(invoiceRef);
                if (!invoiceDoc.exists()) throw "Linked Invoice not found";
                const invoiceData = invoiceDoc.data();

                // --- NEW: Read Customer ---
                const customerRef = doc(customersRef, freshSched.customerId);
                const customerDoc = await transaction.get(customerRef);
                if (!customerDoc.exists()) throw "Customer not found";
                const customerData = customerDoc.data();

                // 3. Update Schedule Logic
                const install = freshSched.schedule[index];
                const newPaidAmount = (install.paidAmount || 0) + amount;
                
                // Determine Status
                let newStatus = 'Partial';
                if (Math.abs(newPaidAmount - install.amount) < 0.01) newStatus = 'Paid';
                
                install.paidAmount = newPaidAmount;
                install.status = newStatus;
                if(newStatus === 'Paid') install.paidDate = new Date().toISOString();

                // Check if all paid
                const allPaid = freshSched.schedule.every(s => s.status === 'Paid');
                if (allPaid) freshSched.status = 'Completed';

                let interestCovered = Math.min(amount, Math.max(0, install.interestComponent)); 
                let principalCovered = Math.max(0, amount - interestCovered);
                
                freshSched.remainingPrincipal = Math.max(0, freshSched.remainingPrincipal - principalCovered);
                freshSched.remainingInterest = Math.max(0, freshSched.remainingInterest - interestCovered);
                
                freshSched.lastPaymentDate = new Date().toISOString();

                transaction.update(schedRef, freshSched);

                // 4. Update Invoice (Financial Integrity)
                // Append to paymentDetails
                const newPayment = {
                    amount: currencyUtils.convert(amount, appState.currentCurrency),
                    date: new Date().toISOString(),
                    method: method,
                    notes: `EMI Installment #${install.installmentNo} (${newStatus})`,
                    isEMIPayment: true,
                    scheduleId: schedule.id
                };
                
                // Invoice Due only tracks Principal
                const newInvoiceDue = Math.max(0, invoiceData.dueAmount - principalCovered); 
                
                transaction.update(invoiceRef, {
                    dueAmount: newInvoiceDue,
                    paymentDetails: [...(invoiceData.paymentDetails || []), newPayment],
                    status: newInvoiceDue < 0.01 ? 'Paid' : 'EMI'
                });

                // --- CRITICAL FIX: Update Customer Due ---
                // Since we added (Principal + Interest) to Due on creation,
                // we simply subtract the *full payment amount* here.
                const newCustomerDue = Math.max(0, (customerData.currentDue || 0) - amount);
                transaction.update(customerRef, { currentDue: newCustomerDue });

                // 5. Audit
                const logRef = doc(auditLogRef);
                transaction.set(logRef, {
                    type: 'emi_payment',
                    timestamp: new Date().toISOString(),
                    details: `Received ${currencyUtils.format(amount)} for EMI ${schedule.id} #${install.installmentNo}`,
                    user: { id: appState.session.currentUser.uid, name: appState.session.currentUser.name }
                });
            });
            showToast('Payment received successfully!', 'success');
            // Refresh
            const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
            if(activeTab?.viewType === 'emi-sales') initEMI(document.querySelector('.view-pane'));
        } catch (err) {
            console.error(err);
            showToast('Transaction failed.', 'error');
        }
    }

    // --- Helper: Process Settlement ---
    async function processSettlement(schedule, amount, method) {
        showToast('Settling loan...', 'info');
        try {
            await runTransaction(db, async (transaction) => {
                const schedRef = doc(emiSchedulesRef, schedule.id);
                const invoiceRef = doc(invoicesRef, schedule.invoiceId);
                const invoiceDoc = await transaction.get(invoiceRef);
                const invoiceData = invoiceDoc.data();

                // --- NEW: Read Customer ---
                const customerRef = doc(customersRef, schedule.customerId);
                const customerDoc = await transaction.get(customerRef);
                if (!customerDoc.exists()) throw "Customer not found";
                const customerData = customerDoc.data();

                // Update Schedule
                const updatedScheduleArr = schedule.schedule.map(s => {
                    if(s.status !== 'Paid') return { ...s, status: 'Waived', notes: 'Loan Settled Early' };
                    return s;
                });

                transaction.update(schedRef, {
                    schedule: updatedScheduleArr,
                    status: 'Settled',
                    remainingPrincipal: 0,
                    remainingInterest: 0,
                    settledDate: new Date().toISOString()
                });

                // Update Invoice
                const newPayment = {
                    amount: currencyUtils.convert(amount, appState.currentCurrency),
                    date: new Date().toISOString(),
                    method: method,
                    notes: `Early Settlement for EMI ${schedule.id}`,
                    isEMISettlement: true
                };
                
                // When settling, we assume the invoice due amount becomes 0
                transaction.update(invoiceRef, {
                    dueAmount: 0,
                    paymentDetails: [...(invoiceData.paymentDetails || []), newPayment],
                    status: 'Paid',
                    notes: (invoiceData.notes || '') + '\n[Loan Settled Early]'
                });

                // --- CRITICAL FIX: Update Customer Due ---
                // We reduce the customer due by the (Amount Paid + Interest Waived).
                // 'amount' is the Principal being paid.
                // 'schedule.remainingInterest' is the interest being waived.
                // This clears the full outstanding balance for this loan from the customer profile.
                const totalReduction = amount + (schedule.remainingInterest || 0);
                const newCustomerDue = Math.max(0, (customerData.currentDue || 0) - totalReduction);
                
                transaction.update(customerRef, { currentDue: newCustomerDue });
                
                // Audit
                const logRef = doc(auditLogRef);
                transaction.set(logRef, {
                    type: 'emi_settlement',
                    timestamp: new Date().toISOString(),
                    details: `Settled loan ${schedule.id} for ${currencyUtils.format(amount)}. Waived interest: ${currencyUtils.format(schedule.remainingInterest)}`,
                    user: { id: appState.session.currentUser.uid, name: appState.session.currentUser.name }
                });
            });
            showToast('Loan settled successfully.', 'success');
            const activeTab = appState.tabs.find(t => t.id === appState.activeTabId);
            if(activeTab?.viewType === 'emi-sales') initEMI(document.querySelector('.view-pane'));
        } catch(err) {
            console.error(err);
            showToast('Settlement failed.', 'error');
        }
    }

    window.addEventListener('resize', checkScreenSize);
});
</script>